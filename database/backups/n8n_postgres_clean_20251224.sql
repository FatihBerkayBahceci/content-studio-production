--
-- PostgreSQL database dump
--


-- Dumped from database version 15.14
-- Dumped by pg_dump version 15.14

SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;

--
-- Name: uuid-ossp; Type: EXTENSION; Schema: -; Owner: -
--

CREATE EXTENSION IF NOT EXISTS "uuid-ossp" WITH SCHEMA public;


--
-- Name: EXTENSION "uuid-ossp"; Type: COMMENT; Schema: -; Owner: -
--

COMMENT ON EXTENSION "uuid-ossp" IS 'generate universally unique identifiers (UUIDs)';


--
-- Name: increment_workflow_version(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.increment_workflow_version() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
			BEGIN
				IF NEW."versionCounter" IS NOT DISTINCT FROM OLD."versionCounter" THEN
					NEW."versionCounter" = OLD."versionCounter" + 1;
				END IF;
				RETURN NEW;
			END;
			$$;


SET default_tablespace = '';

SET default_table_access_method = heap;

--
-- Name: annotation_tag_entity; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.annotation_tag_entity (
    id character varying(16) NOT NULL,
    name character varying(24) NOT NULL,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL
);


--
-- Name: auth_identity; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.auth_identity (
    "userId" uuid,
    "providerId" character varying(64) NOT NULL,
    "providerType" character varying(32) NOT NULL,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL
);


--
-- Name: auth_provider_sync_history; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.auth_provider_sync_history (
    id integer NOT NULL,
    "providerType" character varying(32) NOT NULL,
    "runMode" text NOT NULL,
    status text NOT NULL,
    "startedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP NOT NULL,
    "endedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP NOT NULL,
    scanned integer NOT NULL,
    created integer NOT NULL,
    updated integer NOT NULL,
    disabled integer NOT NULL,
    error text
);


--
-- Name: auth_provider_sync_history_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.auth_provider_sync_history_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: auth_provider_sync_history_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.auth_provider_sync_history_id_seq OWNED BY public.auth_provider_sync_history.id;


--
-- Name: binary_data; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.binary_data (
    "fileId" uuid NOT NULL,
    "sourceType" character varying(50) NOT NULL,
    "sourceId" character varying(255) NOT NULL,
    data bytea NOT NULL,
    "mimeType" character varying(255),
    "fileName" character varying(255),
    "fileSize" integer NOT NULL,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    CONSTRAINT "CHK_binary_data_sourceType" CHECK ((("sourceType")::text = ANY (ARRAY[('execution'::character varying)::text, ('chat_message_attachment'::character varying)::text])))
);


--
-- Name: COLUMN binary_data."sourceType"; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.binary_data."sourceType" IS 'Source the file belongs to, e.g. ''execution''';


--
-- Name: COLUMN binary_data."sourceId"; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.binary_data."sourceId" IS 'ID of the source, e.g. execution ID';


--
-- Name: COLUMN binary_data.data; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.binary_data.data IS 'Raw, not base64 encoded';


--
-- Name: COLUMN binary_data."fileSize"; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.binary_data."fileSize" IS 'In bytes';


--
-- Name: chat_hub_agents; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.chat_hub_agents (
    id uuid NOT NULL,
    name character varying(256) NOT NULL,
    description character varying(512),
    "systemPrompt" text NOT NULL,
    "ownerId" uuid NOT NULL,
    "credentialId" character varying(36),
    provider character varying(16) NOT NULL,
    model character varying(64) NOT NULL,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    tools json DEFAULT '[]'::json NOT NULL
);


--
-- Name: COLUMN chat_hub_agents.provider; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.chat_hub_agents.provider IS 'ChatHubProvider enum: "openai", "anthropic", "google", "n8n"';


--
-- Name: COLUMN chat_hub_agents.model; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.chat_hub_agents.model IS 'Model name used at the respective Model node, ie. "gpt-4"';


--
-- Name: COLUMN chat_hub_agents.tools; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.chat_hub_agents.tools IS 'Tools available to the agent as JSON node definitions';


--
-- Name: chat_hub_messages; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.chat_hub_messages (
    id uuid NOT NULL,
    "sessionId" uuid NOT NULL,
    "previousMessageId" uuid,
    "revisionOfMessageId" uuid,
    "retryOfMessageId" uuid,
    type character varying(16) NOT NULL,
    name character varying(128) NOT NULL,
    content text NOT NULL,
    provider character varying(16),
    model character varying(64),
    "workflowId" character varying(36),
    "executionId" integer,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "agentId" character varying(36),
    status character varying(16) DEFAULT 'success'::character varying NOT NULL,
    attachments json
);


--
-- Name: COLUMN chat_hub_messages.type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.chat_hub_messages.type IS 'ChatHubMessageType enum: "human", "ai", "system", "tool", "generic"';


--
-- Name: COLUMN chat_hub_messages.provider; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.chat_hub_messages.provider IS 'ChatHubProvider enum: "openai", "anthropic", "google", "n8n"';


--
-- Name: COLUMN chat_hub_messages.model; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.chat_hub_messages.model IS 'Model name used at the respective Model node, ie. "gpt-4"';


--
-- Name: COLUMN chat_hub_messages."agentId"; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.chat_hub_messages."agentId" IS 'ID of the custom agent (if provider is "custom-agent")';


--
-- Name: COLUMN chat_hub_messages.status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.chat_hub_messages.status IS 'ChatHubMessageStatus enum, eg. "success", "error", "running", "cancelled"';


--
-- Name: COLUMN chat_hub_messages.attachments; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.chat_hub_messages.attachments IS 'File attachments for the message (if any), stored as JSON. Files are stored as base64-encoded data URLs.';


--
-- Name: chat_hub_sessions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.chat_hub_sessions (
    id uuid NOT NULL,
    title character varying(256) NOT NULL,
    "ownerId" uuid NOT NULL,
    "lastMessageAt" timestamp(3) with time zone,
    "credentialId" character varying(36),
    provider character varying(16),
    model character varying(64),
    "workflowId" character varying(36),
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "agentId" character varying(36),
    "agentName" character varying(128),
    tools json DEFAULT '[]'::json NOT NULL
);


--
-- Name: COLUMN chat_hub_sessions.provider; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.chat_hub_sessions.provider IS 'ChatHubProvider enum: "openai", "anthropic", "google", "n8n"';


--
-- Name: COLUMN chat_hub_sessions.model; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.chat_hub_sessions.model IS 'Model name used at the respective Model node, ie. "gpt-4"';


--
-- Name: COLUMN chat_hub_sessions."agentId"; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.chat_hub_sessions."agentId" IS 'ID of the custom agent (if provider is "custom-agent")';


--
-- Name: COLUMN chat_hub_sessions."agentName"; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.chat_hub_sessions."agentName" IS 'Cached name of the custom agent (if provider is "custom-agent")';


--
-- Name: COLUMN chat_hub_sessions.tools; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.chat_hub_sessions.tools IS 'Tools available to the agent as JSON node definitions';


--
-- Name: credentials_entity; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.credentials_entity (
    name character varying(128) NOT NULL,
    data text NOT NULL,
    type character varying(128) NOT NULL,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    id character varying(36) NOT NULL,
    "isManaged" boolean DEFAULT false NOT NULL,
    "isGlobal" boolean DEFAULT false NOT NULL
);


--
-- Name: data_table; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.data_table (
    id character varying(36) NOT NULL,
    name character varying(128) NOT NULL,
    "projectId" character varying(36) NOT NULL,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL
);


--
-- Name: data_table_column; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.data_table_column (
    id character varying(36) NOT NULL,
    name character varying(128) NOT NULL,
    type character varying(32) NOT NULL,
    index integer NOT NULL,
    "dataTableId" character varying(36) NOT NULL,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL
);


--
-- Name: COLUMN data_table_column.type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.data_table_column.type IS 'Expected: string, number, boolean, or date (not enforced as a constraint)';


--
-- Name: COLUMN data_table_column.index; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.data_table_column.index IS 'Column order, starting from 0 (0 = first column)';


--
-- Name: event_destinations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.event_destinations (
    id uuid NOT NULL,
    destination jsonb NOT NULL,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL
);


--
-- Name: execution_annotation_tags; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.execution_annotation_tags (
    "annotationId" integer NOT NULL,
    "tagId" character varying(24) NOT NULL
);


--
-- Name: execution_annotations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.execution_annotations (
    id integer NOT NULL,
    "executionId" integer NOT NULL,
    vote character varying(6),
    note text,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL
);


--
-- Name: execution_annotations_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.execution_annotations_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: execution_annotations_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.execution_annotations_id_seq OWNED BY public.execution_annotations.id;


--
-- Name: execution_data; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.execution_data (
    "executionId" integer NOT NULL,
    "workflowData" json NOT NULL,
    data text NOT NULL
);


--
-- Name: execution_entity; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.execution_entity (
    id integer NOT NULL,
    finished boolean NOT NULL,
    mode character varying NOT NULL,
    "retryOf" character varying,
    "retrySuccessId" character varying,
    "startedAt" timestamp(3) with time zone,
    "stoppedAt" timestamp(3) with time zone,
    "waitTill" timestamp(3) with time zone,
    status character varying NOT NULL,
    "workflowId" character varying(36) NOT NULL,
    "deletedAt" timestamp(3) with time zone,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL
);


--
-- Name: execution_entity_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.execution_entity_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: execution_entity_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.execution_entity_id_seq OWNED BY public.execution_entity.id;


--
-- Name: execution_metadata; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.execution_metadata (
    id integer NOT NULL,
    "executionId" integer NOT NULL,
    key character varying(255) NOT NULL,
    value text NOT NULL
);


--
-- Name: execution_metadata_temp_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.execution_metadata_temp_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: execution_metadata_temp_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.execution_metadata_temp_id_seq OWNED BY public.execution_metadata.id;


--
-- Name: folder; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.folder (
    id character varying(36) NOT NULL,
    name character varying(128) NOT NULL,
    "parentFolderId" character varying(36),
    "projectId" character varying(36) NOT NULL,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL
);


--
-- Name: folder_tag; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.folder_tag (
    "folderId" character varying(36) NOT NULL,
    "tagId" character varying(36) NOT NULL
);


--
-- Name: insights_by_period; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.insights_by_period (
    id integer NOT NULL,
    "metaId" integer NOT NULL,
    type integer NOT NULL,
    value bigint NOT NULL,
    "periodUnit" integer NOT NULL,
    "periodStart" timestamp(0) with time zone DEFAULT CURRENT_TIMESTAMP
);


--
-- Name: COLUMN insights_by_period.type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.insights_by_period.type IS '0: time_saved_minutes, 1: runtime_milliseconds, 2: success, 3: failure';


--
-- Name: COLUMN insights_by_period."periodUnit"; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.insights_by_period."periodUnit" IS '0: hour, 1: day, 2: week';


--
-- Name: insights_by_period_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.insights_by_period ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.insights_by_period_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: insights_metadata; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.insights_metadata (
    "metaId" integer NOT NULL,
    "workflowId" character varying(16),
    "projectId" character varying(36),
    "workflowName" character varying(128) NOT NULL,
    "projectName" character varying(255) NOT NULL
);


--
-- Name: insights_metadata_metaId_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.insights_metadata ALTER COLUMN "metaId" ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public."insights_metadata_metaId_seq"
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: insights_raw; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.insights_raw (
    id integer NOT NULL,
    "metaId" integer NOT NULL,
    type integer NOT NULL,
    value bigint NOT NULL,
    "timestamp" timestamp(0) with time zone DEFAULT CURRENT_TIMESTAMP NOT NULL
);


--
-- Name: COLUMN insights_raw.type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.insights_raw.type IS '0: time_saved_minutes, 1: runtime_milliseconds, 2: success, 3: failure';


--
-- Name: insights_raw_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.insights_raw ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.insights_raw_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: installed_nodes; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.installed_nodes (
    name character varying(200) NOT NULL,
    type character varying(200) NOT NULL,
    "latestVersion" integer DEFAULT 1 NOT NULL,
    package character varying(241) NOT NULL
);


--
-- Name: installed_packages; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.installed_packages (
    "packageName" character varying(214) NOT NULL,
    "installedVersion" character varying(50) NOT NULL,
    "authorName" character varying(70),
    "authorEmail" character varying(70),
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL
);


--
-- Name: invalid_auth_token; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.invalid_auth_token (
    token character varying(512) NOT NULL,
    "expiresAt" timestamp(3) with time zone NOT NULL
);


--
-- Name: migrations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.migrations (
    id integer NOT NULL,
    "timestamp" bigint NOT NULL,
    name character varying NOT NULL
);


--
-- Name: migrations_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.migrations_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: migrations_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.migrations_id_seq OWNED BY public.migrations.id;


--
-- Name: oauth_access_tokens; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.oauth_access_tokens (
    token character varying NOT NULL,
    "clientId" character varying NOT NULL,
    "userId" uuid NOT NULL
);


--
-- Name: oauth_authorization_codes; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.oauth_authorization_codes (
    code character varying(255) NOT NULL,
    "clientId" character varying NOT NULL,
    "userId" uuid NOT NULL,
    "redirectUri" character varying NOT NULL,
    "codeChallenge" character varying NOT NULL,
    "codeChallengeMethod" character varying(255) NOT NULL,
    "expiresAt" bigint NOT NULL,
    state character varying,
    used boolean DEFAULT false NOT NULL,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL
);


--
-- Name: COLUMN oauth_authorization_codes."expiresAt"; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.oauth_authorization_codes."expiresAt" IS 'Unix timestamp in milliseconds';


--
-- Name: oauth_clients; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.oauth_clients (
    id character varying NOT NULL,
    name character varying(255) NOT NULL,
    "redirectUris" json NOT NULL,
    "grantTypes" json NOT NULL,
    "clientSecret" character varying(255),
    "clientSecretExpiresAt" bigint,
    "tokenEndpointAuthMethod" character varying(255) DEFAULT 'none'::character varying NOT NULL,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL
);


--
-- Name: COLUMN oauth_clients."tokenEndpointAuthMethod"; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.oauth_clients."tokenEndpointAuthMethod" IS 'Possible values: none, client_secret_basic or client_secret_post';


--
-- Name: oauth_refresh_tokens; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.oauth_refresh_tokens (
    token character varying(255) NOT NULL,
    "clientId" character varying NOT NULL,
    "userId" uuid NOT NULL,
    "expiresAt" bigint NOT NULL,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL
);


--
-- Name: COLUMN oauth_refresh_tokens."expiresAt"; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.oauth_refresh_tokens."expiresAt" IS 'Unix timestamp in milliseconds';


--
-- Name: oauth_user_consents; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.oauth_user_consents (
    id integer NOT NULL,
    "userId" uuid NOT NULL,
    "clientId" character varying NOT NULL,
    "grantedAt" bigint NOT NULL
);


--
-- Name: COLUMN oauth_user_consents."grantedAt"; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.oauth_user_consents."grantedAt" IS 'Unix timestamp in milliseconds';


--
-- Name: oauth_user_consents_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.oauth_user_consents ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.oauth_user_consents_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: processed_data; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.processed_data (
    "workflowId" character varying(36) NOT NULL,
    context character varying(255) NOT NULL,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    value text NOT NULL
);


--
-- Name: project; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.project (
    id character varying(36) NOT NULL,
    name character varying(255) NOT NULL,
    type character varying(36) NOT NULL,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    icon json,
    description character varying(512)
);


--
-- Name: project_relation; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.project_relation (
    "projectId" character varying(36) NOT NULL,
    "userId" uuid NOT NULL,
    role character varying NOT NULL,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL
);


--
-- Name: role; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.role (
    slug character varying(128) NOT NULL,
    "displayName" text,
    description text,
    "roleType" text,
    "systemRole" boolean DEFAULT false NOT NULL,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL
);


--
-- Name: COLUMN role.slug; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.role.slug IS 'Unique identifier of the role for example: "global:owner"';


--
-- Name: COLUMN role."displayName"; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.role."displayName" IS 'Name used to display in the UI';


--
-- Name: COLUMN role.description; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.role.description IS 'Text describing the scope in more detail of users';


--
-- Name: COLUMN role."roleType"; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.role."roleType" IS 'Type of the role, e.g., global, project, or workflow';


--
-- Name: COLUMN role."systemRole"; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.role."systemRole" IS 'Indicates if the role is managed by the system and cannot be edited';


--
-- Name: role_scope; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.role_scope (
    "roleSlug" character varying(128) NOT NULL,
    "scopeSlug" character varying(128) NOT NULL
);


--
-- Name: scope; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.scope (
    slug character varying(128) NOT NULL,
    "displayName" text,
    description text
);


--
-- Name: COLUMN scope.slug; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.scope.slug IS 'Unique identifier of the scope for example: "project:create"';


--
-- Name: COLUMN scope."displayName"; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.scope."displayName" IS 'Name used to display in the UI';


--
-- Name: COLUMN scope.description; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.scope.description IS 'Text describing the scope in more detail of users';


--
-- Name: settings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.settings (
    key character varying(255) NOT NULL,
    value text NOT NULL,
    "loadOnStartup" boolean DEFAULT false NOT NULL
);


--
-- Name: shared_credentials; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.shared_credentials (
    "credentialsId" character varying(36) NOT NULL,
    "projectId" character varying(36) NOT NULL,
    role text NOT NULL,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL
);


--
-- Name: shared_workflow; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.shared_workflow (
    "workflowId" character varying(36) NOT NULL,
    "projectId" character varying(36) NOT NULL,
    role text NOT NULL,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL
);


--
-- Name: tag_entity; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.tag_entity (
    name character varying(24) NOT NULL,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    id character varying(36) NOT NULL
);


--
-- Name: test_case_execution; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.test_case_execution (
    id character varying(36) NOT NULL,
    "testRunId" character varying(36) NOT NULL,
    "executionId" integer,
    status character varying NOT NULL,
    "runAt" timestamp(3) with time zone,
    "completedAt" timestamp(3) with time zone,
    "errorCode" character varying,
    "errorDetails" json,
    metrics json,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    inputs json,
    outputs json
);


--
-- Name: test_run; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.test_run (
    id character varying(36) NOT NULL,
    "workflowId" character varying(36) NOT NULL,
    status character varying NOT NULL,
    "errorCode" character varying,
    "errorDetails" json,
    "runAt" timestamp(3) with time zone,
    "completedAt" timestamp(3) with time zone,
    metrics json,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL
);


--
-- Name: user; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public."user" (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    email character varying(255),
    "firstName" character varying(32),
    "lastName" character varying(32),
    password character varying(255),
    "personalizationAnswers" json,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    settings json,
    disabled boolean DEFAULT false NOT NULL,
    "mfaEnabled" boolean DEFAULT false NOT NULL,
    "mfaSecret" text,
    "mfaRecoveryCodes" text,
    "lastActiveAt" date,
    "roleSlug" character varying(128) DEFAULT 'global:member'::character varying NOT NULL
);


--
-- Name: user_api_keys; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.user_api_keys (
    id character varying(36) NOT NULL,
    "userId" uuid NOT NULL,
    label character varying(100) NOT NULL,
    "apiKey" character varying NOT NULL,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    scopes json,
    audience character varying DEFAULT 'public-api'::character varying NOT NULL
);


--
-- Name: variables; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.variables (
    key character varying(50) NOT NULL,
    type character varying(50) DEFAULT 'string'::character varying NOT NULL,
    value character varying(255),
    id character varying(36) NOT NULL,
    "projectId" character varying(36)
);


--
-- Name: webhook_entity; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.webhook_entity (
    "webhookPath" character varying NOT NULL,
    method character varying NOT NULL,
    node character varying NOT NULL,
    "webhookId" character varying,
    "pathLength" integer,
    "workflowId" character varying(36) NOT NULL
);


--
-- Name: workflow_dependency; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.workflow_dependency (
    id integer NOT NULL,
    "workflowId" character varying(36) NOT NULL,
    "workflowVersionId" integer NOT NULL,
    "dependencyType" character varying(32) NOT NULL,
    "dependencyKey" character varying(255) NOT NULL,
    "dependencyInfo" json,
    "indexVersionId" smallint DEFAULT 1 NOT NULL,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL
);


--
-- Name: COLUMN workflow_dependency."workflowVersionId"; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.workflow_dependency."workflowVersionId" IS 'Version of the workflow';


--
-- Name: COLUMN workflow_dependency."dependencyType"; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.workflow_dependency."dependencyType" IS 'Type of dependency: "credential", "nodeType", "webhookPath", or "workflowCall"';


--
-- Name: COLUMN workflow_dependency."dependencyKey"; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.workflow_dependency."dependencyKey" IS 'ID or name of the dependency';


--
-- Name: COLUMN workflow_dependency."dependencyInfo"; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.workflow_dependency."dependencyInfo" IS 'Additional info about the dependency, interpreted based on type';


--
-- Name: COLUMN workflow_dependency."indexVersionId"; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.workflow_dependency."indexVersionId" IS 'Version of the index structure';


--
-- Name: workflow_dependency_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.workflow_dependency ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.workflow_dependency_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: workflow_entity; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.workflow_entity (
    name character varying(128) NOT NULL,
    active boolean NOT NULL,
    nodes json NOT NULL,
    connections json NOT NULL,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    settings json,
    "staticData" json,
    "pinData" json,
    "versionId" character(36) NOT NULL,
    "triggerCount" integer DEFAULT 0 NOT NULL,
    id character varying(36) NOT NULL,
    meta json,
    "parentFolderId" character varying(36) DEFAULT NULL::character varying,
    "isArchived" boolean DEFAULT false NOT NULL,
    "versionCounter" integer DEFAULT 1 NOT NULL,
    description text,
    "activeVersionId" character varying(36)
);


--
-- Name: workflow_history; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.workflow_history (
    "versionId" character varying(36) NOT NULL,
    "workflowId" character varying(36) NOT NULL,
    authors character varying(255) NOT NULL,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    "updatedAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    nodes json NOT NULL,
    connections json NOT NULL,
    name character varying(128),
    autosaved boolean DEFAULT false NOT NULL,
    description text
);


--
-- Name: workflow_publish_history; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.workflow_publish_history (
    id integer NOT NULL,
    "workflowId" character varying(36) NOT NULL,
    "versionId" character varying(36) NOT NULL,
    event character varying(36) NOT NULL,
    "userId" uuid,
    "createdAt" timestamp(3) with time zone DEFAULT CURRENT_TIMESTAMP(3) NOT NULL,
    CONSTRAINT "CHK_workflow_publish_history_event" CHECK (((event)::text = ANY (ARRAY[('activated'::character varying)::text, ('deactivated'::character varying)::text])))
);


--
-- Name: COLUMN workflow_publish_history.event; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.workflow_publish_history.event IS 'Type of history record: activated (workflow is now active), deactivated (workflow is now inactive)';


--
-- Name: workflow_publish_history_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

ALTER TABLE public.workflow_publish_history ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (
    SEQUENCE NAME public.workflow_publish_history_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1
);


--
-- Name: workflow_statistics; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.workflow_statistics (
    count integer DEFAULT 0,
    "latestEvent" timestamp(3) with time zone,
    name character varying(128) NOT NULL,
    "workflowId" character varying(36) NOT NULL,
    "rootCount" integer DEFAULT 0
);


--
-- Name: workflows_tags; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.workflows_tags (
    "workflowId" character varying(36) NOT NULL,
    "tagId" character varying(36) NOT NULL
);


--
-- Name: auth_provider_sync_history id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.auth_provider_sync_history ALTER COLUMN id SET DEFAULT nextval('public.auth_provider_sync_history_id_seq'::regclass);


--
-- Name: execution_annotations id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.execution_annotations ALTER COLUMN id SET DEFAULT nextval('public.execution_annotations_id_seq'::regclass);


--
-- Name: execution_entity id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.execution_entity ALTER COLUMN id SET DEFAULT nextval('public.execution_entity_id_seq'::regclass);


--
-- Name: execution_metadata id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.execution_metadata ALTER COLUMN id SET DEFAULT nextval('public.execution_metadata_temp_id_seq'::regclass);


--
-- Name: migrations id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.migrations ALTER COLUMN id SET DEFAULT nextval('public.migrations_id_seq'::regclass);


--
-- Data for Name: annotation_tag_entity; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.annotation_tag_entity (id, name, "createdAt", "updatedAt") FROM stdin;
\.


--
-- Data for Name: auth_identity; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.auth_identity ("userId", "providerId", "providerType", "createdAt", "updatedAt") FROM stdin;
\.


--
-- Data for Name: auth_provider_sync_history; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.auth_provider_sync_history (id, "providerType", "runMode", status, "startedAt", "endedAt", scanned, created, updated, disabled, error) FROM stdin;
\.


--
-- Data for Name: binary_data; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.binary_data ("fileId", "sourceType", "sourceId", data, "mimeType", "fileName", "fileSize", "createdAt", "updatedAt") FROM stdin;
\.


--
-- Data for Name: chat_hub_agents; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.chat_hub_agents (id, name, description, "systemPrompt", "ownerId", "credentialId", provider, model, "createdAt", "updatedAt", tools) FROM stdin;
\.


--
-- Data for Name: chat_hub_messages; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.chat_hub_messages (id, "sessionId", "previousMessageId", "revisionOfMessageId", "retryOfMessageId", type, name, content, provider, model, "workflowId", "executionId", "createdAt", "updatedAt", "agentId", status, attachments) FROM stdin;
\.


--
-- Data for Name: chat_hub_sessions; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.chat_hub_sessions (id, title, "ownerId", "lastMessageAt", "credentialId", provider, model, "workflowId", "createdAt", "updatedAt", "agentId", "agentName", tools) FROM stdin;
\.


--
-- Data for Name: credentials_entity; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.credentials_entity (name, data, type, "createdAt", "updatedAt", id, "isManaged", "isGlobal") FROM stdin;
Gemini API	U2FsdGVkX1/luCaJIsUrFLOw3qr7+HhU1nWUKOKWP+uDeauZ9o11wdGFu2YlIAtIO0fVqROyjldLl8xzQ6o86yDUIqkY7+njXa8ST7XdApKsNbzoK4ZyU+QcLSfOmEGg	httpQueryAuth	2025-12-17 10:22:45.061+00	2025-12-17 10:22:45.061+00	Hp8gTY1C1efbSfkx	f	f
Serper API	U2FsdGVkX18W7WbmH8TIOh52NLbP2/8B1d4CVLZH7bLObK6EtiSmCirZ7o9TyQ+GVPfhq/8VB99lgtyMRNHHX2yHzkYP0WpzKRQUOiAwIDj3NOMXzB3DWU4dT/XWxp6J	httpHeaderAuth	2025-12-17 10:23:41.939+00	2025-12-17 10:23:41.939+00	01zZGrP0Fob8kD8r	f	f
OpenAI API	U2FsdGVkX1+w046s2aSkYxHpiZHK1TTQ2k0AFbptqjvZy3q2MSYvmudDCW95VFj/uxbe64PTVxw5QIyYdyfm64YLio+EOJ4VWZWKQJ/loik=	httpHeaderAuth	2025-12-17 10:24:32.046+00	2025-12-17 10:24:32.046+00	ThQVVDooMABNmQQm	f	f
Ahrefs API	U2FsdGVkX1/lHOGvYd4e83KaDS3AWKTjwoPPG11NT1IdaunqSw88EVTD/gv6gFillQWWRzca6oKcc9VY4/YBrPgHsVpPkJmSxGClo41kwrs=	httpHeaderAuth	2025-12-17 10:24:41.855+00	2025-12-17 10:24:41.855+00	tdfM9Y0L3V28A5wJ	f	f
SEO Suite MySQL	U2FsdGVkX18FCPu+sDIwmm3XP9eWw5b+c8c0431oIdsoOTLzlgYTf1l0iCfDC0bX2oimzv13MWj+E9NuBlUcy6Q4PUhY5Lr6V/L3jOOg3Ta4oYhPhSUA1OE9+nMKIIgMPS9Rf7Brt7w0I0K0Y5KNdiAnQWDEo5yuJBckJfW4iyU=	mySql	2025-12-17 09:55:39.804+00	2025-12-18 19:27:20.327+00	1rDLBK64lV00T0am	f	f
Google Sheets account	U2FsdGVkX18zmD+IswJ6u+IbUu9AKVMuV+slbpWDPFBpTAy9OPKdshBITw85JhLOo5YmXMQcW/tArd0Fk5R1Lo5dIPK0RP40k0o9/KLlTiU8WuAjAVw/RgGpvYoYmdIGMcPXwrOq6ok6sPdlRsKbTYDm8DGT2I2/1omRdLUfTd67c5cAhd/ora59eetK8CV/fehEiaE8YC3xJfmuJlWBFqoilGsM3bkNMn3rQiY4rDfDd2XmbpLJ1QdEMJtZIC/B0qdP44kDdDCP/chbv8XPxZlBXDoomuYpar/lO9Jf+2fKzL6glHQDgLbhmJQQB6Rfk9rLIrMO69AF7WGgDTRTJGpIBenU5kxjfpZ1MhF/OI1bpwZnLjEn0g2/KDnyv1QFSwJnNdj5/xKrsWHHzdx8lwjDHZ5Y2MKZ71uz2WU0zQL7XsP5lCd6ai6/mCzx1NjkoRP65I3M28HBR3w70ZCE7tBpoUFi/bbRsZynnmo0sLT9LInKt+Nvs1kMtItUENudGooXgp/QkaTmAfS831z+RAXy1aZCs8hzDpBIOchFv3+CUq12CB1hqEN2bqtQ3edgP7cqV5Jw/UEPnX0CAvxikTv7GTFlj1rfzfLckhx/u9QvcebJNdiTofVHTSJlMxhAAyi4dWgtu8ZvSdu5kezdxOEf4McTRTVrMT3TVAU/UBNYoknifj5vSIoDP6O69hHAVLblWXFxYdMqhMren2d12n71xUqAaxon+01A8M7//MqecBmfdBo6/hWMi1EeMEKDlxt/FoXEje6Rn5rGnFpymEsaiTCGYW7Xc33Scd5LzlnqdrAj7NvWuBJvq8mXvOn6PaLCaBr8XBzojUokQRzu9uJWoZAqKPUfI+sa3SRWp5++ygA5jsq1AjR0iB9epSVm3D5o/sW0T35pjQKdMYelXhen9ApP3yODOFsKarNB/YthOtPyP4wTXDOA1MsTLf9T5kzbJfIH9FwVBgtrUc52nCe1F8/LRpvhASTJSXyuAhh/O6ieTcQqVhNjjbPJYVlxG3tvKIeT1ha8aOWrhmIwYyPQncs+FnlbHlxkqMCJI30PDMfDDDrjqoJZb/8vZWwe/qhq1q00n6Efus0u6RndaSMPN5/d4qMRFlRT+uJDxJp7ZswNfl6N6J8Hqe3VmaNzx1Mib7B6WjxTqnp8dm2DbPf7UOGmcfm1h7X0xZFpF8lo+kZL5L0xhAvzoL0N6BoYp/JKpBwYa+z44Ez8ekB974GOsISam2x/3IxQT2+TCnQL5Gy63PysKzujhsxtGvgW	googleSheetsOAuth2Api	2025-12-18 11:58:28.605+00	2025-12-21 11:06:52.472+00	FRUwxjFQM3dnpWm4	f	f
\.


--
-- Data for Name: data_table; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.data_table (id, name, "projectId", "createdAt", "updatedAt") FROM stdin;
\.


--
-- Data for Name: data_table_column; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.data_table_column (id, name, type, index, "dataTableId", "createdAt", "updatedAt") FROM stdin;
\.


--
-- Data for Name: event_destinations; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.event_destinations (id, destination, "createdAt", "updatedAt") FROM stdin;
\.


--
-- Data for Name: execution_annotation_tags; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.execution_annotation_tags ("annotationId", "tagId") FROM stdin;
\.


--
-- Data for Name: execution_annotations; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.execution_annotations (id, "executionId", vote, note, "createdAt", "updatedAt") FROM stdin;
\.


--
-- Data for Name: folder; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.folder (id, name, "parentFolderId", "projectId", "createdAt", "updatedAt") FROM stdin;
\.


--
-- Data for Name: folder_tag; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.folder_tag ("folderId", "tagId") FROM stdin;
\.


--
-- Data for Name: insights_by_period; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.insights_by_period (id, "metaId", type, value, "periodUnit", "periodStart") FROM stdin;
12	4	2	5	0	2025-12-17 10:00:00+00
13	5	2	2	0	2025-12-17 10:00:00+00
14	5	1	60090	0	2025-12-17 10:00:00+00
16	8	1	582	0	2025-12-17 10:00:00+00
17	8	3	2	0	2025-12-17 10:00:00+00
18	7	2	1	0	2025-12-17 10:00:00+00
20	6	1	1612	0	2025-12-17 10:00:00+00
21	4	1	1161	0	2025-12-17 10:00:00+00
22	7	1	2054	0	2025-12-17 10:00:00+00
23	6	2	8	0	2025-12-17 10:00:00+00
24	5	2	1	0	2025-12-17 11:00:00+00
15	9	1	194	0	2025-12-17 11:00:00+00
26	5	1	19250	0	2025-12-17 11:00:00+00
19	9	2	2	0	2025-12-17 11:00:00+00
28	4	2	11	0	2025-12-17 11:00:00+00
29	6	1	101	0	2025-12-17 11:00:00+00
30	6	2	1	0	2025-12-17 11:00:00+00
31	4	1	4017	0	2025-12-17 11:00:00+00
32	6	2	2	0	2025-12-17 12:00:00+00
33	6	1	1420	0	2025-12-17 12:00:00+00
34	5	1	156847	0	2025-12-17 12:00:00+00
35	4	2	1	0	2025-12-17 12:00:00+00
36	5	2	5	0	2025-12-17 12:00:00+00
37	4	1	168	0	2025-12-17 12:00:00+00
38	4	1	7144	0	2025-12-17 13:00:00+00
39	5	2	1	0	2025-12-17 13:00:00+00
40	6	2	1	0	2025-12-17 13:00:00+00
41	4	2	17	0	2025-12-17 13:00:00+00
44	5	1	32620	0	2025-12-17 13:00:00+00
45	6	1	245	0	2025-12-17 13:00:00+00
49	10	2	1	0	2025-12-17 14:00:00+00
51	5	1	384646	0	2025-12-17 14:00:00+00
52	10	1	821	0	2025-12-17 14:00:00+00
53	11	2	1	0	2025-12-17 14:00:00+00
54	9	2	39	0	2025-12-17 14:00:00+00
55	7	2	1	0	2025-12-17 14:00:00+00
56	9	1	4264	0	2025-12-17 14:00:00+00
42	6	2	10	0	2025-12-17 14:00:00+00
43	6	1	6381	0	2025-12-17 14:00:00+00
59	11	1	1329	0	2025-12-17 14:00:00+00
60	5	2	7	0	2025-12-17 14:00:00+00
61	7	1	1480	0	2025-12-17 14:00:00+00
46	4	2	18	0	2025-12-17 14:00:00+00
47	4	1	7875	0	2025-12-17 14:00:00+00
48	5	2	5	0	2025-12-17 15:00:00+00
65	9	2	1	0	2025-12-17 15:00:00+00
50	5	1	113785	0	2025-12-17 15:00:00+00
67	9	1	184	0	2025-12-17 15:00:00+00
68	9	2	1	0	2025-12-17 16:00:00+00
69	4	1	184	0	2025-12-17 15:00:00+00
70	9	1	156	0	2025-12-17 16:00:00+00
71	4	2	1	0	2025-12-17 15:00:00+00
72	5	1	36037	0	2025-12-17 18:00:00+00
73	5	2	1	0	2025-12-17 18:00:00+00
74	4	2	1	0	2025-12-17 18:00:00+00
75	4	1	277	0	2025-12-17 18:00:00+00
76	4	1	131	0	2025-12-17 22:00:00+00
77	5	1	57014	0	2025-12-17 22:00:00+00
78	5	2	1	0	2025-12-17 22:00:00+00
79	4	2	1	0	2025-12-17 22:00:00+00
80	5	1	59151	0	2025-12-18 07:00:00+00
81	6	2	1	0	2025-12-18 07:00:00+00
82	6	1	2665	0	2025-12-18 07:00:00+00
83	4	1	5760	0	2025-12-18 07:00:00+00
84	4	2	3	0	2025-12-18 07:00:00+00
85	5	2	1	0	2025-12-18 07:00:00+00
86	4	2	1	0	2025-12-18 08:00:00+00
87	5	2	1	0	2025-12-18 08:00:00+00
88	5	1	58179	0	2025-12-18 08:00:00+00
89	4	1	259	0	2025-12-18 08:00:00+00
90	9	1	112	0	2025-12-18 09:00:00+00
91	5	2	1	0	2025-12-18 09:00:00+00
92	5	1	101489	0	2025-12-18 09:00:00+00
93	6	1	250	0	2025-12-18 09:00:00+00
94	4	2	6	0	2025-12-18 09:00:00+00
95	6	2	1	0	2025-12-18 09:00:00+00
96	9	2	2	0	2025-12-18 09:00:00+00
97	4	1	745	0	2025-12-18 09:00:00+00
98	12	2	1	0	2025-12-18 10:00:00+00
99	4	2	4	0	2025-12-18 10:00:00+00
100	12	1	98	0	2025-12-18 10:00:00+00
101	4	1	1267	0	2025-12-18 10:00:00+00
102	4	2	5	0	2025-12-18 11:00:00+00
103	4	1	984	0	2025-12-18 11:00:00+00
104	4	1	751	0	2025-12-18 12:00:00+00
105	5	2	2	0	2025-12-18 13:00:00+00
107	12	1	174	0	2025-12-18 12:00:00+00
108	5	2	3	0	2025-12-18 12:00:00+00
111	5	1	56637	0	2025-12-18 13:00:00+00
112	12	2	4	0	2025-12-18 12:00:00+00
113	6	1	1755	0	2025-12-18 12:00:00+00
115	6	2	7	0	2025-12-18 12:00:00+00
116	5	1	108443	0	2025-12-18 12:00:00+00
117	4	2	5	0	2025-12-18 12:00:00+00
106	12	1	89	0	2025-12-18 13:00:00+00
109	12	2	2	0	2025-12-18 13:00:00+00
110	4	1	504	0	2025-12-18 13:00:00+00
114	4	2	4	0	2025-12-18 13:00:00+00
126	12	2	2	0	2025-12-18 14:00:00+00
127	6	1	3479	0	2025-12-18 14:00:00+00
128	5	1	137756	0	2025-12-18 15:00:00+00
121	4	2	5	0	2025-12-18 14:00:00+00
130	6	2	2	0	2025-12-18 14:00:00+00
131	5	2	3	0	2025-12-18 15:00:00+00
123	4	1	40740	0	2025-12-18 14:00:00+00
124	5	1	74366	0	2025-12-18 14:00:00+00
125	5	2	4	0	2025-12-18 14:00:00+00
135	12	1	266	0	2025-12-18 14:00:00+00
137	5	2	4	0	2025-12-18 17:00:00+00
139	5	1	113984	0	2025-12-18 17:00:00+00
140	12	2	1	0	2025-12-18 19:00:00+00
136	4	2	3	0	2025-12-18 17:00:00+00
142	5	2	6	0	2025-12-18 19:00:00+00
143	5	3	1	0	2025-12-18 19:00:00+00
144	4	1	370	0	2025-12-18 18:00:00+00
145	12	1	70	0	2025-12-18 19:00:00+00
146	4	3	1	0	2025-12-18 18:00:00+00
138	4	1	561	0	2025-12-18 17:00:00+00
148	5	1	174057	0	2025-12-18 19:00:00+00
150	25	1	60480	0	2025-12-19 09:00:00+00
151	29	1	2651	0	2025-12-19 10:00:00+00
153	27	1	95886	0	2025-12-19 09:00:00+00
154	34	3	4	0	2025-12-19 10:00:00+00
155	12	2	3	0	2025-12-19 10:00:00+00
156	24	1	63601	0	2025-12-19 08:00:00+00
157	22	2	7	0	2025-12-19 08:00:00+00
158	26	2	2	0	2025-12-19 09:00:00+00
159	5	2	2	0	2025-12-19 08:00:00+00
160	27	2	4	0	2025-12-19 09:00:00+00
161	33	1	4457	0	2025-12-19 10:00:00+00
162	33	2	2	0	2025-12-19 10:00:00+00
163	12	2	3	0	2025-12-19 09:00:00+00
164	29	3	9	0	2025-12-19 09:00:00+00
165	4	2	2	0	2025-12-19 08:00:00+00
166	29	2	1	0	2025-12-19 10:00:00+00
167	26	1	56170	0	2025-12-19 09:00:00+00
168	24	2	4	0	2025-12-19 08:00:00+00
169	5	1	68428	0	2025-12-19 08:00:00+00
170	12	1	181	0	2025-12-19 09:00:00+00
171	29	1	720	0	2025-12-19 09:00:00+00
172	25	2	2	0	2025-12-19 09:00:00+00
173	22	1	160628	0	2025-12-19 08:00:00+00
174	12	1	317	0	2025-12-19 10:00:00+00
175	4	1	795	0	2025-12-19 08:00:00+00
149	34	1	14497	0	2025-12-19 10:00:00+00
152	34	2	4	0	2025-12-19 10:00:00+00
178	34	1	21841	0	2025-12-19 11:00:00+00
179	34	2	11	0	2025-12-19 11:00:00+00
180	36	2	1	0	2025-12-19 12:00:00+00
185	4	1	1065	0	2025-12-19 12:00:00+00
186	35	2	1	0	2025-12-19 12:00:00+00
189	4	2	2	0	2025-12-19 12:00:00+00
190	39	1	882	0	2025-12-19 12:00:00+00
193	36	1	904	0	2025-12-19 12:00:00+00
196	39	2	1	0	2025-12-19 12:00:00+00
197	35	1	656	0	2025-12-19 12:00:00+00
198	12	1	257	0	2025-12-19 13:00:00+00
199	40	3	2	0	2025-12-19 13:00:00+00
181	38	1	4024	0	2025-12-19 12:00:00+00
182	34	1	6660	0	2025-12-19 12:00:00+00
183	29	2	3	0	2025-12-19 12:00:00+00
184	34	2	4	0	2025-12-19 12:00:00+00
187	38	3	2	0	2025-12-19 12:00:00+00
188	12	2	3	0	2025-12-19 12:00:00+00
206	34	2	8	0	2025-12-19 13:00:00+00
207	4	2	4	0	2025-12-19 13:00:00+00
208	4	1	7280	0	2025-12-19 13:00:00+00
209	38	3	1	0	2025-12-19 13:00:00+00
210	40	1	168605	0	2025-12-19 13:00:00+00
211	40	2	4	0	2025-12-19 13:00:00+00
212	38	1	5905	0	2025-12-19 13:00:00+00
191	12	1	202	0	2025-12-19 12:00:00+00
192	33	1	6322	0	2025-12-19 12:00:00+00
215	34	1	31194	0	2025-12-19 13:00:00+00
216	12	2	2	0	2025-12-19 13:00:00+00
194	33	2	4	0	2025-12-19 12:00:00+00
195	29	1	4499	0	2025-12-19 12:00:00+00
219	38	2	1	0	2025-12-19 13:00:00+00
220	4	1	568	0	2025-12-19 14:00:00+00
221	4	2	1	0	2025-12-19 15:00:00+00
222	4	1	670	0	2025-12-19 15:00:00+00
223	4	2	1	0	2025-12-19 14:00:00+00
224	34	1	4823	0	2025-12-19 19:00:00+00
225	34	2	1	0	2025-12-19 19:00:00+00
226	40	2	1	0	2025-12-21 10:00:00+00
227	40	1	47248	0	2025-12-21 10:00:00+00
228	33	2	1	0	2025-12-21 11:00:00+00
229	29	2	1	0	2025-12-21 11:00:00+00
230	40	1	374364	0	2025-12-21 11:00:00+00
231	12	2	2	0	2025-12-21 11:00:00+00
232	34	2	2	0	2025-12-21 11:00:00+00
233	4	2	2	0	2025-12-21 11:00:00+00
234	29	1	1365	0	2025-12-21 11:00:00+00
235	12	3	2	0	2025-12-21 11:00:00+00
236	33	1	2004	0	2025-12-21 11:00:00+00
237	12	1	628	0	2025-12-21 11:00:00+00
238	40	2	8	0	2025-12-21 11:00:00+00
239	4	1	731	0	2025-12-21 11:00:00+00
240	34	1	8292	0	2025-12-21 11:00:00+00
241	40	1	97102	0	2025-12-22 13:00:00+00
242	40	2	3	0	2025-12-22 13:00:00+00
243	40	1	64981	0	2025-12-22 14:00:00+00
244	4	1	497	0	2025-12-22 14:00:00+00
245	4	2	1	0	2025-12-22 14:00:00+00
246	40	2	2	0	2025-12-22 14:00:00+00
247	4	2	2	0	2025-12-22 16:00:00+00
248	4	1	881	0	2025-12-22 16:00:00+00
249	4	1	2001	0	2025-12-22 17:00:00+00
250	4	2	7	0	2025-12-22 17:00:00+00
251	12	1	407	0	2025-12-22 19:00:00+00
253	4	2	4	0	2025-12-22 19:00:00+00
254	12	2	4	0	2025-12-22 19:00:00+00
256	4	1	2092	0	2025-12-22 19:00:00+00
257	4	2	2	0	2025-12-23 07:00:00+00
252	4	1	1271	0	2025-12-22 20:00:00+00
259	4	1	846	0	2025-12-23 07:00:00+00
255	4	2	2	0	2025-12-22 20:00:00+00
261	40	1	33764	0	2025-12-23 10:00:00+00
262	4	2	1	0	2025-12-23 08:00:00+00
263	40	2	2	0	2025-12-23 10:00:00+00
265	54	1	220345	0	2025-12-23 10:00:00+00
267	54	2	2	0	2025-12-23 10:00:00+00
268	54	1	40650	0	2025-12-23 08:00:00+00
269	54	3	2	0	2025-12-23 08:00:00+00
270	4	1	453	0	2025-12-23 08:00:00+00
264	54	2	5	0	2025-12-23 11:00:00+00
266	54	1	646566	0	2025-12-23 11:00:00+00
273	54	2	3	0	2025-12-23 12:00:00+00
274	54	1	461776	0	2025-12-23 12:00:00+00
275	54	1	559713	0	2025-12-23 13:00:00+00
276	54	2	5	0	2025-12-23 13:00:00+00
277	54	2	5	0	2025-12-23 14:00:00+00
278	54	1	217087	0	2025-12-23 14:00:00+00
279	4	1	0	0	2025-12-23 14:00:00+00
280	40	1	30090	0	2025-12-23 14:00:00+00
281	40	2	1	0	2025-12-23 14:00:00+00
282	4	2	1	0	2025-12-23 14:00:00+00
283	70	1	374	0	2025-12-23 19:00:00+00
284	72	1	85326	0	2025-12-24 07:00:00+00
285	71	2	1	0	2025-12-23 20:00:00+00
286	4	1	1219	0	2025-12-24 07:00:00+00
287	71	1	28493	0	2025-12-23 20:00:00+00
288	71	1	158	0	2025-12-23 19:00:00+00
289	4	2	1	0	2025-12-24 07:00:00+00
290	71	2	1	0	2025-12-23 19:00:00+00
291	72	1	79059	0	2025-12-23 20:00:00+00
292	72	2	4	0	2025-12-23 20:00:00+00
293	71	1	32814	0	2025-12-24 07:00:00+00
294	70	2	2	0	2025-12-23 19:00:00+00
295	71	2	1	0	2025-12-24 07:00:00+00
296	72	2	3	0	2025-12-24 07:00:00+00
297	72	2	3	0	2025-12-24 08:00:00+00
298	72	1	49716	0	2025-12-24 08:00:00+00
299	71	1	23551	0	2025-12-24 08:00:00+00
300	40	1	7003	0	2025-12-24 08:00:00+00
301	4	2	1	0	2025-12-24 08:00:00+00
302	4	1	1196	0	2025-12-24 08:00:00+00
303	40	2	1	0	2025-12-24 08:00:00+00
304	71	2	1	0	2025-12-24 08:00:00+00
\.


--
-- Data for Name: insights_metadata; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.insights_metadata ("metaId", "workflowId", "projectId", "workflowName", "projectName") FROM stdin;
7	6nclsXOjxGhT8qJs	vMTnhKlkE0V1r3hl	WF-101b: AI Keyword Filter	Fatih Berkay Baheci <hello@pera.works>
8	x03Ivd085mWitZQ9	vMTnhKlkE0V1r3hl	WF-107: Opportunity Scorer	Fatih Berkay Baheci <hello@pera.works>
9	nuQVa3YLSJFRC4Ny	vMTnhKlkE0V1r3hl	WF-001 Clients CRUD Operations	Fatih Berkay Baheci <hello@pera.works>
10	yyD1QW0PcJgp3ik2	vMTnhKlkE0V1r3hl	WF-101a: Keyword Discovery	Fatih Berkay Baheci <hello@pera.works>
11	UxU00NHUOlNJSpFi	vMTnhKlkE0V1r3hl	WF-104: Competitor Analyzer	Fatih Berkay Baheci <hello@pera.works>
6	yd6UhBrs7iqGeEg6	vMTnhKlkE0V1r3hl	WF-102: Get Keyword Project	Fatih Berkay Baheci <hello@pera.works>
29	cRzztL0RsykZYA9k	vMTnhKlkE0V1r3hl	WF-002 Sheets Connect	Fatih Berkay Baheci <hello@pera.works>
33	IGWk6RXq1AHpB4L1	vMTnhKlkE0V1r3hl	WF-003 Sheets Get Columns	Fatih Berkay Baheci <hello@pera.works>
22	\N	vMTnhKlkE0V1r3hl	WF-KEYWORD-RESEARCH: Keyword Discovery & Filter v3	Fatih Berkay Baheci <hello@pera.works>
5	\N	vMTnhKlkE0V1r3hl	WF-KEYWORD-RESEARCH: Keyword Discovery & Filter v3	Fatih Berkay Baheci <hello@pera.works>
24	\N	vMTnhKlkE0V1r3hl	WF-KEYWORD-RESEARCH: Keyword Discovery & Filter v3	Fatih Berkay Baheci <hello@pera.works>
25	\N	vMTnhKlkE0V1r3hl	WF-KEYWORD-RESEARCH: Keyword Discovery & Filter v3	Fatih Berkay Baheci <hello@pera.works>
26	\N	vMTnhKlkE0V1r3hl	WF-KEYWORD-RESEARCH: Keyword Discovery & Filter v3	Fatih Berkay Baheci <hello@pera.works>
27	886MnxYqCbAQ1Bjz	vMTnhKlkE0V1r3hl	WF-KEYWORD-RESEARCH: Keyword Discovery & Filter v3	Fatih Berkay Baheci <hello@pera.works>
35	IoTg8e61J99uOFka	vMTnhKlkE0V1r3hl	WF-006 Sheets Get Cell	Fatih Berkay Baheci <hello@pera.works>
36	O9VRT7UV70STh36c	vMTnhKlkE0V1r3hl	WF-007 Sheets Get Row	Fatih Berkay Baheci <hello@pera.works>
12	WpQy66Cn5XTG9pFD	vMTnhKlkE0V1r3hl	WF-002 Client Prompts CRUD Operations	Fatih Berkay Baheci <hello@pera.works>
39	GcCbIVDLCEBXWH4c	vMTnhKlkE0V1r3hl	WF-008 Sheets Test	Fatih Berkay Baheci <hello@pera.works>
34	k21swmfiM5y9Dspc	vMTnhKlkE0V1r3hl	WF-005 Sheets Write	Fatih Berkay Baheci <hello@pera.works>
38	fkgU1ClgOCaGeuXR	vMTnhKlkE0V1r3hl	WF-004 Sheets Check	Fatih Berkay Baheci <hello@pera.works>
40	j3jZIjdsJSchQqCe	vMTnhKlkE0V1r3hl	WF-KEYWORD-RESEARCH: Keyword Discovery & Filter v3	Fatih Berkay Baheci <hello@pera.works>
54	adol4O3V4iGsGXpf	vMTnhKlkE0V1r3hl	WF-KEYWORD-RESEARCH: Bulk v13	Fatih Berkay Baheci <hello@pera.works>
4	9wxzOy1QgENPVVSD	vMTnhKlkE0V1r3hl	WF-103: List Keyword Projects	Fatih Berkay Baheci <hello@pera.works>
70	sWwmP23m89DQTpVI	vMTnhKlkE0V1r3hl	WF-BULK-KEYWORD: Main Controller	Fatih Berkay Baheci <hello@pera.works>
72	mNQs5AgZjCB0MIZx	vMTnhKlkE0V1r3hl	WF-BULK-KEYWORD: Single Seed v2	Fatih Berkay Baheci <hello@pera.works>
71	wl9T4eOGoazJkDdv	vMTnhKlkE0V1r3hl	WF-BULK-KEYWORD: Main v3	Fatih Berkay Baheci <hello@pera.works>
\.


--
-- Data for Name: insights_raw; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.insights_raw (id, "metaId", type, value, "timestamp") FROM stdin;
\.


--
-- Data for Name: installed_nodes; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.installed_nodes (name, type, "latestVersion", package) FROM stdin;
\.


--
-- Data for Name: installed_packages; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.installed_packages ("packageName", "installedVersion", "authorName", "authorEmail", "createdAt", "updatedAt") FROM stdin;
\.


--
-- Data for Name: invalid_auth_token; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.invalid_auth_token (token, "expiresAt") FROM stdin;
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImViYzA0YTFhLTViODAtNGRlMi04YjY1LTM4MmMwY2Q5MzkzYyIsImhhc2giOiJ4NGRRbWUzUWVmIiwiYnJvd3NlcklkIjoiekJZWFhXcVhrSGpIVURIVENycnBzRnJhdHRwL0Zkd1FreHRFVVF0MjlYST0iLCJ1c2VkTWZhIjpmYWxzZSwiaWF0IjoxNzY1OTYyNTY5LCJleHAiOjE3NjY1NjczNjl9.ReUbmzS5alHCV4o_wQhOpqsiANOPozgtIzPyzEAU3yA	2025-12-24 09:09:29+00
\.


--
-- Data for Name: migrations; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.migrations (id, "timestamp", name) FROM stdin;
1	1587669153312	InitialMigration1587669153312
2	1589476000887	WebhookModel1589476000887
3	1594828256133	CreateIndexStoppedAt1594828256133
4	1607431743768	MakeStoppedAtNullable1607431743768
5	1611144599516	AddWebhookId1611144599516
6	1617270242566	CreateTagEntity1617270242566
7	1620824779533	UniqueWorkflowNames1620824779533
8	1626176912946	AddwaitTill1626176912946
9	1630419189837	UpdateWorkflowCredentials1630419189837
10	1644422880309	AddExecutionEntityIndexes1644422880309
11	1646834195327	IncreaseTypeVarcharLimit1646834195327
12	1646992772331	CreateUserManagement1646992772331
13	1648740597343	LowerCaseUserEmail1648740597343
14	1652254514002	CommunityNodes1652254514002
15	1652367743993	AddUserSettings1652367743993
16	1652905585850	AddAPIKeyColumn1652905585850
17	1654090467022	IntroducePinData1654090467022
18	1658932090381	AddNodeIds1658932090381
19	1659902242948	AddJsonKeyPinData1659902242948
20	1660062385367	CreateCredentialsUserRole1660062385367
21	1663755770893	CreateWorkflowsEditorRole1663755770893
22	1664196174001	WorkflowStatistics1664196174001
23	1665484192212	CreateCredentialUsageTable1665484192212
24	1665754637025	RemoveCredentialUsageTable1665754637025
25	1669739707126	AddWorkflowVersionIdColumn1669739707126
26	1669823906995	AddTriggerCountColumn1669823906995
27	1671535397530	MessageEventBusDestinations1671535397530
28	1671726148421	RemoveWorkflowDataLoadedFlag1671726148421
29	1673268682475	DeleteExecutionsWithWorkflows1673268682475
30	1674138566000	AddStatusToExecutions1674138566000
31	1674509946020	CreateLdapEntities1674509946020
32	1675940580449	PurgeInvalidWorkflowConnections1675940580449
33	1676996103000	MigrateExecutionStatus1676996103000
34	1677236854063	UpdateRunningExecutionStatus1677236854063
35	1677501636754	CreateVariables1677501636754
36	1679416281778	CreateExecutionMetadataTable1679416281778
37	1681134145996	AddUserActivatedProperty1681134145996
38	1681134145997	RemoveSkipOwnerSetup1681134145997
39	1690000000000	MigrateIntegerKeysToString1690000000000
40	1690000000020	SeparateExecutionData1690000000020
41	1690000000030	RemoveResetPasswordColumns1690000000030
42	1690000000030	AddMfaColumns1690000000030
43	1690787606731	AddMissingPrimaryKeyOnExecutionData1690787606731
44	1691088862123	CreateWorkflowNameIndex1691088862123
45	1692967111175	CreateWorkflowHistoryTable1692967111175
46	1693491613982	ExecutionSoftDelete1693491613982
47	1693554410387	DisallowOrphanExecutions1693554410387
48	1694091729095	MigrateToTimestampTz1694091729095
49	1695128658538	AddWorkflowMetadata1695128658538
50	1695829275184	ModifyWorkflowHistoryNodesAndConnections1695829275184
51	1700571993961	AddGlobalAdminRole1700571993961
52	1705429061930	DropRoleMapping1705429061930
53	1711018413374	RemoveFailedExecutionStatus1711018413374
54	1711390882123	MoveSshKeysToDatabase1711390882123
55	1712044305787	RemoveNodesAccess1712044305787
56	1714133768519	CreateProject1714133768519
57	1714133768521	MakeExecutionStatusNonNullable1714133768521
58	1717498465931	AddActivatedAtUserSetting1717498465931
59	1720101653148	AddConstraintToExecutionMetadata1720101653148
60	1721377157740	FixExecutionMetadataSequence1721377157740
61	1723627610222	CreateInvalidAuthTokenTable1723627610222
62	1723796243146	RefactorExecutionIndices1723796243146
63	1724753530828	CreateAnnotationTables1724753530828
64	1724951148974	AddApiKeysTable1724951148974
65	1726606152711	CreateProcessedDataTable1726606152711
66	1727427440136	SeparateExecutionCreationFromStart1727427440136
67	1728659839644	AddMissingPrimaryKeyOnAnnotationTagMapping1728659839644
68	1729607673464	UpdateProcessedDataValueColumnToText1729607673464
69	1729607673469	AddProjectIcons1729607673469
70	1730386903556	CreateTestDefinitionTable1730386903556
71	1731404028106	AddDescriptionToTestDefinition1731404028106
72	1731582748663	MigrateTestDefinitionKeyToString1731582748663
73	1732271325258	CreateTestMetricTable1732271325258
74	1732549866705	CreateTestRun1732549866705
75	1733133775640	AddMockedNodesColumnToTestDefinition1733133775640
76	1734479635324	AddManagedColumnToCredentialsTable1734479635324
77	1736172058779	AddStatsColumnsToTestRun1736172058779
78	1736947513045	CreateTestCaseExecutionTable1736947513045
79	1737715421462	AddErrorColumnsToTestRuns1737715421462
80	1738709609940	CreateFolderTable1738709609940
81	1739549398681	CreateAnalyticsTables1739549398681
82	1740445074052	UpdateParentFolderIdColumn1740445074052
83	1741167584277	RenameAnalyticsToInsights1741167584277
84	1742918400000	AddScopesColumnToApiKeys1742918400000
85	1745322634000	ClearEvaluation1745322634000
86	1745587087521	AddWorkflowStatisticsRootCount1745587087521
87	1745934666076	AddWorkflowArchivedColumn1745934666076
88	1745934666077	DropRoleTable1745934666077
89	1747824239000	AddProjectDescriptionColumn1747824239000
90	1750252139166	AddLastActiveAtColumnToUser1750252139166
91	1750252139166	AddScopeTables1750252139166
92	1750252139167	AddRolesTables1750252139167
93	1750252139168	LinkRoleToUserTable1750252139168
94	1750252139170	RemoveOldRoleColumn1750252139170
95	1752669793000	AddInputsOutputsToTestCaseExecution1752669793000
96	1753953244168	LinkRoleToProjectRelationTable1753953244168
97	1754475614601	CreateDataStoreTables1754475614601
98	1754475614602	ReplaceDataStoreTablesWithDataTables1754475614602
99	1756906557570	AddTimestampsToRoleAndRoleIndexes1756906557570
100	1758731786132	AddAudienceColumnToApiKeys1758731786132
101	1758794506893	AddProjectIdToVariableTable1758794506893
102	1759399811000	ChangeValueTypesForInsights1759399811000
103	1760019379982	CreateChatHubTables1760019379982
104	1760020000000	CreateChatHubAgentTable1760020000000
105	1760020838000	UniqueRoleNames1760020838000
106	1760116750277	CreateOAuthEntities1760116750277
107	1760314000000	CreateWorkflowDependencyTable1760314000000
108	1760965142113	DropUnusedChatHubColumns1760965142113
109	1761047826451	AddWorkflowVersionColumn1761047826451
110	1761655473000	ChangeDependencyInfoToJson1761655473000
111	1761773155024	AddAttachmentsToChatHubMessages1761773155024
112	1761830340990	AddToolsColumnToChatHubTables1761830340990
113	1762177736257	AddWorkflowDescriptionColumn1762177736257
114	1762763704614	BackfillMissingWorkflowHistoryRecords1762763704614
115	1762771264000	ChangeDefaultForIdInUserTable1762771264000
116	1762771954619	AddIsGlobalColumnToCredentialsTable1762771954619
117	1762847206508	AddWorkflowHistoryAutoSaveFields1762847206508
118	1763047800000	AddActiveVersionIdColumn1763047800000
119	1763572724000	ChangeOAuthStateColumnToUnboundedVarchar1763572724000
120	1763716655000	CreateBinaryDataTable1763716655000
121	1763048000000	ActivateExecuteWorkflowTriggerWorkflows1763048000000
122	1764167920585	CreateWorkflowPublishHistoryTable1764167920585
123	1765448186933	BackfillMissingWorkflowHistoryRecords1765448186933
\.


--
-- Data for Name: oauth_access_tokens; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.oauth_access_tokens (token, "clientId", "userId") FROM stdin;
\.


--
-- Data for Name: oauth_authorization_codes; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.oauth_authorization_codes (code, "clientId", "userId", "redirectUri", "codeChallenge", "codeChallengeMethod", "expiresAt", state, used, "createdAt", "updatedAt") FROM stdin;
\.


--
-- Data for Name: oauth_clients; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.oauth_clients (id, name, "redirectUris", "grantTypes", "clientSecret", "clientSecretExpiresAt", "tokenEndpointAuthMethod", "createdAt", "updatedAt") FROM stdin;
\.


--
-- Data for Name: oauth_refresh_tokens; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.oauth_refresh_tokens (token, "clientId", "userId", "expiresAt", "createdAt", "updatedAt") FROM stdin;
\.


--
-- Data for Name: oauth_user_consents; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.oauth_user_consents (id, "userId", "clientId", "grantedAt") FROM stdin;
\.


--
-- Data for Name: processed_data; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.processed_data ("workflowId", context, "createdAt", "updatedAt", value) FROM stdin;
\.


--
-- Data for Name: project; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.project (id, name, type, "createdAt", "updatedAt", icon, description) FROM stdin;
vMTnhKlkE0V1r3hl	Fatih Berkay Baheci <hello@pera.works>	personal	2025-12-09 18:40:04.385+00	2025-12-09 18:41:38.817+00	\N	\N
\.


--
-- Data for Name: project_relation; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.project_relation ("projectId", "userId", role, "createdAt", "updatedAt") FROM stdin;
vMTnhKlkE0V1r3hl	ebc04a1a-5b80-4de2-8b65-382c0cd9393c	project:personalOwner	2025-12-09 18:40:04.385+00	2025-12-09 18:40:04.385+00
\.


--
-- Data for Name: role; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.role (slug, "displayName", description, "roleType", "systemRole", "createdAt", "updatedAt") FROM stdin;
global:owner	Owner	Owner	global	t	2025-12-09 18:40:06.456+00	2025-12-09 18:40:07.288+00
global:admin	Admin	Admin	global	t	2025-12-09 18:40:06.456+00	2025-12-09 18:40:07.288+00
global:member	Member	Member	global	t	2025-12-09 18:40:06.456+00	2025-12-09 18:40:07.288+00
project:admin	Project Admin	Full control of settings, members, workflows, credentials and executions	project	t	2025-12-09 18:40:06.456+00	2025-12-09 18:40:07.317+00
project:personalOwner	Project Owner	Project Owner	project	t	2025-12-09 18:40:06.456+00	2025-12-09 18:40:07.317+00
project:editor	Project Editor	Create, edit, and delete workflows, credentials, and executions	project	t	2025-12-09 18:40:06.456+00	2025-12-09 18:40:07.317+00
project:viewer	Project Viewer	Read-only access to workflows, credentials, and executions	project	t	2025-12-09 18:40:06.456+00	2025-12-09 18:40:07.317+00
credential:owner	Credential Owner	Credential Owner	credential	t	2025-12-09 18:40:07.337+00	2025-12-09 18:40:07.337+00
credential:user	Credential User	Credential User	credential	t	2025-12-09 18:40:07.337+00	2025-12-09 18:40:07.337+00
workflow:owner	Workflow Owner	Workflow Owner	workflow	t	2025-12-09 18:40:07.344+00	2025-12-09 18:40:07.344+00
workflow:editor	Workflow Editor	Workflow Editor	workflow	t	2025-12-09 18:40:07.344+00	2025-12-09 18:40:07.344+00
\.


--
-- Data for Name: role_scope; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.role_scope ("roleSlug", "scopeSlug") FROM stdin;
global:owner	annotationTag:create
global:owner	annotationTag:read
global:owner	annotationTag:update
global:owner	annotationTag:delete
global:owner	annotationTag:list
global:owner	auditLogs:manage
global:owner	banner:dismiss
global:owner	community:register
global:owner	communityPackage:install
global:owner	communityPackage:uninstall
global:owner	communityPackage:update
global:owner	communityPackage:list
global:owner	credential:share
global:owner	credential:shareGlobally
global:owner	credential:move
global:owner	credential:create
global:owner	credential:read
global:owner	credential:update
global:owner	credential:delete
global:owner	credential:list
global:owner	externalSecretsProvider:sync
global:owner	externalSecretsProvider:create
global:owner	externalSecretsProvider:read
global:owner	externalSecretsProvider:update
global:owner	externalSecretsProvider:delete
global:owner	externalSecretsProvider:list
global:owner	externalSecret:list
global:owner	externalSecret:use
global:owner	eventBusDestination:test
global:owner	eventBusDestination:create
global:owner	eventBusDestination:read
global:owner	eventBusDestination:update
global:owner	eventBusDestination:delete
global:owner	eventBusDestination:list
global:owner	ldap:sync
global:owner	ldap:manage
global:owner	license:manage
global:owner	logStreaming:manage
global:owner	orchestration:read
global:owner	project:create
global:owner	project:read
global:owner	project:update
global:owner	project:delete
global:owner	project:list
global:owner	saml:manage
global:owner	securityAudit:generate
global:owner	sourceControl:pull
global:owner	sourceControl:push
global:owner	sourceControl:manage
global:owner	tag:create
global:owner	tag:read
global:owner	tag:update
global:owner	tag:delete
global:owner	tag:list
global:owner	user:resetPassword
global:owner	user:changeRole
global:owner	user:enforceMfa
global:owner	user:create
global:owner	user:read
global:owner	user:update
global:owner	user:delete
global:owner	user:list
global:owner	variable:create
global:owner	variable:read
global:owner	variable:update
global:owner	variable:delete
global:owner	variable:list
global:owner	projectVariable:create
global:owner	projectVariable:read
global:owner	projectVariable:update
global:owner	projectVariable:delete
global:owner	projectVariable:list
global:owner	workersView:manage
global:owner	workflow:share
global:owner	workflow:execute
global:owner	workflow:move
global:owner	workflow:create
global:owner	workflow:read
global:owner	workflow:update
global:owner	workflow:delete
global:owner	workflow:list
global:owner	folder:create
global:owner	folder:read
global:owner	folder:update
global:owner	folder:delete
global:owner	folder:list
global:owner	folder:move
global:owner	insights:list
global:owner	oidc:manage
global:owner	provisioning:manage
global:owner	dataTable:create
global:owner	dataTable:read
global:owner	dataTable:update
global:owner	dataTable:delete
global:owner	dataTable:list
global:owner	dataTable:readRow
global:owner	dataTable:writeRow
global:owner	dataTable:listProject
global:owner	role:manage
global:owner	mcp:manage
global:owner	mcp:oauth
global:owner	mcpApiKey:create
global:owner	mcpApiKey:rotate
global:owner	chatHub:manage
global:owner	chatHub:message
global:owner	chatHubAgent:create
global:owner	chatHubAgent:read
global:owner	chatHubAgent:update
global:owner	chatHubAgent:delete
global:owner	chatHubAgent:list
global:owner	breakingChanges:list
global:admin	annotationTag:create
global:admin	annotationTag:read
global:admin	annotationTag:update
global:admin	annotationTag:delete
global:admin	annotationTag:list
global:admin	auditLogs:manage
global:admin	banner:dismiss
global:admin	community:register
global:admin	communityPackage:install
global:admin	communityPackage:uninstall
global:admin	communityPackage:update
global:admin	communityPackage:list
global:admin	credential:share
global:admin	credential:shareGlobally
global:admin	credential:move
global:admin	credential:create
global:admin	credential:read
global:admin	credential:update
global:admin	credential:delete
global:admin	credential:list
global:admin	externalSecretsProvider:sync
global:admin	externalSecretsProvider:create
global:admin	externalSecretsProvider:read
global:admin	externalSecretsProvider:update
global:admin	externalSecretsProvider:delete
global:admin	externalSecretsProvider:list
global:admin	externalSecret:list
global:admin	externalSecret:use
global:admin	eventBusDestination:test
global:admin	eventBusDestination:create
global:admin	eventBusDestination:read
global:admin	eventBusDestination:update
global:admin	eventBusDestination:delete
global:admin	eventBusDestination:list
global:admin	ldap:sync
global:admin	ldap:manage
global:admin	license:manage
global:admin	logStreaming:manage
global:admin	orchestration:read
global:admin	project:create
global:admin	project:read
global:admin	project:update
global:admin	project:delete
global:admin	project:list
global:admin	saml:manage
global:admin	securityAudit:generate
global:admin	sourceControl:pull
global:admin	sourceControl:push
global:admin	sourceControl:manage
global:admin	tag:create
global:admin	tag:read
global:admin	tag:update
global:admin	tag:delete
global:admin	tag:list
global:admin	user:resetPassword
global:admin	user:changeRole
global:admin	user:enforceMfa
global:admin	user:create
global:admin	user:read
global:admin	user:update
global:admin	user:delete
global:admin	user:list
global:admin	variable:create
global:admin	variable:read
global:admin	variable:update
global:admin	variable:delete
global:admin	variable:list
global:admin	projectVariable:create
global:admin	projectVariable:read
global:admin	projectVariable:update
global:admin	projectVariable:delete
global:admin	projectVariable:list
global:admin	workersView:manage
global:admin	workflow:share
global:admin	workflow:execute
global:admin	workflow:move
global:admin	workflow:create
global:admin	workflow:read
global:admin	workflow:update
global:admin	workflow:delete
global:admin	workflow:list
global:admin	folder:create
global:admin	folder:read
global:admin	folder:update
global:admin	folder:delete
global:admin	folder:list
global:admin	folder:move
global:admin	insights:list
global:admin	oidc:manage
global:admin	provisioning:manage
global:admin	dataTable:create
global:admin	dataTable:read
global:admin	dataTable:update
global:admin	dataTable:delete
global:admin	dataTable:list
global:admin	dataTable:readRow
global:admin	dataTable:writeRow
global:admin	dataTable:listProject
global:admin	role:manage
global:admin	mcp:manage
global:admin	mcp:oauth
global:admin	mcpApiKey:create
global:admin	mcpApiKey:rotate
global:admin	chatHub:manage
global:admin	chatHub:message
global:admin	chatHubAgent:create
global:admin	chatHubAgent:read
global:admin	chatHubAgent:update
global:admin	chatHubAgent:delete
global:admin	chatHubAgent:list
global:admin	breakingChanges:list
global:member	annotationTag:create
global:member	annotationTag:read
global:member	annotationTag:update
global:member	annotationTag:delete
global:member	annotationTag:list
global:member	eventBusDestination:test
global:member	eventBusDestination:list
global:member	tag:create
global:member	tag:read
global:member	tag:update
global:member	tag:list
global:member	user:list
global:member	variable:read
global:member	variable:list
global:member	dataTable:list
global:member	mcp:oauth
global:member	mcpApiKey:create
global:member	mcpApiKey:rotate
global:member	chatHub:message
global:member	chatHubAgent:create
global:member	chatHubAgent:read
global:member	chatHubAgent:update
global:member	chatHubAgent:delete
global:member	chatHubAgent:list
project:admin	credential:share
project:admin	credential:move
project:admin	credential:create
project:admin	credential:read
project:admin	credential:update
project:admin	credential:delete
project:admin	credential:list
project:admin	project:read
project:admin	project:update
project:admin	project:delete
project:admin	project:list
project:admin	sourceControl:push
project:admin	projectVariable:create
project:admin	projectVariable:read
project:admin	projectVariable:update
project:admin	projectVariable:delete
project:admin	projectVariable:list
project:admin	workflow:execute
project:admin	workflow:move
project:admin	workflow:create
project:admin	workflow:read
project:admin	workflow:update
project:admin	workflow:delete
project:admin	workflow:list
project:admin	folder:create
project:admin	folder:read
project:admin	folder:update
project:admin	folder:delete
project:admin	folder:list
project:admin	folder:move
project:admin	dataTable:create
project:admin	dataTable:read
project:admin	dataTable:update
project:admin	dataTable:delete
project:admin	dataTable:readRow
project:admin	dataTable:writeRow
project:admin	dataTable:listProject
project:personalOwner	credential:share
project:personalOwner	credential:move
project:personalOwner	credential:create
project:personalOwner	credential:read
project:personalOwner	credential:update
project:personalOwner	credential:delete
project:personalOwner	credential:list
project:personalOwner	project:read
project:personalOwner	project:list
project:personalOwner	workflow:share
project:personalOwner	workflow:execute
project:personalOwner	workflow:move
project:personalOwner	workflow:create
project:personalOwner	workflow:read
project:personalOwner	workflow:update
project:personalOwner	workflow:delete
project:personalOwner	workflow:list
project:personalOwner	folder:create
project:personalOwner	folder:read
project:personalOwner	folder:update
project:personalOwner	folder:delete
project:personalOwner	folder:list
project:personalOwner	folder:move
project:personalOwner	dataTable:create
project:personalOwner	dataTable:read
project:personalOwner	dataTable:update
project:personalOwner	dataTable:delete
project:personalOwner	dataTable:readRow
project:personalOwner	dataTable:writeRow
project:personalOwner	dataTable:listProject
project:editor	credential:create
project:editor	credential:read
project:editor	credential:update
project:editor	credential:delete
project:editor	credential:list
project:editor	project:read
project:editor	project:list
project:editor	projectVariable:create
project:editor	projectVariable:read
project:editor	projectVariable:update
project:editor	projectVariable:delete
project:editor	projectVariable:list
project:editor	workflow:execute
project:editor	workflow:create
project:editor	workflow:read
project:editor	workflow:update
project:editor	workflow:delete
project:editor	workflow:list
project:editor	folder:create
project:editor	folder:read
project:editor	folder:update
project:editor	folder:delete
project:editor	folder:list
project:editor	dataTable:create
project:editor	dataTable:read
project:editor	dataTable:update
project:editor	dataTable:delete
project:editor	dataTable:readRow
project:editor	dataTable:writeRow
project:editor	dataTable:listProject
project:viewer	credential:read
project:viewer	credential:list
project:viewer	project:read
project:viewer	project:list
project:viewer	projectVariable:read
project:viewer	projectVariable:list
project:viewer	workflow:read
project:viewer	workflow:list
project:viewer	folder:read
project:viewer	folder:list
project:viewer	dataTable:read
project:viewer	dataTable:readRow
project:viewer	dataTable:listProject
credential:owner	credential:share
credential:owner	credential:move
credential:owner	credential:read
credential:owner	credential:update
credential:owner	credential:delete
credential:user	credential:read
workflow:owner	workflow:share
workflow:owner	workflow:execute
workflow:owner	workflow:move
workflow:owner	workflow:read
workflow:owner	workflow:update
workflow:owner	workflow:delete
workflow:editor	workflow:execute
workflow:editor	workflow:read
workflow:editor	workflow:update
\.


--
-- Data for Name: scope; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.scope (slug, "displayName", description) FROM stdin;
annotationTag:create	Create Annotation Tag	Allows creating new annotation tags.
annotationTag:read	annotationTag:read	\N
annotationTag:update	annotationTag:update	\N
annotationTag:delete	annotationTag:delete	\N
annotationTag:list	annotationTag:list	\N
annotationTag:*	annotationTag:*	\N
auditLogs:manage	auditLogs:manage	\N
auditLogs:*	auditLogs:*	\N
banner:dismiss	banner:dismiss	\N
banner:*	banner:*	\N
community:register	community:register	\N
community:*	community:*	\N
communityPackage:install	communityPackage:install	\N
communityPackage:uninstall	communityPackage:uninstall	\N
communityPackage:update	communityPackage:update	\N
communityPackage:list	communityPackage:list	\N
communityPackage:manage	communityPackage:manage	\N
communityPackage:*	communityPackage:*	\N
credential:share	credential:share	\N
credential:shareGlobally	credential:shareGlobally	\N
credential:move	credential:move	\N
credential:create	credential:create	\N
credential:read	credential:read	\N
credential:update	credential:update	\N
credential:delete	credential:delete	\N
credential:list	credential:list	\N
credential:*	credential:*	\N
externalSecretsProvider:sync	externalSecretsProvider:sync	\N
externalSecretsProvider:create	externalSecretsProvider:create	\N
externalSecretsProvider:read	externalSecretsProvider:read	\N
externalSecretsProvider:update	externalSecretsProvider:update	\N
externalSecretsProvider:delete	externalSecretsProvider:delete	\N
externalSecretsProvider:list	externalSecretsProvider:list	\N
externalSecretsProvider:*	externalSecretsProvider:*	\N
externalSecret:list	externalSecret:list	\N
externalSecret:use	externalSecret:use	\N
externalSecret:*	externalSecret:*	\N
eventBusDestination:test	eventBusDestination:test	\N
eventBusDestination:create	eventBusDestination:create	\N
eventBusDestination:read	eventBusDestination:read	\N
eventBusDestination:update	eventBusDestination:update	\N
eventBusDestination:delete	eventBusDestination:delete	\N
eventBusDestination:list	eventBusDestination:list	\N
eventBusDestination:*	eventBusDestination:*	\N
ldap:sync	ldap:sync	\N
ldap:manage	ldap:manage	\N
ldap:*	ldap:*	\N
license:manage	license:manage	\N
license:*	license:*	\N
logStreaming:manage	logStreaming:manage	\N
logStreaming:*	logStreaming:*	\N
orchestration:read	orchestration:read	\N
orchestration:list	orchestration:list	\N
orchestration:*	orchestration:*	\N
project:create	project:create	\N
project:read	project:read	\N
project:update	project:update	\N
project:delete	project:delete	\N
project:list	project:list	\N
project:*	project:*	\N
saml:manage	saml:manage	\N
saml:*	saml:*	\N
securityAudit:generate	securityAudit:generate	\N
securityAudit:*	securityAudit:*	\N
sourceControl:pull	sourceControl:pull	\N
sourceControl:push	sourceControl:push	\N
sourceControl:manage	sourceControl:manage	\N
sourceControl:*	sourceControl:*	\N
tag:create	tag:create	\N
tag:read	tag:read	\N
tag:update	tag:update	\N
tag:delete	tag:delete	\N
tag:list	tag:list	\N
tag:*	tag:*	\N
user:resetPassword	user:resetPassword	\N
user:changeRole	user:changeRole	\N
user:enforceMfa	user:enforceMfa	\N
user:create	user:create	\N
user:read	user:read	\N
user:update	user:update	\N
user:delete	user:delete	\N
user:list	user:list	\N
user:*	user:*	\N
variable:create	variable:create	\N
variable:read	variable:read	\N
variable:update	variable:update	\N
variable:delete	variable:delete	\N
variable:list	variable:list	\N
variable:*	variable:*	\N
projectVariable:create	projectVariable:create	\N
projectVariable:read	projectVariable:read	\N
projectVariable:update	projectVariable:update	\N
projectVariable:delete	projectVariable:delete	\N
projectVariable:list	projectVariable:list	\N
projectVariable:*	projectVariable:*	\N
workersView:manage	workersView:manage	\N
workersView:*	workersView:*	\N
workflow:share	workflow:share	\N
workflow:execute	workflow:execute	\N
workflow:move	workflow:move	\N
workflow:activate	workflow:activate	\N
workflow:deactivate	workflow:deactivate	\N
workflow:create	workflow:create	\N
workflow:read	workflow:read	\N
workflow:update	workflow:update	\N
workflow:delete	workflow:delete	\N
workflow:list	workflow:list	\N
workflow:*	workflow:*	\N
folder:create	folder:create	\N
folder:read	folder:read	\N
folder:update	folder:update	\N
folder:delete	folder:delete	\N
folder:list	folder:list	\N
folder:move	folder:move	\N
folder:*	folder:*	\N
insights:list	insights:list	\N
insights:*	insights:*	\N
oidc:manage	oidc:manage	\N
oidc:*	oidc:*	\N
provisioning:manage	provisioning:manage	\N
provisioning:*	provisioning:*	\N
dataTable:create	dataTable:create	\N
dataTable:read	dataTable:read	\N
dataTable:update	dataTable:update	\N
dataTable:delete	dataTable:delete	\N
dataTable:list	dataTable:list	\N
dataTable:readRow	dataTable:readRow	\N
dataTable:writeRow	dataTable:writeRow	\N
dataTable:listProject	dataTable:listProject	\N
dataTable:*	dataTable:*	\N
execution:delete	execution:delete	\N
execution:read	execution:read	\N
execution:retry	execution:retry	\N
execution:list	execution:list	\N
execution:get	execution:get	\N
execution:*	execution:*	\N
workflowTags:update	workflowTags:update	\N
workflowTags:list	workflowTags:list	\N
workflowTags:*	workflowTags:*	\N
role:manage	role:manage	\N
role:*	role:*	\N
mcp:manage	mcp:manage	\N
mcp:oauth	mcp:oauth	\N
mcp:*	mcp:*	\N
mcpApiKey:create	mcpApiKey:create	\N
mcpApiKey:rotate	mcpApiKey:rotate	\N
mcpApiKey:*	mcpApiKey:*	\N
chatHub:manage	chatHub:manage	\N
chatHub:message	chatHub:message	\N
chatHub:*	chatHub:*	\N
chatHubAgent:create	chatHubAgent:create	\N
chatHubAgent:read	chatHubAgent:read	\N
chatHubAgent:update	chatHubAgent:update	\N
chatHubAgent:delete	chatHubAgent:delete	\N
chatHubAgent:list	chatHubAgent:list	\N
chatHubAgent:*	chatHubAgent:*	\N
breakingChanges:list	breakingChanges:list	\N
breakingChanges:*	breakingChanges:*	\N
*	*	\N
\.


--
-- Data for Name: settings; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.settings (key, value, "loadOnStartup") FROM stdin;
ui.banners.dismissed	["V1"]	t
features.ldap	{"loginEnabled":false,"loginLabel":"","connectionUrl":"","allowUnauthorizedCerts":false,"connectionSecurity":"none","connectionPort":389,"baseDn":"","bindingAdminDn":"","bindingAdminPassword":"","firstNameAttribute":"","lastNameAttribute":"","emailAttribute":"","loginIdAttribute":"","ldapIdAttribute":"","userFilter":"","synchronizationEnabled":false,"synchronizationInterval":60,"searchPageSize":0,"searchTimeout":60,"enforceEmailUniqueness":true}	t
userManagement.authenticationMethod	email	t
features.sourceControl.sshKeys	{"encryptedPrivateKey":"U2FsdGVkX19tnpVIeHDMh/jNEdckpePyTQuSRP5r44IIJRg6/4D/sAHWCY3KmHWH9+721Ds5pVW20GHuC0jROII6yTMchHEMNRBHHp1k5zojDsAG1qZ8DPODsuYk8UY4C4DJPDbtNRFgkxuGYyGrogYZ76EUVCuK2XHX+RWBVIva4HJrhaxKHHJr+zPEW6VhSMgqHYQsoU27Oid/Gy5wBCCveDDQp1NQtr5JmbsdMV4dW48557gNo0mu3zVzcAr+sgweA5cyrE47ZyjmyCU2JhcXsjbzio8GgRpGFv3mjij8rsqkOykPQGtu748WG083noqLw3Df+RfmQmbStQ+76x8CDh57RqoAmgvB6BH9yRAHHtVe25fEyhWG/Xqf90L/sqrtVx3XWW09ah+0p/b0ixstOPZwv1qtAyx4W30mGoFDqeqGUncEt6FVeQn7ZNkdAxAVak0x8Vbn9ON8mTgNvRpvfqimObaBklm8x6Cmb78WxpoHpzFJ9/qJP0RN4Yts04LOFvsnd+n9dsL9tlulzyV/ZeVHgZh5jHFpLW+6l9ySl4ueWZcfI94VjpSK9njK","publicKey":"ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAICUJw6cr7xY42AS49+IMHbRyr4cYjHo8ouytN4MMEQUe n8n deploy key"}	t
features.sourceControl	{"branchName":"main","connectionType":"ssh","keyGeneratorType":"ed25519"}	t
userManagement.isInstanceOwnerSetUp	true	t
license.cert	eyJsaWNlbnNlS2V5IjoiLS0tLS1CRUdJTiBMSUNFTlNFIEtFWS0tLS0tXG5CeUN2aGd3bkFNcVJIQXdpeTRFd1RCRTUxNmhWaHlTSXJEcy9MS0ZmbFI1bit4aWIvRTc1SFNPREVvdEs2MEd3XG5raXV1MS8yNEdCUkovRHBMeWFRb250M1llSlFpQ2k5bFh3cXFyTEdJZ3FnbUpUM1BJbmd0SmhyYTBtakJlWDlWXG5lTHg1eVhIK1V5ZVdxYnVTSlpIRG0vNXpiQ1hCcSt0OXVQNnlvcVEzdzFPZkp3RVN5ZHRRbnVXdnZpd1Z3NkIzXG5hVEc4M1dmTTlmR054a0ZUUi92QXFNeWVxeUFnSmlwdUJwR0hUSTdyTEtFRXFPQmd1ZW53STdxK1hFZnBsR3VHXG5xMWxHaDdqVTFpbW5sMXFZOUlNYVBzaCt1UThibkd4YXdPTUE3MlVYaU1yalhKRnA2YktlQ1Y2UWVXc2RaNUZmXG5WRFhscEVyUUNZSW1lTytoQitqbThRPT18fFUyRnNkR1ZrWDE5aTBBTDZEdVVyRVNGVXlPb2NKN3ExWlhRUXQ2XG41NGxCT2NweDU4NkY1a3Q5S3JLN2NRaDl0QU5qZmJvNFhwLy93NVpQbVRMVkZmcTBRY1ZjQ3JTQVh3UXlvQ0Z1XG5LNkhFOXhNUXpmTUhlaStibWcyZ05Mdi9SR2k2UjFmTGdkakxHeEFsTU56Q1AzZnp3eVhINkxFeG9GM3AyQ0NOXG41U2R4UmIvc2tZQUFTc0xHMHp3cERzRktjQjlDSjBNbEozelZwQjB3TU5uenpvNDFqMjV3TEFvYlNFZTBMNTJrXG5PZnlnK2hla3pyRmViWVUvLzFYcnhSQTRjT1MxOWFqcHlLVExrRW80T2w2dGlQV3h3ZHorNCs4R2NBb2c5MmorXG5vejc2VVZreWdpbzNyVkUxOXgzS2M2enU5K3UzUGtBV2pHWE9hRk9KVWZQRVRxZmdLWkx5dm5kMXJGeFNQQTBjXG5xS21yTGF5TUxjUmJ3d1ZwSXFBbWVWNGNCMkhYOEt1bDRvSlp6cVJJa1pqeHJZczJhVlo4ZjA0WWxEbG5ob3NoXG5jMjFqejVYTlA0WkxwR0ZTejcxZE9ic3I3TG45VUhkKzBSVmpIblo1WVZNcUhjWXQ0NmdFaXhyT0JKNEsyV2VqXG5valFBd1ZETnJ4U21jM0R2YXF0N3A2ZTBwK2xqdW8rcWZKT0ZPMURZazdHbzBaTVlCOVZ2UTROWEN5SnlFa1IyXG5RZHVtZzlRNDY0eW9pcmxnWWN2cmJ1SVVZSG4wV1NPRlBrczJIaGQ3Mm9rVUk2SmZ0S3V5M0FuRWRpNlZ4UFp2XG43MGo1Q0pzcEg3M3dLMzZQVXJibDloYktPdk5iR2NFUXZzajJ5dWUySm96QlpNOTEzOUE1V3hFWHZKRFNXU0pNXG5iOUNTYzZlaGVWNWd6UXMrNk9yc1dRMW42R2IvandiMmtPNWJlTHB6NjdpTko4Tkp0SVVFcG1tVGlPM1JiU2RkXG5IdzJXV3o3ME0vbVptbHFGcVN2UzVRREdCWWdGVHNpcXhVNFVnN25aaEdiS2FYczRIcVdkb0N5M2lTU3VGQnVxXG5seEd5WS8rVHY5OUxJZmhlTGI3Wk5NMnhMK05NdHpqY2c1eU5lWGVBUThPZStlbHkwbVVmekp6UnU5SHFaVWZQXG54d1RWV1NkUHd0RmFLNG5rSG5pQnZwVi9DNGozdU9rS3Npdll0cnZac2U1cnBkcEJlay9xYmpXWG9BZ2cvU0pTXG4wenNTUmo1VWFVMXAyYkN0Q0R2aE1MMEpSOW8vc1lRUUp6elN2ZHVWbE1NbU1CZUh5aTgzOFRNWVpXeW5UVVZ1XG5ya2p1NUw2MTNqQVk0a0dwcS85elcvc215U2hjYlVqSnphT0hxcWFWRzdjOEkxMU5hNmRDUGlqZW9DZmovMjhCXG5SS2ZRMHNqemZoTkVFYkl1NklyWTJiZWN4eHI0TWU2L1hDcmpIemJhcWNiNlhtZENTRWpVSHRHREZWVFNEMGRqXG5hM2gyNUNhUnFjZHNQS29LMFphL2YvSUJkOHJjT05NblBRa3lhNzdEckZiYnBlTUozbFltamxrRmMzRkF1Y3VUXG5nS3hGcjdIL0M4dDdFUE1mSHVkTU5RODQzeTBrN1lhUEg0bGRZSE8xT0ErblZQUCtPbzE4S08rZHoydHJFcWU0XG45dnlvQTlUK1JpS2lNZVRKQWlLNy81a1BLVHI4MloxM1k2Zm12SFZKRFFRZmptV2lialJsTmVpaDg5RlVMVXlLXG54NHFvVHE3RjJlU0tzWDJjSTR3WjdoVDl0ckt1NktQaTQvbDc3amZDSEpiWFM3S0RmdHdwcWNidk4zeG1rek5IXG4zV2crUHg0ak45ZTRQM0Fyb2tyeTNDa3hWbHMyclV5aUpvWUtQaXNLY3lSRlZ4QWpFWi82aUVlcVljM3FRSjJmXG5qMEF1S1hIdExOZHkvc3B5WElUYzdMK0tYM3N5SHRoZGo2NkRtV1YxWUQ0akRzZm5abytIdGJ3SE9NcW1IKytoXG5PKy90a1JkRFRDc0U4MmRpNXlESXNzMm9rcUFXYVBPaSt0SGgxL3UvMWt1R00yV0IrZ1lLTkJqMnJ5aXFtd2luXG5GODBLeUpHWmgvcC84MWhteUFNb1hlSXRQYlF6eDBwZzhic2VoeDB6VlkydFhEb3JVRDJpdk82ZHIxenpTUktpXG41aTRrZHdrcHBrcllzT3cxaGtsaWdxWkdaTUxpVm1VRVpxWVQ1OWJTZ0RvWkpYc1F5K2hqenFpakJ5ZU5VQzdIXG5jaGFPYXF2dmV0ZnhkUGJuYXBOWnM3VnFxYS9xWVhGdlFUT0lYK0c1Z2l3Z0NNZ3hmMVU5SnVEclRDbVlHWk1aXG54N3BBcDE3VjZkc1NpWU9wTVdXR3dTaUxPZGQ0WFVSVXRleU85azNabFFvZy8xNHBtcjU0L1FrcHBxUmVxRWc2XG5KaUROYlEzanJOempucmZNaDdwK3lJUGRwdHdqbzlGMWNEVWEwRzdiZ3B2SHFKc3pvWWdTR3dkaDA5ME82MlNRXG44OGJLeFJaTG5FQmtZREJsOEhKYnljVTBaSyt3eVVTbzNTZGlkcFdCS0FOM2RsaUhPMitaV1kwRDI4NGw3NDBEXG5RdmhqNGI5NHluN1U0WEJmVDBua3RSL01tWVJvdUQvbDRUL0dXNzZtQURFdVpwcU53eW8waThadWRvV05zUEY3XG51Y2t4elpJeWpiVXlFZ1gwUHZra2ZDV0dENzBhZGRwVFhMdDFxbHZ4c2JLQXEzWlFUOUpTWFZrUnlNbVdXeklIXG44UFcvWTJ0eHFTZUk2WUNKd24wY2wycXA3ck8vc2V2Mk1TeHFmcnUrMTF0UE00a0JYelBQSnBtL2p3TlZsbVgrXG51NXF4QlFTYjBhenBXelptY1RrNVFuSmxRMHFTSkpwNm1TQ1luMHNXUGdqUnZzY2ZJMnRhcXZvVEN6VWZxejRLXG5uUXlaYUg5aG43bCtVUm5pcmZYeWJrd3ZCMk5jNUJFQXZrVC8xdVNwN0dhQmhUc091SjlSNElNOTJTTkMyNk43XG5YV1dhcjdzTStDZHFzS3pCTk8xYUUwM1BRZUpVNlN0QWs1U2RVOFlDWWZpU0ZXNHc9PXx8WEIyQ1F1VnpCV01XXG56SGZxc3dHTU5ibFZ4RTR1NjhEL0pnN0Y2Uk9FNXFLL3RNS1FHeUhUd0lXUlByZG9Vb3FOUVVrZXFZdEJ4dFlEXG43aXpvVW1TSHNvREMxb0loUkt6UzVKWFVBUGdMandqV3pKcFNHdW1CV1hTQ2I0T2pWTUdua0dPV0NPRkdOQlNjXG5NWHhEa0hBeng3T0dVY1VxaTgrN3BKMUdFTlVVTXVVRU8wOVJWV2F2Wm5semtoREVxTkxiUFl4dW1vREo5SDQ0XG5iUWVlKzh4bUQrY0lEMFo0dlExaFc1ZEhLdlhIVTV5dXZrYmQ5Y3dyeEllVThQcWNZazF4Z0N4TVpkNVljRmhBXG5LajBjNWtCaE5peDl4Y1F0YUtOYWJ6ZTA5dGNKL3oyNmNNU2lkU1FzRzFZbFhNem5CenVFVmg3Q2lndHNDNVltXG5ER2VUTHY3Z09RPT1cbi0tLS0tRU5EIExJQ0VOU0UgS0VZLS0tLS0iLCJ4NTA5IjoiLS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tXG5NSUlFRERDQ0FmUUNDUUNxZzJvRFQ4MHh3akFOQmdrcWhraUc5dzBCQVFVRkFEQklNUXN3Q1FZRFZRUUdFd0pFXG5SVEVQTUEwR0ExVUVDQXdHUW1WeWJHbHVNUTh3RFFZRFZRUUhEQVpDWlhKc2FXNHhGekFWQmdOVkJBTU1EbXhwXG5ZMlZ1YzJVdWJqaHVMbWx2TUI0WERUSXlNRFl5TkRBME1UQTBNRm9YRFRJek1EWXlOREEwTVRBME1Gb3dTREVMXG5NQWtHQTFVRUJoTUNSRVV4RHpBTkJnTlZCQWdNQmtKbGNteHBiakVQTUEwR0ExVUVCd3dHUW1WeWJHbHVNUmN3XG5GUVlEVlFRRERBNXNhV05sYm5ObExtNDRiaTVwYnpDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDXG5BUW9DZ2dFQkFNQk0wNVhCNDRnNXhmbUNMd2RwVVR3QVQ4K0NCa3lMS0ZzZXprRDVLLzZXaGFYL1hyc2QvUWQwXG4yMEo3d2w1V2RIVTRjVkJtRlJqVndWemtsQ0syeVlKaThtang4c1hzR3E5UTFsYlVlTUtmVjlkc2dmdWhubEFTXG50blFaZ2x1Z09uRjJGZ1JoWGIvakswdHhUb2FvK2JORTZyNGdJRXpwa3RITEJUWXZ2aXVKbXJlZjdXYlBSdDRJXG5uZDlEN2xoeWJlYnloVjdrdXpqUUEvcFBLSFRGczhNVEhaOGhZVXhSeXJwbTMrTVl6UUQrYmpBMlUxRkljdGFVXG53UVhZV2FON3QydVR3Q3Q5ekFLc21ZL1dlT2J2bDNUWk41T05MQXp5V0dDdWxtNWN3S1IzeGJsQlp6WG5CNmdzXG5Pbk4yT0FkU3RjelRWQ3ljbThwY0ZVcnl0S1NLa0dFQ0F3RUFBVEFOQmdrcWhraUc5dzBCQVFVRkFBT0NBZ0VBXG5sSjAxd2NuMXZqWFhDSHVvaTdSMERKMWxseDErZGFmcXlFcVBBMjdKdStMWG1WVkdYUW9yUzFiOHhqVXFVa2NaXG5UQndiV0ZPNXo1ZFptTnZuYnlqYXptKzZvT2cwUE1hWXhoNlRGd3NJMlBPYmM3YkZ2MmVheXdQdC8xQ3BuYzQwXG5xVU1oZnZSeC9HQ1pQQ1d6My8yUlBKV1g5alFEU0hYQ1hxOEJXK0kvM2N1TERaeVkzZkVZQkIwcDNEdlZtYWQ2XG42V0hRYVVyaU4wL0xxeVNPcC9MWmdsbC90MDI5Z1dWdDA1WmliR29LK2NWaFpFY3NMY1VJaHJqMnVGR0ZkM0ltXG5KTGcxSktKN2pLU0JVUU9kSU1EdnNGVUY3WWRNdk11ckNZQTJzT05OOENaK0k1eFFWMUtTOWV2R0hNNWZtd2dTXG5PUEZ2UHp0RENpMC8xdVc5dE9nSHBvcnVvZGFjdCtFWk5rQVRYQ3ZaaXUydy9xdEtSSkY0VTRJVEVtNWFXMGt3XG42enVDOHh5SWt0N3ZoZHM0OFV1UlNHSDlqSnJBZW1sRWl6dEdJTGhHRHF6UUdZYmxoVVFGR01iQmI3amhlTHlDXG5MSjFXT0c2MkYxc3B4Q0tCekVXNXg2cFIxelQxbWhFZ2Q0TWtMYTZ6UFRwYWNyZDk1QWd4YUdLRUxhMVJXU0ZwXG5NdmRoR2s0TnY3aG5iOHIrQnVNUkM2aWVkUE1DelhxL001MGNOOEFnOGJ3K0oxYUZvKzBFSzJoV0phN2tpRStzXG45R3ZGalNkekNGbFVQaEtra1Vaa1NvNWFPdGNRcTdKdTZrV0JoTG9GWUtncHJscDFRVkIwc0daQTZvNkR0cWphXG5HNy9SazZ2YmFZOHdzTllLMnpCWFRUOG5laDVab1JaL1BKTFV0RUV0YzdZPVxuLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLSJ9	f
\.


--
-- Data for Name: shared_credentials; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.shared_credentials ("credentialsId", "projectId", role, "createdAt", "updatedAt") FROM stdin;
1rDLBK64lV00T0am	vMTnhKlkE0V1r3hl	credential:owner	2025-12-17 09:55:39.804+00	2025-12-17 09:55:39.804+00
Hp8gTY1C1efbSfkx	vMTnhKlkE0V1r3hl	credential:owner	2025-12-17 10:22:45.061+00	2025-12-17 10:22:45.061+00
01zZGrP0Fob8kD8r	vMTnhKlkE0V1r3hl	credential:owner	2025-12-17 10:23:41.939+00	2025-12-17 10:23:41.939+00
ThQVVDooMABNmQQm	vMTnhKlkE0V1r3hl	credential:owner	2025-12-17 10:24:32.046+00	2025-12-17 10:24:32.046+00
tdfM9Y0L3V28A5wJ	vMTnhKlkE0V1r3hl	credential:owner	2025-12-17 10:24:41.855+00	2025-12-17 10:24:41.855+00
FRUwxjFQM3dnpWm4	vMTnhKlkE0V1r3hl	credential:owner	2025-12-18 11:58:28.605+00	2025-12-18 11:58:28.605+00
\.


--
-- Data for Name: shared_workflow; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.shared_workflow ("workflowId", "projectId", role, "createdAt", "updatedAt") FROM stdin;
askirexPIC3sUVXx	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-17 10:16:28.7+00	2025-12-17 10:16:28.7+00
nuQVa3YLSJFRC4Ny	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-17 10:25:58.854+00	2025-12-17 10:25:58.854+00
WpQy66Cn5XTG9pFD	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-17 10:26:21.495+00	2025-12-17 10:26:21.495+00
DyGEyObKWBEHrb0B	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-17 10:26:33.459+00	2025-12-17 10:26:33.459+00
yyD1QW0PcJgp3ik2	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-17 10:27:00.358+00	2025-12-17 10:27:00.358+00
6nclsXOjxGhT8qJs	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-17 10:27:22.449+00	2025-12-17 10:27:22.449+00
r8uQ8T48G7SDp9or	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-17 10:27:36.026+00	2025-12-17 10:27:36.026+00
yd6UhBrs7iqGeEg6	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-17 10:27:50.264+00	2025-12-17 10:27:50.264+00
9wxzOy1QgENPVVSD	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-17 10:28:04.071+00	2025-12-17 10:28:04.071+00
UxU00NHUOlNJSpFi	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-17 10:28:20.591+00	2025-12-17 10:28:20.591+00
E29x9qTqO4XIfetR	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-17 10:28:38.266+00	2025-12-17 10:28:38.266+00
oCR2cQcwwClAsT55	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-17 10:28:51.007+00	2025-12-17 10:28:51.007+00
x03Ivd085mWitZQ9	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-17 10:29:03.332+00	2025-12-17 10:29:03.332+00
dKv529VBvG6GzQ7d	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-17 10:29:24.428+00	2025-12-17 10:29:24.428+00
S0zn4vyawwOhLuuO	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-17 10:30:14.926+00	2025-12-17 10:30:14.926+00
s7JHrKu0WDrkbkzw	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-17 10:32:00.99+00	2025-12-17 10:32:00.99+00
xqZA3Veie70f1PZI	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-17 10:32:30.381+00	2025-12-17 10:32:30.381+00
cRzztL0RsykZYA9k	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-18 11:34:23.337+00	2025-12-18 11:34:23.337+00
IGWk6RXq1AHpB4L1	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-18 11:34:23.44+00	2025-12-18 11:34:23.44+00
fkgU1ClgOCaGeuXR	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-18 11:34:23.547+00	2025-12-18 11:34:23.547+00
k21swmfiM5y9Dspc	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-18 11:34:23.86+00	2025-12-18 11:34:23.86+00
886MnxYqCbAQ1Bjz	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-19 09:14:49.15+00	2025-12-19 09:14:49.15+00
j3jZIjdsJSchQqCe	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-19 09:29:42.147+00	2025-12-19 09:29:42.147+00
IoTg8e61J99uOFka	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-19 11:59:31.784+00	2025-12-19 11:59:31.784+00
O9VRT7UV70STh36c	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-19 11:59:40.715+00	2025-12-19 11:59:40.715+00
GcCbIVDLCEBXWH4c	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-19 12:13:34.244+00	2025-12-19 12:13:34.244+00
adol4O3V4iGsGXpf	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-23 08:12:16.817+00	2025-12-23 08:12:16.817+00
MhHeIUZBSMtqRRrR	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-23 19:36:44.405+00	2025-12-23 19:36:44.405+00
sWwmP23m89DQTpVI	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-23 19:37:09.381+00	2025-12-23 19:37:09.381+00
mNQs5AgZjCB0MIZx	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-23 19:55:02.057+00	2025-12-23 19:55:02.057+00
wl9T4eOGoazJkDdv	vMTnhKlkE0V1r3hl	workflow:owner	2025-12-23 19:55:15.963+00	2025-12-23 19:55:15.963+00
\.


--
-- Data for Name: tag_entity; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.tag_entity (name, "createdAt", "updatedAt", id) FROM stdin;
SEO Pipeline	2025-12-09 18:44:57.678+00	2025-12-09 18:44:57.678+00	seo-pipeline
Orchestration	2025-12-09 18:44:57.678+00	2025-12-09 18:44:57.678+00	orchestration
Tool1-KeywordResearch	2025-12-13 11:18:17.285+00	2025-12-13 11:18:17.285+00	1
Shared-Core	2025-12-17 10:05:17.646+00	2025-12-17 10:05:17.646+00	fuSMKRiaWGPmaGru
Shared	2025-12-17 10:31:57.714+00	2025-12-17 10:31:57.714+00	Ezxn5KBS7wZlyQuW
\.


--
-- Data for Name: test_case_execution; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.test_case_execution (id, "testRunId", "executionId", status, "runAt", "completedAt", "errorCode", "errorDetails", metrics, "createdAt", "updatedAt", inputs, outputs) FROM stdin;
\.


--
-- Data for Name: test_run; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.test_run (id, "workflowId", status, "errorCode", "errorDetails", "runAt", "completedAt", metrics, "createdAt", "updatedAt") FROM stdin;
\.


--
-- Data for Name: user; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public."user" (id, email, "firstName", "lastName", password, "personalizationAnswers", "createdAt", "updatedAt", settings, disabled, "mfaEnabled", "mfaSecret", "mfaRecoveryCodes", "lastActiveAt", "roleSlug") FROM stdin;
ebc04a1a-5b80-4de2-8b65-382c0cd9393c	fatihberkaybahceci@icloud.com	Fatih Berkay	Baheci	$2b$12$uO.s3I12U4k/noiTuljxHuuyckc2lYS6arbHn6BUCiUtv/ecWVmMy	{"version":"v4","personalization_survey_submitted_at":"2025-12-09T18:41:45.079Z","personalization_survey_n8n_version":"1.122.5"}	2025-12-09 18:40:01.986+00	2025-12-24 08:19:54.195+00	{"userActivated":true,"firstSuccessfulWorkflowId":"Ocdl2H3iqvuOChgw","userActivatedAt":1765306810023}	f	f	\N	\N	2025-12-23	global:owner
\.


--
-- Data for Name: user_api_keys; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.user_api_keys (id, "userId", label, "apiKey", "createdAt", "updatedAt", scopes, audience) FROM stdin;
CsBFwAGfX5Qlhwpo	ebc04a1a-5b80-4de2-8b65-382c0cd9393c	Pro	eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJlYmMwNGExYS01YjgwLTRkZTItOGI2NS0zODJjMGNkOTM5M2MiLCJpc3MiOiJuOG4iLCJhdWQiOiJwdWJsaWMtYXBpIiwiaWF0IjoxNzY1OTY1MjExfQ.QJ9zNJgrpV4IXImtDMPt00RyMMnFIi9-iHZklmU2vGU	2025-12-17 09:53:31.069+00	2025-12-17 09:53:31.069+00	["credential:move","credential:create","credential:delete","project:create","project:update","project:delete","project:list","securityAudit:generate","sourceControl:pull","tag:create","tag:read","tag:update","tag:delete","tag:list","user:changeRole","user:enforceMfa","user:create","user:read","user:delete","user:list","variable:create","variable:update","variable:delete","variable:list","workflow:move","workflow:create","workflow:read","workflow:update","workflow:delete","workflow:list","workflowTags:update","workflowTags:list","workflow:activate","workflow:deactivate","execution:delete","execution:read","execution:retry","execution:list"]	public-api
\.


--
-- Data for Name: variables; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.variables (key, type, value, id, "projectId") FROM stdin;
\.


--
-- Data for Name: webhook_entity; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.webhook_entity ("webhookPath", method, node, "webhookId", "pathLength", "workflowId") FROM stdin;
tool1/projects	GET	Webhook	\N	\N	9wxzOy1QgENPVVSD
:projectId/analyze-competitors	POST	Webhook	tool1-competitor-analyze	2	UxU00NHUOlNJSpFi
tool1-serp-features/:projectId/detect	POST	Webhook	tool1-serp-features	3	E29x9qTqO4XIfetR
:projectId/analyze	POST	Webhook	tool1-content-gap	2	oCR2cQcwwClAsT55
:projectId/calculate	POST	Webhook	tool1-opportunity-scorer	2	x03Ivd085mWitZQ9
:projectId/generate	POST	Webhook	tool1-strategy-generator	2	dKv529VBvG6GzQ7d
:projectId/export	GET	Webhook	tool1-report-exporter	2	S0zn4vyawwOhLuuO
clients/list	GET	Webhook - List Clients	\N	\N	nuQVa3YLSJFRC4Ny
clients/create	POST	Webhook - Create Client	\N	\N	nuQVa3YLSJFRC4Ny
log-tokens	POST	Webhook	\N	\N	s7JHrKu0WDrkbkzw
sheets-get-columns	POST	Webhook	\N	\N	IGWk6RXq1AHpB4L1
sheets-check	POST	Webhook	\N	\N	fkgU1ClgOCaGeuXR
sheets-write	POST	Webhook	\N	\N	k21swmfiM5y9Dspc
sheets-test	POST	Webhook	\N	\N	GcCbIVDLCEBXWH4c
clients-get/clients/:id	GET	Webhook - Get Client	clients-get	3	nuQVa3YLSJFRC4Ny
clients-update/clients/:id/update	PUT	Webhook - Update Client	clients-update	4	nuQVa3YLSJFRC4Ny
clients-delete/clients/:id	DELETE	Webhook - Delete Client	clients-delete	3	nuQVa3YLSJFRC4Ny
client-prompts/list/:clientId	GET	Webhook - List Prompts	client-prompts-list	3	WpQy66Cn5XTG9pFD
client-prompts/create	POST	Webhook - Create Prompt	\N	\N	WpQy66Cn5XTG9pFD
client-prompts/update/:id	PUT	Webhook - Update Prompt	client-prompts-update	3	WpQy66Cn5XTG9pFD
client-prompts/delete/:id	DELETE	Webhook - Delete Prompt	client-prompts-delete	3	WpQy66Cn5XTG9pFD
client-prompts/set-active/:id	PUT	Webhook - Set Active	client-prompts-set-active	3	WpQy66Cn5XTG9pFD
client-prompts/active/:clientId	GET	Webhook - Get Active Prompt	client-prompts-get-active	3	WpQy66Cn5XTG9pFD
tool1/project/create	POST	Webhook - Create Project	\N	\N	DyGEyObKWBEHrb0B
keyword-discovery	POST	Webhook	\N	\N	yyD1QW0PcJgp3ik2
:projectId/filter-keywords	POST	Webhook	tool1-keyword-filter	2	6nclsXOjxGhT8qJs
:projectId/keywords	GET	Webhook	tool1-get-keywords	2	r8uQ8T48G7SDp9or
tool1/project/:id	GET	Webhook	tool1-project-get	3	yd6UhBrs7iqGeEg6
sheets-connect	POST	Webhook	\N	\N	cRzztL0RsykZYA9k
keyword-research	POST	Webhook	\N	\N	j3jZIjdsJSchQqCe
sheets-get-cell	POST	Webhook	\N	\N	IoTg8e61J99uOFka
sheets-get-row	POST	Webhook	\N	\N	O9VRT7UV70STh36c
bulk-keyword-research	POST	Webhook	\N	\N	wl9T4eOGoazJkDdv
process-single-seed	POST	Webhook	\N	\N	mNQs5AgZjCB0MIZx
\.


--
-- Data for Name: workflow_dependency; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.workflow_dependency (id, "workflowId", "workflowVersionId", "dependencyType", "dependencyKey", "dependencyInfo", "indexVersionId", "createdAt") FROM stdin;
241	j3jZIjdsJSchQqCe	1	nodeType	n8n-nodes-base.webhook	{"nodeId":"9902bbac-8a79-4dee-bb77-cf11c3ed3eb4","nodeVersion":2}	1	2025-12-19 09:29:42.167+00
242	j3jZIjdsJSchQqCe	1	webhookPath	keyword-research	{"nodeId":"9902bbac-8a79-4dee-bb77-cf11c3ed3eb4","nodeVersion":2}	1	2025-12-19 09:29:42.167+00
243	j3jZIjdsJSchQqCe	1	nodeType	n8n-nodes-base.code	{"nodeId":"aa92142f-6a42-43f8-90d6-42f7732c52ca","nodeVersion":2}	1	2025-12-19 09:29:42.167+00
244	j3jZIjdsJSchQqCe	1	nodeType	n8n-nodes-base.if	{"nodeId":"318aa55f-b2b4-4f1e-a39b-506db0ef4b22","nodeVersion":2}	1	2025-12-19 09:29:42.167+00
245	j3jZIjdsJSchQqCe	1	nodeType	n8n-nodes-base.respondToWebhook	{"nodeId":"d11d1df2-d9f5-466c-ba34-3bae3d776943","nodeVersion":1.1}	1	2025-12-19 09:29:42.167+00
246	j3jZIjdsJSchQqCe	1	nodeType	n8n-nodes-base.mySql	{"nodeId":"95dbeb6c-1aa6-4bb7-95bb-e390149cea53","nodeVersion":2.4}	1	2025-12-19 09:29:42.167+00
247	j3jZIjdsJSchQqCe	1	credentialId	1rDLBK64lV00T0am	{"nodeId":"95dbeb6c-1aa6-4bb7-95bb-e390149cea53","nodeVersion":2.4}	1	2025-12-19 09:29:42.167+00
248	j3jZIjdsJSchQqCe	1	nodeType	n8n-nodes-base.code	{"nodeId":"716b9b67-15b7-4d99-b48c-5f845aa91a8a","nodeVersion":2}	1	2025-12-19 09:29:42.167+00
249	j3jZIjdsJSchQqCe	1	nodeType	n8n-nodes-base.httpRequest	{"nodeId":"28b889d0-a61d-4492-a801-1915a8d2af95","nodeVersion":4.2}	1	2025-12-19 09:29:42.167+00
250	j3jZIjdsJSchQqCe	1	nodeType	n8n-nodes-base.httpRequest	{"nodeId":"fcd6a5cb-6fc1-4ede-bc8f-1f5024c39ee3","nodeVersion":4.2}	1	2025-12-19 09:29:42.167+00
251	j3jZIjdsJSchQqCe	1	nodeType	n8n-nodes-base.code	{"nodeId":"fe663b95-d188-4b4d-8abf-3b63087067b6","nodeVersion":2}	1	2025-12-19 09:29:42.167+00
252	j3jZIjdsJSchQqCe	1	nodeType	n8n-nodes-base.code	{"nodeId":"55b4947a-ab6c-4cdb-b89d-62ac04a7a87c","nodeVersion":2}	1	2025-12-19 09:29:42.167+00
253	j3jZIjdsJSchQqCe	1	nodeType	n8n-nodes-base.if	{"nodeId":"3d6dd4f8-05d7-4c1d-904d-9e596616e2c2","nodeVersion":2}	1	2025-12-19 09:29:42.167+00
254	j3jZIjdsJSchQqCe	1	nodeType	n8n-nodes-base.httpRequest	{"nodeId":"ab251c8f-e17a-4fac-a6c8-cb0eebe77469","nodeVersion":4.2}	1	2025-12-19 09:29:42.167+00
255	j3jZIjdsJSchQqCe	1	credentialId	Hp8gTY1C1efbSfkx	{"nodeId":"ab251c8f-e17a-4fac-a6c8-cb0eebe77469","nodeVersion":4.2}	1	2025-12-19 09:29:42.167+00
256	j3jZIjdsJSchQqCe	1	nodeType	n8n-nodes-base.code	{"nodeId":"c12570a1-9082-40e2-851e-5fa442731ee5","nodeVersion":2}	1	2025-12-19 09:29:42.167+00
257	j3jZIjdsJSchQqCe	1	nodeType	n8n-nodes-base.code	{"nodeId":"4e09e311-9491-44f1-be02-fcbed1df844f","nodeVersion":2}	1	2025-12-19 09:29:42.167+00
258	j3jZIjdsJSchQqCe	1	nodeType	n8n-nodes-base.if	{"nodeId":"7e9b7e8f-d76b-4ed5-b4a0-74ef365c4c73","nodeVersion":2}	1	2025-12-19 09:29:42.167+00
259	j3jZIjdsJSchQqCe	1	nodeType	n8n-nodes-base.code	{"nodeId":"47235346-5e12-4b44-83b6-12eeeb60d03f","nodeVersion":2}	1	2025-12-19 09:29:42.167+00
260	j3jZIjdsJSchQqCe	1	nodeType	n8n-nodes-base.mySql	{"nodeId":"e7fb17bc-8bcf-444e-904b-951979d35708","nodeVersion":2.4}	1	2025-12-19 09:29:42.167+00
261	j3jZIjdsJSchQqCe	1	credentialId	1rDLBK64lV00T0am	{"nodeId":"e7fb17bc-8bcf-444e-904b-951979d35708","nodeVersion":2.4}	1	2025-12-19 09:29:42.167+00
262	j3jZIjdsJSchQqCe	1	nodeType	n8n-nodes-base.code	{"nodeId":"c9a4c00f-9934-4b47-af6f-5f83b8b27ce5","nodeVersion":2}	1	2025-12-19 09:29:42.167+00
263	j3jZIjdsJSchQqCe	1	nodeType	n8n-nodes-base.code	{"nodeId":"d94e8ee4-4657-4f03-9f84-6c46abb29598","nodeVersion":2}	1	2025-12-19 09:29:42.167+00
264	j3jZIjdsJSchQqCe	1	nodeType	n8n-nodes-base.respondToWebhook	{"nodeId":"8c3e3bcd-7259-4254-ab37-cfe54f57c19d","nodeVersion":1.1}	1	2025-12-19 09:29:42.167+00
265	j3jZIjdsJSchQqCe	1	nodeType	n8n-nodes-base.respondToWebhook	{"nodeId":"f2a7e84a-4acc-46e1-b29e-fab7355ac891","nodeVersion":1.1}	1	2025-12-19 09:29:42.167+00
\.


--
-- Data for Name: workflow_entity; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.workflow_entity (name, active, nodes, connections, "createdAt", "updatedAt", settings, "staticData", "pinData", "versionId", "triggerCount", id, meta, "parentFolderId", "isArchived", "versionCounter", description, "activeVersionId") FROM stdin;
WF-101b: AI Keyword Filter	t	[{"parameters":{"httpMethod":"POST","path":":projectId/filter-keywords","responseMode":"responseNode","options":{}},"id":"086a5924-9929-4d72-865a-49babb42c0e1","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-2640,112],"webhookId":"tool1-keyword-filter"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Input validation\\nconst projectId = $json.params?.projectId;\\n\\n// Validate projectId\\nif (!projectId) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'project_id parametresi zorunludur',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nconst parsedId = parseInt(projectId);\\nif (isNaN(parsedId) || parsedId <= 0) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'project_id gecerli bir pozitif sayi olmalidir',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nreturn {\\n  json: {\\n    isValid: true,\\n    projectId: parsedId\\n  }\\n};"},"id":"3f00def3-9491-4873-a8f2-9c9f23675970","name":"Code - Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2416,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"0954be86-7a09-4923-8b1d-ca23e6b72df4","name":"IF - Valid Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[-2208,112]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Validation failed\\",\\n  \\"message\\": \\"{{ $json.error }}\\"\\n}","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"866c5943-bfab-4440-a1bb-9b15bf811fd0","name":"Respond - Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-1984,256]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  (SELECT id FROM keyword_projects WHERE id = {{ $json.projectId }}) as project_id,\\n  (SELECT client_id FROM keyword_projects WHERE id = {{ $json.projectId }}) as client_id,\\n  (SELECT main_keyword FROM keyword_projects WHERE id = {{ $json.projectId }}) as main_keyword,\\n  (SELECT scenario_type FROM keyword_projects WHERE id = {{ $json.projectId }}) as scenario_type,\\n  (SELECT target_country FROM keyword_projects WHERE id = {{ $json.projectId }}) as target_country,\\n  (SELECT target_language FROM keyword_projects WHERE id = {{ $json.projectId }}) as target_language,\\n  (SELECT c.domain FROM keyword_projects kp JOIN clients c ON c.id = kp.client_id WHERE kp.id = {{ $json.projectId }}) as client_domain,\\n  (SELECT c.name FROM keyword_projects kp JOIN clients c ON c.id = kp.client_id WHERE kp.id = {{ $json.projectId }}) as client_name,\\n  (SELECT COALESCE(cc.enable_ai_analysis, 0) FROM keyword_projects kp LEFT JOIN client_configurations cc ON cc.client_id = kp.client_id WHERE kp.id = {{ $json.projectId }}) as enable_ai_analysis,\\n  (SELECT COALESCE(cc.ai_model_preference, 'gemini-2.0-flash') FROM keyword_projects kp LEFT JOIN client_configurations cc ON cc.client_id = kp.client_id WHERE kp.id = {{ $json.projectId }}) as ai_model,\\n  (SELECT COALESCE(cc.ai_temperature, 0.7) FROM keyword_projects kp LEFT JOIN client_configurations cc ON cc.client_id = kp.client_id WHERE kp.id = {{ $json.projectId }}) as ai_temperature,\\n  (SELECT cc.target_audience FROM keyword_projects kp LEFT JOIN client_configurations cc ON cc.client_id = kp.client_id WHERE kp.id = {{ $json.projectId }}) as target_audience,\\n  (SELECT prompt_text FROM system_prompts WHERE slug = 'keyword-filter' AND is_active = 1 LIMIT 1) as system_prompt","options":{}},"id":"0f712d11-e31c-4fe2-b99f-5156270b0fbb","name":"MySQL - Get Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1984,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Check if project exists and pass all data including system_prompt\\nconst result = $input.first().json;\\nconst validatedData = $('Code - Validate Input').first().json;\\n\\nif (!result.project_id) {\\n  return [{\\n    json: {\\n      projectExists: false,\\n      projectId: validatedData.projectId\\n    }\\n  }];\\n}\\n\\nreturn [{\\n  json: {\\n    projectExists: true,\\n    project_id: result.project_id,\\n    client_id: result.client_id,\\n    main_keyword: result.main_keyword,\\n    scenario_type: result.scenario_type,\\n    target_country: result.target_country,\\n    target_language: result.target_language,\\n    client_domain: result.client_domain,\\n    client_name: result.client_name,\\n    enable_ai_analysis: result.enable_ai_analysis,\\n    ai_model: result.ai_model,\\n    ai_temperature: result.ai_temperature,\\n    target_audience: result.target_audience,\\n    system_prompt: result.system_prompt,\\n    projectId: validatedData.projectId\\n  }\\n}];"},"id":"f507a0a8-f569-4cc2-8b2e-4bea64cdb680","name":"Code - Check Project","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1760,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"project-exists","leftValue":"={{ $json.projectExists }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"e5fbe619-6d3e-4655-9b9e-d94c4f6f8745","name":"IF - Project Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1536,112]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Project not found\\",\\n  \\"message\\": \\"Proje bulunamadi: {{ $json.projectId }}\\"\\n}","options":{"responseCode":404}},"id":"5d23718b-5775-47ba-9708-95e1ac0bab76","name":"Respond - Project Not Found","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-1328,256]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  id,\\n  keyword,\\n  keyword_type,\\n  search_volume,\\n  keyword_difficulty,\\n  cpc,\\n  search_intent,\\n  trend_direction,\\n  opportunity_score\\nFROM keyword_results \\nWHERE project_id = {{ $json.project_id }}\\nORDER BY search_volume DESC\\nLIMIT 100","options":{}},"id":"adaab5ea-b566-40f7-b5cb-1550ccebf03c","name":"MySQL - Get Keywords","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1328,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Check if keywords exist and pass all project data including system_prompt\\nconst items = $input.all();\\nconst projectData = $('Code - Check Project').first().json;\\n\\nconst hasKeywords = items.length > 0 && !!items[0].json.id;\\n\\n// Pass complete projectData including system_prompt\\nreturn [{\\n  json: {\\n    hasKeywords: hasKeywords,\\n    keywordCount: hasKeywords ? items.length : 0,\\n    projectData: {\\n      project_id: projectData.project_id,\\n      client_id: projectData.client_id,\\n      main_keyword: projectData.main_keyword,\\n      scenario_type: projectData.scenario_type,\\n      client_name: projectData.client_name,\\n      target_audience: projectData.target_audience,\\n      enable_ai_analysis: projectData.enable_ai_analysis,\\n      ai_model: projectData.ai_model,\\n      ai_temperature: projectData.ai_temperature,\\n      system_prompt: projectData.system_prompt\\n    },\\n    keywords: hasKeywords ? items.map(i => i.json) : []\\n  }\\n}];"},"id":"7ed9d9a7-c469-4b43-8d7c-ea762c00a80a","name":"Code - Check Keywords","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1104,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-keywords","leftValue":"={{ $json.hasKeywords }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"9712ecc9-255f-4b61-a682-981e8daf5750","name":"IF - Has Keywords","type":"n8n-nodes-base.if","typeVersion":2,"position":[-880,112]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"No keywords found\\",\\n  \\"message\\": \\"Bu projede filtrelenecek keyword bulunamadi. Once WF-101a ile keyword discovery yapin.\\",\\n  \\"project_id\\": {{ $json.projectData.project_id }}\\n}","options":{"responseCode":404}},"id":"9a19c0fe-0bf2-44e6-8462-60abc19f98e9","name":"Respond - No Keywords","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-656,256]},{"parameters":{"jsCode":"// Prepare AI prompt from database template - COMPACT CSV FORMAT\\nconst data = $input.first().json;\\nconst projectData = data.projectData;\\nconst keywords = data.keywords;\\n\\n// Build keyword list in compact CSV format: ID|keyword\\nconst keywordList = keywords.map(kw => `${kw.id}|${kw.keyword}`).join('\\\\n');\\n\\n// Get system prompt from database and replace template variables\\nlet prompt = projectData.system_prompt || '';\\n\\nif (!prompt) {\\n  prompt = `Keyword filtreleme. Ana konu: ${projectData.main_keyword}\\\\nKEYWORDS (ID|keyword):\\\\n${keywordList}\\\\nIKTI (sadece CSV, balk yok):\\\\nID|status|intent|cluster`;\\n}\\n\\n// Replace template variables\\nprompt = prompt\\n  .replace(/\\\\{\\\\{main_keyword\\\\}\\\\}/g, projectData.main_keyword || '')\\n  .replace(/\\\\{\\\\{client_name\\\\}\\\\}/g, projectData.client_name || '')\\n  .replace(/\\\\{\\\\{target_audience\\\\}\\\\}/g, projectData.target_audience || '')\\n  .replace(/\\\\{\\\\{scenario_type\\\\}\\\\}/g, projectData.scenario_type || '')\\n  .replace(/\\\\{\\\\{keyword_list\\\\}\\\\}/g, keywordList);\\n\\nreturn [{\\n  json: {\\n    project_id: projectData.project_id,\\n    client_id: projectData.client_id,\\n    main_keyword: projectData.main_keyword,\\n    enable_ai_analysis: projectData.enable_ai_analysis,\\n    ai_model: projectData.ai_model,\\n    ai_temperature: projectData.ai_temperature || 0.7,\\n    prompt: prompt,\\n    keyword_count: keywords.length,\\n    keywords: keywords\\n  }\\n}];"},"id":"f9ffc55c-0d61-4c74-b9f4-dfd11cdf1f54","name":"Code - Prepare AI Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,112]},{"parameters":{"url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{\\n    \\"parts\\": [{\\n      \\"text\\": {{ JSON.stringify($json.prompt) }}\\n    }]\\n  }],\\n  \\"generationConfig\\": {\\n    \\"temperature\\": {{ $json.ai_temperature }},\\n    \\"maxOutputTokens\\": 4096\\n  }\\n}","options":{"timeout":30000}},"id":"6f91d0aa-06d0-4cb6-bb53-26b6ad8febb5","name":"Gemini - Try First","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-448,112],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"gemini-success","leftValue":"={{ $json.candidates && $json.candidates.length > 0 }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"749dc652-f8b7-4ce4-b55d-3a9e6e7eb151","name":"IF - Gemini Success","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"url":"https://api.openai.com/v1/chat/completions","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"model\\": \\"gpt-4\\",\\n  \\"messages\\": [\\n    {\\n      \\"role\\": \\"user\\",\\n      \\"content\\": {{ JSON.stringify($('Code - Prepare AI Prompt').first().json.prompt) }}\\n    }\\n  ],\\n  \\"temperature\\": {{ $('Code - Prepare AI Prompt').first().json.ai_temperature }},\\n  \\"max_tokens\\": 4096\\n}","options":{"timeout":60000}},"id":"2f32dbee-36df-4110-b55f-228858267437","name":"OpenAI - Fallback","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,256],"credentials":{"httpHeaderAuth":{"id":"01zZGrP0Fob8kD8r","name":"Serper API"}},"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"openai-success","leftValue":"={{ $json.choices && $json.choices.length > 0 }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"58e58e61-d503-499b-83d6-9aa15ada3486","name":"IF - OpenAI Success","type":"n8n-nodes-base.if","typeVersion":2,"position":[224,256]},{"parameters":{"jsCode":"// Mock AI filtreleme - fallback when both APIs fail\\nconst promptData = $('Code - Prepare AI Prompt').first().json;\\nconst keywords = promptData.keywords || [];\\n\\nconst approved = [];\\nconst rejected = [];\\nconst clusterMap = {};\\n\\nkeywords.forEach((kw, idx) => {\\n  const keyword = kw.keyword.toLowerCase();\\n  \\n  // Eleme kriterleri\\n  if (keyword.length < 3) {\\n    rejected.push({ keyword_id: kw.id, keyword: kw.keyword, rejection_reason: 'Cok kisa keyword' });\\n    return;\\n  }\\n  \\n  if (kw.search_volume && kw.search_volume < 10) {\\n    rejected.push({ keyword_id: kw.id, keyword: kw.keyword, rejection_reason: 'Cok dusuk arama hacmi' });\\n    return;\\n  }\\n  \\n  // Intent belirleme\\n  let intent = 'informational';\\n  if (keyword.includes('fiyat') || keyword.includes('satin al') || keyword.includes('nereden')) {\\n    intent = 'commercial';\\n  } else if (keyword.includes('siparis') || keyword.includes('indir')) {\\n    intent = 'transactional';\\n  } else if (keyword.includes('nedir') || keyword.includes('nasil')) {\\n    intent = 'informational';\\n  }\\n  \\n  // Firsat skoru hesapla\\n  let score = 50;\\n  if (kw.search_volume > 1000) score += 20;\\n  else if (kw.search_volume > 500) score += 10;\\n  \\n  if (kw.keyword_difficulty && kw.keyword_difficulty < 30) score += 15;\\n  else if (kw.keyword_difficulty && kw.keyword_difficulty < 50) score += 5;\\n  \\n  if (kw.keyword_type === 'long_tail') score += 10;\\n  if (kw.keyword_type === 'question') score += 5;\\n  \\n  // Kume belirleme\\n  let cluster = 'Genel';\\n  if (keyword.includes('nedir') || keyword.includes('ne ise yarar')) {\\n    cluster = 'Bilgi Icerikleri';\\n  } else if (keyword.includes('fiyat') || keyword.includes('maliyet')) {\\n    cluster = 'Fiyat Karsilastirma';\\n  } else if (keyword.includes('nasil') || keyword.includes('yapilir')) {\\n    cluster = 'Rehber Icerikleri';\\n  } else if (keyword.includes('en iyi') || keyword.includes('onerisi')) {\\n    cluster = 'Karsilastirma Icerikleri';\\n  }\\n  \\n  if (!clusterMap[cluster]) clusterMap[cluster] = [];\\n  clusterMap[cluster].push(kw.keyword);\\n  \\n  approved.push({\\n    keyword_id: kw.id,\\n    keyword: kw.keyword,\\n    search_intent: intent,\\n    opportunity_score: Math.min(score, 100),\\n    priority: score >= 70 ? 'high' : score >= 50 ? 'medium' : 'low',\\n    cluster_suggestion: cluster,\\n    reasoning: `${kw.keyword_type} keyword, ${kw.search_volume || 'bilinmeyen'} hacim`\\n  });\\n});\\n\\nreturn {\\n  project_id: promptData.project_id,\\n  ai_response: {\\n    summary: `[MOCK - API Fallback] ${keywords.length} keyword analiz edildi. ${approved.length} onaylandi, ${rejected.length} elendi.`,\\n    total_input: keywords.length,\\n    total_approved: approved.length,\\n    total_rejected: rejected.length,\\n    approved_keywords: approved,\\n    rejected_keywords: rejected,\\n    cluster_map: clusterMap\\n  },\\n  ai_source: 'mock'\\n};"},"id":"5d22b808-fbe3-42ea-b2e0-c6654cd7316d","name":"Code - Mock Fallback","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,400]},{"parameters":{"jsCode":"// Gemini response parse - CSV FORMAT: ID|status|intent|cluster\\nconst inputData = $input.first().json;\\nconst projectData = $('Code - Prepare AI Prompt').first().json;\\nconst originalKeywords = projectData.keywords || [];\\n\\nlet rawContent = inputData.candidates[0].content.parts[0].text;\\n\\n// Clean markdown if present\\nlet csvContent = rawContent.replace(/```[a-z]*\\\\n?/g, '').replace(/```/g, '').trim();\\n\\n// Parse CSV lines\\nconst lines = csvContent.split('\\\\n').filter(l => l.trim() && !l.startsWith('ID|'));\\nconst approved = [];\\nconst rejected = [];\\nconst clusterMap = {};\\n\\nfor (const line of lines) {\\n  const parts = line.split('|').map(p => p.trim());\\n  if (parts.length < 4) continue;\\n  \\n  const [id, status, intent, cluster] = parts;\\n  const kwId = parseInt(id);\\n  const origKw = originalKeywords.find(k => k.id === kwId);\\n  if (!origKw) continue;\\n  \\n  if (status === 'approved' || status === 'onay') {\\n    approved.push({\\n      keyword_id: kwId,\\n      keyword: origKw.keyword,\\n      search_intent: intent,\\n      opportunity_score: 70,\\n      priority: 'medium',\\n      cluster_suggestion: cluster\\n    });\\n    if (!clusterMap[cluster]) clusterMap[cluster] = [];\\n    clusterMap[cluster].push(origKw.keyword);\\n  } else {\\n    rejected.push({ keyword_id: kwId, keyword: origKw.keyword, rejection_reason: status });\\n  }\\n}\\n\\nconst aiResponse = {\\n  summary: `${originalKeywords.length} keyword analiz edildi. ${approved.length} onayland, ${rejected.length} elendi.`,\\n  total_input: originalKeywords.length,\\n  total_approved: approved.length,\\n  total_rejected: rejected.length,\\n  approved_keywords: approved,\\n  rejected_keywords: rejected,\\n  cluster_map: clusterMap\\n};\\n\\nreturn { project_id: projectData.project_id, ai_response: aiResponse, ai_source: 'gemini' };"},"id":"ba50c82d-984e-40e2-844a-d515da770866","name":"Code - Parse Gemini","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,0]},{"parameters":{"jsCode":"// OpenAI response parse - CSV FORMAT: ID|status|intent|cluster\\nconst inputData = $input.first().json;\\nconst projectData = $('Code - Prepare AI Prompt').first().json;\\nconst originalKeywords = projectData.keywords || [];\\n\\nlet rawContent = inputData.choices[0].message.content;\\n\\n// Clean markdown if present\\nlet csvContent = rawContent.replace(/```[a-z]*\\\\n?/g, '').replace(/```/g, '').trim();\\n\\n// Parse CSV lines\\nconst lines = csvContent.split('\\\\n').filter(l => l.trim() && !l.startsWith('ID|'));\\nconst approved = [];\\nconst rejected = [];\\nconst clusterMap = {};\\n\\nfor (const line of lines) {\\n  const parts = line.split('|').map(p => p.trim());\\n  if (parts.length < 4) continue;\\n  \\n  const [id, status, intent, cluster] = parts;\\n  const kwId = parseInt(id);\\n  const origKw = originalKeywords.find(k => k.id === kwId);\\n  if (!origKw) continue;\\n  \\n  if (status === 'approved' || status === 'onay') {\\n    approved.push({\\n      keyword_id: kwId,\\n      keyword: origKw.keyword,\\n      search_intent: intent,\\n      opportunity_score: 70,\\n      priority: 'medium',\\n      cluster_suggestion: cluster\\n    });\\n    if (!clusterMap[cluster]) clusterMap[cluster] = [];\\n    clusterMap[cluster].push(origKw.keyword);\\n  } else {\\n    rejected.push({ keyword_id: kwId, keyword: origKw.keyword, rejection_reason: status });\\n  }\\n}\\n\\nconst aiResponse = {\\n  summary: `${originalKeywords.length} keyword analiz edildi. ${approved.length} onayland, ${rejected.length} elendi.`,\\n  total_input: originalKeywords.length,\\n  total_approved: approved.length,\\n  total_rejected: rejected.length,\\n  approved_keywords: approved,\\n  rejected_keywords: rejected,\\n  cluster_map: clusterMap\\n};\\n\\nreturn { project_id: projectData.project_id, ai_response: aiResponse, ai_source: 'openai' };"},"id":"e2e86593-6766-470d-8d8e-2a267b7e84b9","name":"Code - Parse OpenAI","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,160]},{"parameters":{"jsCode":"// Calculate token usage from AI responses\\nconst data = $input.first().json;\\nconst projectData = $('Code - Prepare AI Prompt').first().json;\\nconst aiSource = data.ai_source;\\n\\nlet tokensInput = 0;\\nlet tokensOutput = 0;\\nlet modelName = '';\\nlet apiProvider = '';\\n\\n// Estimate tokens based on character count (rough estimate: chars/4)\\nconst promptLength = projectData.prompt ? projectData.prompt.length : 0;\\ntokensInput = Math.ceil(promptLength / 4);\\n\\nif (aiSource === 'gemini') {\\n  const geminiResponse = $('Gemini - Try First').first().json;\\n  const responseText = geminiResponse?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  tokensOutput = Math.ceil(responseText.length / 4);\\n  apiProvider = 'gemini';\\n  modelName = 'gemini-2.0-flash';\\n} else if (aiSource === 'openai') {\\n  const openaiResponse = $('OpenAI - Fallback').first().json;\\n  const responseText = openaiResponse?.choices?.[0]?.message?.content || '';\\n  tokensOutput = Math.ceil(responseText.length / 4);\\n  apiProvider = 'openai';\\n  modelName = 'gpt-4';\\n} else if (aiSource === 'mock') {\\n  // Mock fallback - minimal token usage\\n  tokensInput = Math.ceil(promptLength / 4);\\n  tokensOutput = 100;\\n  apiProvider = 'mock';\\n  modelName = 'mock-fallback';\\n}\\n\\nreturn {\\n  project_id: data.project_id,\\n  client_id: projectData.client_id,\\n  ai_source: aiSource,\\n  ai_response: data.ai_response,\\n  token_tracking: {\\n    api_provider: apiProvider,\\n    model_name: modelName,\\n    tokens_input: tokensInput,\\n    tokens_output: tokensOutput,\\n    requests_count: 1,\\n    was_successful: 1\\n  }\\n};"},"id":"e72ffd25-218f-4bc7-b32a-17a881ba47a5","name":"Code - Calculate Token Usage","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,112]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO api_usage_tracking \\n  (client_id, tool_name, project_id, workflow_name, api_provider, model_name, tokens_input, tokens_output, requests_count, was_successful)\\nVALUES \\n  ({{ $json.client_id }}, 'tool1', {{ $json.project_id }}, 'WF-101b-keyword-filter', '{{ $json.token_tracking.api_provider }}', '{{ $json.token_tracking.model_name }}', {{ $json.token_tracking.tokens_input }}, {{ $json.token_tracking.tokens_output }}, {{ $json.token_tracking.requests_count }}, {{ $json.token_tracking.was_successful }})","options":{}},"id":"136ecb62-8e57-4fb9-9e1c-09ff16423922","name":"MySQL - Log Token Usage","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[880,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Split approved keywords for update - Reference token calculation node for original data\\nconst data = $('Code - Calculate Token Usage').first().json;\\nconst aiResponse = data.ai_response;\\nconst approved = aiResponse?.approved_keywords || [];\\n\\nif (approved.length === 0) {\\n  return [{ json: { skip: true, project_id: data.project_id, ai_source: data.ai_source, ai_response: aiResponse, count: 0 } }];\\n}\\n\\nreturn approved.map(kw => ({\\n  json: {\\n    keyword_id: kw.keyword_id,\\n    search_intent: kw.search_intent,\\n    opportunity_score: kw.opportunity_score,\\n    keyword_cluster: kw.cluster_suggestion,\\n    project_id: data.project_id,\\n    ai_source: data.ai_source,\\n    ai_response: aiResponse\\n  }\\n}));"},"id":"eea514e5-ced9-4a45-be11-55e1f5228b73","name":"Code - Split Approved","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-approved","leftValue":"={{ $json.skip }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"8c1275a5-1701-4174-92a3-6f763e5a8974","name":"IF - Has Approved","type":"n8n-nodes-base.if","typeVersion":2,"position":[880,112]},{"parameters":{"operation":"executeQuery","query":"=UPDATE keyword_results \\nSET \\n  search_intent = '{{ $json.search_intent }}',\\n  opportunity_score = {{ $json.opportunity_score }},\\n  keyword_cluster = '{{ ($json.keyword_cluster || '').replace(/'/g, \\"''\\") }}'\\nWHERE id = {{ $json.keyword_id }}","options":{}},"id":"5310c69a-5364-4fd1-8f78-af7844ebbe2f","name":"MySQL - Update Keyword","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1104,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=UPDATE keyword_projects \\nSET status = 'keywords_filtered'\\nWHERE id = {{ $('Code - Split Approved').first().json.project_id }}","options":{}},"id":"98fd40a1-a559-449e-ae72-39e7e781cdf8","name":"MySQL - Update Project Status","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1328,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"const firstItem = $('Code - Split Approved').first().json;\\nconst aiResponse = firstItem.ai_response || {};\\nconst approvedCount = $('Code - Split Approved').all().length;\\n\\nreturn {\\n  success: true,\\n  message: aiResponse.summary || 'Keyword filtreleme tamamlandi',\\n  project_id: firstItem.project_id,\\n  total_input: aiResponse.total_input || 0,\\n  total_approved: aiResponse.total_approved || approvedCount,\\n  total_rejected: aiResponse.total_rejected || 0,\\n  cluster_map: aiResponse.cluster_map || {},\\n  ai_source: firstItem.ai_source || 'unknown',\\n  next_step: 'WF-104 Competitor Analyzer ile rakip analizi yapilabilir'\\n};"},"id":"f8d75740-b0eb-455d-88ed-c18b395aa664","name":"Code - Prepare Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1552,112]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"94cfc5f8-80a6-4c79-b3ec-82de2c9bd551","name":"Respond - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1760,112]},{"parameters":{"jsCode":"const data = $input.first().json;\\nconst aiResponse = data.ai_response || {};\\n\\nreturn {\\n  success: true,\\n  message: 'Filtreleme tamamlandi ancak onaylanan keyword bulunamadi',\\n  project_id: data.project_id,\\n  total_input: aiResponse.total_input || 0,\\n  total_approved: 0,\\n  total_rejected: aiResponse.total_rejected || 0,\\n  ai_source: data.ai_source || 'unknown'\\n};"},"id":"a951f37e-c5d5-4c83-9731-25cccccb9831","name":"Code - No Approved","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,208]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"8a0f6b1c-8b6c-4c6b-9a76-08398fe7e3f5","name":"Respond - No Approved","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1328,208]}]	{"Webhook":{"main":[[{"node":"Code - Validate Input","type":"main","index":0}]]},"Code - Validate Input":{"main":[[{"node":"IF - Valid Input","type":"main","index":0}]]},"IF - Valid Input":{"main":[[{"node":"MySQL - Get Project","type":"main","index":0}],[{"node":"Respond - Validation Error","type":"main","index":0}]]},"MySQL - Get Project":{"main":[[{"node":"Code - Check Project","type":"main","index":0}]]},"Code - Check Project":{"main":[[{"node":"IF - Project Exists","type":"main","index":0}]]},"IF - Project Exists":{"main":[[{"node":"MySQL - Get Keywords","type":"main","index":0}],[{"node":"Respond - Project Not Found","type":"main","index":0}]]},"MySQL - Get Keywords":{"main":[[{"node":"Code - Check Keywords","type":"main","index":0}]]},"Code - Check Keywords":{"main":[[{"node":"IF - Has Keywords","type":"main","index":0}]]},"IF - Has Keywords":{"main":[[{"node":"Code - Prepare AI Prompt","type":"main","index":0}],[{"node":"Respond - No Keywords","type":"main","index":0}]]},"Code - Prepare AI Prompt":{"main":[[{"node":"Gemini - Try First","type":"main","index":0}]]},"Gemini - Try First":{"main":[[{"node":"IF - Gemini Success","type":"main","index":0}]]},"IF - Gemini Success":{"main":[[{"node":"Code - Parse Gemini","type":"main","index":0}],[{"node":"OpenAI - Fallback","type":"main","index":0}]]},"Code - Parse Gemini":{"main":[[{"node":"Code - Calculate Token Usage","type":"main","index":0}]]},"OpenAI - Fallback":{"main":[[{"node":"IF - OpenAI Success","type":"main","index":0}]]},"IF - OpenAI Success":{"main":[[{"node":"Code - Parse OpenAI","type":"main","index":0}],[{"node":"Code - Mock Fallback","type":"main","index":0}]]},"Code - Parse OpenAI":{"main":[[{"node":"Code - Calculate Token Usage","type":"main","index":0}]]},"Code - Mock Fallback":{"main":[[{"node":"Code - Calculate Token Usage","type":"main","index":0}]]},"Code - Calculate Token Usage":{"main":[[{"node":"MySQL - Log Token Usage","type":"main","index":0}]]},"MySQL - Log Token Usage":{"main":[[{"node":"Code - Split Approved","type":"main","index":0}]]},"Code - Split Approved":{"main":[[{"node":"IF - Has Approved","type":"main","index":0}]]},"IF - Has Approved":{"main":[[{"node":"MySQL - Update Keyword","type":"main","index":0}],[{"node":"Code - No Approved","type":"main","index":0}]]},"MySQL - Update Keyword":{"main":[[{"node":"MySQL - Update Project Status","type":"main","index":0}]]},"MySQL - Update Project Status":{"main":[[{"node":"Code - Prepare Response","type":"main","index":0}]]},"Code - Prepare Response":{"main":[[{"node":"Respond - Success","type":"main","index":0}]]},"Code - No Approved":{"main":[[{"node":"Respond - No Approved","type":"main","index":0}]]}}	2025-12-17 10:27:22.449+00	2025-12-17 10:27:22.449+00	{"executionOrder":"v1"}	\N	{}	6af1d565-35ba-4e0b-97d9-a109bbb7b16d	1	6nclsXOjxGhT8qJs	{"templateCredsSetupCompleted":true}	\N	f	18	\N	6af1d565-35ba-4e0b-97d9-a109bbb7b16d
WF-103: List Keyword Projects	t	[{"parameters":{"path":"tool1/projects","responseMode":"responseNode","options":{}},"id":"9a0ebdf9-08be-4785-810f-ce71fe62b460","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"tool1-projects-list"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Input validation and sanitization\\nconst query = $json.query || {};\\n\\n// Validate and sanitize limit\\nlet limit = parseInt(query.limit) || 50;\\nlimit = Math.min(Math.max(limit, 1), 100); // 1-100 aras\\n\\n// Validate and sanitize offset\\nlet offset = parseInt(query.offset) || 0;\\noffset = Math.max(offset, 0);\\n\\n// Validate client_id if provided\\nlet clientId = null;\\nlet filterByClient = false;\\nif (query.client_id) {\\n  const parsedClientId = parseInt(query.client_id);\\n  if (isNaN(parsedClientId) || parsedClientId <= 0) {\\n    return {\\n      json: {\\n        isValid: false,\\n        error: 'client_id gecerli bir pozitif sayi olmalidir',\\n        errorCode: 400\\n      }\\n    };\\n  }\\n  clientId = parsedClientId;\\n  filterByClient = true;\\n}\\n\\n// Validate status filter if provided\\nconst validStatuses = ['pending', 'discovering', 'discovered', 'filtering', 'keywords_filtered', 'completed', 'failed'];\\nlet status = null;\\nlet filterByStatus = false;\\nif (query.status) {\\n  if (!validStatuses.includes(query.status)) {\\n    return {\\n      json: {\\n        isValid: false,\\n        error: 'Gecersiz status. Gecerli degerler: ' + validStatuses.join(', '),\\n        errorCode: 400\\n      }\\n    };\\n  }\\n  status = query.status;\\n  filterByStatus = true;\\n}\\n\\nreturn {\\n  json: {\\n    isValid: true,\\n    limit: limit,\\n    offset: offset,\\n    clientId: clientId,\\n    filterByClient: filterByClient,\\n    status: status,\\n    filterByStatus: filterByStatus\\n  }\\n};"},"id":"6a193953-11cd-48d7-a7eb-2c14a17013ee","name":"Code - Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"e4ac4e86-402a-471a-bdca-18217be685cc","name":"IF - Valid Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,0]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Validation failed\\",\\n  \\"message\\": \\"{{ $json.error }}\\"\\n}","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"432f90d9-d69c-4712-9dab-5c7bf574b935","name":"Respond - Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,160]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  kp.id,\\n  kp.uuid,\\n  kp.project_name,\\n  kp.main_keyword,\\n  kp.scenario_type,\\n  kp.target_country,\\n  kp.target_language,\\n  kp.status,\\n  kp.created_at,\\n  kp.updated_at,\\n  c.id as client_id,\\n  c.name as client_name,\\n  (SELECT COUNT(*) FROM keyword_results WHERE project_id = kp.id) as keyword_count\\nFROM keyword_projects kp\\nLEFT JOIN clients c ON kp.client_id = c.id\\nWHERE 1=1\\n{{ $json.filterByClient ? ' AND kp.client_id = ' + $json.clientId : '' }}\\n{{ $json.filterByStatus ? \\" AND kp.status = '\\" + $json.status + \\"'\\" : '' }}\\nORDER BY kp.created_at DESC\\nLIMIT {{ $json.limit }}\\nOFFSET {{ $json.offset }}","options":{}},"id":"b17d0631-ce45-47ce-8d0c-25fcb2309aac","name":"MySQL - List Projects","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT COUNT(*) as total \\nFROM keyword_projects kp\\nWHERE 1=1\\n{{ $('Code - Validate Input').first().json.filterByClient ? ' AND kp.client_id = ' + $('Code - Validate Input').first().json.clientId : '' }}\\n{{ $('Code - Validate Input').first().json.filterByStatus ? \\" AND kp.status = '\\" + $('Code - Validate Input').first().json.status + \\"'\\" : '' }}","options":{}},"id":"5c7d433b-d6d6-47e3-9735-32efa67350a0","name":"MySQL - Count Total","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[880,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Format response\\nconst projectItems = $('MySQL - List Projects').all();\\nconst countResult = $input.first().json;\\nconst validatedData = $('Code - Validate Input').first().json;\\n\\n// Check if we have actual projects\\nconst hasProjects = projectItems.length > 0 && !!projectItems[0].json.id;\\nconst projects = hasProjects ? projectItems.map(item => {\\n  const p = item.json;\\n  return {\\n    id: p.id,\\n    uuid: p.uuid,\\n    project_name: p.project_name,\\n    main_keyword: p.main_keyword,\\n    scenario_type: p.scenario_type,\\n    target_country: p.target_country,\\n    target_language: p.target_language,\\n    status: p.status,\\n    created_at: p.created_at,\\n    updated_at: p.updated_at,\\n    client: p.client_id ? {\\n      id: p.client_id,\\n      name: p.client_name\\n    } : null,\\n    keyword_count: parseInt(p.keyword_count) || 0\\n  };\\n}) : [];\\n\\nconst total = parseInt(countResult.total) || 0;\\n\\nreturn [{\\n  json: {\\n    success: true,\\n    data: projects,\\n    pagination: {\\n      total: total,\\n      limit: validatedData.limit,\\n      offset: validatedData.offset,\\n      returned: projects.length,\\n      has_more: (validatedData.offset + projects.length) < total\\n    },\\n    filters: {\\n      client_id: validatedData.clientId,\\n      status: validatedData.status\\n    }\\n  }\\n}];"},"id":"4af3fedb-5a05-475c-a3d4-c65a8c0d1526","name":"Code - Format Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,0]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"6c4e14db-61fc-4060-8e7f-0f6c2ee6a150","name":"Respond - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1328,0]}]	{"Webhook":{"main":[[{"node":"Code - Validate Input","type":"main","index":0}]]},"Code - Validate Input":{"main":[[{"node":"IF - Valid Input","type":"main","index":0}]]},"IF - Valid Input":{"main":[[{"node":"MySQL - List Projects","type":"main","index":0}],[{"node":"Respond - Validation Error","type":"main","index":0}]]},"MySQL - List Projects":{"main":[[{"node":"MySQL - Count Total","type":"main","index":0}]]},"MySQL - Count Total":{"main":[[{"node":"Code - Format Response","type":"main","index":0}]]},"Code - Format Response":{"main":[[{"node":"Respond - Success","type":"main","index":0}]]}}	2025-12-17 10:28:04.071+00	2025-12-17 10:28:04.071+00	{"executionOrder":"v1"}	\N	{}	d427d382-3336-4aa9-9b50-d3f795ad77ad	1	9wxzOy1QgENPVVSD	{"templateCredsSetupCompleted":true}	\N	f	18	\N	d427d382-3336-4aa9-9b50-d3f795ad77ad
WF-106: Content Gap Finder	t	[{"parameters":{"httpMethod":"POST","path":":projectId/analyze","responseMode":"responseNode","options":{}},"id":"456885fd-6b70-4ff2-acfe-c077168f67b0","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3088,112],"webhookId":"tool1-content-gap"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Input validation\\nconst projectId = $json.params?.projectId;\\n\\nif (!projectId) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'projectId parametresi zorunludur',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nconst parsedId = parseInt(projectId);\\nif (isNaN(parsedId) || parsedId <= 0) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'projectId gecerli bir pozitif sayi olmalidir',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nreturn {\\n  json: {\\n    isValid: true,\\n    projectId: parsedId\\n  }\\n};"},"id":"2d87a9bb-ba19-4804-882d-254aaf614bf8","name":"Code - Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2864,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"b89a68a3-c5f2-4886-aab5-6dd9f3b6b4f8","name":"IF - Valid Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[-2640,112]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Validation failed\\",\\n  \\"message\\": \\"{{ $json.error }}\\"\\n}","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"9a885178-253e-4728-9000-401d9c9cc5e1","name":"Respond - Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-2416,304]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  kp.id as project_id,\\n  kp.client_id,\\n  kp.main_keyword,\\n  kp.target_language,\\n  kp.target_country,\\n  kp.scenario_type,\\n  c.domain as client_domain,\\n  cc.ai_model_preference as client_ai_model,\\n  cc.ai_temperature as client_ai_temperature\\nFROM keyword_projects kp\\nJOIN clients c ON c.id = kp.client_id\\nLEFT JOIN client_configurations cc ON cc.client_id = kp.client_id\\nWHERE kp.id = {{ $json.projectId }}\\nLIMIT 1","options":{}},"id":"4b44dda9-b174-42f7-b574-f46645ccd45e","name":"MySQL - Get Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-2416,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"project-exists","leftValue":"={{ $json.project_id }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"id":"0d82a65c-4b47-4c00-9eda-2cd2b8ed4882","name":"IF - Project Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-2208,112]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Project not found\\",\\n  \\"message\\": \\"Proje bulunamadi: {{ $('Code - Validate Input').first().json.projectId }}\\"\\n}","options":{"responseCode":404}},"id":"e0389edb-4bde-463f-8069-3ac27347a91b","name":"Respond - Not Found","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-1984,304]},{"parameters":{"operation":"executeQuery","query":"SELECT setting_key, setting_value FROM system_settings WHERE setting_key IN ('default_ai_model', 'default_ai_temperature')","options":{}},"id":"e4d0adb7-b6c0-4825-8bea-f25fb3f787ce","name":"MySQL - Get System Settings","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1984,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"SELECT prompt_text FROM system_prompts WHERE slug = 'content-gap-analyzer' AND is_active = 1 LIMIT 1","options":{}},"id":"af2103b0-09ff-4e69-88c0-c3a4c91403a7","name":"MySQL - Get System Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1760,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT competitor_domain, competitor_url, title, COALESCE(word_count, 0) as word_count, headings_json, COALESCE(domain_rating, 0) as domain_rating FROM competitor_data WHERE project_id = {{ $('MySQL - Get Project').first().json.project_id }} ORDER BY serp_position ASC LIMIT 5","options":{}},"id":"b671df11-ccf1-4146-b275-fdfa9cd3a335","name":"MySQL - Get Competitors","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1536,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT has_featured_snippet, featured_snippet_type, featured_snippet_content, has_paa, paa_count, has_video_results, has_image_pack, has_local_pack, has_knowledge_panel, zero_click_risk FROM serp_features WHERE project_id = {{ $('MySQL - Get Project').first().json.project_id }} UNION ALL SELECT 0,NULL,NULL,0,0,0,0,0,0,NULL FROM dual WHERE NOT EXISTS (SELECT 1 FROM serp_features WHERE project_id = {{ $('MySQL - Get Project').first().json.project_id }}) LIMIT 1","options":{}},"id":"4eee0b6c-4038-4d51-8d9b-00247e2a0bca","name":"MySQL - Get SERP Features","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1328,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT question, answer_snippet FROM paa_data WHERE project_id = {{ $('MySQL - Get Project').first().json.project_id }} UNION ALL SELECT NULL as question, NULL as answer_snippet FROM dual WHERE NOT EXISTS (SELECT 1 FROM paa_data WHERE project_id = {{ $('MySQL - Get Project').first().json.project_id }}) LIMIT 10","options":{}},"id":"c1e1484c-0a0c-4b45-ac2e-5b848ad1e588","name":"MySQL - Get PAA","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1104,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Prepare AI prompt - COMPACT CSV FORMAT\\nconst project = $('MySQL - Get Project').first().json;\\nconst systemSettingsItems = $('MySQL - Get System Settings').all();\\nconst systemPromptResult = $('MySQL - Get System Prompt').first().json;\\nconst competitorItems = $('MySQL - Get Competitors').all();\\nconst competitors = competitorItems.filter(i => i.json.competitor_domain).map(i => i.json);\\n\\n// System settings\\nconst systemSettings = {};\\nsystemSettingsItems.forEach(item => {\\n  systemSettings[item.json.setting_key] = item.json.setting_value;\\n});\\n\\n// Model selection\\nconst clientModel = project.client_ai_model;\\nconst systemDefaultModel = systemSettings.default_ai_model || 'gemini-2.0-flash';\\nconst primaryModel = clientModel || systemDefaultModel;\\nlet fallbackModel = null;\\nif (clientModel && systemDefaultModel && clientModel !== systemDefaultModel) {\\n  fallbackModel = systemDefaultModel;\\n}\\nconst temperature = parseFloat(project.client_ai_temperature) || parseFloat(systemSettings.default_ai_temperature) || 0.7;\\n\\n// COMPACT CSV format for competitors: domain|dr|words\\nconst competitorCsv = competitors.map((c, i) => \\n  `${c.competitor_domain}|${i+1}|${c.domain_rating || 0}|${c.word_count || 0}`\\n).join('\\\\n');\\n\\n// System prompt template\\nlet systemPromptTemplate = systemPromptResult?.prompt_text || '';\\n\\n// Replace template variables\\nlet finalPrompt = systemPromptTemplate\\n  .replace(/\\\\{\\\\{main_keyword\\\\}\\\\}/g, project.main_keyword || '')\\n  .replace(/\\\\{\\\\{target_country\\\\}\\\\}/g, project.target_country || 'TR')\\n  .replace(/\\\\{\\\\{competitor_csv\\\\}\\\\}/g, competitorCsv);\\n\\n// Fallback prompt if no system prompt\\nif (!systemPromptTemplate) {\\n  finalPrompt = `Content gap analizi. Konu: ${project.main_keyword} | Ulke: ${project.target_country}\\\\nRAKIPLER (domain|pos|dr|words):\\\\n${competitorCsv}\\\\nCIKTI (sadece CSV, baslik yok):\\\\nkeyword|type|intent|score|format`;\\n}\\n\\nreturn [{\\n  json: {\\n    project_id: project.project_id,\\n    client_id: project.client_id,\\n    main_keyword: project.main_keyword,\\n    primary_model: primaryModel,\\n    fallback_model: fallbackModel,\\n    temperature: temperature,\\n    prompt: finalPrompt,\\n    competitor_count: competitors.length,\\n    has_system_prompt: !!systemPromptTemplate\\n  }\\n}];"},"id":"3bd6d0d1-f6f8-45f4-8673-f0e73321e61b","name":"Code - Prepare AI Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[-880,112]},{"parameters":{"jsCode":"// AI API calls - COMPACT CSV OUTPUT: keyword|type|intent|score|format + TOKEN TRACKING\\nconst data = $input.first().json;\\nconst primaryModel = data.primary_model;\\nconst fallbackModel = data.fallback_model;\\nconst temperature = data.temperature;\\nconst prompt = data.prompt;\\n\\nconst GEMINI_API_KEY = $env.GEMINI_API_KEY || '';\\nconst OPENAI_API_KEY = $env.OPENAI_API_KEY || '';\\n\\nlet tokenUsage = { input: 0, output: 0, model: '', provider: 'none' };\\nlet responseTime = 0;\\n\\n// Gemini API call\\nconst callGemini = async (promptText) => {\\n  const startTime = Date.now();\\n  try {\\n    const response = await this.helpers.httpRequest({\\n      method: 'POST',\\n      url: `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,\\n      body: {\\n        contents: [{ parts: [{ text: promptText }] }],\\n        generationConfig: { temperature: temperature, maxOutputTokens: 2048 }\\n      },\\n      headers: { 'Content-Type': 'application/json' },\\n      timeout: 60000\\n    });\\n    const elapsed = Date.now() - startTime;\\n    if (response.candidates && response.candidates.length > 0) {\\n      const usage = response.usageMetadata || {};\\n      return { success: true, content: response.candidates[0].content.parts[0].text, source: 'gemini', tokens: { input: usage.promptTokenCount || 0, output: usage.candidatesTokenCount || 0 }, model: 'gemini-2.0-flash', elapsed: elapsed };\\n    }\\n    return { success: false, error: 'No candidates', elapsed: elapsed };\\n  } catch (e) {\\n    return { success: false, error: e.message, elapsed: Date.now() - startTime };\\n  }\\n};\\n\\n// OpenAI API call\\nconst callOpenAI = async (promptText) => {\\n  const startTime = Date.now();\\n  try {\\n    const response = await this.helpers.httpRequest({\\n      method: 'POST',\\n      url: 'https://api.openai.com/v1/chat/completions',\\n      body: { model: 'gpt-4o-mini', messages: [{ role: 'user', content: promptText }], temperature: temperature, max_tokens: 2048 },\\n      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${OPENAI_API_KEY}` },\\n      timeout: 60000\\n    });\\n    const elapsed = Date.now() - startTime;\\n    if (response.choices && response.choices.length > 0) {\\n      const usage = response.usage || {};\\n      return { success: true, content: response.choices[0].message.content, source: 'openai', tokens: { input: usage.prompt_tokens || 0, output: usage.completion_tokens || 0 }, model: 'gpt-4o-mini', elapsed: elapsed };\\n    }\\n    return { success: false, error: 'No choices', elapsed: elapsed };\\n  } catch (e) {\\n    return { success: false, error: e.message, elapsed: Date.now() - startTime };\\n  }\\n};\\n\\nconst callModel = async (model, promptText) => {\\n  if (model && model.toLowerCase().includes('gemini')) return await callGemini(promptText);\\n  if (model && (model.toLowerCase().includes('openai') || model.toLowerCase().includes('gpt'))) return await callOpenAI(promptText);\\n  return { success: false, error: 'Unknown model: ' + model, elapsed: 0 };\\n};\\n\\n// Parse CSV response: keyword|type|intent|score|format\\nconst parseCSVResponse = (content) => {\\n  const csvContent = content.replace(/```[a-z]*\\\\n?/g, '').replace(/```/g, '').trim();\\n  const lines = csvContent.split('\\\\n').filter(l => l.trim() && !l.startsWith('keyword|'));\\n  const gaps = [];\\n  for (const line of lines) {\\n    const parts = line.split('|').map(p => p.trim());\\n    if (parts.length >= 5) {\\n      gaps.push({\\n        keyword: parts[0],\\n        keyword_type: parts[1] || 'related',\\n        search_intent: parts[2] || 'informational',\\n        opportunity_score: parseInt(parts[3]) || 50,\\n        content_format: parts[4] || 'blog'\\n      });\\n    }\\n  }\\n  return { content_gaps: gaps, analysis_summary: `${gaps.length} keyword onerisi olusturuldu.` };\\n};\\n\\n// Mock response\\nconst getMockResponse = (mainKeyword) => ({\\n  analysis_summary: `[MOCK] ${mainKeyword} icin 5 keyword onerisi.`,\\n  content_gaps: [\\n    { keyword: `${mainKeyword} nedir`, keyword_type: 'question', search_intent: 'informational', opportunity_score: 85, content_format: 'blog' },\\n    { keyword: `${mainKeyword} fiyatlari`, keyword_type: 'related', search_intent: 'commercial', opportunity_score: 78, content_format: 'comparison' },\\n    { keyword: `${mainKeyword} nasil yapilir`, keyword_type: 'question', search_intent: 'informational', opportunity_score: 82, content_format: 'guide' },\\n    { keyword: `en iyi ${mainKeyword}`, keyword_type: 'related', search_intent: 'commercial', opportunity_score: 75, content_format: 'comparison' },\\n    { keyword: `${mainKeyword} 2024`, keyword_type: 'related', search_intent: 'informational', opportunity_score: 88, content_format: 'blog' }\\n  ]\\n});\\n\\n// Main flow\\nlet result = null;\\nlet aiSource = 'mock';\\n\\nif (primaryModel) {\\n  const primaryResult = await callModel(primaryModel, prompt);\\n  responseTime = primaryResult.elapsed || 0;\\n  if (primaryResult.success) {\\n    result = parseCSVResponse(primaryResult.content);\\n    aiSource = primaryResult.source;\\n    tokenUsage = { input: primaryResult.tokens?.input || 0, output: primaryResult.tokens?.output || 0, model: primaryResult.model, provider: primaryResult.source };\\n  }\\n}\\n\\nif ((!result || !result.content_gaps || result.content_gaps.length === 0) && fallbackModel) {\\n  const fallbackResult = await callModel(fallbackModel, prompt);\\n  responseTime = fallbackResult.elapsed || 0;\\n  if (fallbackResult.success) {\\n    result = parseCSVResponse(fallbackResult.content);\\n    aiSource = fallbackResult.source + '-fallback';\\n    tokenUsage = { input: fallbackResult.tokens?.input || 0, output: fallbackResult.tokens?.output || 0, model: fallbackResult.model, provider: fallbackResult.source };\\n  }\\n}\\n\\nif (!result || !result.content_gaps || result.content_gaps.length === 0) {\\n  result = getMockResponse(data.main_keyword);\\n  aiSource = 'mock';\\n}\\n\\nreturn [{\\n  json: {\\n    project_id: data.project_id,\\n    client_id: data.client_id,\\n    main_keyword: data.main_keyword,\\n    content_gaps: result.content_gaps || [],\\n    analysis_summary: result.analysis_summary || '',\\n    ai_source: aiSource,\\n    token_usage: tokenUsage,\\n    response_time_ms: responseTime\\n  }\\n}];"},"id":"15595b98-9333-4194-ab7b-c6845bf77d2d","name":"Code - AI Analysis","type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,112]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO api_usage_tracking (client_id, tool_name, project_id, workflow_name, api_provider, model_name, tokens_input, tokens_output, requests_count, response_time_ms, was_successful) VALUES ({{ $json.client_id || 0 }}, 'tool1', {{ $json.project_id || 0 }}, 'WF-106-content-gap-finder', '{{ $json.token_usage?.provider === 'gemini' ? 'google' : $json.token_usage?.provider === 'openai' ? 'openai' : 'other' }}', '{{ $json.token_usage?.model || '' }}', {{ $json.token_usage?.input || 0 }}, {{ $json.token_usage?.output || 0 }}, 1, {{ $json.response_time_ms || 0 }}, {{ $json.ai_source !== 'mock' ? 1 : 0 }})","options":{}},"id":"88145cc9-c996-4688-a168-bf4746dc4e02","name":"MySQL - Log Token Usage","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-544,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Content gap keyword'lerini ayr ayr insert iin hazrla\\nconst data = $('Code - AI Analysis').first().json;\\nconst gaps = data.content_gaps || [];\\n\\nif (gaps.length === 0) {\\n  return [{ json: { skip: true, project_id: data.project_id, ai_source: data.ai_source, analysis_summary: data.analysis_summary } }];\\n}\\n\\nreturn gaps.map(gap => ({\\n  json: {\\n    project_id: data.project_id,\\n    keyword: gap.keyword,\\n    keyword_type: gap.keyword_type || 'related',\\n    search_intent: gap.search_intent || 'informational',\\n    opportunity_score: gap.opportunity_score || 50,\\n    content_format: gap.content_format || 'blog',\\n    reasoning: gap.reasoning || '',\\n    source: 'ai',\\n    ai_source: data.ai_source,\\n    analysis_summary: data.analysis_summary,\\n    pillar_suggestion: data.pillar_suggestion,\\n    cluster_suggestions: data.cluster_suggestions\\n  }\\n}));"},"id":"ead5c920-dd68-4b47-9240-54fdb9dee58f","name":"Code - Split Keywords","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-keywords","leftValue":"={{ $json.skip }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"fbdafd5e-7ede-4972-ad53-2644574fd8a9","name":"IF - Has Keywords","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO keyword_results \\n  (project_id, keyword, keyword_type, search_intent, opportunity_score, source)\\nVALUES \\n  ({{ $json.project_id }}, '{{ $json.keyword.replace(/'/g, \\"''\\") }}', '{{ $json.keyword_type }}', '{{ $json.search_intent }}', {{ $json.opportunity_score }}, '{{ $json.source }}')\\nON DUPLICATE KEY UPDATE\\n  opportunity_score = VALUES(opportunity_score),\\n  search_intent = VALUES(search_intent)","options":{}},"id":"b9b60e47-a2b8-4843-a23e-22300a6477a6","name":"MySQL - Save Keyword","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[0,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=UPDATE keyword_projects \\nSET \\n  total_keywords_found = (SELECT COUNT(*) FROM keyword_results WHERE project_id = {{ $('Code - Split Keywords').first().json.project_id }})\\nWHERE id = {{ $('Code - Split Keywords').first().json.project_id }}","options":{}},"id":"70461db9-c05d-49c5-8936-f2f247880911","name":"MySQL - Update Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Response iin veri hazrla\\nconst firstItem = $('Code - Split Keywords').first().json;\\nconst keywordCount = $('Code - Split Keywords').all().filter(i => !i.json.skip).length;\\n\\nreturn {\\n  success: true,\\n  message: `Content Gap analizi tamamlandi. ${keywordCount} keyword onerisi olusturuldu.`,\\n  project_id: firstItem.project_id,\\n  analysis_summary: firstItem.analysis_summary || '',\\n  pillar_suggestion: firstItem.pillar_suggestion || '',\\n  cluster_suggestions: firstItem.cluster_suggestions || [],\\n  keywords_found: keywordCount,\\n  ai_source: firstItem.ai_source || 'unknown'\\n};"},"id":"8758f7dd-18ab-4afe-a6c7-6b05c2414b68","name":"Code - Prepare Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,112]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"b529dac4-ee94-471f-9a8c-b9626e8472cb","name":"Respond - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,112]},{"parameters":{"jsCode":"// Keyword yoksa da response dndr\\nconst firstItem = $('Code - Split Keywords').first().json;\\n\\nreturn {\\n  success: true,\\n  message: 'Content Gap analizi tamamlandi ancak keyword onerisi bulunamadi.',\\n  project_id: firstItem.project_id,\\n  analysis_summary: firstItem.analysis_summary || 'Analiz yapildi ancak sonuc uretilemedi',\\n  keywords_found: 0,\\n  ai_source: firstItem.ai_source || 'unknown'\\n};"},"id":"3330d45d-08dd-4ca6-b5ad-7d93fa88deba","name":"Code - No Keywords Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,208]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"52d47cac-32e5-4db6-8eff-d06ffbd721d2","name":"Respond - No Keywords","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[224,208]}]	{"Webhook":{"main":[[{"node":"Code - Validate Input","type":"main","index":0}]]},"Code - Validate Input":{"main":[[{"node":"IF - Valid Input","type":"main","index":0}]]},"IF - Valid Input":{"main":[[{"node":"MySQL - Get Project","type":"main","index":0}],[{"node":"Respond - Validation Error","type":"main","index":0}]]},"MySQL - Get Project":{"main":[[{"node":"IF - Project Exists","type":"main","index":0}]]},"IF - Project Exists":{"main":[[{"node":"MySQL - Get System Settings","type":"main","index":0}],[{"node":"Respond - Not Found","type":"main","index":0}]]},"MySQL - Get System Settings":{"main":[[{"node":"MySQL - Get System Prompt","type":"main","index":0}]]},"MySQL - Get System Prompt":{"main":[[{"node":"MySQL - Get Competitors","type":"main","index":0}]]},"MySQL - Get Competitors":{"main":[[{"node":"MySQL - Get SERP Features","type":"main","index":0}]]},"MySQL - Get SERP Features":{"main":[[{"node":"MySQL - Get PAA","type":"main","index":0}]]},"MySQL - Get PAA":{"main":[[{"node":"Code - Prepare AI Prompt","type":"main","index":0}]]},"Code - Prepare AI Prompt":{"main":[[{"node":"Code - AI Analysis","type":"main","index":0}]]},"Code - AI Analysis":{"main":[[{"node":"MySQL - Log Token Usage","type":"main","index":0}]]},"MySQL - Log Token Usage":{"main":[[{"node":"Code - Split Keywords","type":"main","index":0}]]},"Code - Split Keywords":{"main":[[{"node":"IF - Has Keywords","type":"main","index":0}]]},"IF - Has Keywords":{"main":[[{"node":"MySQL - Save Keyword","type":"main","index":0}],[{"node":"Code - No Keywords Response","type":"main","index":0}]]},"MySQL - Save Keyword":{"main":[[{"node":"MySQL - Update Project","type":"main","index":0}]]},"MySQL - Update Project":{"main":[[{"node":"Code - Prepare Response","type":"main","index":0}]]},"Code - Prepare Response":{"main":[[{"node":"Respond - Success","type":"main","index":0}]]},"Code - No Keywords Response":{"main":[[{"node":"Respond - No Keywords","type":"main","index":0}]]}}	2025-12-17 10:28:51.007+00	2025-12-17 10:28:51.007+00	{"executionOrder":"v1"}	\N	{}	9c8edff5-626a-40e8-8897-5867882e1542	1	oCR2cQcwwClAsT55	{"templateCredsSetupCompleted":true}	\N	f	18	\N	9c8edff5-626a-40e8-8897-5867882e1542
WF-002 Client Prompts CRUD Operations	t	[{"parameters":{"path":"client-prompts/list/:clientId","responseMode":"responseNode","options":{}},"id":"88c0d94b-04a5-414c-98d0-294af8a21f87","name":"Webhook - List Prompts","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"client-prompts-list"},{"parameters":{"operation":"executeQuery","query":"=SELECT id, client_id, prompt_name, prompt_text, is_active, sort_order, created_at, updated_at FROM client_prompts WHERE client_id = {{ parseInt($json.params.clientId) || 0 }} ORDER BY sort_order ASC, created_at DESC","options":{}},"id":"2ce0a6e7-750f-4eee-b60a-9ccd8002d58e","name":"MySQL - List Prompts","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"data\\": {{ JSON.stringify($input.all().map(i => ({ ...i.json, is_active: i.json.is_active === 1 || i.json.is_active === true }))) }}\\n}","options":{}},"id":"fda9a8b6-ed13-4d40-a1e2-61a2b168c3f1","name":"Respond - List Prompts","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[448,0]},{"parameters":{"httpMethod":"POST","path":"client-prompts/create","responseMode":"responseNode","options":{}},"id":"0b14971a-9ab5-4dee-a35e-223eb2ac9b7a","name":"Webhook - Create Prompt","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,208],"webhookId":"client-prompts-create"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Check max prompts and prepare insert\\nconst body = $json.body || {};\\nconst clientId = parseInt(body.client_id);\\nconst promptName = body.prompt_name || '';\\nconst promptText = body.prompt_text || '';\\nconst isActive = body.is_active ? 1 : 0;\\n\\nif (!clientId || !promptName || !promptText) {\\n  return { json: { error: 'Missing required fields', valid: false } };\\n}\\n\\nreturn {\\n  json: {\\n    clientId,\\n    promptName,\\n    promptText,\\n    isActive,\\n    valid: true\\n  }\\n};"},"id":"c82122b4-97ec-4434-b296-8065c519b0ce","name":"Code - Validate Create","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"condition-valid","leftValue":"={{ $json.valid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"bfaacead-365d-4269-93f3-dfeb3fc968b4","name":"IF - Valid Create","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,208]},{"parameters":{"operation":"executeQuery","query":"=SELECT COUNT(*) as count FROM client_prompts WHERE client_id = {{ $json.clientId }}","options":{}},"id":"f944a9f0-1395-4228-9179-a7beb1e11404","name":"MySQL - Check Count","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,144],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Check if under limit and pass data\\nconst count = $json.count || 0;\\nconst MAX_PROMPTS = 10;\\nconst prevData = $('Code - Validate Create').item.json;\\n\\nif (count >= MAX_PROMPTS) {\\n  return { json: { error: `Maximum ${MAX_PROMPTS} prompts allowed`, canCreate: false } };\\n}\\n\\nreturn {\\n  json: {\\n    ...prevData,\\n    canCreate: true\\n  }\\n};"},"id":"b506fead-a686-43e0-81c5-f61c23e21584","name":"Code - Check Limit","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,144]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"condition-can-create","leftValue":"={{ $json.canCreate }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"c8f06eeb-4d30-4974-be4a-76132cf6fcd9","name":"IF - Can Create","type":"n8n-nodes-base.if","typeVersion":2,"position":[1104,144]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO client_prompts (client_id, prompt_name, prompt_text, is_active, sort_order) VALUES ({{ $json.clientId }}, {{ JSON.stringify($json.promptName) }}, {{ JSON.stringify($json.promptText) }}, {{ $json.isActive }}, (SELECT COALESCE(MAX(sort_order), 0) + 1 FROM client_prompts cp WHERE cp.client_id = {{ $json.clientId }}))","options":{}},"id":"5640a01f-aeea-43a4-adc8-aecc113491af","name":"MySQL - Create Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1328,80],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM client_prompts WHERE id = LAST_INSERT_ID()","options":{}},"id":"02c4798e-b277-4476-918d-eb8e0642d721","name":"MySQL - Get Created Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1552,80],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"data\\": {{ JSON.stringify({ ...$json, is_active: $json.is_active === 1 }) }},\\n  \\"message\\": \\"Prompt created successfully\\"\\n}","options":{}},"id":"e503506a-4ea6-418b-9b5c-d17a04da65da","name":"Respond - Create Prompt","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1760,80]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": {{ JSON.stringify($json.error || 'Cannot create prompt') }}\\n}","options":{"responseCode":400}},"id":"eeaf34f0-1971-4e06-9a5c-76278db11fe7","name":"Respond - Create Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1328,224]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": {{ JSON.stringify($json.error || 'Invalid request') }}\\n}","options":{"responseCode":400}},"id":"944b597c-5609-468a-9b15-232c4ec9817e","name":"Respond - Invalid Create","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,272]},{"parameters":{"httpMethod":"PUT","path":"client-prompts/update/:id","responseMode":"responseNode","options":{}},"id":"20a90231-ec57-424a-8517-9ee64c83625f","name":"Webhook - Update Prompt","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,400],"webhookId":"client-prompts-update"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Build update query\\nconst body = $json.body || {};\\nconst promptId = parseInt($json.params.id);\\n\\nif (!promptId) {\\n  return { json: { error: 'Invalid prompt ID', valid: false } };\\n}\\n\\nconst updates = [];\\nif (body.prompt_name !== undefined) {\\n  updates.push(`prompt_name = ${JSON.stringify(body.prompt_name)}`);\\n}\\nif (body.prompt_text !== undefined) {\\n  updates.push(`prompt_text = ${JSON.stringify(body.prompt_text)}`);\\n}\\nif (body.sort_order !== undefined) {\\n  updates.push(`sort_order = ${parseInt(body.sort_order)}`);\\n}\\n\\nif (updates.length === 0) {\\n  return { json: { error: 'No fields to update', valid: false } };\\n}\\n\\nupdates.push('updated_at = NOW()');\\n\\nreturn {\\n  json: {\\n    promptId,\\n    query: `UPDATE client_prompts SET ${updates.join(', ')} WHERE id = ${promptId}`,\\n    valid: true\\n  }\\n};"},"id":"7df229a9-c7ad-4322-a6f3-5855d71f57d1","name":"Code - Build Update Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,400]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"condition-valid-update","leftValue":"={{ $json.valid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"e572515f-4654-40dc-ab59-71b75a9c6fb5","name":"IF - Valid Update","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,400]},{"parameters":{"operation":"executeQuery","query":"={{ $json.query }}","options":{}},"id":"47c53399-6153-478a-99dd-bbaceb117975","name":"MySQL - Update Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,352],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT * FROM client_prompts WHERE id = {{ $('Code - Build Update Prompt').item.json.promptId }}","options":{}},"id":"92c92f4f-b0e5-4507-aa86-cef292dfb87e","name":"MySQL - Get Updated Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[880,352],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": {{ $json.id ? true : false }},\\n  \\"data\\": {{ $json.id ? JSON.stringify({ ...$json, is_active: $json.is_active === 1 }) : 'null' }},\\n  \\"message\\": {{ $json.id ? '\\"Prompt updated successfully\\"' : '\\"Prompt not found\\"' }}\\n}","options":{}},"id":"0acaa8d6-6c16-4c87-a899-5889288cf9b5","name":"Respond - Update Prompt","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1104,352]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": {{ JSON.stringify($json.error || 'Invalid request') }}\\n}","options":{"responseCode":400}},"id":"874f2b7a-3622-4303-9814-f712818aa7c9","name":"Respond - Invalid Update","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,464]},{"parameters":{"httpMethod":"DELETE","path":"client-prompts/delete/:id","responseMode":"responseNode","options":{}},"id":"8ca18cdf-114c-4762-8aec-0f83bbfb28a7","name":"Webhook - Delete Prompt","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,608],"webhookId":"client-prompts-delete"},{"parameters":{"operation":"executeQuery","query":"=DELETE FROM client_prompts WHERE id = {{ parseInt($json.params.id) || 0 }}","options":{}},"id":"635f4a47-4df0-4f1c-a440-33c750fc3bc9","name":"MySQL - Delete Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,608],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"message\\": \\"Prompt deleted successfully\\"\\n}","options":{}},"id":"83f9accc-cc32-4623-92fd-2ada0ea91ee4","name":"Respond - Delete Prompt","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[448,608]},{"parameters":{"httpMethod":"PUT","path":"client-prompts/set-active/:id","responseMode":"responseNode","options":{}},"id":"a3dfcd2d-b913-45ae-88a5-b469e646633b","name":"Webhook - Set Active","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,800],"webhookId":"client-prompts-set-active"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Get prompt ID and client ID\\nconst promptId = parseInt($json.params.id);\\nconst clientId = parseInt($json.body?.client_id);\\n\\nif (!promptId || !clientId) {\\n  return { json: { error: 'Invalid prompt or client ID', valid: false } };\\n}\\n\\nreturn {\\n  json: {\\n    promptId,\\n    clientId,\\n    valid: true\\n  }\\n};"},"id":"60935498-8613-47af-af01-9ee30c608556","name":"Code - Validate Set Active","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,800]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"condition-valid-set-active","leftValue":"={{ $json.valid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"0321e8ba-dc05-47ac-a757-ad25b9610d27","name":"IF - Valid Set Active","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,800]},{"parameters":{"operation":"executeQuery","query":"=UPDATE client_prompts SET is_active = 0 WHERE client_id = {{ $json.clientId }}","options":{}},"id":"59e27938-d4c9-4edd-9b4c-181196cbea7d","name":"MySQL - Deactivate All","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,752],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=UPDATE client_prompts SET is_active = 1, updated_at = NOW() WHERE id = {{ $('Code - Validate Set Active').item.json.promptId }}","options":{}},"id":"0be9af16-4fcd-48a5-9d9d-6c4e5ce806c7","name":"MySQL - Activate One","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[880,752],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"message\\": \\"Active prompt updated successfully\\"\\n}","options":{}},"id":"f2566456-fd37-43bb-a49d-f75149d01078","name":"Respond - Set Active","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1104,752]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": {{ JSON.stringify($json.error || 'Invalid request') }}\\n}","options":{"responseCode":400}},"id":"123f1d45-e804-4c94-9500-034dadd696dc","name":"Respond - Invalid Set Active","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,864]},{"parameters":{"path":"client-prompts/active/:clientId","responseMode":"responseNode","options":{}},"id":"d6db08a9-9256-43a1-8314-b23de054f5f6","name":"Webhook - Get Active Prompt","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,1008],"webhookId":"client-prompts-get-active"},{"parameters":{"operation":"executeQuery","query":"=SELECT id, client_id, prompt_name, prompt_text, is_active, sort_order, created_at, updated_at FROM client_prompts WHERE client_id = {{ parseInt($json.params.clientId) || 0 }} AND is_active = 1 LIMIT 1","options":{}},"id":"51e3a91f-a417-4562-94af-093973cd2679","name":"MySQL - Get Active Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,1008],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": {{ $json.id ? true : false }},\\n  \\"data\\": {{ $json.id ? JSON.stringify({ ...$json, is_active: true }) : 'null' }},\\n  \\"message\\": {{ $json.id ? '\\"Active prompt found\\"' : '\\"No active prompt found\\"' }}\\n}","options":{}},"id":"25a79964-905b-4a22-83a5-fdb3b5f5ea8f","name":"Respond - Get Active","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[448,1008]}]	{"Webhook - List Prompts":{"main":[[{"node":"MySQL - List Prompts","type":"main","index":0}]]},"MySQL - List Prompts":{"main":[[{"node":"Respond - List Prompts","type":"main","index":0}]]},"Webhook - Create Prompt":{"main":[[{"node":"Code - Validate Create","type":"main","index":0}]]},"Code - Validate Create":{"main":[[{"node":"IF - Valid Create","type":"main","index":0}]]},"IF - Valid Create":{"main":[[{"node":"MySQL - Check Count","type":"main","index":0}],[{"node":"Respond - Invalid Create","type":"main","index":0}]]},"MySQL - Check Count":{"main":[[{"node":"Code - Check Limit","type":"main","index":0}]]},"Code - Check Limit":{"main":[[{"node":"IF - Can Create","type":"main","index":0}]]},"IF - Can Create":{"main":[[{"node":"MySQL - Create Prompt","type":"main","index":0}],[{"node":"Respond - Create Error","type":"main","index":0}]]},"MySQL - Create Prompt":{"main":[[{"node":"MySQL - Get Created Prompt","type":"main","index":0}]]},"MySQL - Get Created Prompt":{"main":[[{"node":"Respond - Create Prompt","type":"main","index":0}]]},"Webhook - Update Prompt":{"main":[[{"node":"Code - Build Update Prompt","type":"main","index":0}]]},"Code - Build Update Prompt":{"main":[[{"node":"IF - Valid Update","type":"main","index":0}]]},"IF - Valid Update":{"main":[[{"node":"MySQL - Update Prompt","type":"main","index":0}],[{"node":"Respond - Invalid Update","type":"main","index":0}]]},"MySQL - Update Prompt":{"main":[[{"node":"MySQL - Get Updated Prompt","type":"main","index":0}]]},"MySQL - Get Updated Prompt":{"main":[[{"node":"Respond - Update Prompt","type":"main","index":0}]]},"Webhook - Delete Prompt":{"main":[[{"node":"MySQL - Delete Prompt","type":"main","index":0}]]},"MySQL - Delete Prompt":{"main":[[{"node":"Respond - Delete Prompt","type":"main","index":0}]]},"Webhook - Set Active":{"main":[[{"node":"Code - Validate Set Active","type":"main","index":0}]]},"Code - Validate Set Active":{"main":[[{"node":"IF - Valid Set Active","type":"main","index":0}]]},"IF - Valid Set Active":{"main":[[{"node":"MySQL - Deactivate All","type":"main","index":0}],[{"node":"Respond - Invalid Set Active","type":"main","index":0}]]},"MySQL - Deactivate All":{"main":[[{"node":"MySQL - Activate One","type":"main","index":0}]]},"MySQL - Activate One":{"main":[[{"node":"Respond - Set Active","type":"main","index":0}]]},"Webhook - Get Active Prompt":{"main":[[{"node":"MySQL - Get Active Prompt","type":"main","index":0}]]},"MySQL - Get Active Prompt":{"main":[[{"node":"Respond - Get Active","type":"main","index":0}]]}}	2025-12-17 10:26:21.495+00	2025-12-17 10:26:21.495+00	{"executionOrder":"v1"}	\N	{}	b9b1ad43-9b8a-43d5-8c9f-05adc54db544	6	WpQy66Cn5XTG9pFD	{"templateCredsSetupCompleted":true}	\N	f	18	\N	b9b1ad43-9b8a-43d5-8c9f-05adc54db544
Test Workflow	f	[]	{}	2025-12-17 10:16:28.7+00	2025-12-21 10:58:15.991+00	{"callerPolicy":"workflowsFromSameOwner","availableInMCP":false}	\N	\N	a26989bc-baf1-4d58-829d-1f7c0a6cd9b2	0	askirexPIC3sUVXx	\N	\N	t	2	\N	\N
WF-101a: Keyword Discovery	t	[{"parameters":{"httpMethod":"POST","path":"keyword-discovery","responseMode":"responseNode","options":{}},"id":"b2b4e892-1ac3-45d3-afcd-bdb1161f2456","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-2864,208],"webhookId":"tool1-keyword-discovery"},{"parameters":{"jsCode":"// Input Validation\\nconst body = $json.body || {};\\nconst projectId = body.project_id;\\n\\nif (!projectId) {\\n  return [{ json: { isValid: false, error: 'project_id is required in request body', errorCode: 400 } }];\\n}\\n\\nconst parsedId = parseInt(projectId);\\nif (isNaN(parsedId) || parsedId <= 0) {\\n  return [{ json: { isValid: false, error: 'project_id must be a positive integer', errorCode: 400 } }];\\n}\\n\\nreturn [{ json: { isValid: true, projectId: parsedId } }];"},"id":"f2737230-d51b-43a2-b0f2-11c6fe10a132","name":"Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2640,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"9da40a40-425b-4612-aa92-78a65c3b6a64","name":"IF Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-2416,208]},{"parameters":{"respondWith":"json","responseBody":"={ \\"success\\": false, \\"error\\": \\"{{ $json.error }}\\" }","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"d82fbb0e-a12e-470b-add8-1576860d8b37","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-2208,352]},{"parameters":{"operation":"executeQuery","query":"SELECT \\n  (SELECT id FROM keyword_projects WHERE id = {{ $json.projectId }}) as project_id,\\n  (SELECT client_id FROM keyword_projects WHERE id = {{ $json.projectId }}) as client_id,\\n  (SELECT main_keyword FROM keyword_projects WHERE id = {{ $json.projectId }}) as main_keyword,\\n  (SELECT scenario_type FROM keyword_projects WHERE id = {{ $json.projectId }}) as scenario_type,\\n  (SELECT target_country FROM keyword_projects WHERE id = {{ $json.projectId }}) as target_country,\\n  (SELECT target_language FROM keyword_projects WHERE id = {{ $json.projectId }}) as target_language,\\n  (SELECT c.name FROM keyword_projects kp JOIN clients c ON c.id = kp.client_id WHERE kp.id = {{ $json.projectId }}) as client_name,\\n  (SELECT c.domain FROM keyword_projects kp JOIN clients c ON c.id = kp.client_id WHERE kp.id = {{ $json.projectId }}) as client_domain,\\n  COALESCE((SELECT cc.enable_google_suggest FROM keyword_projects kp LEFT JOIN client_configurations cc ON cc.client_id = kp.client_id WHERE kp.id = {{ $json.projectId }}), 1) as enable_google_suggest,\\n  COALESCE((SELECT cc.enable_google_trends FROM keyword_projects kp LEFT JOIN client_configurations cc ON cc.client_id = kp.client_id WHERE kp.id = {{ $json.projectId }}), 1) as enable_google_trends,\\n  COALESCE((SELECT cc.enable_ahrefs_api FROM keyword_projects kp LEFT JOIN client_configurations cc ON cc.client_id = kp.client_id WHERE kp.id = {{ $json.projectId }}), 0) as enable_ahrefs_api,\\n  COALESCE((SELECT cc.enable_ai_analysis FROM keyword_projects kp LEFT JOIN client_configurations cc ON cc.client_id = kp.client_id WHERE kp.id = {{ $json.projectId }}), 1) as enable_ai_analysis,\\n  (SELECT cc.ai_model_preference FROM keyword_projects kp LEFT JOIN client_configurations cc ON cc.client_id = kp.client_id WHERE kp.id = {{ $json.projectId }}) as client_ai_model,\\n  (SELECT cc.ai_temperature FROM keyword_projects kp LEFT JOIN client_configurations cc ON cc.client_id = kp.client_id WHERE kp.id = {{ $json.projectId }}) as client_ai_temperature,\\n  (SELECT setting_value FROM system_settings WHERE setting_key = 'default_ai_model') as default_ai_model,\\n  (SELECT setting_value FROM system_settings WHERE setting_key = 'default_ai_temperature') as default_ai_temp,\\n  (SELECT prompt_text FROM system_prompts WHERE slug = 'keyword-discovery' AND is_active = 1 LIMIT 1) as system_prompt","options":{}},"id":"41ad1556-f87b-4e8b-b2a1-32ce02416949","name":"Get Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-2208,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Resolve Config\\nconst items = $input.all();\\nif (items.length === 0 || !items[0].json.project_id) {\\n  return [{ json: { project_exists: false } }];\\n}\\n\\nconst d = items[0].json;\\nconst aiModel = d.client_ai_model || d.default_ai_model || 'gemini-2.0-flash';\\nconst aiTemp = d.client_ai_temperature ?? (d.default_ai_temp ? parseFloat(d.default_ai_temp) : 0.7);\\n\\nlet aiProvider = 'google';\\nif (aiModel.includes('gpt')) aiProvider = 'openai';\\nelse if (aiModel.includes('claude')) aiProvider = 'anthropic';\\n\\n// Build AI prompt from system_prompt template\\nlet aiPrompt = d.system_prompt || 'Ana keyword: {{main_keyword}} iin 15-25 anahtar kelime ner. Sadece virglle ayrarak listele.';\\naiPrompt = aiPrompt\\n  .replace(/\\\\{\\\\{main_keyword\\\\}\\\\}/g, d.main_keyword || '')\\n  .replace(/\\\\{\\\\{target_country\\\\}\\\\}/g, (d.target_country || 'TR').toUpperCase())\\n  .replace(/\\\\{\\\\{target_language\\\\}\\\\}/g, d.target_language || 'Trke');\\n\\nreturn [{\\n  json: {\\n    project_exists: true,\\n    project_id: d.project_id,\\n    client_id: d.client_id,\\n    client_name: d.client_name,\\n    main_keyword: d.main_keyword,\\n    scenario_type: d.scenario_type,\\n    target_country: (d.target_country || 'TR').toLowerCase(),\\n    target_language: d.target_language || 'tr',\\n    // Data source flags\\n    enable_google_suggest: d.enable_google_suggest == 1,\\n    enable_google_trends: d.enable_google_trends == 1,\\n    enable_ahrefs_api: d.enable_ahrefs_api == 1,\\n    enable_ai_analysis: d.enable_ai_analysis == 1,\\n    // AI Config\\n    ai_model: aiModel,\\n    ai_temperature: aiTemp,\\n    ai_provider: aiProvider,\\n    ai_prompt: aiPrompt\\n  }\\n}];"},"id":"5d252d8c-3f11-478a-a8f9-46c48561a455","name":"Resolve Config","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1984,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"exists","leftValue":"={{ $json.project_exists }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"2ba40692-c7f9-44ed-afe8-e564cd43031d","name":"IF Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1760,208]},{"parameters":{"respondWith":"json","responseBody":"{ \\"success\\": false, \\"error\\": \\"Project not found\\" }","options":{"responseCode":404}},"id":"33fbf438-4da1-4caa-88b2-687ecd835134","name":"Respond 404","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-1536,352]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.scenario_type }}","rightValue":"seed_keyword","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"seed_keyword"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.scenario_type }}","rightValue":"topic_based","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"topic_based"}]},"options":{}},"id":"c05afccc-a84a-47db-af88-c34250d3f989","name":"Switch Scenario","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-1536,208]},{"parameters":{"jsCode":"// Seed Keyword: Dorudan ana keyword' kullan\\nconst config = $json;\\nreturn [{\\n  json: {\\n    ...config,\\n    search_keywords: [config.main_keyword],\\n    keyword_source: 'seed_keyword'\\n  }\\n}];"},"id":"320cf454-c667-4166-a391-e117dae15ab1","name":"Prepare Seed","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1328,112]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{\\n    \\"parts\\": [{\\n      \\"text\\": {{ JSON.stringify($json.ai_prompt) }}\\n    }]\\n  }],\\n  \\"generationConfig\\": { \\"temperature\\": {{ $json.ai_temperature }}, \\"maxOutputTokens\\": 500 }\\n}","options":{"timeout":30000}},"id":"93271cad-1353-4a23-8168-455b39957564","name":"AI Extract Keywords","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1328,304],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}}},{"parameters":{"jsCode":"// Parse Gemini response\\nconst config = $('Resolve Config').first().json;\\nconst response = $input.first().json;\\n\\nlet keywords = [];\\ntry {\\n  const text = response.candidates[0].content.parts[0].text;\\n  keywords = text.split(/[,\\\\n]/).map(k => k.trim().toLowerCase()).filter(k => k.length > 2 && k.length < 80);\\n} catch (e) {\\n  keywords = [config.main_keyword.toLowerCase()];\\n}\\n\\n// Main keyword' de ekle\\nif (!keywords.includes(config.main_keyword.toLowerCase())) {\\n  keywords.unshift(config.main_keyword.toLowerCase());\\n}\\n\\nreturn [{\\n  json: {\\n    ...config,\\n    search_keywords: keywords.slice(0, 15),\\n    keyword_source: 'topic_based'\\n  }\\n}];"},"id":"3eeefcf9-e3eb-43f3-b700-c2380d2adfcf","name":"Parse AI Keywords","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1104,304]},{"parameters":{"jsCode":"// Config'i sakla ve keyword'leri ayr item'lara bl\\nconst config = $json;\\nconst keywords = config.search_keywords || [config.main_keyword];\\n\\n// Max 5 keyword iin item olutur\\nreturn keywords.slice(0, 5).map(kw => ({\\n  json: {\\n    config: config,\\n    search_keyword: kw,\\n    suggest_url: `http://suggestqueries.google.com/complete/search?client=firefox&q=${encodeURIComponent(kw)}&hl=${config.target_language || 'tr'}&gl=${config.target_country || 'tr'}`\\n  }\\n}));"},"id":"5457e6cb-9e20-4847-abbb-f6ed12aa14ba","name":"Split Keywords","type":"n8n-nodes-base.code","typeVersion":2,"position":[-768,112]},{"parameters":{"url":"={{ $json.suggest_url }}","options":{"response":{"response":{"responseFormat":"json"}},"timeout":10000}},"id":"a5182841-f304-4d05-83fc-65fd042c7a40","name":"HTTP Google Suggest","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-544,112],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Tm suggest sonularn birletir\\nconst items = $input.all();\\nconst splitItems = $('Split Keywords').all();\\nlet config = splitItems[0]?.json?.config || null;\\nconst allSuggestions = [];\\n\\nfor (let i = 0; i < items.length; i++) {\\n  const item = items[i];\\n  const splitItem = splitItems[i];\\n  const parentKeyword = splitItem?.json?.search_keyword || '';\\n  \\n  // HTTP Response - handle both JSON and text formats\\n  let suggestions = [];\\n  try {\\n    let responseData = item.json.data || item.json;\\n    \\n    // If it's a string, parse as JSON\\n    if (typeof responseData === 'string') {\\n      responseData = JSON.parse(responseData);\\n    }\\n    \\n    // Google Suggest format: [query, [suggestions], [], {}]\\n    if (Array.isArray(responseData) && Array.isArray(responseData[1])) {\\n      suggestions = responseData[1];\\n    }\\n  } catch (e) {\\n    // Parse error, skip\\n    console.log('Parse error for suggestion:', e.message);\\n  }\\n  \\n  suggestions.forEach(suggestion => {\\n    // Ensure proper string handling\\n    const cleanSuggestion = String(suggestion).trim();\\n    if (cleanSuggestion && cleanSuggestion !== parentKeyword && config) {\\n      allSuggestions.push({\\n        project_id: config.project_id,\\n        keyword: cleanSuggestion,\\n        keyword_type: 'google_suggest',\\n        search_volume: null,\\n        keyword_difficulty: null,\\n        cpc: null,\\n        search_intent: null,\\n        trend_direction: 'stable',\\n        parent_topic: parentKeyword,\\n        source: 'google_suggest'\\n      });\\n    }\\n  });\\n}\\n\\nreturn [{ json: { ...config, google_suggest_keywords: allSuggestions } }];"},"id":"2d128f8f-1b66-4741-b57c-a0eb57cb82be","name":"Merge Suggest","type":"n8n-nodes-base.code","typeVersion":2,"position":[-320,112]},{"parameters":{"jsCode":"// ============================================\\n// Google Trends Data (cretsiz)\\n// Related queries ve rising topics\\n// ============================================\\n\\nconst config = $json;\\nconst mainKeyword = config.main_keyword;\\nconst country = config.target_country || 'TR';\\n\\n// Google Trends embed API'den related queries ek\\nconst trendKeywords = [];\\n\\ntry {\\n  // Trends Explore URL'den related topics ekilebilir\\n  // Not: Gerek implementasyonda SerpAPI veya unofficial trends API kullanlabilir\\n  \\n  // imdilik trend-based keyword pattern'ler olutur\\n  const trendPatterns = [\\n    `${mainKeyword} 2024`,\\n    `${mainKeyword} 2025`,\\n    `en iyi ${mainKeyword}`,\\n    `${mainKeyword} nerileri`,\\n    `${mainKeyword} karlatrma`,\\n    `${mainKeyword} yorumlar`,\\n    `${mainKeyword} fiyat`,\\n    `ucuz ${mainKeyword}`,\\n    `${mainKeyword} nasl`,\\n    `${mainKeyword} nedir`\\n  ];\\n  \\n  trendPatterns.forEach(kw => {\\n    trendKeywords.push({\\n      project_id: config.project_id,\\n      keyword: kw.toLowerCase(),\\n      keyword_type: 'trend_based',\\n      search_volume: null,\\n      keyword_difficulty: null,\\n      cpc: null,\\n      search_intent: kw.includes('fiyat') || kw.includes('ucuz') ? 'commercial' : 'informational',\\n      trend_direction: 'up',\\n      parent_topic: mainKeyword,\\n      source: 'google_trends'\\n    });\\n  });\\n} catch (e) {\\n  // Skip on error\\n}\\n\\nreturn [{ json: { ...config, google_trends_keywords: trendKeywords } }];"},"id":"9b227a74-a47d-4581-8852-05d4218a910f","name":"Google Trends","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"ahrefs","leftValue":"={{ $json.enable_ahrefs_api }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"ff136ca1-01cd-4167-a5d6-ee55a3e25d34","name":"IF Ahrefs Enabled","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"method":"POST","url":"https://api.ahrefs.com/v3/keywords-explorer/keyword-ideas","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"country\\": \\"{{ $json.target_country }}\\",\\n  \\"keywords\\": {{ JSON.stringify($json.search_keywords.slice(0, 3)) }},\\n  \\"mode\\": \\"phrase_match\\",\\n  \\"limit\\": 50\\n}","options":{"timeout":60000}},"id":"9fa195e4-755e-4b6d-99fb-b2b0b8476ab1","name":"Ahrefs Keywords","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,0],"credentials":{"httpHeaderAuth":{"id":"01zZGrP0Fob8kD8r","name":"Serper API"}}},{"parameters":{"jsCode":"// Parse Ahrefs response\\nconst config = $('IF Ahrefs Enabled').first().json;\\nconst ahrefsData = $input.first().json;\\nconst keywords = ahrefsData.keywords || [];\\n\\nconst ahrefsKeywords = keywords.map(kw => ({\\n  project_id: config.project_id,\\n  keyword: kw.keyword || '',\\n  keyword_type: 'ahrefs',\\n  search_volume: kw.volume || null,\\n  keyword_difficulty: kw.keyword_difficulty || kw.difficulty || null,\\n  cpc: kw.cpc || null,\\n  search_intent: null,\\n  trend_direction: 'stable',\\n  parent_topic: config.main_keyword,\\n  source: 'ahrefs'\\n}));\\n\\nreturn [{ json: { ...config, ahrefs_keywords: ahrefsKeywords } }];"},"id":"fa34d765-d76e-4c3c-bae4-0b3bf4ab3987","name":"Parse Ahrefs","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"jsCode":"// Ahrefs disabled - bo array dndr\\nconst config = $json;\\nreturn [{ json: { ...config, ahrefs_keywords: [] } }];"},"id":"b254b5eb-a484-4fb1-8611-83ff0a9a95d3","name":"No Ahrefs","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,208]},{"parameters":{"jsCode":"// ============================================\\n// Tm keyword'leri birletir ve tekilletir\\n// ============================================\\n\\nconst items = $input.all();\\nconst config = items[0].json;\\n\\n// Tm kaynaklardan keyword'leri topla\\nconst allKeywords = [];\\n\\n// 1. Primary keyword ekle\\nallKeywords.push({\\n  project_id: config.project_id,\\n  keyword: config.main_keyword.toLowerCase(),\\n  keyword_type: 'primary',\\n  search_volume: null,\\n  keyword_difficulty: null,\\n  cpc: null,\\n  search_intent: null,\\n  trend_direction: 'stable',\\n  parent_topic: null,\\n  source: 'manual'\\n});\\n\\n// 2. Google Suggest keywords\\nif (config.google_suggest_keywords) {\\n  allKeywords.push(...config.google_suggest_keywords);\\n}\\n\\n// 3. Google Trends keywords\\nif (config.google_trends_keywords) {\\n  allKeywords.push(...config.google_trends_keywords);\\n}\\n\\n// 4. Ahrefs keywords\\nif (config.ahrefs_keywords) {\\n  allKeywords.push(...config.ahrefs_keywords);\\n}\\n\\n// Tekilletir (keyword baznda)\\nconst seen = new Set();\\nconst uniqueKeywords = allKeywords.filter(kw => {\\n  const key = kw.keyword.toLowerCase().trim();\\n  if (seen.has(key) || key.length < 2) return false;\\n  seen.add(key);\\n  return true;\\n});\\n\\n// Her keyword iin ayr item dndr\\nreturn uniqueKeywords.map(kw => ({ json: kw }));"},"id":"56c9274d-743c-4c90-8ad3-703c19c377f7","name":"Merge & Dedupe","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,160]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO keyword_results \\n  (project_id, keyword, keyword_type, search_volume, keyword_difficulty, cpc, search_intent, trend_direction, parent_topic, source)\\nVALUES \\n  ({{ $json.project_id }}, '{{ $json.keyword.replace(/'/g, \\"''\\") }}', '{{ $json.keyword_type }}', {{ $json.search_volume || 'NULL' }}, {{ $json.keyword_difficulty || 'NULL' }}, {{ $json.cpc || 'NULL' }}, {{ $json.search_intent ? \\"'\\" + $json.search_intent + \\"'\\" : 'NULL' }}, '{{ $json.trend_direction }}', {{ $json.parent_topic ? \\"'\\" + $json.parent_topic.replace(/'/g, \\"''\\") + \\"'\\" : 'NULL' }}, '{{ $json.source }}')\\nON DUPLICATE KEY UPDATE\\n  search_volume = COALESCE(VALUES(search_volume), search_volume),\\n  keyword_difficulty = COALESCE(VALUES(keyword_difficulty), keyword_difficulty),\\n  source = CONCAT_WS(',', source, VALUES(source))","options":{}},"id":"022fb942-0dd1-4a87-9183-21414c480080","name":"Save Keywords","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,160],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"UPDATE keyword_projects SET\\n  total_keywords_found = (SELECT COUNT(*) FROM keyword_results WHERE project_id = {{ $('Resolve Config').first().json.project_id }}),\\n  status = 'keywords_discovered',\\n  api_source = 'multi_source'\\nWHERE id = {{ $('Resolve Config').first().json.project_id }}","options":{}},"id":"579a8f1f-6aaf-48dc-9391-58935f76600e","name":"Update Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[880,160],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"const config = $('Resolve Config').first().json;\\nconst mergeDedupeItems = $('Merge & Dedupe').all();\\n\\n// Kaynak saylarn hesapla\\nconst sources = {};\\nmergeDedupeItems.forEach(item => {\\n  const src = item.json.source || 'unknown';\\n  sources[src] = (sources[src] || 0) + 1;\\n});\\n\\nreturn {\\n  json: {\\n    success: true,\\n    data: {\\n      project_id: config.project_id,\\n      client_name: config.client_name,\\n      main_keyword: config.main_keyword,\\n      scenario_type: config.scenario_type,\\n      keywords_found: mergeDedupeItems.length,\\n      sources_used: {\\n        google_suggest: config.enable_google_suggest,\\n        google_trends: config.enable_google_trends,\\n        ahrefs: config.enable_ahrefs_api\\n      },\\n      keywords_by_source: sources,\\n      ai_config: {\\n        model: config.ai_model,\\n        provider: config.ai_provider\\n      }\\n    },\\n    next_step: 'WF-101b: Keyword Filter'\\n  }\\n};"},"id":"abf7dc30-7dde-4d7b-96eb-1aeb7c9c9c00","name":"Prepare Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,160]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"1470ce31-1f4b-4d5f-8946-aa4e28bb6e8d","name":"Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1328,160]}]	{"Webhook":{"main":[[{"node":"Validate Input","type":"main","index":0}]]},"Validate Input":{"main":[[{"node":"IF Valid","type":"main","index":0}]]},"IF Valid":{"main":[[{"node":"Get Project","type":"main","index":0}],[{"node":"Respond Error","type":"main","index":0}]]},"Get Project":{"main":[[{"node":"Resolve Config","type":"main","index":0}]]},"Resolve Config":{"main":[[{"node":"IF Exists","type":"main","index":0}]]},"IF Exists":{"main":[[{"node":"Switch Scenario","type":"main","index":0}],[{"node":"Respond 404","type":"main","index":0}]]},"Switch Scenario":{"main":[[{"node":"Prepare Seed","type":"main","index":0}],[{"node":"AI Extract Keywords","type":"main","index":0}]]},"Prepare Seed":{"main":[[{"node":"Split Keywords","type":"main","index":0}]]},"AI Extract Keywords":{"main":[[{"node":"Parse AI Keywords","type":"main","index":0}]]},"Parse AI Keywords":{"main":[[{"node":"Split Keywords","type":"main","index":0}]]},"Split Keywords":{"main":[[{"node":"HTTP Google Suggest","type":"main","index":0}]]},"HTTP Google Suggest":{"main":[[{"node":"Merge Suggest","type":"main","index":0}]]},"Merge Suggest":{"main":[[{"node":"Google Trends","type":"main","index":0}]]},"Google Trends":{"main":[[{"node":"IF Ahrefs Enabled","type":"main","index":0}]]},"IF Ahrefs Enabled":{"main":[[{"node":"Ahrefs Keywords","type":"main","index":0}],[{"node":"No Ahrefs","type":"main","index":0}]]},"Ahrefs Keywords":{"main":[[{"node":"Parse Ahrefs","type":"main","index":0}]]},"Parse Ahrefs":{"main":[[{"node":"Merge & Dedupe","type":"main","index":0}]]},"No Ahrefs":{"main":[[{"node":"Merge & Dedupe","type":"main","index":0}]]},"Merge & Dedupe":{"main":[[{"node":"Save Keywords","type":"main","index":0}]]},"Save Keywords":{"main":[[{"node":"Update Project","type":"main","index":0}]]},"Update Project":{"main":[[{"node":"Prepare Response","type":"main","index":0}]]},"Prepare Response":{"main":[[{"node":"Success","type":"main","index":0}]]}}	2025-12-17 10:27:00.358+00	2025-12-17 10:27:00.358+00	{"executionOrder":"v1"}	\N	{}	90411821-db26-46ed-b5ca-3daf1a5ea8f5	1	yyD1QW0PcJgp3ik2	{"templateCredsSetupCompleted":true}	\N	f	18	\N	90411821-db26-46ed-b5ca-3daf1a5ea8f5
WF-102: Get Keyword Project	t	[{"parameters":{"path":"tool1/project/:id","responseMode":"responseNode","options":{}},"id":"910de8f9-e1b3-42fc-bf63-f189424c7f8b","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"tool1-project-get"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Input validation\\nconst id = $json.params?.id;\\n\\nif (!id) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'id parametresi zorunludur',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\n// Check if it's a numeric ID or UUID\\nconst isNumeric = /^\\\\d+$/.test(id);\\nconst isUUID = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(id);\\n\\nif (!isNumeric && !isUUID) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'id gecerli bir sayi veya UUID olmalidir',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nreturn {\\n  json: {\\n    isValid: true,\\n    id: id,\\n    isNumeric: isNumeric,\\n    isUUID: isUUID\\n  }\\n};"},"id":"282a0248-8ac0-47a3-85aa-290d64ee7aa9","name":"Code - Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"fcbe0035-aa68-4d63-936c-84d536ecf153","name":"IF - Valid Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,0]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Validation failed\\",\\n  \\"message\\": \\"{{ $json.error }}\\"\\n}","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"ec1a04c9-c9a4-4edb-bd7c-dc8032fb2301","name":"Respond - Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,160]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  (SELECT id FROM keyword_projects WHERE id = {{ $json.isNumeric ? $json.id : 0 }} OR uuid = '{{ $json.isUUID ? $json.id : '' }}' LIMIT 1) as project_id","options":{}},"id":"29e4692a-6833-4eb8-bc4c-d5469b78c57f","name":"MySQL - Check Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Check if project exists\\nconst result = $input.first().json;\\nconst validatedData = $('Code - Validate Input').first().json;\\n\\nif (!result.project_id) {\\n  return [{\\n    json: {\\n      projectExists: false,\\n      id: validatedData.id\\n    }\\n  }];\\n}\\n\\nreturn [{\\n  json: {\\n    projectExists: true,\\n    projectId: result.project_id\\n  }\\n}];"},"id":"60156490-2f66-4de0-8989-d88e5d7cda40","name":"Code - Check Exists","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,0]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"exists","leftValue":"={{ $json.projectExists }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"e90fbaf7-fbbe-408f-9561-cb69c41188ea","name":"IF - Project Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[1104,0]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Project not found\\",\\n  \\"message\\": \\"Proje bulunamadi: {{ $json.id }}\\"\\n}","options":{"responseCode":404}},"id":"37e17b05-8688-4138-ae33-227b5e5de105","name":"Respond - Not Found","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1328,160]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  kp.id,\\n  kp.uuid,\\n  kp.project_name,\\n  kp.main_keyword,\\n  kp.target_country,\\n  kp.target_language,\\n  kp.status,\\n  COALESCE(kp.total_keywords_found, (SELECT COUNT(*) FROM keyword_results WHERE project_id = kp.id)) as total_keywords_found,\\n  COALESCE(kp.total_competitors_analyzed, (SELECT COUNT(*) FROM competitor_data WHERE project_id = kp.id)) as total_competitors_analyzed,\\n  COALESCE(kp.total_paa_found, (SELECT COUNT(*) FROM paa_data WHERE project_id = kp.id)) as total_paa_found,\\n  kp.created_at,\\n  kp.updated_at,\\n  c.id as client_id,\\n  c.name as client_name,\\n  (SELECT COUNT(*) FROM keyword_results WHERE project_id = kp.id) as keyword_count,\\n  (SELECT COUNT(*) FROM keyword_results WHERE project_id = kp.id AND search_intent IS NOT NULL) as analyzed_count\\nFROM keyword_projects kp\\nLEFT JOIN clients c ON kp.client_id = c.id\\nWHERE kp.id = {{ $json.projectId }}","options":{}},"id":"ae385843-66cc-4b94-96c9-c7663fab30d7","name":"MySQL - Get Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1328,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Format response\\nconst project = $input.first().json;\\n\\nreturn [{\\n  json: {\\n    success: true,\\n    data: {\\n      id: project.id,\\n      uuid: project.uuid,\\n      project_name: project.project_name,\\n      main_keyword: project.main_keyword,\\n      target_country: project.target_country,\\n      target_language: project.target_language,\\n      status: project.status,\\n      total_keywords_found: project.total_keywords_found || 0,\\n      total_competitors_analyzed: project.total_competitors_analyzed || 0,\\n      total_paa_found: project.total_paa_found || 0,\\n      created_at: project.created_at,\\n      updated_at: project.updated_at,\\n      client: project.client_id ? {\\n        id: project.client_id,\\n        name: project.client_name\\n      } : null,\\n      stats: {\\n        keyword_count: parseInt(project.keyword_count) || 0,\\n        analyzed_count: parseInt(project.analyzed_count) || 0\\n      }\\n    }\\n  }\\n}];"},"id":"ee906cba-3a6a-4724-a6b6-9b62e8980422","name":"Code - Format Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1552,0]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"12bf68ef-fba1-4639-860f-481ad0285162","name":"Respond - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1760,0]}]	{"Webhook":{"main":[[{"node":"Code - Validate Input","type":"main","index":0}]]},"Code - Validate Input":{"main":[[{"node":"IF - Valid Input","type":"main","index":0}]]},"IF - Valid Input":{"main":[[{"node":"MySQL - Check Project","type":"main","index":0}],[{"node":"Respond - Validation Error","type":"main","index":0}]]},"MySQL - Check Project":{"main":[[{"node":"Code - Check Exists","type":"main","index":0}]]},"Code - Check Exists":{"main":[[{"node":"IF - Project Exists","type":"main","index":0}]]},"IF - Project Exists":{"main":[[{"node":"MySQL - Get Project","type":"main","index":0}],[{"node":"Respond - Not Found","type":"main","index":0}]]},"MySQL - Get Project":{"main":[[{"node":"Code - Format Response","type":"main","index":0}]]},"Code - Format Response":{"main":[[{"node":"Respond - Success","type":"main","index":0}]]}}	2025-12-17 10:27:50.264+00	2025-12-17 10:27:50.264+00	{"executionOrder":"v1"}	\N	{}	f0e64617-34fd-4f76-b5f5-07f41216e98e	1	yd6UhBrs7iqGeEg6	{"templateCredsSetupCompleted":true}	\N	f	18	\N	f0e64617-34fd-4f76-b5f5-07f41216e98e
WF-104: Competitor Analyzer	t	[{"parameters":{"httpMethod":"POST","path":":projectId/analyze-competitors","responseMode":"responseNode","options":{}},"id":"3634d046-f746-493c-b78e-110c3de66057","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-2272,208],"webhookId":"tool1-competitor-analyze"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Input validation\\nconst projectId = $json.params?.projectId;\\n\\nif (!projectId) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'projectId parametresi zorunludur',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nconst parsedId = parseInt(projectId);\\nif (isNaN(parsedId) || parsedId <= 0) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'projectId gecerli bir pozitif sayi olmalidir',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\n// Get competitor count from body (optional)\\nconst body = $json.body || {};\\nlet competitorCount = parseInt(body.competitor_count) || 10;\\ncompetitorCount = Math.min(Math.max(competitorCount, 3), 20); // 3-20 aras\\n\\nreturn {\\n  json: {\\n    isValid: true,\\n    projectId: parsedId,\\n    competitorCount: competitorCount\\n  }\\n};"},"id":"8543ca90-1481-4296-9ecf-3117c4e09f9b","name":"Code - Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2048,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"050f3b03-eae5-4773-bdb5-1ebbbceff914","name":"IF - Valid Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1824,208]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Validation failed\\",\\n  \\"message\\": \\"{{ $json.error }}\\"\\n}","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"3ac0f6a0-61d5-4f08-8961-a22321a3dc94","name":"Respond - Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-1600,400]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  (SELECT id FROM keyword_projects WHERE id = {{ $json.projectId }}) as project_id,\\n  (SELECT project_name FROM keyword_projects WHERE id = {{ $json.projectId }}) as project_name,\\n  (SELECT main_keyword FROM keyword_projects WHERE id = {{ $json.projectId }}) as main_keyword,\\n  (SELECT target_country FROM keyword_projects WHERE id = {{ $json.projectId }}) as target_country,\\n  (SELECT target_language FROM keyword_projects WHERE id = {{ $json.projectId }}) as target_language,\\n  (SELECT client_id FROM keyword_projects WHERE id = {{ $json.projectId }}) as client_id","options":{}},"id":"ca3f9907-6cb8-47a4-8c20-89d68f657572","name":"MySQL - Check Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1600,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Check if project exists\\nconst result = $input.first().json;\\nconst validatedData = $('Code - Validate Input').first().json;\\n\\nif (!result.project_id) {\\n  return [{\\n    json: {\\n      projectExists: false,\\n      projectId: validatedData.projectId\\n    }\\n  }];\\n}\\n\\nreturn [{\\n  json: {\\n    projectExists: true,\\n    projectId: result.project_id,\\n    projectName: result.project_name,\\n    mainKeyword: result.main_keyword,\\n    targetCountry: result.target_country || 'tr',\\n    targetLanguage: result.target_language || 'tr',\\n    clientId: result.client_id,\\n    competitorCount: validatedData.competitorCount\\n  }\\n}];"},"id":"a4aa5ed6-ea57-4a9d-b2bf-72ac3a8dc38e","name":"Code - Check Project","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1392,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"project-exists","leftValue":"={{ $json.projectExists }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"7499e34d-c041-4e92-9422-7a5cb4aed508","name":"IF - Project Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1168,208]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Project not found\\",\\n  \\"message\\": \\"Proje bulunamadi: {{ $json.projectId }}\\"\\n}","options":{"responseCode":404}},"id":"be6b076e-902e-42f4-8201-d173299dc8e2","name":"Respond - Not Found","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-944,400]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  COALESCE(cc.enable_ahrefs_api, 0) as enable_ahrefs_api,\\n  COALESCE(cc.enable_serper_api, 1) as enable_serper_api,\\n  COALESCE(cc.competitor_count, 10) as competitor_count\\nFROM clients c\\nLEFT JOIN client_configurations cc ON c.id = cc.client_id\\nWHERE c.id = {{ $json.clientId }}","options":{}},"id":"20c08b14-d745-40cc-9904-98c3ace62b05","name":"MySQL - Get Client Config","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-944,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Determine which API to use\\nconst config = $input.first().json;\\nconst projectData = $('IF - Project Exists').first().json;\\n\\n// Priority: Ahrefs > Serper > Mock\\nlet apiSource = 'mock';\\nif (config.enable_ahrefs_api === 1) {\\n  apiSource = 'ahrefs';\\n} else if (config.enable_serper_api === 1) {\\n  apiSource = 'serper';\\n}\\n\\nreturn [{\\n  json: {\\n    ...projectData,\\n    apiSource: apiSource,\\n    competitorCount: projectData.competitorCount || config.competitor_count || 10\\n  }\\n}];"},"id":"09c9510a-23ad-40c4-ba05-0900914d11c5","name":"Code - Determine API Source","type":"n8n-nodes-base.code","typeVersion":2,"position":[-720,208]},{"parameters":{"operation":"executeQuery","query":"=UPDATE keyword_projects SET status = 'processing' WHERE id = {{ $json.projectId }}","options":{}},"id":"73017083-c5d8-4a09-bd6b-305a477c0b5e","name":"MySQL - Update Status","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-512,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $json.apiSource }}","rightValue":"ahrefs","operator":{"type":"string","operation":"equals"},"id":"0a75c2c1-b101-4b8b-b03f-c6d2cfc8fdf1"}],"combinator":"and"},"renameOutput":true,"outputKey":"Ahrefs"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $json.apiSource }}","rightValue":"serper","operator":{"type":"string","operation":"equals"},"id":"38e8a40a-2671-40db-8f5b-5659d5c3aaaf"}],"combinator":"and"},"renameOutput":true,"outputKey":"Serper"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $json.apiSource }}","rightValue":"mock","operator":{"type":"string","operation":"equals"},"id":"e82ba37f-d3c2-45b8-a4c0-032e1bc6e13d"}],"combinator":"and"},"renameOutput":true,"outputKey":"Mock"}]},"options":{}},"id":"9ec60d6c-1cd9-4285-97b0-84bf8021bb4b","name":"Switch - API Source","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-288,208]},{"parameters":{"url":"https://api.ahrefs.com/v3/serp-overview/serp","sendQuery":true,"queryParameters":{"parameters":[{"name":"target","value":"={{ $('Code - Determine API Source').first().json.mainKeyword }}"},{"name":"country","value":"={{ $('Code - Determine API Source').first().json.targetCountry }}"},{"name":"limit","value":"={{ $('Code - Determine API Source').first().json.competitorCount }}"}]},"options":{}},"id":"356050ce-b078-4e2d-b794-348d72ad8da1","name":"HTTP - Ahrefs SERP","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,0],"continueOnFail":true},{"parameters":{"method":"POST","url":"https://google.serper.dev/search","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\"q\\": \\"{{ $json.mainKeyword }}\\", \\"gl\\": \\"{{ $json.targetCountry }}\\", \\"hl\\": \\"{{ $json.targetLanguage }}\\", \\"num\\": {{ $json.competitorCount }}}","options":{}},"id":"eb591b0e-b5cb-4088-b210-87f57179eab7","name":"HTTP - Serper SERP","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,208],"credentials":{"httpHeaderAuth":{"id":"01zZGrP0Fob8kD8r","name":"Serper API"}},"continueOnFail":true},{"parameters":{"jsCode":"// Generate mock SERP data for testing\\nconst projectData = $('Code - Determine API Source').first().json;\\nconst keyword = projectData.mainKeyword || 'test keyword';\\nconst count = projectData.competitorCount || 10;\\n\\nconst mockResults = [];\\nfor (let i = 1; i <= count; i++) {\\n  mockResults.push({\\n    position: i,\\n    url: `https://example${i}.com/${keyword.replace(/\\\\s+/g, '-')}`,\\n    domain: `example${i}.com`,\\n    title: `${keyword} - Ornek Baslik ${i}`,\\n    description: `${keyword} hakkinda detayli bilgi. Ornek aciklama ${i}.`,\\n    source: 'mock'\\n  });\\n}\\n\\nreturn [{ json: { organic: mockResults, source: 'mock' } }];"},"id":"96241def-a36b-48fd-b0e9-8819dfb21180","name":"Code - Mock SERP","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,400]},{"parameters":{"jsCode":"// Transform Ahrefs response to standard format\\nconst response = $input.first().json;\\nconst projectData = $('Code - Determine API Source').first().json;\\n\\n// Handle error\\nif (response.error || !response.serp) {\\n  return [{ json: { organic: [], source: 'ahrefs', error: response.error || 'No data' } }];\\n}\\n\\nconst positions = response.serp?.positions || response.positions || [];\\nconst organic = positions.map((pos, idx) => ({\\n  position: pos.position || idx + 1,\\n  url: pos.url || '',\\n  domain: pos.domain || '',\\n  title: pos.title || '',\\n  description: pos.description || '',\\n  domainRating: pos.domain_rating || pos.dr || null,\\n  backlinks: pos.backlinks || null,\\n  source: 'ahrefs'\\n}));\\n\\nreturn [{ json: { organic, source: 'ahrefs' } }];"},"id":"bbabc5fb-0a8e-4bbf-ae60-5da22650db43","name":"Code - Transform Ahrefs","type":"n8n-nodes-base.code","typeVersion":2,"position":[208,0]},{"parameters":{"jsCode":"// Transform Serper response to standard format\\nconst response = $input.first().json;\\n\\n// Handle error\\nif (response.error || !response.organic) {\\n  return [{ json: { organic: [], source: 'serper', error: response.error || 'No data' } }];\\n}\\n\\n// Extract domain from URL using regex\\nconst getDomain = (url) => {\\n  if (!url) return '';\\n  const match = url.match(/^https?[:][\\\\/][\\\\/]([^\\\\/]+)/);\\n  return match ? match[1] : '';\\n};\\n\\nconst organic = (response.organic || []).map((item, idx) => ({\\n  position: item.position || idx + 1,\\n  url: item.link || '',\\n  domain: getDomain(item.link),\\n  title: item.title || '',\\n  description: item.snippet || '',\\n  source: 'serper'\\n}));\\n\\nreturn [{ json: { organic, source: 'serper' } }];"},"id":"44e6dc34-a432-4ada-b257-55f29c9e6b34","name":"Code - Transform Serper","type":"n8n-nodes-base.code","typeVersion":2,"position":[208,208]},{"parameters":{"mode":"combine","options":{}},"id":"be24ee49-2cf5-4331-bdf9-2ffc32c46c93","name":"Merge Results","type":"n8n-nodes-base.merge","typeVersion":3,"position":[432,208]},{"parameters":{"jsCode":"// Process results and prepare for database insert\\nconst serpData = $input.first().json;\\nconst projectData = $('Code - Determine API Source').first().json;\\n\\nif (!serpData || !serpData.organic || serpData.organic.length === 0) {\\n  return [{\\n    json: {\\n      success: false,\\n      error: 'No SERP data received',\\n      projectId: projectData.projectId,\\n      source: serpData?.source || 'none'\\n    }\\n  }];\\n}\\n\\n// Return each competitor as separate item for batch insert\\nconst competitors = serpData.organic.map(comp => ({\\n  json: {\\n    projectId: projectData.projectId,\\n    position: comp.position,\\n    url: comp.url,\\n    domain: comp.domain,\\n    title: (comp.title || '').substring(0, 500),\\n    description: (comp.description || '').substring(0, 1000),\\n    domainRating: comp.domainRating || null,\\n    backlinks: comp.backlinks || null,\\n    source: serpData.source\\n  }\\n}));\\n\\nreturn competitors;"},"id":"4e2e7d05-732b-412f-8f67-b45863c53a8f","name":"Code - Process Results","type":"n8n-nodes-base.code","typeVersion":2,"position":[656,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-data","leftValue":"={{ $json.url }}","rightValue":"","operator":{"type":"string","operation":"notEmpty"}}],"combinator":"and"},"options":{}},"id":"90bd237a-73db-4de3-9c1a-0a84f0f53603","name":"IF - Has Data","type":"n8n-nodes-base.if","typeVersion":2,"position":[880,208]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO competitor_data (project_id, competitor_url, competitor_domain, serp_position, title, meta_description, domain_rating, backlinks_count, source)\\nVALUES (\\n  {{ $json.projectId }},\\n  '{{ $json.url.replace(/'/g, \\"''\\") }}',\\n  '{{ $json.domain.replace(/'/g, \\"''\\") }}',\\n  {{ $json.position }},\\n  '{{ $json.title.replace(/'/g, \\"''\\") }}',\\n  '{{ $json.description.replace(/'/g, \\"''\\") }}',\\n  {{ $json.domainRating || 'NULL' }},\\n  {{ $json.backlinks || 'NULL' }},\\n  '{{ $json.source }}'\\n)\\nON DUPLICATE KEY UPDATE\\n  serp_position = VALUES(serp_position),\\n  title = VALUES(title),\\n  meta_description = VALUES(meta_description)","options":{}},"id":"2880ce94-eefb-48ac-afd2-1a4c68ef9631","name":"MySQL - Insert Competitor","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1104,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=UPDATE keyword_projects \\nSET \\n  status = 'competitors_analyzed',\\n  total_competitors_analyzed = (SELECT COUNT(*) FROM competitor_data WHERE project_id = {{ $('Code - Determine API Source').first().json.projectId }}),\\n  updated_at = NOW()\\nWHERE id = {{ $('Code - Determine API Source').first().json.projectId }}","options":{}},"id":"3972cc13-e556-4973-aee0-b0c2e139b05d","name":"MySQL - Update Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1328,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Prepare success response\\nconst projectData = $('Code - Determine API Source').first().json;\\nconst insertedItems = $('MySQL - Insert Competitor').all();\\n\\nreturn [{\\n  json: {\\n    success: true,\\n    data: {\\n      projectId: projectData.projectId,\\n      projectName: projectData.projectName,\\n      mainKeyword: projectData.mainKeyword,\\n      competitorsAnalyzed: insertedItems.length,\\n      source: projectData.apiSource,\\n      status: 'competitors_analyzed'\\n    },\\n    message: `${insertedItems.length} rakip basariyla analiz edildi`\\n  }\\n}];"},"id":"ee4a67d4-261c-43e7-be27-53d68914c3d1","name":"Code - Prepare Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1536,208]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"e9fd7ed6-f79a-45bc-92fb-49b152869685","name":"Respond - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1760,208]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"No SERP data\\",\\n  \\"message\\": \\"{{ $json.error || 'Hicbir kaynaktan SERP verisi alinamadi' }}\\"\\n}","options":{"responseCode":500}},"id":"00986c11-3b28-4d31-9781-17425992f136","name":"Respond - No Data","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1104,400]}]	{"Webhook":{"main":[[{"node":"Code - Validate Input","type":"main","index":0}]]},"Code - Validate Input":{"main":[[{"node":"IF - Valid Input","type":"main","index":0}]]},"IF - Valid Input":{"main":[[{"node":"MySQL - Check Project","type":"main","index":0}],[{"node":"Respond - Validation Error","type":"main","index":0}]]},"MySQL - Check Project":{"main":[[{"node":"Code - Check Project","type":"main","index":0}]]},"Code - Check Project":{"main":[[{"node":"IF - Project Exists","type":"main","index":0}]]},"IF - Project Exists":{"main":[[{"node":"MySQL - Get Client Config","type":"main","index":0}],[{"node":"Respond - Not Found","type":"main","index":0}]]},"MySQL - Get Client Config":{"main":[[{"node":"Code - Determine API Source","type":"main","index":0}]]},"Code - Determine API Source":{"main":[[{"node":"Switch - API Source","type":"main","index":0}]]},"Switch - API Source":{"main":[[{"node":"HTTP - Ahrefs SERP","type":"main","index":0}],[{"node":"HTTP - Serper SERP","type":"main","index":0}],[{"node":"Code - Mock SERP","type":"main","index":0}]]},"HTTP - Ahrefs SERP":{"main":[[{"node":"Code - Transform Ahrefs","type":"main","index":0}]]},"HTTP - Serper SERP":{"main":[[{"node":"Code - Transform Serper","type":"main","index":0}]]},"Code - Transform Ahrefs":{"main":[[{"node":"Code - Process Results","type":"main","index":0}]]},"Code - Transform Serper":{"main":[[{"node":"Code - Process Results","type":"main","index":0}]]},"Code - Mock SERP":{"main":[[{"node":"Code - Process Results","type":"main","index":0}]]},"Code - Process Results":{"main":[[{"node":"IF - Has Data","type":"main","index":0}]]},"IF - Has Data":{"main":[[{"node":"MySQL - Insert Competitor","type":"main","index":0}],[{"node":"Respond - No Data","type":"main","index":0}]]},"MySQL - Insert Competitor":{"main":[[{"node":"MySQL - Update Project","type":"main","index":0}]]},"MySQL - Update Project":{"main":[[{"node":"Code - Prepare Response","type":"main","index":0}]]},"Code - Prepare Response":{"main":[[{"node":"Respond - Success","type":"main","index":0}]]}}	2025-12-17 10:28:20.591+00	2025-12-17 10:28:20.591+00	{"executionOrder":"v1"}	\N	{}	4117e47b-f342-43ae-9f1d-ae8ee30514c7	1	UxU00NHUOlNJSpFi	{"templateCredsSetupCompleted":true}	\N	f	18	\N	4117e47b-f342-43ae-9f1d-ae8ee30514c7
WF-107: Opportunity Scorer	t	[{"parameters":{"httpMethod":"POST","path":":projectId/calculate","responseMode":"responseNode","options":{}},"id":"159096a6-eb1c-4268-bebd-8b77d5c6ff42","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3296,208],"webhookId":"tool1-opportunity-scorer"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Input validation\\nconst projectId = $json.params?.projectId;\\n\\nif (!projectId) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'projectId parametresi zorunludur',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nconst parsedId = parseInt(projectId);\\nif (isNaN(parsedId) || parsedId <= 0) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'projectId gecerli bir pozitif sayi olmalidir',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nreturn {\\n  json: {\\n    isValid: true,\\n    projectId: parsedId\\n  }\\n};"},"id":"c488f3bc-13f8-4783-9a3b-f8879244a44b","name":"Code - Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-3088,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"3c1d56e6-47f7-4a85-bcae-7078dbb77af3","name":"IF - Valid Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[-2864,208]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Validation failed\\",\\n  \\"message\\": \\"{{ $json.error }}\\"\\n}","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"b67e8cd6-5bd8-427b-b75b-20e06bf85579","name":"Respond - Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-2640,400]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  kp.id as project_id,\\n  kp.client_id,\\n  kp.main_keyword,\\n  kp.scenario_type,\\n  kp.target_country,\\n  kp.target_language,\\n  c.domain as client_domain,\\n  c.name as client_name,\\n  cc.ai_model_preference as client_ai_model\\nFROM keyword_projects kp\\nJOIN clients c ON c.id = kp.client_id\\nLEFT JOIN client_configurations cc ON cc.client_id = kp.client_id\\nWHERE kp.id = {{ $json.projectId }}\\nLIMIT 1","options":{}},"id":"52fca920-c317-4c89-aa01-163c897d004d","name":"MySQL - Get Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-2640,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"project-exists","leftValue":"={{ $json.project_id }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"id":"b96b8d83-22e9-4ee2-9a4a-2f1aca66fb7b","name":"IF - Project Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-2416,208]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Project not found\\",\\n  \\"message\\": \\"Proje bulunamadi: {{ $('Code - Validate Input').first().json.projectId }}\\"\\n}","options":{"responseCode":404}},"id":"0351edcc-b05f-4ece-a33b-514e567b888b","name":"Respond - Not Found","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-2208,400]},{"parameters":{"operation":"executeQuery","query":"=SELECT setting_key, setting_value FROM system_settings WHERE setting_key IN ('default_ai_model', 'default_ai_temperature')","options":{}},"id":"832f52c8-693c-4b6d-abb7-31b98014fc8e","name":"MySQL - Get System Settings","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-2208,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT prompt_text FROM system_prompts WHERE slug = 'opportunity-scorer' AND is_active = 1 LIMIT 1","options":{}},"id":"9e70fc94-5726-408a-b627-a42cd234c0fa","name":"MySQL - Get System Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1984,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  kr.id,\\n  kr.keyword,\\n  kr.keyword_type,\\n  kr.search_volume,\\n  kr.keyword_difficulty,\\n  kr.cpc,\\n  kr.competition,\\n  kr.search_intent,\\n  kr.trend_direction,\\n  kr.opportunity_score as current_score\\nFROM keyword_results kr\\nWHERE kr.project_id = {{ $('MySQL - Get Project').first().json.project_id }}\\nORDER BY kr.search_volume DESC\\nLIMIT 100","options":{}},"id":"379efe11-ab1c-45a5-9c51-363a662dde19","name":"MySQL - Get Keywords","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1760,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=(SELECT \\n  cd.competitor_domain,\\n  cd.competitor_url,\\n  cd.title,\\n  cd.domain_rating,\\n  cd.serp_position,\\n  cd.word_count,\\n  cd.backlinks_count\\nFROM competitor_data cd\\nWHERE cd.project_id = {{ $('MySQL - Get Project').first().json.project_id }}\\nAND cd.word_count > 0\\nORDER BY cd.serp_position ASC\\nLIMIT 10)\\nUNION ALL\\n(SELECT NULL, NULL, NULL, NULL, NULL, NULL, NULL FROM dual\\nWHERE NOT EXISTS (\\n  SELECT 1 FROM competitor_data \\n  WHERE project_id = {{ $('MySQL - Get Project').first().json.project_id }} AND word_count > 0\\n))","options":{}},"id":"f6ca76a2-acd8-44e0-958f-d083a36525d7","name":"MySQL - Get Competitors","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1536,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=(SELECT \\n  sf.has_featured_snippet,\\n  sf.featured_snippet_type,\\n  sf.has_paa,\\n  sf.paa_count,\\n  sf.has_video_results,\\n  sf.has_knowledge_panel,\\n  sf.zero_click_risk\\nFROM serp_features sf\\nWHERE sf.project_id = {{ $('MySQL - Get Project').first().json.project_id }}\\nLIMIT 1)\\nUNION ALL\\n(SELECT 0, NULL, 0, 0, 0, 0, NULL FROM dual\\nWHERE NOT EXISTS (\\n  SELECT 1 FROM serp_features \\n  WHERE project_id = {{ $('MySQL - Get Project').first().json.project_id }}\\n))","options":{}},"id":"9c14a715-7419-4974-96c6-6c07f90c61c3","name":"MySQL - Get SERP Features","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1328,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Prepare AI prompt - COMPACT CSV FORMAT: ID|Keyword|Vol|KD|CPC\\nconst project = $('MySQL - Get Project').first().json;\\nconst keywordItems = $('MySQL - Get Keywords').all();\\nconst keywords = keywordItems.map(i => i.json).filter(k => k.id);\\n\\n// System Settings\\nconst settingsItems = $('MySQL - Get System Settings').all();\\nconst systemSettings = {};\\nsettingsItems.forEach(item => {\\n  if (item.json.setting_key) systemSettings[item.json.setting_key] = item.json.setting_value;\\n});\\n\\n// System Prompt\\nconst promptData = $('MySQL - Get System Prompt').first().json;\\nconst systemPromptTemplate = promptData?.prompt_text || '';\\n\\nif (keywords.length === 0) {\\n  return [{ json: { skip: true, project_id: project.project_id, message: 'Skorlanacak keyword bulunamadi' } }];\\n}\\n\\n// COMPACT CSV format: ID|Keyword|Vol|KD|CPC\\nconst keywordCsv = keywords.map(kw => {\\n  const vol = kw.search_volume || 0;\\n  const kd = kw.keyword_difficulty !== null ? kw.keyword_difficulty : '';\\n  const cpc = kw.cpc || 0;\\n  return `${kw.id}|${kw.keyword}|${vol}|${kd}|${cpc}`;\\n}).join('\\\\n');\\n\\n// Replace template variables\\nlet finalPrompt = systemPromptTemplate\\n  .replace(/\\\\{\\\\{main_keyword\\\\}\\\\}/g, project.main_keyword || '')\\n  .replace(/\\\\{\\\\{target_country\\\\}\\\\}/g, project.target_country || 'TR')\\n  .replace(/\\\\{\\\\{keyword_csv\\\\}\\\\}/g, keywordCsv);\\n\\n// Fallback prompt if empty\\nif (!finalPrompt || finalPrompt.trim() === '') {\\n  finalPrompt = `SEO keyword firsat skorlama. Skoru 0-100 arasi hesapla.\\\\nPROJE: ${project.main_keyword} | ${project.target_country}\\\\nKEYWORDS (ID|Keyword|Vol|KD|CPC):\\\\n${keywordCsv}\\\\nCIKTI (sadece CSV, baslik yok):\\\\nID,Score,Priority,LHF`;\\n}\\n\\n// Model selection\\nconst clientModel = project.client_ai_model;\\nconst systemDefaultModel = systemSettings.default_ai_model || 'gemini-2.0-flash';\\nconst primaryModel = clientModel || systemDefaultModel;\\nlet fallbackModel = null;\\nif (clientModel && systemDefaultModel && clientModel !== systemDefaultModel) fallbackModel = systemDefaultModel;\\nconst temperature = parseFloat(systemSettings.default_ai_temperature) || 0.7;\\n\\nreturn [{\\n  json: {\\n    project_id: project.project_id,\\n    client_id: project.client_id,\\n    main_keyword: project.main_keyword,\\n    prompt: finalPrompt,\\n    keyword_count: keywords.length,\\n    keywords: keywords,\\n    primaryModel: primaryModel,\\n    fallbackModel: fallbackModel,\\n    temperature: temperature\\n  }\\n}];"},"id":"703a04d7-3b7d-4fb8-9ded-0804ad9164a5","name":"Code - Prepare AI Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1104,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-keywords","leftValue":"={{ $json.skip }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"181f1c88-2678-4d7f-80dc-d81b5ec33fbc","name":"IF - Has Keywords","type":"n8n-nodes-base.if","typeVersion":2,"position":[-880,208]},{"parameters":{"jsCode":"// AI Analysis - COMPACT CSV OUTPUT + TOKEN TRACKING\\nconst data = $input.first().json;\\nconst prompt = data.prompt;\\nconst primaryModel = data.primaryModel;\\nconst fallbackModel = data.fallbackModel;\\nconst temperature = data.temperature;\\nconst keywords = data.keywords || [];\\n\\nconst GEMINI_API_KEY = $env.GEMINI_API_KEY || '';\\nconst OPENAI_API_KEY = $env.OPENAI_API_KEY || '';\\n\\nlet result = null;\\nlet aiSource = 'none';\\nlet tokenUsage = { input: 0, output: 0, model: '', provider: 'none' };\\n\\n// Call AI Model with token tracking\\nasync function callModel(model, promptText) {\\n  const startTime = Date.now();\\n  try {\\n    if (model.includes('gemini') && GEMINI_API_KEY) {\\n      const response = await this.helpers.httpRequest({\\n        method: 'POST',\\n        url: `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`,\\n        headers: { 'Content-Type': 'application/json' },\\n        body: { contents: [{ parts: [{ text: promptText }] }], generationConfig: { temperature: temperature, maxOutputTokens: 4096 } },\\n        timeout: 90000\\n      });\\n      const elapsed = Date.now() - startTime;\\n      if (response.candidates?.[0]?.content?.parts?.[0]?.text) {\\n        const usage = response.usageMetadata || {};\\n        return { success: true, content: response.candidates[0].content.parts[0].text, source: 'gemini', tokens: { input: usage.promptTokenCount || 0, output: usage.candidatesTokenCount || 0 }, model: model, elapsed: elapsed };\\n      }\\n    } else if ((model.includes('gpt') || model.includes('openai')) && OPENAI_API_KEY) {\\n      const response = await this.helpers.httpRequest({\\n        method: 'POST',\\n        url: 'https://api.openai.com/v1/chat/completions',\\n        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${OPENAI_API_KEY}` },\\n        body: { model: 'gpt-4o-mini', messages: [{ role: 'user', content: promptText }], temperature: temperature, max_tokens: 4096 },\\n        timeout: 90000\\n      });\\n      const elapsed = Date.now() - startTime;\\n      if (response.choices?.[0]?.message?.content) {\\n        const usage = response.usage || {};\\n        return { success: true, content: response.choices[0].message.content, source: 'openai', tokens: { input: usage.prompt_tokens || 0, output: usage.completion_tokens || 0 }, model: 'gpt-4o-mini', elapsed: elapsed };\\n      }\\n    }\\n  } catch (e) { console.log(`Model ${model} failed:`, e.message); }\\n  return { success: false, elapsed: Date.now() - startTime };\\n}\\n\\n// Parse CSV response\\nfunction parseCSVResponse(content, keywordList) {\\n  const csvContent = content.replace(/```[a-z]*\\\\n?/g, '').replace(/```/g, '').trim();\\n  const lines = csvContent.split('\\\\n').filter(l => l.trim() && !l.toLowerCase().startsWith('id'));\\n  const scoredKeywords = [];\\n  for (const line of lines) {\\n    const parts = line.split(/[,|]/).map(p => p.trim());\\n    if (parts.length >= 4) {\\n      const kwId = parseInt(parts[0]);\\n      const origKw = keywordList.find(k => k.id === kwId);\\n      if (origKw) {\\n        scoredKeywords.push({ keyword_id: kwId, keyword: origKw.keyword, opportunity_score: parseInt(parts[1]) || 50, priority: (parts[2] || 'medium').toLowerCase(), low_hanging_fruit: parts[3] === '1' || parts[3].toLowerCase() === 'true' });\\n      }\\n    }\\n  }\\n  if (scoredKeywords.length === 0) return null;\\n  scoredKeywords.sort((a, b) => b.opportunity_score - a.opportunity_score);\\n  return { analysis_summary: `${scoredKeywords.length} keyword analiz edildi.`, scored_keywords: scoredKeywords, top_opportunities: scoredKeywords.slice(0, 5).map(k => k.keyword) };\\n}\\n\\n// Mock Scoring\\nfunction getMockScoring(keywordList) {\\n  const scoredKeywords = keywordList.map(kw => {\\n    const vol = kw.search_volume || 0; const kd = kw.keyword_difficulty !== null ? kw.keyword_difficulty : 50;\\n    let score = 50 + (vol >= 1000 ? 15 : vol >= 100 ? 8 : 0) + (kd <= 30 ? 20 : kd <= 50 ? 10 : 0);\\n    return { keyword_id: kw.id, keyword: kw.keyword, opportunity_score: Math.min(score, 100), priority: score >= 70 ? 'high' : score >= 50 ? 'medium' : 'low', low_hanging_fruit: vol >= 100 && kd <= 30 };\\n  });\\n  scoredKeywords.sort((a, b) => b.opportunity_score - a.opportunity_score);\\n  return { analysis_summary: `[MOCK] ${keywordList.length} keyword skorlandi.`, scored_keywords: scoredKeywords, top_opportunities: scoredKeywords.slice(0, 5).map(k => k.keyword) };\\n}\\n\\nlet responseTime = 0;\\n\\n// 1. Try Primary Model\\nif (primaryModel) {\\n  const r = await callModel.call(this, primaryModel, prompt);\\n  responseTime = r.elapsed || 0;\\n  if (r.success) {\\n    result = parseCSVResponse(r.content, keywords);\\n    if (result) { aiSource = r.source; tokenUsage = { input: r.tokens?.input || 0, output: r.tokens?.output || 0, model: r.model, provider: r.source }; }\\n  }\\n}\\n\\n// 2. Try Fallback\\nif (!result && fallbackModel) {\\n  const r = await callModel.call(this, fallbackModel, prompt);\\n  responseTime = r.elapsed || 0;\\n  if (r.success) {\\n    result = parseCSVResponse(r.content, keywords);\\n    if (result) { aiSource = r.source + '-fallback'; tokenUsage = { input: r.tokens?.input || 0, output: r.tokens?.output || 0, model: r.model, provider: r.source }; }\\n  }\\n}\\n\\n// 3. Mock\\nif (!result) { result = getMockScoring(keywords); aiSource = 'mock'; }\\n\\nreturn [{ json: { project_id: data.project_id, client_id: data.client_id, ai_response: result, ai_source: aiSource, keyword_count: keywords.length, token_usage: tokenUsage, response_time_ms: responseTime } }];"},"id":"e20d5499-7a65-4708-b83d-e0d33549f1bc","name":"Code - AI Analysis","type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,112]},{"parameters":{"jsCode":"const data = $input.first().json;\\nreturn {\\n  success: true,\\n  message: data.message || 'Skorlanacak keyword bulunamadi',\\n  project_id: data.project_id,\\n  stats: { total_keywords: 0 }\\n};"},"id":"bb90e693-8f0d-4c76-96d5-4436dd96bb93","name":"Code - No Keywords","type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,352]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"dbde50bf-7953-435e-ab44-78edd1b82b5a","name":"Respond - No Keywords","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-448,352]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO api_usage_tracking (client_id, tool_name, project_id, workflow_name, api_provider, model_name, tokens_input, tokens_output, requests_count, response_time_ms, was_successful) VALUES ({{ $json.client_id || 0 }}, 'tool1', {{ $json.project_id || 0 }}, 'WF-107-opportunity-scorer', '{{ $json.token_usage?.provider === 'gemini' ? 'google' : $json.token_usage?.provider === 'openai' ? 'openai' : 'other' }}', '{{ $json.token_usage?.model || '' }}', {{ $json.token_usage?.input || 0 }}, {{ $json.token_usage?.output || 0 }}, 1, {{ $json.response_time_ms || 0 }}, {{ $json.ai_source !== 'mock' ? 1 : 0 }})","options":{}},"id":"f4867113-a5c7-4a76-9f93-3f1655d48bd1","name":"MySQL - Log Token Usage","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-544,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Skorlari tek tek update icin ayir\\nconst data = $('Code - AI Analysis').first().json;\\nconst aiResponse = data.ai_response || {};\\nconst scoredKeywords = aiResponse.scored_keywords || [];\\n\\nif (scoredKeywords.length === 0) {\\n  return [{ json: { skip: true, project_id: data.project_id, ai_source: data.ai_source, ai_response: aiResponse } }];\\n}\\n\\nreturn scoredKeywords.map(kw => ({\\n  json: {\\n    keyword_id: kw.keyword_id,\\n    opportunity_score: kw.opportunity_score,\\n    priority: kw.priority,\\n    low_hanging_fruit: kw.low_hanging_fruit ? 1 : 0,\\n    project_id: data.project_id,\\n    ai_source: data.ai_source,\\n    ai_response: aiResponse\\n  }\\n}));"},"id":"6efbb017-1ad9-4721-830d-fe086fe5e4c9","name":"Code - Split for Update","type":"n8n-nodes-base.code","typeVersion":2,"position":[-336,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-scores","leftValue":"={{ $json.skip }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"a0c77832-2c23-4661-b095-06f8a38647ee","name":"IF - Has Scores","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"operation":"executeQuery","query":"=UPDATE keyword_results \\nSET opportunity_score = {{ $json.opportunity_score }}\\nWHERE id = {{ $json.keyword_id }}","options":{}},"id":"3cbe924e-3c55-4771-b37a-fc27c9e4c781","name":"MySQL - Update Score","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[0,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=UPDATE keyword_projects \\nSET status = 'scores_calculated'\\nWHERE id = {{ $('Code - Split for Update').first().json.project_id }}","options":{}},"id":"18eae58d-50c8-4151-9ad8-96bd13685d4b","name":"MySQL - Update Project Status","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Response hazirla\\nconst firstItem = $('Code - Split for Update').first().json;\\nconst aiResponse = firstItem.ai_response || {};\\nconst allItems = $('Code - Split for Update').all();\\nconst totalUpdated = allItems.filter(i => !i.json.skip).length;\\nconst scoredKeywords = aiResponse.scored_keywords || [];\\n\\n// Stats hesapla\\nconst highPriority = scoredKeywords.filter(k => k.priority === 'high').length;\\nconst mediumPriority = scoredKeywords.filter(k => k.priority === 'medium').length;\\nconst lowPriority = scoredKeywords.filter(k => k.priority === 'low').length;\\nconst lowHangingFruits = scoredKeywords.filter(k => k.low_hanging_fruit).length;\\nconst avgScore = scoredKeywords.length > 0 \\n  ? Math.round(scoredKeywords.reduce((sum, k) => sum + k.opportunity_score, 0) / scoredKeywords.length)\\n  : 0;\\n\\nreturn {\\n  success: true,\\n  message: aiResponse.analysis_summary || `Firsat skorlari hesaplandi. ${totalUpdated} keyword guncellendi.`,\\n  project_id: firstItem.project_id,\\n  ai_source: firstItem.ai_source,\\n  stats: {\\n    total_keywords: totalUpdated,\\n    high_priority: highPriority,\\n    medium_priority: mediumPriority,\\n    low_priority: lowPriority,\\n    low_hanging_fruits: lowHangingFruits,\\n    average_score: avgScore\\n  },\\n  top_opportunities: aiResponse.top_opportunities || [],\\n  warnings: aiResponse.warnings || [],\\n  next_step: 'WF-108 Keyword Clusterer ile kumeleme yapilabilir'\\n};"},"id":"cfe9528a-a9c5-445d-a929-93e48c628abc","name":"Code - Prepare Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,112]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"cb7d75b6-1f90-4898-8059-27d6f7b54daa","name":"Respond - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,112]},{"parameters":{"jsCode":"const data = $input.first().json;\\nconst aiResponse = data.ai_response || {};\\n\\nreturn {\\n  success: true,\\n  message: 'Skorlama tamamlandi ancak guncellenecek keyword bulunamadi',\\n  project_id: data.project_id,\\n  ai_source: data.ai_source,\\n  analysis_summary: aiResponse.analysis_summary || '',\\n  warnings: aiResponse.warnings || []\\n};"},"id":"9a462407-2e9e-4581-8a05-d48e47ff0fcf","name":"Code - No Scores","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,256]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"988eb5d6-7981-4bbe-8ad9-403d3debe0eb","name":"Respond - No Scores","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[224,256]}]	{"Webhook":{"main":[[{"node":"Code - Validate Input","type":"main","index":0}]]},"Code - Validate Input":{"main":[[{"node":"IF - Valid Input","type":"main","index":0}]]},"IF - Valid Input":{"main":[[{"node":"MySQL - Get Project","type":"main","index":0}],[{"node":"Respond - Validation Error","type":"main","index":0}]]},"MySQL - Get Project":{"main":[[{"node":"IF - Project Exists","type":"main","index":0}]]},"IF - Project Exists":{"main":[[{"node":"MySQL - Get System Settings","type":"main","index":0}],[{"node":"Respond - Not Found","type":"main","index":0}]]},"MySQL - Get System Settings":{"main":[[{"node":"MySQL - Get System Prompt","type":"main","index":0}]]},"MySQL - Get System Prompt":{"main":[[{"node":"MySQL - Get Keywords","type":"main","index":0}]]},"MySQL - Get Keywords":{"main":[[{"node":"MySQL - Get Competitors","type":"main","index":0}]]},"MySQL - Get Competitors":{"main":[[{"node":"MySQL - Get SERP Features","type":"main","index":0}]]},"MySQL - Get SERP Features":{"main":[[{"node":"Code - Prepare AI Prompt","type":"main","index":0}]]},"Code - Prepare AI Prompt":{"main":[[{"node":"IF - Has Keywords","type":"main","index":0}]]},"IF - Has Keywords":{"main":[[{"node":"Code - AI Analysis","type":"main","index":0}],[{"node":"Code - No Keywords","type":"main","index":0}]]},"Code - AI Analysis":{"main":[[{"node":"MySQL - Log Token Usage","type":"main","index":0}]]},"MySQL - Log Token Usage":{"main":[[{"node":"Code - Split for Update","type":"main","index":0}]]},"Code - No Keywords":{"main":[[{"node":"Respond - No Keywords","type":"main","index":0}]]},"Code - Split for Update":{"main":[[{"node":"IF - Has Scores","type":"main","index":0}]]},"IF - Has Scores":{"main":[[{"node":"MySQL - Update Score","type":"main","index":0}],[{"node":"Code - No Scores","type":"main","index":0}]]},"MySQL - Update Score":{"main":[[{"node":"MySQL - Update Project Status","type":"main","index":0}]]},"MySQL - Update Project Status":{"main":[[{"node":"Code - Prepare Response","type":"main","index":0}]]},"Code - Prepare Response":{"main":[[{"node":"Respond - Success","type":"main","index":0}]]},"Code - No Scores":{"main":[[{"node":"Respond - No Scores","type":"main","index":0}]]}}	2025-12-17 10:29:03.332+00	2025-12-17 10:29:03.332+00	{"executionOrder":"v1"}	\N	{}	7ee59fa8-baf4-4e41-a893-81d590e61e86	1	x03Ivd085mWitZQ9	{"templateCredsSetupCompleted":true}	\N	f	18	\N	7ee59fa8-baf4-4e41-a893-81d590e61e86
WF-109: Strategy Generator	t	[{"parameters":{"httpMethod":"POST","path":":projectId/generate","responseMode":"responseNode","options":{}},"id":"d0dad58f-42b9-4e0c-ba38-378f79cc1f6a","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3088,208],"webhookId":"tool1-strategy-generator"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Input validation\\nconst projectId = $json.params?.projectId;\\n\\nif (!projectId) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'projectId parametresi zorunludur',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nconst parsedId = parseInt(projectId);\\nif (isNaN(parsedId) || parsedId <= 0) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'projectId gecerli bir pozitif sayi olmalidir',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nreturn {\\n  json: {\\n    isValid: true,\\n    projectId: parsedId\\n  }\\n};"},"id":"3bf32125-cc5c-49da-97aa-ea6b4bea4d1d","name":"Code - Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2864,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"688f21a5-78c8-4041-8c54-91856822c348","name":"IF - Valid Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[-2640,208]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Validation failed\\",\\n  \\"message\\": \\"{{ $json.error }}\\"\\n}","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"59b91cda-ff2f-4405-bc00-2815afa908b3","name":"Respond - Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-2416,400]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  kp.id as project_id,\\n  kp.client_id,\\n  kp.main_keyword,\\n  kp.scenario_type,\\n  kp.target_country,\\n  kp.target_language,\\n  c.domain as client_domain,\\n  c.name as client_name,\\n  c.industry as client_industry,\\n  cc.ai_model_preference as client_ai_model\\nFROM keyword_projects kp\\nJOIN clients c ON c.id = kp.client_id\\nLEFT JOIN client_configurations cc ON cc.client_id = kp.client_id\\nWHERE kp.id = {{ $json.projectId }}\\nLIMIT 1","options":{}},"id":"f3af111f-4680-43f4-a53e-2e19711ae44f","name":"MySQL - Get Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-2416,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"project-exists","leftValue":"={{ $json.project_id }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"id":"bda8f0fa-5168-4cb1-873b-b90c83ec9543","name":"IF - Project Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-2208,208]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Project not found\\",\\n  \\"message\\": \\"Proje bulunamadi: {{ $('Code - Validate Input').first().json.projectId }}\\"\\n}","options":{"responseCode":404}},"id":"a943bedc-ac10-46ad-89d7-8d23fbd2ec31","name":"Respond - Not Found","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-1984,400]},{"parameters":{"operation":"executeQuery","query":"=SELECT setting_key, setting_value FROM system_settings WHERE setting_key IN ('default_ai_model', 'default_ai_temperature')","options":{}},"id":"4ebff6c1-fd11-435b-8b4a-68c7d5766fb3","name":"MySQL - Get System Settings","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1984,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT prompt_text FROM system_prompts WHERE slug = 'strategy-generator' AND is_active = 1 LIMIT 1","options":{}},"id":"466abb05-c121-48d1-b914-dbe2b41e511d","name":"MySQL - Get System Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1760,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  kr.id,\\n  kr.keyword,\\n  kr.keyword_type,\\n  kr.search_volume,\\n  kr.keyword_difficulty,\\n  kr.cpc,\\n  kr.search_intent,\\n  kr.keyword_cluster,\\n  kr.opportunity_score,\\n  kr.parent_topic\\nFROM keyword_results kr\\nWHERE kr.project_id = {{ $('MySQL - Get Project').first().json.project_id }}\\nAND kr.keyword_type != 'rejected'\\nORDER BY kr.opportunity_score DESC, kr.search_volume DESC\\nLIMIT 50","options":{}},"id":"0fc1f293-e5ac-4f0e-8cd5-4b066f8d6341","name":"MySQL - Get Keywords","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1536,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=(SELECT \\n  cd.competitor_domain,\\n  cd.title,\\n  cd.word_count,\\n  cd.serp_position,\\n  cd.domain_rating\\nFROM competitor_data cd\\nWHERE cd.project_id = {{ $('MySQL - Get Project').first().json.project_id }}\\nAND cd.word_count > 0\\nORDER BY cd.serp_position ASC\\nLIMIT 5)\\nUNION ALL\\n(SELECT NULL, NULL, NULL, NULL, NULL FROM dual\\nWHERE NOT EXISTS (\\n  SELECT 1 FROM competitor_data \\n  WHERE project_id = {{ $('MySQL - Get Project').first().json.project_id }} AND word_count > 0\\n))","options":{}},"id":"273109e8-6278-4f47-83ae-a2657c9abadf","name":"MySQL - Get Competitors","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1328,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Prepare AI prompt - COMPACT CSV FORMAT: ID|keyword|intent|score\\nconst project = $('MySQL - Get Project').first().json;\\nconst keywordItems = $('MySQL - Get Keywords').all();\\nconst keywords = keywordItems.map(i => i.json).filter(k => k.id);\\nconst competitorItems = $('MySQL - Get Competitors').all();\\nconst competitors = competitorItems.map(i => i.json).filter(c => c.competitor_domain);\\n\\n// System Settings\\nconst settingsItems = $('MySQL - Get System Settings').all();\\nconst systemSettings = {};\\nsettingsItems.forEach(item => {\\n  if (item.json.setting_key) systemSettings[item.json.setting_key] = item.json.setting_value;\\n});\\n\\n// System Prompt\\nconst promptData = $('MySQL - Get System Prompt').first().json;\\nconst systemPromptTemplate = promptData?.prompt_text || '';\\n\\nif (keywords.length === 0) {\\n  return [{ json: { skip: true, project_id: project.project_id, message: 'Strateji olusturulacak keyword bulunamadi' } }];\\n}\\n\\n// Average competitor word count\\nconst avgWordCount = competitors.length > 0 \\n  ? Math.round(competitors.reduce((sum, c) => sum + (c.word_count || 0), 0) / competitors.length) : 1500;\\n\\n// COMPACT CSV format: ID|keyword|intent|score\\nconst keywordCsv = keywords.map(kw => {\\n  const intent = kw.search_intent || 'informational';\\n  const score = kw.opportunity_score || 0;\\n  return `${kw.id}|${kw.keyword}|${intent}|${score}`;\\n}).join('\\\\n');\\n\\n// Replace template variables\\nlet finalPrompt = systemPromptTemplate\\n  .replace(/\\\\{\\\\{main_keyword\\\\}\\\\}/g, project.main_keyword || '')\\n  .replace(/\\\\{\\\\{target_country\\\\}\\\\}/g, project.target_country || 'TR')\\n  .replace(/\\\\{\\\\{keyword_csv\\\\}\\\\}/g, keywordCsv);\\n\\n// Fallback prompt\\nif (!finalPrompt || finalPrompt.trim() === '') {\\n  finalPrompt = `Icerik stratejisi. Konu: ${project.main_keyword} | Ulke: ${project.target_country}\\\\nKEYWORDS (ID|keyword|intent|score):\\\\n${keywordCsv}\\\\nCIKTI (sadece CSV, baslik yok):\\\\nID|type|format|priority|words|pillar_id`;\\n}\\n\\n// Model selection\\nconst clientModel = project.client_ai_model;\\nconst systemDefaultModel = systemSettings.default_ai_model || 'gemini-2.0-flash';\\nconst primaryModel = clientModel || systemDefaultModel;\\nlet fallbackModel = null;\\nif (clientModel && systemDefaultModel && clientModel !== systemDefaultModel) fallbackModel = systemDefaultModel;\\nconst temperature = parseFloat(systemSettings.default_ai_temperature) || 0.7;\\n\\nreturn [{\\n  json: {\\n    project_id: project.project_id,\\n    client_id: project.client_id,\\n    main_keyword: project.main_keyword,\\n    prompt: finalPrompt,\\n    keyword_count: keywords.length,\\n    keywords: keywords,\\n    avg_competitor_word_count: avgWordCount,\\n    primaryModel: primaryModel,\\n    fallbackModel: fallbackModel,\\n    temperature: temperature\\n  }\\n}];"},"id":"b192b797-3e6d-4a21-a4e4-ba8fb19e64ff","name":"Code - Prepare AI Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1104,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-keywords","leftValue":"={{ $json.skip }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"c70eef1f-3a56-453d-a676-6bec7112f7be","name":"IF - Has Keywords","type":"n8n-nodes-base.if","typeVersion":2,"position":[-880,208]},{"parameters":{"jsCode":"// AI Analysis - COMPACT CSV OUTPUT + TOKEN TRACKING: ID|type|format|priority|words|pillar_id\\nconst data = $input.first().json;\\nconst prompt = data.prompt;\\nconst primaryModel = data.primaryModel;\\nconst fallbackModel = data.fallbackModel;\\nconst temperature = data.temperature;\\nconst keywords = data.keywords || [];\\nconst avgWordCount = data.avg_competitor_word_count || 1500;\\n\\nconst GEMINI_API_KEY = $env.GEMINI_API_KEY || '';\\nconst OPENAI_API_KEY = $env.OPENAI_API_KEY || '';\\n\\nlet result = null;\\nlet aiSource = 'none';\\nlet tokenUsage = { input: 0, output: 0, model: '', provider: 'none' };\\n\\n// Call AI Model with token tracking\\nasync function callModel(model, promptText) {\\n  const startTime = Date.now();\\n  try {\\n    if (model.includes('gemini') && GEMINI_API_KEY) {\\n      const response = await this.helpers.httpRequest({\\n        method: 'POST',\\n        url: `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`,\\n        headers: { 'Content-Type': 'application/json' },\\n        body: { contents: [{ parts: [{ text: promptText }] }], generationConfig: { temperature: temperature, maxOutputTokens: 4096 } },\\n        timeout: 90000\\n      });\\n      const elapsed = Date.now() - startTime;\\n      if (response.candidates?.[0]?.content?.parts?.[0]?.text) {\\n        const usage = response.usageMetadata || {};\\n        return { success: true, content: response.candidates[0].content.parts[0].text, source: 'gemini', tokens: { input: usage.promptTokenCount || 0, output: usage.candidatesTokenCount || 0 }, model: model, elapsed: elapsed };\\n      }\\n    } else if ((model.includes('gpt') || model.includes('openai')) && OPENAI_API_KEY) {\\n      const response = await this.helpers.httpRequest({\\n        method: 'POST',\\n        url: 'https://api.openai.com/v1/chat/completions',\\n        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${OPENAI_API_KEY}` },\\n        body: { model: 'gpt-4o-mini', messages: [{ role: 'user', content: promptText }], temperature: temperature, max_tokens: 4096 },\\n        timeout: 90000\\n      });\\n      const elapsed = Date.now() - startTime;\\n      if (response.choices?.[0]?.message?.content) {\\n        const usage = response.usage || {};\\n        return { success: true, content: response.choices[0].message.content, source: 'openai', tokens: { input: usage.prompt_tokens || 0, output: usage.completion_tokens || 0 }, model: 'gpt-4o-mini', elapsed: elapsed };\\n      }\\n    }\\n  } catch (e) { console.log(`Model ${model} failed:`, e.message); }\\n  return { success: false, elapsed: Date.now() - startTime };\\n}\\n\\n// Parse CSV response: ID|type|format|priority|words|pillar_id\\nfunction parseCSVResponse(content, keywordList) {\\n  const csvContent = content.replace(/```[a-z]*\\\\n?/g, '').replace(/```/g, '').trim();\\n  const lines = csvContent.split('\\\\n').filter(l => l.trim() && !l.toLowerCase().startsWith('id'));\\n  const strategies = [];\\n  \\n  for (const line of lines) {\\n    const parts = line.split('|').map(p => p.trim());\\n    if (parts.length >= 5) {\\n      const kwId = parseInt(parts[0]);\\n      const origKw = keywordList.find(k => k.id === kwId);\\n      if (origKw) {\\n        strategies.push({\\n          keyword_id: kwId,\\n          keyword: origKw.keyword,\\n          page_type: parts[1] || 'cluster',\\n          content_format: parts[2] || 'blog',\\n          content_priority: parts[3] || 'medium',\\n          recommended_word_count: parseInt(parts[4]) || 1500,\\n          parent_pillar: parts[5] || null\\n        });\\n      }\\n    }\\n  }\\n  \\n  if (strategies.length === 0) return null;\\n  const pillarCount = strategies.filter(s => s.page_type === 'pillar').length;\\n  const clusterCount = strategies.filter(s => s.page_type === 'cluster').length;\\n  \\n  return {\\n    strategy_summary: `${strategies.length} keyword icin strateji olusturuldu. ${pillarCount} pillar, ${clusterCount} cluster.`,\\n    keyword_strategies: strategies,\\n    pillar_pages: strategies.filter(s => s.page_type === 'pillar').map(s => ({ keyword: s.keyword, keyword_id: s.keyword_id }))\\n  };\\n}\\n\\n// Mock Strategy\\nfunction getMockStrategy(keywordList, avgWC) {\\n  const sortedByVolume = [...keywordList].sort((a, b) => (b.search_volume || 0) - (a.search_volume || 0));\\n  const pillarKw = sortedByVolume[0];\\n  \\n  const strategies = keywordList.map(kw => {\\n    const isPillar = kw.id === pillarKw?.id;\\n    const score = kw.opportunity_score || 0;\\n    const intent = kw.search_intent || 'informational';\\n    let type = isPillar ? 'pillar' : 'cluster';\\n    let format = isPillar ? 'guide' : (intent === 'commercial' ? 'comparison' : 'blog');\\n    let priority = score >= 65 ? 'high' : score >= 40 ? 'medium' : 'low';\\n    let words = isPillar ? Math.round(avgWC * 1.8) : avgWC;\\n    return { keyword_id: kw.id, keyword: kw.keyword, page_type: type, content_format: format, content_priority: priority, recommended_word_count: words, parent_pillar: isPillar ? null : pillarKw?.keyword };\\n  });\\n  \\n  return {\\n    strategy_summary: `[MOCK] ${keywordList.length} keyword icin strateji.`,\\n    keyword_strategies: strategies,\\n    pillar_pages: pillarKw ? [{ keyword: pillarKw.keyword, keyword_id: pillarKw.id }] : [],\\n    recommendations: ['Mock strateji kullanildi']\\n  };\\n}\\n\\nlet responseTime = 0;\\n\\n// 1. Try Primary Model\\nif (primaryModel) {\\n  const r = await callModel.call(this, primaryModel, prompt);\\n  responseTime = r.elapsed || 0;\\n  if (r.success) {\\n    result = parseCSVResponse(r.content, keywords);\\n    if (result) { aiSource = r.source; tokenUsage = { input: r.tokens?.input || 0, output: r.tokens?.output || 0, model: r.model, provider: r.source }; }\\n  }\\n}\\n\\n// 2. Try Fallback Model\\nif (!result && fallbackModel) {\\n  const r = await callModel.call(this, fallbackModel, prompt);\\n  responseTime = r.elapsed || 0;\\n  if (r.success) {\\n    result = parseCSVResponse(r.content, keywords);\\n    if (result) { aiSource = r.source + '-fallback'; tokenUsage = { input: r.tokens?.input || 0, output: r.tokens?.output || 0, model: r.model, provider: r.source }; }\\n  }\\n}\\n\\n// 3. Use Mock\\nif (!result) {\\n  result = getMockStrategy(keywords, avgWordCount);\\n  aiSource = 'mock';\\n}\\n\\nreturn [{ json: { project_id: data.project_id, client_id: data.client_id, ai_response: result, ai_source: aiSource, keyword_count: keywords.length, token_usage: tokenUsage, response_time_ms: responseTime } }];"},"id":"2976e24c-4897-4c42-8f26-2a705b272527","name":"Code - AI Analysis","type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,112]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO api_usage_tracking (client_id, tool_name, project_id, workflow_name, api_provider, model_name, tokens_input, tokens_output, requests_count, response_time_ms, was_successful) VALUES ({{ $json.client_id || 0 }}, 'tool1', {{ $json.project_id || 0 }}, 'WF-109-strategy-generator', '{{ $json.token_usage?.provider === 'gemini' ? 'google' : $json.token_usage?.provider === 'openai' ? 'openai' : 'other' }}', '{{ $json.token_usage?.model || '' }}', {{ $json.token_usage?.input || 0 }}, {{ $json.token_usage?.output || 0 }}, 1, {{ $json.response_time_ms || 0 }}, {{ $json.ai_source !== 'mock' ? 1 : 0 }})","options":{}},"id":"06f0e9a1-d519-4b5c-bb34-ea687581f5ad","name":"MySQL - Log Token Usage","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-448,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const data = $input.first().json;\\nreturn {\\n  success: true,\\n  message: data.message || 'Strateji olusturulacak keyword bulunamadi',\\n  project_id: data.project_id,\\n  stats: { total_keywords: 0 }\\n};"},"id":"b1ce9169-5440-4ff6-a7fe-addb5dab5792","name":"Code - No Keywords","type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,352]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"d8285171-06d4-4131-a085-44038d36e60d","name":"Respond - No Keywords","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-448,352]},{"parameters":{"jsCode":"// Strateji verilerini tek tek update icin ayir\\nconst data = $('Code - AI Analysis').first().json;\\nconst aiResponse = data.ai_response || {};\\nconst strategies = aiResponse.keyword_strategies || [];\\n\\nif (strategies.length === 0) {\\n  return [{ json: { skip: true, project_id: data.project_id, ai_source: data.ai_source, ai_response: aiResponse } }];\\n}\\n\\nreturn strategies.map(s => ({\\n  json: {\\n    keyword_id: s.keyword_id,\\n    page_type: s.page_type || 'cluster',\\n    content_format: s.content_format || 'blog',\\n    content_priority: s.content_priority || 'medium',\\n    recommended_word_count: s.recommended_word_count || 1500,\\n    parent_pillar: s.parent_pillar || null,\\n    project_id: data.project_id,\\n    ai_source: data.ai_source,\\n    ai_response: aiResponse\\n  }\\n}));"},"id":"78631029-8b1d-4af6-abb6-e018cbf126ef","name":"Code - Split for Update","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-strategies","leftValue":"={{ $json.skip }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"3b4be378-0aea-4f24-89a9-13ad394a59aa","name":"IF - Has Strategies","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"operation":"executeQuery","query":"=UPDATE keyword_results \\nSET page_type = '{{ $json.page_type }}',\\n    content_format = '{{ $json.content_format }}',\\n    content_priority = '{{ $json.content_priority }}',\\n    recommended_word_count = {{ $json.recommended_word_count }}\\nWHERE id = {{ $json.keyword_id }}","options":{}},"id":"900e8d0a-b990-4e62-b2f0-a365ece448a2","name":"MySQL - Update Keyword","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[0,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=UPDATE keyword_projects \\nSET status = 'completed'\\nWHERE id = {{ $('Code - Split for Update').first().json.project_id }}","options":{}},"id":"54957ca4-5368-4942-b071-ceb5d9d9a837","name":"MySQL - Update Project Status","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Response hazirla\\nconst firstItem = $('Code - Split for Update').first().json;\\nconst aiResponse = firstItem.ai_response || {};\\nconst allItems = $('Code - Split for Update').all();\\nconst totalUpdated = allItems.filter(i => !i.json.skip).length;\\nconst strategies = aiResponse.keyword_strategies || [];\\n\\n// Stats hesapla\\nconst pillarCount = strategies.filter(s => s.page_type === 'pillar').length;\\nconst clusterCount = strategies.filter(s => s.page_type === 'cluster').length;\\nconst standaloneCount = strategies.filter(s => s.page_type === 'standalone').length;\\nconst highPriority = strategies.filter(s => s.content_priority === 'high').length;\\nconst mediumPriority = strategies.filter(s => s.content_priority === 'medium').length;\\nconst lowPriority = strategies.filter(s => s.content_priority === 'low').length;\\n\\nreturn {\\n  success: true,\\n  message: aiResponse.strategy_summary || `Icerik stratejisi olusturuldu. ${totalUpdated} keyword guncellendi.`,\\n  project_id: firstItem.project_id,\\n  ai_source: firstItem.ai_source,\\n  stats: {\\n    total_keywords: totalUpdated,\\n    pillar_pages: pillarCount,\\n    cluster_pages: clusterCount,\\n    standalone_pages: standaloneCount,\\n    high_priority: highPriority,\\n    medium_priority: mediumPriority,\\n    low_priority: lowPriority\\n  },\\n  pillar_pages: aiResponse.pillar_pages || [],\\n  content_calendar: aiResponse.content_calendar || {},\\n  recommendations: aiResponse.recommendations || []\\n};"},"id":"574bd7d7-2807-4775-bab2-8fd7d2b81963","name":"Code - Prepare Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,112]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"36ad5f8e-3152-4756-9c0c-247c3be3f7a9","name":"Respond - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,112]},{"parameters":{"jsCode":"const data = $input.first().json;\\nconst aiResponse = data.ai_response || {};\\n\\nreturn {\\n  success: true,\\n  message: 'Strateji olusturuldu ancak guncellenecek keyword bulunamadi',\\n  project_id: data.project_id,\\n  ai_source: data.ai_source,\\n  strategy_summary: aiResponse.strategy_summary || '',\\n  recommendations: aiResponse.recommendations || []\\n};"},"id":"ac2ea4ca-cd80-418f-8b7b-c69afcefd04d","name":"Code - No Strategies","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,256]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"da6c27a7-2685-4e2c-aa8b-b2046619d142","name":"Respond - No Strategies","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[224,256]}]	{"Webhook":{"main":[[{"node":"Code - Validate Input","type":"main","index":0}]]},"Code - Validate Input":{"main":[[{"node":"IF - Valid Input","type":"main","index":0}]]},"IF - Valid Input":{"main":[[{"node":"MySQL - Get Project","type":"main","index":0}],[{"node":"Respond - Validation Error","type":"main","index":0}]]},"MySQL - Get Project":{"main":[[{"node":"IF - Project Exists","type":"main","index":0}]]},"IF - Project Exists":{"main":[[{"node":"MySQL - Get System Settings","type":"main","index":0}],[{"node":"Respond - Not Found","type":"main","index":0}]]},"MySQL - Get System Settings":{"main":[[{"node":"MySQL - Get System Prompt","type":"main","index":0}]]},"MySQL - Get System Prompt":{"main":[[{"node":"MySQL - Get Keywords","type":"main","index":0}]]},"MySQL - Get Keywords":{"main":[[{"node":"MySQL - Get Competitors","type":"main","index":0}]]},"MySQL - Get Competitors":{"main":[[{"node":"Code - Prepare AI Prompt","type":"main","index":0}]]},"Code - Prepare AI Prompt":{"main":[[{"node":"IF - Has Keywords","type":"main","index":0}]]},"IF - Has Keywords":{"main":[[{"node":"Code - AI Analysis","type":"main","index":0}],[{"node":"Code - No Keywords","type":"main","index":0}]]},"Code - AI Analysis":{"main":[[{"node":"MySQL - Log Token Usage","type":"main","index":0}]]},"MySQL - Log Token Usage":{"main":[[{"node":"Code - Split for Update","type":"main","index":0}]]},"Code - No Keywords":{"main":[[{"node":"Respond - No Keywords","type":"main","index":0}]]},"Code - Split for Update":{"main":[[{"node":"IF - Has Strategies","type":"main","index":0}]]},"IF - Has Strategies":{"main":[[{"node":"MySQL - Update Keyword","type":"main","index":0}],[{"node":"Code - No Strategies","type":"main","index":0}]]},"MySQL - Update Keyword":{"main":[[{"node":"MySQL - Update Project Status","type":"main","index":0}]]},"MySQL - Update Project Status":{"main":[[{"node":"Code - Prepare Response","type":"main","index":0}]]},"Code - Prepare Response":{"main":[[{"node":"Respond - Success","type":"main","index":0}]]},"Code - No Strategies":{"main":[[{"node":"Respond - No Strategies","type":"main","index":0}]]}}	2025-12-17 10:29:24.428+00	2025-12-17 10:29:24.428+00	{"executionOrder":"v1"}	\N	{}	3acbc191-abbe-4188-85e8-28351da99233	1	dKv529VBvG6GzQ7d	{"templateCredsSetupCompleted":true}	\N	f	18	\N	3acbc191-abbe-4188-85e8-28351da99233
WF-002 Client Prompts CRUD Operations	f	[{"parameters":{"path":"client-prompts/list/:clientId","responseMode":"responseNode","options":{}},"id":"7bd75f15-a536-4430-8380-acd92785cd67","name":"Webhook - List Prompts","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"client-prompts-list"},{"parameters":{"operation":"executeQuery","query":"=SELECT id, client_id, prompt_name, prompt_text, is_active, sort_order, created_at, updated_at FROM client_prompts WHERE client_id = {{ parseInt($json.params.clientId) || 0 }} ORDER BY sort_order ASC, created_at DESC","options":{}},"id":"90f088e7-ab6f-47cc-afce-75da6cebf44b","name":"MySQL - List Prompts","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"data\\": {{ JSON.stringify($input.all().map(i => ({ ...i.json, is_active: i.json.is_active === 1 || i.json.is_active === true }))) }}\\n}","options":{}},"id":"d82e3d49-c8e0-41b7-916f-126dcee0eaed","name":"Respond - List Prompts","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[448,0]},{"parameters":{"httpMethod":"POST","path":"client-prompts/create","responseMode":"responseNode","options":{}},"id":"336d2ab8-937e-459c-a147-1648ccad36ac","name":"Webhook - Create Prompt","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,208],"webhookId":"client-prompts-create"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Check max prompts and prepare insert\\nconst body = $json.body || {};\\nconst clientId = parseInt(body.client_id);\\nconst promptName = body.prompt_name || '';\\nconst promptText = body.prompt_text || '';\\nconst isActive = body.is_active ? 1 : 0;\\n\\nif (!clientId || !promptName || !promptText) {\\n  return { json: { error: 'Missing required fields', valid: false } };\\n}\\n\\nreturn {\\n  json: {\\n    clientId,\\n    promptName,\\n    promptText,\\n    isActive,\\n    valid: true\\n  }\\n};"},"id":"f1f75d49-d1e7-41f0-88e0-864e1bd7015d","name":"Code - Validate Create","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"condition-valid","leftValue":"={{ $json.valid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"020fb845-ebb5-4f3f-8622-7bff49cd9f89","name":"IF - Valid Create","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,208]},{"parameters":{"operation":"executeQuery","query":"=SELECT COUNT(*) as count FROM client_prompts WHERE client_id = {{ $json.clientId }}","options":{}},"id":"b6ba912c-9332-4b24-8ee3-52874e336fd3","name":"MySQL - Check Count","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,144],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Check if under limit and pass data\\nconst count = $json.count || 0;\\nconst MAX_PROMPTS = 10;\\nconst prevData = $('Code - Validate Create').item.json;\\n\\nif (count >= MAX_PROMPTS) {\\n  return { json: { error: `Maximum ${MAX_PROMPTS} prompts allowed`, canCreate: false } };\\n}\\n\\nreturn {\\n  json: {\\n    ...prevData,\\n    canCreate: true\\n  }\\n};"},"id":"ea729d6f-af5c-4546-9420-1aa21b486c1e","name":"Code - Check Limit","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,144]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"condition-can-create","leftValue":"={{ $json.canCreate }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"25b42883-1d61-4b37-9bf7-73d60a27309e","name":"IF - Can Create","type":"n8n-nodes-base.if","typeVersion":2,"position":[1104,144]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO client_prompts (client_id, prompt_name, prompt_text, is_active, sort_order) VALUES ({{ $json.clientId }}, {{ JSON.stringify($json.promptName) }}, {{ JSON.stringify($json.promptText) }}, {{ $json.isActive }}, (SELECT COALESCE(MAX(sort_order), 0) + 1 FROM client_prompts cp WHERE cp.client_id = {{ $json.clientId }}))","options":{}},"id":"2e92704c-49a0-424d-a905-de1862a92ec1","name":"MySQL - Create Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1328,80],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM client_prompts WHERE id = LAST_INSERT_ID()","options":{}},"id":"f7faf58d-cdc9-49f0-81b6-ad14007b01a5","name":"MySQL - Get Created Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1552,80],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"data\\": {{ JSON.stringify({ ...$json, is_active: $json.is_active === 1 }) }},\\n  \\"message\\": \\"Prompt created successfully\\"\\n}","options":{}},"id":"c8dece86-345d-48a9-9642-b8ab9d48c2ad","name":"Respond - Create Prompt","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1760,80]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": {{ JSON.stringify($json.error || 'Cannot create prompt') }}\\n}","options":{"responseCode":400}},"id":"b4ff7bea-821d-4fd2-b5a5-905b34b9acee","name":"Respond - Create Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1328,224]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": {{ JSON.stringify($json.error || 'Invalid request') }}\\n}","options":{"responseCode":400}},"id":"b8524a53-f304-418a-bc55-dcf5d3c9a230","name":"Respond - Invalid Create","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,272]},{"parameters":{"httpMethod":"PUT","path":"client-prompts/update/:id","responseMode":"responseNode","options":{}},"id":"aebd9405-6b52-4da4-95ec-6f9c9fd670f8","name":"Webhook - Update Prompt","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,400],"webhookId":"client-prompts-update"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Build update query\\nconst body = $json.body || {};\\nconst promptId = parseInt($json.params.id);\\n\\nif (!promptId) {\\n  return { json: { error: 'Invalid prompt ID', valid: false } };\\n}\\n\\nconst updates = [];\\nif (body.prompt_name !== undefined) {\\n  updates.push(`prompt_name = ${JSON.stringify(body.prompt_name)}`);\\n}\\nif (body.prompt_text !== undefined) {\\n  updates.push(`prompt_text = ${JSON.stringify(body.prompt_text)}`);\\n}\\nif (body.sort_order !== undefined) {\\n  updates.push(`sort_order = ${parseInt(body.sort_order)}`);\\n}\\n\\nif (updates.length === 0) {\\n  return { json: { error: 'No fields to update', valid: false } };\\n}\\n\\nupdates.push('updated_at = NOW()');\\n\\nreturn {\\n  json: {\\n    promptId,\\n    query: `UPDATE client_prompts SET ${updates.join(', ')} WHERE id = ${promptId}`,\\n    valid: true\\n  }\\n};"},"id":"ec11cfaf-71b4-4a54-9144-a4a1d94ef825","name":"Code - Build Update Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,400]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"condition-valid-update","leftValue":"={{ $json.valid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"59e2f8b2-768e-463e-a370-d73a7563913f","name":"IF - Valid Update","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,400]},{"parameters":{"operation":"executeQuery","query":"={{ $json.query }}","options":{}},"id":"25259415-b74d-486b-8641-507b8fbc4899","name":"MySQL - Update Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,352],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT * FROM client_prompts WHERE id = {{ $('Code - Build Update Prompt').item.json.promptId }}","options":{}},"id":"3a21674a-faff-4d9c-9b52-3fc6725bd50a","name":"MySQL - Get Updated Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[880,352],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": {{ $json.id ? true : false }},\\n  \\"data\\": {{ $json.id ? JSON.stringify({ ...$json, is_active: $json.is_active === 1 }) : 'null' }},\\n  \\"message\\": {{ $json.id ? '\\"Prompt updated successfully\\"' : '\\"Prompt not found\\"' }}\\n}","options":{}},"id":"571d7a52-5632-4fee-a026-2b8432b64b69","name":"Respond - Update Prompt","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1104,352]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": {{ JSON.stringify($json.error || 'Invalid request') }}\\n}","options":{"responseCode":400}},"id":"c1a68bba-3423-466e-a594-6743ac080799","name":"Respond - Invalid Update","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,464]},{"parameters":{"httpMethod":"DELETE","path":"client-prompts/delete/:id","responseMode":"responseNode","options":{}},"id":"caca335a-dd88-4cc9-8501-c37848e77110","name":"Webhook - Delete Prompt","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,608],"webhookId":"client-prompts-delete"},{"parameters":{"operation":"executeQuery","query":"=DELETE FROM client_prompts WHERE id = {{ parseInt($json.params.id) || 0 }}","options":{}},"id":"3cf91a18-4226-47ff-83e4-1f7c05e6c41f","name":"MySQL - Delete Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,608],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"message\\": \\"Prompt deleted successfully\\"\\n}","options":{}},"id":"0a40e276-5c1f-406e-8b7f-6f399a26ef42","name":"Respond - Delete Prompt","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[448,608]},{"parameters":{"httpMethod":"PUT","path":"client-prompts/set-active/:id","responseMode":"responseNode","options":{}},"id":"b1352f7b-34d9-45fb-8f43-4526787f0feb","name":"Webhook - Set Active","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,800],"webhookId":"client-prompts-set-active"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Get prompt ID and client ID\\nconst promptId = parseInt($json.params.id);\\nconst clientId = parseInt($json.body?.client_id);\\n\\nif (!promptId || !clientId) {\\n  return { json: { error: 'Invalid prompt or client ID', valid: false } };\\n}\\n\\nreturn {\\n  json: {\\n    promptId,\\n    clientId,\\n    valid: true\\n  }\\n};"},"id":"a0dc4cb9-eae8-4dab-a5d8-4c505f7c7fa7","name":"Code - Validate Set Active","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,800]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"condition-valid-set-active","leftValue":"={{ $json.valid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"ee137210-2bbe-468f-9919-2f1c0a461471","name":"IF - Valid Set Active","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,800]},{"parameters":{"operation":"executeQuery","query":"=UPDATE client_prompts SET is_active = 0 WHERE client_id = {{ $json.clientId }}","options":{}},"id":"8f1410ce-f65a-4cff-9586-6d21d4aec28c","name":"MySQL - Deactivate All","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,752],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=UPDATE client_prompts SET is_active = 1, updated_at = NOW() WHERE id = {{ $('Code - Validate Set Active').item.json.promptId }}","options":{}},"id":"bb05c1bc-2657-41e5-8716-124a46b15a2d","name":"MySQL - Activate One","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[880,752],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"message\\": \\"Active prompt updated successfully\\"\\n}","options":{}},"id":"03b57618-93bf-44aa-b3dd-0441d6c980b1","name":"Respond - Set Active","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1104,752]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": {{ JSON.stringify($json.error || 'Invalid request') }}\\n}","options":{"responseCode":400}},"id":"dbaf24fa-852f-4a99-901b-716270a53219","name":"Respond - Invalid Set Active","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,864]},{"parameters":{"path":"client-prompts/active/:clientId","responseMode":"responseNode","options":{}},"id":"7a26b56d-c29f-4c4d-b38e-cc9e524550ca","name":"Webhook - Get Active Prompt","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,1008],"webhookId":"client-prompts-get-active"},{"parameters":{"operation":"executeQuery","query":"=SELECT id, client_id, prompt_name, prompt_text, is_active, sort_order, created_at, updated_at FROM client_prompts WHERE client_id = {{ parseInt($json.params.clientId) || 0 }} AND is_active = 1 LIMIT 1","options":{}},"id":"b918d4a3-19ec-46e3-befd-9f41787dc38c","name":"MySQL - Get Active Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,1008],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": {{ $json.id ? true : false }},\\n  \\"data\\": {{ $json.id ? JSON.stringify({ ...$json, is_active: true }) : 'null' }},\\n  \\"message\\": {{ $json.id ? '\\"Active prompt found\\"' : '\\"No active prompt found\\"' }}\\n}","options":{}},"id":"bc07c573-de42-4822-94e2-c8ba06be9e55","name":"Respond - Get Active","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[448,1008]}]	{"Webhook - List Prompts":{"main":[[{"node":"MySQL - List Prompts","type":"main","index":0}]]},"MySQL - List Prompts":{"main":[[{"node":"Respond - List Prompts","type":"main","index":0}]]},"Webhook - Create Prompt":{"main":[[{"node":"Code - Validate Create","type":"main","index":0}]]},"Code - Validate Create":{"main":[[{"node":"IF - Valid Create","type":"main","index":0}]]},"IF - Valid Create":{"main":[[{"node":"MySQL - Check Count","type":"main","index":0}],[{"node":"Respond - Invalid Create","type":"main","index":0}]]},"MySQL - Check Count":{"main":[[{"node":"Code - Check Limit","type":"main","index":0}]]},"Code - Check Limit":{"main":[[{"node":"IF - Can Create","type":"main","index":0}]]},"IF - Can Create":{"main":[[{"node":"MySQL - Create Prompt","type":"main","index":0}],[{"node":"Respond - Create Error","type":"main","index":0}]]},"MySQL - Create Prompt":{"main":[[{"node":"MySQL - Get Created Prompt","type":"main","index":0}]]},"MySQL - Get Created Prompt":{"main":[[{"node":"Respond - Create Prompt","type":"main","index":0}]]},"Webhook - Update Prompt":{"main":[[{"node":"Code - Build Update Prompt","type":"main","index":0}]]},"Code - Build Update Prompt":{"main":[[{"node":"IF - Valid Update","type":"main","index":0}]]},"IF - Valid Update":{"main":[[{"node":"MySQL - Update Prompt","type":"main","index":0}],[{"node":"Respond - Invalid Update","type":"main","index":0}]]},"MySQL - Update Prompt":{"main":[[{"node":"MySQL - Get Updated Prompt","type":"main","index":0}]]},"MySQL - Get Updated Prompt":{"main":[[{"node":"Respond - Update Prompt","type":"main","index":0}]]},"Webhook - Delete Prompt":{"main":[[{"node":"MySQL - Delete Prompt","type":"main","index":0}]]},"MySQL - Delete Prompt":{"main":[[{"node":"Respond - Delete Prompt","type":"main","index":0}]]},"Webhook - Set Active":{"main":[[{"node":"Code - Validate Set Active","type":"main","index":0}]]},"Code - Validate Set Active":{"main":[[{"node":"IF - Valid Set Active","type":"main","index":0}]]},"IF - Valid Set Active":{"main":[[{"node":"MySQL - Deactivate All","type":"main","index":0}],[{"node":"Respond - Invalid Set Active","type":"main","index":0}]]},"MySQL - Deactivate All":{"main":[[{"node":"MySQL - Activate One","type":"main","index":0}]]},"MySQL - Activate One":{"main":[[{"node":"Respond - Set Active","type":"main","index":0}]]},"Webhook - Get Active Prompt":{"main":[[{"node":"MySQL - Get Active Prompt","type":"main","index":0}]]},"MySQL - Get Active Prompt":{"main":[[{"node":"Respond - Get Active","type":"main","index":0}]]}}	2025-12-17 10:32:30.381+00	2025-12-21 10:58:13.012+00	{"executionOrder":"v1"}	\N	{}	9dc5a4f7-aab6-404a-8959-11eebca030c0	0	xqZA3Veie70f1PZI	{"templateCredsSetupCompleted":true}	\N	t	2	\N	\N
WF-005 Sheets Write	t	[{"parameters":{"httpMethod":"POST","path":"sheets-write","responseMode":"responseNode","options":{}},"id":"8d4ff474-5958-4307-abfb-4ec63c7cae04","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-848,128],"webhookId":"sheets-write"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const body = $json.body || {};\\nconst mappings = body.column_mappings || {};\\nconst data = body.data || [];\\nconst writeMode = body.write_mode || 'append';\\nconst includeHeaders = body.include_headers !== false;\\nconst targetRow = body.target_row || 2;\\nconst targetColumn = body.target_column || 'A';\\nconst appendSeparator = body.append_separator || ', ';\\nconst sheetGid = body.sheet_gid || 0;\\n\\n// Get column letters sorted\\nconst columns = Object.entries(mappings).sort((a, b) => a[1].localeCompare(b[1]));\\nconst firstCol = columns[0]?.[1] || 'A';\\nconst lastCol = columns[columns.length - 1]?.[1] || 'A';\\n\\n// Build values array for Sheets API\\nconst values = [];\\n\\n// Add headers if needed (only for replace mode)\\nif (includeHeaders && writeMode === 'replace') {\\n  const headerRow = [];\\n  const labels = {\\n    keyword: 'Anahtar Kelime',\\n    search_volume: 'Arama Hacmi',\\n    keyword_difficulty: 'Zorluk',\\n    cpc: 'CPC',\\n    competition: 'Rekabet',\\n    search_intent: 'Arama Niyeti',\\n    opportunity_score: 'Frsat Skoru',\\n    ai_category: 'AI Kategori'\\n  };\\n  for (const [field, col] of columns) {\\n    headerRow.push(labels[field] || field);\\n  }\\n  values.push(headerRow);\\n}\\n\\n// Add data rows\\nfor (const item of data) {\\n  const row = [];\\n  for (const [field, col] of columns) {\\n    const val = item[field];\\n    row.push(val !== null && val !== undefined ? String(val) : '');\\n  }\\n  values.push(row);\\n}\\n\\n// Calculate ranges\\nconst dataEndRow = values.length;\\nconst exactRange = `${body.sheet_name}!${firstCol}1:${lastCol}${dataEndRow}`;\\nconst targetCellRange = `${body.sheet_name}!${targetColumn}${targetRow}`;\\nconst targetRowRange = `${body.sheet_name}!${firstCol}${targetRow}:${lastCol}${targetRow}`;\\n\\nreturn { json: {\\n  spreadsheet_id: body.spreadsheet_id,\\n  sheet_name: body.sheet_name,\\n  sheet_gid: sheetGid,\\n  exact_range: exactRange,\\n  target_cell_range: targetCellRange,\\n  target_row_range: targetRowRange,\\n  target_row: targetRow,\\n  target_column: targetColumn,\\n  append_separator: appendSeparator,\\n  values: values,\\n  single_row_values: values.length > 0 ? [values[0]] : [],\\n  new_cell_value: data[0] ? String(data[0][Object.keys(data[0])[0]] || '') : '',\\n  write_mode: writeMode,\\n  row_count: data.length\\n}};"},"id":"1d59bfd0-f5b2-4450-984b-2ed17aa09649","name":"Prepare Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-640,128]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.write_mode }}","rightValue":"replace","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.write_mode }}","rightValue":"append","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.write_mode }}","rightValue":"update_cell","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.write_mode }}","rightValue":"insert_row","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.write_mode }}","rightValue":"update_row","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true}]},"options":{"fallbackOutput":"none"}},"id":"cd4715dc-3942-4408-b836-d068eba995cb","name":"Switch","type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-416,128]},{"parameters":{"method":"POST","url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.sheet_name) }}!A:Z:clear","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","options":{}},"id":"e5a7ef64-c72f-4b85-8a94-03ed5bf00307","name":"Clear Sheet","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-192,-80],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"return { json: $('Prepare Data').item.json };"},"id":"8967955f-b832-42da-9866-065860bb3f15","name":"Restore (Replace)","type":"n8n-nodes-base.code","typeVersion":2,"position":[32,-80]},{"parameters":{"method":"PUT","url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.exact_range) }}?valueInputOption=USER_ENTERED","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ range: $json.exact_range, values: $json.values }) }}","options":{}},"id":"10045661-0791-4b97-aba0-2c8bbbd9b771","name":"Write (Replace)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[256,-80],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"method":"POST","url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.sheet_name) }}:append?valueInputOption=USER_ENTERED","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ values: $json.values }) }}","options":{}},"id":"0b97953a-b970-4269-aac8-bb828cdcd0b5","name":"Write (Append)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-192,48],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.target_cell_range) }}","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","options":{}},"id":"37526215-fba3-48e5-b8fe-5be1b54a496b","name":"Get Cell","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-192,160],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const prepData = $('Prepare Data').item.json;\\nconst currentValues = $json.values || [['']];\\nconst currentValue = currentValues[0]?.[0] || '';\\nconst newValue = prepData.new_cell_value;\\nconst separator = prepData.append_separator;\\n\\nconst updatedValue = currentValue ? `${currentValue}${separator}${newValue}` : newValue;\\n\\nreturn { json: {\\n  ...prepData,\\n  updated_cell_value: updatedValue\\n}};"},"id":"d3cefad5-fe4a-44f9-a9e4-b6a054e89b5c","name":"Merge Cell Value","type":"n8n-nodes-base.code","typeVersion":2,"position":[32,160]},{"parameters":{"method":"PUT","url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.target_cell_range) }}?valueInputOption=USER_ENTERED","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ values: [[$json.updated_cell_value]] }) }}","options":{}},"id":"e9ddff7e-12e4-4e56-b8b6-ebf016df7998","name":"Write Cell","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[256,160],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"method":"POST","url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}:batchUpdate","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ requests: [{ insertDimension: { range: { sheetId: $json.sheet_gid, dimension: 'ROWS', startIndex: $json.target_row - 1, endIndex: $json.target_row }, inheritFromBefore: false } }] }) }}","options":{}},"id":"bf651abb-e4ee-4625-9b5a-1a61f9d0ba9c","name":"Insert Row","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-192,288],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"return { json: $('Prepare Data').item.json };"},"id":"da3219a5-2e6f-4fa6-ad7e-1aa421577a1a","name":"Restore (Insert)","type":"n8n-nodes-base.code","typeVersion":2,"position":[32,288]},{"parameters":{"method":"PUT","url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.target_row_range) }}?valueInputOption=USER_ENTERED","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ values: $json.single_row_values }) }}","options":{}},"id":"30c2d38f-aaa4-4ffd-ad20-69b26bcc76a1","name":"Write Inserted Row","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[256,288],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"method":"PUT","url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.target_row_range) }}?valueInputOption=USER_ENTERED","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ values: $json.single_row_values }) }}","options":{}},"id":"18e2b9e1-95b0-4a14-a353-7b02c142704e","name":"Write (Update Row)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-192,400],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const prepData = $('Prepare Data').item.json;\\nreturn { json: { success: true, mode: prepData.write_mode, rows_written: prepData.row_count, spreadsheet_url: `https://docs.google.com/spreadsheets/d/${prepData.spreadsheet_id}` }};"},"id":"cce93c04-f354-4ca8-9935-afec7bf54dc9","name":"Format (Replace)","type":"n8n-nodes-base.code","typeVersion":2,"position":[480,-80]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const prepData = $('Prepare Data').item.json;\\nreturn { json: { success: true, mode: prepData.write_mode, rows_written: prepData.row_count, spreadsheet_url: `https://docs.google.com/spreadsheets/d/${prepData.spreadsheet_id}` }};"},"id":"45e1cbe9-5843-462e-8e7b-1a9820a7a5f2","name":"Format (Append)","type":"n8n-nodes-base.code","typeVersion":2,"position":[32,48]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const prepData = $('Prepare Data').item.json;\\nreturn { json: { success: true, mode: prepData.write_mode, cell: prepData.target_cell_range, new_value: $json.updated_cell_value || prepData.updated_cell_value, spreadsheet_url: `https://docs.google.com/spreadsheets/d/${prepData.spreadsheet_id}` }};"},"id":"331ee645-2916-4170-b492-86ce7e47caee","name":"Format (Cell)","type":"n8n-nodes-base.code","typeVersion":2,"position":[480,160]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const prepData = $('Prepare Data').item.json;\\nreturn { json: { success: true, mode: prepData.write_mode, inserted_at_row: prepData.target_row, spreadsheet_url: `https://docs.google.com/spreadsheets/d/${prepData.spreadsheet_id}` }};"},"id":"93ad50d0-ad7e-4a0a-801b-1e480b34cb2d","name":"Format (Insert)","type":"n8n-nodes-base.code","typeVersion":2,"position":[480,288]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const prepData = $('Prepare Data').item.json;\\nreturn { json: { success: true, mode: prepData.write_mode, updated_row: prepData.target_row, spreadsheet_url: `https://docs.google.com/spreadsheets/d/${prepData.spreadsheet_id}` }};"},"id":"f1cdd163-000f-4cff-9e54-bd7b418f4178","name":"Format (Update Row)","type":"n8n-nodes-base.code","typeVersion":2,"position":[32,400]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"3bc72137-4855-4747-8810-b21af90be895","name":"Respond (Replace)","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[688,-80]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"5b0a5aad-9466-41e2-9e67-89fe113bdf1f","name":"Respond (Append)","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[256,48]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"1c1b780e-f730-4181-b9d4-b1dd9698b757","name":"Respond (Cell)","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[688,160]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"00648ef0-0abc-458f-bf31-ea19047cff2b","name":"Respond (Insert)","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[688,288]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"016a6a38-2cbf-4ba3-8a73-441da44fb046","name":"Respond (Update Row)","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[256,400]}]	{"Webhook":{"main":[[{"node":"Prepare Data","type":"main","index":0}]]},"Prepare Data":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Clear Sheet","type":"main","index":0}],[{"node":"Write (Append)","type":"main","index":0}],[{"node":"Get Cell","type":"main","index":0}],[{"node":"Insert Row","type":"main","index":0}],[{"node":"Write (Update Row)","type":"main","index":0}]]},"Clear Sheet":{"main":[[{"node":"Restore (Replace)","type":"main","index":0}]]},"Restore (Replace)":{"main":[[{"node":"Write (Replace)","type":"main","index":0}]]},"Write (Replace)":{"main":[[{"node":"Format (Replace)","type":"main","index":0}]]},"Format (Replace)":{"main":[[{"node":"Respond (Replace)","type":"main","index":0}]]},"Write (Append)":{"main":[[{"node":"Format (Append)","type":"main","index":0}]]},"Format (Append)":{"main":[[{"node":"Respond (Append)","type":"main","index":0}]]},"Get Cell":{"main":[[{"node":"Merge Cell Value","type":"main","index":0}]]},"Merge Cell Value":{"main":[[{"node":"Write Cell","type":"main","index":0}]]},"Write Cell":{"main":[[{"node":"Format (Cell)","type":"main","index":0}]]},"Format (Cell)":{"main":[[{"node":"Respond (Cell)","type":"main","index":0}]]},"Insert Row":{"main":[[{"node":"Restore (Insert)","type":"main","index":0}]]},"Restore (Insert)":{"main":[[{"node":"Write Inserted Row","type":"main","index":0}]]},"Write Inserted Row":{"main":[[{"node":"Format (Insert)","type":"main","index":0}]]},"Format (Insert)":{"main":[[{"node":"Respond (Insert)","type":"main","index":0}]]},"Write (Update Row)":{"main":[[{"node":"Format (Update Row)","type":"main","index":0}]]},"Format (Update Row)":{"main":[[{"node":"Respond (Update Row)","type":"main","index":0}]]}}	2025-12-18 11:34:23.86+00	2025-12-19 11:35:01.569+00	{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false}	\N	{}	84895dcd-2a4c-4e92-9732-63bbfa0d1557	1	k21swmfiM5y9Dspc	{"templateCredsSetupCompleted":true}	\N	f	40	\N	84895dcd-2a4c-4e92-9732-63bbfa0d1557
WF-006 Sheets Get Cell	t	[{"parameters":{"httpMethod":"POST","path":"sheets-get-cell","responseMode":"responseNode","options":{}},"id":"9bae26d1-993a-4112-8a13-46953bde139d","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"sheets-get-cell"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const body = $json.body || {};\\nconst spreadsheetId = body.spreadsheet_id;\\nconst sheetName = body.sheet_name;\\nconst row = body.row || 1;\\nconst column = body.column || 'A';\\n\\nif (!spreadsheetId || !sheetName) {\\n  return { json: { success: false, error: 'spreadsheet_id ve sheet_name gerekli' } };\\n}\\n\\nconst cellRange = `${sheetName}!${column}${row}`;\\n\\nreturn { json: {\\n  spreadsheet_id: spreadsheetId,\\n  sheet_name: sheetName,\\n  row,\\n  column,\\n  cell_range: cellRange\\n}};"},"id":"83cc90d3-eaca-4a58-9a82-e06a3b4db8ae","name":"Prepare","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.cell_range) }}","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","options":{}},"id":"7a7bca6b-d76d-469c-8ea1-b80c0c2413ce","name":"Get Cell","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[448,0],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const prepData = $('Prepare').item.json;\\nconst response = $json;\\nconst values = response.values || [['']];\\nconst cellValue = values[0]?.[0] || '';\\n\\nreturn { json: {\\n  success: true,\\n  value: cellValue,\\n  cell: prepData.cell_range\\n}};"},"id":"068baa03-07b9-4ced-946d-88ee1fa4c2af","name":"Format","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"c04cae19-bf61-4453-9470-8fbea03d95d2","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[880,0]}]	{"Webhook":{"main":[[{"node":"Prepare","type":"main","index":0}]]},"Prepare":{"main":[[{"node":"Get Cell","type":"main","index":0}]]},"Get Cell":{"main":[[{"node":"Format","type":"main","index":0}]]},"Format":{"main":[[{"node":"Respond","type":"main","index":0}]]}}	2025-12-19 11:59:31.784+00	2025-12-19 11:59:31.915+00	{"executionOrder":"v1"}	\N	{}	c181632c-c3a2-4b27-99f2-001a4be7c06f	1	IoTg8e61J99uOFka	\N	\N	f	9	\N	c181632c-c3a2-4b27-99f2-001a4be7c06f
WF-BULK-KEYWORD: Main Controller	f	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"7a4686a8-c032-49ac-8603-2e91eeb6fc03","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-656,112],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"const body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\n\\nif (!Array.isArray(keywords) || keywords.length === 0) {\\n  return [{json: {error: 'keywords array required', code: 400}}];\\n}\\n\\nconst seeds = keywords\\n  .map(k => String(k).trim().toLowerCase())\\n  .filter(k => k.length >= 2)\\n  .slice(0, 20);\\n\\nif (seeds.length === 0) {\\n  return [{json: {error: 'valid keywords required', code: 400}}];\\n}\\n\\nconst locCodes = {TR: 2792, US: 2840, GB: 2826, DE: 2276};\\n\\n// Clear static data for fresh run\\nconst ctx = $getWorkflowStaticData('global');\\nctx.results = [];\\nctx.projectId = projectId ? parseInt(projectId) : null;\\nctx.clientId = clientId ? parseInt(clientId) : null;\\nctx.startTime = Date.now();\\nctx.totalSeeds = seeds.length;\\n\\n// Return each seed as separate item\\nreturn seeds.map(seed => ({\\n  json: {\\n    seed,\\n    locationCode: locCodes[country] || 2792,\\n    language\\n  }\\n}));"},"id":"e00aa475-179b-4157-bf38-b4d274937271","name":"Validate","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"options":{}},"id":"84410ee5-19a9-47fb-9197-545c7da900c0","name":"Loop Seeds","type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-224,112]},{"parameters":{"workflowId":{"__rl":true,"mode":"id","value":"MhHeIUZBSMtqRRrR"},"options":{}},"id":"467d2bcd-e6d2-467c-b0a1-da31ba66bcbb","name":"Process Seed","type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[0,0]},{"parameters":{"jsCode":"const result = $input.first().json;\\n\\n// Accumulate results in static data\\nconst ctx = $getWorkflowStaticData('global');\\nif (!ctx.results) ctx.results = [];\\n\\nctx.results.push({\\n  seed: result.seed,\\n  approved: result.approved || [],\\n  rejected: result.rejected || [],\\n  stats: result.stats || {approved: 0, rejected: 0}\\n});\\n\\nreturn [{json: {accumulated: ctx.results.length}}];"},"id":"f416ec62-fbdc-49a6-ad95-eb1d9120c79a","name":"Accumulate","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"jsCode":"const ctx = $getWorkflowStaticData('global');\\nconst results = ctx.results || [];\\nconst projectId = ctx.projectId;\\nconst clientId = ctx.clientId;\\nconst startTime = ctx.startTime;\\nconst totalSeeds = ctx.totalSeeds;\\n\\n// Combine all results\\nconst allApproved = [];\\nconst allRejected = [];\\nconst perSeed = {};\\n\\nresults.forEach(r => {\\n  allApproved.push(...(r.approved || []));\\n  allRejected.push(...(r.rejected || []));\\n  perSeed[r.seed] = r.stats;\\n});\\n\\n// Clear static data\\ndelete ctx.results;\\ndelete ctx.projectId;\\ndelete ctx.clientId;\\ndelete ctx.startTime;\\ndelete ctx.totalSeeds;\\n\\nreturn [{json: {\\n  projectId,\\n  clientId,\\n  stats: {\\n    total_seeds: totalSeeds,\\n    total_approved: allApproved.length,\\n    total_rejected: allRejected.length,\\n    per_seed: perSeed\\n  },\\n  approved_keywords: allApproved,\\n  rejected_keywords: allRejected,\\n  startTime\\n}}];"},"id":"9df0fd50-cbc1-4670-b30d-4bd75f83920c","name":"Finalize","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,304]},{"parameters":{"conditions":{"options":{"leftValue":"","typeValidation":"loose"},"conditions":[{"leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}]},"options":{}},"id":"5e518832-eeb2-44cd-88a3-f92b63aa3c73","name":"IF DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[224,304]},{"parameters":{"jsCode":"const d = $input.first().json;\\nconst all = [...(d.approved_keywords || []), ...(d.rejected_keywords || [])];\\n\\nif (!all.length || !d.projectId) {\\n  return [{json: {...d, query: 'SELECT 1'}}];\\n}\\n\\nconst esc = s => s == null ? 'NULL' : \\"'\\" + String(s).replace(/'/g, \\"''\\") + \\"'\\";\\n\\nconst vals = all.slice(0, 2000).map(k => \\n  `(${d.projectId},${esc(k.keyword)},${esc(k.seed_keyword)},'related',${k.search_volume || 'NULL'},${k.cpc || 'NULL'},NULL,NULL,${esc(k.seed_keyword)},${esc(k.priority || 'medium')},'cluster','dataforseo','${k.status}',NULL)`\\n).join(',');\\n\\nconst query = `INSERT INTO keyword_results(project_id,keyword,seed_keyword,keyword_type,search_volume,cpc,competition,search_intent,keyword_cluster,content_priority,page_type,source,status,reject_reason) VALUES ${vals} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume),status=VALUES(status),seed_keyword=VALUES(seed_keyword)`;\\n\\nreturn [{json: {...d, query}}];"},"id":"8b70f825-ef2e-4d4e-bcda-2a2ec3ed6b0f","name":"Build SQL","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,208]},{"parameters":{"operation":"executeQuery","query":"={{ $json.query }}","options":{}},"id":"78f44e52-56f6-40de-b182-4d70964b37bb","name":"MySQL","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const d = $('Build SQL').first().json;\\nreturn [{json: {\\n  success: true,\\n  message: `Bulk tamamlandi: ${d.approved_keywords?.length || 0} ana sonuc, ${d.rejected_keywords?.length || 0} diger`,\\n  project_id: d.projectId,\\n  stats: d.stats,\\n  keywords: (d.approved_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume,\\n    priority: k.priority,\\n    status: k.status\\n  })),\\n  rejected_keywords: (d.rejected_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume\\n  })),\\n  processing_time_ms: Date.now() - d.startTime\\n}}];"},"id":"abeac08c-751c-4558-9b77-7c35715baefe","name":"Response DB","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,208]},{"parameters":{"jsCode":"const d = $input.first().json;\\nreturn [{json: {\\n  success: true,\\n  message: `Bulk tamamlandi: ${d.approved_keywords?.length || 0} ana sonuc, ${d.rejected_keywords?.length || 0} diger`,\\n  project_id: null,\\n  stats: d.stats,\\n  keywords: (d.approved_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume,\\n    priority: k.priority,\\n    status: k.status\\n  })),\\n  rejected_keywords: (d.rejected_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume\\n  })),\\n  processing_time_ms: Date.now() - d.startTime\\n}}];"},"id":"c23881c5-dc7d-4f9d-bf66-4d48b199d8a4","name":"Response No DB","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,400]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"4ca429dc-b6c8-44a3-870e-aba7b21191fd","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1104,304]}]	{"Webhook":{"main":[[{"node":"Validate","type":"main","index":0}]]},"Validate":{"main":[[{"node":"Loop Seeds","type":"main","index":0}]]},"Loop Seeds":{"main":[[{"node":"Process Seed","type":"main","index":0}],[{"node":"Finalize","type":"main","index":0}]]},"Process Seed":{"main":[[{"node":"Accumulate","type":"main","index":0}]]},"Accumulate":{"main":[[{"node":"Loop Seeds","type":"main","index":0}]]},"Finalize":{"main":[[{"node":"IF DB","type":"main","index":0}]]},"IF DB":{"main":[[{"node":"Build SQL","type":"main","index":0}],[{"node":"Response No DB","type":"main","index":0}]]},"Build SQL":{"main":[[{"node":"MySQL","type":"main","index":0}]]},"MySQL":{"main":[[{"node":"Response DB","type":"main","index":0}]]},"Response DB":{"main":[[{"node":"Respond","type":"main","index":0}]]},"Response No DB":{"main":[[{"node":"Respond","type":"main","index":0}]]}}	2025-12-23 19:37:09.381+00	2025-12-23 19:54:52.515+00	{"executionOrder":"v1"}	{"global":{}}	{}	35582cc8-1c65-48eb-a9bf-1cb91e70932b	1	sWwmP23m89DQTpVI	\N	\N	t	9	\N	\N
WF-BULK-KEYWORD: Main v3	t	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"2adab057-4eef-4a13-ae8f-af68dd9fa417","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1104,112],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"const body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\n\\nif (!Array.isArray(keywords) || keywords.length === 0) {\\n  return [{json: {error: 'keywords array required', code: 400}}];\\n}\\n\\nconst seeds = keywords\\n  .map(k => String(k).trim().toLowerCase())\\n  .filter(k => k.length >= 2)\\n  .slice(0, 20);\\n\\nif (seeds.length === 0) {\\n  return [{json: {error: 'valid keywords required', code: 400}}];\\n}\\n\\nconst locCodes = {TR: 2792, US: 2840, GB: 2826, DE: 2276};\\nconst locationCode = locCodes[country] || 2792;\\n\\n// Return each seed as separate item for sequential processing\\nreturn seeds.map((seed, idx) => ({\\n  json: {\\n    seed,\\n    seedIndex: idx,\\n    totalSeeds: seeds.length,\\n    locationCode,\\n    language,\\n    projectId: projectId ? parseInt(projectId) : null,\\n    clientId: clientId ? parseInt(clientId) : null,\\n    startTime: Date.now()\\n  }\\n}));"},"id":"becf9734-d29b-4df3-be6c-0704c5c8d26d","name":"Validate","type":"n8n-nodes-base.code","typeVersion":2,"position":[-880,112]},{"parameters":{"method":"POST","url":"http://localhost:5678/webhook/process-single-seed","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"seed\\": \\"{{ $json.seed }}\\",\\n  \\"locationCode\\": {{ $json.locationCode }},\\n  \\"language\\": \\"{{ $json.language }}\\"\\n}","options":{"batching":{"batch":{"batchSize":1}},"timeout":120000}},"id":"4ba38dc6-1bf0-4661-8f82-586d3d0b2f22","name":"Process Seeds","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-656,112],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const items = $input.all();\\nconst firstItem = $('Validate').first().json;\\nconst projectId = firstItem.projectId;\\nconst clientId = firstItem.clientId;\\nconst startTime = firstItem.startTime;\\nconst totalSeeds = firstItem.totalSeeds;\\n\\n// Combine all results\\nconst allApproved = [];\\nconst allRejected = [];\\nconst perSeed = {};\\n\\nitems.forEach(item => {\\n  const r = item.json;\\n  if (r.seed) {\\n    allApproved.push(...(r.approved || []));\\n    allRejected.push(...(r.rejected || []));\\n    perSeed[r.seed] = r.stats || {approved: 0, rejected: 0};\\n  }\\n});\\n\\nreturn [{json: {\\n  projectId,\\n  clientId,\\n  stats: {\\n    total_seeds: totalSeeds,\\n    total_approved: allApproved.length,\\n    total_rejected: allRejected.length,\\n    per_seed: perSeed\\n  },\\n  approved_keywords: allApproved,\\n  rejected_keywords: allRejected,\\n  startTime\\n}}];"},"id":"a451da23-76a2-4931-9a84-3be0075aaad9","name":"Combine Results","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"leftValue":"","typeValidation":"loose"},"conditions":[{"leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}]},"options":{}},"id":"da0f4753-a4e0-4002-905d-b99ad94c656e","name":"IF DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"jsCode":"const d = $input.first().json;\\nconst all = [...(d.approved_keywords || []), ...(d.rejected_keywords || [])];\\n\\nif (!all.length || !d.projectId) {\\n  return [{json: {...d, query: 'SELECT 1'}}];\\n}\\n\\nconst esc = s => s == null ? 'NULL' : \\"'\\" + String(s).replace(/'/g, \\"''\\") + \\"'\\";\\n\\nconst vals = all.slice(0, 2000).map(k => \\n  `(${d.projectId},${esc(k.keyword)},${esc(k.seed_keyword)},'related',${k.search_volume || 'NULL'},${k.cpc || 'NULL'},NULL,NULL,${esc(k.seed_keyword)},${esc(k.priority || 'medium')},'cluster','dataforseo','${k.status}',NULL)`\\n).join(',');\\n\\nconst query = `INSERT INTO keyword_results(project_id,keyword,seed_keyword,keyword_type,search_volume,cpc,competition,search_intent,keyword_cluster,content_priority,page_type,source,status,reject_reason) VALUES ${vals} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume),status=VALUES(status),seed_keyword=VALUES(seed_keyword)`;\\n\\nreturn [{json: {...d, query}}];"},"id":"715e6537-fe87-4c8f-bda3-27eb89b1fb9f","name":"Build SQL","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,0]},{"parameters":{"operation":"executeQuery","query":"={{ $json.query }}","options":{}},"id":"f6b45fef-46b6-4f95-9506-cc3efa23d542","name":"MySQL","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const d = $('Build SQL').first().json;\\nreturn [{json: {\\n  success: true,\\n  message: `Bulk tamamlandi: ${d.approved_keywords?.length || 0} ana sonuc, ${d.rejected_keywords?.length || 0} diger`,\\n  project_id: d.projectId,\\n  stats: d.stats,\\n  keywords: (d.approved_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume,\\n    priority: k.priority,\\n    status: k.status\\n  })),\\n  rejected_keywords: (d.rejected_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume\\n  })),\\n  processing_time_ms: Date.now() - d.startTime\\n}}];"},"id":"7b5864a2-74a7-4d92-b6a7-58e2bbbe34b5","name":"Response DB","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"jsCode":"const d = $input.first().json;\\nreturn [{json: {\\n  success: true,\\n  message: `Bulk tamamlandi: ${d.approved_keywords?.length || 0} ana sonuc, ${d.rejected_keywords?.length || 0} diger`,\\n  project_id: null,\\n  stats: d.stats,\\n  keywords: (d.approved_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume,\\n    priority: k.priority,\\n    status: k.status\\n  })),\\n  rejected_keywords: (d.rejected_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume\\n  })),\\n  processing_time_ms: Date.now() - d.startTime\\n}}];"},"id":"b79fbb1d-a38d-41e3-8b4a-c34973da5de8","name":"Response No DB","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,208]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"5bf30999-d066-4061-8398-4da68ad6edfe","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,112]}]	{"Webhook":{"main":[[{"node":"Validate","type":"main","index":0}]]},"Validate":{"main":[[{"node":"Process Seeds","type":"main","index":0}]]},"Process Seeds":{"main":[[{"node":"Combine Results","type":"main","index":0}]]},"Combine Results":{"main":[[{"node":"IF DB","type":"main","index":0}]]},"IF DB":{"main":[[{"node":"Build SQL","type":"main","index":0}],[{"node":"Response No DB","type":"main","index":0}]]},"Build SQL":{"main":[[{"node":"MySQL","type":"main","index":0}]]},"MySQL":{"main":[[{"node":"Response DB","type":"main","index":0}]]},"Response DB":{"main":[[{"node":"Respond","type":"main","index":0}]]},"Response No DB":{"main":[[{"node":"Respond","type":"main","index":0}]]}}	2025-12-23 19:55:15.963+00	2025-12-23 20:03:37.514+00	{"executionOrder":"v1"}	{"global":{"locationCode":2792,"language":"tr"}}	{}	3f0ba1a2-c731-440b-963c-87cb5361b2c7	1	wl9T4eOGoazJkDdv	\N	\N	f	6	\N	3f0ba1a2-c731-440b-963c-87cb5361b2c7
WF-BULK-KEYWORD: Single Seed v2	t	[{"parameters":{"httpMethod":"POST","path":"process-single-seed","responseMode":"lastNode","options":{}},"id":"2408578d-b210-43cc-9b8f-698ccad87cca","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"process-single-seed"},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\"keywords\\": [\\"{{ $json.body.seed }}\\"], \\"location_code\\": {{ $json.body.locationCode }}, \\"language_code\\": \\"{{ $json.body.language }}\\", \\"include_seed_keyword\\": true, \\"sort_by\\": \\"search_volume\\"}]","options":{"timeout":60000}},"id":"b666eeba-78a1-47d4-a474-dbbff4ae8bc8","name":"DataForSEO","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[224,0],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const input = $('Webhook').first().json.body;\\nconst dfs = $input.first().json;\\nconst seed = input.seed;\\n\\nlet keywords = [];\\ntry {\\n  if (dfs?.tasks?.[0]?.result) {\\n    keywords = dfs.tasks[0].result.map(k => ({\\n      kw: (k.keyword || '').toLowerCase().trim(),\\n      vol: k.search_volume || 0,\\n      cpc: k.cpc || 0\\n    })).filter(k => k.kw.length >= 2);\\n  }\\n} catch(e) {}\\n\\n// Dedupe\\nconst seen = new Set();\\nconst unique = keywords.filter(k => {\\n  if (seen.has(k.kw)) return false;\\n  seen.add(k.kw);\\n  return true;\\n}).slice(0, 500);\\n\\nif (unique.length === 0) {\\n  return [{json: {\\n    seed,\\n    approved: [],\\n    rejected: [],\\n    stats: {approved: 0, rejected: 0}\\n  }}];\\n}\\n\\nconst kwList = unique.map((k, i) => `${i+1}|${k.kw}|${k.vol}`).join('\\\\n');\\n\\nconst prompt = `\\"${seed}\\" icin anahtar kelime analizi.\\n\\nKEYWORDS (no|keyword|volume):\\n${kwList}\\n\\nGOREV: Icerik olusturmaya EN UYGUN 35 keyword sec.\\n\\nSECIM KRITERLERI:\\n- Blog/makale/rehber yazilabilir mi?\\n- Kullaniciya deger katan bilgi iceriyor mu?\\n- Arama amaci bilgi edinme mi?\\n\\nSECME (ama DIGER'de goster):\\n- Marka+model kombinasyonlari (nike air max 90)\\n- Fiyat/satin alma sorgulari\\n- Cok genel tek kelimeler\\n\\nONEMLI: Sadece CONTENT listesi ver. Geri kalan TUM keywordler otomatik DIGER olarak kaydedilecek.\\n\\nCIKTI FORMATI (TEK SATIR):\\nCONTENT:1,5,8,12,15,23,45,67\\n\\nACIKLAMA YAZMA. SADECE NUMARALAR.`;\\n\\nreturn [{json: {seed, keywords: unique, prompt}}];"},"id":"3f6b3573-5cd6-4d65-8363-f1a2b72d631f","name":"Parse DFS","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\"contents\\":[{\\"parts\\":[{\\"text\\":{{ JSON.stringify($json.prompt) }}}]}],\\"generationConfig\\":{\\"temperature\\":0.1,\\"maxOutputTokens\\":4096}}","options":{"timeout":60000}},"id":"068ee1b9-28ea-42d2-99da-45d282a960df","name":"Gemini","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[672,0],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const prev = $('Parse DFS').first().json;\\nconst gemini = $input.first().json;\\nconst seed = prev.seed;\\nconst kws = prev.keywords || [];\\n\\n// Normalize function for Turkish character comparison\\nconst normalize = (str) => {\\n  return str\\n    .toLowerCase()\\n    .replace(//g, 'i')\\n    .replace(//g, 'g')\\n    .replace(//g, 'u')\\n    .replace(//g, 's')\\n    .replace(//g, 'o')\\n    .replace(//g, 'c')\\n    .replace(/[^a-z0-9\\\\s]/g, '')\\n    .replace(/\\\\s+/g, ' ')\\n    .trim();\\n};\\n\\n// Check if string has Turkish characters (preferred version)\\nconst hasTurkishChars = (str) => /[]/.test(str);\\n\\n// Helper: prefer Turkish version, else higher volume\\nconst pickBest = (existing, newKw) => {\\n  const existingTr = hasTurkishChars(existing.kw);\\n  const newTr = hasTurkishChars(newKw.kw);\\n  if (newTr && !existingTr) return newKw;\\n  if (existingTr && !newTr) return existing;\\n  return newKw.vol > existing.vol ? newKw : existing;\\n};\\n\\nconst approved = [];\\nconst rejected = [];\\nconst contentSet = new Set();\\n\\ntry {\\n  const txt = gemini?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  \\n  // Parse CONTENT line\\n  const contentMatch = txt.match(/CONTENT[:\\\\s]*([\\\\d,\\\\s]+)/i);\\n  const contentNos = contentMatch \\n    ? contentMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => n > 0 && n <= kws.length)\\n    : [];\\n  \\n  // Build approved list from CONTENT (with Turkish preference)\\n  const approvedMap = new Map();\\n  contentNos.forEach(n => {\\n    const k = kws[n - 1];\\n    if (k) {\\n      contentSet.add(n - 1);\\n      const norm = normalize(k.kw);\\n      if (approvedMap.has(norm)) {\\n        approvedMap.set(norm, pickBest(approvedMap.get(norm), k));\\n      } else {\\n        approvedMap.set(norm, k);\\n      }\\n    }\\n  });\\n  \\n  approvedMap.forEach((k, norm) => {\\n    approved.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'approved',\\n      priority: k.vol >= 5000 ? 'high' : k.vol >= 1000 ? 'medium' : 'low'\\n    });\\n  });\\n  \\n  // Build rejected list - group by normalized, pick Turkish version\\n  const rejectedMap = new Map();\\n  const approvedNorms = new Set(approvedMap.keys());\\n  \\n  kws.forEach((k, idx) => {\\n    if (contentSet.has(idx)) return;\\n    const norm = normalize(k.kw);\\n    if (approvedNorms.has(norm)) return;\\n    \\n    if (rejectedMap.has(norm)) {\\n      rejectedMap.set(norm, pickBest(rejectedMap.get(norm), k));\\n    } else {\\n      rejectedMap.set(norm, k);\\n    }\\n  });\\n  \\n  rejectedMap.forEach((k, norm) => {\\n    rejected.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'rejected'\\n    });\\n  });\\n  \\n} catch(e) {\\n  // Fallback: top 35 by volume for approved, rest for rejected\\n  const sorted = [...kws].sort((a, b) => b.vol - a.vol);\\n  const approvedMap = new Map();\\n  const rejectedMap = new Map();\\n  \\n  sorted.forEach((k, idx) => {\\n    const norm = normalize(k.kw);\\n    const isTop35 = idx < 35;\\n    const targetMap = isTop35 ? approvedMap : rejectedMap;\\n    \\n    if (isTop35 && rejectedMap.has(norm)) return;\\n    if (!isTop35 && approvedMap.has(norm)) return;\\n    \\n    if (targetMap.has(norm)) {\\n      targetMap.set(norm, pickBest(targetMap.get(norm), k));\\n    } else {\\n      targetMap.set(norm, k);\\n    }\\n  });\\n  \\n  approvedMap.forEach((k) => {\\n    approved.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'approved',\\n      priority: k.vol >= 5000 ? 'high' : k.vol >= 1000 ? 'medium' : 'low'\\n    });\\n  });\\n  \\n  rejectedMap.forEach((k) => {\\n    rejected.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'rejected'\\n    });\\n  });\\n}\\n\\n// If no approved from Gemini, fallback to top 35\\nif (approved.length === 0 && kws.length > 0) {\\n  const sorted = [...kws].sort((a, b) => b.vol - a.vol);\\n  const approvedMap = new Map();\\n  const rejectedMap = new Map();\\n  \\n  sorted.forEach((k, idx) => {\\n    const norm = normalize(k.kw);\\n    const isTop35 = approvedMap.size < 35 && !rejectedMap.has(norm);\\n    const targetMap = isTop35 ? approvedMap : rejectedMap;\\n    \\n    if (!isTop35 && approvedMap.has(norm)) return;\\n    \\n    if (targetMap.has(norm)) {\\n      targetMap.set(norm, pickBest(targetMap.get(norm), k));\\n    } else {\\n      targetMap.set(norm, k);\\n    }\\n  });\\n  \\n  approvedMap.forEach((k) => {\\n    approved.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'approved',\\n      priority: 'medium'\\n    });\\n  });\\n  \\n  rejectedMap.forEach((k) => {\\n    rejected.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'rejected'\\n    });\\n  });\\n}\\n\\nreturn [{json: {\\n  seed,\\n  approved,\\n  rejected,\\n  stats: {\\n    approved: approved.length,\\n    rejected: rejected.length\\n  }\\n}}];"},"id":"68d5b73c-c41c-492b-a034-908fe9bea4d5","name":"Parse Gemini","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,0]}]	{"Webhook":{"main":[[{"node":"DataForSEO","type":"main","index":0}]]},"DataForSEO":{"main":[[{"node":"Parse DFS","type":"main","index":0}]]},"Parse DFS":{"main":[[{"node":"Gemini","type":"main","index":0}]]},"Gemini":{"main":[[{"node":"Parse Gemini","type":"main","index":0}]]}}	2025-12-23 19:55:02.057+00	2025-12-24 08:20:19+00	{"executionOrder":"v1"}	\N	{}	cca84042-6828-4a5e-97e4-a37d5b8ad28c	1	mNQs5AgZjCB0MIZx	\N	\N	f	5	\N	cca84042-6828-4a5e-97e4-a37d5b8ad28c
WF-001 Clients CRUD Operations	t	[{"parameters":{"path":"clients/list","responseMode":"responseNode","options":{}},"id":"bdad1ffa-c3b0-4036-bea7-fdd012a425e9","name":"Webhook - List Clients","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"clients-list"},{"parameters":{"operation":"executeQuery","query":"SELECT id, uuid, name, slug, domain, industry, default_language, default_country, is_active, created_at FROM clients WHERE deleted_at IS NULL ORDER BY name ASC","options":{}},"id":"ac2e981a-948e-453c-9ed9-a83706ad2aca","name":"MySQL - List Clients","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"data\\": {{ JSON.stringify($input.all().map(i => i.json)) }}\\n}","options":{}},"id":"a5c5bfd3-c198-4032-b68a-1f72e093eb21","name":"Respond - List","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[448,0]},{"parameters":{"httpMethod":"POST","path":"clients/create","responseMode":"responseNode","options":{}},"id":"b4c12f3a-be37-4f9d-82cf-469b50012152","name":"Webhook - Create Client","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,208],"webhookId":"clients-create"},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO clients (uuid, name, slug, domain, industry, default_language, default_country) VALUES (UUID(), {{ JSON.stringify($json.body.name || '') }}, {{ JSON.stringify($json.body.slug || '') }}, {{ JSON.stringify($json.body.domain || '') }}, {{ JSON.stringify($json.body.industry || '') }}, {{ JSON.stringify($json.body.default_language || 'tr') }}, {{ JSON.stringify($json.body.default_country || 'TR') }})","options":{}},"id":"0f889398-f2ab-484b-bc03-becca8be9944","name":"MySQL - Create Client","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueErrorOutput"},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM clients WHERE id = LAST_INSERT_ID()","options":{}},"id":"ee657cb9-0102-43fa-9a22-ef0d319de882","name":"MySQL - Get Created","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[448,144],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO client_configurations (client_id) VALUES ({{ $json.id }})","options":{}},"id":"d07f60ae-2c3c-490c-8a8c-91e8b6d197cf","name":"MySQL - Create Config","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,144],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"data\\": {{ JSON.stringify($json) }},\\n  \\"message\\": \\"Mteri baaryla oluturuldu\\"\\n}","options":{}},"id":"e73e043e-df38-4e26-be0c-74994b5be605","name":"Respond - Create Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[880,144]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": {{ $json.message && $json.message.includes('Duplicate') ? '\\"Bu slug zaten kullanmda\\"' : JSON.stringify($json.message || 'Mteri oluturulamad') }}\\n}","options":{"responseCode":400}},"id":"f7afb8f3-1981-4707-bb90-637201314ef1","name":"Respond - Create Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[448,288]},{"parameters":{"path":"clients-get/clients/:id","responseMode":"responseNode","options":{}},"id":"c90f9bd0-12e6-4032-a1d5-12e30bbeb72c","name":"Webhook - Get Client","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,400],"webhookId":"clients-get"},{"parameters":{"operation":"executeQuery","query":"=SELECT c.id, c.uuid, c.name, c.slug, c.domain, c.industry, c.default_language, c.default_country, c.is_active, c.created_at, c.updated_at, cc.system_prompt_id, cc.tone_of_voice, cc.writing_style, cc.target_audience, cc.brand_keywords, cc.forbidden_words, cc.competitor_domains, cc.keyword_density_min, cc.keyword_density_max, cc.internal_links_per_1000_words, cc.ai_model_preference, cc.ai_temperature, cc.enable_ai_analysis, cc.competitor_count, cc.cache_duration_days, cc.enable_ahrefs_api FROM clients c LEFT JOIN client_configurations cc ON c.id = cc.client_id WHERE (c.id = {{ parseInt($json.params.id) || 0 }} OR c.uuid = '{{ $json.params.id }}') AND c.deleted_at IS NULL LIMIT 1","options":{}},"id":"8a8f46b3-7975-408d-852b-7eacbde0965a","name":"MySQL - Get Client","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,400],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const item = $json;\\nif (item.id) {\\n  try { item.brand_keywords = item.brand_keywords ? JSON.parse(item.brand_keywords) : []; } catch { item.brand_keywords = []; }\\n  try { item.forbidden_words = item.forbidden_words ? JSON.parse(item.forbidden_words) : []; } catch { item.forbidden_words = []; }\\n  try { item.competitor_domains = item.competitor_domains ? JSON.parse(item.competitor_domains) : []; } catch { item.competitor_domains = []; }\\n}\\nreturn { json: item };"},"id":"ae170dd9-ca8d-4ea6-830d-cf3fd0652a37","name":"Code - Parse JSON","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,400]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": {{ $json.id ? true : false }},\\n  \\"data\\": {{ $json.id ? JSON.stringify($json) : 'null' }},\\n  \\"error\\": {{ $json.id ? 'null' : '\\"Mteri bulunamad\\"' }}\\n}","options":{}},"id":"2a089b97-fdc9-455a-87d1-12035ee48bcd","name":"Respond - Get","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,400]},{"parameters":{"httpMethod":"PUT","path":"clients-update/clients/:id/update","responseMode":"responseNode","options":{}},"id":"22d9adb5-e85a-4316-9ce3-bd3683647815","name":"Webhook - Update Client","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,608],"webhookId":"clients-update"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const body = $json.body || {};\\nconst clientId = parseInt($json.params.id);\\nif (!clientId) return { json: { error: 'Invalid client ID', clientId: 0 } };\\n\\nconst clientFields = ['name', 'slug', 'domain', 'industry', 'default_language', 'default_country', 'is_active'];\\nconst clientUpdates = [];\\nfor (const field of clientFields) {\\n  if (body[field] !== undefined) {\\n    const value = body[field];\\n    if (typeof value === 'boolean') clientUpdates.push(`${field} = ${value ? 1 : 0}`);\\n    else if (typeof value === 'number') clientUpdates.push(`${field} = ${value}`);\\n    else clientUpdates.push(`${field} = ${JSON.stringify(value)}`);\\n  }\\n}\\n\\nconst configFields = ['system_prompt_id', 'tone_of_voice', 'writing_style', 'target_audience', 'brand_keywords', 'forbidden_words', 'competitor_domains', 'keyword_density_min', 'keyword_density_max', 'internal_links_per_1000_words', 'ai_model_preference', 'ai_temperature', 'enable_ai_analysis', 'competitor_count', 'cache_duration_days', 'enable_ahrefs_api'];\\nconst configUpdates = [];\\nfor (const field of configFields) {\\n  if (body[field] !== undefined) {\\n    const value = body[field];\\n    if (value === null) configUpdates.push(`${field} = NULL`);\\n    else if (Array.isArray(value)) configUpdates.push(`${field} = ${JSON.stringify(JSON.stringify(value))}`);\\n    else if (typeof value === 'boolean') configUpdates.push(`${field} = ${value ? 1 : 0}`);\\n    else if (typeof value === 'number') configUpdates.push(`${field} = ${value}`);\\n    else configUpdates.push(`${field} = ${JSON.stringify(value)}`);\\n  }\\n}\\n\\nlet clientQuery = '';\\nif (clientUpdates.length > 0) {\\n  clientUpdates.push('updated_at = NOW()');\\n  clientQuery = `UPDATE clients SET ${clientUpdates.join(', ')} WHERE id = ${clientId} AND deleted_at IS NULL`;\\n}\\n\\nlet configQuery = '';\\nif (configUpdates.length > 0) {\\n  configUpdates.push('updated_at = NOW()');\\n  configQuery = `UPDATE client_configurations SET ${configUpdates.join(', ')} WHERE client_id = ${clientId}`;\\n}\\n\\nreturn { json: { clientId, clientQuery, configQuery, hasClientUpdates: clientUpdates.length > 0, hasConfigUpdates: configUpdates.length > 0 } };"},"id":"4d83b2cd-fdec-4263-8ee3-c15379bf7bf4","name":"Code - Build Update","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,608]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"c1","leftValue":"={{ $json.hasClientUpdates }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"9b67eb25-4b7a-45a8-bb5d-db42a451a65b","name":"IF - Has Client Updates","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,608]},{"parameters":{"operation":"executeQuery","query":"={{ $json.clientQuery }}","options":{}},"id":"13195b60-4fc3-46c5-b2e4-5bd79301a90b","name":"MySQL - Update Client","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,544],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"return { json: $('Code - Build Update').item.json };"},"id":"2aef954a-50e1-4681-9f9c-b0719f749568","name":"Code - Merge Client","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,544]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"return { json: $('Code - Build Update').item.json };"},"id":"1c65a609-3a83-43b0-a0f3-5a1670ec20d5","name":"Code - Skip Client","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,672]},{"parameters":{"mode":"passThrough"},"id":"6867bdd8-84c6-4c0f-981d-69248c79fce7","name":"Merge After Client","type":"n8n-nodes-base.merge","typeVersion":3,"position":[1104,608]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"c2","leftValue":"={{ $json.hasConfigUpdates }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"aa29e8f0-29ef-4902-923c-a9ba7c7c310d","name":"IF - Has Config Updates","type":"n8n-nodes-base.if","typeVersion":2,"position":[1328,608]},{"parameters":{"operation":"executeQuery","query":"={{ $json.configQuery }}","options":{}},"id":"989584df-5171-467f-bdba-a1b0f38c159d","name":"MySQL - Update Config","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1552,544],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"return { json: { clientId: $('Code - Build Update').item.json.clientId } };"},"id":"ccee490a-4be8-4e6d-8b52-9b41becf2322","name":"Code - Merge Config","type":"n8n-nodes-base.code","typeVersion":2,"position":[1760,544]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"return { json: { clientId: $('Code - Build Update').item.json.clientId } };"},"id":"115044c0-e1b5-4b7e-b34f-26e55145af79","name":"Code - Skip Config","type":"n8n-nodes-base.code","typeVersion":2,"position":[1552,672]},{"parameters":{"mode":"passThrough"},"id":"c8de9758-83fd-46e3-8438-45b103273a5b","name":"Merge After Config","type":"n8n-nodes-base.merge","typeVersion":3,"position":[1984,608]},{"parameters":{"operation":"executeQuery","query":"=SELECT c.id, c.uuid, c.name, c.slug, c.domain, c.industry, c.default_language, c.default_country, c.is_active, c.created_at, c.updated_at, cc.system_prompt_id, cc.tone_of_voice, cc.writing_style, cc.target_audience, cc.brand_keywords, cc.forbidden_words, cc.competitor_domains, cc.keyword_density_min, cc.keyword_density_max, cc.internal_links_per_1000_words, cc.ai_model_preference, cc.ai_temperature, cc.enable_ai_analysis, cc.competitor_count, cc.cache_duration_days, cc.enable_ahrefs_api FROM clients c LEFT JOIN client_configurations cc ON c.id = cc.client_id WHERE c.id = {{ $json.clientId }} AND c.deleted_at IS NULL LIMIT 1","options":{}},"id":"e3ac250c-0ce7-439e-b226-8604dccabc11","name":"MySQL - Get Updated","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[2208,608],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const item = $json;\\nif (item.id) {\\n  try { item.brand_keywords = item.brand_keywords ? JSON.parse(item.brand_keywords) : []; } catch { item.brand_keywords = []; }\\n  try { item.forbidden_words = item.forbidden_words ? JSON.parse(item.forbidden_words) : []; } catch { item.forbidden_words = []; }\\n  try { item.competitor_domains = item.competitor_domains ? JSON.parse(item.competitor_domains) : []; } catch { item.competitor_domains = []; }\\n}\\nreturn { json: item };"},"id":"a58e911e-a230-4b0a-93ee-79058cb4f1ec","name":"Code - Parse Updated","type":"n8n-nodes-base.code","typeVersion":2,"position":[2432,608]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": {{ $json.id ? true : false }},\\n  \\"data\\": {{ $json.id ? JSON.stringify($json) : 'null' }},\\n  \\"message\\": {{ $json.id ? '\\"Mteri baaryla gncellendi\\"' : '\\"Mteri bulunamad\\"' }}\\n}","options":{}},"id":"222a39bb-7af5-4708-af56-c872903a3c06","name":"Respond - Update","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[2640,608]},{"parameters":{"httpMethod":"DELETE","path":"clients-delete/clients/:id","responseMode":"responseNode","options":{}},"id":"c096fdca-4fda-4afe-b277-171b18542f41","name":"Webhook - Delete Client","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,800],"webhookId":"clients-delete"},{"parameters":{"operation":"executeQuery","query":"=UPDATE clients SET deleted_at = NOW(), is_active = 0 WHERE id = {{ parseInt($json.params.id) || 0 }} AND deleted_at IS NULL","options":{}},"id":"86766418-cb19-4e1a-a8b9-513b01575e1e","name":"MySQL - Delete Client","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,800],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"message\\": \\"Mteri baaryla silindi\\"\\n}","options":{}},"id":"ace5b004-6617-40b4-9dd4-2566bbf0bb50","name":"Respond - Delete","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[448,800]}]	{"Webhook - List Clients":{"main":[[{"node":"MySQL - List Clients","type":"main","index":0}]]},"MySQL - List Clients":{"main":[[{"node":"Respond - List","type":"main","index":0}]]},"Webhook - Create Client":{"main":[[{"node":"MySQL - Create Client","type":"main","index":0}]]},"MySQL - Create Client":{"main":[[{"node":"MySQL - Get Created","type":"main","index":0}],[{"node":"Respond - Create Error","type":"main","index":0}]]},"MySQL - Get Created":{"main":[[{"node":"MySQL - Create Config","type":"main","index":0}]]},"MySQL - Create Config":{"main":[[{"node":"Respond - Create Success","type":"main","index":0}]]},"Webhook - Get Client":{"main":[[{"node":"MySQL - Get Client","type":"main","index":0}]]},"MySQL - Get Client":{"main":[[{"node":"Code - Parse JSON","type":"main","index":0}]]},"Code - Parse JSON":{"main":[[{"node":"Respond - Get","type":"main","index":0}]]},"Webhook - Update Client":{"main":[[{"node":"Code - Build Update","type":"main","index":0}]]},"Code - Build Update":{"main":[[{"node":"IF - Has Client Updates","type":"main","index":0}]]},"IF - Has Client Updates":{"main":[[{"node":"MySQL - Update Client","type":"main","index":0}],[{"node":"Code - Skip Client","type":"main","index":0}]]},"MySQL - Update Client":{"main":[[{"node":"Code - Merge Client","type":"main","index":0}]]},"Code - Merge Client":{"main":[[{"node":"Merge After Client","type":"main","index":0}]]},"Code - Skip Client":{"main":[[{"node":"Merge After Client","type":"main","index":1}]]},"Merge After Client":{"main":[[{"node":"IF - Has Config Updates","type":"main","index":0}]]},"IF - Has Config Updates":{"main":[[{"node":"MySQL - Update Config","type":"main","index":0}],[{"node":"Code - Skip Config","type":"main","index":0}]]},"MySQL - Update Config":{"main":[[{"node":"Code - Merge Config","type":"main","index":0}]]},"Code - Merge Config":{"main":[[{"node":"Merge After Config","type":"main","index":0}]]},"Code - Skip Config":{"main":[[{"node":"Merge After Config","type":"main","index":1}]]},"Merge After Config":{"main":[[{"node":"MySQL - Get Updated","type":"main","index":0}]]},"MySQL - Get Updated":{"main":[[{"node":"Code - Parse Updated","type":"main","index":0}]]},"Code - Parse Updated":{"main":[[{"node":"Respond - Update","type":"main","index":0}]]},"Webhook - Delete Client":{"main":[[{"node":"MySQL - Delete Client","type":"main","index":0}]]},"MySQL - Delete Client":{"main":[[{"node":"Respond - Delete","type":"main","index":0}]]}}	2025-12-17 10:25:58.854+00	2025-12-17 10:25:58.854+00	{"executionOrder":"v1"}	\N	{}	057c1d4a-90b8-4bc9-add8-c93e1acd2aa6	5	nuQVa3YLSJFRC4Ny	{"templateCredsSetupCompleted":true}	\N	f	18	\N	057c1d4a-90b8-4bc9-add8-c93e1acd2aa6
WF-101-project-initializer	t	[{"parameters":{"httpMethod":"POST","path":"tool1/project/create","responseMode":"responseNode","options":{}},"id":"448a287d-0c56-4536-b6eb-c67882e0e5bc","name":"Webhook - Create Project","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1328,288],"webhookId":"tool1-project-create"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// ============================================\\n// WF-101 Input Validation\\n// ============================================\\n\\nconst body = $json.body || {};\\nconst errors = [];\\n\\n// Required fields validation\\nif (!body.client_id || isNaN(parseInt(body.client_id))) {\\n  errors.push('client_id zorunludur ve say olmaldr');\\n}\\n\\nif (!body.project_name || String(body.project_name).trim() === '') {\\n  errors.push('project_name zorunludur');\\n}\\n\\nif (!body.main_keyword || String(body.main_keyword).trim() === '') {\\n  errors.push('main_keyword zorunludur');\\n}\\n\\n// Scenario type validation\\nconst validScenarios = ['seed_keyword', 'topic_based'];\\nconst scenarioType = body.scenario_type || 'seed_keyword';\\nif (!validScenarios.includes(scenarioType)) {\\n  errors.push('scenario_type seed_keyword veya topic_based olmaldr');\\n}\\n\\n// Sanitize inputs to prevent SQL injection\\nconst sanitize = (str) => {\\n  if (str === null || str === undefined) return '';\\n  return String(str).replace(/'/g, \\"''\\").trim();\\n};\\n\\nreturn {\\n  json: {\\n    isValid: errors.length === 0,\\n    errors: errors,\\n    data: {\\n      client_id: parseInt(body.client_id) || 0,\\n      project_name: sanitize(body.project_name),\\n      main_keyword: sanitize(body.main_keyword),\\n      scenario_type: scenarioType,\\n      target_country: sanitize(body.target_country) || 'TR',\\n      target_language: sanitize(body.target_language) || 'tr'\\n    }\\n  }\\n};"},"id":"37675695-4465-4ca5-85da-e04d7f441a31","name":"Code - Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1104,288]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"check-valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"5f12128f-2ecd-40cf-aad9-45348c1724f8","name":"IF - Valid Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[-880,288]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Validation failed\\",\\n  \\"details\\": {{ JSON.stringify($json.errors) }}\\n}","options":{"responseCode":400}},"id":"c6d5fa9a-3895-4b3a-a56d-8f043a3754b7","name":"Respond - Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-656,432]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  (SELECT id FROM clients WHERE id = {{ $('Code - Validate Input').first().json.data.client_id }} AND deleted_at IS NULL LIMIT 1) as id,\\n  (SELECT name FROM clients WHERE id = {{ $('Code - Validate Input').first().json.data.client_id }} AND deleted_at IS NULL LIMIT 1) as name","options":{}},"id":"0933056b-ff80-4912-82a8-01fd58529128","name":"MySQL - Check Client","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-656,144],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Check if client exists and pass validated data forward\\nconst clientResult = $json;\\nconst validatedData = $('Code - Validate Input').first().json.data;\\n\\n// Now clientResult always has a row - check if id is not null\\nconst clientExists = clientResult.id !== null && clientResult.id !== undefined;\\n\\nreturn {\\n  json: {\\n    clientExists: clientExists,\\n    client_id: validatedData.client_id,\\n    client_name: clientResult.name || null,\\n    project_name: validatedData.project_name,\\n    main_keyword: validatedData.main_keyword,\\n    scenario_type: validatedData.scenario_type,\\n    target_country: validatedData.target_country,\\n    target_language: validatedData.target_language\\n  }\\n};"},"id":"7a6bf583-e529-4457-bccf-6df104385c71","name":"Code - Check Client Result","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,144]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"check-client-exists","leftValue":"={{ $json.clientExists }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"4b2bbcea-8c9e-4a4c-99bd-5f9a35dea3d9","name":"IF - Client Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,144]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Client not found\\",\\n  \\"details\\": [\\"Belirtilen client_id ile mteri bulunamad\\"]\\n}","options":{"responseCode":404}},"id":"26849fb3-deef-4682-aed4-791295faa522","name":"Respond - Client Not Found","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[0,288]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO keyword_projects (\\n  client_id, project_name, main_keyword, scenario_type, \\n  target_country, target_language, status\\n) VALUES (\\n  {{ $json.client_id }},\\n  '{{ $json.project_name }}',\\n  '{{ $json.main_keyword }}',\\n  '{{ $json.scenario_type }}',\\n  '{{ $json.target_country }}',\\n  '{{ $json.target_language }}',\\n  'pending'\\n)","options":{}},"id":"46e2ef1b-33cd-48eb-92f1-589483efe03c","name":"MySQL - Create Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[0,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT id, uuid, project_name, main_keyword, scenario_type, status \\nFROM keyword_projects \\nWHERE client_id = {{ $('IF - Client Exists').item.json.client_id }} \\nORDER BY id DESC LIMIT 1","options":{}},"id":"cb8572e4-33d4-475b-a93e-33ed5493c03e","name":"MySQL - Get Created Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=UPDATE keyword_projects \\nSET status = 'processing', started_at = NOW() \\nWHERE id = {{ $json.id }}","options":{}},"id":"f5a3afa3-a01c-419b-a8f6-f8c6c095f02e","name":"MySQL - Set Processing","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[448,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO activity_logs (\\n  client_id, tool_name, project_id, action, log_level, message\\n) VALUES (\\n  {{ $('IF - Client Exists').item.json.client_id }},\\n  'keyword_research',\\n  {{ $('MySQL - Get Created Project').item.json.id }},\\n  'project_created',\\n  'info',\\n  'Keyword research project created: {{ $('MySQL - Get Created Project').item.json.project_name }}'\\n)","options":{}},"id":"e975dc8b-bb2c-410d-9523-e98b439b6ec8","name":"MySQL - Log Activity","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"data\\": {\\n    \\"project_id\\": {{ $('MySQL - Get Created Project').item.json.id }},\\n    \\"uuid\\": \\"{{ $('MySQL - Get Created Project').item.json.uuid }}\\",\\n    \\"project_name\\": \\"{{ $('MySQL - Get Created Project').item.json.project_name }}\\",\\n    \\"main_keyword\\": \\"{{ $('MySQL - Get Created Project').item.json.main_keyword }}\\",\\n    \\"scenario_type\\": \\"{{ $('MySQL - Get Created Project').item.json.scenario_type }}\\",\\n    \\"status\\": \\"processing\\",\\n    \\"message\\": \\"Keyword research project created successfully\\"\\n  }\\n}","options":{}},"id":"9c68d279-b97b-422e-aff2-0fe334d05d09","name":"Respond - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[880,0]}]	{"Webhook - Create Project":{"main":[[{"node":"Code - Validate Input","type":"main","index":0}]]},"Code - Validate Input":{"main":[[{"node":"IF - Valid Input","type":"main","index":0}]]},"IF - Valid Input":{"main":[[{"node":"MySQL - Check Client","type":"main","index":0}],[{"node":"Respond - Validation Error","type":"main","index":0}]]},"MySQL - Check Client":{"main":[[{"node":"Code - Check Client Result","type":"main","index":0}]]},"Code - Check Client Result":{"main":[[{"node":"IF - Client Exists","type":"main","index":0}]]},"IF - Client Exists":{"main":[[{"node":"MySQL - Create Project","type":"main","index":0}],[{"node":"Respond - Client Not Found","type":"main","index":0}]]},"MySQL - Create Project":{"main":[[{"node":"MySQL - Get Created Project","type":"main","index":0}]]},"MySQL - Get Created Project":{"main":[[{"node":"MySQL - Set Processing","type":"main","index":0}]]},"MySQL - Set Processing":{"main":[[{"node":"MySQL - Log Activity","type":"main","index":0}]]},"MySQL - Log Activity":{"main":[[{"node":"Respond - Success","type":"main","index":0}]]}}	2025-12-17 10:26:33.459+00	2025-12-17 10:26:38.486+00	{"executionOrder":"v1"}	\N	{}	7c994d64-1fad-4c91-8a09-b1a0adb79c50	1	DyGEyObKWBEHrb0B	{"templateCredsSetupCompleted":true}	\N	f	19	\N	7c994d64-1fad-4c91-8a09-b1a0adb79c50
WF-002 Sheets Connect	t	[{"parameters":{"httpMethod":"POST","path":"sheets-connect","responseMode":"responseNode","options":{}},"id":"11ccaca6-b11e-4f66-ae1c-56e733aa384f","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-672,64],"webhookId":"sheets-connect"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const url = $json.body?.spreadsheet_url || '';\\nconst match = url.match(/\\\\/spreadsheets\\\\/d\\\\/([a-zA-Z0-9-_]+)/);\\nconst spreadsheetId = match ? match[1] : null;\\nif (!spreadsheetId) {\\n  return { json: { success: false, error: 'Geersiz Google Sheets URL' } };\\n}\\nreturn { json: { spreadsheetId, originalUrl: url } };"},"id":"567ae667-0a24-41a3-9392-f2f3e2c7b59c","name":"Parse URL","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,64]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"c1","leftValue":"={{ $json.spreadsheetId }}","rightValue":"","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"d9975acc-b891-411d-926a-3a31ce793fa3","name":"IF Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,64]},{"parameters":{"url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheetId }}","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","options":{}},"id":"450649b0-319e-4ba5-aeca-d1f3d41c82f2","name":"Get Spreadsheet","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,0],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const s = $json;\\nreturn { json: {\\n  success: true,\\n  spreadsheet_id: s.spreadsheetId,\\n  spreadsheet_name: s.properties?.title || 'Untitled',\\n  spreadsheet_url: s.spreadsheetUrl,\\n  sheets: (s.sheets || []).map(sh => ({ name: sh.properties?.title, gid: String(sh.properties?.sheetId || 0) }))\\n}};"},"id":"77122043-ca59-4488-aede-3ca511b5d0bc","name":"Format","type":"n8n-nodes-base.code","typeVersion":2,"position":[208,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"d113ce64-2b48-430a-b354-a81bd34c6e53","name":"Respond OK","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[432,0]},{"parameters":{"respondWith":"json","responseBody":"={ \\"success\\": false, \\"error\\": \\"Geersiz URL\\" }","options":{"responseCode":400}},"id":"1c780bec-e48e-4a85-97cf-49833d78a372","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[0,144]}]	{"Webhook":{"main":[[{"node":"Parse URL","type":"main","index":0}]]},"Parse URL":{"main":[[{"node":"IF Valid","type":"main","index":0}]]},"IF Valid":{"main":[[{"node":"Get Spreadsheet","type":"main","index":0}],[{"node":"Respond Error","type":"main","index":0}]]},"Get Spreadsheet":{"main":[[{"node":"Format","type":"main","index":0}]]},"Format":{"main":[[{"node":"Respond OK","type":"main","index":0}]]}}	2025-12-18 11:34:23.337+00	2025-12-19 10:26:20.327+00	{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false}	\N	{}	5f87ae9f-2108-4042-888c-99ad089a972e	1	cRzztL0RsykZYA9k	{"templateCredsSetupCompleted":true}	\N	f	22	\N	5f87ae9f-2108-4042-888c-99ad089a972e
WF-110: Report Exporter	t	[{"parameters":{"path":":projectId/export","responseMode":"responseNode","options":{}},"id":"3a9f788c-3d32-4a06-974c-44fa31f66ef0","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-2416,112],"webhookId":"tool1-report-exporter"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Input validation\\nconst projectId = $json.params?.projectId;\\nconst format = $json.query?.format || 'json'; // json, csv, html\\n\\nif (!projectId) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'projectId parametresi zorunludur',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nconst parsedId = parseInt(projectId);\\nif (isNaN(parsedId) || parsedId <= 0) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'projectId gecerli bir pozitif sayi olmalidir',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nconst validFormats = ['json', 'csv', 'html'];\\nif (!validFormats.includes(format)) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'Gecersiz format. Gecerli degerler: json, csv, html',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nreturn {\\n  json: {\\n    isValid: true,\\n    projectId: parsedId,\\n    format: format\\n  }\\n};"},"id":"15e9c313-0ce6-46bf-9e2c-4e529ff74eac","name":"Code - Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2208,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"8b575e0b-692f-4c9c-b5ea-0bb52ceee8a3","name":"IF - Valid Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1984,112]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Validation failed\\",\\n  \\"message\\": \\"{{ $json.error }}\\"\\n}","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"9921213e-16c3-46d4-b181-d4e62c757db8","name":"Respond - Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-1760,304]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  kp.*,\\n  c.name as client_name,\\n  c.domain as client_domain,\\n  c.industry as client_industry\\nFROM keyword_projects kp\\nLEFT JOIN clients c ON kp.client_id = c.id\\nWHERE kp.id = {{ $json.projectId }}\\nLIMIT 1","options":{}},"id":"1523cb24-67a8-485c-af99-1f7218112815","name":"MySQL - Get Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1760,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"project-exists","leftValue":"={{ $json.id }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"id":"56a3a716-5bf7-4728-9f5e-72076a90f79c","name":"IF - Project Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1536,112]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Project not found\\",\\n  \\"message\\": \\"Proje bulunamadi: {{ $('Code - Validate Input').first().json.projectId }}\\"\\n}","options":{"responseCode":404}},"id":"06a43875-7977-4eaa-b2a4-cfbe28fb11d3","name":"Respond - Not Found","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-1328,304]},{"parameters":{"operation":"executeQuery","query":"=SELECT 0 as id, '' as keyword, '' as keyword_type, 0 as search_volume, 0 as keyword_difficulty, 0 as cpc, '' as search_intent, '' as keyword_cluster, '' as parent_topic, 0 as opportunity_score, '' as page_type, '' as content_format, '' as content_priority, 0 as recommended_word_count, '' as source, NULL as created_at UNION ALL SELECT id, keyword, keyword_type, search_volume, keyword_difficulty, cpc, search_intent, keyword_cluster, parent_topic, opportunity_score, page_type, content_format, content_priority, recommended_word_count, source, created_at FROM keyword_results WHERE project_id = {{ $('MySQL - Get Project').first().json.id }} LIMIT 201","options":{}},"id":"c7e32974-abaf-4d1a-a195-78423e3f45a8","name":"MySQL - Get Keywords","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1328,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT 0 as id, '' as competitor_url, '' as competitor_domain, 0 as serp_position, '' as title, '' as meta_description, 0 as word_count, 0 as h1_count, 0 as h2_count, 0 as h3_count, 0 as domain_rating, 0 as backlinks_count, NULL as analyzed_at UNION ALL SELECT id, competitor_url, competitor_domain, serp_position, title, meta_description, word_count, h1_count, h2_count, h3_count, domain_rating, backlinks_count, analyzed_at FROM competitor_data WHERE project_id = {{ $('MySQL - Get Project').first().json.id }} LIMIT 51","options":{}},"id":"615656d3-0ac5-4da2-91bc-53dbd112015d","name":"MySQL - Get Competitors","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1104,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT has_featured_snippet, featured_snippet_type, has_paa, paa_count, has_video_results, has_image_pack, has_local_pack, has_knowledge_panel, zero_click_risk, analyzed_at FROM serp_features WHERE project_id = {{ $('MySQL - Get Project').first().json.id }} UNION ALL SELECT 0, NULL, 0, 0, 0, 0, 0, 0, NULL, NULL LIMIT 1","options":{}},"id":"da44af18-116e-4415-97fb-2ad7df79655f","name":"MySQL - Get SERP Features","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-880,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT 0 as id, '' as question, '' as answer_snippet, '' as source_url, '' as source_domain, 0 as position UNION ALL SELECT id, question, answer_snippet, source_url, source_domain, position FROM paa_data WHERE project_id = {{ $('MySQL - Get Project').first().json.id }} LIMIT 51","options":{}},"id":"f6a1b063-5c4a-4b27-b708-61dd268b89f7","name":"MySQL - Get PAA","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-656,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Tum verileri topla ve rapor olustur\\nconst validatedData = $('Code - Validate Input').first().json;\\nconst format = validatedData.format;\\nconst project = $('MySQL - Get Project').first().json;\\n\\n// Keywords - de-duplicate by id (n8n may duplicate rows per input item)\\nconst keywordItems = $('MySQL - Get Keywords').all();\\nconst seenKeywordIds = new Set();\\nconst keywords = keywordItems.map(i => i.json).filter(k => {\\n  if (!k.id || seenKeywordIds.has(k.id)) return false;\\n  seenKeywordIds.add(k.id);\\n  return true;\\n});\\n\\n// Competitors - de-duplicate by id (n8n duplicates per input item)\\nconst competitorItems = $('MySQL - Get Competitors').all();\\nconst seenCompetitorIds = new Set();\\nconst competitors = competitorItems.map(i => i.json).filter(c => {\\n  if (!c.id || seenCompetitorIds.has(c.id)) return false;\\n  seenCompetitorIds.add(c.id);\\n  return true;\\n});\\n\\n// SERP Features - take first valid result\\nconst serpItems = $('MySQL - Get SERP Features').all();\\nconst serpFeatures = serpItems.find(i => i.json.has_featured_snippet !== undefined)?.json || null;\\n\\n// PAA - de-duplicate by id\\nconst paaItems = $('MySQL - Get PAA').all();\\nconst seenPaaIds = new Set();\\nconst paaData = paaItems.map(i => i.json).filter(p => {\\n  if (!p.id || seenPaaIds.has(p.id)) return false;\\n  seenPaaIds.add(p.id);\\n  return true;\\n});\\n\\n// Filter competitors with valid word count\\nconst competitorsWithWordCount = competitors.filter(c => c.word_count && c.word_count > 0);\\n\\n// ============ STATISTICS ============\\nconst stats = {\\n  total_keywords: keywords.length,\\n  avg_volume: keywords.length > 0 ? Math.round(keywords.reduce((sum, k) => sum + (k.search_volume || 0), 0) / keywords.length) : 0,\\n  avg_difficulty: keywords.length > 0 ? Math.round(keywords.reduce((sum, k) => sum + (k.keyword_difficulty || 0), 0) / keywords.length) : 0,\\n  avg_opportunity_score: keywords.length > 0 ? Math.round(keywords.reduce((sum, k) => sum + (parseFloat(k.opportunity_score) || 0), 0) / keywords.length) : 0,\\n  total_competitors: competitors.length,\\n  avg_competitor_word_count: competitorsWithWordCount.length > 0 ? Math.round(competitorsWithWordCount.reduce((sum, c) => sum + c.word_count, 0) / competitorsWithWordCount.length) : 0,\\n  total_paa_questions: paaData.length\\n};\\n\\n// Priority breakdown\\nconst priorityBreakdown = {\\n  high: keywords.filter(k => k.content_priority === 'high').length,\\n  medium: keywords.filter(k => k.content_priority === 'medium').length,\\n  low: keywords.filter(k => k.content_priority === 'low').length\\n};\\n\\n// Intent distribution\\nconst intentGroups = {};\\nkeywords.forEach(k => {\\n  const intent = k.search_intent || 'unknown';\\n  intentGroups[intent] = (intentGroups[intent] || 0) + 1;\\n});\\n\\n// Content format distribution\\nconst formatGroups = {};\\nkeywords.forEach(k => {\\n  const fmt = k.content_format || 'unassigned';\\n  formatGroups[fmt] = (formatGroups[fmt] || 0) + 1;\\n});\\n\\n// Cluster groups\\nconst clusters = {};\\nkeywords.forEach(k => {\\n  const cluster = k.keyword_cluster || 'Unclustered';\\n  if (!clusters[cluster]) clusters[cluster] = [];\\n  clusters[cluster].push(k.keyword);\\n});\\n\\n// ============ CONTENT PLAN ============\\n// Pillar ve Cluster sayfalar\\nconst pillarPages = keywords.filter(k => k.page_type === 'pillar');\\nconst clusterPages = keywords.filter(k => k.page_type === 'cluster');\\n\\n// Toplam kelime hedefi\\nconst totalWordTarget = keywords.reduce((sum, k) => sum + (k.recommended_word_count || 0), 0);\\n\\n// ncelikli ierik listesi\\nconst highPriorityContent = keywords.filter(k => k.content_priority === 'high').sort((a, b) => (parseFloat(b.opportunity_score) || 0) - (parseFloat(a.opportunity_score) || 0));\\nconst mediumPriorityContent = keywords.filter(k => k.content_priority === 'medium').sort((a, b) => (parseFloat(b.opportunity_score) || 0) - (parseFloat(a.opportunity_score) || 0));\\nconst lowPriorityContent = keywords.filter(k => k.content_priority === 'low').sort((a, b) => (parseFloat(b.opportunity_score) || 0) - (parseFloat(a.opportunity_score) || 0));\\n\\n// Pillar-Cluster haritas\\nconst pillarClusterMap = {};\\npillarPages.forEach(pillar => {\\n  const pillarKeyword = pillar.keyword;\\n  pillarClusterMap[pillarKeyword] = {\\n    pillar: pillar,\\n    clusters: clusterPages.filter(c => c.parent_topic === pillarKeyword || c.keyword_cluster === pillar.keyword_cluster)\\n  };\\n});\\n\\n// Content Plan Summary\\nconst contentPlan = {\\n  total_content_pieces: keywords.filter(k => k.page_type).length,\\n  pillar_pages: pillarPages.length,\\n  cluster_pages: clusterPages.length,\\n  total_word_target: totalWordTarget,\\n  estimated_articles: {\\n    high_priority: highPriorityContent.length,\\n    medium_priority: mediumPriorityContent.length,\\n    low_priority: lowPriorityContent.length\\n  },\\n  content_by_format: formatGroups,\\n  pillar_cluster_map: pillarClusterMap\\n};\\n\\n// ============ CSV GENERATION ============\\n// Keywords CSV\\nconst keywordsCsvHeader = 'ID,Keyword,Type,Volume,Difficulty,CPC,Intent,Cluster,Opportunity Score,Page Type,Content Format,Priority,Word Count';\\nconst keywordsCsvRows = keywords.map(k => \\n  `${k.id},\\"${(k.keyword || '').replace(/\\"/g, '\\"\\"')}\\",\\"${k.keyword_type || ''}\\",${k.search_volume || 0},${k.keyword_difficulty || 0},${k.cpc || 0},\\"${k.search_intent || ''}\\",\\"${(k.keyword_cluster || '').replace(/\\"/g, '\\"\\"')}\\",${k.opportunity_score || 0},\\"${k.page_type || ''}\\",\\"${k.content_format || ''}\\",\\"${k.content_priority || ''}\\",${k.recommended_word_count || 0}`\\n);\\nconst keywordsCsv = keywordsCsvHeader + '\\\\n' + keywordsCsvRows.join('\\\\n');\\n\\n// Competitors CSV\\nconst competitorsCsvHeader = 'ID,URL,Domain,Position,Title,Word Count,H1,H2,H3,DR,Backlinks';\\nconst competitorsCsvRows = competitors.map(c => \\n  `${c.id},\\"${c.competitor_url || ''}\\",\\"${c.competitor_domain || ''}\\",${c.serp_position || 0},\\"${(c.title || '').replace(/\\"/g, '\\"\\"')}\\",${c.word_count || 0},${c.h1_count || 0},${c.h2_count || 0},${c.h3_count || 0},${c.domain_rating || 0},${c.backlinks_count || 0}`\\n);\\nconst competitorsCsv = competitorsCsvHeader + '\\\\n' + competitorsCsvRows.join('\\\\n');\\n\\n// PAA CSV\\nconst paaCsvHeader = 'ID,Question,Answer,Source URL,Source Domain,Position';\\nconst paaCsvRows = paaData.map(p => \\n  `${p.id},\\"${(p.question || '').replace(/\\"/g, '\\"\\"')}\\",\\"${(p.answer_snippet || '').replace(/\\"/g, '\\"\\"')}\\",\\"${p.source_url || ''}\\",\\"${p.source_domain || ''}\\",${p.position || 0}`\\n);\\nconst paaCsv = paaCsvHeader + '\\\\n' + paaCsvRows.join('\\\\n');\\n\\n// Summary CSV\\nconst summaryCsv = `Metric,Value\\nProject Name,\\"${project.project_name}\\"\\nMain Keyword,\\"${project.main_keyword}\\"\\nClient,\\"${project.client_name || 'N/A'}\\"\\nStatus,\\"${project.status}\\"\\nTotal Keywords,${stats.total_keywords}\\nAverage Volume,${stats.avg_volume}\\nAverage Difficulty,${stats.avg_difficulty}\\nAverage Opportunity Score,${stats.avg_opportunity_score}\\nHigh Priority Keywords,${priorityBreakdown.high}\\nMedium Priority Keywords,${priorityBreakdown.medium}\\nLow Priority Keywords,${priorityBreakdown.low}\\nTotal Competitors,${stats.total_competitors}\\nAvg Competitor Word Count,${stats.avg_competitor_word_count}\\nTotal PAA Questions,${stats.total_paa_questions}\\nGenerated At,\\"${new Date().toISOString()}\\"`;\\n\\n// ============ HTML REPORT (for PDF) ============\\nconst topKeywords = keywords.slice(0, 20);\\nconst topKeywordsHtml = topKeywords.map(k => \\n  `<tr><td>${k.keyword}</td><td>${k.search_volume || 0}</td><td>${k.keyword_difficulty || 0}</td><td>${k.opportunity_score || 0}</td><td>${k.content_priority || '-'}</td><td>${k.content_format || '-'}</td></tr>`\\n).join('');\\n\\nconst competitorsHtml = competitors.slice(0, 10).map(c => \\n  `<tr><td>${c.competitor_domain || ''}</td><td>${c.serp_position || ''}</td><td>${c.word_count || 0}</td><td>${c.domain_rating || 0}</td><td>${c.backlinks_count || 0}</td></tr>`\\n).join('');\\n\\nconst paaHtml = paaData.slice(0, 10).map(p => \\n  `<tr><td>${p.question || ''}</td><td>${(p.answer_snippet || '').substring(0, 100)}...</td></tr>`\\n).join('');\\n\\n// ============ MODERN HTML REPORT ============\\n// Calculate percentages for charts\\nconst totalWithPriority = priorityBreakdown.high + priorityBreakdown.medium + priorityBreakdown.low;\\nconst highPct = totalWithPriority > 0 ? Math.round((priorityBreakdown.high / totalWithPriority) * 100) : 0;\\nconst mediumPct = totalWithPriority > 0 ? Math.round((priorityBreakdown.medium / totalWithPriority) * 100) : 0;\\nconst lowPct = totalWithPriority > 0 ? Math.round((priorityBreakdown.low / totalWithPriority) * 100) : 0;\\n\\n// Intent percentages\\nconst intentEntries = Object.entries(intentGroups).sort((a, b) => b[1] - a[1]);\\nconst maxIntent = intentEntries.length > 0 ? intentEntries[0][1] : 1;\\n\\n// Format percentages\\nconst formatEntries = Object.entries(formatGroups).filter(([k]) => k !== 'unassigned').sort((a, b) => b[1] - a[1]);\\nconst maxFormat = formatEntries.length > 0 ? formatEntries[0][1] : 1;\\n\\n// Top keywords for table\\nconst topKwList = keywords.slice(0, 25);\\n\\n// High priority content\\nconst highPrioList = highPriorityContent.slice(0, 10);\\nconst medPrioList = mediumPriorityContent.slice(0, 5);\\n\\n// Pillar-cluster structure\\nconst pillarEntries = Object.entries(pillarClusterMap);\\n\\n// Competitor stats\\nconst topCompetitors = competitors.slice(0, 10);\\nconst avgWordCount = stats.avg_competitor_word_count;\\nconst maxWordCount = competitorsWithWordCount.length > 0 ? Math.max(...competitorsWithWordCount.map(c => c.word_count)) : 0;\\nconst minWordCount = competitorsWithWordCount.length > 0 ? Math.min(...competitorsWithWordCount.map(c => c.word_count)) : 0;\\n\\nconst htmlReport = `<!DOCTYPE html>\\n<html lang=\\"tr\\">\\n<head>\\n  <meta charset=\\"UTF-8\\">\\n  <title>${project.project_name} - SEO Raporu</title>\\n  <style>\\n    *{margin:0;padding:0;box-sizing:border-box}\\n    body{font-family:system-ui,sans-serif;font-size:14px;color:#333;padding:40px;max-width:1100px;margin:0 auto;background:#fff}\\n    h1{font-size:24px;color:#1a1a2e;margin-bottom:8px}\\n    h2{font-size:16px;color:#16213e;margin:32px 0 16px;padding-bottom:8px;border-bottom:2px solid #e94560}\\n    .meta{color:#666;font-size:13px;margin-bottom:32px}\\n    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}\\n    .box{background:#f8f9fa;border-radius:8px;padding:20px;text-align:center}\\n    .box .num{font-size:28px;font-weight:700;color:#e94560}\\n    .box .lbl{font-size:11px;color:#666;text-transform:uppercase;margin-top:4px}\\n    table{width:100%;border-collapse:collapse;margin-bottom:24px}\\n    th{background:#1a1a2e;color:#fff;padding:12px;text-align:left;font-size:12px;text-transform:uppercase}\\n    td{padding:10px 12px;border-bottom:1px solid #eee}\\n    tr:hover{background:#f8f9fa}\\n    .tag{display:inline-block;padding:3px 8px;border-radius:4px;font-size:11px;font-weight:600}\\n    .tag-high{background:#d4edda;color:#155724}\\n    .tag-med{background:#fff3cd;color:#856404}\\n    .tag-low{background:#f8d7da;color:#721c24}\\n    .tag-info{background:#e7f1ff;color:#004085}\\n    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:24px}\\n    .bar{display:flex;align-items:center;margin-bottom:8px}\\n    .bar-label{width:100px;font-size:12px;color:#666}\\n    .bar-track{flex:1;height:20px;background:#eee;border-radius:4px;overflow:hidden}\\n    .bar-fill{height:100%;background:linear-gradient(90deg,#e94560,#1a1a2e);border-radius:4px}\\n    .bar-val{width:40px;text-align:right;font-size:12px;font-weight:600}\\n    .footer{margin-top:40px;padding-top:20px;border-top:1px solid #eee;text-align:center;color:#999;font-size:12px}\\n    @media print{body{padding:20px}h2{break-before:auto}}\\n  </style>\\n</head>\\n<body>\\n  <h1>${project.project_name}</h1>\\n  <div class=\\"meta\\">Ana Keyword: <strong>${project.main_keyword}</strong> | Musteri: ${project.client_name || '-'} | ${new Date().toLocaleDateString('tr-TR')}</div>\\n  \\n  <div class=\\"grid\\">\\n    <div class=\\"box\\"><div class=\\"num\\">${stats.total_keywords}</div><div class=\\"lbl\\">Keyword</div></div>\\n    <div class=\\"box\\"><div class=\\"num\\">${contentPlan.pillar_pages}</div><div class=\\"lbl\\">Pillar</div></div>\\n    <div class=\\"box\\"><div class=\\"num\\">${contentPlan.cluster_pages}</div><div class=\\"lbl\\">Cluster</div></div>\\n    <div class=\\"box\\"><div class=\\"num\\">${Math.round(totalWordTarget/1000)}K</div><div class=\\"lbl\\">Kelime Hedef</div></div>\\n  </div>\\n\\n  <div class=\\"two-col\\">\\n    <div>\\n      <h2>Oncelik Dagilimi</h2>\\n      <div class=\\"bar\\"><div class=\\"bar-label\\">Yuksek</div><div class=\\"bar-track\\"><div class=\\"bar-fill\\" style=\\"width:${highPct}%\\"></div></div><div class=\\"bar-val\\">${priorityBreakdown.high}</div></div>\\n      <div class=\\"bar\\"><div class=\\"bar-label\\">Orta</div><div class=\\"bar-track\\"><div class=\\"bar-fill\\" style=\\"width:${mediumPct}%;background:#f59e0b\\"></div></div><div class=\\"bar-val\\">${priorityBreakdown.medium}</div></div>\\n      <div class=\\"bar\\"><div class=\\"bar-label\\">Dusuk</div><div class=\\"bar-track\\"><div class=\\"bar-fill\\" style=\\"width:${lowPct}%;background:#94a3b8\\"></div></div><div class=\\"bar-val\\">${priorityBreakdown.low}</div></div>\\n    </div>\\n    <div>\\n      <h2>Intent Dagilimi</h2>\\n      ${intentEntries.slice(0,4).map(([i,c])=>`<div class=\\"bar\\"><div class=\\"bar-label\\">${i}</div><div class=\\"bar-track\\"><div class=\\"bar-fill\\" style=\\"width:${Math.round(c/maxIntent*100)}%\\"></div></div><div class=\\"bar-val\\">${c}</div></div>`).join('')}\\n    </div>\\n  </div>\\n\\n  <h2>Oncelikli Icerikler</h2>\\n  <table>\\n    <tr><th>#</th><th>Keyword</th><th>Format</th><th>Kelime</th><th>Firsat</th><th>Oncelik</th></tr>\\n    ${highPrioList.concat(medPrioList).slice(0,12).map((k,i)=>`<tr><td>${i+1}</td><td><strong>${k.keyword}</strong></td><td>${k.content_format||'-'}</td><td>${k.recommended_word_count||'-'}</td><td>${k.opportunity_score||0}</td><td><span class=\\"tag ${k.content_priority==='high'?'tag-high':'tag-med'}\\">${k.content_priority||'-'}</span></td></tr>`).join('')}\\n  </table>\\n\\n  ${pillarEntries.length>0?`<h2>Pillar-Cluster Yapisi</h2>\\n  <table>\\n    <tr><th>Pillar</th><th>Cluster Sayisi</th><th>Cluster Keywordler</th></tr>\\n    ${pillarEntries.slice(0,5).map(([kw,d])=>`<tr><td><strong>${kw}</strong></td><td>${d.clusters.length}</td><td>${d.clusters.slice(0,4).map(c=>c.keyword).join(', ')}${d.clusters.length>4?' ...':''}</td></tr>`).join('')}\\n  </table>`:''}\\n\\n  ${topCompetitors.length>0?`<h2>Rakip Analizi</h2>\\n  <div class=\\"grid\\" style=\\"grid-template-columns:repeat(3,1fr);margin-bottom:16px\\">\\n    <div class=\\"box\\"><div class=\\"num\\">${avgWordCount}</div><div class=\\"lbl\\">Ort. Kelime</div></div>\\n    <div class=\\"box\\"><div class=\\"num\\">${maxWordCount}</div><div class=\\"lbl\\">Max</div></div>\\n    <div class=\\"box\\"><div class=\\"num\\">${minWordCount}</div><div class=\\"lbl\\">Min</div></div>\\n  </div>\\n  <table>\\n    <tr><th>Sira</th><th>Domain</th><th>Kelime</th><th>DR</th></tr>\\n    ${topCompetitors.slice(0,5).map(c=>`<tr><td><span class=\\"tag tag-info\\">#${c.serp_position||'-'}</span></td><td>${c.competitor_domain||'-'}</td><td>${c.word_count||0}</td><td>${c.domain_rating||0}</td></tr>`).join('')}\\n  </table>`:''}\\n\\n  <h2>Keyword Listesi</h2>\\n  <table>\\n    <tr><th>Keyword</th><th>Intent</th><th>Firsat</th><th>Oncelik</th><th>Format</th></tr>\\n    ${topKwList.slice(0,20).map(k=>`<tr><td>${k.keyword}</td><td>${k.search_intent||'-'}</td><td><strong>${k.opportunity_score||0}</strong></td><td><span class=\\"tag ${k.content_priority==='high'?'tag-high':k.content_priority==='medium'?'tag-med':'tag-low'}\\">${k.content_priority||'-'}</span></td><td>${k.content_format||'-'}</td></tr>`).join('')}\\n  </table>\\n\\n  <div class=\\"footer\\">SEOART Content Studio | ${new Date().toLocaleString('tr-TR')}</div>\\n</body>\\n</html>`;\\n\\n// ============ RETURN BASED ON FORMAT ============\\nreturn [{\\n  json: {\\n    format: format,\\n    project: {\\n      id: project.id,\\n      name: project.project_name,\\n      main_keyword: project.main_keyword,\\n      client_name: project.client_name,\\n      client_domain: project.client_domain,\\n      status: project.status,\\n      target_country: project.target_country,\\n      target_language: project.target_language\\n    },\\n    statistics: stats,\\n    priority_breakdown: priorityBreakdown,\\n    intent_distribution: intentGroups,\\n    content_format_distribution: formatGroups,\\n    clusters: clusters,\\n    content_plan: contentPlan,\\n    serp_features: serpFeatures,\\n    csv_exports: {\\n      summary: summaryCsv,\\n      keywords: keywordsCsv,\\n      competitors: competitorsCsv,\\n      paa: paaCsv\\n    },\\n    html_report: htmlReport,\\n    raw_data: {\\n      keywords: keywords,\\n      competitors: competitors,\\n      paa_questions: paaData\\n    },\\n    generated_at: new Date().toISOString()\\n  }\\n}];"},"id":"1f78c1f9-f824-41c5-b47b-6a4aea384dff","name":"Code - Prepare Report","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-html","leftValue":"={{ $json.format }}","rightValue":"html","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"c7562643-2fac-4c55-ac98-bdfd9e06168d","name":"IF - HTML Format","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"respondWith":"text","responseBody":"={{ $json.html_report }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"text/html; charset=utf-8"}]}}},"id":"6b621cb7-e30e-4c49-87af-f90982e312a4","name":"Respond - HTML","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[0,0]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-csv","leftValue":"={{ $json.format }}","rightValue":"csv","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"f31dca35-da22-44ba-8140-e5cacd80e194","name":"IF - CSV Format","type":"n8n-nodes-base.if","typeVersion":2,"position":[0,208]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"format\\": \\"csv\\",\\n  \\"project\\": {{ JSON.stringify($json.project) }},\\n  \\"files\\": {\\n    \\"summary.csv\\": {{ JSON.stringify($json.csv_exports.summary) }},\\n    \\"keywords.csv\\": {{ JSON.stringify($json.csv_exports.keywords) }},\\n    \\"competitors.csv\\": {{ JSON.stringify($json.csv_exports.competitors) }},\\n    \\"paa.csv\\": {{ JSON.stringify($json.csv_exports.paa) }}\\n  },\\n  \\"generated_at\\": \\"{{ $json.generated_at }}\\"\\n}","options":{}},"id":"b2f3b65d-d87c-451c-b5eb-ac2c02a582a5","name":"Respond - CSV","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[224,112]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"format\\": \\"json\\",\\n  \\"project\\": {{ JSON.stringify($json.project) }},\\n  \\"statistics\\": {{ JSON.stringify($json.statistics) }},\\n  \\"priority_breakdown\\": {{ JSON.stringify($json.priority_breakdown) }},\\n  \\"intent_distribution\\": {{ JSON.stringify($json.intent_distribution) }},\\n  \\"content_format_distribution\\": {{ JSON.stringify($json.content_format_distribution) }},\\n  \\"clusters\\": {{ JSON.stringify($json.clusters) }},\\n  \\"content_plan\\": {{ JSON.stringify($json.content_plan) }},\\n  \\"serp_features\\": {{ JSON.stringify($json.serp_features) }},\\n  \\"raw_data\\": {{ JSON.stringify($json.raw_data) }},\\n  \\"csv_exports\\": {{ JSON.stringify($json.csv_exports) }},\\n  \\"html_report\\": {{ JSON.stringify($json.html_report) }},\\n  \\"generated_at\\": \\"{{ $json.generated_at }}\\"\\n}","options":{}},"id":"a2c61194-0174-406e-9dca-84904f3de44a","name":"Respond - JSON","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[224,304]}]	{"Webhook":{"main":[[{"node":"Code - Validate Input","type":"main","index":0}]]},"Code - Validate Input":{"main":[[{"node":"IF - Valid Input","type":"main","index":0}]]},"IF - Valid Input":{"main":[[{"node":"MySQL - Get Project","type":"main","index":0}],[{"node":"Respond - Validation Error","type":"main","index":0}]]},"MySQL - Get Project":{"main":[[{"node":"IF - Project Exists","type":"main","index":0}]]},"IF - Project Exists":{"main":[[{"node":"MySQL - Get Keywords","type":"main","index":0}],[{"node":"Respond - Not Found","type":"main","index":0}]]},"MySQL - Get Keywords":{"main":[[{"node":"MySQL - Get Competitors","type":"main","index":0}]]},"MySQL - Get Competitors":{"main":[[{"node":"MySQL - Get SERP Features","type":"main","index":0}]]},"MySQL - Get SERP Features":{"main":[[{"node":"MySQL - Get PAA","type":"main","index":0}]]},"MySQL - Get PAA":{"main":[[{"node":"Code - Prepare Report","type":"main","index":0}]]},"Code - Prepare Report":{"main":[[{"node":"IF - HTML Format","type":"main","index":0}]]},"IF - HTML Format":{"main":[[{"node":"Respond - HTML","type":"main","index":0}],[{"node":"IF - CSV Format","type":"main","index":0}]]},"IF - CSV Format":{"main":[[{"node":"Respond - CSV","type":"main","index":0}],[{"node":"Respond - JSON","type":"main","index":0}]]}}	2025-12-17 10:30:14.926+00	2025-12-17 10:30:14.926+00	{"executionOrder":"v1"}	\N	{}	c6ba8c4f-fe4b-4ac8-9751-938e63afe4ee	1	S0zn4vyawwOhLuuO	{"templateCredsSetupCompleted":true}	\N	f	18	\N	c6ba8c4f-fe4b-4ac8-9751-938e63afe4ee
WF-003 Sheets Get Columns	t	[{"parameters":{"httpMethod":"POST","path":"sheets-get-columns","responseMode":"responseNode","options":{}},"id":"webhook","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"sheets-get-columns"},{"parameters":{"documentId":{"__rl":true,"mode":"id","value":"={{ $json.body.spreadsheet_id }}"},"sheetName":{"__rl":true,"mode":"name","value":"={{ $json.body.sheet_name }}"},"options":{}},"id":"read-headers","name":"Read Headers","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[224,0],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const row = $json;\\nconst columns = [];\\nlet colIndex = 0;\\nfor (const [key, value] of Object.entries(row)) {\\n  if (key !== 'row_number') {\\n    const letter = String.fromCharCode(65 + colIndex);\\n    columns.push({ letter, header: value || '' });\\n    colIndex++;\\n  }\\n}\\nreturn { json: { success: true, columns } };"},"id":"format","name":"Format","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"respond","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,0]}]	{"Webhook":{"main":[[{"node":"Read Headers","type":"main","index":0}]]},"Read Headers":{"main":[[{"node":"Format","type":"main","index":0}]]},"Format":{"main":[[{"node":"Respond","type":"main","index":0}]]}}	2025-12-18 11:34:23.44+00	2025-12-18 12:05:21.735+00	{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false}	\N	{}	41b2d0c6-e47c-47fc-98ba-d3cb742389f0	1	IGWk6RXq1AHpB4L1	{"templateCredsSetupCompleted":true}	\N	f	19	\N	41b2d0c6-e47c-47fc-98ba-d3cb742389f0
WF-004 Sheets Check	t	[{"parameters":{"httpMethod":"POST","path":"sheets-check","responseMode":"responseNode","options":{}},"id":"webhook","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"sheets-check"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const body = $json.body || {};\\nconst mappings = body.column_mappings || {};\\nconst startRow = body.start_row || 2;\\n\\n// Get first mapped column (usually 'keyword' -> 'A')\\nconst firstCol = Object.values(mappings)[0] || 'A';\\nconst range = `${firstCol}${startRow}:${firstCol}`;\\n\\nreturn { json: { \\n  spreadsheet_id: body.spreadsheet_id,\\n  sheet_name: body.sheet_name,\\n  range,\\n  start_row: startRow\\n}};"},"id":"prepare","name":"Prepare","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"documentId":{"__rl":true,"mode":"id","value":"={{ $json.spreadsheet_id }}"},"sheetName":{"__rl":true,"mode":"name","value":"={{ $json.sheet_name }}"},"options":{}},"id":"read-data","name":"Read Data","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[448,0],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}},"onError":"continueErrorOutput"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const items = $input.all();\\nconst rowCount = items.length;\\nconst hasData = rowCount > 0 && Object.keys(items[0].json || {}).length > 1;\\nconst startRow = $('Prepare').item.json.start_row;\\n\\nreturn { json: {\\n  success: true,\\n  has_existing_data: hasData,\\n  existing_row_count: hasData ? rowCount : 0,\\n  first_empty_row: hasData ? startRow + rowCount : startRow\\n}};"},"id":"analyze","name":"Analyze","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,-64]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const startRow = $('Prepare').item.json.start_row;\\nreturn { json: {\\n  success: true,\\n  has_existing_data: false,\\n  existing_row_count: 0,\\n  first_empty_row: startRow\\n}};"},"id":"no-data","name":"No Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,80]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"respond-ok","name":"Respond OK","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[880,-64]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"respond-empty","name":"Respond Empty","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[880,80]}]	{"Webhook":{"main":[[{"node":"Prepare","type":"main","index":0}]]},"Prepare":{"main":[[{"node":"Read Data","type":"main","index":0}]]},"Read Data":{"main":[[{"node":"Analyze","type":"main","index":0}],[{"node":"No Data","type":"main","index":0}]]},"Analyze":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"No Data":{"main":[[{"node":"Respond Empty","type":"main","index":0}]]}}	2025-12-18 11:34:23.547+00	2025-12-18 12:05:31.695+00	{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false}	\N	{}	d567b778-8181-432e-80b2-e2aae9143edc	1	fkgU1ClgOCaGeuXR	{"templateCredsSetupCompleted":true}	\N	f	19	\N	d567b778-8181-432e-80b2-e2aae9143edc
WF-KEYWORD-RESEARCH: Bulk v13	f	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"3594851f-00c8-48d9-9743-3ca4781d724e","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1536,112],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"const body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\n\\nif (!keywords.length) return [{json:{error:'keywords required',code:400}}];\\n\\nconst seeds = keywords.map(k => String(k).trim().toLowerCase()).filter(k => k.length >= 2).slice(0, 50);\\nif (!seeds.length) return [{json:{error:'valid keywords required',code:400}}];\\n\\nconst locCodes = {TR:2792,US:2840,GB:2826,DE:2276};\\n\\nreturn [{json:{\\n  seeds,\\n  projectId: projectId ? parseInt(projectId) : null,\\n  clientId: clientId ? parseInt(clientId) : null,\\n  locationCode: locCodes[country] || 2792,\\n  language,\\n  startTime: Date.now()\\n}}];"},"id":"2604818f-822e-4086-988e-c69d92b5c7f8","name":"Validate","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1328,112]},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\"keywords\\": {{ JSON.stringify($json.seeds) }}, \\"location_code\\": {{ $json.locationCode }}, \\"language_code\\": \\"{{ $json.language }}\\", \\"include_seed_keyword\\": true, \\"sort_by\\": \\"search_volume\\"}]","options":{"timeout":90000}},"id":"a41f6e74-7ef6-47f5-8b22-f2160be1dbb6","name":"DataForSEO","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1104,112],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const prev = $('Validate').first().json;\\nconst dfs = $input.first().json;\\nconst seeds = prev.seeds;\\n\\n// Parse keywords\\nlet allKw = [];\\ntry {\\n  if (dfs?.tasks?.[0]?.result) {\\n    allKw = dfs.tasks[0].result.map(k => ({\\n      kw: (k.keyword||'').toLowerCase().trim(),\\n      vol: k.search_volume||0,\\n      cpc: k.cpc||0\\n    })).filter(k => k.kw.length >= 2);\\n  }\\n} catch(e) {}\\n\\n// Dedupe\\nconst seen = new Set();\\nconst unique = allKw.filter(k => {\\n  if (seen.has(k.kw)) return false;\\n  seen.add(k.kw);\\n  return true;\\n}).slice(0, 2000);\\n\\n// Build mega prompt - classification + filtering in one\\nconst seedList = seeds.map((s,i) => `${i+1}. ${s}`).join('\\\\n');\\nconst kwList = unique.map((k,i) => `${i+1}|${k.kw}|${k.vol}`).join('\\\\n');\\n\\nconst prompt = `GOREV: Her keyword'u dogru SEED ile eslestir ve icerik uygunlugunu degerlendir.\\n\\nSEED'LER:\\n${seedList}\\n\\nKEYWORDS (no|keyword|volume):\\n${kwList}\\n\\nKURALLAR:\\n1. Her keyword EN UYGUN seed ile eslesir (anlamsal, marka, kategori)\\n2. Alakasiz = seed 0\\n3. Her seed icin MAX 35 icerige uygun keyword sec (ANA)\\n4. Geri kalanlar DIGER (benzerler birlestir: fiyat/fiyati1 tane)\\n\\nCIKTI FORMATI - HER SEED ICIN:\\n[SEED_NO]\\nANA:1,5,12,23\\nDIGER:2,8,15,31\\n\\nOrnek:\\n[1]\\nANA:3,7,15,22,45\\nDIGER:2,9,18,33,41\\n\\n[2]\\nANA:1,6,19,28\\nDIGER:4,11,24,37\\n\\nSADECE NUMARALAR. ACIKLAMA YOK.`;\\n\\nreturn [{json:{...prev, keywords: unique, prompt}}];"},"id":"4a8a5a7a-80bc-43d1-9151-b1c1d0875378","name":"Parse DFS","type":"n8n-nodes-base.code","typeVersion":2,"position":[-880,112]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\"contents\\":[{\\"parts\\":[{\\"text\\":{{ JSON.stringify($json.prompt) }}}]}],\\"generationConfig\\":{\\"temperature\\":0.15,\\"maxOutputTokens\\":65536}}","options":{"timeout":180000}},"id":"5a1e38b4-8601-4262-af39-37faecc16a87","name":"Gemini","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-656,112],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const prev = $('Parse DFS').first().json;\\nconst gemini = $input.first().json;\\nconst seeds = prev.seeds;\\nconst kws = prev.keywords;\\n\\nconst approved = [];\\nconst rejected = [];\\nconst perSeed = {};\\n\\ntry {\\n  const txt = gemini?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  \\n  // Parse each seed block\\n  const blocks = txt.split(/\\\\[\\\\s*(\\\\d+)\\\\s*\\\\]/).filter(b => b.trim());\\n  \\n  for (let i = 0; i < blocks.length - 1; i += 2) {\\n    const seedIdx = parseInt(blocks[i]) - 1;\\n    const content = blocks[i + 1];\\n    \\n    if (seedIdx < 0 || seedIdx >= seeds.length) continue;\\n    const seed = seeds[seedIdx];\\n    \\n    // Parse ANA line\\n    const anaMatch = content.match(/ANA[:\\\\s]*([\\\\d,\\\\s]+)/i);\\n    const anaNos = anaMatch ? anaMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => n > 0 && n <= kws.length) : [];\\n    \\n    // Parse DIGER line\\n    const digerMatch = content.match(/DIGER[:\\\\s]*([\\\\d,\\\\s]+)/i);\\n    const digerNos = digerMatch ? digerMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => n > 0 && n <= kws.length) : [];\\n    \\n    anaNos.forEach(n => {\\n      const k = kws[n-1];\\n      if (k) approved.push({keyword: k.kw, seed_keyword: seed, search_volume: k.vol, cpc: k.cpc, status: 'approved', priority: k.vol >= 5000 ? 'high' : k.vol >= 1000 ? 'medium' : 'low'});\\n    });\\n    \\n    digerNos.forEach(n => {\\n      const k = kws[n-1];\\n      if (k) rejected.push({keyword: k.kw, seed_keyword: seed, search_volume: k.vol, status: 'rejected'});\\n    });\\n    \\n    perSeed[seed] = {approved: anaNos.length, others: digerNos.length};\\n  }\\n} catch(e) {\\n  // Fallback: distribute evenly\\n  const perSeedCount = Math.ceil(kws.length / seeds.length);\\n  seeds.forEach((seed, si) => {\\n    const start = si * perSeedCount;\\n    const chunk = kws.slice(start, start + perSeedCount).sort((a,b) => b.vol - a.vol);\\n    chunk.slice(0, 35).forEach(k => approved.push({keyword: k.kw, seed_keyword: seed, search_volume: k.vol, status: 'approved', priority: 'medium'}));\\n    chunk.slice(35).forEach(k => rejected.push({keyword: k.kw, seed_keyword: seed, search_volume: k.vol, status: 'rejected'}));\\n    perSeed[seed] = {approved: Math.min(35, chunk.length), others: Math.max(0, chunk.length - 35)};\\n  });\\n}\\n\\nreturn [{json:{\\n  projectId: prev.projectId,\\n  clientId: prev.clientId,\\n  seeds: seeds,\\n  stats: {total_seeds: seeds.length, total_approved: approved.length, total_others: rejected.length, per_seed: perSeed},\\n  approved_keywords: approved,\\n  rejected_keywords: rejected,\\n  startTime: prev.startTime\\n}}];"},"id":"5d84465b-2a7e-4ee0-967a-ba94bb4d8992","name":"Parse Gemini","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"leftValue":"","typeValidation":"loose"},"conditions":[{"leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}]},"options":{}},"id":"76d90745-07d8-4224-8690-3de4e058dbd3","name":"IF DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"jsCode":"const d = $input.first().json;\\nconst all = [...(d.approved_keywords||[]), ...(d.rejected_keywords||[])];\\nif (!all.length || !d.projectId) return [{json:{...d, query:'SELECT 1'}}];\\n\\nconst esc = s => s == null ? 'NULL' : \\"'\\" + String(s).replace(/'/g, \\"''\\") + \\"'\\";\\nconst vals = all.slice(0, 2000).map(k => \\n  `(${d.projectId},${esc(k.keyword)},${esc(k.seed_keyword)},'related',${k.search_volume||'NULL'},${k.cpc||'NULL'},NULL,NULL,${esc(k.seed_keyword)},${esc(k.priority)},'cluster','dataforseo','${k.status}',NULL)`\\n).join(',');\\n\\nreturn [{json:{...d, query:`INSERT INTO keyword_results(project_id,keyword,seed_keyword,keyword_type,search_volume,cpc,competition,search_intent,keyword_cluster,content_priority,page_type,source,status,reject_reason) VALUES ${vals} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume),status=VALUES(status),seed_keyword=VALUES(seed_keyword)`}}];"},"id":"d0208b95-0789-45d0-a64a-8a3798943f36","name":"Build SQL","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,0]},{"parameters":{"operation":"executeQuery","query":"={{ $json.query }}","options":{}},"id":"da623ab2-0b34-44c8-ab8f-09b30eabca66","name":"MySQL","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const d = $('Build SQL').first().json;\\nreturn [{json:{\\n  success: true,\\n  message: `Bulk: ${d.approved_keywords?.length||0} ana sonuc, ${d.rejected_keywords?.length||0} diger kelime`,\\n  project_id: d.projectId,\\n  stats: d.stats,\\n  keywords: (d.approved_keywords||[]).map(k => ({keyword:k.keyword, seed_keyword:k.seed_keyword, search_volume:k.search_volume, priority:k.priority, status:k.status})),\\n  rejected_keywords: (d.rejected_keywords||[]).map(k => ({keyword:k.keyword, seed_keyword:k.seed_keyword, search_volume:k.search_volume})),\\n  processing_time_ms: Date.now() - d.startTime\\n}}];"},"id":"30cb9238-546d-4fba-a8d3-bc4387b18f35","name":"Response DB","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"jsCode":"const d = $input.first().json;\\nreturn [{json:{\\n  success: true,\\n  message: `Bulk: ${d.approved_keywords?.length||0} ana sonuc, ${d.rejected_keywords?.length||0} diger kelime`,\\n  project_id: null,\\n  stats: d.stats,\\n  keywords: (d.approved_keywords||[]).map(k => ({keyword:k.keyword, seed_keyword:k.seed_keyword, search_volume:k.search_volume, priority:k.priority, status:k.status})),\\n  rejected_keywords: (d.rejected_keywords||[]).map(k => ({keyword:k.keyword, seed_keyword:k.seed_keyword, search_volume:k.search_volume})),\\n  processing_time_ms: Date.now() - d.startTime\\n}}];"},"id":"1c7862c4-8e30-4c25-83df-5073b8ef870f","name":"Response No DB","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,208]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"7b425ed5-aa71-4c23-9733-205bb3d39a5a","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,112]}]	{"Webhook":{"main":[[{"node":"Validate","type":"main","index":0}]]},"Validate":{"main":[[{"node":"DataForSEO","type":"main","index":0}]]},"DataForSEO":{"main":[[{"node":"Parse DFS","type":"main","index":0}]]},"Parse DFS":{"main":[[{"node":"Gemini","type":"main","index":0}]]},"Gemini":{"main":[[{"node":"Parse Gemini","type":"main","index":0}]]},"Parse Gemini":{"main":[[{"node":"IF DB","type":"main","index":0}]]},"IF DB":{"main":[[{"node":"Build SQL","type":"main","index":0}],[{"node":"Response No DB","type":"main","index":0}]]},"Build SQL":{"main":[[{"node":"MySQL","type":"main","index":0}]]},"MySQL":{"main":[[{"node":"Response DB","type":"main","index":0}]]},"Response DB":{"main":[[{"node":"Respond","type":"main","index":0}]]},"Response No DB":{"main":[[{"node":"Respond","type":"main","index":0}]]}}	2025-12-23 08:12:16.817+00	2025-12-23 19:40:53.634+00	{"executionOrder":"v1"}	{"global":{}}	{}	e06053c4-e931-487a-94ae-31c187226716	1	adol4O3V4iGsGXpf	\N	\N	f	38	\N	\N
WF-105: SERP Feature Detector	t	[{"parameters":{"httpMethod":"POST","path":"tool1-serp-features/:projectId/detect","responseMode":"responseNode","options":{}},"id":"b3091565-5ad5-4597-a2ea-c2160dd1ff09","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1536,208],"webhookId":"tool1-serp-features"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const projectId = $json.params?.projectId;\\n\\nif (!projectId) {\\n  return { json: { isValid: false, error: 'projectId parametresi zorunludur', errorCode: 400 } };\\n}\\n\\nconst parsedId = parseInt(projectId);\\nif (isNaN(parsedId) || parsedId <= 0) {\\n  return { json: { isValid: false, error: 'projectId gecerli bir pozitif sayi olmalidir', errorCode: 400 } };\\n}\\n\\nreturn { json: { isValid: true, projectId: parsedId } };"},"id":"72e8c1e5-9b9d-4613-b3be-f109416d5061","name":"Code - Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1328,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"744c5962-48e6-46d4-b7fb-00c73b3fc2f4","name":"IF - Valid Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1104,208]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Validation failed\\",\\n  \\"message\\": \\"{{ $json.error }}\\"\\n}","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"e53d5427-c6bf-4c55-9e3d-9ea7654c9591","name":"Respond - Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-880,400]},{"parameters":{"operation":"executeQuery","query":"=SELECT kp.id as project_id, kp.main_keyword, kp.target_country, kp.target_language, kp.client_id, COALESCE(cc.enable_ahrefs_api, 0) as enable_ahrefs_api FROM keyword_projects kp LEFT JOIN client_configurations cc ON kp.client_id = cc.client_id WHERE kp.id = {{ $json.projectId }} LIMIT 1","options":{}},"id":"32bd83e4-aa1d-408b-9eb0-81ecb8da36a1","name":"MySQL - Get Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-880,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"const result = $input.first().json;\\nconst validatedData = $('Code - Validate Input').first().json;\\n\\nif (!result.project_id) {\\n  return [{ json: { projectExists: false, projectId: validatedData.projectId } }];\\n}\\n\\nlet apiSource = 'serper';\\nif (result.enable_ahrefs_api === 1) {\\n  apiSource = 'ahrefs';\\n}\\n\\nreturn [{ json: { projectExists: true, projectId: result.project_id, mainKeyword: result.main_keyword, targetCountry: result.target_country || 'tr', targetLanguage: result.target_language || 'tr', apiSource: apiSource } }];"},"id":"fa377785-0b75-4a88-a4b7-e0f1e2cc55fd","name":"Code - Check Project","type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"project-exists","leftValue":"={{ $json.projectExists }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"b4119e54-4fd6-467d-b501-30ec8666464b","name":"IF - Project Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-448,208]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Project not found\\",\\n  \\"message\\": \\"Proje bulunamadi: {{ $json.projectId }}\\"\\n}","options":{"responseCode":404}},"id":"61cafd85-a140-4863-85b8-70898c3d51c8","name":"Respond - Not Found","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-224,400]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.apiSource }}","rightValue":"ahrefs","operator":{"type":"string","operation":"equals"}}],"combinator":"and"}},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.apiSource }}","rightValue":"serper","operator":{"type":"string","operation":"equals"}}],"combinator":"and"}}]},"options":{}},"id":"49728d31-7cae-4723-978c-4941001ccf33","name":"Switch - API Source","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-224,208]},{"parameters":{"url":"https://api.ahrefs.com/v3/serp-overview/serp-features","authentication":"predefinedCredentialType","nodeCredentialType":"httpHeaderAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"target","value":"={{ $json.mainKeyword }}"},{"name":"country","value":"={{ $json.targetCountry }}"}]},"options":{"timeout":30000}},"id":"f7a56c31-c611-4f03-bf53-dbd7b209d253","name":"HTTP - Ahrefs SERP","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,0],"credentials":{"httpHeaderAuth":{"id":"01zZGrP0Fob8kD8r","name":"Serper API"}},"continueOnFail":true},{"parameters":{"method":"POST","url":"https://google.serper.dev/search","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"q\\": \\"{{ $json.mainKeyword }}\\",\\n  \\"gl\\": \\"{{ $json.targetCountry || 'tr' }}\\",\\n  \\"hl\\": \\"{{ $json.targetLanguage || 'tr' }}\\",\\n  \\"num\\": 10\\n}","options":{"timeout":30000}},"id":"c22c95f3-481b-4947-a1e9-5c98e0e97652","name":"HTTP - Serper SERP","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,208],"credentials":{"httpHeaderAuth":{"id":"01zZGrP0Fob8kD8r","name":"Serper API"}},"continueOnFail":true},{"parameters":{"jsCode":"const input = $input.first().json;\\nconst projectData = $('Code - Check Project').first().json;\\nconst projectId = projectData.projectId;\\n\\nlet serpData = {\\n  project_id: projectId,\\n  has_featured_snippet: false,\\n  featured_snippet_type: 'none',\\n  featured_snippet_content: null,\\n  featured_snippet_url: null,\\n  has_paa: false,\\n  paa_count: 0,\\n  has_video_results: false,\\n  has_image_pack: false,\\n  has_local_pack: false,\\n  has_knowledge_panel: false,\\n  has_shopping_results: false,\\n  has_news_results: false,\\n  organic_results_count: 10,\\n  ads_count: 0,\\n  zero_click_risk: 'low',\\n  paa_questions: [],\\n  source: 'ahrefs'\\n};\\n\\nif (!input || input.error) {\\n  return [{ json: { ...serpData, source: 'ahrefs_failed' } }];\\n}\\n\\nconst serp = input.serp || input;\\nserpData.has_featured_snippet = !!serp.featured_snippet;\\nif (serp.featured_snippet) {\\n  serpData.featured_snippet_type = serp.featured_snippet.type || 'paragraph';\\n  serpData.featured_snippet_content = serp.featured_snippet.content || null;\\n  serpData.featured_snippet_url = serp.featured_snippet.url || null;\\n}\\n\\nserpData.has_paa = Array.isArray(serp.people_also_ask) && serp.people_also_ask.length > 0;\\nserpData.paa_count = serp.people_also_ask?.length || 0;\\nserpData.has_video_results = Array.isArray(serp.video_results) && serp.video_results.length > 0;\\nserpData.has_image_pack = !!serp.image_pack;\\nserpData.has_local_pack = !!serp.local_pack;\\nserpData.has_knowledge_panel = !!serp.knowledge_panel;\\nserpData.organic_results_count = serp.organic?.length || 10;\\nserpData.ads_count = serp.ads?.length || 0;\\n\\nlet riskScore = 0;\\nif (serpData.has_featured_snippet) riskScore += 2;\\nif (serpData.has_knowledge_panel) riskScore += 2;\\nif (serpData.paa_count > 3) riskScore += 1;\\nserpData.zero_click_risk = riskScore >= 4 ? 'high' : riskScore >= 2 ? 'medium' : 'low';\\n\\nserpData.paa_questions = (serp.people_also_ask || []).map((paa, idx) => ({\\n  question: paa.question || paa,\\n  answer_snippet: paa.snippet || null,\\n  source_url: paa.url || null,\\n  source_domain: paa.domain || null,\\n  position: idx + 1\\n}));\\n\\nreturn [{ json: serpData }];"},"id":"3710f1fc-8e1c-49d9-ac5d-e174a776da76","name":"Code - Transform Ahrefs","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"jsCode":"const input = $input.first().json;\\nconst projectData = $('Code - Check Project').first().json;\\nconst projectId = projectData.projectId;\\nconst keyword = projectData.mainKeyword;\\n\\nlet serpData = {\\n  project_id: projectId,\\n  has_featured_snippet: false,\\n  featured_snippet_type: 'none',\\n  featured_snippet_content: null,\\n  featured_snippet_url: null,\\n  has_paa: false,\\n  paa_count: 0,\\n  has_video_results: false,\\n  has_image_pack: false,\\n  has_local_pack: false,\\n  has_knowledge_panel: false,\\n  has_shopping_results: false,\\n  has_news_results: false,\\n  organic_results_count: 10,\\n  ads_count: 0,\\n  zero_click_risk: 'low',\\n  paa_questions: [],\\n  source: 'serper'\\n};\\n\\nif (!input || input.error) {\\n  serpData.source = 'serper_failed';\\n  return [{ json: serpData }];\\n}\\n\\n// Parse Serper response\\nif (input.answerBox) {\\n  serpData.has_featured_snippet = true;\\n  serpData.featured_snippet_type = input.answerBox.snippetType || 'paragraph';\\n  serpData.featured_snippet_content = input.answerBox.snippet || input.answerBox.answer || null;\\n  serpData.featured_snippet_url = input.answerBox.link || null;\\n}\\n\\nif (input.peopleAlsoAsk && input.peopleAlsoAsk.length > 0) {\\n  serpData.has_paa = true;\\n  serpData.paa_count = input.peopleAlsoAsk.length;\\n  serpData.paa_questions = input.peopleAlsoAsk.map((paa, idx) => ({\\n    question: paa.question,\\n    answer_snippet: paa.snippet || null,\\n    source_url: paa.link || null,\\n    source_domain: paa.link ? paa.link.match(/https?:\\\\/\\\\/([^\\\\/]+)/)?.[1] : null,\\n    position: idx + 1\\n  }));\\n}\\n\\nserpData.has_video_results = !!(input.videos && input.videos.length > 0);\\nserpData.has_image_pack = !!(input.images && input.images.length > 0);\\nserpData.has_local_pack = !!(input.places && input.places.length > 0);\\nserpData.has_knowledge_panel = !!input.knowledgeGraph;\\nserpData.has_shopping_results = !!(input.shopping && input.shopping.length > 0);\\nserpData.has_news_results = !!(input.news && input.news.length > 0);\\nserpData.organic_results_count = input.organic?.length || 10;\\nserpData.ads_count = input.ads?.length || 0;\\n\\nlet riskScore = 0;\\nif (serpData.has_featured_snippet) riskScore += 2;\\nif (serpData.has_knowledge_panel) riskScore += 2;\\nif (serpData.paa_count > 3) riskScore += 1;\\nif (serpData.ads_count > 2) riskScore += 1;\\nserpData.zero_click_risk = riskScore >= 4 ? 'high' : riskScore >= 2 ? 'medium' : 'low';\\n\\nreturn [{ json: serpData }];"},"id":"8802ce58-bb1f-4122-88ce-1c24ea0914b2","name":"Code - Transform Serper","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,208]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO serp_features (project_id, has_featured_snippet, featured_snippet_type, featured_snippet_content, featured_snippet_url, has_paa, paa_count, has_video_results, has_image_pack, has_local_pack, has_knowledge_panel, has_shopping_results, has_news_results, organic_results_count, ads_count, zero_click_risk) VALUES ({{ $json.project_id }}, {{ $json.has_featured_snippet ? 1 : 0 }}, '{{ $json.featured_snippet_type }}', {{ $json.featured_snippet_content ? \\"'\\" + $json.featured_snippet_content.replace(/'/g, \\"''\\").substring(0, 500) + \\"'\\" : 'NULL' }}, {{ $json.featured_snippet_url ? \\"'\\" + $json.featured_snippet_url + \\"'\\" : 'NULL' }}, {{ $json.has_paa ? 1 : 0 }}, {{ $json.paa_count }}, {{ $json.has_video_results ? 1 : 0 }}, {{ $json.has_image_pack ? 1 : 0 }}, {{ $json.has_local_pack ? 1 : 0 }}, {{ $json.has_knowledge_panel ? 1 : 0 }}, {{ $json.has_shopping_results ? 1 : 0 }}, {{ $json.has_news_results ? 1 : 0 }}, {{ $json.organic_results_count }}, {{ $json.ads_count }}, '{{ $json.zero_click_risk }}') ON DUPLICATE KEY UPDATE has_featured_snippet = VALUES(has_featured_snippet), featured_snippet_type = VALUES(featured_snippet_type), featured_snippet_content = VALUES(featured_snippet_content), featured_snippet_url = VALUES(featured_snippet_url), has_paa = VALUES(has_paa), paa_count = VALUES(paa_count), has_video_results = VALUES(has_video_results), has_image_pack = VALUES(has_image_pack), has_local_pack = VALUES(has_local_pack), has_knowledge_panel = VALUES(has_knowledge_panel), has_shopping_results = VALUES(has_shopping_results), has_news_results = VALUES(has_news_results), organic_results_count = VALUES(organic_results_count), ads_count = VALUES(ads_count), zero_click_risk = VALUES(zero_click_risk), analyzed_at = NOW()","options":{}},"id":"8259a4be-50b7-4703-97ca-e09adae3ad9e","name":"MySQL - Save SERP Features","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[448,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"const serpData = $('Code - Transform Serper').all()[0]?.json || $('Code - Transform Ahrefs').all()[0]?.json;\\nif (!serpData) {\\n  return [{ json: { skip_paa: true, paa_count: 0 } }];\\n}\\n\\nconst projectId = serpData.project_id;\\nconst paaQuestions = serpData.paa_questions || [];\\n\\nif (paaQuestions.length === 0) {\\n  return [{ json: { project_id: projectId, skip_paa: true, paa_count: 0 } }];\\n}\\n\\nreturn paaQuestions.map((paa, idx) => ({\\n  json: {\\n    project_id: projectId,\\n    question: (paa.question || '').replace(/'/g, \\"''\\").substring(0, 500),\\n    answer_snippet: paa.answer_snippet ? paa.answer_snippet.replace(/'/g, \\"''\\").substring(0, 1000) : null,\\n    source_url: paa.source_url || null,\\n    source_domain: paa.source_domain || null,\\n    position: paa.position || idx + 1,\\n    is_recommended_as_h2: idx < 2 ? 1 : 0,\\n    is_recommended_as_h3: idx >= 2 ? 1 : 0,\\n    relevance_score: (100 - (idx * 10)).toFixed(2)\\n  }\\n}));"},"id":"f08f6e3b-4a25-4fd1-97b8-1be3021d36e6","name":"Code - Split PAA","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-paa","leftValue":"={{ $json.skip_paa }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"cd686630-75a5-4618-959e-cbb79dbd8417","name":"IF - Has PAA","type":"n8n-nodes-base.if","typeVersion":2,"position":[880,112]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO paa_data (project_id, question, answer_snippet, source_url, source_domain, position, is_recommended_as_h2, is_recommended_as_h3, relevance_score) VALUES ({{ $json.project_id }}, '{{ $json.question }}', {{ $json.answer_snippet ? \\"'\\" + $json.answer_snippet + \\"'\\" : 'NULL' }}, {{ $json.source_url ? \\"'\\" + $json.source_url + \\"'\\" : 'NULL' }}, {{ $json.source_domain ? \\"'\\" + $json.source_domain + \\"'\\" : 'NULL' }}, {{ $json.position }}, {{ $json.is_recommended_as_h2 }}, {{ $json.is_recommended_as_h3 }}, {{ $json.relevance_score }}) ON DUPLICATE KEY UPDATE answer_snippet = VALUES(answer_snippet), source_url = VALUES(source_url), source_domain = VALUES(source_domain)","options":{}},"id":"64f9ab2d-8a51-4ffc-a2b6-beb653be9c6f","name":"MySQL - Save PAA","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1104,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"const serpData = $('Code - Transform Serper').all()[0]?.json || $('Code - Transform Ahrefs').all()[0]?.json || {};\\nconst paaCount = serpData.paa_questions?.length || 0;\\n\\nconst warnings = [];\\nif (!serpData.has_paa) warnings.push('Bu arama icin PAA (People Also Ask) bulunamadi');\\nif (!serpData.has_featured_snippet) warnings.push('Bu arama icin Featured Snippet bulunamadi');\\nif (!serpData.has_knowledge_panel) warnings.push('Bu arama icin Knowledge Panel bulunamadi');\\n\\nreturn [{\\n  json: {\\n    success: true,\\n    message: warnings.length > 0 ? 'SERP analizi tamamlandi (bazi ozellikler bulunamadi)' : 'SERP features detected successfully',\\n    project_id: serpData.project_id,\\n    serp_features: {\\n      has_featured_snippet: serpData.has_featured_snippet || false,\\n      featured_snippet_type: serpData.featured_snippet_type || 'none',\\n      has_paa: serpData.has_paa || false,\\n      paa_count: serpData.paa_count || 0,\\n      has_video_results: serpData.has_video_results || false,\\n      has_image_pack: serpData.has_image_pack || false,\\n      has_local_pack: serpData.has_local_pack || false,\\n      has_knowledge_panel: serpData.has_knowledge_panel || false,\\n      has_shopping_results: serpData.has_shopping_results || false,\\n      has_news_results: serpData.has_news_results || false,\\n      zero_click_risk: serpData.zero_click_risk || 'low'\\n    },\\n    paa_questions_saved: paaCount,\\n    warnings: warnings,\\n    source: serpData.source || 'unknown'\\n  }\\n}];"},"id":"30036c4d-50c2-4744-9686-450ceef1c83f","name":"Code - Prepare Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1328,112]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"a2e2f100-6a01-473d-97b6-c9507c2e24f8","name":"Respond - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1552,112]}]	{"Webhook":{"main":[[{"node":"Code - Validate Input","type":"main","index":0}]]},"Code - Validate Input":{"main":[[{"node":"IF - Valid Input","type":"main","index":0}]]},"IF - Valid Input":{"main":[[{"node":"MySQL - Get Project","type":"main","index":0}],[{"node":"Respond - Validation Error","type":"main","index":0}]]},"MySQL - Get Project":{"main":[[{"node":"Code - Check Project","type":"main","index":0}]]},"Code - Check Project":{"main":[[{"node":"IF - Project Exists","type":"main","index":0}]]},"IF - Project Exists":{"main":[[{"node":"Switch - API Source","type":"main","index":0}],[{"node":"Respond - Not Found","type":"main","index":0}]]},"Switch - API Source":{"main":[[{"node":"HTTP - Ahrefs SERP","type":"main","index":0}],[{"node":"HTTP - Serper SERP","type":"main","index":0}]]},"HTTP - Ahrefs SERP":{"main":[[{"node":"Code - Transform Ahrefs","type":"main","index":0}]]},"HTTP - Serper SERP":{"main":[[{"node":"Code - Transform Serper","type":"main","index":0}]]},"Code - Transform Ahrefs":{"main":[[{"node":"MySQL - Save SERP Features","type":"main","index":0}]]},"Code - Transform Serper":{"main":[[{"node":"MySQL - Save SERP Features","type":"main","index":0}]]},"MySQL - Save SERP Features":{"main":[[{"node":"Code - Split PAA","type":"main","index":0}]]},"Code - Split PAA":{"main":[[{"node":"IF - Has PAA","type":"main","index":0}]]},"IF - Has PAA":{"main":[[{"node":"MySQL - Save PAA","type":"main","index":0}],[{"node":"Code - Prepare Response","type":"main","index":0}]]},"MySQL - Save PAA":{"main":[[{"node":"Code - Prepare Response","type":"main","index":0}]]},"Code - Prepare Response":{"main":[[{"node":"Respond - Success","type":"main","index":0}]]}}	2025-12-17 10:28:38.266+00	2025-12-17 10:28:38.266+00	{"executionOrder":"v1"}	\N	{}	47de4265-58d6-42c2-9a3d-854120b78853	1	E29x9qTqO4XIfetR	{"templateCredsSetupCompleted":true}	\N	f	18	\N	47de4265-58d6-42c2-9a3d-854120b78853
WF-005 Sheets Write	f	[{"parameters":{"httpMethod":"POST","path":"sheets-write","responseMode":"responseNode","options":{}},"id":"a3fcfc72-9c17-4c55-b17e-275b5b9c5a3a","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-672,80],"webhookId":"sheets-write"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const body = $json.body || {};\\nconst mappings = body.column_mappings || {};\\nconst data = body.data || [];\\nconst startRow = body.start_row || 2;\\nconst writeMode = body.write_mode || 'append';\\nconst includeHeaders = body.include_headers !== false;\\n\\n// Get column letters sorted\\nconst columns = Object.entries(mappings).sort((a, b) => a[1].localeCompare(b[1]));\\nconst firstCol = columns[0]?.[1] || 'A';\\nconst lastCol = columns[columns.length - 1]?.[1] || 'A';\\n\\n// Build values array for Sheets API\\nconst values = [];\\n\\n// Add headers if needed\\nif (includeHeaders) {\\n  const headerRow = [];\\n  const labels = {\\n    keyword: 'Anahtar Kelime',\\n    search_volume: 'Arama Hacmi',\\n    keyword_difficulty: 'Zorluk',\\n    cpc: 'CPC',\\n    competition: 'Rekabet',\\n    search_intent: 'Arama Niyeti',\\n    opportunity_score: 'Frsat Skoru',\\n    ai_category: 'AI Kategori'\\n  };\\n  for (const [field, col] of columns) {\\n    headerRow.push(labels[field] || field);\\n  }\\n  values.push(headerRow);\\n}\\n\\n// Add data rows\\nfor (const item of data) {\\n  const row = [];\\n  for (const [field, col] of columns) {\\n    const val = item[field];\\n    row.push(val !== null && val !== undefined ? String(val) : '');\\n  }\\n  values.push(row);\\n}\\n\\n// Calculate range for replace (exact range) vs append (starting point)\\nconst dataStartRow = includeHeaders ? 1 : startRow;\\nconst dataEndRow = dataStartRow + values.length - 1;\\nconst exactRange = `${body.sheet_name}!${firstCol}${dataStartRow}:${lastCol}${dataEndRow}`;\\nconst appendRange = `${body.sheet_name}!${firstCol}:${lastCol}`;\\n\\nreturn { json: {\\n  spreadsheet_id: body.spreadsheet_id,\\n  sheet_name: body.sheet_name,\\n  exact_range: exactRange,\\n  append_range: appendRange,\\n  values: values,\\n  write_mode: writeMode,\\n  row_count: data.length\\n}};"},"id":"215c15a1-ad4e-4c57-b80a-3e5bb33e3215","name":"Prepare Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,80]},{"parameters":{"conditions":{"options":{"caseSensitive":true},"conditions":[{"id":"c1","leftValue":"={{ $json.write_mode }}","rightValue":"replace","operator":{"type":"string","operation":"equals"}}]},"options":{}},"id":"04aa4aeb-e05d-4431-91c7-fc27f32124e7","name":"IF Replace","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,80]},{"parameters":{"method":"POST","url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.sheet_name) }}!A:Z:clear","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","options":{}},"id":"7e6bb1e9-879b-4881-b604-3f325a05f95b","name":"Clear Sheet","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,0],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"return { json: $('Prepare Data').item.json };"},"id":"93459e45-1c88-48e3-9183-c3abd6a530ae","name":"Restore (Replace)","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"method":"PUT","url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.exact_range) }}?valueInputOption=USER_ENTERED","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ range: $json.exact_range, values: $json.values }) }}","options":{}},"id":"53037a00-b6d8-402b-9ef7-d1b0a98f971f","name":"Write (Replace)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[448,0],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"method":"POST","url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.append_range) }}:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ values: $json.values }) }}","options":{}},"id":"039bdec8-ed44-43c7-b475-e5890e95ef87","name":"Write (Append)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,160],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const prepData = $('Prepare Data').item.json;\\nconst response = $json;\\nconst updatedRows = response.updatedRows || prepData.values.length;\\n\\nreturn { json: {\\n  success: true,\\n  rows_written: updatedRows,\\n  spreadsheet_url: `https://docs.google.com/spreadsheets/d/${prepData.spreadsheet_id}`\\n}};"},"id":"174df93a-e7fb-4091-b4b8-2abbc650bdd6","name":"Format (Replace)","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const prepData = $('Prepare Data').item.json;\\nconst response = $json;\\nconst updatedRows = response.updates?.updatedRows || prepData.values.length;\\n\\nreturn { json: {\\n  success: true,\\n  rows_written: updatedRows,\\n  spreadsheet_url: `https://docs.google.com/spreadsheets/d/${prepData.spreadsheet_id}`\\n}};"},"id":"6e529f28-9d94-44ba-9d22-19ca25d4f5b1","name":"Format (Append)","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,160]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"3bd2b97b-10f9-49a8-a2fe-bf28040fc3e4","name":"Respond (Replace)","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[896,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"e677d34c-fe67-4356-9c57-2b01d17c6847","name":"Respond (Append)","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[448,160]}]	{"Webhook":{"main":[[{"node":"Prepare Data","type":"main","index":0}]]},"Prepare Data":{"main":[[{"node":"IF Replace","type":"main","index":0}]]},"IF Replace":{"main":[[{"node":"Clear Sheet","type":"main","index":0}],[{"node":"Write (Append)","type":"main","index":0}]]},"Clear Sheet":{"main":[[{"node":"Restore (Replace)","type":"main","index":0}]]},"Restore (Replace)":{"main":[[{"node":"Write (Replace)","type":"main","index":0}]]},"Write (Replace)":{"main":[[{"node":"Format (Replace)","type":"main","index":0}]]},"Write (Append)":{"main":[[{"node":"Format (Append)","type":"main","index":0}]]},"Format (Replace)":{"main":[[{"node":"Respond (Replace)","type":"main","index":0}]]},"Format (Append)":{"main":[[{"node":"Respond (Append)","type":"main","index":0}]]}}	2025-12-19 09:14:49.15+00	2025-12-21 10:58:05.441+00	{"executionOrder":"v1"}	\N	{}	f7cd0ca4-f01c-4f88-8d44-102e6cde14ce	1	886MnxYqCbAQ1Bjz	\N	\N	t	8	\N	\N
WF-101c: Get Keywords	t	[{"parameters":{"path":":projectId/keywords","responseMode":"responseNode","options":{}},"id":"faafc4d6-51f2-4c06-bcf3-dd1d97829f4c","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"tool1-get-keywords"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Input validation - supports both numeric ID and UUID\\nconst projectId = $json.params?.projectId;\\n\\nif (!projectId) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'project_id parametresi zorunludur',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\n// Check if it's a valid UUID format\\nconst uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\\nconst isUuid = uuidRegex.test(projectId);\\n\\n// Check if it's a valid numeric ID\\nconst parsedId = parseInt(projectId);\\nconst isNumericId = !isNaN(parsedId) && parsedId > 0;\\n\\nif (!isUuid && !isNumericId) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'project_id gecerli bir sayi veya UUID olmalidir',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nconst query = $json.query || {};\\nconst limit = Math.min(Math.max(parseInt(query.limit) || 100, 1), 500);\\nconst offset = Math.max(parseInt(query.offset) || 0, 0);\\n\\nreturn {\\n  json: {\\n    isValid: true,\\n    projectId: isUuid ? projectId : parsedId,\\n    isUuid: isUuid,\\n    limit: limit,\\n    offset: offset\\n  }\\n};"},"id":"6e6b10f1-aad4-47f7-be5e-57503a0fcf65","name":"Code - Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"109e698e-93a6-4bc2-afaa-99386c0241fb","name":"IF - Valid Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,0]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Validation failed\\",\\n  \\"message\\": \\"{{ $json.error }}\\"\\n}","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"5c09e9fd-1270-4b7f-bc70-0dd24e722cec","name":"Respond - Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,160]},{"parameters":{"operation":"executeQuery","query":"=SELECT id as project_id, project_name, main_keyword, status FROM keyword_projects WHERE {{ $json.isUuid ? \\"uuid = '\\" + $json.projectId + \\"'\\" : \\"id = \\" + $json.projectId }}","options":{}},"id":"4f1577da-8132-462d-9713-6f60616ec826","name":"MySQL - Check Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Check if project exists\\nconst result = $input.first().json;\\nconst validatedData = $('Code - Validate Input').first().json;\\n\\nif (!result.project_id) {\\n  return [{\\n    json: {\\n      projectExists: false,\\n      projectId: validatedData.projectId\\n    }\\n  }];\\n}\\n\\n// Use the actual numeric project_id from DB (important when UUID was used)\\nreturn [{\\n  json: {\\n    projectExists: true,\\n    projectId: result.project_id,\\n    projectName: result.project_name,\\n    mainKeyword: result.main_keyword,\\n    status: result.status,\\n    limit: validatedData.limit,\\n    offset: validatedData.offset\\n  }\\n}];"},"id":"06f9fe43-c7cf-4f1b-9679-43c85b83d003","name":"Code - Check Project","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,0]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"project-exists","leftValue":"={{ $json.projectExists }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"96537062-2449-4836-a73f-5ad1f1083848","name":"IF - Project Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[1104,0]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Project not found\\",\\n  \\"message\\": \\"Proje bulunamadi: {{ $json.projectId }}\\"\\n}","options":{"responseCode":404}},"id":"e3eb5050-661a-4b16-925f-392c541b7f4a","name":"Respond - Project Not Found","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1328,160]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  kr.id,\\n  kr.keyword,\\n  kr.keyword_type,\\n  kr.search_volume,\\n  kr.keyword_difficulty,\\n  kr.cpc,\\n  kr.competition,\\n  kr.search_intent,\\n  kr.trend_direction,\\n  kr.parent_topic,\\n  kr.keyword_cluster,\\n  kr.opportunity_score,\\n  kr.source,\\n  kr.created_at\\nFROM keyword_results kr\\nWHERE kr.project_id = {{ $json.projectId }}\\nORDER BY \\n  CASE WHEN kr.opportunity_score IS NOT NULL THEN 0 ELSE 1 END,\\n  kr.opportunity_score DESC,\\n  kr.search_volume DESC\\nLIMIT {{ $json.limit }}\\nOFFSET {{ $json.offset }}","options":{}},"id":"9a7dae16-d6b7-41d9-a6b9-bf16268e1d95","name":"MySQL - Get Keywords","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1328,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  COUNT(*) as total_count,\\n  COALESCE(AVG(search_volume), 0) as avg_volume,\\n  COALESCE(AVG(keyword_difficulty), 0) as avg_difficulty,\\n  COALESCE(AVG(opportunity_score), 0) as avg_opportunity,\\n  SUM(CASE WHEN search_intent IS NOT NULL THEN 1 ELSE 0 END) as with_intent\\nFROM keyword_results \\nWHERE project_id = {{ $('IF - Project Exists').item.json.projectId }}","options":{}},"id":"7a452111-e93d-40ad-b7a6-503e6866331e","name":"MySQL - Get Stats","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1552,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Aggregate results\\nconst keywordItems = $('MySQL - Get Keywords').all();\\nconst statsResult = $input.first().json;\\nconst projectData = $('IF - Project Exists').first().json;\\n\\n// Check if keywords exist\\nconst hasKeywords = keywordItems.length > 0 && !!keywordItems[0].json.id;\\nconst keywords = hasKeywords ? keywordItems.map(i => i.json) : [];\\n\\n// Group by type\\nconst byType = {};\\nkeywords.forEach(kw => {\\n  const type = kw.keyword_type || 'unknown';\\n  if (!byType[type]) byType[type] = 0;\\n  byType[type]++;\\n});\\n\\n// Group by cluster\\nconst byCluster = {};\\nkeywords.forEach(kw => {\\n  if (kw.keyword_cluster) {\\n    if (!byCluster[kw.keyword_cluster]) byCluster[kw.keyword_cluster] = 0;\\n    byCluster[kw.keyword_cluster]++;\\n  }\\n});\\n\\n// Group by intent\\nconst byIntent = {};\\nkeywords.forEach(kw => {\\n  if (kw.search_intent) {\\n    if (!byIntent[kw.search_intent]) byIntent[kw.search_intent] = 0;\\n    byIntent[kw.search_intent]++;\\n  }\\n});\\n\\nreturn [{\\n  json: {\\n    success: true,\\n    project: {\\n      id: projectData.projectId,\\n      name: projectData.projectName,\\n      main_keyword: projectData.mainKeyword,\\n      status: projectData.status\\n    },\\n    data: keywords,\\n    stats: {\\n      total: parseInt(statsResult.total_count) || 0,\\n      filtered_count: keywords.length,\\n      with_intent: parseInt(statsResult.with_intent) || 0,\\n      avg_volume: Math.round(parseFloat(statsResult.avg_volume) || 0),\\n      avg_difficulty: Math.round(parseFloat(statsResult.avg_difficulty) || 0),\\n      avg_opportunity: Math.round(parseFloat(statsResult.avg_opportunity) || 0)\\n    },\\n    by_type: byType,\\n    by_cluster: byCluster,\\n    by_intent: byIntent,\\n    pagination: {\\n      limit: projectData.limit,\\n      offset: projectData.offset,\\n      returned: keywords.length,\\n      has_more: keywords.length === projectData.limit\\n    }\\n  }\\n}];"},"id":"fc5ca91c-5ad6-42ab-ac5a-93fa3032fd6f","name":"Code - Aggregate","type":"n8n-nodes-base.code","typeVersion":2,"position":[1760,0]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"50273772-4471-4b73-a6b1-7914bd1a2f7e","name":"Respond - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1984,0]}]	{"Webhook":{"main":[[{"node":"Code - Validate Input","type":"main","index":0}]]},"Code - Validate Input":{"main":[[{"node":"IF - Valid Input","type":"main","index":0}]]},"IF - Valid Input":{"main":[[{"node":"MySQL - Check Project","type":"main","index":0}],[{"node":"Respond - Validation Error","type":"main","index":0}]]},"MySQL - Check Project":{"main":[[{"node":"Code - Check Project","type":"main","index":0}]]},"Code - Check Project":{"main":[[{"node":"IF - Project Exists","type":"main","index":0}]]},"IF - Project Exists":{"main":[[{"node":"MySQL - Get Keywords","type":"main","index":0}],[{"node":"Respond - Project Not Found","type":"main","index":0}]]},"MySQL - Get Keywords":{"main":[[{"node":"MySQL - Get Stats","type":"main","index":0}]]},"MySQL - Get Stats":{"main":[[{"node":"Code - Aggregate","type":"main","index":0}]]},"Code - Aggregate":{"main":[[{"node":"Respond - Success","type":"main","index":0}]]}}	2025-12-17 10:27:36.026+00	2025-12-17 10:27:36.026+00	{"executionOrder":"v1"}	\N	{}	e446236e-cc11-4f88-9622-af72007ff710	1	r8uQ8T48G7SDp9or	{"templateCredsSetupCompleted":true}	\N	f	18	\N	e446236e-cc11-4f88-9622-af72007ff710
WF-KEYWORD-RESEARCH: Keyword Discovery & Filter v3	t	[{"parameters":{"httpMethod":"POST","path":"keyword-research","responseMode":"responseNode","options":{}},"id":"ce71ae02-218b-4c38-b350-8d3ba1bdf514","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-2960,-192],"webhookId":"keyword-research"},{"parameters":{"jsCode":"// ===========================================\\n// INPUT VALIDATION\\n// ===========================================\\nconst body = $json.body || $json;\\nconst keyword = body.keyword || body.main_keyword;\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\nconst customRules = body.custom_rules || '';\\n\\nif (!keyword || keyword.trim().length < 2) {\\n  return [{ json: { \\n    isValid: false, \\n    error: 'keyword parametresi zorunludur (min 2 karakter)', \\n    errorCode: 400 \\n  }}];\\n}\\n\\nconst locationCodes = {\\n  'TR': 2792, 'US': 2840, 'GB': 2826, 'DE': 2276, 'FR': 2250\\n};\\n\\nreturn [{ json: { \\n  isValid: true, \\n  keyword: keyword.trim().toLowerCase(),\\n  projectId: projectId ? parseInt(projectId) : null,\\n  clientId: clientId ? parseInt(clientId) : null,\\n  country: country,\\n  language: language,\\n  locationCode: locationCodes[country] || 2792,\\n  customRules: customRules\\n}}];"},"id":"438536cb-683f-4538-b7b0-d83a59b51046","name":"Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2736,-192]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"eccec6cd-cfb2-4642-b4a9-4bab435372b1","name":"IF Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-2512,-192]},{"parameters":{"respondWith":"json","responseBody":"={ \\"success\\": false, \\"error\\": \\"{{ $json.error }}\\" }","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"9147c91b-3161-4634-8999-c11d1d4f6bba","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-2288,32]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  COALESCE(cc.enable_ai_analysis, 1) as enable_ai_analysis,\\n  cc.ai_model_preference,\\n  cc.ai_temperature,\\n  sp.prompt_text as filter_prompt\\nFROM (SELECT 1 as dummy) d\\nLEFT JOIN client_configurations cc ON cc.client_id = {{ $json.clientId || 0 }}\\nLEFT JOIN system_prompts sp ON sp.slug = 'keyword-filter' AND sp.is_active = 1\\nLIMIT 1","options":{}},"id":"1ff0a02c-0423-48c5-9d75-b8ca52309dcf","name":"Get Client Config & Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-2288,-192],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// ===========================================\\n// PREPARE CONFIG FOR API CALLS\\n// ===========================================\\nconst input = $('Validate Input').first().json;\\nconst config = $input.first().json;\\n\\nreturn [{ json: {\\n  ...input,\\n  enableAiAnalysis: config.enable_ai_analysis == 1 || config.enable_ai_analysis === null,\\n  aiModel: config.ai_model_preference || 'gemini-2.0-flash',\\n  aiTemperature: parseFloat(config.ai_temperature) || 0.3,\\n  filterPromptTemplate: config.filter_prompt || ''\\n}}];"},"id":"cff631a6-fa4e-4496-906b-5eff852737c2","name":"Prepare Config","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2080,-192]},{"parameters":{"url":"=http://suggestqueries.google.com/complete/search?client=firefox&q={{ encodeURIComponent($json.keyword) }}&hl={{ $json.language }}&gl={{ $json.country.toLowerCase() }}","options":{"timeout":15000}},"id":"6e8c52e4-bf1d-4357-bdd1-3db837d34b44","name":"Google Suggestions","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1856,-192],"onError":"continueRegularOutput"},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\n  \\"keywords\\": [\\"{{ $('Prepare Config').first().json.keyword }}\\"],\\n  \\"location_code\\": {{ $('Prepare Config').first().json.locationCode }},\\n  \\"language_code\\": \\"{{ $('Prepare Config').first().json.language }}\\",\\n  \\"include_seed_keyword\\": true,\\n  \\"sort_by\\": \\"search_volume\\"\\n}]","options":{"timeout":60000}},"id":"99f78ec1-df9f-4828-90b4-1b8df289baeb","name":"DataForSEO Keywords","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1632,-192],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// MERGE ALL KEYWORD SOURCES + TURKISH NORMALIZATION\\n// ===========================================\\nconst config = $('Prepare Config').first().json;\\nconst mainKeyword = config.keyword;\\n\\nfunction normalizeForComparison(str) {\\n  return str.toLowerCase()\\n    .replace(//g, 'i').replace(//g, 'i')\\n    .replace(//g, 's').replace(//g, 's')\\n    .replace(//g, 'o').replace(//g, 'o')\\n    .replace(//g, 'u').replace(//g, 'u')\\n    .replace(//g, 'c').replace(//g, 'c')\\n    .replace(//g, 'g').replace(//g, 'g')\\n    .replace(/[^a-z0-9\\\\s]/g, '')\\n    .replace(/\\\\s+/g, ' ')\\n    .trim();\\n}\\n\\nfunction hasTurkishChars(str) {\\n  return /[]/.test(str);\\n}\\n\\nlet suggestions = [];\\ntry {\\n  const sugResponse = $('Google Suggestions').first().json;\\n  if (Array.isArray(sugResponse) && Array.isArray(sugResponse[1])) {\\n    suggestions = sugResponse[1].map(s => ({\\n      keyword: String(s).toLowerCase(),\\n      search_volume: null,\\n      cpc: null,\\n      competition: null,\\n      source: 'google_suggest'\\n    }));\\n  }\\n} catch (e) { console.log('Suggestions parse error:', e.message); }\\n\\nlet dataforseoKeywords = [];\\ntry {\\n  const dfsResponse = $('DataForSEO Keywords').first().json;\\n  if (dfsResponse?.tasks?.[0]?.result && Array.isArray(dfsResponse.tasks[0].result)) {\\n    dataforseoKeywords = dfsResponse.tasks[0].result.map(kw => ({\\n      keyword: (kw.keyword || '').toLowerCase(),\\n      search_volume: kw.search_volume || 0,\\n      cpc: kw.cpc || 0,\\n      competition: kw.competition || null,\\n      competition_index: kw.competition_index || 0,\\n      source: 'dataforseo'\\n    })).filter(kw => kw.keyword);\\n  }\\n} catch (e) { console.log('DataForSEO parse error:', e.message); }\\n\\nconst allKeywords = [...dataforseoKeywords, ...suggestions];\\nconst seen = new Map();\\n\\nallKeywords.forEach(kw => {\\n  if (!kw.keyword || kw.keyword.length < 2) return;\\n  const normalizedKey = normalizeForComparison(kw.keyword);\\n  if (!normalizedKey || normalizedKey.length < 2) return;\\n  \\n  if (!seen.has(normalizedKey)) {\\n    seen.set(normalizedKey, kw);\\n  } else {\\n    const existing = seen.get(normalizedKey);\\n    if (hasTurkishChars(kw.keyword) && !hasTurkishChars(existing.keyword)) {\\n      kw.search_volume = kw.search_volume || existing.search_volume;\\n      kw.cpc = kw.cpc || existing.cpc;\\n      kw.source = existing.source + ',' + kw.source;\\n      seen.set(normalizedKey, kw);\\n    } else if (kw.search_volume && !existing.search_volume) {\\n      existing.search_volume = kw.search_volume;\\n      existing.cpc = kw.cpc;\\n    }\\n  }\\n});\\n\\nconst uniqueKeywords = Array.from(seen.values());\\n\\nconst mainNormalized = normalizeForComparison(mainKeyword);\\nif (!seen.has(mainNormalized)) {\\n  uniqueKeywords.unshift({\\n    keyword: mainKeyword,\\n    search_volume: null,\\n    cpc: null,\\n    competition: null,\\n    source: 'seed'\\n  });\\n}\\n\\nreturn [{\\n  json: {\\n    mainKeyword: mainKeyword,\\n    projectId: config.projectId,\\n    clientId: config.clientId,\\n    country: config.country,\\n    language: config.language,\\n    customRules: config.customRules,\\n    enableAiAnalysis: config.enableAiAnalysis,\\n    aiModel: config.aiModel,\\n    aiTemperature: config.aiTemperature,\\n    filterPromptTemplate: config.filterPromptTemplate,\\n    keywords: uniqueKeywords,\\n    stats: {\\n      total_raw: allKeywords.length,\\n      after_dedup: uniqueKeywords.length,\\n      from_google_suggest: suggestions.length,\\n      from_dataforseo: dataforseoKeywords.length\\n    }\\n  }\\n}];"},"id":"9c2ba053-872e-4b76-b9c1-52745965f515","name":"Merge Keywords","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1408,-192]},{"parameters":{"jsCode":"// ===========================================\\n// PREPARE FILTER PROMPT FROM DATABASE\\n// Uses keyword-filter system prompt\\n// v4: Passes ALL keywords for later saving\\n// ===========================================\\nconst data = $input.first().json;\\nconst keywords = data.keywords || [];\\nconst mainKeyword = data.mainKeyword;\\nconst country = data.country;\\nconst language = data.language;\\nconst customRules = data.customRules || '';\\nlet promptTemplate = data.filterPromptTemplate || '';\\n\\nif (keywords.length === 0) {\\n  return [{ json: { skip: true, message: 'No keywords to filter' } }];\\n}\\n\\nif (!data.enableAiAnalysis) {\\n  return [{ json: { skipAi: true, ...data } }];\\n}\\n\\n// Sort ALL keywords by volume\\nconst allSortedKeywords = [...keywords]\\n  .sort((a, b) => (b.search_volume || 0) - (a.search_volume || 0));\\n\\n// Only top 150 go to AI for processing\\nconst aiKeywords = allSortedKeywords.slice(0, 150);\\n// Remaining keywords will be saved as pending\\nconst remainingKeywords = allSortedKeywords.slice(150);\\n\\n// Build keyword CSV for AI\\nconst keywordCsv = aiKeywords.map((kw, i) => {\\n  const vol = kw.search_volume || 0;\\n  const cpc = kw.cpc ? kw.cpc.toFixed(2) : '0';\\n  const comp = kw.competition || '';\\n  const src = kw.source || '';\\n  return `${i+1}|${kw.keyword}|${vol}|${cpc}|${comp}|${src}`;\\n}).join('\\\\n');\\n\\n// Use DB prompt or fallback\\nlet prompt = '';\\nif (promptTemplate) {\\n  prompt = promptTemplate\\n    .replace(/\\\\{\\\\{main_keyword\\\\}\\\\}/g, mainKeyword)\\n    .replace(/\\\\{\\\\{country\\\\}\\\\}/g, country)\\n    .replace(/\\\\{\\\\{language\\\\}\\\\}/g, language)\\n    .replace(/\\\\{\\\\{keyword_list\\\\}\\\\}/g, keywordCsv);\\n} else {\\n  prompt = `Sen bir SEO uzmanisin. Keyword listesini analiz et.\\\\n\\\\nAna Keyword: ${mainKeyword}\\\\nKEYWORDS:\\\\n${keywordCsv}\\\\n\\\\nCIKTI: No|status|intent|cluster|priority|content_type|reject_reason`;\\n}\\n\\nif (customRules) {\\n  prompt += `\\\\n\\\\n ZEL KURALLAR:\\\\n${customRules}`;\\n}\\n\\nreturn [{\\n  json: {\\n    ...data,\\n    skip: false,\\n    skipAi: false,\\n    filterPrompt: prompt,\\n    processedKeywords: aiKeywords,\\n    remainingKeywords: remainingKeywords,\\n    totalKeywords: allSortedKeywords.length\\n  }\\n}];"},"id":"b38cfe93-765c-44b2-bb1b-600e5ba7a1b1","name":"Prepare Filter Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1184,-192]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"not-skip","leftValue":"={{ $json.skip }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}},{"id":"not-skip-ai","leftValue":"={{ $json.skipAi }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"74ffbb2c-c5e2-4a5b-a9a7-f2ac6b8fc0d6","name":"IF Run Filter","type":"n8n-nodes-base.if","typeVersion":2,"position":[-960,-192]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{\\n    \\"parts\\": [{\\n      \\"text\\": {{ JSON.stringify($json.filterPrompt) }}\\n    }]\\n  }],\\n  \\"generationConfig\\": {\\n    \\"temperature\\": {{ $json.aiTemperature || 0.3 }},\\n    \\"maxOutputTokens\\": 8192\\n  }\\n}","options":{"timeout":90000}},"id":"22543871-2af3-4b52-9bd9-c4dd70e4b1ce","name":"Gemini Filter","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-736,-288],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// PARSE FILTER RESPONSE (Approved/Rejected)\\n// v4: Includes ALL remaining keywords as pending\\n// ===========================================\\nconst prevData = $('Prepare Filter Prompt').first().json;\\nconst geminiResponse = $input.first().json;\\nconst processedKeywords = prevData.processedKeywords || [];\\nconst remainingKeywords = prevData.remainingKeywords || [];\\n\\nconst approved = [];\\nconst rejected = [];\\n\\ntry {\\n  const text = geminiResponse?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  const lines = text.split('\\\\n').filter(l => /^\\\\d+\\\\|/.test(l.trim()));\\n  \\n  for (const line of lines) {\\n    const parts = line.split('|').map(p => p.trim());\\n    if (parts.length < 2) continue;\\n    \\n    const no = parseInt(parts[0]);\\n    const status = (parts[1] || '').toLowerCase();\\n    \\n    if (isNaN(no) || no < 1 || no > processedKeywords.length) continue;\\n    \\n    const original = processedKeywords[no - 1];\\n    \\n    if (status === 'approved') {\\n      approved.push({\\n        ...original,\\n        index: no,\\n        intent: parts[2] && parts[2] !== '' ? parts[2].toLowerCase() : null,\\n        cluster: parts[3] && parts[3] !== '' ? parts[3] : null,\\n        priority: parts[4] && parts[4] !== '' ? parts[4].toLowerCase() : 'medium',\\n        content_type: parts[5] && parts[5] !== '' ? parts[5].toLowerCase() : 'cluster',\\n        status: 'approved',\\n        reject_reason: null\\n      });\\n    } else if (status === 'rejected') {\\n      const cluster = parts[3] && parts[3] !== '' ? parts[3] : null;\\n      const reason = parts[6] && parts[6] !== '' ? parts[6] : 'filtered';\\n      rejected.push({\\n        ...original,\\n        index: no,\\n        intent: null,\\n        cluster: cluster,\\n        priority: null,\\n        content_type: null,\\n        status: 'rejected',\\n        reject_reason: reason\\n      });\\n    }\\n  }\\n  \\n  // Handle AI-processed keywords that weren't in response\\n  const processedIndices = new Set([...approved, ...rejected].map(k => k.index));\\n  processedKeywords.forEach((kw, idx) => {\\n    if (!processedIndices.has(idx + 1)) {\\n      rejected.push({\\n        ...kw,\\n        index: idx + 1,\\n        intent: null,\\n        cluster: null,\\n        priority: null,\\n        content_type: null,\\n        status: 'pending',\\n        reject_reason: 'AI skipped'\\n      });\\n    }\\n  });\\n  \\n  // Add ALL remaining keywords (not sent to AI) as pending\\n  remainingKeywords.forEach((kw, idx) => {\\n    rejected.push({\\n      ...kw,\\n      index: 150 + idx + 1,\\n      intent: null,\\n      cluster: null,\\n      priority: null,\\n      content_type: null,\\n      status: 'pending',\\n      reject_reason: null\\n    });\\n  });\\n  \\n} catch (e) { \\n  console.log('Parse error:', e.message);\\n  processedKeywords.forEach((kw, idx) => {\\n    approved.push({\\n      ...kw,\\n      index: idx + 1,\\n      intent: null,\\n      cluster: 'Genel',\\n      priority: 'medium',\\n      content_type: 'cluster',\\n      status: 'approved',\\n      reject_reason: null\\n    });\\n  });\\n}\\n\\nconst clusters = {};\\napproved.forEach(kw => {\\n  const c = kw.cluster || 'Genel';\\n  if (!clusters[c]) clusters[c] = [];\\n  clusters[c].push(kw.keyword);\\n});\\n\\nreturn [{\\n  json: {\\n    mainKeyword: prevData.mainKeyword,\\n    projectId: prevData.projectId,\\n    clientId: prevData.clientId,\\n    stats: {\\n      ...prevData.stats,\\n      total_processed: processedKeywords.length,\\n      approved_count: approved.length,\\n      rejected_count: rejected.length,\\n      remaining_count: remainingKeywords.length\\n    },\\n    approved_keywords: approved,\\n    rejected_keywords: rejected,\\n    all_keywords: [...approved, ...rejected],\\n    clusters: clusters,\\n    ai_used: true\\n  }\\n}];"},"id":"cb8f8af8-10b2-4a1c-bb19-f0226ed1ad2d","name":"Parse Filter Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[-512,-288]},{"parameters":{"jsCode":"// ===========================================\\n// SKIP AI - Use keywords as-is with defaults\\n// v3: All keywords approved by default when AI is skipped\\n// ===========================================\\nconst data = $input.first().json;\\nconst keywords = data.keywords || [];\\n\\nconst approvedKeywords = keywords.slice(0, 50).map((kw, idx) => ({\\n  ...kw,\\n  index: idx + 1,\\n  intent: null,\\n  cluster: 'Genel',\\n  priority: 'medium',\\n  content_type: 'cluster',\\n  status: 'approved',\\n  reject_reason: null\\n}));\\n\\n// Remaining keywords are pending\\nconst pendingKeywords = keywords.slice(50).map((kw, idx) => ({\\n  ...kw,\\n  index: idx + 51,\\n  intent: null,\\n  cluster: 'Beklemede',\\n  priority: null,\\n  content_type: null,\\n  status: 'pending',\\n  reject_reason: 'AI analysis skipped - pending review'\\n}));\\n\\nreturn [{\\n  json: {\\n    mainKeyword: data.mainKeyword,\\n    projectId: data.projectId,\\n    clientId: data.clientId,\\n    stats: {\\n      ...data.stats,\\n      approved_count: approvedKeywords.length,\\n      rejected_count: pendingKeywords.length\\n    },\\n    approved_keywords: approvedKeywords,\\n    rejected_keywords: pendingKeywords,\\n    all_keywords: [...approvedKeywords, ...pendingKeywords],\\n    clusters: { 'Genel': approvedKeywords.map(k => k.keyword) },\\n    ai_used: false\\n  }\\n}];"},"id":"84db2ce1-aee8-4722-9574-558c0af03a38","name":"Skip AI Filter","type":"n8n-nodes-base.code","typeVersion":2,"position":[-736,-80]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"has-project","leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}],"combinator":"and"},"options":{}},"id":"594d8a8b-b214-487a-b7fc-5f69fd419d8f","name":"IF Save to DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[-288,-192]},{"parameters":{"jsCode":"// ===========================================\\n// PREPARE BATCH INSERT - ALL KEYWORDS WITH STATUS\\n// v5: Fixed source normalization for VARCHAR column\\n// ===========================================\\nlet data = null;\\ntry { data = $('Parse Filter Response').first().json; } catch(e) {}\\nif (!data) { try { data = $('Skip AI Filter').first().json; } catch(e) {} }\\nif (!data) { data = $input.first().json; }\\n\\nconst projectId = data.projectId;\\nconst allKeywords = data.all_keywords || [...(data.approved_keywords || []), ...(data.rejected_keywords || [])];\\n\\nif (allKeywords.length === 0) {\\n  return [{ json: { skip: true, batchQuery: '' } }];\\n}\\n\\nfunction esc(str) {\\n  if (str === null || str === undefined) return 'NULL';\\n  return \\"'\\" + String(str).replace(/\\\\\\\\/g, '\\\\\\\\\\\\\\\\').replace(/'/g, \\"''\\") + \\"'\\";\\n}\\n\\nfunction escOrNull(str) {\\n  if (str === null || str === undefined || str === '') return 'NULL';\\n  return \\"'\\" + String(str).replace(/\\\\\\\\/g, '\\\\\\\\\\\\\\\\').replace(/'/g, \\"''\\") + \\"'\\";\\n}\\n\\n// Normalize source - take first valid source from combined values\\nfunction normalizeSource(src) {\\n  if (!src) return 'dataforseo';\\n  const first = src.split(',')[0].trim();\\n  return first || 'dataforseo';\\n}\\n\\n// Build batch VALUES\\nconst batchSize = 500;\\nconst batches = [];\\n\\nfor (let i = 0; i < allKeywords.length; i += batchSize) {\\n  const batch = allKeywords.slice(i, i + batchSize);\\n  const values = batch.map(kw => {\\n    const kwType = kw.source?.includes('suggest') ? 'google_suggest' : 'related';\\n    const src = normalizeSource(kw.source);\\n    return `(${projectId}, ${esc(kw.keyword)}, '${kwType}', ${kw.search_volume || 'NULL'}, ${kw.cpc || 'NULL'}, ${escOrNull(kw.competition)}, ${escOrNull(kw.intent)}, ${escOrNull(kw.cluster)}, ${escOrNull(kw.priority)}, ${escOrNull(kw.content_type)}, '${src}', '${kw.status || 'pending'}', ${escOrNull(kw.reject_reason)})`;\\n  }).join(',\\\\n');\\n  \\n  const query = `INSERT INTO keyword_results (project_id, keyword, keyword_type, search_volume, cpc, competition, search_intent, keyword_cluster, content_priority, page_type, source, status, reject_reason) VALUES ${values} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume), cpc=VALUES(cpc), search_intent=COALESCE(VALUES(search_intent),search_intent), keyword_cluster=COALESCE(VALUES(keyword_cluster),keyword_cluster), content_priority=COALESCE(VALUES(content_priority),content_priority), page_type=COALESCE(VALUES(page_type),page_type), status=VALUES(status), reject_reason=VALUES(reject_reason)`;\\n  \\n  batches.push({ json: { batchQuery: query, batchIndex: Math.floor(i/batchSize), batchCount: batch.length } });\\n}\\n\\nconsole.log(`[Split for DB] Total: ${allKeywords.length} keywords, ${batches.length} batches`);\\nreturn batches;"},"id":"f909122d-f149-4d46-a173-79cf5baad4e6","name":"Split for DB","type":"n8n-nodes-base.code","typeVersion":2,"position":[-64,-288]},{"parameters":{"operation":"executeQuery","query":"={{ $json.batchQuery }}","options":{}},"id":"d62c4a05-84ac-4a37-8dec-1f618ad13f3a","name":"Save to DB","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[160,-288],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// PREPARE FINAL RESPONSE\\n// v3: Reports both approved and rejected counts\\n// ===========================================\\nlet data = null;\\ntry { data = $('Parse Filter Response').first().json; } catch(e) {}\\nif (!data) { try { data = $('Skip AI Filter').first().json; } catch(e) {} }\\n\\nif (!data) {\\n  return [{ json: { success: false, error: 'Could not retrieve data' } }];\\n}\\n\\nconst approvedKeywords = data.approved_keywords || [];\\nconst rejectedKeywords = data.rejected_keywords || [];\\nconst savedCount = $input.all().length;\\n\\nreturn [{\\n  json: {\\n    success: true,\\n    message: `Keyword arastirmasi tamamlandi. ${approvedKeywords.length} keyword onaylandi, ${rejectedKeywords.length} reddedildi/beklemede, ${savedCount} DB'ye kaydedildi.`,\\n    main_keyword: data.mainKeyword,\\n    project_id: data.projectId,\\n    stats: {\\n      ...data.stats,\\n      saved_to_db: savedCount,\\n      approved_count: approvedKeywords.length,\\n      rejected_count: rejectedKeywords.length\\n    },\\n    keywords: approvedKeywords.map(kw => ({\\n      keyword: kw.keyword,\\n      search_volume: kw.search_volume,\\n      cpc: kw.cpc,\\n      competition: kw.competition,\\n      intent: kw.intent,\\n      cluster: kw.cluster,\\n      priority: kw.priority,\\n      content_type: kw.content_type,\\n      source: kw.source,\\n      status: kw.status\\n    })),\\n    rejected: rejectedKeywords.map(kw => ({\\n      keyword: kw.keyword,\\n      search_volume: kw.search_volume,\\n      reason: kw.reject_reason,\\n      status: kw.status\\n    })),\\n    clusters: data.clusters || {},\\n    ai_used: data.ai_used\\n  }\\n}];"},"id":"508b5272-c633-4347-ba6d-6d074abd14b2","name":"Response (DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[384,-288]},{"parameters":{"jsCode":"// ===========================================\\n// PREPARE RESPONSE (NO DB SAVE)\\n// ===========================================\\nlet data = null;\\ntry { data = $('Parse Filter Response').first().json; } catch(e) {}\\nif (!data) { try { data = $('Skip AI Filter').first().json; } catch(e) {} }\\nif (!data) { data = $input.first().json; }\\n\\nconst approvedKeywords = data.approved_keywords || [];\\nconst rejectedKeywords = data.rejected_keywords || [];\\n\\nreturn [{\\n  json: {\\n    success: true,\\n    message: `Keyword arastirmasi tamamlandi. ${approvedKeywords.length} keyword onaylandi, ${rejectedKeywords.length} reddedildi.`,\\n    main_keyword: data.mainKeyword,\\n    project_id: null,\\n    stats: {\\n      ...data.stats,\\n      saved_to_db: 0\\n    },\\n    keywords: approvedKeywords.map(kw => ({\\n      keyword: kw.keyword,\\n      search_volume: kw.search_volume,\\n      cpc: kw.cpc,\\n      competition: kw.competition,\\n      intent: kw.intent,\\n      cluster: kw.cluster,\\n      priority: kw.priority,\\n      content_type: kw.content_type,\\n      source: kw.source,\\n      status: kw.status\\n    })),\\n    rejected: rejectedKeywords.map(kw => ({\\n      keyword: kw.keyword,\\n      reason: kw.reject_reason,\\n      status: kw.status\\n    })),\\n    clusters: data.clusters || {},\\n    ai_used: data.ai_used\\n  }\\n}];"},"id":"d7cc1eb4-3339-4a5c-8027-b82fd578a30c","name":"Response (No DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[-64,-80]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"2a123e6b-46e1-45b4-844d-02f247859ee1","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[608,-192]},{"parameters":{"respondWith":"json","responseBody":"={ \\"success\\": true, \\"message\\": \\"Keyword bulunamadi\\", \\"keywords\\": [], \\"rejected\\": [], \\"stats\\": {} }","options":{}},"id":"cde5d3cd-74c9-4e8d-bbd5-c12c7a886ee1","name":"Respond Empty","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-736,128]}]	{"Webhook":{"main":[[{"node":"Validate Input","type":"main","index":0}]]},"Validate Input":{"main":[[{"node":"IF Valid","type":"main","index":0}]]},"IF Valid":{"main":[[{"node":"Get Client Config & Prompt","type":"main","index":0}],[{"node":"Respond Error","type":"main","index":0}]]},"Get Client Config & Prompt":{"main":[[{"node":"Prepare Config","type":"main","index":0}]]},"Prepare Config":{"main":[[{"node":"Google Suggestions","type":"main","index":0}]]},"Google Suggestions":{"main":[[{"node":"DataForSEO Keywords","type":"main","index":0}]]},"DataForSEO Keywords":{"main":[[{"node":"Merge Keywords","type":"main","index":0}]]},"Merge Keywords":{"main":[[{"node":"Prepare Filter Prompt","type":"main","index":0}]]},"Prepare Filter Prompt":{"main":[[{"node":"IF Run Filter","type":"main","index":0}]]},"IF Run Filter":{"main":[[{"node":"Gemini Filter","type":"main","index":0}],[{"node":"Skip AI Filter","type":"main","index":0}]]},"Gemini Filter":{"main":[[{"node":"Parse Filter Response","type":"main","index":0}]]},"Parse Filter Response":{"main":[[{"node":"IF Save to DB","type":"main","index":0}]]},"Skip AI Filter":{"main":[[{"node":"IF Save to DB","type":"main","index":0}]]},"IF Save to DB":{"main":[[{"node":"Split for DB","type":"main","index":0}],[{"node":"Response (No DB)","type":"main","index":0}]]},"Split for DB":{"main":[[{"node":"Save to DB","type":"main","index":0}]]},"Save to DB":{"main":[[{"node":"Response (DB)","type":"main","index":0}]]},"Response (DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]},"Response (No DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]}}	2025-12-19 09:29:42.147+00	2025-12-21 11:11:26.876+00	{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false}	\N	{}	c20bd27d-6b9f-4ecd-8d9b-3d18a4e295d1	1	j3jZIjdsJSchQqCe	{"templateCredsSetupCompleted":true,"instanceId":"962669683927cc1437044c6b20237fcf963b814bc72f0acd8ce7d659ad95be86"}	\N	f	16	\N	c20bd27d-6b9f-4ecd-8d9b-3d18a4e295d1
WF-008 Sheets Test	t	[{"parameters":{"httpMethod":"POST","path":"sheets-test","responseMode":"responseNode","options":{}},"id":"98cd196e-1857-4b6e-a7cc-8cd62c9c2680","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"sheets-test"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const body = $json.body || {};\\nconst spreadsheetId = body.spreadsheet_id;\\nconst sheetName = body.sheet_name;\\n\\nif (!spreadsheetId || !sheetName) {\\n  return { json: { success: false, error: 'spreadsheet_id ve sheet_name gerekli' } };\\n}\\n\\nreturn { json: {\\n  spreadsheet_id: spreadsheetId,\\n  sheet_name: sheetName\\n}};"},"id":"f0b26a39-5805-481c-a61c-483d4b1481ce","name":"Prepare","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}?fields=properties.title,sheets(properties(sheetId,title,gridProperties.rowCount))","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","options":{}},"id":"2603cfec-f60c-42ff-a46b-9f196a3a92f3","name":"Get Metadata","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[448,0],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const prepData = $('Prepare').item.json;\\nconst response = $json;\\n\\ntry {\\n  const spreadsheetName = response.properties?.title || '';\\n  const sheets = response.sheets || [];\\n  \\n  // Find the requested sheet\\n  const targetSheet = sheets.find(s => s.properties?.title === prepData.sheet_name);\\n  \\n  if (!targetSheet) {\\n    return { json: {\\n      success: false,\\n      error: `Sheet '${prepData.sheet_name}' bulunamad`\\n    }};\\n  }\\n  \\n  const rowCount = targetSheet.properties?.gridProperties?.rowCount || 0;\\n  \\n  return { json: {\\n    success: true,\\n    spreadsheet_name: spreadsheetName,\\n    sheet_name: prepData.sheet_name,\\n    row_count: rowCount\\n  }};\\n} catch (err) {\\n  return { json: {\\n    success: false,\\n    error: 'Sheet bilgileri alnamad: ' + err.message\\n  }};\\n}"},"id":"2ffca6bd-5fea-40b8-b809-83f383d5a264","name":"Format","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"8b9c5f41-079f-411a-98a6-34fd9a0dc0ac","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[880,0]}]	{"Webhook":{"main":[[{"node":"Prepare","type":"main","index":0}]]},"Prepare":{"main":[[{"node":"Get Metadata","type":"main","index":0}]]},"Get Metadata":{"main":[[{"node":"Format","type":"main","index":0}]]},"Format":{"main":[[{"node":"Respond","type":"main","index":0}]]}}	2025-12-19 12:13:34.244+00	2025-12-19 12:13:34.38+00	{"executionOrder":"v1"}	\N	{}	6afc6c39-3544-4491-87f9-4e2810dcaaf6	1	GcCbIVDLCEBXWH4c	\N	\N	f	9	\N	6afc6c39-3544-4491-87f9-4e2810dcaaf6
WF-BULK-KEYWORD: Single Seed Processor	f	[{"parameters":{},"id":"908e6211-af91-4ad5-b2b9-2ef3806d7bfd","name":"Execute Workflow Trigger","type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1,"position":[0,0]},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\"keywords\\": [\\"{{ $json.seed }}\\"], \\"location_code\\": {{ $json.locationCode }}, \\"language_code\\": \\"{{ $json.language }}\\", \\"include_seed_keyword\\": true, \\"sort_by\\": \\"search_volume\\"}]","options":{"timeout":60000}},"id":"4d7a9a87-7a72-4699-a225-6f54bc4668aa","name":"DataForSEO","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[224,0],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const input = $('Execute Workflow Trigger').first().json;\\nconst dfs = $input.first().json;\\nconst seed = input.seed;\\n\\nlet keywords = [];\\ntry {\\n  if (dfs?.tasks?.[0]?.result) {\\n    keywords = dfs.tasks[0].result.map(k => ({\\n      kw: (k.keyword || '').toLowerCase().trim(),\\n      vol: k.search_volume || 0,\\n      cpc: k.cpc || 0\\n    })).filter(k => k.kw.length >= 2);\\n  }\\n} catch(e) {}\\n\\n// Dedupe\\nconst seen = new Set();\\nconst unique = keywords.filter(k => {\\n  if (seen.has(k.kw)) return false;\\n  seen.add(k.kw);\\n  return true;\\n}).slice(0, 500);\\n\\nif (unique.length === 0) {\\n  return [{json: {\\n    seed,\\n    approved: [],\\n    rejected: [],\\n    stats: {approved: 0, rejected: 0}\\n  }}];\\n}\\n\\nconst kwList = unique.map((k, i) => `${i+1}|${k.kw}|${k.vol}`).join('\\\\n');\\n\\nconst prompt = `\\"${seed}\\" icin anahtar kelime analizi.\\n\\nKEYWORDS (no|keyword|volume):\\n${kwList}\\n\\nGOREV:\\n1. Icerik olusturmaya UYGUN olanlari sec (max 35 adet)\\n   - Blog/makale konusu olabilir mi?\\n   - Arama amaci net mi?\\n   - Bilgi verici icerik yazilabilir mi?\\n   \\n2. UYGUN OLMAYANLAR:\\n   - Sadece marka+model (ornek: \\"nike air max 90\\")\\n   - Cok genel (ornek: \\"ayakkabi\\")\\n   - Fiyat sorgulari (ornek: \\"spor ayakkabi fiyatlari\\")\\n   - Satin alma niyetli (ornek: \\"spor ayakkabi satin al\\")\\n\\n3. Benzer kelimeler tek secilsin:\\n   - fiyat/fiyati/fiyatlari  sadece 1 tane\\n   - erkek/erkekler  sadece 1 tane\\n\\nCIKTI FORMATI (SADECE BU SATIRLAR):\\nCONTENT:1,5,8,12,15\\nOTHERS:2,3,4,6,7,9,10,11,13,14\\n\\nACIKLAMA YAZMA. SADECE NUMARALAR.`;\\n\\nreturn [{json: {...input, keywords: unique, prompt}}];"},"id":"6302aac9-0e7a-4769-8c0a-5687fe36c7bc","name":"Parse DFS","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\"contents\\":[{\\"parts\\":[{\\"text\\":{{ JSON.stringify($json.prompt) }}}]}],\\"generationConfig\\":{\\"temperature\\":0.1,\\"maxOutputTokens\\":4096}}","options":{"timeout":60000}},"id":"302ecb84-712e-4c82-9254-7d050959f37b","name":"Gemini","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[672,0],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const prev = $('Parse DFS').first().json;\\nconst gemini = $input.first().json;\\nconst seed = prev.seed;\\nconst kws = prev.keywords || [];\\n\\nconst approved = [];\\nconst rejected = [];\\n\\ntry {\\n  const txt = gemini?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  \\n  // Parse CONTENT line\\n  const contentMatch = txt.match(/CONTENT[:\\\\s]*([\\\\d,\\\\s]+)/i);\\n  const contentNos = contentMatch \\n    ? contentMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => n > 0 && n <= kws.length)\\n    : [];\\n  \\n  // Parse OTHERS line\\n  const othersMatch = txt.match(/OTHERS[:\\\\s]*([\\\\d,\\\\s]+)/i);\\n  const othersNos = othersMatch\\n    ? othersMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => n > 0 && n <= kws.length)\\n    : [];\\n  \\n  // Build approved list\\n  contentNos.forEach(n => {\\n    const k = kws[n - 1];\\n    if (k) {\\n      approved.push({\\n        keyword: k.kw,\\n        seed_keyword: seed,\\n        search_volume: k.vol,\\n        cpc: k.cpc,\\n        status: 'approved',\\n        priority: k.vol >= 5000 ? 'high' : k.vol >= 1000 ? 'medium' : 'low'\\n      });\\n    }\\n  });\\n  \\n  // Build rejected list\\n  othersNos.forEach(n => {\\n    const k = kws[n - 1];\\n    if (k) {\\n      rejected.push({\\n        keyword: k.kw,\\n        seed_keyword: seed,\\n        search_volume: k.vol,\\n        cpc: k.cpc,\\n        status: 'rejected'\\n      });\\n    }\\n  });\\n  \\n} catch(e) {\\n  // Fallback: top 35 by volume\\n  const sorted = [...kws].sort((a, b) => b.vol - a.vol);\\n  sorted.slice(0, 35).forEach(k => {\\n    approved.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'approved',\\n      priority: k.vol >= 5000 ? 'high' : k.vol >= 1000 ? 'medium' : 'low'\\n    });\\n  });\\n  sorted.slice(35).forEach(k => {\\n    rejected.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'rejected'\\n    });\\n  });\\n}\\n\\n// If no approved from Gemini, fallback\\nif (approved.length === 0 && kws.length > 0) {\\n  const sorted = [...kws].sort((a, b) => b.vol - a.vol);\\n  sorted.slice(0, 35).forEach(k => {\\n    approved.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'approved',\\n      priority: 'medium'\\n    });\\n  });\\n  sorted.slice(35).forEach(k => {\\n    rejected.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'rejected'\\n    });\\n  });\\n}\\n\\nreturn [{json: {\\n  seed,\\n  approved,\\n  rejected,\\n  stats: {\\n    approved: approved.length,\\n    rejected: rejected.length\\n  }\\n}}];"},"id":"79a4aa5b-7757-4fde-a3ce-3a00c05f9451","name":"Parse Gemini","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,0]}]	{"Execute Workflow Trigger":{"main":[[{"node":"DataForSEO","type":"main","index":0}]]},"DataForSEO":{"main":[[{"node":"Parse DFS","type":"main","index":0}]]},"Parse DFS":{"main":[[{"node":"Gemini","type":"main","index":0}]]},"Gemini":{"main":[[{"node":"Parse Gemini","type":"main","index":0}]]}}	2025-12-23 19:36:44.405+00	2025-12-23 19:54:55.208+00	{"executionOrder":"v1"}	\N	{}	2c3f8f8d-f586-4262-ae2d-e85f3ccbd935	0	MhHeIUZBSMtqRRrR	\N	\N	t	5	\N	\N
WF-007 Sheets Get Row	t	[{"parameters":{"httpMethod":"POST","path":"sheets-get-row","responseMode":"responseNode","options":{}},"id":"e84e60ab-f502-4820-8fea-54b17b77a730","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"sheets-get-row"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const body = $json.body || {};\\nconst spreadsheetId = body.spreadsheet_id;\\nconst sheetName = body.sheet_name;\\nconst row = body.row || 1;\\nconst columnMappings = body.column_mappings || {};\\n\\nif (!spreadsheetId || !sheetName) {\\n  return { json: { success: false, error: 'spreadsheet_id ve sheet_name gerekli' } };\\n}\\n\\n// Get column letters sorted\\nconst columns = Object.entries(columnMappings).sort((a, b) => a[1].localeCompare(b[1]));\\nconst firstCol = columns[0]?.[1] || 'A';\\nconst lastCol = columns[columns.length - 1]?.[1] || 'A';\\nconst rowRange = `${sheetName}!${firstCol}${row}:${lastCol}${row}`;\\n\\nreturn { json: {\\n  spreadsheet_id: spreadsheetId,\\n  sheet_name: sheetName,\\n  row,\\n  row_range: rowRange,\\n  column_mappings: columnMappings,\\n  columns: columns\\n}};"},"id":"1fd0fb98-8345-475b-a9cb-3ef5cb2f91b2","name":"Prepare","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.row_range) }}","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","options":{}},"id":"30c75a67-250a-40ea-8a1a-d6285eaa3ef6","name":"Get Row","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[448,0],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const prepData = $('Prepare').item.json;\\nconst response = $json;\\nconst rowValues = response.values?.[0] || [];\\nconst columns = prepData.columns || [];\\n\\n// Map values back to field names\\nconst values = {};\\ncolumns.forEach(([field, col], index) => {\\n  values[field] = rowValues[index] || '';\\n});\\n\\nreturn { json: {\\n  success: true,\\n  row: prepData.row,\\n  values: values\\n}};"},"id":"07badae0-2b73-47b1-b6fe-5c05c24d0a63","name":"Format","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"868a70c3-57cc-4bfd-8fc3-81ca3a1481bc","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[880,0]}]	{"Webhook":{"main":[[{"node":"Prepare","type":"main","index":0}]]},"Prepare":{"main":[[{"node":"Get Row","type":"main","index":0}]]},"Get Row":{"main":[[{"node":"Format","type":"main","index":0}]]},"Format":{"main":[[{"node":"Respond","type":"main","index":0}]]}}	2025-12-19 11:59:40.715+00	2025-12-19 11:59:40.811+00	{"executionOrder":"v1"}	\N	{}	4a8dff3c-c281-46eb-8742-cd5ec6256b2b	1	O9VRT7UV70STh36c	\N	\N	f	9	\N	4a8dff3c-c281-46eb-8742-cd5ec6256b2b
WF-000: Token Logger	t	[{"parameters":{"httpMethod":"POST","path":"log-tokens","responseMode":"lastNode","options":{}},"id":"a8967647-5034-423d-a4b1-98478e2ebaa4","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"token-logger"},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO api_usage_tracking (client_id, tool_name, project_id, workflow_name, api_provider, model_name, tokens_input, tokens_output, api_calls, cost_usd, response_time_ms, was_successful, error_message) VALUES ({{ $json.client_id || 0 }}, '{{ $json.tool_name || 'other' }}', {{ $json.project_id || 'NULL' }}, '{{ $json.workflow_name || '' }}', '{{ $json.api_provider || 'google' }}', '{{ $json.model_name || '' }}', {{ $json.tokens_input || 0 }}, {{ $json.tokens_output || 0 }}, 1, {{ $json.cost_usd || 0 }}, {{ $json.response_time_ms || 0 }}, {{ $json.was_successful ? 1 : 0 }}, {{ $json.error_message ? \\"'\\" + $json.error_message.replace(/'/g, \\"''\\") + \\"'\\" : 'NULL' }})","options":{}},"id":"26978034-79e9-418a-8b3d-fc07269f2a39","name":"MySQL - Log Token Usage","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"return { success: true, logged: true };"},"id":"05c686b6-fd0d-46f8-a79f-92155b35ee3f","name":"Code - Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]}]	{"Webhook":{"main":[[{"node":"MySQL - Log Token Usage","type":"main","index":0}]]},"MySQL - Log Token Usage":{"main":[[{"node":"Code - Response","type":"main","index":0}]]}}	2025-12-17 10:32:00.99+00	2025-12-17 10:32:00.99+00	{"executionOrder":"v1"}	\N	{}	73230155-b208-43c1-9cee-280a6e4ebac1	1	s7JHrKu0WDrkbkzw	{"templateCredsSetupCompleted":true}	\N	f	18	\N	73230155-b208-43c1-9cee-280a6e4ebac1
\.


--
-- Data for Name: workflow_history; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.workflow_history ("versionId", "workflowId", authors, "createdAt", "updatedAt", nodes, connections, name, autosaved, description) FROM stdin;
057c1d4a-90b8-4bc9-add8-c93e1acd2aa6	nuQVa3YLSJFRC4Ny	Fatih Berkay Baheci	2025-12-17 10:25:58.854+00	2025-12-17 10:26:00.905+00	[{"parameters":{"path":"clients/list","responseMode":"responseNode","options":{}},"id":"bdad1ffa-c3b0-4036-bea7-fdd012a425e9","name":"Webhook - List Clients","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"clients-list"},{"parameters":{"operation":"executeQuery","query":"SELECT id, uuid, name, slug, domain, industry, default_language, default_country, is_active, created_at FROM clients WHERE deleted_at IS NULL ORDER BY name ASC","options":{}},"id":"ac2e981a-948e-453c-9ed9-a83706ad2aca","name":"MySQL - List Clients","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"data\\": {{ JSON.stringify($input.all().map(i => i.json)) }}\\n}","options":{}},"id":"a5c5bfd3-c198-4032-b68a-1f72e093eb21","name":"Respond - List","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[448,0]},{"parameters":{"httpMethod":"POST","path":"clients/create","responseMode":"responseNode","options":{}},"id":"b4c12f3a-be37-4f9d-82cf-469b50012152","name":"Webhook - Create Client","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,208],"webhookId":"clients-create"},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO clients (uuid, name, slug, domain, industry, default_language, default_country) VALUES (UUID(), {{ JSON.stringify($json.body.name || '') }}, {{ JSON.stringify($json.body.slug || '') }}, {{ JSON.stringify($json.body.domain || '') }}, {{ JSON.stringify($json.body.industry || '') }}, {{ JSON.stringify($json.body.default_language || 'tr') }}, {{ JSON.stringify($json.body.default_country || 'TR') }})","options":{}},"id":"0f889398-f2ab-484b-bc03-becca8be9944","name":"MySQL - Create Client","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueErrorOutput"},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM clients WHERE id = LAST_INSERT_ID()","options":{}},"id":"ee657cb9-0102-43fa-9a22-ef0d319de882","name":"MySQL - Get Created","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[448,144],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO client_configurations (client_id) VALUES ({{ $json.id }})","options":{}},"id":"d07f60ae-2c3c-490c-8a8c-91e8b6d197cf","name":"MySQL - Create Config","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,144],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"data\\": {{ JSON.stringify($json) }},\\n  \\"message\\": \\"Mteri baaryla oluturuldu\\"\\n}","options":{}},"id":"e73e043e-df38-4e26-be0c-74994b5be605","name":"Respond - Create Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[880,144]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": {{ $json.message && $json.message.includes('Duplicate') ? '\\"Bu slug zaten kullanmda\\"' : JSON.stringify($json.message || 'Mteri oluturulamad') }}\\n}","options":{"responseCode":400}},"id":"f7afb8f3-1981-4707-bb90-637201314ef1","name":"Respond - Create Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[448,288]},{"parameters":{"path":"clients-get/clients/:id","responseMode":"responseNode","options":{}},"id":"c90f9bd0-12e6-4032-a1d5-12e30bbeb72c","name":"Webhook - Get Client","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,400],"webhookId":"clients-get"},{"parameters":{"operation":"executeQuery","query":"=SELECT c.id, c.uuid, c.name, c.slug, c.domain, c.industry, c.default_language, c.default_country, c.is_active, c.created_at, c.updated_at, cc.system_prompt_id, cc.tone_of_voice, cc.writing_style, cc.target_audience, cc.brand_keywords, cc.forbidden_words, cc.competitor_domains, cc.keyword_density_min, cc.keyword_density_max, cc.internal_links_per_1000_words, cc.ai_model_preference, cc.ai_temperature, cc.enable_ai_analysis, cc.competitor_count, cc.cache_duration_days, cc.enable_ahrefs_api FROM clients c LEFT JOIN client_configurations cc ON c.id = cc.client_id WHERE (c.id = {{ parseInt($json.params.id) || 0 }} OR c.uuid = '{{ $json.params.id }}') AND c.deleted_at IS NULL LIMIT 1","options":{}},"id":"8a8f46b3-7975-408d-852b-7eacbde0965a","name":"MySQL - Get Client","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,400],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const item = $json;\\nif (item.id) {\\n  try { item.brand_keywords = item.brand_keywords ? JSON.parse(item.brand_keywords) : []; } catch { item.brand_keywords = []; }\\n  try { item.forbidden_words = item.forbidden_words ? JSON.parse(item.forbidden_words) : []; } catch { item.forbidden_words = []; }\\n  try { item.competitor_domains = item.competitor_domains ? JSON.parse(item.competitor_domains) : []; } catch { item.competitor_domains = []; }\\n}\\nreturn { json: item };"},"id":"ae170dd9-ca8d-4ea6-830d-cf3fd0652a37","name":"Code - Parse JSON","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,400]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": {{ $json.id ? true : false }},\\n  \\"data\\": {{ $json.id ? JSON.stringify($json) : 'null' }},\\n  \\"error\\": {{ $json.id ? 'null' : '\\"Mteri bulunamad\\"' }}\\n}","options":{}},"id":"2a089b97-fdc9-455a-87d1-12035ee48bcd","name":"Respond - Get","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,400]},{"parameters":{"httpMethod":"PUT","path":"clients-update/clients/:id/update","responseMode":"responseNode","options":{}},"id":"22d9adb5-e85a-4316-9ce3-bd3683647815","name":"Webhook - Update Client","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,608],"webhookId":"clients-update"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const body = $json.body || {};\\nconst clientId = parseInt($json.params.id);\\nif (!clientId) return { json: { error: 'Invalid client ID', clientId: 0 } };\\n\\nconst clientFields = ['name', 'slug', 'domain', 'industry', 'default_language', 'default_country', 'is_active'];\\nconst clientUpdates = [];\\nfor (const field of clientFields) {\\n  if (body[field] !== undefined) {\\n    const value = body[field];\\n    if (typeof value === 'boolean') clientUpdates.push(`${field} = ${value ? 1 : 0}`);\\n    else if (typeof value === 'number') clientUpdates.push(`${field} = ${value}`);\\n    else clientUpdates.push(`${field} = ${JSON.stringify(value)}`);\\n  }\\n}\\n\\nconst configFields = ['system_prompt_id', 'tone_of_voice', 'writing_style', 'target_audience', 'brand_keywords', 'forbidden_words', 'competitor_domains', 'keyword_density_min', 'keyword_density_max', 'internal_links_per_1000_words', 'ai_model_preference', 'ai_temperature', 'enable_ai_analysis', 'competitor_count', 'cache_duration_days', 'enable_ahrefs_api'];\\nconst configUpdates = [];\\nfor (const field of configFields) {\\n  if (body[field] !== undefined) {\\n    const value = body[field];\\n    if (value === null) configUpdates.push(`${field} = NULL`);\\n    else if (Array.isArray(value)) configUpdates.push(`${field} = ${JSON.stringify(JSON.stringify(value))}`);\\n    else if (typeof value === 'boolean') configUpdates.push(`${field} = ${value ? 1 : 0}`);\\n    else if (typeof value === 'number') configUpdates.push(`${field} = ${value}`);\\n    else configUpdates.push(`${field} = ${JSON.stringify(value)}`);\\n  }\\n}\\n\\nlet clientQuery = '';\\nif (clientUpdates.length > 0) {\\n  clientUpdates.push('updated_at = NOW()');\\n  clientQuery = `UPDATE clients SET ${clientUpdates.join(', ')} WHERE id = ${clientId} AND deleted_at IS NULL`;\\n}\\n\\nlet configQuery = '';\\nif (configUpdates.length > 0) {\\n  configUpdates.push('updated_at = NOW()');\\n  configQuery = `UPDATE client_configurations SET ${configUpdates.join(', ')} WHERE client_id = ${clientId}`;\\n}\\n\\nreturn { json: { clientId, clientQuery, configQuery, hasClientUpdates: clientUpdates.length > 0, hasConfigUpdates: configUpdates.length > 0 } };"},"id":"4d83b2cd-fdec-4263-8ee3-c15379bf7bf4","name":"Code - Build Update","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,608]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"c1","leftValue":"={{ $json.hasClientUpdates }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"9b67eb25-4b7a-45a8-bb5d-db42a451a65b","name":"IF - Has Client Updates","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,608]},{"parameters":{"operation":"executeQuery","query":"={{ $json.clientQuery }}","options":{}},"id":"13195b60-4fc3-46c5-b2e4-5bd79301a90b","name":"MySQL - Update Client","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,544],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"return { json: $('Code - Build Update').item.json };"},"id":"2aef954a-50e1-4681-9f9c-b0719f749568","name":"Code - Merge Client","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,544]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"return { json: $('Code - Build Update').item.json };"},"id":"1c65a609-3a83-43b0-a0f3-5a1670ec20d5","name":"Code - Skip Client","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,672]},{"parameters":{"mode":"passThrough"},"id":"6867bdd8-84c6-4c0f-981d-69248c79fce7","name":"Merge After Client","type":"n8n-nodes-base.merge","typeVersion":3,"position":[1104,608]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"c2","leftValue":"={{ $json.hasConfigUpdates }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"aa29e8f0-29ef-4902-923c-a9ba7c7c310d","name":"IF - Has Config Updates","type":"n8n-nodes-base.if","typeVersion":2,"position":[1328,608]},{"parameters":{"operation":"executeQuery","query":"={{ $json.configQuery }}","options":{}},"id":"989584df-5171-467f-bdba-a1b0f38c159d","name":"MySQL - Update Config","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1552,544],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"return { json: { clientId: $('Code - Build Update').item.json.clientId } };"},"id":"ccee490a-4be8-4e6d-8b52-9b41becf2322","name":"Code - Merge Config","type":"n8n-nodes-base.code","typeVersion":2,"position":[1760,544]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"return { json: { clientId: $('Code - Build Update').item.json.clientId } };"},"id":"115044c0-e1b5-4b7e-b34f-26e55145af79","name":"Code - Skip Config","type":"n8n-nodes-base.code","typeVersion":2,"position":[1552,672]},{"parameters":{"mode":"passThrough"},"id":"c8de9758-83fd-46e3-8438-45b103273a5b","name":"Merge After Config","type":"n8n-nodes-base.merge","typeVersion":3,"position":[1984,608]},{"parameters":{"operation":"executeQuery","query":"=SELECT c.id, c.uuid, c.name, c.slug, c.domain, c.industry, c.default_language, c.default_country, c.is_active, c.created_at, c.updated_at, cc.system_prompt_id, cc.tone_of_voice, cc.writing_style, cc.target_audience, cc.brand_keywords, cc.forbidden_words, cc.competitor_domains, cc.keyword_density_min, cc.keyword_density_max, cc.internal_links_per_1000_words, cc.ai_model_preference, cc.ai_temperature, cc.enable_ai_analysis, cc.competitor_count, cc.cache_duration_days, cc.enable_ahrefs_api FROM clients c LEFT JOIN client_configurations cc ON c.id = cc.client_id WHERE c.id = {{ $json.clientId }} AND c.deleted_at IS NULL LIMIT 1","options":{}},"id":"e3ac250c-0ce7-439e-b226-8604dccabc11","name":"MySQL - Get Updated","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[2208,608],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const item = $json;\\nif (item.id) {\\n  try { item.brand_keywords = item.brand_keywords ? JSON.parse(item.brand_keywords) : []; } catch { item.brand_keywords = []; }\\n  try { item.forbidden_words = item.forbidden_words ? JSON.parse(item.forbidden_words) : []; } catch { item.forbidden_words = []; }\\n  try { item.competitor_domains = item.competitor_domains ? JSON.parse(item.competitor_domains) : []; } catch { item.competitor_domains = []; }\\n}\\nreturn { json: item };"},"id":"a58e911e-a230-4b0a-93ee-79058cb4f1ec","name":"Code - Parse Updated","type":"n8n-nodes-base.code","typeVersion":2,"position":[2432,608]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": {{ $json.id ? true : false }},\\n  \\"data\\": {{ $json.id ? JSON.stringify($json) : 'null' }},\\n  \\"message\\": {{ $json.id ? '\\"Mteri baaryla gncellendi\\"' : '\\"Mteri bulunamad\\"' }}\\n}","options":{}},"id":"222a39bb-7af5-4708-af56-c872903a3c06","name":"Respond - Update","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[2640,608]},{"parameters":{"httpMethod":"DELETE","path":"clients-delete/clients/:id","responseMode":"responseNode","options":{}},"id":"c096fdca-4fda-4afe-b277-171b18542f41","name":"Webhook - Delete Client","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,800],"webhookId":"clients-delete"},{"parameters":{"operation":"executeQuery","query":"=UPDATE clients SET deleted_at = NOW(), is_active = 0 WHERE id = {{ parseInt($json.params.id) || 0 }} AND deleted_at IS NULL","options":{}},"id":"86766418-cb19-4e1a-a8b9-513b01575e1e","name":"MySQL - Delete Client","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,800],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"message\\": \\"Mteri baaryla silindi\\"\\n}","options":{}},"id":"ace5b004-6617-40b4-9dd4-2566bbf0bb50","name":"Respond - Delete","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[448,800]}]	{"Webhook - List Clients":{"main":[[{"node":"MySQL - List Clients","type":"main","index":0}]]},"MySQL - List Clients":{"main":[[{"node":"Respond - List","type":"main","index":0}]]},"Webhook - Create Client":{"main":[[{"node":"MySQL - Create Client","type":"main","index":0}]]},"MySQL - Create Client":{"main":[[{"node":"MySQL - Get Created","type":"main","index":0}],[{"node":"Respond - Create Error","type":"main","index":0}]]},"MySQL - Get Created":{"main":[[{"node":"MySQL - Create Config","type":"main","index":0}]]},"MySQL - Create Config":{"main":[[{"node":"Respond - Create Success","type":"main","index":0}]]},"Webhook - Get Client":{"main":[[{"node":"MySQL - Get Client","type":"main","index":0}]]},"MySQL - Get Client":{"main":[[{"node":"Code - Parse JSON","type":"main","index":0}]]},"Code - Parse JSON":{"main":[[{"node":"Respond - Get","type":"main","index":0}]]},"Webhook - Update Client":{"main":[[{"node":"Code - Build Update","type":"main","index":0}]]},"Code - Build Update":{"main":[[{"node":"IF - Has Client Updates","type":"main","index":0}]]},"IF - Has Client Updates":{"main":[[{"node":"MySQL - Update Client","type":"main","index":0}],[{"node":"Code - Skip Client","type":"main","index":0}]]},"MySQL - Update Client":{"main":[[{"node":"Code - Merge Client","type":"main","index":0}]]},"Code - Merge Client":{"main":[[{"node":"Merge After Client","type":"main","index":0}]]},"Code - Skip Client":{"main":[[{"node":"Merge After Client","type":"main","index":1}]]},"Merge After Client":{"main":[[{"node":"IF - Has Config Updates","type":"main","index":0}]]},"IF - Has Config Updates":{"main":[[{"node":"MySQL - Update Config","type":"main","index":0}],[{"node":"Code - Skip Config","type":"main","index":0}]]},"MySQL - Update Config":{"main":[[{"node":"Code - Merge Config","type":"main","index":0}]]},"Code - Merge Config":{"main":[[{"node":"Merge After Config","type":"main","index":0}]]},"Code - Skip Config":{"main":[[{"node":"Merge After Config","type":"main","index":1}]]},"Merge After Config":{"main":[[{"node":"MySQL - Get Updated","type":"main","index":0}]]},"MySQL - Get Updated":{"main":[[{"node":"Code - Parse Updated","type":"main","index":0}]]},"Code - Parse Updated":{"main":[[{"node":"Respond - Update","type":"main","index":0}]]},"Webhook - Delete Client":{"main":[[{"node":"MySQL - Delete Client","type":"main","index":0}]]},"MySQL - Delete Client":{"main":[[{"node":"Respond - Delete","type":"main","index":0}]]}}	Version 057c1d4a	f	
b9b1ad43-9b8a-43d5-8c9f-05adc54db544	WpQy66Cn5XTG9pFD	Fatih Berkay Baheci	2025-12-17 10:26:21.495+00	2025-12-17 10:26:23.604+00	[{"parameters":{"path":"client-prompts/list/:clientId","responseMode":"responseNode","options":{}},"id":"88c0d94b-04a5-414c-98d0-294af8a21f87","name":"Webhook - List Prompts","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"client-prompts-list"},{"parameters":{"operation":"executeQuery","query":"=SELECT id, client_id, prompt_name, prompt_text, is_active, sort_order, created_at, updated_at FROM client_prompts WHERE client_id = {{ parseInt($json.params.clientId) || 0 }} ORDER BY sort_order ASC, created_at DESC","options":{}},"id":"2ce0a6e7-750f-4eee-b60a-9ccd8002d58e","name":"MySQL - List Prompts","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"data\\": {{ JSON.stringify($input.all().map(i => ({ ...i.json, is_active: i.json.is_active === 1 || i.json.is_active === true }))) }}\\n}","options":{}},"id":"fda9a8b6-ed13-4d40-a1e2-61a2b168c3f1","name":"Respond - List Prompts","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[448,0]},{"parameters":{"httpMethod":"POST","path":"client-prompts/create","responseMode":"responseNode","options":{}},"id":"0b14971a-9ab5-4dee-a35e-223eb2ac9b7a","name":"Webhook - Create Prompt","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,208],"webhookId":"client-prompts-create"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Check max prompts and prepare insert\\nconst body = $json.body || {};\\nconst clientId = parseInt(body.client_id);\\nconst promptName = body.prompt_name || '';\\nconst promptText = body.prompt_text || '';\\nconst isActive = body.is_active ? 1 : 0;\\n\\nif (!clientId || !promptName || !promptText) {\\n  return { json: { error: 'Missing required fields', valid: false } };\\n}\\n\\nreturn {\\n  json: {\\n    clientId,\\n    promptName,\\n    promptText,\\n    isActive,\\n    valid: true\\n  }\\n};"},"id":"c82122b4-97ec-4434-b296-8065c519b0ce","name":"Code - Validate Create","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"condition-valid","leftValue":"={{ $json.valid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"bfaacead-365d-4269-93f3-dfeb3fc968b4","name":"IF - Valid Create","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,208]},{"parameters":{"operation":"executeQuery","query":"=SELECT COUNT(*) as count FROM client_prompts WHERE client_id = {{ $json.clientId }}","options":{}},"id":"f944a9f0-1395-4228-9179-a7beb1e11404","name":"MySQL - Check Count","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,144],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Check if under limit and pass data\\nconst count = $json.count || 0;\\nconst MAX_PROMPTS = 10;\\nconst prevData = $('Code - Validate Create').item.json;\\n\\nif (count >= MAX_PROMPTS) {\\n  return { json: { error: `Maximum ${MAX_PROMPTS} prompts allowed`, canCreate: false } };\\n}\\n\\nreturn {\\n  json: {\\n    ...prevData,\\n    canCreate: true\\n  }\\n};"},"id":"b506fead-a686-43e0-81c5-f61c23e21584","name":"Code - Check Limit","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,144]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"condition-can-create","leftValue":"={{ $json.canCreate }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"c8f06eeb-4d30-4974-be4a-76132cf6fcd9","name":"IF - Can Create","type":"n8n-nodes-base.if","typeVersion":2,"position":[1104,144]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO client_prompts (client_id, prompt_name, prompt_text, is_active, sort_order) VALUES ({{ $json.clientId }}, {{ JSON.stringify($json.promptName) }}, {{ JSON.stringify($json.promptText) }}, {{ $json.isActive }}, (SELECT COALESCE(MAX(sort_order), 0) + 1 FROM client_prompts cp WHERE cp.client_id = {{ $json.clientId }}))","options":{}},"id":"5640a01f-aeea-43a4-adc8-aecc113491af","name":"MySQL - Create Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1328,80],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM client_prompts WHERE id = LAST_INSERT_ID()","options":{}},"id":"02c4798e-b277-4476-918d-eb8e0642d721","name":"MySQL - Get Created Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1552,80],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"data\\": {{ JSON.stringify({ ...$json, is_active: $json.is_active === 1 }) }},\\n  \\"message\\": \\"Prompt created successfully\\"\\n}","options":{}},"id":"e503506a-4ea6-418b-9b5c-d17a04da65da","name":"Respond - Create Prompt","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1760,80]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": {{ JSON.stringify($json.error || 'Cannot create prompt') }}\\n}","options":{"responseCode":400}},"id":"eeaf34f0-1971-4e06-9a5c-76278db11fe7","name":"Respond - Create Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1328,224]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": {{ JSON.stringify($json.error || 'Invalid request') }}\\n}","options":{"responseCode":400}},"id":"944b597c-5609-468a-9b15-232c4ec9817e","name":"Respond - Invalid Create","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,272]},{"parameters":{"httpMethod":"PUT","path":"client-prompts/update/:id","responseMode":"responseNode","options":{}},"id":"20a90231-ec57-424a-8517-9ee64c83625f","name":"Webhook - Update Prompt","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,400],"webhookId":"client-prompts-update"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Build update query\\nconst body = $json.body || {};\\nconst promptId = parseInt($json.params.id);\\n\\nif (!promptId) {\\n  return { json: { error: 'Invalid prompt ID', valid: false } };\\n}\\n\\nconst updates = [];\\nif (body.prompt_name !== undefined) {\\n  updates.push(`prompt_name = ${JSON.stringify(body.prompt_name)}`);\\n}\\nif (body.prompt_text !== undefined) {\\n  updates.push(`prompt_text = ${JSON.stringify(body.prompt_text)}`);\\n}\\nif (body.sort_order !== undefined) {\\n  updates.push(`sort_order = ${parseInt(body.sort_order)}`);\\n}\\n\\nif (updates.length === 0) {\\n  return { json: { error: 'No fields to update', valid: false } };\\n}\\n\\nupdates.push('updated_at = NOW()');\\n\\nreturn {\\n  json: {\\n    promptId,\\n    query: `UPDATE client_prompts SET ${updates.join(', ')} WHERE id = ${promptId}`,\\n    valid: true\\n  }\\n};"},"id":"7df229a9-c7ad-4322-a6f3-5855d71f57d1","name":"Code - Build Update Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,400]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"condition-valid-update","leftValue":"={{ $json.valid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"e572515f-4654-40dc-ab59-71b75a9c6fb5","name":"IF - Valid Update","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,400]},{"parameters":{"operation":"executeQuery","query":"={{ $json.query }}","options":{}},"id":"47c53399-6153-478a-99dd-bbaceb117975","name":"MySQL - Update Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,352],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT * FROM client_prompts WHERE id = {{ $('Code - Build Update Prompt').item.json.promptId }}","options":{}},"id":"92c92f4f-b0e5-4507-aa86-cef292dfb87e","name":"MySQL - Get Updated Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[880,352],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": {{ $json.id ? true : false }},\\n  \\"data\\": {{ $json.id ? JSON.stringify({ ...$json, is_active: $json.is_active === 1 }) : 'null' }},\\n  \\"message\\": {{ $json.id ? '\\"Prompt updated successfully\\"' : '\\"Prompt not found\\"' }}\\n}","options":{}},"id":"0acaa8d6-6c16-4c87-a899-5889288cf9b5","name":"Respond - Update Prompt","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1104,352]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": {{ JSON.stringify($json.error || 'Invalid request') }}\\n}","options":{"responseCode":400}},"id":"874f2b7a-3622-4303-9814-f712818aa7c9","name":"Respond - Invalid Update","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,464]},{"parameters":{"httpMethod":"DELETE","path":"client-prompts/delete/:id","responseMode":"responseNode","options":{}},"id":"8ca18cdf-114c-4762-8aec-0f83bbfb28a7","name":"Webhook - Delete Prompt","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,608],"webhookId":"client-prompts-delete"},{"parameters":{"operation":"executeQuery","query":"=DELETE FROM client_prompts WHERE id = {{ parseInt($json.params.id) || 0 }}","options":{}},"id":"635f4a47-4df0-4f1c-a440-33c750fc3bc9","name":"MySQL - Delete Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,608],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"message\\": \\"Prompt deleted successfully\\"\\n}","options":{}},"id":"83f9accc-cc32-4623-92fd-2ada0ea91ee4","name":"Respond - Delete Prompt","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[448,608]},{"parameters":{"httpMethod":"PUT","path":"client-prompts/set-active/:id","responseMode":"responseNode","options":{}},"id":"a3dfcd2d-b913-45ae-88a5-b469e646633b","name":"Webhook - Set Active","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,800],"webhookId":"client-prompts-set-active"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Get prompt ID and client ID\\nconst promptId = parseInt($json.params.id);\\nconst clientId = parseInt($json.body?.client_id);\\n\\nif (!promptId || !clientId) {\\n  return { json: { error: 'Invalid prompt or client ID', valid: false } };\\n}\\n\\nreturn {\\n  json: {\\n    promptId,\\n    clientId,\\n    valid: true\\n  }\\n};"},"id":"60935498-8613-47af-af01-9ee30c608556","name":"Code - Validate Set Active","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,800]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"condition-valid-set-active","leftValue":"={{ $json.valid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"0321e8ba-dc05-47ac-a757-ad25b9610d27","name":"IF - Valid Set Active","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,800]},{"parameters":{"operation":"executeQuery","query":"=UPDATE client_prompts SET is_active = 0 WHERE client_id = {{ $json.clientId }}","options":{}},"id":"59e27938-d4c9-4edd-9b4c-181196cbea7d","name":"MySQL - Deactivate All","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,752],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=UPDATE client_prompts SET is_active = 1, updated_at = NOW() WHERE id = {{ $('Code - Validate Set Active').item.json.promptId }}","options":{}},"id":"0be9af16-4fcd-48a5-9d9d-6c4e5ce806c7","name":"MySQL - Activate One","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[880,752],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"message\\": \\"Active prompt updated successfully\\"\\n}","options":{}},"id":"f2566456-fd37-43bb-a49d-f75149d01078","name":"Respond - Set Active","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1104,752]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": {{ JSON.stringify($json.error || 'Invalid request') }}\\n}","options":{"responseCode":400}},"id":"123f1d45-e804-4c94-9500-034dadd696dc","name":"Respond - Invalid Set Active","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,864]},{"parameters":{"path":"client-prompts/active/:clientId","responseMode":"responseNode","options":{}},"id":"d6db08a9-9256-43a1-8314-b23de054f5f6","name":"Webhook - Get Active Prompt","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,1008],"webhookId":"client-prompts-get-active"},{"parameters":{"operation":"executeQuery","query":"=SELECT id, client_id, prompt_name, prompt_text, is_active, sort_order, created_at, updated_at FROM client_prompts WHERE client_id = {{ parseInt($json.params.clientId) || 0 }} AND is_active = 1 LIMIT 1","options":{}},"id":"51e3a91f-a417-4562-94af-093973cd2679","name":"MySQL - Get Active Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,1008],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": {{ $json.id ? true : false }},\\n  \\"data\\": {{ $json.id ? JSON.stringify({ ...$json, is_active: true }) : 'null' }},\\n  \\"message\\": {{ $json.id ? '\\"Active prompt found\\"' : '\\"No active prompt found\\"' }}\\n}","options":{}},"id":"25a79964-905b-4a22-83a5-fdb3b5f5ea8f","name":"Respond - Get Active","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[448,1008]}]	{"Webhook - List Prompts":{"main":[[{"node":"MySQL - List Prompts","type":"main","index":0}]]},"MySQL - List Prompts":{"main":[[{"node":"Respond - List Prompts","type":"main","index":0}]]},"Webhook - Create Prompt":{"main":[[{"node":"Code - Validate Create","type":"main","index":0}]]},"Code - Validate Create":{"main":[[{"node":"IF - Valid Create","type":"main","index":0}]]},"IF - Valid Create":{"main":[[{"node":"MySQL - Check Count","type":"main","index":0}],[{"node":"Respond - Invalid Create","type":"main","index":0}]]},"MySQL - Check Count":{"main":[[{"node":"Code - Check Limit","type":"main","index":0}]]},"Code - Check Limit":{"main":[[{"node":"IF - Can Create","type":"main","index":0}]]},"IF - Can Create":{"main":[[{"node":"MySQL - Create Prompt","type":"main","index":0}],[{"node":"Respond - Create Error","type":"main","index":0}]]},"MySQL - Create Prompt":{"main":[[{"node":"MySQL - Get Created Prompt","type":"main","index":0}]]},"MySQL - Get Created Prompt":{"main":[[{"node":"Respond - Create Prompt","type":"main","index":0}]]},"Webhook - Update Prompt":{"main":[[{"node":"Code - Build Update Prompt","type":"main","index":0}]]},"Code - Build Update Prompt":{"main":[[{"node":"IF - Valid Update","type":"main","index":0}]]},"IF - Valid Update":{"main":[[{"node":"MySQL - Update Prompt","type":"main","index":0}],[{"node":"Respond - Invalid Update","type":"main","index":0}]]},"MySQL - Update Prompt":{"main":[[{"node":"MySQL - Get Updated Prompt","type":"main","index":0}]]},"MySQL - Get Updated Prompt":{"main":[[{"node":"Respond - Update Prompt","type":"main","index":0}]]},"Webhook - Delete Prompt":{"main":[[{"node":"MySQL - Delete Prompt","type":"main","index":0}]]},"MySQL - Delete Prompt":{"main":[[{"node":"Respond - Delete Prompt","type":"main","index":0}]]},"Webhook - Set Active":{"main":[[{"node":"Code - Validate Set Active","type":"main","index":0}]]},"Code - Validate Set Active":{"main":[[{"node":"IF - Valid Set Active","type":"main","index":0}]]},"IF - Valid Set Active":{"main":[[{"node":"MySQL - Deactivate All","type":"main","index":0}],[{"node":"Respond - Invalid Set Active","type":"main","index":0}]]},"MySQL - Deactivate All":{"main":[[{"node":"MySQL - Activate One","type":"main","index":0}]]},"MySQL - Activate One":{"main":[[{"node":"Respond - Set Active","type":"main","index":0}]]},"Webhook - Get Active Prompt":{"main":[[{"node":"MySQL - Get Active Prompt","type":"main","index":0}]]},"MySQL - Get Active Prompt":{"main":[[{"node":"Respond - Get Active","type":"main","index":0}]]}}	Version b9b1ad43	f	
7c994d64-1fad-4c91-8a09-b1a0adb79c50	DyGEyObKWBEHrb0B	Fatih Berkay Baheci	2025-12-17 10:26:38.488+00	2025-12-17 10:26:39.902+00	[{"parameters":{"httpMethod":"POST","path":"tool1/project/create","responseMode":"responseNode","options":{}},"id":"448a287d-0c56-4536-b6eb-c67882e0e5bc","name":"Webhook - Create Project","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1328,288],"webhookId":"tool1-project-create"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// ============================================\\n// WF-101 Input Validation\\n// ============================================\\n\\nconst body = $json.body || {};\\nconst errors = [];\\n\\n// Required fields validation\\nif (!body.client_id || isNaN(parseInt(body.client_id))) {\\n  errors.push('client_id zorunludur ve say olmaldr');\\n}\\n\\nif (!body.project_name || String(body.project_name).trim() === '') {\\n  errors.push('project_name zorunludur');\\n}\\n\\nif (!body.main_keyword || String(body.main_keyword).trim() === '') {\\n  errors.push('main_keyword zorunludur');\\n}\\n\\n// Scenario type validation\\nconst validScenarios = ['seed_keyword', 'topic_based'];\\nconst scenarioType = body.scenario_type || 'seed_keyword';\\nif (!validScenarios.includes(scenarioType)) {\\n  errors.push('scenario_type seed_keyword veya topic_based olmaldr');\\n}\\n\\n// Sanitize inputs to prevent SQL injection\\nconst sanitize = (str) => {\\n  if (str === null || str === undefined) return '';\\n  return String(str).replace(/'/g, \\"''\\").trim();\\n};\\n\\nreturn {\\n  json: {\\n    isValid: errors.length === 0,\\n    errors: errors,\\n    data: {\\n      client_id: parseInt(body.client_id) || 0,\\n      project_name: sanitize(body.project_name),\\n      main_keyword: sanitize(body.main_keyword),\\n      scenario_type: scenarioType,\\n      target_country: sanitize(body.target_country) || 'TR',\\n      target_language: sanitize(body.target_language) || 'tr'\\n    }\\n  }\\n};"},"id":"37675695-4465-4ca5-85da-e04d7f441a31","name":"Code - Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1104,288]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"check-valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"5f12128f-2ecd-40cf-aad9-45348c1724f8","name":"IF - Valid Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[-880,288]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Validation failed\\",\\n  \\"details\\": {{ JSON.stringify($json.errors) }}\\n}","options":{"responseCode":400}},"id":"c6d5fa9a-3895-4b3a-a56d-8f043a3754b7","name":"Respond - Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-656,432]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  (SELECT id FROM clients WHERE id = {{ $('Code - Validate Input').first().json.data.client_id }} AND deleted_at IS NULL LIMIT 1) as id,\\n  (SELECT name FROM clients WHERE id = {{ $('Code - Validate Input').first().json.data.client_id }} AND deleted_at IS NULL LIMIT 1) as name","options":{}},"id":"0933056b-ff80-4912-82a8-01fd58529128","name":"MySQL - Check Client","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-656,144],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Check if client exists and pass validated data forward\\nconst clientResult = $json;\\nconst validatedData = $('Code - Validate Input').first().json.data;\\n\\n// Now clientResult always has a row - check if id is not null\\nconst clientExists = clientResult.id !== null && clientResult.id !== undefined;\\n\\nreturn {\\n  json: {\\n    clientExists: clientExists,\\n    client_id: validatedData.client_id,\\n    client_name: clientResult.name || null,\\n    project_name: validatedData.project_name,\\n    main_keyword: validatedData.main_keyword,\\n    scenario_type: validatedData.scenario_type,\\n    target_country: validatedData.target_country,\\n    target_language: validatedData.target_language\\n  }\\n};"},"id":"7a6bf583-e529-4457-bccf-6df104385c71","name":"Code - Check Client Result","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,144]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"check-client-exists","leftValue":"={{ $json.clientExists }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"4b2bbcea-8c9e-4a4c-99bd-5f9a35dea3d9","name":"IF - Client Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,144]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Client not found\\",\\n  \\"details\\": [\\"Belirtilen client_id ile mteri bulunamad\\"]\\n}","options":{"responseCode":404}},"id":"26849fb3-deef-4682-aed4-791295faa522","name":"Respond - Client Not Found","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[0,288]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO keyword_projects (\\n  client_id, project_name, main_keyword, scenario_type, \\n  target_country, target_language, status\\n) VALUES (\\n  {{ $json.client_id }},\\n  '{{ $json.project_name }}',\\n  '{{ $json.main_keyword }}',\\n  '{{ $json.scenario_type }}',\\n  '{{ $json.target_country }}',\\n  '{{ $json.target_language }}',\\n  'pending'\\n)","options":{}},"id":"46e2ef1b-33cd-48eb-92f1-589483efe03c","name":"MySQL - Create Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[0,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT id, uuid, project_name, main_keyword, scenario_type, status \\nFROM keyword_projects \\nWHERE client_id = {{ $('IF - Client Exists').item.json.client_id }} \\nORDER BY id DESC LIMIT 1","options":{}},"id":"cb8572e4-33d4-475b-a93e-33ed5493c03e","name":"MySQL - Get Created Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=UPDATE keyword_projects \\nSET status = 'processing', started_at = NOW() \\nWHERE id = {{ $json.id }}","options":{}},"id":"f5a3afa3-a01c-419b-a8f6-f8c6c095f02e","name":"MySQL - Set Processing","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[448,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO activity_logs (\\n  client_id, tool_name, project_id, action, log_level, message\\n) VALUES (\\n  {{ $('IF - Client Exists').item.json.client_id }},\\n  'keyword_research',\\n  {{ $('MySQL - Get Created Project').item.json.id }},\\n  'project_created',\\n  'info',\\n  'Keyword research project created: {{ $('MySQL - Get Created Project').item.json.project_name }}'\\n)","options":{}},"id":"e975dc8b-bb2c-410d-9523-e98b439b6ec8","name":"MySQL - Log Activity","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"data\\": {\\n    \\"project_id\\": {{ $('MySQL - Get Created Project').item.json.id }},\\n    \\"uuid\\": \\"{{ $('MySQL - Get Created Project').item.json.uuid }}\\",\\n    \\"project_name\\": \\"{{ $('MySQL - Get Created Project').item.json.project_name }}\\",\\n    \\"main_keyword\\": \\"{{ $('MySQL - Get Created Project').item.json.main_keyword }}\\",\\n    \\"scenario_type\\": \\"{{ $('MySQL - Get Created Project').item.json.scenario_type }}\\",\\n    \\"status\\": \\"processing\\",\\n    \\"message\\": \\"Keyword research project created successfully\\"\\n  }\\n}","options":{}},"id":"9c68d279-b97b-422e-aff2-0fe334d05d09","name":"Respond - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[880,0]}]	{"Webhook - Create Project":{"main":[[{"node":"Code - Validate Input","type":"main","index":0}]]},"Code - Validate Input":{"main":[[{"node":"IF - Valid Input","type":"main","index":0}]]},"IF - Valid Input":{"main":[[{"node":"MySQL - Check Client","type":"main","index":0}],[{"node":"Respond - Validation Error","type":"main","index":0}]]},"MySQL - Check Client":{"main":[[{"node":"Code - Check Client Result","type":"main","index":0}]]},"Code - Check Client Result":{"main":[[{"node":"IF - Client Exists","type":"main","index":0}]]},"IF - Client Exists":{"main":[[{"node":"MySQL - Create Project","type":"main","index":0}],[{"node":"Respond - Client Not Found","type":"main","index":0}]]},"MySQL - Create Project":{"main":[[{"node":"MySQL - Get Created Project","type":"main","index":0}]]},"MySQL - Get Created Project":{"main":[[{"node":"MySQL - Set Processing","type":"main","index":0}]]},"MySQL - Set Processing":{"main":[[{"node":"MySQL - Log Activity","type":"main","index":0}]]},"MySQL - Log Activity":{"main":[[{"node":"Respond - Success","type":"main","index":0}]]}}	Version 7c994d64	f	
90411821-db26-46ed-b5ca-3daf1a5ea8f5	yyD1QW0PcJgp3ik2	Fatih Berkay Baheci	2025-12-17 10:27:00.358+00	2025-12-17 10:27:03.145+00	[{"parameters":{"httpMethod":"POST","path":"keyword-discovery","responseMode":"responseNode","options":{}},"id":"b2b4e892-1ac3-45d3-afcd-bdb1161f2456","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-2864,208],"webhookId":"tool1-keyword-discovery"},{"parameters":{"jsCode":"// Input Validation\\nconst body = $json.body || {};\\nconst projectId = body.project_id;\\n\\nif (!projectId) {\\n  return [{ json: { isValid: false, error: 'project_id is required in request body', errorCode: 400 } }];\\n}\\n\\nconst parsedId = parseInt(projectId);\\nif (isNaN(parsedId) || parsedId <= 0) {\\n  return [{ json: { isValid: false, error: 'project_id must be a positive integer', errorCode: 400 } }];\\n}\\n\\nreturn [{ json: { isValid: true, projectId: parsedId } }];"},"id":"f2737230-d51b-43a2-b0f2-11c6fe10a132","name":"Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2640,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"9da40a40-425b-4612-aa92-78a65c3b6a64","name":"IF Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-2416,208]},{"parameters":{"respondWith":"json","responseBody":"={ \\"success\\": false, \\"error\\": \\"{{ $json.error }}\\" }","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"d82fbb0e-a12e-470b-add8-1576860d8b37","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-2208,352]},{"parameters":{"operation":"executeQuery","query":"SELECT \\n  (SELECT id FROM keyword_projects WHERE id = {{ $json.projectId }}) as project_id,\\n  (SELECT client_id FROM keyword_projects WHERE id = {{ $json.projectId }}) as client_id,\\n  (SELECT main_keyword FROM keyword_projects WHERE id = {{ $json.projectId }}) as main_keyword,\\n  (SELECT scenario_type FROM keyword_projects WHERE id = {{ $json.projectId }}) as scenario_type,\\n  (SELECT target_country FROM keyword_projects WHERE id = {{ $json.projectId }}) as target_country,\\n  (SELECT target_language FROM keyword_projects WHERE id = {{ $json.projectId }}) as target_language,\\n  (SELECT c.name FROM keyword_projects kp JOIN clients c ON c.id = kp.client_id WHERE kp.id = {{ $json.projectId }}) as client_name,\\n  (SELECT c.domain FROM keyword_projects kp JOIN clients c ON c.id = kp.client_id WHERE kp.id = {{ $json.projectId }}) as client_domain,\\n  COALESCE((SELECT cc.enable_google_suggest FROM keyword_projects kp LEFT JOIN client_configurations cc ON cc.client_id = kp.client_id WHERE kp.id = {{ $json.projectId }}), 1) as enable_google_suggest,\\n  COALESCE((SELECT cc.enable_google_trends FROM keyword_projects kp LEFT JOIN client_configurations cc ON cc.client_id = kp.client_id WHERE kp.id = {{ $json.projectId }}), 1) as enable_google_trends,\\n  COALESCE((SELECT cc.enable_ahrefs_api FROM keyword_projects kp LEFT JOIN client_configurations cc ON cc.client_id = kp.client_id WHERE kp.id = {{ $json.projectId }}), 0) as enable_ahrefs_api,\\n  COALESCE((SELECT cc.enable_ai_analysis FROM keyword_projects kp LEFT JOIN client_configurations cc ON cc.client_id = kp.client_id WHERE kp.id = {{ $json.projectId }}), 1) as enable_ai_analysis,\\n  (SELECT cc.ai_model_preference FROM keyword_projects kp LEFT JOIN client_configurations cc ON cc.client_id = kp.client_id WHERE kp.id = {{ $json.projectId }}) as client_ai_model,\\n  (SELECT cc.ai_temperature FROM keyword_projects kp LEFT JOIN client_configurations cc ON cc.client_id = kp.client_id WHERE kp.id = {{ $json.projectId }}) as client_ai_temperature,\\n  (SELECT setting_value FROM system_settings WHERE setting_key = 'default_ai_model') as default_ai_model,\\n  (SELECT setting_value FROM system_settings WHERE setting_key = 'default_ai_temperature') as default_ai_temp,\\n  (SELECT prompt_text FROM system_prompts WHERE slug = 'keyword-discovery' AND is_active = 1 LIMIT 1) as system_prompt","options":{}},"id":"41ad1556-f87b-4e8b-b2a1-32ce02416949","name":"Get Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-2208,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Resolve Config\\nconst items = $input.all();\\nif (items.length === 0 || !items[0].json.project_id) {\\n  return [{ json: { project_exists: false } }];\\n}\\n\\nconst d = items[0].json;\\nconst aiModel = d.client_ai_model || d.default_ai_model || 'gemini-2.0-flash';\\nconst aiTemp = d.client_ai_temperature ?? (d.default_ai_temp ? parseFloat(d.default_ai_temp) : 0.7);\\n\\nlet aiProvider = 'google';\\nif (aiModel.includes('gpt')) aiProvider = 'openai';\\nelse if (aiModel.includes('claude')) aiProvider = 'anthropic';\\n\\n// Build AI prompt from system_prompt template\\nlet aiPrompt = d.system_prompt || 'Ana keyword: {{main_keyword}} iin 15-25 anahtar kelime ner. Sadece virglle ayrarak listele.';\\naiPrompt = aiPrompt\\n  .replace(/\\\\{\\\\{main_keyword\\\\}\\\\}/g, d.main_keyword || '')\\n  .replace(/\\\\{\\\\{target_country\\\\}\\\\}/g, (d.target_country || 'TR').toUpperCase())\\n  .replace(/\\\\{\\\\{target_language\\\\}\\\\}/g, d.target_language || 'Trke');\\n\\nreturn [{\\n  json: {\\n    project_exists: true,\\n    project_id: d.project_id,\\n    client_id: d.client_id,\\n    client_name: d.client_name,\\n    main_keyword: d.main_keyword,\\n    scenario_type: d.scenario_type,\\n    target_country: (d.target_country || 'TR').toLowerCase(),\\n    target_language: d.target_language || 'tr',\\n    // Data source flags\\n    enable_google_suggest: d.enable_google_suggest == 1,\\n    enable_google_trends: d.enable_google_trends == 1,\\n    enable_ahrefs_api: d.enable_ahrefs_api == 1,\\n    enable_ai_analysis: d.enable_ai_analysis == 1,\\n    // AI Config\\n    ai_model: aiModel,\\n    ai_temperature: aiTemp,\\n    ai_provider: aiProvider,\\n    ai_prompt: aiPrompt\\n  }\\n}];"},"id":"5d252d8c-3f11-478a-a8f9-46c48561a455","name":"Resolve Config","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1984,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"exists","leftValue":"={{ $json.project_exists }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"2ba40692-c7f9-44ed-afe8-e564cd43031d","name":"IF Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1760,208]},{"parameters":{"respondWith":"json","responseBody":"{ \\"success\\": false, \\"error\\": \\"Project not found\\" }","options":{"responseCode":404}},"id":"33fbf438-4da1-4caa-88b2-687ecd835134","name":"Respond 404","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-1536,352]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.scenario_type }}","rightValue":"seed_keyword","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"seed_keyword"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.scenario_type }}","rightValue":"topic_based","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"topic_based"}]},"options":{}},"id":"c05afccc-a84a-47db-af88-c34250d3f989","name":"Switch Scenario","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-1536,208]},{"parameters":{"jsCode":"// Seed Keyword: Dorudan ana keyword' kullan\\nconst config = $json;\\nreturn [{\\n  json: {\\n    ...config,\\n    search_keywords: [config.main_keyword],\\n    keyword_source: 'seed_keyword'\\n  }\\n}];"},"id":"320cf454-c667-4166-a391-e117dae15ab1","name":"Prepare Seed","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1328,112]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{\\n    \\"parts\\": [{\\n      \\"text\\": {{ JSON.stringify($json.ai_prompt) }}\\n    }]\\n  }],\\n  \\"generationConfig\\": { \\"temperature\\": {{ $json.ai_temperature }}, \\"maxOutputTokens\\": 500 }\\n}","options":{"timeout":30000}},"id":"93271cad-1353-4a23-8168-455b39957564","name":"AI Extract Keywords","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1328,304],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}}},{"parameters":{"jsCode":"// Parse Gemini response\\nconst config = $('Resolve Config').first().json;\\nconst response = $input.first().json;\\n\\nlet keywords = [];\\ntry {\\n  const text = response.candidates[0].content.parts[0].text;\\n  keywords = text.split(/[,\\\\n]/).map(k => k.trim().toLowerCase()).filter(k => k.length > 2 && k.length < 80);\\n} catch (e) {\\n  keywords = [config.main_keyword.toLowerCase()];\\n}\\n\\n// Main keyword' de ekle\\nif (!keywords.includes(config.main_keyword.toLowerCase())) {\\n  keywords.unshift(config.main_keyword.toLowerCase());\\n}\\n\\nreturn [{\\n  json: {\\n    ...config,\\n    search_keywords: keywords.slice(0, 15),\\n    keyword_source: 'topic_based'\\n  }\\n}];"},"id":"3eeefcf9-e3eb-43f3-b700-c2380d2adfcf","name":"Parse AI Keywords","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1104,304]},{"parameters":{"jsCode":"// Config'i sakla ve keyword'leri ayr item'lara bl\\nconst config = $json;\\nconst keywords = config.search_keywords || [config.main_keyword];\\n\\n// Max 5 keyword iin item olutur\\nreturn keywords.slice(0, 5).map(kw => ({\\n  json: {\\n    config: config,\\n    search_keyword: kw,\\n    suggest_url: `http://suggestqueries.google.com/complete/search?client=firefox&q=${encodeURIComponent(kw)}&hl=${config.target_language || 'tr'}&gl=${config.target_country || 'tr'}`\\n  }\\n}));"},"id":"5457e6cb-9e20-4847-abbb-f6ed12aa14ba","name":"Split Keywords","type":"n8n-nodes-base.code","typeVersion":2,"position":[-768,112]},{"parameters":{"url":"={{ $json.suggest_url }}","options":{"response":{"response":{"responseFormat":"json"}},"timeout":10000}},"id":"a5182841-f304-4d05-83fc-65fd042c7a40","name":"HTTP Google Suggest","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-544,112],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Tm suggest sonularn birletir\\nconst items = $input.all();\\nconst splitItems = $('Split Keywords').all();\\nlet config = splitItems[0]?.json?.config || null;\\nconst allSuggestions = [];\\n\\nfor (let i = 0; i < items.length; i++) {\\n  const item = items[i];\\n  const splitItem = splitItems[i];\\n  const parentKeyword = splitItem?.json?.search_keyword || '';\\n  \\n  // HTTP Response - handle both JSON and text formats\\n  let suggestions = [];\\n  try {\\n    let responseData = item.json.data || item.json;\\n    \\n    // If it's a string, parse as JSON\\n    if (typeof responseData === 'string') {\\n      responseData = JSON.parse(responseData);\\n    }\\n    \\n    // Google Suggest format: [query, [suggestions], [], {}]\\n    if (Array.isArray(responseData) && Array.isArray(responseData[1])) {\\n      suggestions = responseData[1];\\n    }\\n  } catch (e) {\\n    // Parse error, skip\\n    console.log('Parse error for suggestion:', e.message);\\n  }\\n  \\n  suggestions.forEach(suggestion => {\\n    // Ensure proper string handling\\n    const cleanSuggestion = String(suggestion).trim();\\n    if (cleanSuggestion && cleanSuggestion !== parentKeyword && config) {\\n      allSuggestions.push({\\n        project_id: config.project_id,\\n        keyword: cleanSuggestion,\\n        keyword_type: 'google_suggest',\\n        search_volume: null,\\n        keyword_difficulty: null,\\n        cpc: null,\\n        search_intent: null,\\n        trend_direction: 'stable',\\n        parent_topic: parentKeyword,\\n        source: 'google_suggest'\\n      });\\n    }\\n  });\\n}\\n\\nreturn [{ json: { ...config, google_suggest_keywords: allSuggestions } }];"},"id":"2d128f8f-1b66-4741-b57c-a0eb57cb82be","name":"Merge Suggest","type":"n8n-nodes-base.code","typeVersion":2,"position":[-320,112]},{"parameters":{"jsCode":"// ============================================\\n// Google Trends Data (cretsiz)\\n// Related queries ve rising topics\\n// ============================================\\n\\nconst config = $json;\\nconst mainKeyword = config.main_keyword;\\nconst country = config.target_country || 'TR';\\n\\n// Google Trends embed API'den related queries ek\\nconst trendKeywords = [];\\n\\ntry {\\n  // Trends Explore URL'den related topics ekilebilir\\n  // Not: Gerek implementasyonda SerpAPI veya unofficial trends API kullanlabilir\\n  \\n  // imdilik trend-based keyword pattern'ler olutur\\n  const trendPatterns = [\\n    `${mainKeyword} 2024`,\\n    `${mainKeyword} 2025`,\\n    `en iyi ${mainKeyword}`,\\n    `${mainKeyword} nerileri`,\\n    `${mainKeyword} karlatrma`,\\n    `${mainKeyword} yorumlar`,\\n    `${mainKeyword} fiyat`,\\n    `ucuz ${mainKeyword}`,\\n    `${mainKeyword} nasl`,\\n    `${mainKeyword} nedir`\\n  ];\\n  \\n  trendPatterns.forEach(kw => {\\n    trendKeywords.push({\\n      project_id: config.project_id,\\n      keyword: kw.toLowerCase(),\\n      keyword_type: 'trend_based',\\n      search_volume: null,\\n      keyword_difficulty: null,\\n      cpc: null,\\n      search_intent: kw.includes('fiyat') || kw.includes('ucuz') ? 'commercial' : 'informational',\\n      trend_direction: 'up',\\n      parent_topic: mainKeyword,\\n      source: 'google_trends'\\n    });\\n  });\\n} catch (e) {\\n  // Skip on error\\n}\\n\\nreturn [{ json: { ...config, google_trends_keywords: trendKeywords } }];"},"id":"9b227a74-a47d-4581-8852-05d4218a910f","name":"Google Trends","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"ahrefs","leftValue":"={{ $json.enable_ahrefs_api }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"ff136ca1-01cd-4167-a5d6-ee55a3e25d34","name":"IF Ahrefs Enabled","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"method":"POST","url":"https://api.ahrefs.com/v3/keywords-explorer/keyword-ideas","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"country\\": \\"{{ $json.target_country }}\\",\\n  \\"keywords\\": {{ JSON.stringify($json.search_keywords.slice(0, 3)) }},\\n  \\"mode\\": \\"phrase_match\\",\\n  \\"limit\\": 50\\n}","options":{"timeout":60000}},"id":"9fa195e4-755e-4b6d-99fb-b2b0b8476ab1","name":"Ahrefs Keywords","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,0],"credentials":{"httpHeaderAuth":{"id":"01zZGrP0Fob8kD8r","name":"Serper API"}}},{"parameters":{"jsCode":"// Parse Ahrefs response\\nconst config = $('IF Ahrefs Enabled').first().json;\\nconst ahrefsData = $input.first().json;\\nconst keywords = ahrefsData.keywords || [];\\n\\nconst ahrefsKeywords = keywords.map(kw => ({\\n  project_id: config.project_id,\\n  keyword: kw.keyword || '',\\n  keyword_type: 'ahrefs',\\n  search_volume: kw.volume || null,\\n  keyword_difficulty: kw.keyword_difficulty || kw.difficulty || null,\\n  cpc: kw.cpc || null,\\n  search_intent: null,\\n  trend_direction: 'stable',\\n  parent_topic: config.main_keyword,\\n  source: 'ahrefs'\\n}));\\n\\nreturn [{ json: { ...config, ahrefs_keywords: ahrefsKeywords } }];"},"id":"fa34d765-d76e-4c3c-bae4-0b3bf4ab3987","name":"Parse Ahrefs","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"jsCode":"// Ahrefs disabled - bo array dndr\\nconst config = $json;\\nreturn [{ json: { ...config, ahrefs_keywords: [] } }];"},"id":"b254b5eb-a484-4fb1-8611-83ff0a9a95d3","name":"No Ahrefs","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,208]},{"parameters":{"jsCode":"// ============================================\\n// Tm keyword'leri birletir ve tekilletir\\n// ============================================\\n\\nconst items = $input.all();\\nconst config = items[0].json;\\n\\n// Tm kaynaklardan keyword'leri topla\\nconst allKeywords = [];\\n\\n// 1. Primary keyword ekle\\nallKeywords.push({\\n  project_id: config.project_id,\\n  keyword: config.main_keyword.toLowerCase(),\\n  keyword_type: 'primary',\\n  search_volume: null,\\n  keyword_difficulty: null,\\n  cpc: null,\\n  search_intent: null,\\n  trend_direction: 'stable',\\n  parent_topic: null,\\n  source: 'manual'\\n});\\n\\n// 2. Google Suggest keywords\\nif (config.google_suggest_keywords) {\\n  allKeywords.push(...config.google_suggest_keywords);\\n}\\n\\n// 3. Google Trends keywords\\nif (config.google_trends_keywords) {\\n  allKeywords.push(...config.google_trends_keywords);\\n}\\n\\n// 4. Ahrefs keywords\\nif (config.ahrefs_keywords) {\\n  allKeywords.push(...config.ahrefs_keywords);\\n}\\n\\n// Tekilletir (keyword baznda)\\nconst seen = new Set();\\nconst uniqueKeywords = allKeywords.filter(kw => {\\n  const key = kw.keyword.toLowerCase().trim();\\n  if (seen.has(key) || key.length < 2) return false;\\n  seen.add(key);\\n  return true;\\n});\\n\\n// Her keyword iin ayr item dndr\\nreturn uniqueKeywords.map(kw => ({ json: kw }));"},"id":"56c9274d-743c-4c90-8ad3-703c19c377f7","name":"Merge & Dedupe","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,160]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO keyword_results \\n  (project_id, keyword, keyword_type, search_volume, keyword_difficulty, cpc, search_intent, trend_direction, parent_topic, source)\\nVALUES \\n  ({{ $json.project_id }}, '{{ $json.keyword.replace(/'/g, \\"''\\") }}', '{{ $json.keyword_type }}', {{ $json.search_volume || 'NULL' }}, {{ $json.keyword_difficulty || 'NULL' }}, {{ $json.cpc || 'NULL' }}, {{ $json.search_intent ? \\"'\\" + $json.search_intent + \\"'\\" : 'NULL' }}, '{{ $json.trend_direction }}', {{ $json.parent_topic ? \\"'\\" + $json.parent_topic.replace(/'/g, \\"''\\") + \\"'\\" : 'NULL' }}, '{{ $json.source }}')\\nON DUPLICATE KEY UPDATE\\n  search_volume = COALESCE(VALUES(search_volume), search_volume),\\n  keyword_difficulty = COALESCE(VALUES(keyword_difficulty), keyword_difficulty),\\n  source = CONCAT_WS(',', source, VALUES(source))","options":{}},"id":"022fb942-0dd1-4a87-9183-21414c480080","name":"Save Keywords","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,160],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"UPDATE keyword_projects SET\\n  total_keywords_found = (SELECT COUNT(*) FROM keyword_results WHERE project_id = {{ $('Resolve Config').first().json.project_id }}),\\n  status = 'keywords_discovered',\\n  api_source = 'multi_source'\\nWHERE id = {{ $('Resolve Config').first().json.project_id }}","options":{}},"id":"579a8f1f-6aaf-48dc-9391-58935f76600e","name":"Update Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[880,160],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"const config = $('Resolve Config').first().json;\\nconst mergeDedupeItems = $('Merge & Dedupe').all();\\n\\n// Kaynak saylarn hesapla\\nconst sources = {};\\nmergeDedupeItems.forEach(item => {\\n  const src = item.json.source || 'unknown';\\n  sources[src] = (sources[src] || 0) + 1;\\n});\\n\\nreturn {\\n  json: {\\n    success: true,\\n    data: {\\n      project_id: config.project_id,\\n      client_name: config.client_name,\\n      main_keyword: config.main_keyword,\\n      scenario_type: config.scenario_type,\\n      keywords_found: mergeDedupeItems.length,\\n      sources_used: {\\n        google_suggest: config.enable_google_suggest,\\n        google_trends: config.enable_google_trends,\\n        ahrefs: config.enable_ahrefs_api\\n      },\\n      keywords_by_source: sources,\\n      ai_config: {\\n        model: config.ai_model,\\n        provider: config.ai_provider\\n      }\\n    },\\n    next_step: 'WF-101b: Keyword Filter'\\n  }\\n};"},"id":"abf7dc30-7dde-4d7b-96eb-1aeb7c9c9c00","name":"Prepare Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,160]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"1470ce31-1f4b-4d5f-8946-aa4e28bb6e8d","name":"Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1328,160]}]	{"Webhook":{"main":[[{"node":"Validate Input","type":"main","index":0}]]},"Validate Input":{"main":[[{"node":"IF Valid","type":"main","index":0}]]},"IF Valid":{"main":[[{"node":"Get Project","type":"main","index":0}],[{"node":"Respond Error","type":"main","index":0}]]},"Get Project":{"main":[[{"node":"Resolve Config","type":"main","index":0}]]},"Resolve Config":{"main":[[{"node":"IF Exists","type":"main","index":0}]]},"IF Exists":{"main":[[{"node":"Switch Scenario","type":"main","index":0}],[{"node":"Respond 404","type":"main","index":0}]]},"Switch Scenario":{"main":[[{"node":"Prepare Seed","type":"main","index":0}],[{"node":"AI Extract Keywords","type":"main","index":0}]]},"Prepare Seed":{"main":[[{"node":"Split Keywords","type":"main","index":0}]]},"AI Extract Keywords":{"main":[[{"node":"Parse AI Keywords","type":"main","index":0}]]},"Parse AI Keywords":{"main":[[{"node":"Split Keywords","type":"main","index":0}]]},"Split Keywords":{"main":[[{"node":"HTTP Google Suggest","type":"main","index":0}]]},"HTTP Google Suggest":{"main":[[{"node":"Merge Suggest","type":"main","index":0}]]},"Merge Suggest":{"main":[[{"node":"Google Trends","type":"main","index":0}]]},"Google Trends":{"main":[[{"node":"IF Ahrefs Enabled","type":"main","index":0}]]},"IF Ahrefs Enabled":{"main":[[{"node":"Ahrefs Keywords","type":"main","index":0}],[{"node":"No Ahrefs","type":"main","index":0}]]},"Ahrefs Keywords":{"main":[[{"node":"Parse Ahrefs","type":"main","index":0}]]},"Parse Ahrefs":{"main":[[{"node":"Merge & Dedupe","type":"main","index":0}]]},"No Ahrefs":{"main":[[{"node":"Merge & Dedupe","type":"main","index":0}]]},"Merge & Dedupe":{"main":[[{"node":"Save Keywords","type":"main","index":0}]]},"Save Keywords":{"main":[[{"node":"Update Project","type":"main","index":0}]]},"Update Project":{"main":[[{"node":"Prepare Response","type":"main","index":0}]]},"Prepare Response":{"main":[[{"node":"Success","type":"main","index":0}]]}}	Version 90411821	f	
6af1d565-35ba-4e0b-97d9-a109bbb7b16d	6nclsXOjxGhT8qJs	Fatih Berkay Baheci	2025-12-17 10:27:22.449+00	2025-12-17 10:27:23.909+00	[{"parameters":{"httpMethod":"POST","path":":projectId/filter-keywords","responseMode":"responseNode","options":{}},"id":"086a5924-9929-4d72-865a-49babb42c0e1","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-2640,112],"webhookId":"tool1-keyword-filter"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Input validation\\nconst projectId = $json.params?.projectId;\\n\\n// Validate projectId\\nif (!projectId) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'project_id parametresi zorunludur',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nconst parsedId = parseInt(projectId);\\nif (isNaN(parsedId) || parsedId <= 0) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'project_id gecerli bir pozitif sayi olmalidir',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nreturn {\\n  json: {\\n    isValid: true,\\n    projectId: parsedId\\n  }\\n};"},"id":"3f00def3-9491-4873-a8f2-9c9f23675970","name":"Code - Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2416,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"0954be86-7a09-4923-8b1d-ca23e6b72df4","name":"IF - Valid Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[-2208,112]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Validation failed\\",\\n  \\"message\\": \\"{{ $json.error }}\\"\\n}","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"866c5943-bfab-4440-a1bb-9b15bf811fd0","name":"Respond - Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-1984,256]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  (SELECT id FROM keyword_projects WHERE id = {{ $json.projectId }}) as project_id,\\n  (SELECT client_id FROM keyword_projects WHERE id = {{ $json.projectId }}) as client_id,\\n  (SELECT main_keyword FROM keyword_projects WHERE id = {{ $json.projectId }}) as main_keyword,\\n  (SELECT scenario_type FROM keyword_projects WHERE id = {{ $json.projectId }}) as scenario_type,\\n  (SELECT target_country FROM keyword_projects WHERE id = {{ $json.projectId }}) as target_country,\\n  (SELECT target_language FROM keyword_projects WHERE id = {{ $json.projectId }}) as target_language,\\n  (SELECT c.domain FROM keyword_projects kp JOIN clients c ON c.id = kp.client_id WHERE kp.id = {{ $json.projectId }}) as client_domain,\\n  (SELECT c.name FROM keyword_projects kp JOIN clients c ON c.id = kp.client_id WHERE kp.id = {{ $json.projectId }}) as client_name,\\n  (SELECT COALESCE(cc.enable_ai_analysis, 0) FROM keyword_projects kp LEFT JOIN client_configurations cc ON cc.client_id = kp.client_id WHERE kp.id = {{ $json.projectId }}) as enable_ai_analysis,\\n  (SELECT COALESCE(cc.ai_model_preference, 'gemini-2.0-flash') FROM keyword_projects kp LEFT JOIN client_configurations cc ON cc.client_id = kp.client_id WHERE kp.id = {{ $json.projectId }}) as ai_model,\\n  (SELECT COALESCE(cc.ai_temperature, 0.7) FROM keyword_projects kp LEFT JOIN client_configurations cc ON cc.client_id = kp.client_id WHERE kp.id = {{ $json.projectId }}) as ai_temperature,\\n  (SELECT cc.target_audience FROM keyword_projects kp LEFT JOIN client_configurations cc ON cc.client_id = kp.client_id WHERE kp.id = {{ $json.projectId }}) as target_audience,\\n  (SELECT prompt_text FROM system_prompts WHERE slug = 'keyword-filter' AND is_active = 1 LIMIT 1) as system_prompt","options":{}},"id":"0f712d11-e31c-4fe2-b99f-5156270b0fbb","name":"MySQL - Get Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1984,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Check if project exists and pass all data including system_prompt\\nconst result = $input.first().json;\\nconst validatedData = $('Code - Validate Input').first().json;\\n\\nif (!result.project_id) {\\n  return [{\\n    json: {\\n      projectExists: false,\\n      projectId: validatedData.projectId\\n    }\\n  }];\\n}\\n\\nreturn [{\\n  json: {\\n    projectExists: true,\\n    project_id: result.project_id,\\n    client_id: result.client_id,\\n    main_keyword: result.main_keyword,\\n    scenario_type: result.scenario_type,\\n    target_country: result.target_country,\\n    target_language: result.target_language,\\n    client_domain: result.client_domain,\\n    client_name: result.client_name,\\n    enable_ai_analysis: result.enable_ai_analysis,\\n    ai_model: result.ai_model,\\n    ai_temperature: result.ai_temperature,\\n    target_audience: result.target_audience,\\n    system_prompt: result.system_prompt,\\n    projectId: validatedData.projectId\\n  }\\n}];"},"id":"f507a0a8-f569-4cc2-8b2e-4bea64cdb680","name":"Code - Check Project","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1760,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"project-exists","leftValue":"={{ $json.projectExists }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"e5fbe619-6d3e-4655-9b9e-d94c4f6f8745","name":"IF - Project Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1536,112]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Project not found\\",\\n  \\"message\\": \\"Proje bulunamadi: {{ $json.projectId }}\\"\\n}","options":{"responseCode":404}},"id":"5d23718b-5775-47ba-9708-95e1ac0bab76","name":"Respond - Project Not Found","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-1328,256]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  id,\\n  keyword,\\n  keyword_type,\\n  search_volume,\\n  keyword_difficulty,\\n  cpc,\\n  search_intent,\\n  trend_direction,\\n  opportunity_score\\nFROM keyword_results \\nWHERE project_id = {{ $json.project_id }}\\nORDER BY search_volume DESC\\nLIMIT 100","options":{}},"id":"adaab5ea-b566-40f7-b5cb-1550ccebf03c","name":"MySQL - Get Keywords","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1328,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Check if keywords exist and pass all project data including system_prompt\\nconst items = $input.all();\\nconst projectData = $('Code - Check Project').first().json;\\n\\nconst hasKeywords = items.length > 0 && !!items[0].json.id;\\n\\n// Pass complete projectData including system_prompt\\nreturn [{\\n  json: {\\n    hasKeywords: hasKeywords,\\n    keywordCount: hasKeywords ? items.length : 0,\\n    projectData: {\\n      project_id: projectData.project_id,\\n      client_id: projectData.client_id,\\n      main_keyword: projectData.main_keyword,\\n      scenario_type: projectData.scenario_type,\\n      client_name: projectData.client_name,\\n      target_audience: projectData.target_audience,\\n      enable_ai_analysis: projectData.enable_ai_analysis,\\n      ai_model: projectData.ai_model,\\n      ai_temperature: projectData.ai_temperature,\\n      system_prompt: projectData.system_prompt\\n    },\\n    keywords: hasKeywords ? items.map(i => i.json) : []\\n  }\\n}];"},"id":"7ed9d9a7-c469-4b43-8d7c-ea762c00a80a","name":"Code - Check Keywords","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1104,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-keywords","leftValue":"={{ $json.hasKeywords }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"9712ecc9-255f-4b61-a682-981e8daf5750","name":"IF - Has Keywords","type":"n8n-nodes-base.if","typeVersion":2,"position":[-880,112]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"No keywords found\\",\\n  \\"message\\": \\"Bu projede filtrelenecek keyword bulunamadi. Once WF-101a ile keyword discovery yapin.\\",\\n  \\"project_id\\": {{ $json.projectData.project_id }}\\n}","options":{"responseCode":404}},"id":"9a19c0fe-0bf2-44e6-8462-60abc19f98e9","name":"Respond - No Keywords","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-656,256]},{"parameters":{"jsCode":"// Prepare AI prompt from database template - COMPACT CSV FORMAT\\nconst data = $input.first().json;\\nconst projectData = data.projectData;\\nconst keywords = data.keywords;\\n\\n// Build keyword list in compact CSV format: ID|keyword\\nconst keywordList = keywords.map(kw => `${kw.id}|${kw.keyword}`).join('\\\\n');\\n\\n// Get system prompt from database and replace template variables\\nlet prompt = projectData.system_prompt || '';\\n\\nif (!prompt) {\\n  prompt = `Keyword filtreleme. Ana konu: ${projectData.main_keyword}\\\\nKEYWORDS (ID|keyword):\\\\n${keywordList}\\\\nIKTI (sadece CSV, balk yok):\\\\nID|status|intent|cluster`;\\n}\\n\\n// Replace template variables\\nprompt = prompt\\n  .replace(/\\\\{\\\\{main_keyword\\\\}\\\\}/g, projectData.main_keyword || '')\\n  .replace(/\\\\{\\\\{client_name\\\\}\\\\}/g, projectData.client_name || '')\\n  .replace(/\\\\{\\\\{target_audience\\\\}\\\\}/g, projectData.target_audience || '')\\n  .replace(/\\\\{\\\\{scenario_type\\\\}\\\\}/g, projectData.scenario_type || '')\\n  .replace(/\\\\{\\\\{keyword_list\\\\}\\\\}/g, keywordList);\\n\\nreturn [{\\n  json: {\\n    project_id: projectData.project_id,\\n    client_id: projectData.client_id,\\n    main_keyword: projectData.main_keyword,\\n    enable_ai_analysis: projectData.enable_ai_analysis,\\n    ai_model: projectData.ai_model,\\n    ai_temperature: projectData.ai_temperature || 0.7,\\n    prompt: prompt,\\n    keyword_count: keywords.length,\\n    keywords: keywords\\n  }\\n}];"},"id":"f9ffc55c-0d61-4c74-b9f4-dfd11cdf1f54","name":"Code - Prepare AI Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,112]},{"parameters":{"url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{\\n    \\"parts\\": [{\\n      \\"text\\": {{ JSON.stringify($json.prompt) }}\\n    }]\\n  }],\\n  \\"generationConfig\\": {\\n    \\"temperature\\": {{ $json.ai_temperature }},\\n    \\"maxOutputTokens\\": 4096\\n  }\\n}","options":{"timeout":30000}},"id":"6f91d0aa-06d0-4cb6-bb53-26b6ad8febb5","name":"Gemini - Try First","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-448,112],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"gemini-success","leftValue":"={{ $json.candidates && $json.candidates.length > 0 }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"749dc652-f8b7-4ce4-b55d-3a9e6e7eb151","name":"IF - Gemini Success","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"url":"https://api.openai.com/v1/chat/completions","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"model\\": \\"gpt-4\\",\\n  \\"messages\\": [\\n    {\\n      \\"role\\": \\"user\\",\\n      \\"content\\": {{ JSON.stringify($('Code - Prepare AI Prompt').first().json.prompt) }}\\n    }\\n  ],\\n  \\"temperature\\": {{ $('Code - Prepare AI Prompt').first().json.ai_temperature }},\\n  \\"max_tokens\\": 4096\\n}","options":{"timeout":60000}},"id":"2f32dbee-36df-4110-b55f-228858267437","name":"OpenAI - Fallback","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,256],"credentials":{"httpHeaderAuth":{"id":"01zZGrP0Fob8kD8r","name":"Serper API"}},"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"openai-success","leftValue":"={{ $json.choices && $json.choices.length > 0 }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"58e58e61-d503-499b-83d6-9aa15ada3486","name":"IF - OpenAI Success","type":"n8n-nodes-base.if","typeVersion":2,"position":[224,256]},{"parameters":{"jsCode":"// Mock AI filtreleme - fallback when both APIs fail\\nconst promptData = $('Code - Prepare AI Prompt').first().json;\\nconst keywords = promptData.keywords || [];\\n\\nconst approved = [];\\nconst rejected = [];\\nconst clusterMap = {};\\n\\nkeywords.forEach((kw, idx) => {\\n  const keyword = kw.keyword.toLowerCase();\\n  \\n  // Eleme kriterleri\\n  if (keyword.length < 3) {\\n    rejected.push({ keyword_id: kw.id, keyword: kw.keyword, rejection_reason: 'Cok kisa keyword' });\\n    return;\\n  }\\n  \\n  if (kw.search_volume && kw.search_volume < 10) {\\n    rejected.push({ keyword_id: kw.id, keyword: kw.keyword, rejection_reason: 'Cok dusuk arama hacmi' });\\n    return;\\n  }\\n  \\n  // Intent belirleme\\n  let intent = 'informational';\\n  if (keyword.includes('fiyat') || keyword.includes('satin al') || keyword.includes('nereden')) {\\n    intent = 'commercial';\\n  } else if (keyword.includes('siparis') || keyword.includes('indir')) {\\n    intent = 'transactional';\\n  } else if (keyword.includes('nedir') || keyword.includes('nasil')) {\\n    intent = 'informational';\\n  }\\n  \\n  // Firsat skoru hesapla\\n  let score = 50;\\n  if (kw.search_volume > 1000) score += 20;\\n  else if (kw.search_volume > 500) score += 10;\\n  \\n  if (kw.keyword_difficulty && kw.keyword_difficulty < 30) score += 15;\\n  else if (kw.keyword_difficulty && kw.keyword_difficulty < 50) score += 5;\\n  \\n  if (kw.keyword_type === 'long_tail') score += 10;\\n  if (kw.keyword_type === 'question') score += 5;\\n  \\n  // Kume belirleme\\n  let cluster = 'Genel';\\n  if (keyword.includes('nedir') || keyword.includes('ne ise yarar')) {\\n    cluster = 'Bilgi Icerikleri';\\n  } else if (keyword.includes('fiyat') || keyword.includes('maliyet')) {\\n    cluster = 'Fiyat Karsilastirma';\\n  } else if (keyword.includes('nasil') || keyword.includes('yapilir')) {\\n    cluster = 'Rehber Icerikleri';\\n  } else if (keyword.includes('en iyi') || keyword.includes('onerisi')) {\\n    cluster = 'Karsilastirma Icerikleri';\\n  }\\n  \\n  if (!clusterMap[cluster]) clusterMap[cluster] = [];\\n  clusterMap[cluster].push(kw.keyword);\\n  \\n  approved.push({\\n    keyword_id: kw.id,\\n    keyword: kw.keyword,\\n    search_intent: intent,\\n    opportunity_score: Math.min(score, 100),\\n    priority: score >= 70 ? 'high' : score >= 50 ? 'medium' : 'low',\\n    cluster_suggestion: cluster,\\n    reasoning: `${kw.keyword_type} keyword, ${kw.search_volume || 'bilinmeyen'} hacim`\\n  });\\n});\\n\\nreturn {\\n  project_id: promptData.project_id,\\n  ai_response: {\\n    summary: `[MOCK - API Fallback] ${keywords.length} keyword analiz edildi. ${approved.length} onaylandi, ${rejected.length} elendi.`,\\n    total_input: keywords.length,\\n    total_approved: approved.length,\\n    total_rejected: rejected.length,\\n    approved_keywords: approved,\\n    rejected_keywords: rejected,\\n    cluster_map: clusterMap\\n  },\\n  ai_source: 'mock'\\n};"},"id":"5d22b808-fbe3-42ea-b2e0-c6654cd7316d","name":"Code - Mock Fallback","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,400]},{"parameters":{"jsCode":"// Gemini response parse - CSV FORMAT: ID|status|intent|cluster\\nconst inputData = $input.first().json;\\nconst projectData = $('Code - Prepare AI Prompt').first().json;\\nconst originalKeywords = projectData.keywords || [];\\n\\nlet rawContent = inputData.candidates[0].content.parts[0].text;\\n\\n// Clean markdown if present\\nlet csvContent = rawContent.replace(/```[a-z]*\\\\n?/g, '').replace(/```/g, '').trim();\\n\\n// Parse CSV lines\\nconst lines = csvContent.split('\\\\n').filter(l => l.trim() && !l.startsWith('ID|'));\\nconst approved = [];\\nconst rejected = [];\\nconst clusterMap = {};\\n\\nfor (const line of lines) {\\n  const parts = line.split('|').map(p => p.trim());\\n  if (parts.length < 4) continue;\\n  \\n  const [id, status, intent, cluster] = parts;\\n  const kwId = parseInt(id);\\n  const origKw = originalKeywords.find(k => k.id === kwId);\\n  if (!origKw) continue;\\n  \\n  if (status === 'approved' || status === 'onay') {\\n    approved.push({\\n      keyword_id: kwId,\\n      keyword: origKw.keyword,\\n      search_intent: intent,\\n      opportunity_score: 70,\\n      priority: 'medium',\\n      cluster_suggestion: cluster\\n    });\\n    if (!clusterMap[cluster]) clusterMap[cluster] = [];\\n    clusterMap[cluster].push(origKw.keyword);\\n  } else {\\n    rejected.push({ keyword_id: kwId, keyword: origKw.keyword, rejection_reason: status });\\n  }\\n}\\n\\nconst aiResponse = {\\n  summary: `${originalKeywords.length} keyword analiz edildi. ${approved.length} onayland, ${rejected.length} elendi.`,\\n  total_input: originalKeywords.length,\\n  total_approved: approved.length,\\n  total_rejected: rejected.length,\\n  approved_keywords: approved,\\n  rejected_keywords: rejected,\\n  cluster_map: clusterMap\\n};\\n\\nreturn { project_id: projectData.project_id, ai_response: aiResponse, ai_source: 'gemini' };"},"id":"ba50c82d-984e-40e2-844a-d515da770866","name":"Code - Parse Gemini","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,0]},{"parameters":{"jsCode":"// OpenAI response parse - CSV FORMAT: ID|status|intent|cluster\\nconst inputData = $input.first().json;\\nconst projectData = $('Code - Prepare AI Prompt').first().json;\\nconst originalKeywords = projectData.keywords || [];\\n\\nlet rawContent = inputData.choices[0].message.content;\\n\\n// Clean markdown if present\\nlet csvContent = rawContent.replace(/```[a-z]*\\\\n?/g, '').replace(/```/g, '').trim();\\n\\n// Parse CSV lines\\nconst lines = csvContent.split('\\\\n').filter(l => l.trim() && !l.startsWith('ID|'));\\nconst approved = [];\\nconst rejected = [];\\nconst clusterMap = {};\\n\\nfor (const line of lines) {\\n  const parts = line.split('|').map(p => p.trim());\\n  if (parts.length < 4) continue;\\n  \\n  const [id, status, intent, cluster] = parts;\\n  const kwId = parseInt(id);\\n  const origKw = originalKeywords.find(k => k.id === kwId);\\n  if (!origKw) continue;\\n  \\n  if (status === 'approved' || status === 'onay') {\\n    approved.push({\\n      keyword_id: kwId,\\n      keyword: origKw.keyword,\\n      search_intent: intent,\\n      opportunity_score: 70,\\n      priority: 'medium',\\n      cluster_suggestion: cluster\\n    });\\n    if (!clusterMap[cluster]) clusterMap[cluster] = [];\\n    clusterMap[cluster].push(origKw.keyword);\\n  } else {\\n    rejected.push({ keyword_id: kwId, keyword: origKw.keyword, rejection_reason: status });\\n  }\\n}\\n\\nconst aiResponse = {\\n  summary: `${originalKeywords.length} keyword analiz edildi. ${approved.length} onayland, ${rejected.length} elendi.`,\\n  total_input: originalKeywords.length,\\n  total_approved: approved.length,\\n  total_rejected: rejected.length,\\n  approved_keywords: approved,\\n  rejected_keywords: rejected,\\n  cluster_map: clusterMap\\n};\\n\\nreturn { project_id: projectData.project_id, ai_response: aiResponse, ai_source: 'openai' };"},"id":"e2e86593-6766-470d-8d8e-2a267b7e84b9","name":"Code - Parse OpenAI","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,160]},{"parameters":{"jsCode":"// Calculate token usage from AI responses\\nconst data = $input.first().json;\\nconst projectData = $('Code - Prepare AI Prompt').first().json;\\nconst aiSource = data.ai_source;\\n\\nlet tokensInput = 0;\\nlet tokensOutput = 0;\\nlet modelName = '';\\nlet apiProvider = '';\\n\\n// Estimate tokens based on character count (rough estimate: chars/4)\\nconst promptLength = projectData.prompt ? projectData.prompt.length : 0;\\ntokensInput = Math.ceil(promptLength / 4);\\n\\nif (aiSource === 'gemini') {\\n  const geminiResponse = $('Gemini - Try First').first().json;\\n  const responseText = geminiResponse?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  tokensOutput = Math.ceil(responseText.length / 4);\\n  apiProvider = 'gemini';\\n  modelName = 'gemini-2.0-flash';\\n} else if (aiSource === 'openai') {\\n  const openaiResponse = $('OpenAI - Fallback').first().json;\\n  const responseText = openaiResponse?.choices?.[0]?.message?.content || '';\\n  tokensOutput = Math.ceil(responseText.length / 4);\\n  apiProvider = 'openai';\\n  modelName = 'gpt-4';\\n} else if (aiSource === 'mock') {\\n  // Mock fallback - minimal token usage\\n  tokensInput = Math.ceil(promptLength / 4);\\n  tokensOutput = 100;\\n  apiProvider = 'mock';\\n  modelName = 'mock-fallback';\\n}\\n\\nreturn {\\n  project_id: data.project_id,\\n  client_id: projectData.client_id,\\n  ai_source: aiSource,\\n  ai_response: data.ai_response,\\n  token_tracking: {\\n    api_provider: apiProvider,\\n    model_name: modelName,\\n    tokens_input: tokensInput,\\n    tokens_output: tokensOutput,\\n    requests_count: 1,\\n    was_successful: 1\\n  }\\n};"},"id":"e72ffd25-218f-4bc7-b32a-17a881ba47a5","name":"Code - Calculate Token Usage","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,112]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO api_usage_tracking \\n  (client_id, tool_name, project_id, workflow_name, api_provider, model_name, tokens_input, tokens_output, requests_count, was_successful)\\nVALUES \\n  ({{ $json.client_id }}, 'tool1', {{ $json.project_id }}, 'WF-101b-keyword-filter', '{{ $json.token_tracking.api_provider }}', '{{ $json.token_tracking.model_name }}', {{ $json.token_tracking.tokens_input }}, {{ $json.token_tracking.tokens_output }}, {{ $json.token_tracking.requests_count }}, {{ $json.token_tracking.was_successful }})","options":{}},"id":"136ecb62-8e57-4fb9-9e1c-09ff16423922","name":"MySQL - Log Token Usage","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[880,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Split approved keywords for update - Reference token calculation node for original data\\nconst data = $('Code - Calculate Token Usage').first().json;\\nconst aiResponse = data.ai_response;\\nconst approved = aiResponse?.approved_keywords || [];\\n\\nif (approved.length === 0) {\\n  return [{ json: { skip: true, project_id: data.project_id, ai_source: data.ai_source, ai_response: aiResponse, count: 0 } }];\\n}\\n\\nreturn approved.map(kw => ({\\n  json: {\\n    keyword_id: kw.keyword_id,\\n    search_intent: kw.search_intent,\\n    opportunity_score: kw.opportunity_score,\\n    keyword_cluster: kw.cluster_suggestion,\\n    project_id: data.project_id,\\n    ai_source: data.ai_source,\\n    ai_response: aiResponse\\n  }\\n}));"},"id":"eea514e5-ced9-4a45-be11-55e1f5228b73","name":"Code - Split Approved","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-approved","leftValue":"={{ $json.skip }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"8c1275a5-1701-4174-92a3-6f763e5a8974","name":"IF - Has Approved","type":"n8n-nodes-base.if","typeVersion":2,"position":[880,112]},{"parameters":{"operation":"executeQuery","query":"=UPDATE keyword_results \\nSET \\n  search_intent = '{{ $json.search_intent }}',\\n  opportunity_score = {{ $json.opportunity_score }},\\n  keyword_cluster = '{{ ($json.keyword_cluster || '').replace(/'/g, \\"''\\") }}'\\nWHERE id = {{ $json.keyword_id }}","options":{}},"id":"5310c69a-5364-4fd1-8f78-af7844ebbe2f","name":"MySQL - Update Keyword","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1104,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=UPDATE keyword_projects \\nSET status = 'keywords_filtered'\\nWHERE id = {{ $('Code - Split Approved').first().json.project_id }}","options":{}},"id":"98fd40a1-a559-449e-ae72-39e7e781cdf8","name":"MySQL - Update Project Status","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1328,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"const firstItem = $('Code - Split Approved').first().json;\\nconst aiResponse = firstItem.ai_response || {};\\nconst approvedCount = $('Code - Split Approved').all().length;\\n\\nreturn {\\n  success: true,\\n  message: aiResponse.summary || 'Keyword filtreleme tamamlandi',\\n  project_id: firstItem.project_id,\\n  total_input: aiResponse.total_input || 0,\\n  total_approved: aiResponse.total_approved || approvedCount,\\n  total_rejected: aiResponse.total_rejected || 0,\\n  cluster_map: aiResponse.cluster_map || {},\\n  ai_source: firstItem.ai_source || 'unknown',\\n  next_step: 'WF-104 Competitor Analyzer ile rakip analizi yapilabilir'\\n};"},"id":"f8d75740-b0eb-455d-88ed-c18b395aa664","name":"Code - Prepare Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1552,112]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"94cfc5f8-80a6-4c79-b3ec-82de2c9bd551","name":"Respond - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1760,112]},{"parameters":{"jsCode":"const data = $input.first().json;\\nconst aiResponse = data.ai_response || {};\\n\\nreturn {\\n  success: true,\\n  message: 'Filtreleme tamamlandi ancak onaylanan keyword bulunamadi',\\n  project_id: data.project_id,\\n  total_input: aiResponse.total_input || 0,\\n  total_approved: 0,\\n  total_rejected: aiResponse.total_rejected || 0,\\n  ai_source: data.ai_source || 'unknown'\\n};"},"id":"a951f37e-c5d5-4c83-9731-25cccccb9831","name":"Code - No Approved","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,208]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"8a0f6b1c-8b6c-4c6b-9a76-08398fe7e3f5","name":"Respond - No Approved","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1328,208]}]	{"Webhook":{"main":[[{"node":"Code - Validate Input","type":"main","index":0}]]},"Code - Validate Input":{"main":[[{"node":"IF - Valid Input","type":"main","index":0}]]},"IF - Valid Input":{"main":[[{"node":"MySQL - Get Project","type":"main","index":0}],[{"node":"Respond - Validation Error","type":"main","index":0}]]},"MySQL - Get Project":{"main":[[{"node":"Code - Check Project","type":"main","index":0}]]},"Code - Check Project":{"main":[[{"node":"IF - Project Exists","type":"main","index":0}]]},"IF - Project Exists":{"main":[[{"node":"MySQL - Get Keywords","type":"main","index":0}],[{"node":"Respond - Project Not Found","type":"main","index":0}]]},"MySQL - Get Keywords":{"main":[[{"node":"Code - Check Keywords","type":"main","index":0}]]},"Code - Check Keywords":{"main":[[{"node":"IF - Has Keywords","type":"main","index":0}]]},"IF - Has Keywords":{"main":[[{"node":"Code - Prepare AI Prompt","type":"main","index":0}],[{"node":"Respond - No Keywords","type":"main","index":0}]]},"Code - Prepare AI Prompt":{"main":[[{"node":"Gemini - Try First","type":"main","index":0}]]},"Gemini - Try First":{"main":[[{"node":"IF - Gemini Success","type":"main","index":0}]]},"IF - Gemini Success":{"main":[[{"node":"Code - Parse Gemini","type":"main","index":0}],[{"node":"OpenAI - Fallback","type":"main","index":0}]]},"Code - Parse Gemini":{"main":[[{"node":"Code - Calculate Token Usage","type":"main","index":0}]]},"OpenAI - Fallback":{"main":[[{"node":"IF - OpenAI Success","type":"main","index":0}]]},"IF - OpenAI Success":{"main":[[{"node":"Code - Parse OpenAI","type":"main","index":0}],[{"node":"Code - Mock Fallback","type":"main","index":0}]]},"Code - Parse OpenAI":{"main":[[{"node":"Code - Calculate Token Usage","type":"main","index":0}]]},"Code - Mock Fallback":{"main":[[{"node":"Code - Calculate Token Usage","type":"main","index":0}]]},"Code - Calculate Token Usage":{"main":[[{"node":"MySQL - Log Token Usage","type":"main","index":0}]]},"MySQL - Log Token Usage":{"main":[[{"node":"Code - Split Approved","type":"main","index":0}]]},"Code - Split Approved":{"main":[[{"node":"IF - Has Approved","type":"main","index":0}]]},"IF - Has Approved":{"main":[[{"node":"MySQL - Update Keyword","type":"main","index":0}],[{"node":"Code - No Approved","type":"main","index":0}]]},"MySQL - Update Keyword":{"main":[[{"node":"MySQL - Update Project Status","type":"main","index":0}]]},"MySQL - Update Project Status":{"main":[[{"node":"Code - Prepare Response","type":"main","index":0}]]},"Code - Prepare Response":{"main":[[{"node":"Respond - Success","type":"main","index":0}]]},"Code - No Approved":{"main":[[{"node":"Respond - No Approved","type":"main","index":0}]]}}	Version 6af1d565	f	
f0e64617-34fd-4f76-b5f5-07f41216e98e	yd6UhBrs7iqGeEg6	Fatih Berkay Baheci	2025-12-17 10:27:50.264+00	2025-12-17 10:27:51.478+00	[{"parameters":{"path":"tool1/project/:id","responseMode":"responseNode","options":{}},"id":"910de8f9-e1b3-42fc-bf63-f189424c7f8b","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"tool1-project-get"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Input validation\\nconst id = $json.params?.id;\\n\\nif (!id) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'id parametresi zorunludur',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\n// Check if it's a numeric ID or UUID\\nconst isNumeric = /^\\\\d+$/.test(id);\\nconst isUUID = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(id);\\n\\nif (!isNumeric && !isUUID) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'id gecerli bir sayi veya UUID olmalidir',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nreturn {\\n  json: {\\n    isValid: true,\\n    id: id,\\n    isNumeric: isNumeric,\\n    isUUID: isUUID\\n  }\\n};"},"id":"282a0248-8ac0-47a3-85aa-290d64ee7aa9","name":"Code - Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"fcbe0035-aa68-4d63-936c-84d536ecf153","name":"IF - Valid Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,0]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Validation failed\\",\\n  \\"message\\": \\"{{ $json.error }}\\"\\n}","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"ec1a04c9-c9a4-4edb-bd7c-dc8032fb2301","name":"Respond - Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,160]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  (SELECT id FROM keyword_projects WHERE id = {{ $json.isNumeric ? $json.id : 0 }} OR uuid = '{{ $json.isUUID ? $json.id : '' }}' LIMIT 1) as project_id","options":{}},"id":"29e4692a-6833-4eb8-bc4c-d5469b78c57f","name":"MySQL - Check Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Check if project exists\\nconst result = $input.first().json;\\nconst validatedData = $('Code - Validate Input').first().json;\\n\\nif (!result.project_id) {\\n  return [{\\n    json: {\\n      projectExists: false,\\n      id: validatedData.id\\n    }\\n  }];\\n}\\n\\nreturn [{\\n  json: {\\n    projectExists: true,\\n    projectId: result.project_id\\n  }\\n}];"},"id":"60156490-2f66-4de0-8989-d88e5d7cda40","name":"Code - Check Exists","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,0]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"exists","leftValue":"={{ $json.projectExists }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"e90fbaf7-fbbe-408f-9561-cb69c41188ea","name":"IF - Project Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[1104,0]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Project not found\\",\\n  \\"message\\": \\"Proje bulunamadi: {{ $json.id }}\\"\\n}","options":{"responseCode":404}},"id":"37e17b05-8688-4138-ae33-227b5e5de105","name":"Respond - Not Found","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1328,160]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  kp.id,\\n  kp.uuid,\\n  kp.project_name,\\n  kp.main_keyword,\\n  kp.target_country,\\n  kp.target_language,\\n  kp.status,\\n  COALESCE(kp.total_keywords_found, (SELECT COUNT(*) FROM keyword_results WHERE project_id = kp.id)) as total_keywords_found,\\n  COALESCE(kp.total_competitors_analyzed, (SELECT COUNT(*) FROM competitor_data WHERE project_id = kp.id)) as total_competitors_analyzed,\\n  COALESCE(kp.total_paa_found, (SELECT COUNT(*) FROM paa_data WHERE project_id = kp.id)) as total_paa_found,\\n  kp.created_at,\\n  kp.updated_at,\\n  c.id as client_id,\\n  c.name as client_name,\\n  (SELECT COUNT(*) FROM keyword_results WHERE project_id = kp.id) as keyword_count,\\n  (SELECT COUNT(*) FROM keyword_results WHERE project_id = kp.id AND search_intent IS NOT NULL) as analyzed_count\\nFROM keyword_projects kp\\nLEFT JOIN clients c ON kp.client_id = c.id\\nWHERE kp.id = {{ $json.projectId }}","options":{}},"id":"ae385843-66cc-4b94-96c9-c7663fab30d7","name":"MySQL - Get Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1328,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Format response\\nconst project = $input.first().json;\\n\\nreturn [{\\n  json: {\\n    success: true,\\n    data: {\\n      id: project.id,\\n      uuid: project.uuid,\\n      project_name: project.project_name,\\n      main_keyword: project.main_keyword,\\n      target_country: project.target_country,\\n      target_language: project.target_language,\\n      status: project.status,\\n      total_keywords_found: project.total_keywords_found || 0,\\n      total_competitors_analyzed: project.total_competitors_analyzed || 0,\\n      total_paa_found: project.total_paa_found || 0,\\n      created_at: project.created_at,\\n      updated_at: project.updated_at,\\n      client: project.client_id ? {\\n        id: project.client_id,\\n        name: project.client_name\\n      } : null,\\n      stats: {\\n        keyword_count: parseInt(project.keyword_count) || 0,\\n        analyzed_count: parseInt(project.analyzed_count) || 0\\n      }\\n    }\\n  }\\n}];"},"id":"ee906cba-3a6a-4724-a6b6-9b62e8980422","name":"Code - Format Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1552,0]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"12bf68ef-fba1-4639-860f-481ad0285162","name":"Respond - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1760,0]}]	{"Webhook":{"main":[[{"node":"Code - Validate Input","type":"main","index":0}]]},"Code - Validate Input":{"main":[[{"node":"IF - Valid Input","type":"main","index":0}]]},"IF - Valid Input":{"main":[[{"node":"MySQL - Check Project","type":"main","index":0}],[{"node":"Respond - Validation Error","type":"main","index":0}]]},"MySQL - Check Project":{"main":[[{"node":"Code - Check Exists","type":"main","index":0}]]},"Code - Check Exists":{"main":[[{"node":"IF - Project Exists","type":"main","index":0}]]},"IF - Project Exists":{"main":[[{"node":"MySQL - Get Project","type":"main","index":0}],[{"node":"Respond - Not Found","type":"main","index":0}]]},"MySQL - Get Project":{"main":[[{"node":"Code - Format Response","type":"main","index":0}]]},"Code - Format Response":{"main":[[{"node":"Respond - Success","type":"main","index":0}]]}}	Version f0e64617	f	
4117e47b-f342-43ae-9f1d-ae8ee30514c7	UxU00NHUOlNJSpFi	Fatih Berkay Baheci	2025-12-17 10:28:20.591+00	2025-12-17 10:28:21.813+00	[{"parameters":{"httpMethod":"POST","path":":projectId/analyze-competitors","responseMode":"responseNode","options":{}},"id":"3634d046-f746-493c-b78e-110c3de66057","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-2272,208],"webhookId":"tool1-competitor-analyze"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Input validation\\nconst projectId = $json.params?.projectId;\\n\\nif (!projectId) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'projectId parametresi zorunludur',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nconst parsedId = parseInt(projectId);\\nif (isNaN(parsedId) || parsedId <= 0) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'projectId gecerli bir pozitif sayi olmalidir',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\n// Get competitor count from body (optional)\\nconst body = $json.body || {};\\nlet competitorCount = parseInt(body.competitor_count) || 10;\\ncompetitorCount = Math.min(Math.max(competitorCount, 3), 20); // 3-20 aras\\n\\nreturn {\\n  json: {\\n    isValid: true,\\n    projectId: parsedId,\\n    competitorCount: competitorCount\\n  }\\n};"},"id":"8543ca90-1481-4296-9ecf-3117c4e09f9b","name":"Code - Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2048,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"050f3b03-eae5-4773-bdb5-1ebbbceff914","name":"IF - Valid Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1824,208]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Validation failed\\",\\n  \\"message\\": \\"{{ $json.error }}\\"\\n}","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"3ac0f6a0-61d5-4f08-8961-a22321a3dc94","name":"Respond - Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-1600,400]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  (SELECT id FROM keyword_projects WHERE id = {{ $json.projectId }}) as project_id,\\n  (SELECT project_name FROM keyword_projects WHERE id = {{ $json.projectId }}) as project_name,\\n  (SELECT main_keyword FROM keyword_projects WHERE id = {{ $json.projectId }}) as main_keyword,\\n  (SELECT target_country FROM keyword_projects WHERE id = {{ $json.projectId }}) as target_country,\\n  (SELECT target_language FROM keyword_projects WHERE id = {{ $json.projectId }}) as target_language,\\n  (SELECT client_id FROM keyword_projects WHERE id = {{ $json.projectId }}) as client_id","options":{}},"id":"ca3f9907-6cb8-47a4-8c20-89d68f657572","name":"MySQL - Check Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1600,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Check if project exists\\nconst result = $input.first().json;\\nconst validatedData = $('Code - Validate Input').first().json;\\n\\nif (!result.project_id) {\\n  return [{\\n    json: {\\n      projectExists: false,\\n      projectId: validatedData.projectId\\n    }\\n  }];\\n}\\n\\nreturn [{\\n  json: {\\n    projectExists: true,\\n    projectId: result.project_id,\\n    projectName: result.project_name,\\n    mainKeyword: result.main_keyword,\\n    targetCountry: result.target_country || 'tr',\\n    targetLanguage: result.target_language || 'tr',\\n    clientId: result.client_id,\\n    competitorCount: validatedData.competitorCount\\n  }\\n}];"},"id":"a4aa5ed6-ea57-4a9d-b2bf-72ac3a8dc38e","name":"Code - Check Project","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1392,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"project-exists","leftValue":"={{ $json.projectExists }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"7499e34d-c041-4e92-9422-7a5cb4aed508","name":"IF - Project Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1168,208]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Project not found\\",\\n  \\"message\\": \\"Proje bulunamadi: {{ $json.projectId }}\\"\\n}","options":{"responseCode":404}},"id":"be6b076e-902e-42f4-8201-d173299dc8e2","name":"Respond - Not Found","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-944,400]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  COALESCE(cc.enable_ahrefs_api, 0) as enable_ahrefs_api,\\n  COALESCE(cc.enable_serper_api, 1) as enable_serper_api,\\n  COALESCE(cc.competitor_count, 10) as competitor_count\\nFROM clients c\\nLEFT JOIN client_configurations cc ON c.id = cc.client_id\\nWHERE c.id = {{ $json.clientId }}","options":{}},"id":"20c08b14-d745-40cc-9904-98c3ace62b05","name":"MySQL - Get Client Config","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-944,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Determine which API to use\\nconst config = $input.first().json;\\nconst projectData = $('IF - Project Exists').first().json;\\n\\n// Priority: Ahrefs > Serper > Mock\\nlet apiSource = 'mock';\\nif (config.enable_ahrefs_api === 1) {\\n  apiSource = 'ahrefs';\\n} else if (config.enable_serper_api === 1) {\\n  apiSource = 'serper';\\n}\\n\\nreturn [{\\n  json: {\\n    ...projectData,\\n    apiSource: apiSource,\\n    competitorCount: projectData.competitorCount || config.competitor_count || 10\\n  }\\n}];"},"id":"09c9510a-23ad-40c4-ba05-0900914d11c5","name":"Code - Determine API Source","type":"n8n-nodes-base.code","typeVersion":2,"position":[-720,208]},{"parameters":{"operation":"executeQuery","query":"=UPDATE keyword_projects SET status = 'processing' WHERE id = {{ $json.projectId }}","options":{}},"id":"73017083-c5d8-4a09-bd6b-305a477c0b5e","name":"MySQL - Update Status","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-512,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $json.apiSource }}","rightValue":"ahrefs","operator":{"type":"string","operation":"equals"},"id":"0a75c2c1-b101-4b8b-b03f-c6d2cfc8fdf1"}],"combinator":"and"},"renameOutput":true,"outputKey":"Ahrefs"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $json.apiSource }}","rightValue":"serper","operator":{"type":"string","operation":"equals"},"id":"38e8a40a-2671-40db-8f5b-5659d5c3aaaf"}],"combinator":"and"},"renameOutput":true,"outputKey":"Serper"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $json.apiSource }}","rightValue":"mock","operator":{"type":"string","operation":"equals"},"id":"e82ba37f-d3c2-45b8-a4c0-032e1bc6e13d"}],"combinator":"and"},"renameOutput":true,"outputKey":"Mock"}]},"options":{}},"id":"9ec60d6c-1cd9-4285-97b0-84bf8021bb4b","name":"Switch - API Source","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-288,208]},{"parameters":{"url":"https://api.ahrefs.com/v3/serp-overview/serp","sendQuery":true,"queryParameters":{"parameters":[{"name":"target","value":"={{ $('Code - Determine API Source').first().json.mainKeyword }}"},{"name":"country","value":"={{ $('Code - Determine API Source').first().json.targetCountry }}"},{"name":"limit","value":"={{ $('Code - Determine API Source').first().json.competitorCount }}"}]},"options":{}},"id":"356050ce-b078-4e2d-b794-348d72ad8da1","name":"HTTP - Ahrefs SERP","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,0],"continueOnFail":true},{"parameters":{"method":"POST","url":"https://google.serper.dev/search","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\"q\\": \\"{{ $json.mainKeyword }}\\", \\"gl\\": \\"{{ $json.targetCountry }}\\", \\"hl\\": \\"{{ $json.targetLanguage }}\\", \\"num\\": {{ $json.competitorCount }}}","options":{}},"id":"eb591b0e-b5cb-4088-b210-87f57179eab7","name":"HTTP - Serper SERP","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,208],"credentials":{"httpHeaderAuth":{"id":"01zZGrP0Fob8kD8r","name":"Serper API"}},"continueOnFail":true},{"parameters":{"jsCode":"// Generate mock SERP data for testing\\nconst projectData = $('Code - Determine API Source').first().json;\\nconst keyword = projectData.mainKeyword || 'test keyword';\\nconst count = projectData.competitorCount || 10;\\n\\nconst mockResults = [];\\nfor (let i = 1; i <= count; i++) {\\n  mockResults.push({\\n    position: i,\\n    url: `https://example${i}.com/${keyword.replace(/\\\\s+/g, '-')}`,\\n    domain: `example${i}.com`,\\n    title: `${keyword} - Ornek Baslik ${i}`,\\n    description: `${keyword} hakkinda detayli bilgi. Ornek aciklama ${i}.`,\\n    source: 'mock'\\n  });\\n}\\n\\nreturn [{ json: { organic: mockResults, source: 'mock' } }];"},"id":"96241def-a36b-48fd-b0e9-8819dfb21180","name":"Code - Mock SERP","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,400]},{"parameters":{"jsCode":"// Transform Ahrefs response to standard format\\nconst response = $input.first().json;\\nconst projectData = $('Code - Determine API Source').first().json;\\n\\n// Handle error\\nif (response.error || !response.serp) {\\n  return [{ json: { organic: [], source: 'ahrefs', error: response.error || 'No data' } }];\\n}\\n\\nconst positions = response.serp?.positions || response.positions || [];\\nconst organic = positions.map((pos, idx) => ({\\n  position: pos.position || idx + 1,\\n  url: pos.url || '',\\n  domain: pos.domain || '',\\n  title: pos.title || '',\\n  description: pos.description || '',\\n  domainRating: pos.domain_rating || pos.dr || null,\\n  backlinks: pos.backlinks || null,\\n  source: 'ahrefs'\\n}));\\n\\nreturn [{ json: { organic, source: 'ahrefs' } }];"},"id":"bbabc5fb-0a8e-4bbf-ae60-5da22650db43","name":"Code - Transform Ahrefs","type":"n8n-nodes-base.code","typeVersion":2,"position":[208,0]},{"parameters":{"jsCode":"// Transform Serper response to standard format\\nconst response = $input.first().json;\\n\\n// Handle error\\nif (response.error || !response.organic) {\\n  return [{ json: { organic: [], source: 'serper', error: response.error || 'No data' } }];\\n}\\n\\n// Extract domain from URL using regex\\nconst getDomain = (url) => {\\n  if (!url) return '';\\n  const match = url.match(/^https?[:][\\\\/][\\\\/]([^\\\\/]+)/);\\n  return match ? match[1] : '';\\n};\\n\\nconst organic = (response.organic || []).map((item, idx) => ({\\n  position: item.position || idx + 1,\\n  url: item.link || '',\\n  domain: getDomain(item.link),\\n  title: item.title || '',\\n  description: item.snippet || '',\\n  source: 'serper'\\n}));\\n\\nreturn [{ json: { organic, source: 'serper' } }];"},"id":"44e6dc34-a432-4ada-b257-55f29c9e6b34","name":"Code - Transform Serper","type":"n8n-nodes-base.code","typeVersion":2,"position":[208,208]},{"parameters":{"mode":"combine","options":{}},"id":"be24ee49-2cf5-4331-bdf9-2ffc32c46c93","name":"Merge Results","type":"n8n-nodes-base.merge","typeVersion":3,"position":[432,208]},{"parameters":{"jsCode":"// Process results and prepare for database insert\\nconst serpData = $input.first().json;\\nconst projectData = $('Code - Determine API Source').first().json;\\n\\nif (!serpData || !serpData.organic || serpData.organic.length === 0) {\\n  return [{\\n    json: {\\n      success: false,\\n      error: 'No SERP data received',\\n      projectId: projectData.projectId,\\n      source: serpData?.source || 'none'\\n    }\\n  }];\\n}\\n\\n// Return each competitor as separate item for batch insert\\nconst competitors = serpData.organic.map(comp => ({\\n  json: {\\n    projectId: projectData.projectId,\\n    position: comp.position,\\n    url: comp.url,\\n    domain: comp.domain,\\n    title: (comp.title || '').substring(0, 500),\\n    description: (comp.description || '').substring(0, 1000),\\n    domainRating: comp.domainRating || null,\\n    backlinks: comp.backlinks || null,\\n    source: serpData.source\\n  }\\n}));\\n\\nreturn competitors;"},"id":"4e2e7d05-732b-412f-8f67-b45863c53a8f","name":"Code - Process Results","type":"n8n-nodes-base.code","typeVersion":2,"position":[656,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-data","leftValue":"={{ $json.url }}","rightValue":"","operator":{"type":"string","operation":"notEmpty"}}],"combinator":"and"},"options":{}},"id":"90bd237a-73db-4de3-9c1a-0a84f0f53603","name":"IF - Has Data","type":"n8n-nodes-base.if","typeVersion":2,"position":[880,208]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO competitor_data (project_id, competitor_url, competitor_domain, serp_position, title, meta_description, domain_rating, backlinks_count, source)\\nVALUES (\\n  {{ $json.projectId }},\\n  '{{ $json.url.replace(/'/g, \\"''\\") }}',\\n  '{{ $json.domain.replace(/'/g, \\"''\\") }}',\\n  {{ $json.position }},\\n  '{{ $json.title.replace(/'/g, \\"''\\") }}',\\n  '{{ $json.description.replace(/'/g, \\"''\\") }}',\\n  {{ $json.domainRating || 'NULL' }},\\n  {{ $json.backlinks || 'NULL' }},\\n  '{{ $json.source }}'\\n)\\nON DUPLICATE KEY UPDATE\\n  serp_position = VALUES(serp_position),\\n  title = VALUES(title),\\n  meta_description = VALUES(meta_description)","options":{}},"id":"2880ce94-eefb-48ac-afd2-1a4c68ef9631","name":"MySQL - Insert Competitor","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1104,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=UPDATE keyword_projects \\nSET \\n  status = 'competitors_analyzed',\\n  total_competitors_analyzed = (SELECT COUNT(*) FROM competitor_data WHERE project_id = {{ $('Code - Determine API Source').first().json.projectId }}),\\n  updated_at = NOW()\\nWHERE id = {{ $('Code - Determine API Source').first().json.projectId }}","options":{}},"id":"3972cc13-e556-4973-aee0-b0c2e139b05d","name":"MySQL - Update Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1328,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Prepare success response\\nconst projectData = $('Code - Determine API Source').first().json;\\nconst insertedItems = $('MySQL - Insert Competitor').all();\\n\\nreturn [{\\n  json: {\\n    success: true,\\n    data: {\\n      projectId: projectData.projectId,\\n      projectName: projectData.projectName,\\n      mainKeyword: projectData.mainKeyword,\\n      competitorsAnalyzed: insertedItems.length,\\n      source: projectData.apiSource,\\n      status: 'competitors_analyzed'\\n    },\\n    message: `${insertedItems.length} rakip basariyla analiz edildi`\\n  }\\n}];"},"id":"ee4a67d4-261c-43e7-be27-53d68914c3d1","name":"Code - Prepare Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1536,208]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"e9fd7ed6-f79a-45bc-92fb-49b152869685","name":"Respond - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1760,208]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"No SERP data\\",\\n  \\"message\\": \\"{{ $json.error || 'Hicbir kaynaktan SERP verisi alinamadi' }}\\"\\n}","options":{"responseCode":500}},"id":"00986c11-3b28-4d31-9781-17425992f136","name":"Respond - No Data","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1104,400]}]	{"Webhook":{"main":[[{"node":"Code - Validate Input","type":"main","index":0}]]},"Code - Validate Input":{"main":[[{"node":"IF - Valid Input","type":"main","index":0}]]},"IF - Valid Input":{"main":[[{"node":"MySQL - Check Project","type":"main","index":0}],[{"node":"Respond - Validation Error","type":"main","index":0}]]},"MySQL - Check Project":{"main":[[{"node":"Code - Check Project","type":"main","index":0}]]},"Code - Check Project":{"main":[[{"node":"IF - Project Exists","type":"main","index":0}]]},"IF - Project Exists":{"main":[[{"node":"MySQL - Get Client Config","type":"main","index":0}],[{"node":"Respond - Not Found","type":"main","index":0}]]},"MySQL - Get Client Config":{"main":[[{"node":"Code - Determine API Source","type":"main","index":0}]]},"Code - Determine API Source":{"main":[[{"node":"Switch - API Source","type":"main","index":0}]]},"Switch - API Source":{"main":[[{"node":"HTTP - Ahrefs SERP","type":"main","index":0}],[{"node":"HTTP - Serper SERP","type":"main","index":0}],[{"node":"Code - Mock SERP","type":"main","index":0}]]},"HTTP - Ahrefs SERP":{"main":[[{"node":"Code - Transform Ahrefs","type":"main","index":0}]]},"HTTP - Serper SERP":{"main":[[{"node":"Code - Transform Serper","type":"main","index":0}]]},"Code - Transform Ahrefs":{"main":[[{"node":"Code - Process Results","type":"main","index":0}]]},"Code - Transform Serper":{"main":[[{"node":"Code - Process Results","type":"main","index":0}]]},"Code - Mock SERP":{"main":[[{"node":"Code - Process Results","type":"main","index":0}]]},"Code - Process Results":{"main":[[{"node":"IF - Has Data","type":"main","index":0}]]},"IF - Has Data":{"main":[[{"node":"MySQL - Insert Competitor","type":"main","index":0}],[{"node":"Respond - No Data","type":"main","index":0}]]},"MySQL - Insert Competitor":{"main":[[{"node":"MySQL - Update Project","type":"main","index":0}]]},"MySQL - Update Project":{"main":[[{"node":"Code - Prepare Response","type":"main","index":0}]]},"Code - Prepare Response":{"main":[[{"node":"Respond - Success","type":"main","index":0}]]}}	Version 4117e47b	f	
e446236e-cc11-4f88-9622-af72007ff710	r8uQ8T48G7SDp9or	Fatih Berkay Baheci	2025-12-17 10:27:36.026+00	2025-12-17 10:27:37.312+00	[{"parameters":{"path":":projectId/keywords","responseMode":"responseNode","options":{}},"id":"faafc4d6-51f2-4c06-bcf3-dd1d97829f4c","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"tool1-get-keywords"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Input validation - supports both numeric ID and UUID\\nconst projectId = $json.params?.projectId;\\n\\nif (!projectId) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'project_id parametresi zorunludur',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\n// Check if it's a valid UUID format\\nconst uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\\nconst isUuid = uuidRegex.test(projectId);\\n\\n// Check if it's a valid numeric ID\\nconst parsedId = parseInt(projectId);\\nconst isNumericId = !isNaN(parsedId) && parsedId > 0;\\n\\nif (!isUuid && !isNumericId) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'project_id gecerli bir sayi veya UUID olmalidir',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nconst query = $json.query || {};\\nconst limit = Math.min(Math.max(parseInt(query.limit) || 100, 1), 500);\\nconst offset = Math.max(parseInt(query.offset) || 0, 0);\\n\\nreturn {\\n  json: {\\n    isValid: true,\\n    projectId: isUuid ? projectId : parsedId,\\n    isUuid: isUuid,\\n    limit: limit,\\n    offset: offset\\n  }\\n};"},"id":"6e6b10f1-aad4-47f7-be5e-57503a0fcf65","name":"Code - Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"109e698e-93a6-4bc2-afaa-99386c0241fb","name":"IF - Valid Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,0]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Validation failed\\",\\n  \\"message\\": \\"{{ $json.error }}\\"\\n}","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"5c09e9fd-1270-4b7f-bc70-0dd24e722cec","name":"Respond - Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,160]},{"parameters":{"operation":"executeQuery","query":"=SELECT id as project_id, project_name, main_keyword, status FROM keyword_projects WHERE {{ $json.isUuid ? \\"uuid = '\\" + $json.projectId + \\"'\\" : \\"id = \\" + $json.projectId }}","options":{}},"id":"4f1577da-8132-462d-9713-6f60616ec826","name":"MySQL - Check Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Check if project exists\\nconst result = $input.first().json;\\nconst validatedData = $('Code - Validate Input').first().json;\\n\\nif (!result.project_id) {\\n  return [{\\n    json: {\\n      projectExists: false,\\n      projectId: validatedData.projectId\\n    }\\n  }];\\n}\\n\\n// Use the actual numeric project_id from DB (important when UUID was used)\\nreturn [{\\n  json: {\\n    projectExists: true,\\n    projectId: result.project_id,\\n    projectName: result.project_name,\\n    mainKeyword: result.main_keyword,\\n    status: result.status,\\n    limit: validatedData.limit,\\n    offset: validatedData.offset\\n  }\\n}];"},"id":"06f9fe43-c7cf-4f1b-9679-43c85b83d003","name":"Code - Check Project","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,0]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"project-exists","leftValue":"={{ $json.projectExists }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"96537062-2449-4836-a73f-5ad1f1083848","name":"IF - Project Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[1104,0]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Project not found\\",\\n  \\"message\\": \\"Proje bulunamadi: {{ $json.projectId }}\\"\\n}","options":{"responseCode":404}},"id":"e3eb5050-661a-4b16-925f-392c541b7f4a","name":"Respond - Project Not Found","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1328,160]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  kr.id,\\n  kr.keyword,\\n  kr.keyword_type,\\n  kr.search_volume,\\n  kr.keyword_difficulty,\\n  kr.cpc,\\n  kr.competition,\\n  kr.search_intent,\\n  kr.trend_direction,\\n  kr.parent_topic,\\n  kr.keyword_cluster,\\n  kr.opportunity_score,\\n  kr.source,\\n  kr.created_at\\nFROM keyword_results kr\\nWHERE kr.project_id = {{ $json.projectId }}\\nORDER BY \\n  CASE WHEN kr.opportunity_score IS NOT NULL THEN 0 ELSE 1 END,\\n  kr.opportunity_score DESC,\\n  kr.search_volume DESC\\nLIMIT {{ $json.limit }}\\nOFFSET {{ $json.offset }}","options":{}},"id":"9a7dae16-d6b7-41d9-a6b9-bf16268e1d95","name":"MySQL - Get Keywords","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1328,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  COUNT(*) as total_count,\\n  COALESCE(AVG(search_volume), 0) as avg_volume,\\n  COALESCE(AVG(keyword_difficulty), 0) as avg_difficulty,\\n  COALESCE(AVG(opportunity_score), 0) as avg_opportunity,\\n  SUM(CASE WHEN search_intent IS NOT NULL THEN 1 ELSE 0 END) as with_intent\\nFROM keyword_results \\nWHERE project_id = {{ $('IF - Project Exists').item.json.projectId }}","options":{}},"id":"7a452111-e93d-40ad-b7a6-503e6866331e","name":"MySQL - Get Stats","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1552,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Aggregate results\\nconst keywordItems = $('MySQL - Get Keywords').all();\\nconst statsResult = $input.first().json;\\nconst projectData = $('IF - Project Exists').first().json;\\n\\n// Check if keywords exist\\nconst hasKeywords = keywordItems.length > 0 && !!keywordItems[0].json.id;\\nconst keywords = hasKeywords ? keywordItems.map(i => i.json) : [];\\n\\n// Group by type\\nconst byType = {};\\nkeywords.forEach(kw => {\\n  const type = kw.keyword_type || 'unknown';\\n  if (!byType[type]) byType[type] = 0;\\n  byType[type]++;\\n});\\n\\n// Group by cluster\\nconst byCluster = {};\\nkeywords.forEach(kw => {\\n  if (kw.keyword_cluster) {\\n    if (!byCluster[kw.keyword_cluster]) byCluster[kw.keyword_cluster] = 0;\\n    byCluster[kw.keyword_cluster]++;\\n  }\\n});\\n\\n// Group by intent\\nconst byIntent = {};\\nkeywords.forEach(kw => {\\n  if (kw.search_intent) {\\n    if (!byIntent[kw.search_intent]) byIntent[kw.search_intent] = 0;\\n    byIntent[kw.search_intent]++;\\n  }\\n});\\n\\nreturn [{\\n  json: {\\n    success: true,\\n    project: {\\n      id: projectData.projectId,\\n      name: projectData.projectName,\\n      main_keyword: projectData.mainKeyword,\\n      status: projectData.status\\n    },\\n    data: keywords,\\n    stats: {\\n      total: parseInt(statsResult.total_count) || 0,\\n      filtered_count: keywords.length,\\n      with_intent: parseInt(statsResult.with_intent) || 0,\\n      avg_volume: Math.round(parseFloat(statsResult.avg_volume) || 0),\\n      avg_difficulty: Math.round(parseFloat(statsResult.avg_difficulty) || 0),\\n      avg_opportunity: Math.round(parseFloat(statsResult.avg_opportunity) || 0)\\n    },\\n    by_type: byType,\\n    by_cluster: byCluster,\\n    by_intent: byIntent,\\n    pagination: {\\n      limit: projectData.limit,\\n      offset: projectData.offset,\\n      returned: keywords.length,\\n      has_more: keywords.length === projectData.limit\\n    }\\n  }\\n}];"},"id":"fc5ca91c-5ad6-42ab-ac5a-93fa3032fd6f","name":"Code - Aggregate","type":"n8n-nodes-base.code","typeVersion":2,"position":[1760,0]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"50273772-4471-4b73-a6b1-7914bd1a2f7e","name":"Respond - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1984,0]}]	{"Webhook":{"main":[[{"node":"Code - Validate Input","type":"main","index":0}]]},"Code - Validate Input":{"main":[[{"node":"IF - Valid Input","type":"main","index":0}]]},"IF - Valid Input":{"main":[[{"node":"MySQL - Check Project","type":"main","index":0}],[{"node":"Respond - Validation Error","type":"main","index":0}]]},"MySQL - Check Project":{"main":[[{"node":"Code - Check Project","type":"main","index":0}]]},"Code - Check Project":{"main":[[{"node":"IF - Project Exists","type":"main","index":0}]]},"IF - Project Exists":{"main":[[{"node":"MySQL - Get Keywords","type":"main","index":0}],[{"node":"Respond - Project Not Found","type":"main","index":0}]]},"MySQL - Get Keywords":{"main":[[{"node":"MySQL - Get Stats","type":"main","index":0}]]},"MySQL - Get Stats":{"main":[[{"node":"Code - Aggregate","type":"main","index":0}]]},"Code - Aggregate":{"main":[[{"node":"Respond - Success","type":"main","index":0}]]}}	Version e446236e	f	
d427d382-3336-4aa9-9b50-d3f795ad77ad	9wxzOy1QgENPVVSD	Fatih Berkay Baheci	2025-12-17 10:28:04.071+00	2025-12-17 10:28:05.942+00	[{"parameters":{"path":"tool1/projects","responseMode":"responseNode","options":{}},"id":"9a0ebdf9-08be-4785-810f-ce71fe62b460","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"tool1-projects-list"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Input validation and sanitization\\nconst query = $json.query || {};\\n\\n// Validate and sanitize limit\\nlet limit = parseInt(query.limit) || 50;\\nlimit = Math.min(Math.max(limit, 1), 100); // 1-100 aras\\n\\n// Validate and sanitize offset\\nlet offset = parseInt(query.offset) || 0;\\noffset = Math.max(offset, 0);\\n\\n// Validate client_id if provided\\nlet clientId = null;\\nlet filterByClient = false;\\nif (query.client_id) {\\n  const parsedClientId = parseInt(query.client_id);\\n  if (isNaN(parsedClientId) || parsedClientId <= 0) {\\n    return {\\n      json: {\\n        isValid: false,\\n        error: 'client_id gecerli bir pozitif sayi olmalidir',\\n        errorCode: 400\\n      }\\n    };\\n  }\\n  clientId = parsedClientId;\\n  filterByClient = true;\\n}\\n\\n// Validate status filter if provided\\nconst validStatuses = ['pending', 'discovering', 'discovered', 'filtering', 'keywords_filtered', 'completed', 'failed'];\\nlet status = null;\\nlet filterByStatus = false;\\nif (query.status) {\\n  if (!validStatuses.includes(query.status)) {\\n    return {\\n      json: {\\n        isValid: false,\\n        error: 'Gecersiz status. Gecerli degerler: ' + validStatuses.join(', '),\\n        errorCode: 400\\n      }\\n    };\\n  }\\n  status = query.status;\\n  filterByStatus = true;\\n}\\n\\nreturn {\\n  json: {\\n    isValid: true,\\n    limit: limit,\\n    offset: offset,\\n    clientId: clientId,\\n    filterByClient: filterByClient,\\n    status: status,\\n    filterByStatus: filterByStatus\\n  }\\n};"},"id":"6a193953-11cd-48d7-a7eb-2c14a17013ee","name":"Code - Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"e4ac4e86-402a-471a-bdca-18217be685cc","name":"IF - Valid Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,0]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Validation failed\\",\\n  \\"message\\": \\"{{ $json.error }}\\"\\n}","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"432f90d9-d69c-4712-9dab-5c7bf574b935","name":"Respond - Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,160]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  kp.id,\\n  kp.uuid,\\n  kp.project_name,\\n  kp.main_keyword,\\n  kp.scenario_type,\\n  kp.target_country,\\n  kp.target_language,\\n  kp.status,\\n  kp.created_at,\\n  kp.updated_at,\\n  c.id as client_id,\\n  c.name as client_name,\\n  (SELECT COUNT(*) FROM keyword_results WHERE project_id = kp.id) as keyword_count\\nFROM keyword_projects kp\\nLEFT JOIN clients c ON kp.client_id = c.id\\nWHERE 1=1\\n{{ $json.filterByClient ? ' AND kp.client_id = ' + $json.clientId : '' }}\\n{{ $json.filterByStatus ? \\" AND kp.status = '\\" + $json.status + \\"'\\" : '' }}\\nORDER BY kp.created_at DESC\\nLIMIT {{ $json.limit }}\\nOFFSET {{ $json.offset }}","options":{}},"id":"b17d0631-ce45-47ce-8d0c-25fcb2309aac","name":"MySQL - List Projects","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT COUNT(*) as total \\nFROM keyword_projects kp\\nWHERE 1=1\\n{{ $('Code - Validate Input').first().json.filterByClient ? ' AND kp.client_id = ' + $('Code - Validate Input').first().json.clientId : '' }}\\n{{ $('Code - Validate Input').first().json.filterByStatus ? \\" AND kp.status = '\\" + $('Code - Validate Input').first().json.status + \\"'\\" : '' }}","options":{}},"id":"5c7d433b-d6d6-47e3-9735-32efa67350a0","name":"MySQL - Count Total","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[880,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Format response\\nconst projectItems = $('MySQL - List Projects').all();\\nconst countResult = $input.first().json;\\nconst validatedData = $('Code - Validate Input').first().json;\\n\\n// Check if we have actual projects\\nconst hasProjects = projectItems.length > 0 && !!projectItems[0].json.id;\\nconst projects = hasProjects ? projectItems.map(item => {\\n  const p = item.json;\\n  return {\\n    id: p.id,\\n    uuid: p.uuid,\\n    project_name: p.project_name,\\n    main_keyword: p.main_keyword,\\n    scenario_type: p.scenario_type,\\n    target_country: p.target_country,\\n    target_language: p.target_language,\\n    status: p.status,\\n    created_at: p.created_at,\\n    updated_at: p.updated_at,\\n    client: p.client_id ? {\\n      id: p.client_id,\\n      name: p.client_name\\n    } : null,\\n    keyword_count: parseInt(p.keyword_count) || 0\\n  };\\n}) : [];\\n\\nconst total = parseInt(countResult.total) || 0;\\n\\nreturn [{\\n  json: {\\n    success: true,\\n    data: projects,\\n    pagination: {\\n      total: total,\\n      limit: validatedData.limit,\\n      offset: validatedData.offset,\\n      returned: projects.length,\\n      has_more: (validatedData.offset + projects.length) < total\\n    },\\n    filters: {\\n      client_id: validatedData.clientId,\\n      status: validatedData.status\\n    }\\n  }\\n}];"},"id":"4af3fedb-5a05-475c-a3d4-c65a8c0d1526","name":"Code - Format Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,0]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"6c4e14db-61fc-4060-8e7f-0f6c2ee6a150","name":"Respond - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1328,0]}]	{"Webhook":{"main":[[{"node":"Code - Validate Input","type":"main","index":0}]]},"Code - Validate Input":{"main":[[{"node":"IF - Valid Input","type":"main","index":0}]]},"IF - Valid Input":{"main":[[{"node":"MySQL - List Projects","type":"main","index":0}],[{"node":"Respond - Validation Error","type":"main","index":0}]]},"MySQL - List Projects":{"main":[[{"node":"MySQL - Count Total","type":"main","index":0}]]},"MySQL - Count Total":{"main":[[{"node":"Code - Format Response","type":"main","index":0}]]},"Code - Format Response":{"main":[[{"node":"Respond - Success","type":"main","index":0}]]}}	Version d427d382	f	
9c8edff5-626a-40e8-8897-5867882e1542	oCR2cQcwwClAsT55	Fatih Berkay Baheci	2025-12-17 10:28:51.007+00	2025-12-17 10:28:52.317+00	[{"parameters":{"httpMethod":"POST","path":":projectId/analyze","responseMode":"responseNode","options":{}},"id":"456885fd-6b70-4ff2-acfe-c077168f67b0","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3088,112],"webhookId":"tool1-content-gap"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Input validation\\nconst projectId = $json.params?.projectId;\\n\\nif (!projectId) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'projectId parametresi zorunludur',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nconst parsedId = parseInt(projectId);\\nif (isNaN(parsedId) || parsedId <= 0) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'projectId gecerli bir pozitif sayi olmalidir',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nreturn {\\n  json: {\\n    isValid: true,\\n    projectId: parsedId\\n  }\\n};"},"id":"2d87a9bb-ba19-4804-882d-254aaf614bf8","name":"Code - Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2864,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"b89a68a3-c5f2-4886-aab5-6dd9f3b6b4f8","name":"IF - Valid Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[-2640,112]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Validation failed\\",\\n  \\"message\\": \\"{{ $json.error }}\\"\\n}","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"9a885178-253e-4728-9000-401d9c9cc5e1","name":"Respond - Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-2416,304]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  kp.id as project_id,\\n  kp.client_id,\\n  kp.main_keyword,\\n  kp.target_language,\\n  kp.target_country,\\n  kp.scenario_type,\\n  c.domain as client_domain,\\n  cc.ai_model_preference as client_ai_model,\\n  cc.ai_temperature as client_ai_temperature\\nFROM keyword_projects kp\\nJOIN clients c ON c.id = kp.client_id\\nLEFT JOIN client_configurations cc ON cc.client_id = kp.client_id\\nWHERE kp.id = {{ $json.projectId }}\\nLIMIT 1","options":{}},"id":"4b44dda9-b174-42f7-b574-f46645ccd45e","name":"MySQL - Get Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-2416,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"project-exists","leftValue":"={{ $json.project_id }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"id":"0d82a65c-4b47-4c00-9eda-2cd2b8ed4882","name":"IF - Project Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-2208,112]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Project not found\\",\\n  \\"message\\": \\"Proje bulunamadi: {{ $('Code - Validate Input').first().json.projectId }}\\"\\n}","options":{"responseCode":404}},"id":"e0389edb-4bde-463f-8069-3ac27347a91b","name":"Respond - Not Found","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-1984,304]},{"parameters":{"operation":"executeQuery","query":"SELECT setting_key, setting_value FROM system_settings WHERE setting_key IN ('default_ai_model', 'default_ai_temperature')","options":{}},"id":"e4d0adb7-b6c0-4825-8bea-f25fb3f787ce","name":"MySQL - Get System Settings","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1984,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"SELECT prompt_text FROM system_prompts WHERE slug = 'content-gap-analyzer' AND is_active = 1 LIMIT 1","options":{}},"id":"af2103b0-09ff-4e69-88c0-c3a4c91403a7","name":"MySQL - Get System Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1760,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT competitor_domain, competitor_url, title, COALESCE(word_count, 0) as word_count, headings_json, COALESCE(domain_rating, 0) as domain_rating FROM competitor_data WHERE project_id = {{ $('MySQL - Get Project').first().json.project_id }} ORDER BY serp_position ASC LIMIT 5","options":{}},"id":"b671df11-ccf1-4146-b275-fdfa9cd3a335","name":"MySQL - Get Competitors","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1536,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT has_featured_snippet, featured_snippet_type, featured_snippet_content, has_paa, paa_count, has_video_results, has_image_pack, has_local_pack, has_knowledge_panel, zero_click_risk FROM serp_features WHERE project_id = {{ $('MySQL - Get Project').first().json.project_id }} UNION ALL SELECT 0,NULL,NULL,0,0,0,0,0,0,NULL FROM dual WHERE NOT EXISTS (SELECT 1 FROM serp_features WHERE project_id = {{ $('MySQL - Get Project').first().json.project_id }}) LIMIT 1","options":{}},"id":"4eee0b6c-4038-4d51-8d9b-00247e2a0bca","name":"MySQL - Get SERP Features","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1328,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT question, answer_snippet FROM paa_data WHERE project_id = {{ $('MySQL - Get Project').first().json.project_id }} UNION ALL SELECT NULL as question, NULL as answer_snippet FROM dual WHERE NOT EXISTS (SELECT 1 FROM paa_data WHERE project_id = {{ $('MySQL - Get Project').first().json.project_id }}) LIMIT 10","options":{}},"id":"c1e1484c-0a0c-4b45-ac2e-5b848ad1e588","name":"MySQL - Get PAA","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1104,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Prepare AI prompt - COMPACT CSV FORMAT\\nconst project = $('MySQL - Get Project').first().json;\\nconst systemSettingsItems = $('MySQL - Get System Settings').all();\\nconst systemPromptResult = $('MySQL - Get System Prompt').first().json;\\nconst competitorItems = $('MySQL - Get Competitors').all();\\nconst competitors = competitorItems.filter(i => i.json.competitor_domain).map(i => i.json);\\n\\n// System settings\\nconst systemSettings = {};\\nsystemSettingsItems.forEach(item => {\\n  systemSettings[item.json.setting_key] = item.json.setting_value;\\n});\\n\\n// Model selection\\nconst clientModel = project.client_ai_model;\\nconst systemDefaultModel = systemSettings.default_ai_model || 'gemini-2.0-flash';\\nconst primaryModel = clientModel || systemDefaultModel;\\nlet fallbackModel = null;\\nif (clientModel && systemDefaultModel && clientModel !== systemDefaultModel) {\\n  fallbackModel = systemDefaultModel;\\n}\\nconst temperature = parseFloat(project.client_ai_temperature) || parseFloat(systemSettings.default_ai_temperature) || 0.7;\\n\\n// COMPACT CSV format for competitors: domain|dr|words\\nconst competitorCsv = competitors.map((c, i) => \\n  `${c.competitor_domain}|${i+1}|${c.domain_rating || 0}|${c.word_count || 0}`\\n).join('\\\\n');\\n\\n// System prompt template\\nlet systemPromptTemplate = systemPromptResult?.prompt_text || '';\\n\\n// Replace template variables\\nlet finalPrompt = systemPromptTemplate\\n  .replace(/\\\\{\\\\{main_keyword\\\\}\\\\}/g, project.main_keyword || '')\\n  .replace(/\\\\{\\\\{target_country\\\\}\\\\}/g, project.target_country || 'TR')\\n  .replace(/\\\\{\\\\{competitor_csv\\\\}\\\\}/g, competitorCsv);\\n\\n// Fallback prompt if no system prompt\\nif (!systemPromptTemplate) {\\n  finalPrompt = `Content gap analizi. Konu: ${project.main_keyword} | Ulke: ${project.target_country}\\\\nRAKIPLER (domain|pos|dr|words):\\\\n${competitorCsv}\\\\nCIKTI (sadece CSV, baslik yok):\\\\nkeyword|type|intent|score|format`;\\n}\\n\\nreturn [{\\n  json: {\\n    project_id: project.project_id,\\n    client_id: project.client_id,\\n    main_keyword: project.main_keyword,\\n    primary_model: primaryModel,\\n    fallback_model: fallbackModel,\\n    temperature: temperature,\\n    prompt: finalPrompt,\\n    competitor_count: competitors.length,\\n    has_system_prompt: !!systemPromptTemplate\\n  }\\n}];"},"id":"3bd6d0d1-f6f8-45f4-8673-f0e73321e61b","name":"Code - Prepare AI Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[-880,112]},{"parameters":{"jsCode":"// AI API calls - COMPACT CSV OUTPUT: keyword|type|intent|score|format + TOKEN TRACKING\\nconst data = $input.first().json;\\nconst primaryModel = data.primary_model;\\nconst fallbackModel = data.fallback_model;\\nconst temperature = data.temperature;\\nconst prompt = data.prompt;\\n\\nconst GEMINI_API_KEY = $env.GEMINI_API_KEY || '';\\nconst OPENAI_API_KEY = $env.OPENAI_API_KEY || '';\\n\\nlet tokenUsage = { input: 0, output: 0, model: '', provider: 'none' };\\nlet responseTime = 0;\\n\\n// Gemini API call\\nconst callGemini = async (promptText) => {\\n  const startTime = Date.now();\\n  try {\\n    const response = await this.helpers.httpRequest({\\n      method: 'POST',\\n      url: `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,\\n      body: {\\n        contents: [{ parts: [{ text: promptText }] }],\\n        generationConfig: { temperature: temperature, maxOutputTokens: 2048 }\\n      },\\n      headers: { 'Content-Type': 'application/json' },\\n      timeout: 60000\\n    });\\n    const elapsed = Date.now() - startTime;\\n    if (response.candidates && response.candidates.length > 0) {\\n      const usage = response.usageMetadata || {};\\n      return { success: true, content: response.candidates[0].content.parts[0].text, source: 'gemini', tokens: { input: usage.promptTokenCount || 0, output: usage.candidatesTokenCount || 0 }, model: 'gemini-2.0-flash', elapsed: elapsed };\\n    }\\n    return { success: false, error: 'No candidates', elapsed: elapsed };\\n  } catch (e) {\\n    return { success: false, error: e.message, elapsed: Date.now() - startTime };\\n  }\\n};\\n\\n// OpenAI API call\\nconst callOpenAI = async (promptText) => {\\n  const startTime = Date.now();\\n  try {\\n    const response = await this.helpers.httpRequest({\\n      method: 'POST',\\n      url: 'https://api.openai.com/v1/chat/completions',\\n      body: { model: 'gpt-4o-mini', messages: [{ role: 'user', content: promptText }], temperature: temperature, max_tokens: 2048 },\\n      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${OPENAI_API_KEY}` },\\n      timeout: 60000\\n    });\\n    const elapsed = Date.now() - startTime;\\n    if (response.choices && response.choices.length > 0) {\\n      const usage = response.usage || {};\\n      return { success: true, content: response.choices[0].message.content, source: 'openai', tokens: { input: usage.prompt_tokens || 0, output: usage.completion_tokens || 0 }, model: 'gpt-4o-mini', elapsed: elapsed };\\n    }\\n    return { success: false, error: 'No choices', elapsed: elapsed };\\n  } catch (e) {\\n    return { success: false, error: e.message, elapsed: Date.now() - startTime };\\n  }\\n};\\n\\nconst callModel = async (model, promptText) => {\\n  if (model && model.toLowerCase().includes('gemini')) return await callGemini(promptText);\\n  if (model && (model.toLowerCase().includes('openai') || model.toLowerCase().includes('gpt'))) return await callOpenAI(promptText);\\n  return { success: false, error: 'Unknown model: ' + model, elapsed: 0 };\\n};\\n\\n// Parse CSV response: keyword|type|intent|score|format\\nconst parseCSVResponse = (content) => {\\n  const csvContent = content.replace(/```[a-z]*\\\\n?/g, '').replace(/```/g, '').trim();\\n  const lines = csvContent.split('\\\\n').filter(l => l.trim() && !l.startsWith('keyword|'));\\n  const gaps = [];\\n  for (const line of lines) {\\n    const parts = line.split('|').map(p => p.trim());\\n    if (parts.length >= 5) {\\n      gaps.push({\\n        keyword: parts[0],\\n        keyword_type: parts[1] || 'related',\\n        search_intent: parts[2] || 'informational',\\n        opportunity_score: parseInt(parts[3]) || 50,\\n        content_format: parts[4] || 'blog'\\n      });\\n    }\\n  }\\n  return { content_gaps: gaps, analysis_summary: `${gaps.length} keyword onerisi olusturuldu.` };\\n};\\n\\n// Mock response\\nconst getMockResponse = (mainKeyword) => ({\\n  analysis_summary: `[MOCK] ${mainKeyword} icin 5 keyword onerisi.`,\\n  content_gaps: [\\n    { keyword: `${mainKeyword} nedir`, keyword_type: 'question', search_intent: 'informational', opportunity_score: 85, content_format: 'blog' },\\n    { keyword: `${mainKeyword} fiyatlari`, keyword_type: 'related', search_intent: 'commercial', opportunity_score: 78, content_format: 'comparison' },\\n    { keyword: `${mainKeyword} nasil yapilir`, keyword_type: 'question', search_intent: 'informational', opportunity_score: 82, content_format: 'guide' },\\n    { keyword: `en iyi ${mainKeyword}`, keyword_type: 'related', search_intent: 'commercial', opportunity_score: 75, content_format: 'comparison' },\\n    { keyword: `${mainKeyword} 2024`, keyword_type: 'related', search_intent: 'informational', opportunity_score: 88, content_format: 'blog' }\\n  ]\\n});\\n\\n// Main flow\\nlet result = null;\\nlet aiSource = 'mock';\\n\\nif (primaryModel) {\\n  const primaryResult = await callModel(primaryModel, prompt);\\n  responseTime = primaryResult.elapsed || 0;\\n  if (primaryResult.success) {\\n    result = parseCSVResponse(primaryResult.content);\\n    aiSource = primaryResult.source;\\n    tokenUsage = { input: primaryResult.tokens?.input || 0, output: primaryResult.tokens?.output || 0, model: primaryResult.model, provider: primaryResult.source };\\n  }\\n}\\n\\nif ((!result || !result.content_gaps || result.content_gaps.length === 0) && fallbackModel) {\\n  const fallbackResult = await callModel(fallbackModel, prompt);\\n  responseTime = fallbackResult.elapsed || 0;\\n  if (fallbackResult.success) {\\n    result = parseCSVResponse(fallbackResult.content);\\n    aiSource = fallbackResult.source + '-fallback';\\n    tokenUsage = { input: fallbackResult.tokens?.input || 0, output: fallbackResult.tokens?.output || 0, model: fallbackResult.model, provider: fallbackResult.source };\\n  }\\n}\\n\\nif (!result || !result.content_gaps || result.content_gaps.length === 0) {\\n  result = getMockResponse(data.main_keyword);\\n  aiSource = 'mock';\\n}\\n\\nreturn [{\\n  json: {\\n    project_id: data.project_id,\\n    client_id: data.client_id,\\n    main_keyword: data.main_keyword,\\n    content_gaps: result.content_gaps || [],\\n    analysis_summary: result.analysis_summary || '',\\n    ai_source: aiSource,\\n    token_usage: tokenUsage,\\n    response_time_ms: responseTime\\n  }\\n}];"},"id":"15595b98-9333-4194-ab7b-c6845bf77d2d","name":"Code - AI Analysis","type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,112]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO api_usage_tracking (client_id, tool_name, project_id, workflow_name, api_provider, model_name, tokens_input, tokens_output, requests_count, response_time_ms, was_successful) VALUES ({{ $json.client_id || 0 }}, 'tool1', {{ $json.project_id || 0 }}, 'WF-106-content-gap-finder', '{{ $json.token_usage?.provider === 'gemini' ? 'google' : $json.token_usage?.provider === 'openai' ? 'openai' : 'other' }}', '{{ $json.token_usage?.model || '' }}', {{ $json.token_usage?.input || 0 }}, {{ $json.token_usage?.output || 0 }}, 1, {{ $json.response_time_ms || 0 }}, {{ $json.ai_source !== 'mock' ? 1 : 0 }})","options":{}},"id":"88145cc9-c996-4688-a168-bf4746dc4e02","name":"MySQL - Log Token Usage","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-544,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Content gap keyword'lerini ayr ayr insert iin hazrla\\nconst data = $('Code - AI Analysis').first().json;\\nconst gaps = data.content_gaps || [];\\n\\nif (gaps.length === 0) {\\n  return [{ json: { skip: true, project_id: data.project_id, ai_source: data.ai_source, analysis_summary: data.analysis_summary } }];\\n}\\n\\nreturn gaps.map(gap => ({\\n  json: {\\n    project_id: data.project_id,\\n    keyword: gap.keyword,\\n    keyword_type: gap.keyword_type || 'related',\\n    search_intent: gap.search_intent || 'informational',\\n    opportunity_score: gap.opportunity_score || 50,\\n    content_format: gap.content_format || 'blog',\\n    reasoning: gap.reasoning || '',\\n    source: 'ai',\\n    ai_source: data.ai_source,\\n    analysis_summary: data.analysis_summary,\\n    pillar_suggestion: data.pillar_suggestion,\\n    cluster_suggestions: data.cluster_suggestions\\n  }\\n}));"},"id":"ead5c920-dd68-4b47-9240-54fdb9dee58f","name":"Code - Split Keywords","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-keywords","leftValue":"={{ $json.skip }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"fbdafd5e-7ede-4972-ad53-2644574fd8a9","name":"IF - Has Keywords","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO keyword_results \\n  (project_id, keyword, keyword_type, search_intent, opportunity_score, source)\\nVALUES \\n  ({{ $json.project_id }}, '{{ $json.keyword.replace(/'/g, \\"''\\") }}', '{{ $json.keyword_type }}', '{{ $json.search_intent }}', {{ $json.opportunity_score }}, '{{ $json.source }}')\\nON DUPLICATE KEY UPDATE\\n  opportunity_score = VALUES(opportunity_score),\\n  search_intent = VALUES(search_intent)","options":{}},"id":"b9b60e47-a2b8-4843-a23e-22300a6477a6","name":"MySQL - Save Keyword","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[0,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=UPDATE keyword_projects \\nSET \\n  total_keywords_found = (SELECT COUNT(*) FROM keyword_results WHERE project_id = {{ $('Code - Split Keywords').first().json.project_id }})\\nWHERE id = {{ $('Code - Split Keywords').first().json.project_id }}","options":{}},"id":"70461db9-c05d-49c5-8936-f2f247880911","name":"MySQL - Update Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Response iin veri hazrla\\nconst firstItem = $('Code - Split Keywords').first().json;\\nconst keywordCount = $('Code - Split Keywords').all().filter(i => !i.json.skip).length;\\n\\nreturn {\\n  success: true,\\n  message: `Content Gap analizi tamamlandi. ${keywordCount} keyword onerisi olusturuldu.`,\\n  project_id: firstItem.project_id,\\n  analysis_summary: firstItem.analysis_summary || '',\\n  pillar_suggestion: firstItem.pillar_suggestion || '',\\n  cluster_suggestions: firstItem.cluster_suggestions || [],\\n  keywords_found: keywordCount,\\n  ai_source: firstItem.ai_source || 'unknown'\\n};"},"id":"8758f7dd-18ab-4afe-a6c7-6b05c2414b68","name":"Code - Prepare Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,112]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"b529dac4-ee94-471f-9a8c-b9626e8472cb","name":"Respond - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,112]},{"parameters":{"jsCode":"// Keyword yoksa da response dndr\\nconst firstItem = $('Code - Split Keywords').first().json;\\n\\nreturn {\\n  success: true,\\n  message: 'Content Gap analizi tamamlandi ancak keyword onerisi bulunamadi.',\\n  project_id: firstItem.project_id,\\n  analysis_summary: firstItem.analysis_summary || 'Analiz yapildi ancak sonuc uretilemedi',\\n  keywords_found: 0,\\n  ai_source: firstItem.ai_source || 'unknown'\\n};"},"id":"3330d45d-08dd-4ca6-b5ad-7d93fa88deba","name":"Code - No Keywords Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,208]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"52d47cac-32e5-4db6-8eff-d06ffbd721d2","name":"Respond - No Keywords","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[224,208]}]	{"Webhook":{"main":[[{"node":"Code - Validate Input","type":"main","index":0}]]},"Code - Validate Input":{"main":[[{"node":"IF - Valid Input","type":"main","index":0}]]},"IF - Valid Input":{"main":[[{"node":"MySQL - Get Project","type":"main","index":0}],[{"node":"Respond - Validation Error","type":"main","index":0}]]},"MySQL - Get Project":{"main":[[{"node":"IF - Project Exists","type":"main","index":0}]]},"IF - Project Exists":{"main":[[{"node":"MySQL - Get System Settings","type":"main","index":0}],[{"node":"Respond - Not Found","type":"main","index":0}]]},"MySQL - Get System Settings":{"main":[[{"node":"MySQL - Get System Prompt","type":"main","index":0}]]},"MySQL - Get System Prompt":{"main":[[{"node":"MySQL - Get Competitors","type":"main","index":0}]]},"MySQL - Get Competitors":{"main":[[{"node":"MySQL - Get SERP Features","type":"main","index":0}]]},"MySQL - Get SERP Features":{"main":[[{"node":"MySQL - Get PAA","type":"main","index":0}]]},"MySQL - Get PAA":{"main":[[{"node":"Code - Prepare AI Prompt","type":"main","index":0}]]},"Code - Prepare AI Prompt":{"main":[[{"node":"Code - AI Analysis","type":"main","index":0}]]},"Code - AI Analysis":{"main":[[{"node":"MySQL - Log Token Usage","type":"main","index":0}]]},"MySQL - Log Token Usage":{"main":[[{"node":"Code - Split Keywords","type":"main","index":0}]]},"Code - Split Keywords":{"main":[[{"node":"IF - Has Keywords","type":"main","index":0}]]},"IF - Has Keywords":{"main":[[{"node":"MySQL - Save Keyword","type":"main","index":0}],[{"node":"Code - No Keywords Response","type":"main","index":0}]]},"MySQL - Save Keyword":{"main":[[{"node":"MySQL - Update Project","type":"main","index":0}]]},"MySQL - Update Project":{"main":[[{"node":"Code - Prepare Response","type":"main","index":0}]]},"Code - Prepare Response":{"main":[[{"node":"Respond - Success","type":"main","index":0}]]},"Code - No Keywords Response":{"main":[[{"node":"Respond - No Keywords","type":"main","index":0}]]}}	Version 9c8edff5	f	
7ee59fa8-baf4-4e41-a893-81d590e61e86	x03Ivd085mWitZQ9	Fatih Berkay Baheci	2025-12-17 10:29:03.332+00	2025-12-17 10:29:04.644+00	[{"parameters":{"httpMethod":"POST","path":":projectId/calculate","responseMode":"responseNode","options":{}},"id":"159096a6-eb1c-4268-bebd-8b77d5c6ff42","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3296,208],"webhookId":"tool1-opportunity-scorer"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Input validation\\nconst projectId = $json.params?.projectId;\\n\\nif (!projectId) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'projectId parametresi zorunludur',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nconst parsedId = parseInt(projectId);\\nif (isNaN(parsedId) || parsedId <= 0) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'projectId gecerli bir pozitif sayi olmalidir',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nreturn {\\n  json: {\\n    isValid: true,\\n    projectId: parsedId\\n  }\\n};"},"id":"c488f3bc-13f8-4783-9a3b-f8879244a44b","name":"Code - Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-3088,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"3c1d56e6-47f7-4a85-bcae-7078dbb77af3","name":"IF - Valid Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[-2864,208]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Validation failed\\",\\n  \\"message\\": \\"{{ $json.error }}\\"\\n}","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"b67e8cd6-5bd8-427b-b75b-20e06bf85579","name":"Respond - Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-2640,400]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  kp.id as project_id,\\n  kp.client_id,\\n  kp.main_keyword,\\n  kp.scenario_type,\\n  kp.target_country,\\n  kp.target_language,\\n  c.domain as client_domain,\\n  c.name as client_name,\\n  cc.ai_model_preference as client_ai_model\\nFROM keyword_projects kp\\nJOIN clients c ON c.id = kp.client_id\\nLEFT JOIN client_configurations cc ON cc.client_id = kp.client_id\\nWHERE kp.id = {{ $json.projectId }}\\nLIMIT 1","options":{}},"id":"52fca920-c317-4c89-aa01-163c897d004d","name":"MySQL - Get Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-2640,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"project-exists","leftValue":"={{ $json.project_id }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"id":"b96b8d83-22e9-4ee2-9a4a-2f1aca66fb7b","name":"IF - Project Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-2416,208]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Project not found\\",\\n  \\"message\\": \\"Proje bulunamadi: {{ $('Code - Validate Input').first().json.projectId }}\\"\\n}","options":{"responseCode":404}},"id":"0351edcc-b05f-4ece-a33b-514e567b888b","name":"Respond - Not Found","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-2208,400]},{"parameters":{"operation":"executeQuery","query":"=SELECT setting_key, setting_value FROM system_settings WHERE setting_key IN ('default_ai_model', 'default_ai_temperature')","options":{}},"id":"832f52c8-693c-4b6d-abb7-31b98014fc8e","name":"MySQL - Get System Settings","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-2208,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT prompt_text FROM system_prompts WHERE slug = 'opportunity-scorer' AND is_active = 1 LIMIT 1","options":{}},"id":"9e70fc94-5726-408a-b627-a42cd234c0fa","name":"MySQL - Get System Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1984,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  kr.id,\\n  kr.keyword,\\n  kr.keyword_type,\\n  kr.search_volume,\\n  kr.keyword_difficulty,\\n  kr.cpc,\\n  kr.competition,\\n  kr.search_intent,\\n  kr.trend_direction,\\n  kr.opportunity_score as current_score\\nFROM keyword_results kr\\nWHERE kr.project_id = {{ $('MySQL - Get Project').first().json.project_id }}\\nORDER BY kr.search_volume DESC\\nLIMIT 100","options":{}},"id":"379efe11-ab1c-45a5-9c51-363a662dde19","name":"MySQL - Get Keywords","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1760,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=(SELECT \\n  cd.competitor_domain,\\n  cd.competitor_url,\\n  cd.title,\\n  cd.domain_rating,\\n  cd.serp_position,\\n  cd.word_count,\\n  cd.backlinks_count\\nFROM competitor_data cd\\nWHERE cd.project_id = {{ $('MySQL - Get Project').first().json.project_id }}\\nAND cd.word_count > 0\\nORDER BY cd.serp_position ASC\\nLIMIT 10)\\nUNION ALL\\n(SELECT NULL, NULL, NULL, NULL, NULL, NULL, NULL FROM dual\\nWHERE NOT EXISTS (\\n  SELECT 1 FROM competitor_data \\n  WHERE project_id = {{ $('MySQL - Get Project').first().json.project_id }} AND word_count > 0\\n))","options":{}},"id":"f6ca76a2-acd8-44e0-958f-d083a36525d7","name":"MySQL - Get Competitors","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1536,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=(SELECT \\n  sf.has_featured_snippet,\\n  sf.featured_snippet_type,\\n  sf.has_paa,\\n  sf.paa_count,\\n  sf.has_video_results,\\n  sf.has_knowledge_panel,\\n  sf.zero_click_risk\\nFROM serp_features sf\\nWHERE sf.project_id = {{ $('MySQL - Get Project').first().json.project_id }}\\nLIMIT 1)\\nUNION ALL\\n(SELECT 0, NULL, 0, 0, 0, 0, NULL FROM dual\\nWHERE NOT EXISTS (\\n  SELECT 1 FROM serp_features \\n  WHERE project_id = {{ $('MySQL - Get Project').first().json.project_id }}\\n))","options":{}},"id":"9c14a715-7419-4974-96c6-6c07f90c61c3","name":"MySQL - Get SERP Features","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1328,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Prepare AI prompt - COMPACT CSV FORMAT: ID|Keyword|Vol|KD|CPC\\nconst project = $('MySQL - Get Project').first().json;\\nconst keywordItems = $('MySQL - Get Keywords').all();\\nconst keywords = keywordItems.map(i => i.json).filter(k => k.id);\\n\\n// System Settings\\nconst settingsItems = $('MySQL - Get System Settings').all();\\nconst systemSettings = {};\\nsettingsItems.forEach(item => {\\n  if (item.json.setting_key) systemSettings[item.json.setting_key] = item.json.setting_value;\\n});\\n\\n// System Prompt\\nconst promptData = $('MySQL - Get System Prompt').first().json;\\nconst systemPromptTemplate = promptData?.prompt_text || '';\\n\\nif (keywords.length === 0) {\\n  return [{ json: { skip: true, project_id: project.project_id, message: 'Skorlanacak keyword bulunamadi' } }];\\n}\\n\\n// COMPACT CSV format: ID|Keyword|Vol|KD|CPC\\nconst keywordCsv = keywords.map(kw => {\\n  const vol = kw.search_volume || 0;\\n  const kd = kw.keyword_difficulty !== null ? kw.keyword_difficulty : '';\\n  const cpc = kw.cpc || 0;\\n  return `${kw.id}|${kw.keyword}|${vol}|${kd}|${cpc}`;\\n}).join('\\\\n');\\n\\n// Replace template variables\\nlet finalPrompt = systemPromptTemplate\\n  .replace(/\\\\{\\\\{main_keyword\\\\}\\\\}/g, project.main_keyword || '')\\n  .replace(/\\\\{\\\\{target_country\\\\}\\\\}/g, project.target_country || 'TR')\\n  .replace(/\\\\{\\\\{keyword_csv\\\\}\\\\}/g, keywordCsv);\\n\\n// Fallback prompt if empty\\nif (!finalPrompt || finalPrompt.trim() === '') {\\n  finalPrompt = `SEO keyword firsat skorlama. Skoru 0-100 arasi hesapla.\\\\nPROJE: ${project.main_keyword} | ${project.target_country}\\\\nKEYWORDS (ID|Keyword|Vol|KD|CPC):\\\\n${keywordCsv}\\\\nCIKTI (sadece CSV, baslik yok):\\\\nID,Score,Priority,LHF`;\\n}\\n\\n// Model selection\\nconst clientModel = project.client_ai_model;\\nconst systemDefaultModel = systemSettings.default_ai_model || 'gemini-2.0-flash';\\nconst primaryModel = clientModel || systemDefaultModel;\\nlet fallbackModel = null;\\nif (clientModel && systemDefaultModel && clientModel !== systemDefaultModel) fallbackModel = systemDefaultModel;\\nconst temperature = parseFloat(systemSettings.default_ai_temperature) || 0.7;\\n\\nreturn [{\\n  json: {\\n    project_id: project.project_id,\\n    client_id: project.client_id,\\n    main_keyword: project.main_keyword,\\n    prompt: finalPrompt,\\n    keyword_count: keywords.length,\\n    keywords: keywords,\\n    primaryModel: primaryModel,\\n    fallbackModel: fallbackModel,\\n    temperature: temperature\\n  }\\n}];"},"id":"703a04d7-3b7d-4fb8-9ded-0804ad9164a5","name":"Code - Prepare AI Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1104,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-keywords","leftValue":"={{ $json.skip }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"181f1c88-2678-4d7f-80dc-d81b5ec33fbc","name":"IF - Has Keywords","type":"n8n-nodes-base.if","typeVersion":2,"position":[-880,208]},{"parameters":{"jsCode":"// AI Analysis - COMPACT CSV OUTPUT + TOKEN TRACKING\\nconst data = $input.first().json;\\nconst prompt = data.prompt;\\nconst primaryModel = data.primaryModel;\\nconst fallbackModel = data.fallbackModel;\\nconst temperature = data.temperature;\\nconst keywords = data.keywords || [];\\n\\nconst GEMINI_API_KEY = $env.GEMINI_API_KEY || '';\\nconst OPENAI_API_KEY = $env.OPENAI_API_KEY || '';\\n\\nlet result = null;\\nlet aiSource = 'none';\\nlet tokenUsage = { input: 0, output: 0, model: '', provider: 'none' };\\n\\n// Call AI Model with token tracking\\nasync function callModel(model, promptText) {\\n  const startTime = Date.now();\\n  try {\\n    if (model.includes('gemini') && GEMINI_API_KEY) {\\n      const response = await this.helpers.httpRequest({\\n        method: 'POST',\\n        url: `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`,\\n        headers: { 'Content-Type': 'application/json' },\\n        body: { contents: [{ parts: [{ text: promptText }] }], generationConfig: { temperature: temperature, maxOutputTokens: 4096 } },\\n        timeout: 90000\\n      });\\n      const elapsed = Date.now() - startTime;\\n      if (response.candidates?.[0]?.content?.parts?.[0]?.text) {\\n        const usage = response.usageMetadata || {};\\n        return { success: true, content: response.candidates[0].content.parts[0].text, source: 'gemini', tokens: { input: usage.promptTokenCount || 0, output: usage.candidatesTokenCount || 0 }, model: model, elapsed: elapsed };\\n      }\\n    } else if ((model.includes('gpt') || model.includes('openai')) && OPENAI_API_KEY) {\\n      const response = await this.helpers.httpRequest({\\n        method: 'POST',\\n        url: 'https://api.openai.com/v1/chat/completions',\\n        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${OPENAI_API_KEY}` },\\n        body: { model: 'gpt-4o-mini', messages: [{ role: 'user', content: promptText }], temperature: temperature, max_tokens: 4096 },\\n        timeout: 90000\\n      });\\n      const elapsed = Date.now() - startTime;\\n      if (response.choices?.[0]?.message?.content) {\\n        const usage = response.usage || {};\\n        return { success: true, content: response.choices[0].message.content, source: 'openai', tokens: { input: usage.prompt_tokens || 0, output: usage.completion_tokens || 0 }, model: 'gpt-4o-mini', elapsed: elapsed };\\n      }\\n    }\\n  } catch (e) { console.log(`Model ${model} failed:`, e.message); }\\n  return { success: false, elapsed: Date.now() - startTime };\\n}\\n\\n// Parse CSV response\\nfunction parseCSVResponse(content, keywordList) {\\n  const csvContent = content.replace(/```[a-z]*\\\\n?/g, '').replace(/```/g, '').trim();\\n  const lines = csvContent.split('\\\\n').filter(l => l.trim() && !l.toLowerCase().startsWith('id'));\\n  const scoredKeywords = [];\\n  for (const line of lines) {\\n    const parts = line.split(/[,|]/).map(p => p.trim());\\n    if (parts.length >= 4) {\\n      const kwId = parseInt(parts[0]);\\n      const origKw = keywordList.find(k => k.id === kwId);\\n      if (origKw) {\\n        scoredKeywords.push({ keyword_id: kwId, keyword: origKw.keyword, opportunity_score: parseInt(parts[1]) || 50, priority: (parts[2] || 'medium').toLowerCase(), low_hanging_fruit: parts[3] === '1' || parts[3].toLowerCase() === 'true' });\\n      }\\n    }\\n  }\\n  if (scoredKeywords.length === 0) return null;\\n  scoredKeywords.sort((a, b) => b.opportunity_score - a.opportunity_score);\\n  return { analysis_summary: `${scoredKeywords.length} keyword analiz edildi.`, scored_keywords: scoredKeywords, top_opportunities: scoredKeywords.slice(0, 5).map(k => k.keyword) };\\n}\\n\\n// Mock Scoring\\nfunction getMockScoring(keywordList) {\\n  const scoredKeywords = keywordList.map(kw => {\\n    const vol = kw.search_volume || 0; const kd = kw.keyword_difficulty !== null ? kw.keyword_difficulty : 50;\\n    let score = 50 + (vol >= 1000 ? 15 : vol >= 100 ? 8 : 0) + (kd <= 30 ? 20 : kd <= 50 ? 10 : 0);\\n    return { keyword_id: kw.id, keyword: kw.keyword, opportunity_score: Math.min(score, 100), priority: score >= 70 ? 'high' : score >= 50 ? 'medium' : 'low', low_hanging_fruit: vol >= 100 && kd <= 30 };\\n  });\\n  scoredKeywords.sort((a, b) => b.opportunity_score - a.opportunity_score);\\n  return { analysis_summary: `[MOCK] ${keywordList.length} keyword skorlandi.`, scored_keywords: scoredKeywords, top_opportunities: scoredKeywords.slice(0, 5).map(k => k.keyword) };\\n}\\n\\nlet responseTime = 0;\\n\\n// 1. Try Primary Model\\nif (primaryModel) {\\n  const r = await callModel.call(this, primaryModel, prompt);\\n  responseTime = r.elapsed || 0;\\n  if (r.success) {\\n    result = parseCSVResponse(r.content, keywords);\\n    if (result) { aiSource = r.source; tokenUsage = { input: r.tokens?.input || 0, output: r.tokens?.output || 0, model: r.model, provider: r.source }; }\\n  }\\n}\\n\\n// 2. Try Fallback\\nif (!result && fallbackModel) {\\n  const r = await callModel.call(this, fallbackModel, prompt);\\n  responseTime = r.elapsed || 0;\\n  if (r.success) {\\n    result = parseCSVResponse(r.content, keywords);\\n    if (result) { aiSource = r.source + '-fallback'; tokenUsage = { input: r.tokens?.input || 0, output: r.tokens?.output || 0, model: r.model, provider: r.source }; }\\n  }\\n}\\n\\n// 3. Mock\\nif (!result) { result = getMockScoring(keywords); aiSource = 'mock'; }\\n\\nreturn [{ json: { project_id: data.project_id, client_id: data.client_id, ai_response: result, ai_source: aiSource, keyword_count: keywords.length, token_usage: tokenUsage, response_time_ms: responseTime } }];"},"id":"e20d5499-7a65-4708-b83d-e0d33549f1bc","name":"Code - AI Analysis","type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,112]},{"parameters":{"jsCode":"const data = $input.first().json;\\nreturn {\\n  success: true,\\n  message: data.message || 'Skorlanacak keyword bulunamadi',\\n  project_id: data.project_id,\\n  stats: { total_keywords: 0 }\\n};"},"id":"bb90e693-8f0d-4c76-96d5-4436dd96bb93","name":"Code - No Keywords","type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,352]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"dbde50bf-7953-435e-ab44-78edd1b82b5a","name":"Respond - No Keywords","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-448,352]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO api_usage_tracking (client_id, tool_name, project_id, workflow_name, api_provider, model_name, tokens_input, tokens_output, requests_count, response_time_ms, was_successful) VALUES ({{ $json.client_id || 0 }}, 'tool1', {{ $json.project_id || 0 }}, 'WF-107-opportunity-scorer', '{{ $json.token_usage?.provider === 'gemini' ? 'google' : $json.token_usage?.provider === 'openai' ? 'openai' : 'other' }}', '{{ $json.token_usage?.model || '' }}', {{ $json.token_usage?.input || 0 }}, {{ $json.token_usage?.output || 0 }}, 1, {{ $json.response_time_ms || 0 }}, {{ $json.ai_source !== 'mock' ? 1 : 0 }})","options":{}},"id":"f4867113-a5c7-4a76-9f93-3f1655d48bd1","name":"MySQL - Log Token Usage","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-544,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Skorlari tek tek update icin ayir\\nconst data = $('Code - AI Analysis').first().json;\\nconst aiResponse = data.ai_response || {};\\nconst scoredKeywords = aiResponse.scored_keywords || [];\\n\\nif (scoredKeywords.length === 0) {\\n  return [{ json: { skip: true, project_id: data.project_id, ai_source: data.ai_source, ai_response: aiResponse } }];\\n}\\n\\nreturn scoredKeywords.map(kw => ({\\n  json: {\\n    keyword_id: kw.keyword_id,\\n    opportunity_score: kw.opportunity_score,\\n    priority: kw.priority,\\n    low_hanging_fruit: kw.low_hanging_fruit ? 1 : 0,\\n    project_id: data.project_id,\\n    ai_source: data.ai_source,\\n    ai_response: aiResponse\\n  }\\n}));"},"id":"6efbb017-1ad9-4721-830d-fe086fe5e4c9","name":"Code - Split for Update","type":"n8n-nodes-base.code","typeVersion":2,"position":[-336,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-scores","leftValue":"={{ $json.skip }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"a0c77832-2c23-4661-b095-06f8a38647ee","name":"IF - Has Scores","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"operation":"executeQuery","query":"=UPDATE keyword_results \\nSET opportunity_score = {{ $json.opportunity_score }}\\nWHERE id = {{ $json.keyword_id }}","options":{}},"id":"3cbe924e-3c55-4771-b37a-fc27c9e4c781","name":"MySQL - Update Score","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[0,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=UPDATE keyword_projects \\nSET status = 'scores_calculated'\\nWHERE id = {{ $('Code - Split for Update').first().json.project_id }}","options":{}},"id":"18eae58d-50c8-4151-9ad8-96bd13685d4b","name":"MySQL - Update Project Status","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Response hazirla\\nconst firstItem = $('Code - Split for Update').first().json;\\nconst aiResponse = firstItem.ai_response || {};\\nconst allItems = $('Code - Split for Update').all();\\nconst totalUpdated = allItems.filter(i => !i.json.skip).length;\\nconst scoredKeywords = aiResponse.scored_keywords || [];\\n\\n// Stats hesapla\\nconst highPriority = scoredKeywords.filter(k => k.priority === 'high').length;\\nconst mediumPriority = scoredKeywords.filter(k => k.priority === 'medium').length;\\nconst lowPriority = scoredKeywords.filter(k => k.priority === 'low').length;\\nconst lowHangingFruits = scoredKeywords.filter(k => k.low_hanging_fruit).length;\\nconst avgScore = scoredKeywords.length > 0 \\n  ? Math.round(scoredKeywords.reduce((sum, k) => sum + k.opportunity_score, 0) / scoredKeywords.length)\\n  : 0;\\n\\nreturn {\\n  success: true,\\n  message: aiResponse.analysis_summary || `Firsat skorlari hesaplandi. ${totalUpdated} keyword guncellendi.`,\\n  project_id: firstItem.project_id,\\n  ai_source: firstItem.ai_source,\\n  stats: {\\n    total_keywords: totalUpdated,\\n    high_priority: highPriority,\\n    medium_priority: mediumPriority,\\n    low_priority: lowPriority,\\n    low_hanging_fruits: lowHangingFruits,\\n    average_score: avgScore\\n  },\\n  top_opportunities: aiResponse.top_opportunities || [],\\n  warnings: aiResponse.warnings || [],\\n  next_step: 'WF-108 Keyword Clusterer ile kumeleme yapilabilir'\\n};"},"id":"cfe9528a-a9c5-445d-a929-93e48c628abc","name":"Code - Prepare Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,112]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"cb7d75b6-1f90-4898-8059-27d6f7b54daa","name":"Respond - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,112]},{"parameters":{"jsCode":"const data = $input.first().json;\\nconst aiResponse = data.ai_response || {};\\n\\nreturn {\\n  success: true,\\n  message: 'Skorlama tamamlandi ancak guncellenecek keyword bulunamadi',\\n  project_id: data.project_id,\\n  ai_source: data.ai_source,\\n  analysis_summary: aiResponse.analysis_summary || '',\\n  warnings: aiResponse.warnings || []\\n};"},"id":"9a462407-2e9e-4581-8a05-d48e47ff0fcf","name":"Code - No Scores","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,256]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"988eb5d6-7981-4bbe-8ad9-403d3debe0eb","name":"Respond - No Scores","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[224,256]}]	{"Webhook":{"main":[[{"node":"Code - Validate Input","type":"main","index":0}]]},"Code - Validate Input":{"main":[[{"node":"IF - Valid Input","type":"main","index":0}]]},"IF - Valid Input":{"main":[[{"node":"MySQL - Get Project","type":"main","index":0}],[{"node":"Respond - Validation Error","type":"main","index":0}]]},"MySQL - Get Project":{"main":[[{"node":"IF - Project Exists","type":"main","index":0}]]},"IF - Project Exists":{"main":[[{"node":"MySQL - Get System Settings","type":"main","index":0}],[{"node":"Respond - Not Found","type":"main","index":0}]]},"MySQL - Get System Settings":{"main":[[{"node":"MySQL - Get System Prompt","type":"main","index":0}]]},"MySQL - Get System Prompt":{"main":[[{"node":"MySQL - Get Keywords","type":"main","index":0}]]},"MySQL - Get Keywords":{"main":[[{"node":"MySQL - Get Competitors","type":"main","index":0}]]},"MySQL - Get Competitors":{"main":[[{"node":"MySQL - Get SERP Features","type":"main","index":0}]]},"MySQL - Get SERP Features":{"main":[[{"node":"Code - Prepare AI Prompt","type":"main","index":0}]]},"Code - Prepare AI Prompt":{"main":[[{"node":"IF - Has Keywords","type":"main","index":0}]]},"IF - Has Keywords":{"main":[[{"node":"Code - AI Analysis","type":"main","index":0}],[{"node":"Code - No Keywords","type":"main","index":0}]]},"Code - AI Analysis":{"main":[[{"node":"MySQL - Log Token Usage","type":"main","index":0}]]},"MySQL - Log Token Usage":{"main":[[{"node":"Code - Split for Update","type":"main","index":0}]]},"Code - No Keywords":{"main":[[{"node":"Respond - No Keywords","type":"main","index":0}]]},"Code - Split for Update":{"main":[[{"node":"IF - Has Scores","type":"main","index":0}]]},"IF - Has Scores":{"main":[[{"node":"MySQL - Update Score","type":"main","index":0}],[{"node":"Code - No Scores","type":"main","index":0}]]},"MySQL - Update Score":{"main":[[{"node":"MySQL - Update Project Status","type":"main","index":0}]]},"MySQL - Update Project Status":{"main":[[{"node":"Code - Prepare Response","type":"main","index":0}]]},"Code - Prepare Response":{"main":[[{"node":"Respond - Success","type":"main","index":0}]]},"Code - No Scores":{"main":[[{"node":"Respond - No Scores","type":"main","index":0}]]}}	Version 7ee59fa8	f	
3acbc191-abbe-4188-85e8-28351da99233	dKv529VBvG6GzQ7d	Fatih Berkay Baheci	2025-12-17 10:29:24.428+00	2025-12-17 10:29:26.03+00	[{"parameters":{"httpMethod":"POST","path":":projectId/generate","responseMode":"responseNode","options":{}},"id":"d0dad58f-42b9-4e0c-ba38-378f79cc1f6a","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3088,208],"webhookId":"tool1-strategy-generator"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Input validation\\nconst projectId = $json.params?.projectId;\\n\\nif (!projectId) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'projectId parametresi zorunludur',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nconst parsedId = parseInt(projectId);\\nif (isNaN(parsedId) || parsedId <= 0) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'projectId gecerli bir pozitif sayi olmalidir',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nreturn {\\n  json: {\\n    isValid: true,\\n    projectId: parsedId\\n  }\\n};"},"id":"3bf32125-cc5c-49da-97aa-ea6b4bea4d1d","name":"Code - Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2864,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"688f21a5-78c8-4041-8c54-91856822c348","name":"IF - Valid Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[-2640,208]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Validation failed\\",\\n  \\"message\\": \\"{{ $json.error }}\\"\\n}","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"59b91cda-ff2f-4405-bc00-2815afa908b3","name":"Respond - Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-2416,400]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  kp.id as project_id,\\n  kp.client_id,\\n  kp.main_keyword,\\n  kp.scenario_type,\\n  kp.target_country,\\n  kp.target_language,\\n  c.domain as client_domain,\\n  c.name as client_name,\\n  c.industry as client_industry,\\n  cc.ai_model_preference as client_ai_model\\nFROM keyword_projects kp\\nJOIN clients c ON c.id = kp.client_id\\nLEFT JOIN client_configurations cc ON cc.client_id = kp.client_id\\nWHERE kp.id = {{ $json.projectId }}\\nLIMIT 1","options":{}},"id":"f3af111f-4680-43f4-a53e-2e19711ae44f","name":"MySQL - Get Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-2416,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"project-exists","leftValue":"={{ $json.project_id }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"id":"bda8f0fa-5168-4cb1-873b-b90c83ec9543","name":"IF - Project Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-2208,208]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Project not found\\",\\n  \\"message\\": \\"Proje bulunamadi: {{ $('Code - Validate Input').first().json.projectId }}\\"\\n}","options":{"responseCode":404}},"id":"a943bedc-ac10-46ad-89d7-8d23fbd2ec31","name":"Respond - Not Found","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-1984,400]},{"parameters":{"operation":"executeQuery","query":"=SELECT setting_key, setting_value FROM system_settings WHERE setting_key IN ('default_ai_model', 'default_ai_temperature')","options":{}},"id":"4ebff6c1-fd11-435b-8b4a-68c7d5766fb3","name":"MySQL - Get System Settings","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1984,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT prompt_text FROM system_prompts WHERE slug = 'strategy-generator' AND is_active = 1 LIMIT 1","options":{}},"id":"466abb05-c121-48d1-b914-dbe2b41e511d","name":"MySQL - Get System Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1760,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  kr.id,\\n  kr.keyword,\\n  kr.keyword_type,\\n  kr.search_volume,\\n  kr.keyword_difficulty,\\n  kr.cpc,\\n  kr.search_intent,\\n  kr.keyword_cluster,\\n  kr.opportunity_score,\\n  kr.parent_topic\\nFROM keyword_results kr\\nWHERE kr.project_id = {{ $('MySQL - Get Project').first().json.project_id }}\\nAND kr.keyword_type != 'rejected'\\nORDER BY kr.opportunity_score DESC, kr.search_volume DESC\\nLIMIT 50","options":{}},"id":"0fc1f293-e5ac-4f0e-8cd5-4b066f8d6341","name":"MySQL - Get Keywords","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1536,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=(SELECT \\n  cd.competitor_domain,\\n  cd.title,\\n  cd.word_count,\\n  cd.serp_position,\\n  cd.domain_rating\\nFROM competitor_data cd\\nWHERE cd.project_id = {{ $('MySQL - Get Project').first().json.project_id }}\\nAND cd.word_count > 0\\nORDER BY cd.serp_position ASC\\nLIMIT 5)\\nUNION ALL\\n(SELECT NULL, NULL, NULL, NULL, NULL FROM dual\\nWHERE NOT EXISTS (\\n  SELECT 1 FROM competitor_data \\n  WHERE project_id = {{ $('MySQL - Get Project').first().json.project_id }} AND word_count > 0\\n))","options":{}},"id":"273109e8-6278-4f47-83ae-a2657c9abadf","name":"MySQL - Get Competitors","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1328,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Prepare AI prompt - COMPACT CSV FORMAT: ID|keyword|intent|score\\nconst project = $('MySQL - Get Project').first().json;\\nconst keywordItems = $('MySQL - Get Keywords').all();\\nconst keywords = keywordItems.map(i => i.json).filter(k => k.id);\\nconst competitorItems = $('MySQL - Get Competitors').all();\\nconst competitors = competitorItems.map(i => i.json).filter(c => c.competitor_domain);\\n\\n// System Settings\\nconst settingsItems = $('MySQL - Get System Settings').all();\\nconst systemSettings = {};\\nsettingsItems.forEach(item => {\\n  if (item.json.setting_key) systemSettings[item.json.setting_key] = item.json.setting_value;\\n});\\n\\n// System Prompt\\nconst promptData = $('MySQL - Get System Prompt').first().json;\\nconst systemPromptTemplate = promptData?.prompt_text || '';\\n\\nif (keywords.length === 0) {\\n  return [{ json: { skip: true, project_id: project.project_id, message: 'Strateji olusturulacak keyword bulunamadi' } }];\\n}\\n\\n// Average competitor word count\\nconst avgWordCount = competitors.length > 0 \\n  ? Math.round(competitors.reduce((sum, c) => sum + (c.word_count || 0), 0) / competitors.length) : 1500;\\n\\n// COMPACT CSV format: ID|keyword|intent|score\\nconst keywordCsv = keywords.map(kw => {\\n  const intent = kw.search_intent || 'informational';\\n  const score = kw.opportunity_score || 0;\\n  return `${kw.id}|${kw.keyword}|${intent}|${score}`;\\n}).join('\\\\n');\\n\\n// Replace template variables\\nlet finalPrompt = systemPromptTemplate\\n  .replace(/\\\\{\\\\{main_keyword\\\\}\\\\}/g, project.main_keyword || '')\\n  .replace(/\\\\{\\\\{target_country\\\\}\\\\}/g, project.target_country || 'TR')\\n  .replace(/\\\\{\\\\{keyword_csv\\\\}\\\\}/g, keywordCsv);\\n\\n// Fallback prompt\\nif (!finalPrompt || finalPrompt.trim() === '') {\\n  finalPrompt = `Icerik stratejisi. Konu: ${project.main_keyword} | Ulke: ${project.target_country}\\\\nKEYWORDS (ID|keyword|intent|score):\\\\n${keywordCsv}\\\\nCIKTI (sadece CSV, baslik yok):\\\\nID|type|format|priority|words|pillar_id`;\\n}\\n\\n// Model selection\\nconst clientModel = project.client_ai_model;\\nconst systemDefaultModel = systemSettings.default_ai_model || 'gemini-2.0-flash';\\nconst primaryModel = clientModel || systemDefaultModel;\\nlet fallbackModel = null;\\nif (clientModel && systemDefaultModel && clientModel !== systemDefaultModel) fallbackModel = systemDefaultModel;\\nconst temperature = parseFloat(systemSettings.default_ai_temperature) || 0.7;\\n\\nreturn [{\\n  json: {\\n    project_id: project.project_id,\\n    client_id: project.client_id,\\n    main_keyword: project.main_keyword,\\n    prompt: finalPrompt,\\n    keyword_count: keywords.length,\\n    keywords: keywords,\\n    avg_competitor_word_count: avgWordCount,\\n    primaryModel: primaryModel,\\n    fallbackModel: fallbackModel,\\n    temperature: temperature\\n  }\\n}];"},"id":"b192b797-3e6d-4a21-a4e4-ba8fb19e64ff","name":"Code - Prepare AI Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1104,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-keywords","leftValue":"={{ $json.skip }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"c70eef1f-3a56-453d-a676-6bec7112f7be","name":"IF - Has Keywords","type":"n8n-nodes-base.if","typeVersion":2,"position":[-880,208]},{"parameters":{"jsCode":"// AI Analysis - COMPACT CSV OUTPUT + TOKEN TRACKING: ID|type|format|priority|words|pillar_id\\nconst data = $input.first().json;\\nconst prompt = data.prompt;\\nconst primaryModel = data.primaryModel;\\nconst fallbackModel = data.fallbackModel;\\nconst temperature = data.temperature;\\nconst keywords = data.keywords || [];\\nconst avgWordCount = data.avg_competitor_word_count || 1500;\\n\\nconst GEMINI_API_KEY = $env.GEMINI_API_KEY || '';\\nconst OPENAI_API_KEY = $env.OPENAI_API_KEY || '';\\n\\nlet result = null;\\nlet aiSource = 'none';\\nlet tokenUsage = { input: 0, output: 0, model: '', provider: 'none' };\\n\\n// Call AI Model with token tracking\\nasync function callModel(model, promptText) {\\n  const startTime = Date.now();\\n  try {\\n    if (model.includes('gemini') && GEMINI_API_KEY) {\\n      const response = await this.helpers.httpRequest({\\n        method: 'POST',\\n        url: `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`,\\n        headers: { 'Content-Type': 'application/json' },\\n        body: { contents: [{ parts: [{ text: promptText }] }], generationConfig: { temperature: temperature, maxOutputTokens: 4096 } },\\n        timeout: 90000\\n      });\\n      const elapsed = Date.now() - startTime;\\n      if (response.candidates?.[0]?.content?.parts?.[0]?.text) {\\n        const usage = response.usageMetadata || {};\\n        return { success: true, content: response.candidates[0].content.parts[0].text, source: 'gemini', tokens: { input: usage.promptTokenCount || 0, output: usage.candidatesTokenCount || 0 }, model: model, elapsed: elapsed };\\n      }\\n    } else if ((model.includes('gpt') || model.includes('openai')) && OPENAI_API_KEY) {\\n      const response = await this.helpers.httpRequest({\\n        method: 'POST',\\n        url: 'https://api.openai.com/v1/chat/completions',\\n        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${OPENAI_API_KEY}` },\\n        body: { model: 'gpt-4o-mini', messages: [{ role: 'user', content: promptText }], temperature: temperature, max_tokens: 4096 },\\n        timeout: 90000\\n      });\\n      const elapsed = Date.now() - startTime;\\n      if (response.choices?.[0]?.message?.content) {\\n        const usage = response.usage || {};\\n        return { success: true, content: response.choices[0].message.content, source: 'openai', tokens: { input: usage.prompt_tokens || 0, output: usage.completion_tokens || 0 }, model: 'gpt-4o-mini', elapsed: elapsed };\\n      }\\n    }\\n  } catch (e) { console.log(`Model ${model} failed:`, e.message); }\\n  return { success: false, elapsed: Date.now() - startTime };\\n}\\n\\n// Parse CSV response: ID|type|format|priority|words|pillar_id\\nfunction parseCSVResponse(content, keywordList) {\\n  const csvContent = content.replace(/```[a-z]*\\\\n?/g, '').replace(/```/g, '').trim();\\n  const lines = csvContent.split('\\\\n').filter(l => l.trim() && !l.toLowerCase().startsWith('id'));\\n  const strategies = [];\\n  \\n  for (const line of lines) {\\n    const parts = line.split('|').map(p => p.trim());\\n    if (parts.length >= 5) {\\n      const kwId = parseInt(parts[0]);\\n      const origKw = keywordList.find(k => k.id === kwId);\\n      if (origKw) {\\n        strategies.push({\\n          keyword_id: kwId,\\n          keyword: origKw.keyword,\\n          page_type: parts[1] || 'cluster',\\n          content_format: parts[2] || 'blog',\\n          content_priority: parts[3] || 'medium',\\n          recommended_word_count: parseInt(parts[4]) || 1500,\\n          parent_pillar: parts[5] || null\\n        });\\n      }\\n    }\\n  }\\n  \\n  if (strategies.length === 0) return null;\\n  const pillarCount = strategies.filter(s => s.page_type === 'pillar').length;\\n  const clusterCount = strategies.filter(s => s.page_type === 'cluster').length;\\n  \\n  return {\\n    strategy_summary: `${strategies.length} keyword icin strateji olusturuldu. ${pillarCount} pillar, ${clusterCount} cluster.`,\\n    keyword_strategies: strategies,\\n    pillar_pages: strategies.filter(s => s.page_type === 'pillar').map(s => ({ keyword: s.keyword, keyword_id: s.keyword_id }))\\n  };\\n}\\n\\n// Mock Strategy\\nfunction getMockStrategy(keywordList, avgWC) {\\n  const sortedByVolume = [...keywordList].sort((a, b) => (b.search_volume || 0) - (a.search_volume || 0));\\n  const pillarKw = sortedByVolume[0];\\n  \\n  const strategies = keywordList.map(kw => {\\n    const isPillar = kw.id === pillarKw?.id;\\n    const score = kw.opportunity_score || 0;\\n    const intent = kw.search_intent || 'informational';\\n    let type = isPillar ? 'pillar' : 'cluster';\\n    let format = isPillar ? 'guide' : (intent === 'commercial' ? 'comparison' : 'blog');\\n    let priority = score >= 65 ? 'high' : score >= 40 ? 'medium' : 'low';\\n    let words = isPillar ? Math.round(avgWC * 1.8) : avgWC;\\n    return { keyword_id: kw.id, keyword: kw.keyword, page_type: type, content_format: format, content_priority: priority, recommended_word_count: words, parent_pillar: isPillar ? null : pillarKw?.keyword };\\n  });\\n  \\n  return {\\n    strategy_summary: `[MOCK] ${keywordList.length} keyword icin strateji.`,\\n    keyword_strategies: strategies,\\n    pillar_pages: pillarKw ? [{ keyword: pillarKw.keyword, keyword_id: pillarKw.id }] : [],\\n    recommendations: ['Mock strateji kullanildi']\\n  };\\n}\\n\\nlet responseTime = 0;\\n\\n// 1. Try Primary Model\\nif (primaryModel) {\\n  const r = await callModel.call(this, primaryModel, prompt);\\n  responseTime = r.elapsed || 0;\\n  if (r.success) {\\n    result = parseCSVResponse(r.content, keywords);\\n    if (result) { aiSource = r.source; tokenUsage = { input: r.tokens?.input || 0, output: r.tokens?.output || 0, model: r.model, provider: r.source }; }\\n  }\\n}\\n\\n// 2. Try Fallback Model\\nif (!result && fallbackModel) {\\n  const r = await callModel.call(this, fallbackModel, prompt);\\n  responseTime = r.elapsed || 0;\\n  if (r.success) {\\n    result = parseCSVResponse(r.content, keywords);\\n    if (result) { aiSource = r.source + '-fallback'; tokenUsage = { input: r.tokens?.input || 0, output: r.tokens?.output || 0, model: r.model, provider: r.source }; }\\n  }\\n}\\n\\n// 3. Use Mock\\nif (!result) {\\n  result = getMockStrategy(keywords, avgWordCount);\\n  aiSource = 'mock';\\n}\\n\\nreturn [{ json: { project_id: data.project_id, client_id: data.client_id, ai_response: result, ai_source: aiSource, keyword_count: keywords.length, token_usage: tokenUsage, response_time_ms: responseTime } }];"},"id":"2976e24c-4897-4c42-8f26-2a705b272527","name":"Code - AI Analysis","type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,112]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO api_usage_tracking (client_id, tool_name, project_id, workflow_name, api_provider, model_name, tokens_input, tokens_output, requests_count, response_time_ms, was_successful) VALUES ({{ $json.client_id || 0 }}, 'tool1', {{ $json.project_id || 0 }}, 'WF-109-strategy-generator', '{{ $json.token_usage?.provider === 'gemini' ? 'google' : $json.token_usage?.provider === 'openai' ? 'openai' : 'other' }}', '{{ $json.token_usage?.model || '' }}', {{ $json.token_usage?.input || 0 }}, {{ $json.token_usage?.output || 0 }}, 1, {{ $json.response_time_ms || 0 }}, {{ $json.ai_source !== 'mock' ? 1 : 0 }})","options":{}},"id":"06f0e9a1-d519-4b5c-bb34-ea687581f5ad","name":"MySQL - Log Token Usage","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-448,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const data = $input.first().json;\\nreturn {\\n  success: true,\\n  message: data.message || 'Strateji olusturulacak keyword bulunamadi',\\n  project_id: data.project_id,\\n  stats: { total_keywords: 0 }\\n};"},"id":"b1ce9169-5440-4ff6-a7fe-addb5dab5792","name":"Code - No Keywords","type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,352]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"d8285171-06d4-4131-a085-44038d36e60d","name":"Respond - No Keywords","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-448,352]},{"parameters":{"jsCode":"// Strateji verilerini tek tek update icin ayir\\nconst data = $('Code - AI Analysis').first().json;\\nconst aiResponse = data.ai_response || {};\\nconst strategies = aiResponse.keyword_strategies || [];\\n\\nif (strategies.length === 0) {\\n  return [{ json: { skip: true, project_id: data.project_id, ai_source: data.ai_source, ai_response: aiResponse } }];\\n}\\n\\nreturn strategies.map(s => ({\\n  json: {\\n    keyword_id: s.keyword_id,\\n    page_type: s.page_type || 'cluster',\\n    content_format: s.content_format || 'blog',\\n    content_priority: s.content_priority || 'medium',\\n    recommended_word_count: s.recommended_word_count || 1500,\\n    parent_pillar: s.parent_pillar || null,\\n    project_id: data.project_id,\\n    ai_source: data.ai_source,\\n    ai_response: aiResponse\\n  }\\n}));"},"id":"78631029-8b1d-4af6-abb6-e018cbf126ef","name":"Code - Split for Update","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-strategies","leftValue":"={{ $json.skip }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"3b4be378-0aea-4f24-89a9-13ad394a59aa","name":"IF - Has Strategies","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"operation":"executeQuery","query":"=UPDATE keyword_results \\nSET page_type = '{{ $json.page_type }}',\\n    content_format = '{{ $json.content_format }}',\\n    content_priority = '{{ $json.content_priority }}',\\n    recommended_word_count = {{ $json.recommended_word_count }}\\nWHERE id = {{ $json.keyword_id }}","options":{}},"id":"900e8d0a-b990-4e62-b2f0-a365ece448a2","name":"MySQL - Update Keyword","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[0,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=UPDATE keyword_projects \\nSET status = 'completed'\\nWHERE id = {{ $('Code - Split for Update').first().json.project_id }}","options":{}},"id":"54957ca4-5368-4942-b071-ceb5d9d9a837","name":"MySQL - Update Project Status","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Response hazirla\\nconst firstItem = $('Code - Split for Update').first().json;\\nconst aiResponse = firstItem.ai_response || {};\\nconst allItems = $('Code - Split for Update').all();\\nconst totalUpdated = allItems.filter(i => !i.json.skip).length;\\nconst strategies = aiResponse.keyword_strategies || [];\\n\\n// Stats hesapla\\nconst pillarCount = strategies.filter(s => s.page_type === 'pillar').length;\\nconst clusterCount = strategies.filter(s => s.page_type === 'cluster').length;\\nconst standaloneCount = strategies.filter(s => s.page_type === 'standalone').length;\\nconst highPriority = strategies.filter(s => s.content_priority === 'high').length;\\nconst mediumPriority = strategies.filter(s => s.content_priority === 'medium').length;\\nconst lowPriority = strategies.filter(s => s.content_priority === 'low').length;\\n\\nreturn {\\n  success: true,\\n  message: aiResponse.strategy_summary || `Icerik stratejisi olusturuldu. ${totalUpdated} keyword guncellendi.`,\\n  project_id: firstItem.project_id,\\n  ai_source: firstItem.ai_source,\\n  stats: {\\n    total_keywords: totalUpdated,\\n    pillar_pages: pillarCount,\\n    cluster_pages: clusterCount,\\n    standalone_pages: standaloneCount,\\n    high_priority: highPriority,\\n    medium_priority: mediumPriority,\\n    low_priority: lowPriority\\n  },\\n  pillar_pages: aiResponse.pillar_pages || [],\\n  content_calendar: aiResponse.content_calendar || {},\\n  recommendations: aiResponse.recommendations || []\\n};"},"id":"574bd7d7-2807-4775-bab2-8fd7d2b81963","name":"Code - Prepare Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,112]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"36ad5f8e-3152-4756-9c0c-247c3be3f7a9","name":"Respond - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,112]},{"parameters":{"jsCode":"const data = $input.first().json;\\nconst aiResponse = data.ai_response || {};\\n\\nreturn {\\n  success: true,\\n  message: 'Strateji olusturuldu ancak guncellenecek keyword bulunamadi',\\n  project_id: data.project_id,\\n  ai_source: data.ai_source,\\n  strategy_summary: aiResponse.strategy_summary || '',\\n  recommendations: aiResponse.recommendations || []\\n};"},"id":"ac2ea4ca-cd80-418f-8b7b-c69afcefd04d","name":"Code - No Strategies","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,256]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"da6c27a7-2685-4e2c-aa8b-b2046619d142","name":"Respond - No Strategies","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[224,256]}]	{"Webhook":{"main":[[{"node":"Code - Validate Input","type":"main","index":0}]]},"Code - Validate Input":{"main":[[{"node":"IF - Valid Input","type":"main","index":0}]]},"IF - Valid Input":{"main":[[{"node":"MySQL - Get Project","type":"main","index":0}],[{"node":"Respond - Validation Error","type":"main","index":0}]]},"MySQL - Get Project":{"main":[[{"node":"IF - Project Exists","type":"main","index":0}]]},"IF - Project Exists":{"main":[[{"node":"MySQL - Get System Settings","type":"main","index":0}],[{"node":"Respond - Not Found","type":"main","index":0}]]},"MySQL - Get System Settings":{"main":[[{"node":"MySQL - Get System Prompt","type":"main","index":0}]]},"MySQL - Get System Prompt":{"main":[[{"node":"MySQL - Get Keywords","type":"main","index":0}]]},"MySQL - Get Keywords":{"main":[[{"node":"MySQL - Get Competitors","type":"main","index":0}]]},"MySQL - Get Competitors":{"main":[[{"node":"Code - Prepare AI Prompt","type":"main","index":0}]]},"Code - Prepare AI Prompt":{"main":[[{"node":"IF - Has Keywords","type":"main","index":0}]]},"IF - Has Keywords":{"main":[[{"node":"Code - AI Analysis","type":"main","index":0}],[{"node":"Code - No Keywords","type":"main","index":0}]]},"Code - AI Analysis":{"main":[[{"node":"MySQL - Log Token Usage","type":"main","index":0}]]},"MySQL - Log Token Usage":{"main":[[{"node":"Code - Split for Update","type":"main","index":0}]]},"Code - No Keywords":{"main":[[{"node":"Respond - No Keywords","type":"main","index":0}]]},"Code - Split for Update":{"main":[[{"node":"IF - Has Strategies","type":"main","index":0}]]},"IF - Has Strategies":{"main":[[{"node":"MySQL - Update Keyword","type":"main","index":0}],[{"node":"Code - No Strategies","type":"main","index":0}]]},"MySQL - Update Keyword":{"main":[[{"node":"MySQL - Update Project Status","type":"main","index":0}]]},"MySQL - Update Project Status":{"main":[[{"node":"Code - Prepare Response","type":"main","index":0}]]},"Code - Prepare Response":{"main":[[{"node":"Respond - Success","type":"main","index":0}]]},"Code - No Strategies":{"main":[[{"node":"Respond - No Strategies","type":"main","index":0}]]}}	Version 3acbc191	f	
47de4265-58d6-42c2-9a3d-854120b78853	E29x9qTqO4XIfetR	Fatih Berkay Baheci	2025-12-17 10:28:38.266+00	2025-12-17 10:28:39.395+00	[{"parameters":{"httpMethod":"POST","path":"tool1-serp-features/:projectId/detect","responseMode":"responseNode","options":{}},"id":"b3091565-5ad5-4597-a2ea-c2160dd1ff09","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1536,208],"webhookId":"tool1-serp-features"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const projectId = $json.params?.projectId;\\n\\nif (!projectId) {\\n  return { json: { isValid: false, error: 'projectId parametresi zorunludur', errorCode: 400 } };\\n}\\n\\nconst parsedId = parseInt(projectId);\\nif (isNaN(parsedId) || parsedId <= 0) {\\n  return { json: { isValid: false, error: 'projectId gecerli bir pozitif sayi olmalidir', errorCode: 400 } };\\n}\\n\\nreturn { json: { isValid: true, projectId: parsedId } };"},"id":"72e8c1e5-9b9d-4613-b3be-f109416d5061","name":"Code - Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1328,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"744c5962-48e6-46d4-b7fb-00c73b3fc2f4","name":"IF - Valid Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1104,208]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Validation failed\\",\\n  \\"message\\": \\"{{ $json.error }}\\"\\n}","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"e53d5427-c6bf-4c55-9e3d-9ea7654c9591","name":"Respond - Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-880,400]},{"parameters":{"operation":"executeQuery","query":"=SELECT kp.id as project_id, kp.main_keyword, kp.target_country, kp.target_language, kp.client_id, COALESCE(cc.enable_ahrefs_api, 0) as enable_ahrefs_api FROM keyword_projects kp LEFT JOIN client_configurations cc ON kp.client_id = cc.client_id WHERE kp.id = {{ $json.projectId }} LIMIT 1","options":{}},"id":"32bd83e4-aa1d-408b-9eb0-81ecb8da36a1","name":"MySQL - Get Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-880,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"const result = $input.first().json;\\nconst validatedData = $('Code - Validate Input').first().json;\\n\\nif (!result.project_id) {\\n  return [{ json: { projectExists: false, projectId: validatedData.projectId } }];\\n}\\n\\nlet apiSource = 'serper';\\nif (result.enable_ahrefs_api === 1) {\\n  apiSource = 'ahrefs';\\n}\\n\\nreturn [{ json: { projectExists: true, projectId: result.project_id, mainKeyword: result.main_keyword, targetCountry: result.target_country || 'tr', targetLanguage: result.target_language || 'tr', apiSource: apiSource } }];"},"id":"fa377785-0b75-4a88-a4b7-e0f1e2cc55fd","name":"Code - Check Project","type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"project-exists","leftValue":"={{ $json.projectExists }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"b4119e54-4fd6-467d-b501-30ec8666464b","name":"IF - Project Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-448,208]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Project not found\\",\\n  \\"message\\": \\"Proje bulunamadi: {{ $json.projectId }}\\"\\n}","options":{"responseCode":404}},"id":"61cafd85-a140-4863-85b8-70898c3d51c8","name":"Respond - Not Found","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-224,400]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.apiSource }}","rightValue":"ahrefs","operator":{"type":"string","operation":"equals"}}],"combinator":"and"}},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.apiSource }}","rightValue":"serper","operator":{"type":"string","operation":"equals"}}],"combinator":"and"}}]},"options":{}},"id":"49728d31-7cae-4723-978c-4941001ccf33","name":"Switch - API Source","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-224,208]},{"parameters":{"url":"https://api.ahrefs.com/v3/serp-overview/serp-features","authentication":"predefinedCredentialType","nodeCredentialType":"httpHeaderAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"target","value":"={{ $json.mainKeyword }}"},{"name":"country","value":"={{ $json.targetCountry }}"}]},"options":{"timeout":30000}},"id":"f7a56c31-c611-4f03-bf53-dbd7b209d253","name":"HTTP - Ahrefs SERP","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,0],"credentials":{"httpHeaderAuth":{"id":"01zZGrP0Fob8kD8r","name":"Serper API"}},"continueOnFail":true},{"parameters":{"method":"POST","url":"https://google.serper.dev/search","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"q\\": \\"{{ $json.mainKeyword }}\\",\\n  \\"gl\\": \\"{{ $json.targetCountry || 'tr' }}\\",\\n  \\"hl\\": \\"{{ $json.targetLanguage || 'tr' }}\\",\\n  \\"num\\": 10\\n}","options":{"timeout":30000}},"id":"c22c95f3-481b-4947-a1e9-5c98e0e97652","name":"HTTP - Serper SERP","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,208],"credentials":{"httpHeaderAuth":{"id":"01zZGrP0Fob8kD8r","name":"Serper API"}},"continueOnFail":true},{"parameters":{"jsCode":"const input = $input.first().json;\\nconst projectData = $('Code - Check Project').first().json;\\nconst projectId = projectData.projectId;\\n\\nlet serpData = {\\n  project_id: projectId,\\n  has_featured_snippet: false,\\n  featured_snippet_type: 'none',\\n  featured_snippet_content: null,\\n  featured_snippet_url: null,\\n  has_paa: false,\\n  paa_count: 0,\\n  has_video_results: false,\\n  has_image_pack: false,\\n  has_local_pack: false,\\n  has_knowledge_panel: false,\\n  has_shopping_results: false,\\n  has_news_results: false,\\n  organic_results_count: 10,\\n  ads_count: 0,\\n  zero_click_risk: 'low',\\n  paa_questions: [],\\n  source: 'ahrefs'\\n};\\n\\nif (!input || input.error) {\\n  return [{ json: { ...serpData, source: 'ahrefs_failed' } }];\\n}\\n\\nconst serp = input.serp || input;\\nserpData.has_featured_snippet = !!serp.featured_snippet;\\nif (serp.featured_snippet) {\\n  serpData.featured_snippet_type = serp.featured_snippet.type || 'paragraph';\\n  serpData.featured_snippet_content = serp.featured_snippet.content || null;\\n  serpData.featured_snippet_url = serp.featured_snippet.url || null;\\n}\\n\\nserpData.has_paa = Array.isArray(serp.people_also_ask) && serp.people_also_ask.length > 0;\\nserpData.paa_count = serp.people_also_ask?.length || 0;\\nserpData.has_video_results = Array.isArray(serp.video_results) && serp.video_results.length > 0;\\nserpData.has_image_pack = !!serp.image_pack;\\nserpData.has_local_pack = !!serp.local_pack;\\nserpData.has_knowledge_panel = !!serp.knowledge_panel;\\nserpData.organic_results_count = serp.organic?.length || 10;\\nserpData.ads_count = serp.ads?.length || 0;\\n\\nlet riskScore = 0;\\nif (serpData.has_featured_snippet) riskScore += 2;\\nif (serpData.has_knowledge_panel) riskScore += 2;\\nif (serpData.paa_count > 3) riskScore += 1;\\nserpData.zero_click_risk = riskScore >= 4 ? 'high' : riskScore >= 2 ? 'medium' : 'low';\\n\\nserpData.paa_questions = (serp.people_also_ask || []).map((paa, idx) => ({\\n  question: paa.question || paa,\\n  answer_snippet: paa.snippet || null,\\n  source_url: paa.url || null,\\n  source_domain: paa.domain || null,\\n  position: idx + 1\\n}));\\n\\nreturn [{ json: serpData }];"},"id":"3710f1fc-8e1c-49d9-ac5d-e174a776da76","name":"Code - Transform Ahrefs","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"jsCode":"const input = $input.first().json;\\nconst projectData = $('Code - Check Project').first().json;\\nconst projectId = projectData.projectId;\\nconst keyword = projectData.mainKeyword;\\n\\nlet serpData = {\\n  project_id: projectId,\\n  has_featured_snippet: false,\\n  featured_snippet_type: 'none',\\n  featured_snippet_content: null,\\n  featured_snippet_url: null,\\n  has_paa: false,\\n  paa_count: 0,\\n  has_video_results: false,\\n  has_image_pack: false,\\n  has_local_pack: false,\\n  has_knowledge_panel: false,\\n  has_shopping_results: false,\\n  has_news_results: false,\\n  organic_results_count: 10,\\n  ads_count: 0,\\n  zero_click_risk: 'low',\\n  paa_questions: [],\\n  source: 'serper'\\n};\\n\\nif (!input || input.error) {\\n  serpData.source = 'serper_failed';\\n  return [{ json: serpData }];\\n}\\n\\n// Parse Serper response\\nif (input.answerBox) {\\n  serpData.has_featured_snippet = true;\\n  serpData.featured_snippet_type = input.answerBox.snippetType || 'paragraph';\\n  serpData.featured_snippet_content = input.answerBox.snippet || input.answerBox.answer || null;\\n  serpData.featured_snippet_url = input.answerBox.link || null;\\n}\\n\\nif (input.peopleAlsoAsk && input.peopleAlsoAsk.length > 0) {\\n  serpData.has_paa = true;\\n  serpData.paa_count = input.peopleAlsoAsk.length;\\n  serpData.paa_questions = input.peopleAlsoAsk.map((paa, idx) => ({\\n    question: paa.question,\\n    answer_snippet: paa.snippet || null,\\n    source_url: paa.link || null,\\n    source_domain: paa.link ? paa.link.match(/https?:\\\\/\\\\/([^\\\\/]+)/)?.[1] : null,\\n    position: idx + 1\\n  }));\\n}\\n\\nserpData.has_video_results = !!(input.videos && input.videos.length > 0);\\nserpData.has_image_pack = !!(input.images && input.images.length > 0);\\nserpData.has_local_pack = !!(input.places && input.places.length > 0);\\nserpData.has_knowledge_panel = !!input.knowledgeGraph;\\nserpData.has_shopping_results = !!(input.shopping && input.shopping.length > 0);\\nserpData.has_news_results = !!(input.news && input.news.length > 0);\\nserpData.organic_results_count = input.organic?.length || 10;\\nserpData.ads_count = input.ads?.length || 0;\\n\\nlet riskScore = 0;\\nif (serpData.has_featured_snippet) riskScore += 2;\\nif (serpData.has_knowledge_panel) riskScore += 2;\\nif (serpData.paa_count > 3) riskScore += 1;\\nif (serpData.ads_count > 2) riskScore += 1;\\nserpData.zero_click_risk = riskScore >= 4 ? 'high' : riskScore >= 2 ? 'medium' : 'low';\\n\\nreturn [{ json: serpData }];"},"id":"8802ce58-bb1f-4122-88ce-1c24ea0914b2","name":"Code - Transform Serper","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,208]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO serp_features (project_id, has_featured_snippet, featured_snippet_type, featured_snippet_content, featured_snippet_url, has_paa, paa_count, has_video_results, has_image_pack, has_local_pack, has_knowledge_panel, has_shopping_results, has_news_results, organic_results_count, ads_count, zero_click_risk) VALUES ({{ $json.project_id }}, {{ $json.has_featured_snippet ? 1 : 0 }}, '{{ $json.featured_snippet_type }}', {{ $json.featured_snippet_content ? \\"'\\" + $json.featured_snippet_content.replace(/'/g, \\"''\\").substring(0, 500) + \\"'\\" : 'NULL' }}, {{ $json.featured_snippet_url ? \\"'\\" + $json.featured_snippet_url + \\"'\\" : 'NULL' }}, {{ $json.has_paa ? 1 : 0 }}, {{ $json.paa_count }}, {{ $json.has_video_results ? 1 : 0 }}, {{ $json.has_image_pack ? 1 : 0 }}, {{ $json.has_local_pack ? 1 : 0 }}, {{ $json.has_knowledge_panel ? 1 : 0 }}, {{ $json.has_shopping_results ? 1 : 0 }}, {{ $json.has_news_results ? 1 : 0 }}, {{ $json.organic_results_count }}, {{ $json.ads_count }}, '{{ $json.zero_click_risk }}') ON DUPLICATE KEY UPDATE has_featured_snippet = VALUES(has_featured_snippet), featured_snippet_type = VALUES(featured_snippet_type), featured_snippet_content = VALUES(featured_snippet_content), featured_snippet_url = VALUES(featured_snippet_url), has_paa = VALUES(has_paa), paa_count = VALUES(paa_count), has_video_results = VALUES(has_video_results), has_image_pack = VALUES(has_image_pack), has_local_pack = VALUES(has_local_pack), has_knowledge_panel = VALUES(has_knowledge_panel), has_shopping_results = VALUES(has_shopping_results), has_news_results = VALUES(has_news_results), organic_results_count = VALUES(organic_results_count), ads_count = VALUES(ads_count), zero_click_risk = VALUES(zero_click_risk), analyzed_at = NOW()","options":{}},"id":"8259a4be-50b7-4703-97ca-e09adae3ad9e","name":"MySQL - Save SERP Features","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[448,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"const serpData = $('Code - Transform Serper').all()[0]?.json || $('Code - Transform Ahrefs').all()[0]?.json;\\nif (!serpData) {\\n  return [{ json: { skip_paa: true, paa_count: 0 } }];\\n}\\n\\nconst projectId = serpData.project_id;\\nconst paaQuestions = serpData.paa_questions || [];\\n\\nif (paaQuestions.length === 0) {\\n  return [{ json: { project_id: projectId, skip_paa: true, paa_count: 0 } }];\\n}\\n\\nreturn paaQuestions.map((paa, idx) => ({\\n  json: {\\n    project_id: projectId,\\n    question: (paa.question || '').replace(/'/g, \\"''\\").substring(0, 500),\\n    answer_snippet: paa.answer_snippet ? paa.answer_snippet.replace(/'/g, \\"''\\").substring(0, 1000) : null,\\n    source_url: paa.source_url || null,\\n    source_domain: paa.source_domain || null,\\n    position: paa.position || idx + 1,\\n    is_recommended_as_h2: idx < 2 ? 1 : 0,\\n    is_recommended_as_h3: idx >= 2 ? 1 : 0,\\n    relevance_score: (100 - (idx * 10)).toFixed(2)\\n  }\\n}));"},"id":"f08f6e3b-4a25-4fd1-97b8-1be3021d36e6","name":"Code - Split PAA","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"has-paa","leftValue":"={{ $json.skip_paa }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"cd686630-75a5-4618-959e-cbb79dbd8417","name":"IF - Has PAA","type":"n8n-nodes-base.if","typeVersion":2,"position":[880,112]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO paa_data (project_id, question, answer_snippet, source_url, source_domain, position, is_recommended_as_h2, is_recommended_as_h3, relevance_score) VALUES ({{ $json.project_id }}, '{{ $json.question }}', {{ $json.answer_snippet ? \\"'\\" + $json.answer_snippet + \\"'\\" : 'NULL' }}, {{ $json.source_url ? \\"'\\" + $json.source_url + \\"'\\" : 'NULL' }}, {{ $json.source_domain ? \\"'\\" + $json.source_domain + \\"'\\" : 'NULL' }}, {{ $json.position }}, {{ $json.is_recommended_as_h2 }}, {{ $json.is_recommended_as_h3 }}, {{ $json.relevance_score }}) ON DUPLICATE KEY UPDATE answer_snippet = VALUES(answer_snippet), source_url = VALUES(source_url), source_domain = VALUES(source_domain)","options":{}},"id":"64f9ab2d-8a51-4ffc-a2b6-beb653be9c6f","name":"MySQL - Save PAA","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1104,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"const serpData = $('Code - Transform Serper').all()[0]?.json || $('Code - Transform Ahrefs').all()[0]?.json || {};\\nconst paaCount = serpData.paa_questions?.length || 0;\\n\\nconst warnings = [];\\nif (!serpData.has_paa) warnings.push('Bu arama icin PAA (People Also Ask) bulunamadi');\\nif (!serpData.has_featured_snippet) warnings.push('Bu arama icin Featured Snippet bulunamadi');\\nif (!serpData.has_knowledge_panel) warnings.push('Bu arama icin Knowledge Panel bulunamadi');\\n\\nreturn [{\\n  json: {\\n    success: true,\\n    message: warnings.length > 0 ? 'SERP analizi tamamlandi (bazi ozellikler bulunamadi)' : 'SERP features detected successfully',\\n    project_id: serpData.project_id,\\n    serp_features: {\\n      has_featured_snippet: serpData.has_featured_snippet || false,\\n      featured_snippet_type: serpData.featured_snippet_type || 'none',\\n      has_paa: serpData.has_paa || false,\\n      paa_count: serpData.paa_count || 0,\\n      has_video_results: serpData.has_video_results || false,\\n      has_image_pack: serpData.has_image_pack || false,\\n      has_local_pack: serpData.has_local_pack || false,\\n      has_knowledge_panel: serpData.has_knowledge_panel || false,\\n      has_shopping_results: serpData.has_shopping_results || false,\\n      has_news_results: serpData.has_news_results || false,\\n      zero_click_risk: serpData.zero_click_risk || 'low'\\n    },\\n    paa_questions_saved: paaCount,\\n    warnings: warnings,\\n    source: serpData.source || 'unknown'\\n  }\\n}];"},"id":"30036c4d-50c2-4744-9686-450ceef1c83f","name":"Code - Prepare Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1328,112]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"a2e2f100-6a01-473d-97b6-c9507c2e24f8","name":"Respond - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1552,112]}]	{"Webhook":{"main":[[{"node":"Code - Validate Input","type":"main","index":0}]]},"Code - Validate Input":{"main":[[{"node":"IF - Valid Input","type":"main","index":0}]]},"IF - Valid Input":{"main":[[{"node":"MySQL - Get Project","type":"main","index":0}],[{"node":"Respond - Validation Error","type":"main","index":0}]]},"MySQL - Get Project":{"main":[[{"node":"Code - Check Project","type":"main","index":0}]]},"Code - Check Project":{"main":[[{"node":"IF - Project Exists","type":"main","index":0}]]},"IF - Project Exists":{"main":[[{"node":"Switch - API Source","type":"main","index":0}],[{"node":"Respond - Not Found","type":"main","index":0}]]},"Switch - API Source":{"main":[[{"node":"HTTP - Ahrefs SERP","type":"main","index":0}],[{"node":"HTTP - Serper SERP","type":"main","index":0}]]},"HTTP - Ahrefs SERP":{"main":[[{"node":"Code - Transform Ahrefs","type":"main","index":0}]]},"HTTP - Serper SERP":{"main":[[{"node":"Code - Transform Serper","type":"main","index":0}]]},"Code - Transform Ahrefs":{"main":[[{"node":"MySQL - Save SERP Features","type":"main","index":0}]]},"Code - Transform Serper":{"main":[[{"node":"MySQL - Save SERP Features","type":"main","index":0}]]},"MySQL - Save SERP Features":{"main":[[{"node":"Code - Split PAA","type":"main","index":0}]]},"Code - Split PAA":{"main":[[{"node":"IF - Has PAA","type":"main","index":0}]]},"IF - Has PAA":{"main":[[{"node":"MySQL - Save PAA","type":"main","index":0}],[{"node":"Code - Prepare Response","type":"main","index":0}]]},"MySQL - Save PAA":{"main":[[{"node":"Code - Prepare Response","type":"main","index":0}]]},"Code - Prepare Response":{"main":[[{"node":"Respond - Success","type":"main","index":0}]]}}	Version 47de4265	f	
c6ba8c4f-fe4b-4ac8-9751-938e63afe4ee	S0zn4vyawwOhLuuO	Fatih Berkay Baheci	2025-12-17 10:30:14.926+00	2025-12-17 10:30:17.116+00	[{"parameters":{"path":":projectId/export","responseMode":"responseNode","options":{}},"id":"3a9f788c-3d32-4a06-974c-44fa31f66ef0","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-2416,112],"webhookId":"tool1-report-exporter"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Input validation\\nconst projectId = $json.params?.projectId;\\nconst format = $json.query?.format || 'json'; // json, csv, html\\n\\nif (!projectId) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'projectId parametresi zorunludur',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nconst parsedId = parseInt(projectId);\\nif (isNaN(parsedId) || parsedId <= 0) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'projectId gecerli bir pozitif sayi olmalidir',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nconst validFormats = ['json', 'csv', 'html'];\\nif (!validFormats.includes(format)) {\\n  return {\\n    json: {\\n      isValid: false,\\n      error: 'Gecersiz format. Gecerli degerler: json, csv, html',\\n      errorCode: 400\\n    }\\n  };\\n}\\n\\nreturn {\\n  json: {\\n    isValid: true,\\n    projectId: parsedId,\\n    format: format\\n  }\\n};"},"id":"15e9c313-0ce6-46bf-9e2c-4e529ff74eac","name":"Code - Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2208,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"8b575e0b-692f-4c9c-b5ea-0bb52ceee8a3","name":"IF - Valid Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1984,112]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Validation failed\\",\\n  \\"message\\": \\"{{ $json.error }}\\"\\n}","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"9921213e-16c3-46d4-b181-d4e62c757db8","name":"Respond - Validation Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-1760,304]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  kp.*,\\n  c.name as client_name,\\n  c.domain as client_domain,\\n  c.industry as client_industry\\nFROM keyword_projects kp\\nLEFT JOIN clients c ON kp.client_id = c.id\\nWHERE kp.id = {{ $json.projectId }}\\nLIMIT 1","options":{}},"id":"1523cb24-67a8-485c-af99-1f7218112815","name":"MySQL - Get Project","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1760,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"project-exists","leftValue":"={{ $json.id }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"id":"56a3a716-5bf7-4728-9f5e-72076a90f79c","name":"IF - Project Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1536,112]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": \\"Project not found\\",\\n  \\"message\\": \\"Proje bulunamadi: {{ $('Code - Validate Input').first().json.projectId }}\\"\\n}","options":{"responseCode":404}},"id":"06a43875-7977-4eaa-b2a4-cfbe28fb11d3","name":"Respond - Not Found","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-1328,304]},{"parameters":{"operation":"executeQuery","query":"=SELECT 0 as id, '' as keyword, '' as keyword_type, 0 as search_volume, 0 as keyword_difficulty, 0 as cpc, '' as search_intent, '' as keyword_cluster, '' as parent_topic, 0 as opportunity_score, '' as page_type, '' as content_format, '' as content_priority, 0 as recommended_word_count, '' as source, NULL as created_at UNION ALL SELECT id, keyword, keyword_type, search_volume, keyword_difficulty, cpc, search_intent, keyword_cluster, parent_topic, opportunity_score, page_type, content_format, content_priority, recommended_word_count, source, created_at FROM keyword_results WHERE project_id = {{ $('MySQL - Get Project').first().json.id }} LIMIT 201","options":{}},"id":"c7e32974-abaf-4d1a-a195-78423e3f45a8","name":"MySQL - Get Keywords","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1328,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT 0 as id, '' as competitor_url, '' as competitor_domain, 0 as serp_position, '' as title, '' as meta_description, 0 as word_count, 0 as h1_count, 0 as h2_count, 0 as h3_count, 0 as domain_rating, 0 as backlinks_count, NULL as analyzed_at UNION ALL SELECT id, competitor_url, competitor_domain, serp_position, title, meta_description, word_count, h1_count, h2_count, h3_count, domain_rating, backlinks_count, analyzed_at FROM competitor_data WHERE project_id = {{ $('MySQL - Get Project').first().json.id }} LIMIT 51","options":{}},"id":"615656d3-0ac5-4da2-91bc-53dbd112015d","name":"MySQL - Get Competitors","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1104,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT has_featured_snippet, featured_snippet_type, has_paa, paa_count, has_video_results, has_image_pack, has_local_pack, has_knowledge_panel, zero_click_risk, analyzed_at FROM serp_features WHERE project_id = {{ $('MySQL - Get Project').first().json.id }} UNION ALL SELECT 0, NULL, 0, 0, 0, 0, 0, 0, NULL, NULL LIMIT 1","options":{}},"id":"da44af18-116e-4415-97fb-2ad7df79655f","name":"MySQL - Get SERP Features","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-880,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT 0 as id, '' as question, '' as answer_snippet, '' as source_url, '' as source_domain, 0 as position UNION ALL SELECT id, question, answer_snippet, source_url, source_domain, position FROM paa_data WHERE project_id = {{ $('MySQL - Get Project').first().json.id }} LIMIT 51","options":{}},"id":"f6a1b063-5c4a-4b27-b708-61dd268b89f7","name":"MySQL - Get PAA","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-656,112],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// Tum verileri topla ve rapor olustur\\nconst validatedData = $('Code - Validate Input').first().json;\\nconst format = validatedData.format;\\nconst project = $('MySQL - Get Project').first().json;\\n\\n// Keywords - de-duplicate by id (n8n may duplicate rows per input item)\\nconst keywordItems = $('MySQL - Get Keywords').all();\\nconst seenKeywordIds = new Set();\\nconst keywords = keywordItems.map(i => i.json).filter(k => {\\n  if (!k.id || seenKeywordIds.has(k.id)) return false;\\n  seenKeywordIds.add(k.id);\\n  return true;\\n});\\n\\n// Competitors - de-duplicate by id (n8n duplicates per input item)\\nconst competitorItems = $('MySQL - Get Competitors').all();\\nconst seenCompetitorIds = new Set();\\nconst competitors = competitorItems.map(i => i.json).filter(c => {\\n  if (!c.id || seenCompetitorIds.has(c.id)) return false;\\n  seenCompetitorIds.add(c.id);\\n  return true;\\n});\\n\\n// SERP Features - take first valid result\\nconst serpItems = $('MySQL - Get SERP Features').all();\\nconst serpFeatures = serpItems.find(i => i.json.has_featured_snippet !== undefined)?.json || null;\\n\\n// PAA - de-duplicate by id\\nconst paaItems = $('MySQL - Get PAA').all();\\nconst seenPaaIds = new Set();\\nconst paaData = paaItems.map(i => i.json).filter(p => {\\n  if (!p.id || seenPaaIds.has(p.id)) return false;\\n  seenPaaIds.add(p.id);\\n  return true;\\n});\\n\\n// Filter competitors with valid word count\\nconst competitorsWithWordCount = competitors.filter(c => c.word_count && c.word_count > 0);\\n\\n// ============ STATISTICS ============\\nconst stats = {\\n  total_keywords: keywords.length,\\n  avg_volume: keywords.length > 0 ? Math.round(keywords.reduce((sum, k) => sum + (k.search_volume || 0), 0) / keywords.length) : 0,\\n  avg_difficulty: keywords.length > 0 ? Math.round(keywords.reduce((sum, k) => sum + (k.keyword_difficulty || 0), 0) / keywords.length) : 0,\\n  avg_opportunity_score: keywords.length > 0 ? Math.round(keywords.reduce((sum, k) => sum + (parseFloat(k.opportunity_score) || 0), 0) / keywords.length) : 0,\\n  total_competitors: competitors.length,\\n  avg_competitor_word_count: competitorsWithWordCount.length > 0 ? Math.round(competitorsWithWordCount.reduce((sum, c) => sum + c.word_count, 0) / competitorsWithWordCount.length) : 0,\\n  total_paa_questions: paaData.length\\n};\\n\\n// Priority breakdown\\nconst priorityBreakdown = {\\n  high: keywords.filter(k => k.content_priority === 'high').length,\\n  medium: keywords.filter(k => k.content_priority === 'medium').length,\\n  low: keywords.filter(k => k.content_priority === 'low').length\\n};\\n\\n// Intent distribution\\nconst intentGroups = {};\\nkeywords.forEach(k => {\\n  const intent = k.search_intent || 'unknown';\\n  intentGroups[intent] = (intentGroups[intent] || 0) + 1;\\n});\\n\\n// Content format distribution\\nconst formatGroups = {};\\nkeywords.forEach(k => {\\n  const fmt = k.content_format || 'unassigned';\\n  formatGroups[fmt] = (formatGroups[fmt] || 0) + 1;\\n});\\n\\n// Cluster groups\\nconst clusters = {};\\nkeywords.forEach(k => {\\n  const cluster = k.keyword_cluster || 'Unclustered';\\n  if (!clusters[cluster]) clusters[cluster] = [];\\n  clusters[cluster].push(k.keyword);\\n});\\n\\n// ============ CONTENT PLAN ============\\n// Pillar ve Cluster sayfalar\\nconst pillarPages = keywords.filter(k => k.page_type === 'pillar');\\nconst clusterPages = keywords.filter(k => k.page_type === 'cluster');\\n\\n// Toplam kelime hedefi\\nconst totalWordTarget = keywords.reduce((sum, k) => sum + (k.recommended_word_count || 0), 0);\\n\\n// ncelikli ierik listesi\\nconst highPriorityContent = keywords.filter(k => k.content_priority === 'high').sort((a, b) => (parseFloat(b.opportunity_score) || 0) - (parseFloat(a.opportunity_score) || 0));\\nconst mediumPriorityContent = keywords.filter(k => k.content_priority === 'medium').sort((a, b) => (parseFloat(b.opportunity_score) || 0) - (parseFloat(a.opportunity_score) || 0));\\nconst lowPriorityContent = keywords.filter(k => k.content_priority === 'low').sort((a, b) => (parseFloat(b.opportunity_score) || 0) - (parseFloat(a.opportunity_score) || 0));\\n\\n// Pillar-Cluster haritas\\nconst pillarClusterMap = {};\\npillarPages.forEach(pillar => {\\n  const pillarKeyword = pillar.keyword;\\n  pillarClusterMap[pillarKeyword] = {\\n    pillar: pillar,\\n    clusters: clusterPages.filter(c => c.parent_topic === pillarKeyword || c.keyword_cluster === pillar.keyword_cluster)\\n  };\\n});\\n\\n// Content Plan Summary\\nconst contentPlan = {\\n  total_content_pieces: keywords.filter(k => k.page_type).length,\\n  pillar_pages: pillarPages.length,\\n  cluster_pages: clusterPages.length,\\n  total_word_target: totalWordTarget,\\n  estimated_articles: {\\n    high_priority: highPriorityContent.length,\\n    medium_priority: mediumPriorityContent.length,\\n    low_priority: lowPriorityContent.length\\n  },\\n  content_by_format: formatGroups,\\n  pillar_cluster_map: pillarClusterMap\\n};\\n\\n// ============ CSV GENERATION ============\\n// Keywords CSV\\nconst keywordsCsvHeader = 'ID,Keyword,Type,Volume,Difficulty,CPC,Intent,Cluster,Opportunity Score,Page Type,Content Format,Priority,Word Count';\\nconst keywordsCsvRows = keywords.map(k => \\n  `${k.id},\\"${(k.keyword || '').replace(/\\"/g, '\\"\\"')}\\",\\"${k.keyword_type || ''}\\",${k.search_volume || 0},${k.keyword_difficulty || 0},${k.cpc || 0},\\"${k.search_intent || ''}\\",\\"${(k.keyword_cluster || '').replace(/\\"/g, '\\"\\"')}\\",${k.opportunity_score || 0},\\"${k.page_type || ''}\\",\\"${k.content_format || ''}\\",\\"${k.content_priority || ''}\\",${k.recommended_word_count || 0}`\\n);\\nconst keywordsCsv = keywordsCsvHeader + '\\\\n' + keywordsCsvRows.join('\\\\n');\\n\\n// Competitors CSV\\nconst competitorsCsvHeader = 'ID,URL,Domain,Position,Title,Word Count,H1,H2,H3,DR,Backlinks';\\nconst competitorsCsvRows = competitors.map(c => \\n  `${c.id},\\"${c.competitor_url || ''}\\",\\"${c.competitor_domain || ''}\\",${c.serp_position || 0},\\"${(c.title || '').replace(/\\"/g, '\\"\\"')}\\",${c.word_count || 0},${c.h1_count || 0},${c.h2_count || 0},${c.h3_count || 0},${c.domain_rating || 0},${c.backlinks_count || 0}`\\n);\\nconst competitorsCsv = competitorsCsvHeader + '\\\\n' + competitorsCsvRows.join('\\\\n');\\n\\n// PAA CSV\\nconst paaCsvHeader = 'ID,Question,Answer,Source URL,Source Domain,Position';\\nconst paaCsvRows = paaData.map(p => \\n  `${p.id},\\"${(p.question || '').replace(/\\"/g, '\\"\\"')}\\",\\"${(p.answer_snippet || '').replace(/\\"/g, '\\"\\"')}\\",\\"${p.source_url || ''}\\",\\"${p.source_domain || ''}\\",${p.position || 0}`\\n);\\nconst paaCsv = paaCsvHeader + '\\\\n' + paaCsvRows.join('\\\\n');\\n\\n// Summary CSV\\nconst summaryCsv = `Metric,Value\\nProject Name,\\"${project.project_name}\\"\\nMain Keyword,\\"${project.main_keyword}\\"\\nClient,\\"${project.client_name || 'N/A'}\\"\\nStatus,\\"${project.status}\\"\\nTotal Keywords,${stats.total_keywords}\\nAverage Volume,${stats.avg_volume}\\nAverage Difficulty,${stats.avg_difficulty}\\nAverage Opportunity Score,${stats.avg_opportunity_score}\\nHigh Priority Keywords,${priorityBreakdown.high}\\nMedium Priority Keywords,${priorityBreakdown.medium}\\nLow Priority Keywords,${priorityBreakdown.low}\\nTotal Competitors,${stats.total_competitors}\\nAvg Competitor Word Count,${stats.avg_competitor_word_count}\\nTotal PAA Questions,${stats.total_paa_questions}\\nGenerated At,\\"${new Date().toISOString()}\\"`;\\n\\n// ============ HTML REPORT (for PDF) ============\\nconst topKeywords = keywords.slice(0, 20);\\nconst topKeywordsHtml = topKeywords.map(k => \\n  `<tr><td>${k.keyword}</td><td>${k.search_volume || 0}</td><td>${k.keyword_difficulty || 0}</td><td>${k.opportunity_score || 0}</td><td>${k.content_priority || '-'}</td><td>${k.content_format || '-'}</td></tr>`\\n).join('');\\n\\nconst competitorsHtml = competitors.slice(0, 10).map(c => \\n  `<tr><td>${c.competitor_domain || ''}</td><td>${c.serp_position || ''}</td><td>${c.word_count || 0}</td><td>${c.domain_rating || 0}</td><td>${c.backlinks_count || 0}</td></tr>`\\n).join('');\\n\\nconst paaHtml = paaData.slice(0, 10).map(p => \\n  `<tr><td>${p.question || ''}</td><td>${(p.answer_snippet || '').substring(0, 100)}...</td></tr>`\\n).join('');\\n\\n// ============ MODERN HTML REPORT ============\\n// Calculate percentages for charts\\nconst totalWithPriority = priorityBreakdown.high + priorityBreakdown.medium + priorityBreakdown.low;\\nconst highPct = totalWithPriority > 0 ? Math.round((priorityBreakdown.high / totalWithPriority) * 100) : 0;\\nconst mediumPct = totalWithPriority > 0 ? Math.round((priorityBreakdown.medium / totalWithPriority) * 100) : 0;\\nconst lowPct = totalWithPriority > 0 ? Math.round((priorityBreakdown.low / totalWithPriority) * 100) : 0;\\n\\n// Intent percentages\\nconst intentEntries = Object.entries(intentGroups).sort((a, b) => b[1] - a[1]);\\nconst maxIntent = intentEntries.length > 0 ? intentEntries[0][1] : 1;\\n\\n// Format percentages\\nconst formatEntries = Object.entries(formatGroups).filter(([k]) => k !== 'unassigned').sort((a, b) => b[1] - a[1]);\\nconst maxFormat = formatEntries.length > 0 ? formatEntries[0][1] : 1;\\n\\n// Top keywords for table\\nconst topKwList = keywords.slice(0, 25);\\n\\n// High priority content\\nconst highPrioList = highPriorityContent.slice(0, 10);\\nconst medPrioList = mediumPriorityContent.slice(0, 5);\\n\\n// Pillar-cluster structure\\nconst pillarEntries = Object.entries(pillarClusterMap);\\n\\n// Competitor stats\\nconst topCompetitors = competitors.slice(0, 10);\\nconst avgWordCount = stats.avg_competitor_word_count;\\nconst maxWordCount = competitorsWithWordCount.length > 0 ? Math.max(...competitorsWithWordCount.map(c => c.word_count)) : 0;\\nconst minWordCount = competitorsWithWordCount.length > 0 ? Math.min(...competitorsWithWordCount.map(c => c.word_count)) : 0;\\n\\nconst htmlReport = `<!DOCTYPE html>\\n<html lang=\\"tr\\">\\n<head>\\n  <meta charset=\\"UTF-8\\">\\n  <title>${project.project_name} - SEO Raporu</title>\\n  <style>\\n    *{margin:0;padding:0;box-sizing:border-box}\\n    body{font-family:system-ui,sans-serif;font-size:14px;color:#333;padding:40px;max-width:1100px;margin:0 auto;background:#fff}\\n    h1{font-size:24px;color:#1a1a2e;margin-bottom:8px}\\n    h2{font-size:16px;color:#16213e;margin:32px 0 16px;padding-bottom:8px;border-bottom:2px solid #e94560}\\n    .meta{color:#666;font-size:13px;margin-bottom:32px}\\n    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}\\n    .box{background:#f8f9fa;border-radius:8px;padding:20px;text-align:center}\\n    .box .num{font-size:28px;font-weight:700;color:#e94560}\\n    .box .lbl{font-size:11px;color:#666;text-transform:uppercase;margin-top:4px}\\n    table{width:100%;border-collapse:collapse;margin-bottom:24px}\\n    th{background:#1a1a2e;color:#fff;padding:12px;text-align:left;font-size:12px;text-transform:uppercase}\\n    td{padding:10px 12px;border-bottom:1px solid #eee}\\n    tr:hover{background:#f8f9fa}\\n    .tag{display:inline-block;padding:3px 8px;border-radius:4px;font-size:11px;font-weight:600}\\n    .tag-high{background:#d4edda;color:#155724}\\n    .tag-med{background:#fff3cd;color:#856404}\\n    .tag-low{background:#f8d7da;color:#721c24}\\n    .tag-info{background:#e7f1ff;color:#004085}\\n    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:24px}\\n    .bar{display:flex;align-items:center;margin-bottom:8px}\\n    .bar-label{width:100px;font-size:12px;color:#666}\\n    .bar-track{flex:1;height:20px;background:#eee;border-radius:4px;overflow:hidden}\\n    .bar-fill{height:100%;background:linear-gradient(90deg,#e94560,#1a1a2e);border-radius:4px}\\n    .bar-val{width:40px;text-align:right;font-size:12px;font-weight:600}\\n    .footer{margin-top:40px;padding-top:20px;border-top:1px solid #eee;text-align:center;color:#999;font-size:12px}\\n    @media print{body{padding:20px}h2{break-before:auto}}\\n  </style>\\n</head>\\n<body>\\n  <h1>${project.project_name}</h1>\\n  <div class=\\"meta\\">Ana Keyword: <strong>${project.main_keyword}</strong> | Musteri: ${project.client_name || '-'} | ${new Date().toLocaleDateString('tr-TR')}</div>\\n  \\n  <div class=\\"grid\\">\\n    <div class=\\"box\\"><div class=\\"num\\">${stats.total_keywords}</div><div class=\\"lbl\\">Keyword</div></div>\\n    <div class=\\"box\\"><div class=\\"num\\">${contentPlan.pillar_pages}</div><div class=\\"lbl\\">Pillar</div></div>\\n    <div class=\\"box\\"><div class=\\"num\\">${contentPlan.cluster_pages}</div><div class=\\"lbl\\">Cluster</div></div>\\n    <div class=\\"box\\"><div class=\\"num\\">${Math.round(totalWordTarget/1000)}K</div><div class=\\"lbl\\">Kelime Hedef</div></div>\\n  </div>\\n\\n  <div class=\\"two-col\\">\\n    <div>\\n      <h2>Oncelik Dagilimi</h2>\\n      <div class=\\"bar\\"><div class=\\"bar-label\\">Yuksek</div><div class=\\"bar-track\\"><div class=\\"bar-fill\\" style=\\"width:${highPct}%\\"></div></div><div class=\\"bar-val\\">${priorityBreakdown.high}</div></div>\\n      <div class=\\"bar\\"><div class=\\"bar-label\\">Orta</div><div class=\\"bar-track\\"><div class=\\"bar-fill\\" style=\\"width:${mediumPct}%;background:#f59e0b\\"></div></div><div class=\\"bar-val\\">${priorityBreakdown.medium}</div></div>\\n      <div class=\\"bar\\"><div class=\\"bar-label\\">Dusuk</div><div class=\\"bar-track\\"><div class=\\"bar-fill\\" style=\\"width:${lowPct}%;background:#94a3b8\\"></div></div><div class=\\"bar-val\\">${priorityBreakdown.low}</div></div>\\n    </div>\\n    <div>\\n      <h2>Intent Dagilimi</h2>\\n      ${intentEntries.slice(0,4).map(([i,c])=>`<div class=\\"bar\\"><div class=\\"bar-label\\">${i}</div><div class=\\"bar-track\\"><div class=\\"bar-fill\\" style=\\"width:${Math.round(c/maxIntent*100)}%\\"></div></div><div class=\\"bar-val\\">${c}</div></div>`).join('')}\\n    </div>\\n  </div>\\n\\n  <h2>Oncelikli Icerikler</h2>\\n  <table>\\n    <tr><th>#</th><th>Keyword</th><th>Format</th><th>Kelime</th><th>Firsat</th><th>Oncelik</th></tr>\\n    ${highPrioList.concat(medPrioList).slice(0,12).map((k,i)=>`<tr><td>${i+1}</td><td><strong>${k.keyword}</strong></td><td>${k.content_format||'-'}</td><td>${k.recommended_word_count||'-'}</td><td>${k.opportunity_score||0}</td><td><span class=\\"tag ${k.content_priority==='high'?'tag-high':'tag-med'}\\">${k.content_priority||'-'}</span></td></tr>`).join('')}\\n  </table>\\n\\n  ${pillarEntries.length>0?`<h2>Pillar-Cluster Yapisi</h2>\\n  <table>\\n    <tr><th>Pillar</th><th>Cluster Sayisi</th><th>Cluster Keywordler</th></tr>\\n    ${pillarEntries.slice(0,5).map(([kw,d])=>`<tr><td><strong>${kw}</strong></td><td>${d.clusters.length}</td><td>${d.clusters.slice(0,4).map(c=>c.keyword).join(', ')}${d.clusters.length>4?' ...':''}</td></tr>`).join('')}\\n  </table>`:''}\\n\\n  ${topCompetitors.length>0?`<h2>Rakip Analizi</h2>\\n  <div class=\\"grid\\" style=\\"grid-template-columns:repeat(3,1fr);margin-bottom:16px\\">\\n    <div class=\\"box\\"><div class=\\"num\\">${avgWordCount}</div><div class=\\"lbl\\">Ort. Kelime</div></div>\\n    <div class=\\"box\\"><div class=\\"num\\">${maxWordCount}</div><div class=\\"lbl\\">Max</div></div>\\n    <div class=\\"box\\"><div class=\\"num\\">${minWordCount}</div><div class=\\"lbl\\">Min</div></div>\\n  </div>\\n  <table>\\n    <tr><th>Sira</th><th>Domain</th><th>Kelime</th><th>DR</th></tr>\\n    ${topCompetitors.slice(0,5).map(c=>`<tr><td><span class=\\"tag tag-info\\">#${c.serp_position||'-'}</span></td><td>${c.competitor_domain||'-'}</td><td>${c.word_count||0}</td><td>${c.domain_rating||0}</td></tr>`).join('')}\\n  </table>`:''}\\n\\n  <h2>Keyword Listesi</h2>\\n  <table>\\n    <tr><th>Keyword</th><th>Intent</th><th>Firsat</th><th>Oncelik</th><th>Format</th></tr>\\n    ${topKwList.slice(0,20).map(k=>`<tr><td>${k.keyword}</td><td>${k.search_intent||'-'}</td><td><strong>${k.opportunity_score||0}</strong></td><td><span class=\\"tag ${k.content_priority==='high'?'tag-high':k.content_priority==='medium'?'tag-med':'tag-low'}\\">${k.content_priority||'-'}</span></td><td>${k.content_format||'-'}</td></tr>`).join('')}\\n  </table>\\n\\n  <div class=\\"footer\\">SEOART Content Studio | ${new Date().toLocaleString('tr-TR')}</div>\\n</body>\\n</html>`;\\n\\n// ============ RETURN BASED ON FORMAT ============\\nreturn [{\\n  json: {\\n    format: format,\\n    project: {\\n      id: project.id,\\n      name: project.project_name,\\n      main_keyword: project.main_keyword,\\n      client_name: project.client_name,\\n      client_domain: project.client_domain,\\n      status: project.status,\\n      target_country: project.target_country,\\n      target_language: project.target_language\\n    },\\n    statistics: stats,\\n    priority_breakdown: priorityBreakdown,\\n    intent_distribution: intentGroups,\\n    content_format_distribution: formatGroups,\\n    clusters: clusters,\\n    content_plan: contentPlan,\\n    serp_features: serpFeatures,\\n    csv_exports: {\\n      summary: summaryCsv,\\n      keywords: keywordsCsv,\\n      competitors: competitorsCsv,\\n      paa: paaCsv\\n    },\\n    html_report: htmlReport,\\n    raw_data: {\\n      keywords: keywords,\\n      competitors: competitors,\\n      paa_questions: paaData\\n    },\\n    generated_at: new Date().toISOString()\\n  }\\n}];"},"id":"1f78c1f9-f824-41c5-b47b-6a4aea384dff","name":"Code - Prepare Report","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-html","leftValue":"={{ $json.format }}","rightValue":"html","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"c7562643-2fac-4c55-ac98-bdfd9e06168d","name":"IF - HTML Format","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"respondWith":"text","responseBody":"={{ $json.html_report }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"text/html; charset=utf-8"}]}}},"id":"6b621cb7-e30e-4c49-87af-f90982e312a4","name":"Respond - HTML","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[0,0]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"is-csv","leftValue":"={{ $json.format }}","rightValue":"csv","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"f31dca35-da22-44ba-8140-e5cacd80e194","name":"IF - CSV Format","type":"n8n-nodes-base.if","typeVersion":2,"position":[0,208]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"format\\": \\"csv\\",\\n  \\"project\\": {{ JSON.stringify($json.project) }},\\n  \\"files\\": {\\n    \\"summary.csv\\": {{ JSON.stringify($json.csv_exports.summary) }},\\n    \\"keywords.csv\\": {{ JSON.stringify($json.csv_exports.keywords) }},\\n    \\"competitors.csv\\": {{ JSON.stringify($json.csv_exports.competitors) }},\\n    \\"paa.csv\\": {{ JSON.stringify($json.csv_exports.paa) }}\\n  },\\n  \\"generated_at\\": \\"{{ $json.generated_at }}\\"\\n}","options":{}},"id":"b2f3b65d-d87c-451c-b5eb-ac2c02a582a5","name":"Respond - CSV","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[224,112]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"format\\": \\"json\\",\\n  \\"project\\": {{ JSON.stringify($json.project) }},\\n  \\"statistics\\": {{ JSON.stringify($json.statistics) }},\\n  \\"priority_breakdown\\": {{ JSON.stringify($json.priority_breakdown) }},\\n  \\"intent_distribution\\": {{ JSON.stringify($json.intent_distribution) }},\\n  \\"content_format_distribution\\": {{ JSON.stringify($json.content_format_distribution) }},\\n  \\"clusters\\": {{ JSON.stringify($json.clusters) }},\\n  \\"content_plan\\": {{ JSON.stringify($json.content_plan) }},\\n  \\"serp_features\\": {{ JSON.stringify($json.serp_features) }},\\n  \\"raw_data\\": {{ JSON.stringify($json.raw_data) }},\\n  \\"csv_exports\\": {{ JSON.stringify($json.csv_exports) }},\\n  \\"html_report\\": {{ JSON.stringify($json.html_report) }},\\n  \\"generated_at\\": \\"{{ $json.generated_at }}\\"\\n}","options":{}},"id":"a2c61194-0174-406e-9dca-84904f3de44a","name":"Respond - JSON","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[224,304]}]	{"Webhook":{"main":[[{"node":"Code - Validate Input","type":"main","index":0}]]},"Code - Validate Input":{"main":[[{"node":"IF - Valid Input","type":"main","index":0}]]},"IF - Valid Input":{"main":[[{"node":"MySQL - Get Project","type":"main","index":0}],[{"node":"Respond - Validation Error","type":"main","index":0}]]},"MySQL - Get Project":{"main":[[{"node":"IF - Project Exists","type":"main","index":0}]]},"IF - Project Exists":{"main":[[{"node":"MySQL - Get Keywords","type":"main","index":0}],[{"node":"Respond - Not Found","type":"main","index":0}]]},"MySQL - Get Keywords":{"main":[[{"node":"MySQL - Get Competitors","type":"main","index":0}]]},"MySQL - Get Competitors":{"main":[[{"node":"MySQL - Get SERP Features","type":"main","index":0}]]},"MySQL - Get SERP Features":{"main":[[{"node":"MySQL - Get PAA","type":"main","index":0}]]},"MySQL - Get PAA":{"main":[[{"node":"Code - Prepare Report","type":"main","index":0}]]},"Code - Prepare Report":{"main":[[{"node":"IF - HTML Format","type":"main","index":0}]]},"IF - HTML Format":{"main":[[{"node":"Respond - HTML","type":"main","index":0}],[{"node":"IF - CSV Format","type":"main","index":0}]]},"IF - CSV Format":{"main":[[{"node":"Respond - CSV","type":"main","index":0}],[{"node":"Respond - JSON","type":"main","index":0}]]}}	Version c6ba8c4f	f	
73230155-b208-43c1-9cee-280a6e4ebac1	s7JHrKu0WDrkbkzw	Fatih Berkay Baheci	2025-12-17 10:32:00.99+00	2025-12-17 10:32:02.485+00	[{"parameters":{"httpMethod":"POST","path":"log-tokens","responseMode":"lastNode","options":{}},"id":"a8967647-5034-423d-a4b1-98478e2ebaa4","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"token-logger"},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO api_usage_tracking (client_id, tool_name, project_id, workflow_name, api_provider, model_name, tokens_input, tokens_output, api_calls, cost_usd, response_time_ms, was_successful, error_message) VALUES ({{ $json.client_id || 0 }}, '{{ $json.tool_name || 'other' }}', {{ $json.project_id || 'NULL' }}, '{{ $json.workflow_name || '' }}', '{{ $json.api_provider || 'google' }}', '{{ $json.model_name || '' }}', {{ $json.tokens_input || 0 }}, {{ $json.tokens_output || 0 }}, 1, {{ $json.cost_usd || 0 }}, {{ $json.response_time_ms || 0 }}, {{ $json.was_successful ? 1 : 0 }}, {{ $json.error_message ? \\"'\\" + $json.error_message.replace(/'/g, \\"''\\") + \\"'\\" : 'NULL' }})","options":{}},"id":"26978034-79e9-418a-8b3d-fc07269f2a39","name":"MySQL - Log Token Usage","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"return { success: true, logged: true };"},"id":"05c686b6-fd0d-46f8-a79f-92155b35ee3f","name":"Code - Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]}]	{"Webhook":{"main":[[{"node":"MySQL - Log Token Usage","type":"main","index":0}]]},"MySQL - Log Token Usage":{"main":[[{"node":"Code - Response","type":"main","index":0}]]}}	Version 73230155	f	
41b2d0c6-e47c-47fc-98ba-d3cb742389f0	IGWk6RXq1AHpB4L1	Fatih Berkay Baheci	2025-12-18 12:05:21.736+00	2025-12-18 12:05:23.674+00	[{"parameters":{"httpMethod":"POST","path":"sheets-get-columns","responseMode":"responseNode","options":{}},"id":"webhook","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"sheets-get-columns"},{"parameters":{"documentId":{"__rl":true,"mode":"id","value":"={{ $json.body.spreadsheet_id }}"},"sheetName":{"__rl":true,"mode":"name","value":"={{ $json.body.sheet_name }}"},"options":{}},"id":"read-headers","name":"Read Headers","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[224,0],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const row = $json;\\nconst columns = [];\\nlet colIndex = 0;\\nfor (const [key, value] of Object.entries(row)) {\\n  if (key !== 'row_number') {\\n    const letter = String.fromCharCode(65 + colIndex);\\n    columns.push({ letter, header: value || '' });\\n    colIndex++;\\n  }\\n}\\nreturn { json: { success: true, columns } };"},"id":"format","name":"Format","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"respond","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,0]}]	{"Webhook":{"main":[[{"node":"Read Headers","type":"main","index":0}]]},"Read Headers":{"main":[[{"node":"Format","type":"main","index":0}]]},"Format":{"main":[[{"node":"Respond","type":"main","index":0}]]}}	Version 41b2d0c6	f	
d567b778-8181-432e-80b2-e2aae9143edc	fkgU1ClgOCaGeuXR	Fatih Berkay Baheci	2025-12-18 12:05:31.696+00	2025-12-18 12:05:33.64+00	[{"parameters":{"httpMethod":"POST","path":"sheets-check","responseMode":"responseNode","options":{}},"id":"webhook","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"sheets-check"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const body = $json.body || {};\\nconst mappings = body.column_mappings || {};\\nconst startRow = body.start_row || 2;\\n\\n// Get first mapped column (usually 'keyword' -> 'A')\\nconst firstCol = Object.values(mappings)[0] || 'A';\\nconst range = `${firstCol}${startRow}:${firstCol}`;\\n\\nreturn { json: { \\n  spreadsheet_id: body.spreadsheet_id,\\n  sheet_name: body.sheet_name,\\n  range,\\n  start_row: startRow\\n}};"},"id":"prepare","name":"Prepare","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"documentId":{"__rl":true,"mode":"id","value":"={{ $json.spreadsheet_id }}"},"sheetName":{"__rl":true,"mode":"name","value":"={{ $json.sheet_name }}"},"options":{}},"id":"read-data","name":"Read Data","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[448,0],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}},"onError":"continueErrorOutput"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const items = $input.all();\\nconst rowCount = items.length;\\nconst hasData = rowCount > 0 && Object.keys(items[0].json || {}).length > 1;\\nconst startRow = $('Prepare').item.json.start_row;\\n\\nreturn { json: {\\n  success: true,\\n  has_existing_data: hasData,\\n  existing_row_count: hasData ? rowCount : 0,\\n  first_empty_row: hasData ? startRow + rowCount : startRow\\n}};"},"id":"analyze","name":"Analyze","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,-64]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const startRow = $('Prepare').item.json.start_row;\\nreturn { json: {\\n  success: true,\\n  has_existing_data: false,\\n  existing_row_count: 0,\\n  first_empty_row: startRow\\n}};"},"id":"no-data","name":"No Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,80]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"respond-ok","name":"Respond OK","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[880,-64]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"respond-empty","name":"Respond Empty","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[880,80]}]	{"Webhook":{"main":[[{"node":"Prepare","type":"main","index":0}]]},"Prepare":{"main":[[{"node":"Read Data","type":"main","index":0}]]},"Read Data":{"main":[[{"node":"Analyze","type":"main","index":0}],[{"node":"No Data","type":"main","index":0}]]},"Analyze":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"No Data":{"main":[[{"node":"Respond Empty","type":"main","index":0}]]}}	Version d567b778	f	
153d186c-c92f-4dd6-8f34-bde310d4177c	adol4O3V4iGsGXpf	Fatih Berkay Baheci	2025-12-23 11:00:46.875+00	2025-12-23 11:00:46.875+00	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"3ec88fb4-bb3e-4a63-9701-8b33ce8d1c6a","name":"Webhook Bulk","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1536,112],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"// ===========================================\\n// BULK INPUT VALIDATION\\n// ===========================================\\nconst body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\nconst customRules = body.custom_rules || '';\\n\\nif (!Array.isArray(keywords) || keywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'keywords array required', errorCode: 400 }}];\\n}\\n\\nconst cleanKeywords = keywords\\n  .map(k => String(k).trim().toLowerCase())\\n  .filter(k => k.length >= 2)\\n  .slice(0, 100);\\n\\nif (cleanKeywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'Min 1 valid keyword required', errorCode: 400 }}];\\n}\\n\\nconst locationCodes = { 'TR': 2792, 'US': 2840, 'GB': 2826, 'DE': 2276, 'FR': 2250 };\\n\\nreturn [{ json: { \\n  isValid: true,\\n  keywords: cleanKeywords,\\n  keywordCount: cleanKeywords.length,\\n  projectId: projectId ? parseInt(projectId) : null,\\n  clientId: clientId ? parseInt(clientId) : null,\\n  country, language,\\n  locationCode: locationCodes[country] || 2792,\\n  customRules,\\n  startTime: Date.now()\\n}}];"},"id":"55acf7de-62a8-442b-9c55-9c1cfa71ad01","name":"Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1328,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"1957a7a3-c5ab-40a2-b5d9-e4bc3e7d90ed","name":"IF Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1104,112]},{"parameters":{"respondWith":"json","responseBody":"={ \\"success\\": false, \\"error\\": \\"{{ $json.error }}\\" }","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"36a2a724-1be1-4226-ba24-f7e4868f7cc8","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-880,304]},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\n  \\"keywords\\": {{ JSON.stringify($json.keywords) }},\\n  \\"location_code\\": {{ $json.locationCode }},\\n  \\"language_code\\": \\"{{ $json.language }}\\",\\n  \\"include_seed_keyword\\": true,\\n  \\"sort_by\\": \\"search_volume\\"\\n}]","options":{"timeout":120000}},"id":"d370a4e4-0afc-485b-baa6-fe3b5bf5307c","name":"DataForSEO Bulk","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-880,112],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// MERGE & PREPARE FOR GEMINI\\n// ===========================================\\nconst input = $('Validate Input').first().json;\\nconst seedKeywords = input.keywords || [];\\n\\nfunction normalizeForComparison(str) {\\n  return str.toLowerCase()\\n    .replace(//g, 'i').replace(//g, 'i')\\n    .replace(//g, 's').replace(//g, 's')\\n    .replace(//g, 'o').replace(//g, 'o')\\n    .replace(//g, 'u').replace(//g, 'u')\\n    .replace(//g, 'c').replace(//g, 'c')\\n    .replace(//g, 'g').replace(//g, 'g')\\n    .replace(/[^a-z0-9\\\\s]/g, '').replace(/\\\\s+/g, ' ').trim();\\n}\\n\\n// Find best matching seed for a keyword (exact match gets priority)\\nfunction findBestSeed(keyword, seeds) {\\n  const kwNorm = normalizeForComparison(keyword);\\n  \\n  // First check for exact match\\n  for (const seed of seeds) {\\n    if (normalizeForComparison(seed) === kwNorm) {\\n      return seed;\\n    }\\n  }\\n  \\n  // Then check for partial word matches\\n  const kwWords = kwNorm.split(' ');\\n  let bestSeed = null;\\n  let bestScore = 0;\\n  \\n  for (const seed of seeds) {\\n    const seedNorm = normalizeForComparison(seed);\\n    const seedWords = seedNorm.split(' ');\\n    \\n    // Count matching words\\n    let matchCount = 0;\\n    for (const sw of seedWords) {\\n      if (sw.length >= 2 && kwWords.some(kw => kw.includes(sw) || sw.includes(kw))) {\\n        matchCount++;\\n      }\\n    }\\n    \\n    // Score based on word match ratio\\n    const score = matchCount / seedWords.length;\\n    if (score > bestScore) {\\n      bestScore = score;\\n      bestSeed = seed;\\n    }\\n  }\\n  \\n  return bestSeed || seeds[0];\\n}\\n\\n// Parse DataForSEO response\\nlet dataforseoKeywords = [];\\nconst seedVolumeMap = new Map(); // Track volumes for seed keywords\\n\\ntry {\\n  const dfsResponse = $input.first().json;\\n  if (dfsResponse?.tasks?.[0]?.result) {\\n    dataforseoKeywords = dfsResponse.tasks[0].result.map(kw => {\\n      const keyword = (kw.keyword || '').toLowerCase().trim();\\n      const seedKw = findBestSeed(keyword, seedKeywords);\\n      \\n      // Track if this is a seed keyword with volume data\\n      const kwNorm = normalizeForComparison(keyword);\\n      for (const seed of seedKeywords) {\\n        if (normalizeForComparison(seed) === kwNorm && kw.search_volume) {\\n          seedVolumeMap.set(seed, { volume: kw.search_volume, cpc: kw.cpc });\\n        }\\n      }\\n      \\n      return {\\n        keyword: keyword,\\n        seed_keyword: seedKw,\\n        search_volume: kw.search_volume || 0,\\n        cpc: kw.cpc || 0,\\n        competition: kw.competition || null,\\n        source: 'dataforseo'\\n      };\\n    }).filter(kw => kw.keyword && kw.keyword.length >= 2);\\n  }\\n} catch (e) { console.log('DFS error:', e.message); }\\n\\n// Dedupe\\nconst seen = new Map();\\ndataforseoKeywords.forEach(kw => {\\n  const key = normalizeForComparison(kw.keyword);\\n  if (key.length >= 2 && !seen.has(key)) seen.set(key, kw);\\n});\\n\\n// IMPORTANT: Add ALL seed keywords (they should always appear)\\n// Even if they don't have volume data, they're the user's primary targets\\nseedKeywords.forEach((seed, idx) => {\\n  const key = normalizeForComparison(seed);\\n  const existingData = seedVolumeMap.get(seed);\\n  \\n  if (!seen.has(key)) {\\n    // Seed not in results - add it\\n    seen.set(key, {\\n      keyword: seed.toLowerCase().trim(),\\n      seed_keyword: seed,\\n      search_volume: existingData?.volume || 0,\\n      cpc: existingData?.cpc || 0,\\n      competition: null,\\n      source: 'seed',\\n      is_seed: true,\\n      seed_order: idx\\n    });\\n  } else {\\n    // Seed exists - mark it as seed\\n    const existing = seen.get(key);\\n    existing.is_seed = true;\\n    existing.seed_order = idx;\\n  }\\n});\\n\\n// Sort: Seeds first (by order), then by volume\\nconst uniqueKeywords = Array.from(seen.values())\\n  .sort((a, b) => {\\n    // Seeds first\\n    if (a.is_seed && !b.is_seed) return -1;\\n    if (!a.is_seed && b.is_seed) return 1;\\n    // Among seeds, keep original order\\n    if (a.is_seed && b.is_seed) return (a.seed_order || 0) - (b.seed_order || 0);\\n    // Rest by volume\\n    return (b.search_volume || 0) - (a.search_volume || 0);\\n  });\\n\\n// Take top 150 for AI (seeds always included), rest as pending\\nconst forAI = uniqueKeywords.slice(0, 150);\\nconst pending = uniqueKeywords.slice(150);\\n\\n// Stats per seed\\nconst seedStats = {};\\nseedKeywords.forEach(seed => {\\n  seedStats[seed] = uniqueKeywords.filter(kw => kw.seed_keyword === seed).length;\\n});\\n\\nreturn [{ json: {\\n  ...input,\\n  allKeywords: uniqueKeywords,\\n  forAI: forAI,\\n  pendingKeywords: pending,\\n  stats: {\\n    total_seeds: seedKeywords.length,\\n    from_dataforseo: dataforseoKeywords.length,\\n    unique: uniqueKeywords.length,\\n    for_ai: forAI.length,\\n    pending: pending.length,\\n    per_seed: seedStats\\n  }\\n}}];"},"id":"85df8f5f-f15d-42dd-9672-9d78b675c882","name":"Merge Keywords","type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,112]},{"parameters":{"jsCode":"// ===========================================\\n// BUILD GEMINI PROMPT\\n// ===========================================\\nconst data = $input.first().json;\\nconst keywords = data.forAI || [];\\nconst seedKeywords = data.keywords || [];\\n\\nif (keywords.length === 0) {\\n  return [{ json: { ...data, skipAi: true }}];\\n}\\n\\nconst keywordCsv = keywords.map((kw, i) => {\\n  const vol = kw.search_volume || 0;\\n  const cpc = kw.cpc ? kw.cpc.toFixed(2) : '0';\\n  const seed = kw.seed_keyword || '';\\n  return `${i+1}|${kw.keyword}|${vol}|${cpc}|${seed}`;\\n}).join('\\\\n');\\n\\nconst seedList = seedKeywords.join(', ');\\n\\nconst prompt = `Sen bir SEO uzmanisin. Bir musteri icin TOPLU keyword arastirmasi yapiyoruz.\\n\\nMusterinin arastirmak istedigi SEED KEYWORDLER:\\n${seedList}\\n\\nUlke: ${data.country}\\n\\nAsagidaki keywordler DataForSEO'dan bu seed'lere gore cekildi. Her keyword kendi SEED KEYWORD'u ile iliskili oldugu surece ONAYLA.\\n\\nKEYWORDS (No|keyword|volume|cpc|seed_keyword):\\n${keywordCsv}\\n\\nDEGERLENDIRME KURALLARI:\\n1. Her keyword kendi seed_keyword'u ile iliskili mi bak (son sutun)\\n2. Keyword, seed ile alakali ise ONAYLA\\n3. Spam, anlamsiz veya tamamen alakasiz ise REDDET\\n4. Search volume 0 olsa bile alakali ise ONAYLA\\n5. COGU KEYWORD ONAYLANMALI - sadece gercekten alakasiz olanlari reddet\\n\\nHer keyword icin tek satir cikti ver:\\n- Uygunsa: No|approved|intent|cluster|priority|content_type\\n- Uygun degilse: No|rejected|||||reason\\n\\nIntent: informational, commercial, transactional, navigational\\nPriority: high (volume>1000), medium (100-1000), low (<100)\\nContent_type: pillar, cluster, blog, product, faq\\n\\nSadece satirlari yaz, baska bir sey yazma.`;\\n\\nreturn [{ json: { ...data, filterPrompt: prompt, skipAi: false }}];"},"id":"1672aef2-64b6-41c7-bc16-050666571c82","name":"Build Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"skip","leftValue":"={{ $json.skipAi }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"dff7f247-f169-49a2-b9e3-fa09f1d91c2f","name":"IF Run AI","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{ \\"parts\\": [{ \\"text\\": {{ JSON.stringify($json.filterPrompt) }} }] }],\\n  \\"generationConfig\\": { \\"temperature\\": 0.3, \\"maxOutputTokens\\": 8192 }\\n}","options":{"timeout":120000}},"id":"f6a60c1f-9da8-4f7a-9fd7-f615565d8545","name":"Gemini Filter","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,0],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// PARSE GEMINI RESPONSE\\n// ===========================================\\nconst prevData = $('Build Prompt').first().json;\\nconst geminiResponse = $input.first().json;\\nconst processedKeywords = prevData.forAI || [];\\nconst pendingKeywords = prevData.pendingKeywords || [];\\n\\nconst approved = [];\\nconst rejected = [];\\n\\ntry {\\n  const text = geminiResponse?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  const lines = text.split('\\\\n').filter(l => /^\\\\d+\\\\|/.test(l.trim()));\\n  const processedIndices = new Set();\\n  \\n  for (const line of lines) {\\n    const parts = line.split('|').map(p => p.trim());\\n    if (parts.length < 2) continue;\\n    \\n    const no = parseInt(parts[0]);\\n    const status = (parts[1] || '').toLowerCase();\\n    \\n    if (isNaN(no) || no < 1 || no > processedKeywords.length) continue;\\n    \\n    const original = processedKeywords[no - 1];\\n    processedIndices.add(no);\\n    \\n    if (status === 'approved') {\\n      approved.push({\\n        ...original,\\n        intent: parts[2] || null,\\n        cluster: parts[3] || null,\\n        priority: parts[4] || 'medium',\\n        content_type: parts[5] || 'cluster',\\n        status: 'approved',\\n        reject_reason: null\\n      });\\n    } else {\\n      rejected.push({\\n        ...original,\\n        intent: null, cluster: parts[3] || null,\\n        priority: null, content_type: null,\\n        status: 'rejected',\\n        reject_reason: parts[6] || 'filtered'\\n      });\\n    }\\n  }\\n  \\n  // Handle skipped keywords\\n  processedKeywords.forEach((kw, idx) => {\\n    if (!processedIndices.has(idx + 1)) {\\n      rejected.push({ ...kw, status: 'pending', reject_reason: 'AI skipped' });\\n    }\\n  });\\n} catch (e) {\\n  console.log('Parse error:', e.message);\\n  processedKeywords.forEach(kw => {\\n    approved.push({ ...kw, status: 'approved', priority: 'medium', content_type: 'cluster' });\\n  });\\n}\\n\\n// Add pending keywords\\npendingKeywords.forEach(kw => {\\n  rejected.push({ ...kw, status: 'pending', reject_reason: null });\\n});\\n\\nconst clusters = {};\\napproved.forEach(kw => {\\n  const c = kw.cluster || 'Genel';\\n  if (!clusters[c]) clusters[c] = [];\\n  clusters[c].push(kw.keyword);\\n});\\n\\nreturn [{ json: {\\n  projectId: prevData.projectId,\\n  clientId: prevData.clientId,\\n  mainKeyword: prevData.keywords[0],\\n  stats: { ...prevData.stats, approved: approved.length, rejected: rejected.length },\\n  approved_keywords: approved,\\n  rejected_keywords: rejected,\\n  all_keywords: [...approved, ...rejected],\\n  clusters,\\n  ai_used: true,\\n  processing_time_ms: Date.now() - prevData.startTime\\n}}];"},"id":"58b56d79-40ca-411b-9226-1e33a60461c8","name":"Parse Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"jsCode":"// ===========================================\\n// SKIP AI - Mark all as approved\\n// ===========================================\\nconst data = $input.first().json;\\nconst keywords = data.allKeywords || [];\\n\\nconst approved = keywords.slice(0, 50).map(kw => ({\\n  ...kw, status: 'approved', priority: 'medium', content_type: 'cluster'\\n}));\\nconst pending = keywords.slice(50).map(kw => ({\\n  ...kw, status: 'pending', reject_reason: 'AI skipped'\\n}));\\n\\nreturn [{ json: {\\n  projectId: data.projectId,\\n  clientId: data.clientId,\\n  mainKeyword: data.keywords[0],\\n  stats: { ...data.stats, approved: approved.length, rejected: pending.length },\\n  approved_keywords: approved,\\n  rejected_keywords: pending,\\n  all_keywords: [...approved, ...pending],\\n  clusters: { 'Genel': approved.map(k => k.keyword) },\\n  ai_used: false,\\n  processing_time_ms: Date.now() - data.startTime\\n}}];"},"id":"a9b82db9-3fc9-4f0d-8206-2b88d42bbf74","name":"Skip AI","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"has-project","leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}],"combinator":"and"},"options":{}},"id":"b32aa838-3600-42b7-8bdc-704badecdba4","name":"IF Save DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,112]},{"parameters":{"jsCode":"// ===========================================\\n// PREPARE BATCH INSERT\\n// ===========================================\\nconst data = $input.first().json;\\nconst projectId = data.projectId;\\nconst allKeywords = data.all_keywords || [];\\n\\nif (allKeywords.length === 0) {\\n  return [{ json: { skip: true, batchQuery: '' }}];\\n}\\n\\nfunction esc(str) {\\n  if (str === null || str === undefined) return 'NULL';\\n  return \\"'\\" + String(str).replace(/\\\\\\\\/g, '\\\\\\\\\\\\\\\\').replace(/'/g, \\"''\\") + \\"'\\";\\n}\\n\\nconst values = allKeywords.slice(0, 500).map(kw => {\\n  const kwType = kw.source?.includes('suggest') ? 'google_suggest' : 'related';\\n  const src = (kw.source || 'dataforseo').split(',')[0].trim();\\n  return `(${projectId}, ${esc(kw.keyword)}, ${esc(kw.seed_keyword)}, '${kwType}', ${kw.search_volume || 'NULL'}, ${kw.cpc || 'NULL'}, ${esc(kw.competition)}, ${esc(kw.intent)}, ${esc(kw.cluster)}, ${esc(kw.priority)}, ${esc(kw.content_type)}, '${src}', '${kw.status || 'pending'}', ${esc(kw.reject_reason)})`;\\n}).join(',\\\\n');\\n\\nconst query = `INSERT INTO keyword_results (project_id, keyword, seed_keyword, keyword_type, search_volume, cpc, competition, search_intent, keyword_cluster, content_priority, page_type, source, status, reject_reason) VALUES ${values} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume), status=VALUES(status)`;\\n\\nreturn [{ json: { ...data, batchQuery: query }}];"},"id":"cf035d15-fb05-491a-b894-608d49395dcc","name":"Prepare Insert","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"operation":"executeQuery","query":"={{ $json.batchQuery }}","options":{}},"id":"d7d5e46b-c6a3-48cf-89a4-a8b236e86d13","name":"Save to DB","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[880,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// FINAL RESPONSE\\n// ===========================================\\nconst data = $('Prepare Insert').first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi. ${approved.length} onaylandi, ${rejected.length} reddedildi.`,\\n  project_id: data.projectId,\\n  stats: data.stats,\\n  keywords: approved.slice(0, 200).map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    intent: kw.intent,\\n    cluster: kw.cluster,\\n    priority: kw.priority,\\n    status: kw.status\\n  })),\\n  rejected: rejected.slice(0, 50).map(kw => ({\\n    keyword: kw.keyword,\\n    reason: kw.reject_reason\\n  })),\\n  clusters: data.clusters,\\n  ai_used: data.ai_used,\\n  processing_time_ms: data.processing_time_ms\\n}}];"},"id":"54e079ec-722c-4b03-a9b5-6b86da26e0fc","name":"Response (DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,0]},{"parameters":{"jsCode":"// ===========================================\\n// RESPONSE WITHOUT DB\\n// ===========================================\\nconst data = $input.first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi (DB yok). ${approved.length} onaylandi.`,\\n  project_id: null,\\n  stats: data.stats,\\n  keywords: approved.slice(0, 200),\\n  rejected: rejected.slice(0, 50),\\n  clusters: data.clusters,\\n  ai_used: data.ai_used\\n}}];"},"id":"fd097d14-8fae-4a9d-b4cc-e8a0470588e3","name":"Response (No DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,208]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"7d6c9f04-1e68-49d3-9de6-411dd38dd41f","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1328,112]}]	{"Webhook Bulk":{"main":[[{"node":"Validate Input","type":"main","index":0}]]},"Validate Input":{"main":[[{"node":"IF Valid","type":"main","index":0}]]},"IF Valid":{"main":[[{"node":"DataForSEO Bulk","type":"main","index":0}],[{"node":"Respond Error","type":"main","index":0}]]},"DataForSEO Bulk":{"main":[[{"node":"Merge Keywords","type":"main","index":0}]]},"Merge Keywords":{"main":[[{"node":"Build Prompt","type":"main","index":0}]]},"Build Prompt":{"main":[[{"node":"IF Run AI","type":"main","index":0}]]},"IF Run AI":{"main":[[{"node":"Gemini Filter","type":"main","index":0}],[{"node":"Skip AI","type":"main","index":0}]]},"Gemini Filter":{"main":[[{"node":"Parse Response","type":"main","index":0}]]},"Parse Response":{"main":[[{"node":"IF Save DB","type":"main","index":0}]]},"Skip AI":{"main":[[{"node":"IF Save DB","type":"main","index":0}]]},"IF Save DB":{"main":[[{"node":"Prepare Insert","type":"main","index":0}],[{"node":"Response (No DB)","type":"main","index":0}]]},"Prepare Insert":{"main":[[{"node":"Save to DB","type":"main","index":0}]]},"Save to DB":{"main":[[{"node":"Response (DB)","type":"main","index":0}]]},"Response (DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]},"Response (No DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]}}	\N	f	\N
955e4b52-554e-4655-9078-3b6637e99651	adol4O3V4iGsGXpf	Fatih Berkay Baheci	2025-12-23 11:09:39.629+00	2025-12-23 11:09:39.629+00	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"e10c6efe-3f5e-4aac-838d-d4005a40613f","name":"Webhook Bulk","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1536,112],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"// ===========================================\\n// BULK INPUT VALIDATION\\n// ===========================================\\nconst body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\nconst customRules = body.custom_rules || '';\\n\\nif (!Array.isArray(keywords) || keywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'keywords array required', errorCode: 400 }}];\\n}\\n\\nconst cleanKeywords = keywords\\n  .map(k => String(k).trim().toLowerCase())\\n  .filter(k => k.length >= 2)\\n  .slice(0, 100);\\n\\nif (cleanKeywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'Min 1 valid keyword required', errorCode: 400 }}];\\n}\\n\\nconst locationCodes = { 'TR': 2792, 'US': 2840, 'GB': 2826, 'DE': 2276, 'FR': 2250 };\\n\\nreturn [{ json: { \\n  isValid: true,\\n  keywords: cleanKeywords,\\n  keywordCount: cleanKeywords.length,\\n  projectId: projectId ? parseInt(projectId) : null,\\n  clientId: clientId ? parseInt(clientId) : null,\\n  country, language,\\n  locationCode: locationCodes[country] || 2792,\\n  customRules,\\n  startTime: Date.now()\\n}}];"},"id":"80241980-934c-47f1-880c-88f3243c96e6","name":"Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1328,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"ba6f1a1e-b8c2-4b60-9115-d254b1242e01","name":"IF Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1104,112]},{"parameters":{"respondWith":"json","responseBody":"={ \\"success\\": false, \\"error\\": \\"{{ $json.error }}\\" }","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"160bad1d-89d5-4379-8c32-473d161fcef6","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-880,304]},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\n  \\"keywords\\": {{ JSON.stringify($json.keywords) }},\\n  \\"location_code\\": {{ $json.locationCode }},\\n  \\"language_code\\": \\"{{ $json.language }}\\",\\n  \\"include_seed_keyword\\": true,\\n  \\"sort_by\\": \\"search_volume\\"\\n}]","options":{"timeout":120000}},"id":"ee45db2f-3726-4ab4-878a-71bacc4caed8","name":"DataForSEO Bulk","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-880,112],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// MERGE & PREPARE FOR GEMINI\\n// ===========================================\\nconst input = $('Validate Input').first().json;\\nconst seedKeywords = input.keywords || [];\\n\\nfunction normalizeForComparison(str) {\\n  return str.toLowerCase()\\n    .replace(//g, 'i').replace(//g, 'i')\\n    .replace(//g, 's').replace(//g, 's')\\n    .replace(//g, 'o').replace(//g, 'o')\\n    .replace(//g, 'u').replace(//g, 'u')\\n    .replace(//g, 'c').replace(//g, 'c')\\n    .replace(//g, 'g').replace(//g, 'g')\\n    .replace(/[^a-z0-9\\\\s]/g, '').replace(/\\\\s+/g, ' ').trim();\\n}\\n\\n// Common synonyms/related terms mapping\\nconst synonymMap = {\\n  'laptop': ['dizustu', 'notebook', 'bilgisayar'],\\n  'notebook': ['dizustu', 'laptop', 'bilgisayar'],\\n  'dizustu': ['laptop', 'notebook'],\\n  'pc': ['masaustu', 'bilgisayar', 'kasa'],\\n  'masaustu': ['pc', 'bilgisayar', 'kasa'],\\n  'kasa': ['pc', 'masaustu', 'bilgisayar'],\\n  'bilgisayar': ['pc', 'laptop', 'notebook', 'masaustu', 'dizustu'],\\n  'supurge': ['dyson', 'elektrikli'],\\n  'dyson': ['supurge', 'elektrikli'],\\n  'seo': ['arama', 'motoru', 'optimizasyon'],\\n  'camasir': ['makine', 'yikama'],\\n  'makine': ['camasir', 'bulasik']\\n};\\n\\n// Find best matching seed for a keyword (exact match gets priority)\\nfunction findBestSeed(keyword, seeds) {\\n  const kwNorm = normalizeForComparison(keyword);\\n  const kwWords = kwNorm.split(' ');\\n  \\n  // First check for exact match\\n  for (const seed of seeds) {\\n    if (normalizeForComparison(seed) === kwNorm) {\\n      return seed;\\n    }\\n  }\\n  \\n  // Check if keyword CONTAINS any seed entirely\\n  for (const seed of seeds) {\\n    const seedNorm = normalizeForComparison(seed);\\n    if (kwNorm.includes(seedNorm)) {\\n      return seed;\\n    }\\n  }\\n  \\n  // Check with synonyms\\n  for (const seed of seeds) {\\n    const seedNorm = normalizeForComparison(seed);\\n    const seedWords = seedNorm.split(' ');\\n    \\n    for (const sw of seedWords) {\\n      // Direct match\\n      if (kwWords.includes(sw)) return seed;\\n      \\n      // Check synonyms\\n      const synonyms = synonymMap[sw] || [];\\n      for (const syn of synonyms) {\\n        if (kwWords.some(kw => kw.includes(syn) || syn.includes(kw))) {\\n          return seed;\\n        }\\n      }\\n    }\\n  }\\n  \\n  // Then check for partial word matches with minimum threshold\\n  let bestSeed = null;\\n  let bestScore = 0;\\n  \\n  for (const seed of seeds) {\\n    const seedNorm = normalizeForComparison(seed);\\n    const seedWords = seedNorm.split(' ');\\n    \\n    // Count matching words (more flexible matching)\\n    let matchCount = 0;\\n    for (const sw of seedWords) {\\n      if (sw.length >= 3) {\\n        for (const kw of kwWords) {\\n          if (kw.length >= 3 && (kw.includes(sw) || sw.includes(kw))) {\\n            matchCount++;\\n            break;\\n          }\\n        }\\n      }\\n    }\\n    \\n    const score = matchCount / seedWords.length;\\n    if (score > bestScore) {\\n      bestScore = score;\\n      bestSeed = seed;\\n    }\\n  }\\n  \\n  if (bestScore >= 0.5) {\\n    return bestSeed;\\n  }\\n  \\n  // Last resort: check if keyword contains any significant word from any seed\\n  for (const seed of seeds) {\\n    const seedNorm = normalizeForComparison(seed);\\n    const seedWords = seedNorm.split(' ').filter(w => w.length >= 4);\\n    for (const sw of seedWords) {\\n      if (kwNorm.includes(sw)) {\\n        return seed;\\n      }\\n    }\\n  }\\n  \\n  return seeds[0]; // Fallback to first seed if no match\\n}\\n\\n// Parse DataForSEO response\\nlet dataforseoKeywords = [];\\nconst seedVolumeMap = new Map(); // Track volumes for seed keywords\\n\\ntry {\\n  const dfsResponse = $input.first().json;\\n  if (dfsResponse?.tasks?.[0]?.result) {\\n    dataforseoKeywords = dfsResponse.tasks[0].result.map(kw => {\\n      const keyword = (kw.keyword || '').toLowerCase().trim();\\n      const seedKw = findBestSeed(keyword, seedKeywords);\\n      \\n      // Track if this is a seed keyword with volume data\\n      const kwNorm = normalizeForComparison(keyword);\\n      for (const seed of seedKeywords) {\\n        if (normalizeForComparison(seed) === kwNorm && kw.search_volume) {\\n          seedVolumeMap.set(seed, { volume: kw.search_volume, cpc: kw.cpc });\\n        }\\n      }\\n      \\n      return {\\n        keyword: keyword,\\n        seed_keyword: seedKw,\\n        search_volume: kw.search_volume || 0,\\n        cpc: kw.cpc || 0,\\n        competition: kw.competition || null,\\n        source: 'dataforseo'\\n      };\\n    }).filter(kw => kw.keyword && kw.keyword.length >= 2);\\n  }\\n} catch (e) { console.log('DFS error:', e.message); }\\n\\n// Dedupe\\nconst seen = new Map();\\ndataforseoKeywords.forEach(kw => {\\n  const key = normalizeForComparison(kw.keyword);\\n  if (key.length >= 2 && !seen.has(key)) seen.set(key, kw);\\n});\\n\\n// IMPORTANT: Add ALL seed keywords (they should always appear)\\n// Even if they don't have volume data, they're the user's primary targets\\nseedKeywords.forEach((seed, idx) => {\\n  const key = normalizeForComparison(seed);\\n  const existingData = seedVolumeMap.get(seed);\\n  \\n  if (!seen.has(key)) {\\n    // Seed not in results - add it\\n    seen.set(key, {\\n      keyword: seed.toLowerCase().trim(),\\n      seed_keyword: seed,\\n      search_volume: existingData?.volume || 0,\\n      cpc: existingData?.cpc || 0,\\n      competition: null,\\n      source: 'seed',\\n      is_seed: true,\\n      seed_order: idx\\n    });\\n  } else {\\n    // Seed exists - mark it as seed\\n    const existing = seen.get(key);\\n    existing.is_seed = true;\\n    existing.seed_order = idx;\\n  }\\n});\\n\\n// Sort: Seeds first (by order), then by volume\\nconst uniqueKeywords = Array.from(seen.values())\\n  .sort((a, b) => {\\n    // Seeds first\\n    if (a.is_seed && !b.is_seed) return -1;\\n    if (!a.is_seed && b.is_seed) return 1;\\n    // Among seeds, keep original order\\n    if (a.is_seed && b.is_seed) return (a.seed_order || 0) - (b.seed_order || 0);\\n    // Rest by volume\\n    return (b.search_volume || 0) - (a.search_volume || 0);\\n  });\\n\\n// Take top 150 for AI (seeds always included), rest as pending\\nconst forAI = uniqueKeywords.slice(0, 150);\\nconst pending = uniqueKeywords.slice(150);\\n\\n// Stats per seed\\nconst seedStats = {};\\nseedKeywords.forEach(seed => {\\n  seedStats[seed] = uniqueKeywords.filter(kw => kw.seed_keyword === seed).length;\\n});\\n\\nreturn [{ json: {\\n  ...input,\\n  allKeywords: uniqueKeywords,\\n  forAI: forAI,\\n  pendingKeywords: pending,\\n  stats: {\\n    total_seeds: seedKeywords.length,\\n    from_dataforseo: dataforseoKeywords.length,\\n    unique: uniqueKeywords.length,\\n    for_ai: forAI.length,\\n    pending: pending.length,\\n    per_seed: seedStats\\n  }\\n}}];"},"id":"87e88f7a-8cad-4617-81f3-10149791b67c","name":"Merge Keywords","type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,112]},{"parameters":{"jsCode":"// ===========================================\\n// BUILD GEMINI PROMPT\\n// ===========================================\\nconst data = $input.first().json;\\nconst keywords = data.forAI || [];\\nconst seedKeywords = data.keywords || [];\\n\\nif (keywords.length === 0) {\\n  return [{ json: { ...data, skipAi: true }}];\\n}\\n\\nconst keywordCsv = keywords.map((kw, i) => {\\n  const vol = kw.search_volume || 0;\\n  const cpc = kw.cpc ? kw.cpc.toFixed(2) : '0';\\n  const seed = kw.seed_keyword || '';\\n  return `${i+1}|${kw.keyword}|${vol}|${cpc}|${seed}`;\\n}).join('\\\\n');\\n\\nconst seedList = seedKeywords.join(', ');\\n\\nconst prompt = `Sen bir SEO uzmanisin. Bir musteri icin TOPLU keyword arastirmasi yapiyoruz.\\n\\nMusterinin arastirmak istedigi SEED KEYWORDLER:\\n${seedList}\\n\\nUlke: ${data.country}\\n\\nAsagidaki keywordler DataForSEO'dan bu seed'lere gore cekildi. Her keyword kendi SEED KEYWORD'u ile iliskili oldugu surece ONAYLA.\\n\\nKEYWORDS (No|keyword|volume|cpc|seed_keyword):\\n${keywordCsv}\\n\\nDEGERLENDIRME KURALLARI:\\n1. Her keyword kendi seed_keyword'u ile iliskili mi bak (son sutun)\\n2. Keyword, seed ile alakali ise ONAYLA\\n3. Spam, anlamsiz veya tamamen alakasiz ise REDDET\\n4. Search volume 0 olsa bile alakali ise ONAYLA\\n5. COGU KEYWORD ONAYLANMALI - sadece gercekten alakasiz olanlari reddet\\n\\nHer keyword icin tek satir cikti ver:\\n- Uygunsa: No|approved|intent|cluster|priority|content_type\\n- Uygun degilse: No|rejected|||||reason\\n\\nIntent: informational, commercial, transactional, navigational\\nPriority: high (volume>1000), medium (100-1000), low (<100)\\nContent_type: pillar, cluster, blog, product, faq\\n\\nSadece satirlari yaz, baska bir sey yazma.`;\\n\\nreturn [{ json: { ...data, filterPrompt: prompt, skipAi: false }}];"},"id":"69429ccd-e02f-4c33-be9c-4355f80cde37","name":"Build Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"skip","leftValue":"={{ $json.skipAi }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"aea03c74-33e1-4835-8d61-4dc7bfe3a32d","name":"IF Run AI","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{ \\"parts\\": [{ \\"text\\": {{ JSON.stringify($json.filterPrompt) }} }] }],\\n  \\"generationConfig\\": { \\"temperature\\": 0.3, \\"maxOutputTokens\\": 8192 }\\n}","options":{"timeout":120000}},"id":"d8c78c4c-6cb9-4ee7-b2fb-9f2ff6767a5c","name":"Gemini Filter","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,0],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// PARSE GEMINI RESPONSE\\n// ===========================================\\nconst prevData = $('Build Prompt').first().json;\\nconst geminiResponse = $input.first().json;\\nconst processedKeywords = prevData.forAI || [];\\nconst pendingKeywords = prevData.pendingKeywords || [];\\n\\nconst approved = [];\\nconst rejected = [];\\n\\ntry {\\n  const text = geminiResponse?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  const lines = text.split('\\\\n').filter(l => /^\\\\d+\\\\|/.test(l.trim()));\\n  const processedIndices = new Set();\\n  \\n  for (const line of lines) {\\n    const parts = line.split('|').map(p => p.trim());\\n    if (parts.length < 2) continue;\\n    \\n    const no = parseInt(parts[0]);\\n    const status = (parts[1] || '').toLowerCase();\\n    \\n    if (isNaN(no) || no < 1 || no > processedKeywords.length) continue;\\n    \\n    const original = processedKeywords[no - 1];\\n    processedIndices.add(no);\\n    \\n    if (status === 'approved') {\\n      approved.push({\\n        ...original,\\n        intent: parts[2] || null,\\n        cluster: parts[3] || null,\\n        priority: parts[4] || 'medium',\\n        content_type: parts[5] || 'cluster',\\n        status: 'approved',\\n        reject_reason: null\\n      });\\n    } else {\\n      rejected.push({\\n        ...original,\\n        intent: null, cluster: parts[3] || null,\\n        priority: null, content_type: null,\\n        status: 'rejected',\\n        reject_reason: parts[6] || 'filtered'\\n      });\\n    }\\n  }\\n  \\n  // Handle skipped keywords\\n  processedKeywords.forEach((kw, idx) => {\\n    if (!processedIndices.has(idx + 1)) {\\n      rejected.push({ ...kw, status: 'pending', reject_reason: 'AI skipped' });\\n    }\\n  });\\n} catch (e) {\\n  console.log('Parse error:', e.message);\\n  processedKeywords.forEach(kw => {\\n    approved.push({ ...kw, status: 'approved', priority: 'medium', content_type: 'cluster' });\\n  });\\n}\\n\\n// Add pending keywords\\npendingKeywords.forEach(kw => {\\n  rejected.push({ ...kw, status: 'pending', reject_reason: null });\\n});\\n\\nconst clusters = {};\\napproved.forEach(kw => {\\n  const c = kw.cluster || 'Genel';\\n  if (!clusters[c]) clusters[c] = [];\\n  clusters[c].push(kw.keyword);\\n});\\n\\nreturn [{ json: {\\n  projectId: prevData.projectId,\\n  clientId: prevData.clientId,\\n  mainKeyword: prevData.keywords[0],\\n  stats: { ...prevData.stats, approved: approved.length, rejected: rejected.length },\\n  approved_keywords: approved,\\n  rejected_keywords: rejected,\\n  all_keywords: [...approved, ...rejected],\\n  clusters,\\n  ai_used: true,\\n  processing_time_ms: Date.now() - prevData.startTime\\n}}];"},"id":"a2f0eccd-8e31-4f8b-af6e-6b221dfc7654","name":"Parse Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"jsCode":"// ===========================================\\n// SKIP AI - Mark all as approved\\n// ===========================================\\nconst data = $input.first().json;\\nconst keywords = data.allKeywords || [];\\n\\nconst approved = keywords.slice(0, 50).map(kw => ({\\n  ...kw, status: 'approved', priority: 'medium', content_type: 'cluster'\\n}));\\nconst pending = keywords.slice(50).map(kw => ({\\n  ...kw, status: 'pending', reject_reason: 'AI skipped'\\n}));\\n\\nreturn [{ json: {\\n  projectId: data.projectId,\\n  clientId: data.clientId,\\n  mainKeyword: data.keywords[0],\\n  stats: { ...data.stats, approved: approved.length, rejected: pending.length },\\n  approved_keywords: approved,\\n  rejected_keywords: pending,\\n  all_keywords: [...approved, ...pending],\\n  clusters: { 'Genel': approved.map(k => k.keyword) },\\n  ai_used: false,\\n  processing_time_ms: Date.now() - data.startTime\\n}}];"},"id":"c7722a12-3b09-4f1f-929f-4336e9080d45","name":"Skip AI","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"has-project","leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}],"combinator":"and"},"options":{}},"id":"b6b10f1b-162d-4034-baf8-cf6217e5231f","name":"IF Save DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,112]},{"parameters":{"jsCode":"// ===========================================\\n// PREPARE BATCH INSERT\\n// ===========================================\\nconst data = $input.first().json;\\nconst projectId = data.projectId;\\nconst allKeywords = data.all_keywords || [];\\n\\nif (allKeywords.length === 0) {\\n  return [{ json: { skip: true, batchQuery: '' }}];\\n}\\n\\nfunction esc(str) {\\n  if (str === null || str === undefined) return 'NULL';\\n  return \\"'\\" + String(str).replace(/\\\\\\\\/g, '\\\\\\\\\\\\\\\\').replace(/'/g, \\"''\\") + \\"'\\";\\n}\\n\\nconst values = allKeywords.slice(0, 500).map(kw => {\\n  const kwType = kw.source?.includes('suggest') ? 'google_suggest' : 'related';\\n  const src = (kw.source || 'dataforseo').split(',')[0].trim();\\n  return `(${projectId}, ${esc(kw.keyword)}, ${esc(kw.seed_keyword)}, '${kwType}', ${kw.search_volume || 'NULL'}, ${kw.cpc || 'NULL'}, ${esc(kw.competition)}, ${esc(kw.intent)}, ${esc(kw.cluster)}, ${esc(kw.priority)}, ${esc(kw.content_type)}, '${src}', '${kw.status || 'pending'}', ${esc(kw.reject_reason)})`;\\n}).join(',\\\\n');\\n\\nconst query = `INSERT INTO keyword_results (project_id, keyword, seed_keyword, keyword_type, search_volume, cpc, competition, search_intent, keyword_cluster, content_priority, page_type, source, status, reject_reason) VALUES ${values} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume), status=VALUES(status)`;\\n\\nreturn [{ json: { ...data, batchQuery: query }}];"},"id":"f279d1ff-5ae4-49c4-9331-b13278873534","name":"Prepare Insert","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"operation":"executeQuery","query":"={{ $json.batchQuery }}","options":{}},"id":"123f6e8f-a955-422f-b4f5-0bba021227aa","name":"Save to DB","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[880,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// FINAL RESPONSE\\n// ===========================================\\nconst data = $('Prepare Insert').first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi. ${approved.length} onaylandi, ${rejected.length} reddedildi.`,\\n  project_id: data.projectId,\\n  stats: data.stats,\\n  keywords: approved.slice(0, 200).map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    intent: kw.intent,\\n    cluster: kw.cluster,\\n    priority: kw.priority,\\n    status: kw.status\\n  })),\\n  rejected: rejected.slice(0, 50).map(kw => ({\\n    keyword: kw.keyword,\\n    reason: kw.reject_reason\\n  })),\\n  clusters: data.clusters,\\n  ai_used: data.ai_used,\\n  processing_time_ms: data.processing_time_ms\\n}}];"},"id":"b935ea2c-2ac3-41ed-bf48-c80deded796f","name":"Response (DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,0]},{"parameters":{"jsCode":"// ===========================================\\n// RESPONSE WITHOUT DB\\n// ===========================================\\nconst data = $input.first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi (DB yok). ${approved.length} onaylandi.`,\\n  project_id: null,\\n  stats: data.stats,\\n  keywords: approved.slice(0, 200),\\n  rejected: rejected.slice(0, 50),\\n  clusters: data.clusters,\\n  ai_used: data.ai_used\\n}}];"},"id":"a9ff77ea-9e28-4613-8fc6-bf3e7b5825f2","name":"Response (No DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,208]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"ce3299dc-13ad-4b97-a867-ff48fabc8aac","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1328,112]}]	{"Webhook Bulk":{"main":[[{"node":"Validate Input","type":"main","index":0}]]},"Validate Input":{"main":[[{"node":"IF Valid","type":"main","index":0}]]},"IF Valid":{"main":[[{"node":"DataForSEO Bulk","type":"main","index":0}],[{"node":"Respond Error","type":"main","index":0}]]},"DataForSEO Bulk":{"main":[[{"node":"Merge Keywords","type":"main","index":0}]]},"Merge Keywords":{"main":[[{"node":"Build Prompt","type":"main","index":0}]]},"Build Prompt":{"main":[[{"node":"IF Run AI","type":"main","index":0}]]},"IF Run AI":{"main":[[{"node":"Gemini Filter","type":"main","index":0}],[{"node":"Skip AI","type":"main","index":0}]]},"Gemini Filter":{"main":[[{"node":"Parse Response","type":"main","index":0}]]},"Parse Response":{"main":[[{"node":"IF Save DB","type":"main","index":0}]]},"Skip AI":{"main":[[{"node":"IF Save DB","type":"main","index":0}]]},"IF Save DB":{"main":[[{"node":"Prepare Insert","type":"main","index":0}],[{"node":"Response (No DB)","type":"main","index":0}]]},"Prepare Insert":{"main":[[{"node":"Save to DB","type":"main","index":0}]]},"Save to DB":{"main":[[{"node":"Response (DB)","type":"main","index":0}]]},"Response (DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]},"Response (No DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]}}	\N	f	\N
abd3d57c-097a-4b2e-ae49-b697c80743f1	adol4O3V4iGsGXpf	Fatih Berkay Baheci	2025-12-23 11:24:17.155+00	2025-12-23 11:24:17.155+00	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"9ef86aa0-2c26-4335-a9d4-4b651129b165","name":"Webhook Bulk","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1536,112],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"// ===========================================\\n// BULK INPUT VALIDATION\\n// ===========================================\\nconst body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\nconst customRules = body.custom_rules || '';\\n\\nif (!Array.isArray(keywords) || keywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'keywords array required', errorCode: 400 }}];\\n}\\n\\nconst cleanKeywords = keywords\\n  .map(k => String(k).trim().toLowerCase())\\n  .filter(k => k.length >= 2)\\n  .slice(0, 100);\\n\\nif (cleanKeywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'Min 1 valid keyword required', errorCode: 400 }}];\\n}\\n\\nconst locationCodes = { 'TR': 2792, 'US': 2840, 'GB': 2826, 'DE': 2276, 'FR': 2250 };\\n\\nreturn [{ json: { \\n  isValid: true,\\n  keywords: cleanKeywords,\\n  keywordCount: cleanKeywords.length,\\n  projectId: projectId ? parseInt(projectId) : null,\\n  clientId: clientId ? parseInt(clientId) : null,\\n  country, language,\\n  locationCode: locationCodes[country] || 2792,\\n  customRules,\\n  startTime: Date.now()\\n}}];"},"id":"6a78e2ab-30c4-4bba-a3f4-3e281a359539","name":"Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1328,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"e647ab31-6d5f-4941-8da2-55007f963d54","name":"IF Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1104,112]},{"parameters":{"respondWith":"json","responseBody":"={ \\"success\\": false, \\"error\\": \\"{{ $json.error }}\\" }","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"f9e5fc32-9d3a-468f-84a0-703aa604a1e1","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-880,304]},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\n  \\"keywords\\": {{ JSON.stringify($json.keywords) }},\\n  \\"location_code\\": {{ $json.locationCode }},\\n  \\"language_code\\": \\"{{ $json.language }}\\",\\n  \\"include_seed_keyword\\": true,\\n  \\"sort_by\\": \\"search_volume\\"\\n}]","options":{"timeout":120000}},"id":"f6ae7a74-39e2-4099-bf37-3fe2e6518154","name":"DataForSEO Bulk","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-880,112],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// MERGE & PREPARE FOR GEMINI - v3 SCORE-BASED\\n// ===========================================\\nconst input = $('Validate Input').first().json;\\nconst seedKeywords = input.keywords || [];\\n\\n// Turkish character normalization\\nfunction normalizeForComparison(str) {\\n  return str.toLowerCase()\\n    .replace(//g, 'i').replace(//g, 'i')\\n    .replace(//g, 's').replace(//g, 's')\\n    .replace(//g, 'o').replace(//g, 'o')\\n    .replace(//g, 'u').replace(//g, 'u')\\n    .replace(//g, 'c').replace(//g, 'c')\\n    .replace(//g, 'g').replace(//g, 'g')\\n    .replace(/[^a-z0-9\\\\s]/g, '').replace(/\\\\s+/g, ' ').trim();\\n}\\n\\n// Comprehensive synonym mapping (bidirectional)\\nconst synonymGroups = [\\n  ['laptop', 'dizustu', 'notebook', 'dizustu bilgisayar', 'tasinabilir bilgisayar'],\\n  ['pc', 'masaustu', 'masaustu bilgisayar', 'kasa', 'desktop'],\\n  ['bilgisayar', 'computer'],\\n  ['supurge', 'dyson', 'elektrikli supurge', 'vacuum'],\\n  ['camasir', 'camasir makinesi', 'yikama'],\\n  ['bulasik', 'bulasik makinesi'],\\n  ['kurutma', 'kurutma makinesi'],\\n  ['seo', 'arama motoru optimizasyonu', 'search engine'],\\n  ['telefon', 'cep telefonu', 'akilli telefon', 'smartphone', 'iphone', 'samsung'],\\n  ['tablet', 'ipad'],\\n  ['tv', 'televizyon', 'smart tv'],\\n  ['oyun', 'gaming', 'gamer', 'oyuncu']\\n];\\n\\n// Build synonym lookup\\nconst synonymMap = new Map();\\nsynonymGroups.forEach(group => {\\n  group.forEach(term => {\\n    const normalized = normalizeForComparison(term);\\n    if (!synonymMap.has(normalized)) {\\n      synonymMap.set(normalized, new Set());\\n    }\\n    group.forEach(syn => {\\n      if (syn !== term) {\\n        synonymMap.get(normalized).add(normalizeForComparison(syn));\\n      }\\n    });\\n  });\\n});\\n\\n// Score-based seed matching\\nfunction findBestSeed(keyword, seeds) {\\n  const kwNorm = normalizeForComparison(keyword);\\n  const kwWords = kwNorm.split(' ').filter(w => w.length >= 2);\\n  \\n  let bestSeed = null;\\n  let bestScore = -1;\\n  \\n  for (const seed of seeds) {\\n    const seedNorm = normalizeForComparison(seed);\\n    const seedWords = seedNorm.split(' ').filter(w => w.length >= 2);\\n    let score = 0;\\n    \\n    // Rule 1: EXACT match = 1000 points\\n    if (kwNorm === seedNorm) {\\n      return seed; // Instant return\\n    }\\n    \\n    // Rule 2: Keyword CONTAINS entire seed = 500 points\\n    if (kwNorm.includes(seedNorm)) {\\n      score += 500;\\n    }\\n    \\n    // Rule 3: Seed CONTAINS entire keyword = 400 points\\n    if (seedNorm.includes(kwNorm)) {\\n      score += 400;\\n    }\\n    \\n    // Rule 4: Direct word match = 100 points each\\n    for (const sw of seedWords) {\\n      if (kwWords.includes(sw)) {\\n        score += 100;\\n      }\\n    }\\n    \\n    // Rule 5: Partial word match (substring) = 50 points each\\n    for (const sw of seedWords) {\\n      if (sw.length >= 4) {\\n        for (const kw of kwWords) {\\n          if (kw.length >= 4 && kw !== sw) {\\n            if (kw.includes(sw) || sw.includes(kw)) {\\n              score += 50;\\n            }\\n          }\\n        }\\n      }\\n    }\\n    \\n    // Rule 6: Synonym match = 75 points each\\n    // Check if any keyword word is a synonym of any seed word\\n    for (const kw of kwWords) {\\n      const kwSynonyms = synonymMap.get(kw) || new Set();\\n      for (const sw of seedWords) {\\n        if (kwSynonyms.has(sw)) {\\n          score += 75;\\n        }\\n      }\\n      // Also check reverse: seed word synonyms contain keyword word\\n      for (const sw of seedWords) {\\n        const swSynonyms = synonymMap.get(sw) || new Set();\\n        if (swSynonyms.has(kw)) {\\n          score += 75;\\n        }\\n      }\\n    }\\n    \\n    // Rule 7: Keyword word appears in synonym group with seed word = 60 points\\n    for (const kw of kwWords) {\\n      for (const sw of seedWords) {\\n        // Check if they're in the same synonym group\\n        const kwSyns = synonymMap.get(kw);\\n        if (kwSyns && kwSyns.has(sw)) {\\n          score += 60;\\n        }\\n      }\\n    }\\n    \\n    if (score > bestScore) {\\n      bestScore = score;\\n      bestSeed = seed;\\n    }\\n  }\\n  \\n  // Minimum score threshold: if no good match, return null (will be assigned to first seed as fallback)\\n  if (bestScore >= 50) {\\n    return bestSeed;\\n  }\\n  \\n  // Last resort fallback to first seed\\n  return seeds[0];\\n}\\n\\n// Parse DataForSEO response\\nlet dataforseoKeywords = [];\\nconst seedVolumeMap = new Map();\\nconst seedMatchDebug = {}; // Debug info for seed matching\\n\\ntry {\\n  const dfsResponse = $input.first().json;\\n  if (dfsResponse?.tasks?.[0]?.result) {\\n    dataforseoKeywords = dfsResponse.tasks[0].result.map(kw => {\\n      const keyword = (kw.keyword || '').toLowerCase().trim();\\n      const seedKw = findBestSeed(keyword, seedKeywords);\\n      \\n      // Track volume for seed keywords\\n      const kwNorm = normalizeForComparison(keyword);\\n      for (const seed of seedKeywords) {\\n        if (normalizeForComparison(seed) === kwNorm && kw.search_volume) {\\n          seedVolumeMap.set(seed, { volume: kw.search_volume, cpc: kw.cpc });\\n        }\\n      }\\n      \\n      return {\\n        keyword: keyword,\\n        seed_keyword: seedKw,\\n        search_volume: kw.search_volume || 0,\\n        cpc: kw.cpc || 0,\\n        competition: kw.competition || null,\\n        source: 'dataforseo'\\n      };\\n    }).filter(kw => kw.keyword && kw.keyword.length >= 2);\\n  }\\n} catch (e) { console.log('DFS error:', e.message); }\\n\\n// Dedupe\\nconst seen = new Map();\\ndataforseoKeywords.forEach(kw => {\\n  const key = normalizeForComparison(kw.keyword);\\n  if (key.length >= 2 && !seen.has(key)) seen.set(key, kw);\\n});\\n\\n// Add ALL seed keywords\\nseedKeywords.forEach((seed, idx) => {\\n  const key = normalizeForComparison(seed);\\n  const existingData = seedVolumeMap.get(seed);\\n  \\n  if (!seen.has(key)) {\\n    seen.set(key, {\\n      keyword: seed.toLowerCase().trim(),\\n      seed_keyword: seed,\\n      search_volume: existingData?.volume || 0,\\n      cpc: existingData?.cpc || 0,\\n      competition: null,\\n      source: 'seed',\\n      is_seed: true,\\n      seed_order: idx\\n    });\\n  } else {\\n    const existing = seen.get(key);\\n    existing.is_seed = true;\\n    existing.seed_order = idx;\\n    existing.seed_keyword = seed; // Ensure seed points to itself\\n  }\\n});\\n\\n// Sort: Seeds first, then by volume\\nconst uniqueKeywords = Array.from(seen.values())\\n  .sort((a, b) => {\\n    if (a.is_seed && !b.is_seed) return -1;\\n    if (!a.is_seed && b.is_seed) return 1;\\n    if (a.is_seed && b.is_seed) return (a.seed_order || 0) - (b.seed_order || 0);\\n    return (b.search_volume || 0) - (a.search_volume || 0);\\n  });\\n\\nconst forAI = uniqueKeywords.slice(0, 150);\\nconst pending = uniqueKeywords.slice(150);\\n\\n// Stats per seed\\nconst seedStats = {};\\nseedKeywords.forEach(seed => {\\n  seedStats[seed] = uniqueKeywords.filter(kw => kw.seed_keyword === seed).length;\\n});\\n\\nreturn [{ json: {\\n  ...input,\\n  allKeywords: uniqueKeywords,\\n  forAI: forAI,\\n  pendingKeywords: pending,\\n  stats: {\\n    total_seeds: seedKeywords.length,\\n    from_dataforseo: dataforseoKeywords.length,\\n    unique: uniqueKeywords.length,\\n    for_ai: forAI.length,\\n    pending: pending.length,\\n    per_seed: seedStats\\n  }\\n}}];"},"id":"5da8159c-55e0-4fd2-bca7-e0b432f9caab","name":"Merge Keywords","type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,112]},{"parameters":{"jsCode":"// ===========================================\\n// BUILD GEMINI PROMPT\\n// ===========================================\\nconst data = $input.first().json;\\nconst keywords = data.forAI || [];\\nconst seedKeywords = data.keywords || [];\\n\\nif (keywords.length === 0) {\\n  return [{ json: { ...data, skipAi: true }}];\\n}\\n\\nconst keywordCsv = keywords.map((kw, i) => {\\n  const vol = kw.search_volume || 0;\\n  const cpc = kw.cpc ? kw.cpc.toFixed(2) : '0';\\n  const seed = kw.seed_keyword || '';\\n  return `${i+1}|${kw.keyword}|${vol}|${cpc}|${seed}`;\\n}).join('\\\\n');\\n\\nconst seedList = seedKeywords.join(', ');\\n\\nconst prompt = `Sen bir SEO uzmanisin. Bir musteri icin TOPLU keyword arastirmasi yapiyoruz.\\n\\nMusterinin arastirmak istedigi SEED KEYWORDLER:\\n${seedList}\\n\\nUlke: ${data.country}\\n\\nAsagidaki keywordler DataForSEO'dan bu seed'lere gore cekildi. Her keyword kendi SEED KEYWORD'u ile iliskili oldugu surece ONAYLA.\\n\\nKEYWORDS (No|keyword|volume|cpc|seed_keyword):\\n${keywordCsv}\\n\\nDEGERLENDIRME KURALLARI:\\n1. Her keyword kendi seed_keyword'u ile iliskili mi bak (son sutun)\\n2. Keyword, seed ile alakali ise ONAYLA\\n3. Spam, anlamsiz veya tamamen alakasiz ise REDDET\\n4. Search volume 0 olsa bile alakali ise ONAYLA\\n5. COGU KEYWORD ONAYLANMALI - sadece gercekten alakasiz olanlari reddet\\n\\nHer keyword icin tek satir cikti ver:\\n- Uygunsa: No|approved|intent|cluster|priority|content_type\\n- Uygun degilse: No|rejected|||||reason\\n\\nIntent: informational, commercial, transactional, navigational\\nPriority: high (volume>1000), medium (100-1000), low (<100)\\nContent_type: pillar, cluster, blog, product, faq\\n\\nSadece satirlari yaz, baska bir sey yazma.`;\\n\\nreturn [{ json: { ...data, filterPrompt: prompt, skipAi: false }}];"},"id":"9de331ab-2a79-49aa-bcec-257a02e76661","name":"Build Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"skip","leftValue":"={{ $json.skipAi }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"03af4e47-31d5-4a61-ba68-097fcbb32d35","name":"IF Run AI","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{ \\"parts\\": [{ \\"text\\": {{ JSON.stringify($json.filterPrompt) }} }] }],\\n  \\"generationConfig\\": { \\"temperature\\": 0.3, \\"maxOutputTokens\\": 8192 }\\n}","options":{"timeout":120000}},"id":"1d6948a1-53da-4433-8012-8043a0ae0995","name":"Gemini Filter","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,0],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// PARSE GEMINI RESPONSE\\n// ===========================================\\nconst prevData = $('Build Prompt').first().json;\\nconst geminiResponse = $input.first().json;\\nconst processedKeywords = prevData.forAI || [];\\nconst pendingKeywords = prevData.pendingKeywords || [];\\n\\nconst approved = [];\\nconst rejected = [];\\n\\ntry {\\n  const text = geminiResponse?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  const lines = text.split('\\\\n').filter(l => /^\\\\d+\\\\|/.test(l.trim()));\\n  const processedIndices = new Set();\\n  \\n  for (const line of lines) {\\n    const parts = line.split('|').map(p => p.trim());\\n    if (parts.length < 2) continue;\\n    \\n    const no = parseInt(parts[0]);\\n    const status = (parts[1] || '').toLowerCase();\\n    \\n    if (isNaN(no) || no < 1 || no > processedKeywords.length) continue;\\n    \\n    const original = processedKeywords[no - 1];\\n    processedIndices.add(no);\\n    \\n    if (status === 'approved') {\\n      approved.push({\\n        ...original,\\n        intent: parts[2] || null,\\n        cluster: parts[3] || null,\\n        priority: parts[4] || 'medium',\\n        content_type: parts[5] || 'cluster',\\n        status: 'approved',\\n        reject_reason: null\\n      });\\n    } else {\\n      rejected.push({\\n        ...original,\\n        intent: null, cluster: parts[3] || null,\\n        priority: null, content_type: null,\\n        status: 'rejected',\\n        reject_reason: parts[6] || 'filtered'\\n      });\\n    }\\n  }\\n  \\n  // Handle skipped keywords\\n  processedKeywords.forEach((kw, idx) => {\\n    if (!processedIndices.has(idx + 1)) {\\n      rejected.push({ ...kw, status: 'pending', reject_reason: 'AI skipped' });\\n    }\\n  });\\n} catch (e) {\\n  console.log('Parse error:', e.message);\\n  processedKeywords.forEach(kw => {\\n    approved.push({ ...kw, status: 'approved', priority: 'medium', content_type: 'cluster' });\\n  });\\n}\\n\\n// Add pending keywords\\npendingKeywords.forEach(kw => {\\n  rejected.push({ ...kw, status: 'pending', reject_reason: null });\\n});\\n\\nconst clusters = {};\\napproved.forEach(kw => {\\n  const c = kw.cluster || 'Genel';\\n  if (!clusters[c]) clusters[c] = [];\\n  clusters[c].push(kw.keyword);\\n});\\n\\nreturn [{ json: {\\n  projectId: prevData.projectId,\\n  clientId: prevData.clientId,\\n  mainKeyword: prevData.keywords[0],\\n  stats: { ...prevData.stats, approved: approved.length, rejected: rejected.length },\\n  approved_keywords: approved,\\n  rejected_keywords: rejected,\\n  all_keywords: [...approved, ...rejected],\\n  clusters,\\n  ai_used: true,\\n  processing_time_ms: Date.now() - prevData.startTime\\n}}];"},"id":"15390360-0a0a-40d3-a04e-57219573b162","name":"Parse Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"jsCode":"// ===========================================\\n// SKIP AI - Mark all as approved\\n// ===========================================\\nconst data = $input.first().json;\\nconst keywords = data.allKeywords || [];\\n\\nconst approved = keywords.slice(0, 50).map(kw => ({\\n  ...kw, status: 'approved', priority: 'medium', content_type: 'cluster'\\n}));\\nconst pending = keywords.slice(50).map(kw => ({\\n  ...kw, status: 'pending', reject_reason: 'AI skipped'\\n}));\\n\\nreturn [{ json: {\\n  projectId: data.projectId,\\n  clientId: data.clientId,\\n  mainKeyword: data.keywords[0],\\n  stats: { ...data.stats, approved: approved.length, rejected: pending.length },\\n  approved_keywords: approved,\\n  rejected_keywords: pending,\\n  all_keywords: [...approved, ...pending],\\n  clusters: { 'Genel': approved.map(k => k.keyword) },\\n  ai_used: false,\\n  processing_time_ms: Date.now() - data.startTime\\n}}];"},"id":"2cc515d3-016d-4105-9378-7a4811fd8695","name":"Skip AI","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"has-project","leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}],"combinator":"and"},"options":{}},"id":"456613fa-b109-4aad-a055-c26b20b494cc","name":"IF Save DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,112]},{"parameters":{"jsCode":"// ===========================================\\n// PREPARE BATCH INSERT\\n// ===========================================\\nconst data = $input.first().json;\\nconst projectId = data.projectId;\\nconst allKeywords = data.all_keywords || [];\\n\\nif (allKeywords.length === 0) {\\n  return [{ json: { skip: true, batchQuery: '' }}];\\n}\\n\\nfunction esc(str) {\\n  if (str === null || str === undefined) return 'NULL';\\n  return \\"'\\" + String(str).replace(/\\\\\\\\/g, '\\\\\\\\\\\\\\\\').replace(/'/g, \\"''\\") + \\"'\\";\\n}\\n\\nconst values = allKeywords.slice(0, 500).map(kw => {\\n  const kwType = kw.source?.includes('suggest') ? 'google_suggest' : 'related';\\n  const src = (kw.source || 'dataforseo').split(',')[0].trim();\\n  return `(${projectId}, ${esc(kw.keyword)}, ${esc(kw.seed_keyword)}, '${kwType}', ${kw.search_volume || 'NULL'}, ${kw.cpc || 'NULL'}, ${esc(kw.competition)}, ${esc(kw.intent)}, ${esc(kw.cluster)}, ${esc(kw.priority)}, ${esc(kw.content_type)}, '${src}', '${kw.status || 'pending'}', ${esc(kw.reject_reason)})`;\\n}).join(',\\\\n');\\n\\nconst query = `INSERT INTO keyword_results (project_id, keyword, seed_keyword, keyword_type, search_volume, cpc, competition, search_intent, keyword_cluster, content_priority, page_type, source, status, reject_reason) VALUES ${values} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume), status=VALUES(status)`;\\n\\nreturn [{ json: { ...data, batchQuery: query }}];"},"id":"b75d89c6-a6fb-49ea-b617-223fd21bb298","name":"Prepare Insert","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"operation":"executeQuery","query":"={{ $json.batchQuery }}","options":{}},"id":"8a9fee3e-a4bb-44fd-bfde-0a8816e99057","name":"Save to DB","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[880,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// FINAL RESPONSE\\n// ===========================================\\nconst data = $('Prepare Insert').first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi. ${approved.length} onaylandi, ${rejected.length} reddedildi.`,\\n  project_id: data.projectId,\\n  stats: data.stats,\\n  keywords: approved.slice(0, 200).map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    intent: kw.intent,\\n    cluster: kw.cluster,\\n    priority: kw.priority,\\n    status: kw.status\\n  })),\\n  rejected: rejected.slice(0, 50).map(kw => ({\\n    keyword: kw.keyword,\\n    reason: kw.reject_reason\\n  })),\\n  clusters: data.clusters,\\n  ai_used: data.ai_used,\\n  processing_time_ms: data.processing_time_ms\\n}}];"},"id":"6c58e736-ce91-4625-a66c-d736028ab048","name":"Response (DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,0]},{"parameters":{"jsCode":"// ===========================================\\n// RESPONSE WITHOUT DB\\n// ===========================================\\nconst data = $input.first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi (DB yok). ${approved.length} onaylandi.`,\\n  project_id: null,\\n  stats: data.stats,\\n  keywords: approved.slice(0, 200),\\n  rejected: rejected.slice(0, 50),\\n  clusters: data.clusters,\\n  ai_used: data.ai_used\\n}}];"},"id":"150b0cea-217a-43de-9f66-1ddba2e2f587","name":"Response (No DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,208]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"26c7661c-7a02-4b2b-ad75-f9bb4f9e47b0","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1328,112]}]	{"Webhook Bulk":{"main":[[{"node":"Validate Input","type":"main","index":0}]]},"Validate Input":{"main":[[{"node":"IF Valid","type":"main","index":0}]]},"IF Valid":{"main":[[{"node":"DataForSEO Bulk","type":"main","index":0}],[{"node":"Respond Error","type":"main","index":0}]]},"DataForSEO Bulk":{"main":[[{"node":"Merge Keywords","type":"main","index":0}]]},"Merge Keywords":{"main":[[{"node":"Build Prompt","type":"main","index":0}]]},"Build Prompt":{"main":[[{"node":"IF Run AI","type":"main","index":0}]]},"IF Run AI":{"main":[[{"node":"Gemini Filter","type":"main","index":0}],[{"node":"Skip AI","type":"main","index":0}]]},"Gemini Filter":{"main":[[{"node":"Parse Response","type":"main","index":0}]]},"Parse Response":{"main":[[{"node":"IF Save DB","type":"main","index":0}]]},"Skip AI":{"main":[[{"node":"IF Save DB","type":"main","index":0}]]},"IF Save DB":{"main":[[{"node":"Prepare Insert","type":"main","index":0}],[{"node":"Response (No DB)","type":"main","index":0}]]},"Prepare Insert":{"main":[[{"node":"Save to DB","type":"main","index":0}]]},"Save to DB":{"main":[[{"node":"Response (DB)","type":"main","index":0}]]},"Response (DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]},"Response (No DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]}}	\N	f	\N
987fe41f-0649-4ccf-8274-12433a51e642	sWwmP23m89DQTpVI	Fatih Berkay Baheci	2025-12-23 19:37:09.381+00	2025-12-23 19:37:09.381+00	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"f8be5171-8134-4daf-bd75-da12f41a2185","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-656,112],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"const body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\n\\nif (!Array.isArray(keywords) || keywords.length === 0) {\\n  return [{json: {error: 'keywords array required', code: 400}}];\\n}\\n\\nconst seeds = keywords\\n  .map(k => String(k).trim().toLowerCase())\\n  .filter(k => k.length >= 2)\\n  .slice(0, 20);\\n\\nif (seeds.length === 0) {\\n  return [{json: {error: 'valid keywords required', code: 400}}];\\n}\\n\\nconst locCodes = {TR: 2792, US: 2840, GB: 2826, DE: 2276};\\n\\n// Clear static data for fresh run\\nconst ctx = $getWorkflowStaticData('global');\\nctx.results = [];\\nctx.projectId = projectId ? parseInt(projectId) : null;\\nctx.clientId = clientId ? parseInt(clientId) : null;\\nctx.startTime = Date.now();\\nctx.totalSeeds = seeds.length;\\n\\n// Return each seed as separate item\\nreturn seeds.map(seed => ({\\n  json: {\\n    seed,\\n    locationCode: locCodes[country] || 2792,\\n    language\\n  }\\n}));"},"id":"69059e90-9eda-49df-bd98-a0f4514e6d8e","name":"Validate","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"options":{}},"id":"1b27f3b9-6411-480a-8b7d-3de3e315deb5","name":"Loop Seeds","type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-224,112]},{"parameters":{"workflowId":{"__rl":true,"mode":"name","value":"WF-BULK-KEYWORD: Single Seed Processor"},"options":{}},"id":"1cbf7267-f46d-4d79-a48b-216ee48d3099","name":"Process Seed","type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[0,0]},{"parameters":{"jsCode":"const result = $input.first().json;\\n\\n// Accumulate results in static data\\nconst ctx = $getWorkflowStaticData('global');\\nif (!ctx.results) ctx.results = [];\\n\\nctx.results.push({\\n  seed: result.seed,\\n  approved: result.approved || [],\\n  rejected: result.rejected || [],\\n  stats: result.stats || {approved: 0, rejected: 0}\\n});\\n\\nreturn [{json: {accumulated: ctx.results.length}}];"},"id":"7dcd75e0-e75f-4639-be4d-8f07405aeedd","name":"Accumulate","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"jsCode":"const ctx = $getWorkflowStaticData('global');\\nconst results = ctx.results || [];\\nconst projectId = ctx.projectId;\\nconst clientId = ctx.clientId;\\nconst startTime = ctx.startTime;\\nconst totalSeeds = ctx.totalSeeds;\\n\\n// Combine all results\\nconst allApproved = [];\\nconst allRejected = [];\\nconst perSeed = {};\\n\\nresults.forEach(r => {\\n  allApproved.push(...(r.approved || []));\\n  allRejected.push(...(r.rejected || []));\\n  perSeed[r.seed] = r.stats;\\n});\\n\\n// Clear static data\\ndelete ctx.results;\\ndelete ctx.projectId;\\ndelete ctx.clientId;\\ndelete ctx.startTime;\\ndelete ctx.totalSeeds;\\n\\nreturn [{json: {\\n  projectId,\\n  clientId,\\n  stats: {\\n    total_seeds: totalSeeds,\\n    total_approved: allApproved.length,\\n    total_rejected: allRejected.length,\\n    per_seed: perSeed\\n  },\\n  approved_keywords: allApproved,\\n  rejected_keywords: allRejected,\\n  startTime\\n}}];"},"id":"49068568-df77-43da-8b46-efcc63a1935e","name":"Finalize","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,304]},{"parameters":{"conditions":{"options":{"leftValue":"","typeValidation":"loose"},"conditions":[{"leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}]},"options":{}},"id":"2a9ccbae-89cd-4249-9527-e1834e6dcc39","name":"IF DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[224,304]},{"parameters":{"jsCode":"const d = $input.first().json;\\nconst all = [...(d.approved_keywords || []), ...(d.rejected_keywords || [])];\\n\\nif (!all.length || !d.projectId) {\\n  return [{json: {...d, query: 'SELECT 1'}}];\\n}\\n\\nconst esc = s => s == null ? 'NULL' : \\"'\\" + String(s).replace(/'/g, \\"''\\") + \\"'\\";\\n\\nconst vals = all.slice(0, 2000).map(k => \\n  `(${d.projectId},${esc(k.keyword)},${esc(k.seed_keyword)},'related',${k.search_volume || 'NULL'},${k.cpc || 'NULL'},NULL,NULL,${esc(k.seed_keyword)},${esc(k.priority || 'medium')},'cluster','dataforseo','${k.status}',NULL)`\\n).join(',');\\n\\nconst query = `INSERT INTO keyword_results(project_id,keyword,seed_keyword,keyword_type,search_volume,cpc,competition,search_intent,keyword_cluster,content_priority,page_type,source,status,reject_reason) VALUES ${vals} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume),status=VALUES(status),seed_keyword=VALUES(seed_keyword)`;\\n\\nreturn [{json: {...d, query}}];"},"id":"1f3fb72c-4953-4e26-b2fd-10722562a847","name":"Build SQL","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,208]},{"parameters":{"operation":"executeQuery","query":"={{ $json.query }}","options":{}},"id":"9c0dd2b0-33b3-413e-b800-8dd7d4d3b225","name":"MySQL","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const d = $('Build SQL').first().json;\\nreturn [{json: {\\n  success: true,\\n  message: `Bulk tamamlandi: ${d.approved_keywords?.length || 0} ana sonuc, ${d.rejected_keywords?.length || 0} diger`,\\n  project_id: d.projectId,\\n  stats: d.stats,\\n  keywords: (d.approved_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume,\\n    priority: k.priority,\\n    status: k.status\\n  })),\\n  rejected_keywords: (d.rejected_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume\\n  })),\\n  processing_time_ms: Date.now() - d.startTime\\n}}];"},"id":"5f149a32-cebf-4fc5-b694-74ba3b52eb78","name":"Response DB","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,208]},{"parameters":{"jsCode":"const d = $input.first().json;\\nreturn [{json: {\\n  success: true,\\n  message: `Bulk tamamlandi: ${d.approved_keywords?.length || 0} ana sonuc, ${d.rejected_keywords?.length || 0} diger`,\\n  project_id: null,\\n  stats: d.stats,\\n  keywords: (d.approved_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume,\\n    priority: k.priority,\\n    status: k.status\\n  })),\\n  rejected_keywords: (d.rejected_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume\\n  })),\\n  processing_time_ms: Date.now() - d.startTime\\n}}];"},"id":"367721c7-aef2-4ec4-9a9f-849477e8a1c0","name":"Response No DB","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,400]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"9aee1de5-3315-4eeb-b747-b288af9d5ba7","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1104,304]}]	{"Webhook":{"main":[[{"node":"Validate","type":"main","index":0}]]},"Validate":{"main":[[{"node":"Loop Seeds","type":"main","index":0}]]},"Loop Seeds":{"main":[[{"node":"Process Seed","type":"main","index":0}],[{"node":"Finalize","type":"main","index":0}]]},"Process Seed":{"main":[[{"node":"Accumulate","type":"main","index":0}]]},"Accumulate":{"main":[[{"node":"Loop Seeds","type":"main","index":0}]]},"Finalize":{"main":[[{"node":"IF DB","type":"main","index":0}]]},"IF DB":{"main":[[{"node":"Build SQL","type":"main","index":0}],[{"node":"Response No DB","type":"main","index":0}]]},"Build SQL":{"main":[[{"node":"MySQL","type":"main","index":0}]]},"MySQL":{"main":[[{"node":"Response DB","type":"main","index":0}]]},"Response DB":{"main":[[{"node":"Respond","type":"main","index":0}]]},"Response No DB":{"main":[[{"node":"Respond","type":"main","index":0}]]}}	\N	f	\N
d37e0b7d-1e7a-4f7f-a20e-a6bb3238715b	MhHeIUZBSMtqRRrR	Fatih Berkay Baheci	2025-12-23 19:39:02.497+00	2025-12-23 19:39:02.497+00	[{"parameters":{},"id":"908e6211-af91-4ad5-b2b9-2ef3806d7bfd","name":"Execute Workflow Trigger","type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1,"position":[0,0]},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\"keywords\\": [\\"{{ $json.seed }}\\"], \\"location_code\\": {{ $json.locationCode }}, \\"language_code\\": \\"{{ $json.language }}\\", \\"include_seed_keyword\\": true, \\"sort_by\\": \\"search_volume\\"}]","options":{"timeout":60000}},"id":"4d7a9a87-7a72-4699-a225-6f54bc4668aa","name":"DataForSEO","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[224,0],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const input = $('Execute Workflow Trigger').first().json;\\nconst dfs = $input.first().json;\\nconst seed = input.seed;\\n\\nlet keywords = [];\\ntry {\\n  if (dfs?.tasks?.[0]?.result) {\\n    keywords = dfs.tasks[0].result.map(k => ({\\n      kw: (k.keyword || '').toLowerCase().trim(),\\n      vol: k.search_volume || 0,\\n      cpc: k.cpc || 0\\n    })).filter(k => k.kw.length >= 2);\\n  }\\n} catch(e) {}\\n\\n// Dedupe\\nconst seen = new Set();\\nconst unique = keywords.filter(k => {\\n  if (seen.has(k.kw)) return false;\\n  seen.add(k.kw);\\n  return true;\\n}).slice(0, 500);\\n\\nif (unique.length === 0) {\\n  return [{json: {\\n    seed,\\n    approved: [],\\n    rejected: [],\\n    stats: {approved: 0, rejected: 0}\\n  }}];\\n}\\n\\nconst kwList = unique.map((k, i) => `${i+1}|${k.kw}|${k.vol}`).join('\\\\n');\\n\\nconst prompt = `\\"${seed}\\" icin anahtar kelime analizi.\\n\\nKEYWORDS (no|keyword|volume):\\n${kwList}\\n\\nGOREV:\\n1. Icerik olusturmaya UYGUN olanlari sec (max 35 adet)\\n   - Blog/makale konusu olabilir mi?\\n   - Arama amaci net mi?\\n   - Bilgi verici icerik yazilabilir mi?\\n   \\n2. UYGUN OLMAYANLAR:\\n   - Sadece marka+model (ornek: \\"nike air max 90\\")\\n   - Cok genel (ornek: \\"ayakkabi\\")\\n   - Fiyat sorgulari (ornek: \\"spor ayakkabi fiyatlari\\")\\n   - Satin alma niyetli (ornek: \\"spor ayakkabi satin al\\")\\n\\n3. Benzer kelimeler tek secilsin:\\n   - fiyat/fiyati/fiyatlari  sadece 1 tane\\n   - erkek/erkekler  sadece 1 tane\\n\\nCIKTI FORMATI (SADECE BU SATIRLAR):\\nCONTENT:1,5,8,12,15\\nOTHERS:2,3,4,6,7,9,10,11,13,14\\n\\nACIKLAMA YAZMA. SADECE NUMARALAR.`;\\n\\nreturn [{json: {...input, keywords: unique, prompt}}];"},"id":"6302aac9-0e7a-4769-8c0a-5687fe36c7bc","name":"Parse DFS","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\"contents\\":[{\\"parts\\":[{\\"text\\":{{ JSON.stringify($json.prompt) }}}]}],\\"generationConfig\\":{\\"temperature\\":0.1,\\"maxOutputTokens\\":4096}}","options":{"timeout":60000}},"id":"302ecb84-712e-4c82-9254-7d050959f37b","name":"Gemini","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[672,0],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const prev = $('Parse DFS').first().json;\\nconst gemini = $input.first().json;\\nconst seed = prev.seed;\\nconst kws = prev.keywords || [];\\n\\nconst approved = [];\\nconst rejected = [];\\n\\ntry {\\n  const txt = gemini?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  \\n  // Parse CONTENT line\\n  const contentMatch = txt.match(/CONTENT[:\\\\s]*([\\\\d,\\\\s]+)/i);\\n  const contentNos = contentMatch \\n    ? contentMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => n > 0 && n <= kws.length)\\n    : [];\\n  \\n  // Parse OTHERS line\\n  const othersMatch = txt.match(/OTHERS[:\\\\s]*([\\\\d,\\\\s]+)/i);\\n  const othersNos = othersMatch\\n    ? othersMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => n > 0 && n <= kws.length)\\n    : [];\\n  \\n  // Build approved list\\n  contentNos.forEach(n => {\\n    const k = kws[n - 1];\\n    if (k) {\\n      approved.push({\\n        keyword: k.kw,\\n        seed_keyword: seed,\\n        search_volume: k.vol,\\n        cpc: k.cpc,\\n        status: 'approved',\\n        priority: k.vol >= 5000 ? 'high' : k.vol >= 1000 ? 'medium' : 'low'\\n      });\\n    }\\n  });\\n  \\n  // Build rejected list\\n  othersNos.forEach(n => {\\n    const k = kws[n - 1];\\n    if (k) {\\n      rejected.push({\\n        keyword: k.kw,\\n        seed_keyword: seed,\\n        search_volume: k.vol,\\n        cpc: k.cpc,\\n        status: 'rejected'\\n      });\\n    }\\n  });\\n  \\n} catch(e) {\\n  // Fallback: top 35 by volume\\n  const sorted = [...kws].sort((a, b) => b.vol - a.vol);\\n  sorted.slice(0, 35).forEach(k => {\\n    approved.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'approved',\\n      priority: k.vol >= 5000 ? 'high' : k.vol >= 1000 ? 'medium' : 'low'\\n    });\\n  });\\n  sorted.slice(35).forEach(k => {\\n    rejected.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'rejected'\\n    });\\n  });\\n}\\n\\n// If no approved from Gemini, fallback\\nif (approved.length === 0 && kws.length > 0) {\\n  const sorted = [...kws].sort((a, b) => b.vol - a.vol);\\n  sorted.slice(0, 35).forEach(k => {\\n    approved.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'approved',\\n      priority: 'medium'\\n    });\\n  });\\n  sorted.slice(35).forEach(k => {\\n    rejected.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'rejected'\\n    });\\n  });\\n}\\n\\nreturn [{json: {\\n  seed,\\n  approved,\\n  rejected,\\n  stats: {\\n    approved: approved.length,\\n    rejected: rejected.length\\n  }\\n}}];"},"id":"79a4aa5b-7757-4fde-a3ce-3a00c05f9451","name":"Parse Gemini","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,0]}]	{"Execute Workflow Trigger":{"main":[[{"node":"DataForSEO","type":"main","index":0}]]},"DataForSEO":{"main":[[{"node":"Parse DFS","type":"main","index":0}]]},"Parse DFS":{"main":[[{"node":"Gemini","type":"main","index":0}]]},"Gemini":{"main":[[{"node":"Parse Gemini","type":"main","index":0}]]}}	\N	f	\N
35582cc8-1c65-48eb-a9bf-1cb91e70932b	sWwmP23m89DQTpVI	Fatih Berkay Baheci	2025-12-23 19:54:52.518+00	2025-12-23 19:54:52.518+00	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"7a4686a8-c032-49ac-8603-2e91eeb6fc03","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-656,112],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"const body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\n\\nif (!Array.isArray(keywords) || keywords.length === 0) {\\n  return [{json: {error: 'keywords array required', code: 400}}];\\n}\\n\\nconst seeds = keywords\\n  .map(k => String(k).trim().toLowerCase())\\n  .filter(k => k.length >= 2)\\n  .slice(0, 20);\\n\\nif (seeds.length === 0) {\\n  return [{json: {error: 'valid keywords required', code: 400}}];\\n}\\n\\nconst locCodes = {TR: 2792, US: 2840, GB: 2826, DE: 2276};\\n\\n// Clear static data for fresh run\\nconst ctx = $getWorkflowStaticData('global');\\nctx.results = [];\\nctx.projectId = projectId ? parseInt(projectId) : null;\\nctx.clientId = clientId ? parseInt(clientId) : null;\\nctx.startTime = Date.now();\\nctx.totalSeeds = seeds.length;\\n\\n// Return each seed as separate item\\nreturn seeds.map(seed => ({\\n  json: {\\n    seed,\\n    locationCode: locCodes[country] || 2792,\\n    language\\n  }\\n}));"},"id":"e00aa475-179b-4157-bf38-b4d274937271","name":"Validate","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"options":{}},"id":"84410ee5-19a9-47fb-9197-545c7da900c0","name":"Loop Seeds","type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-224,112]},{"parameters":{"workflowId":{"__rl":true,"mode":"id","value":"MhHeIUZBSMtqRRrR"},"options":{}},"id":"467d2bcd-e6d2-467c-b0a1-da31ba66bcbb","name":"Process Seed","type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[0,0]},{"parameters":{"jsCode":"const result = $input.first().json;\\n\\n// Accumulate results in static data\\nconst ctx = $getWorkflowStaticData('global');\\nif (!ctx.results) ctx.results = [];\\n\\nctx.results.push({\\n  seed: result.seed,\\n  approved: result.approved || [],\\n  rejected: result.rejected || [],\\n  stats: result.stats || {approved: 0, rejected: 0}\\n});\\n\\nreturn [{json: {accumulated: ctx.results.length}}];"},"id":"f416ec62-fbdc-49a6-ad95-eb1d9120c79a","name":"Accumulate","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"jsCode":"const ctx = $getWorkflowStaticData('global');\\nconst results = ctx.results || [];\\nconst projectId = ctx.projectId;\\nconst clientId = ctx.clientId;\\nconst startTime = ctx.startTime;\\nconst totalSeeds = ctx.totalSeeds;\\n\\n// Combine all results\\nconst allApproved = [];\\nconst allRejected = [];\\nconst perSeed = {};\\n\\nresults.forEach(r => {\\n  allApproved.push(...(r.approved || []));\\n  allRejected.push(...(r.rejected || []));\\n  perSeed[r.seed] = r.stats;\\n});\\n\\n// Clear static data\\ndelete ctx.results;\\ndelete ctx.projectId;\\ndelete ctx.clientId;\\ndelete ctx.startTime;\\ndelete ctx.totalSeeds;\\n\\nreturn [{json: {\\n  projectId,\\n  clientId,\\n  stats: {\\n    total_seeds: totalSeeds,\\n    total_approved: allApproved.length,\\n    total_rejected: allRejected.length,\\n    per_seed: perSeed\\n  },\\n  approved_keywords: allApproved,\\n  rejected_keywords: allRejected,\\n  startTime\\n}}];"},"id":"9df0fd50-cbc1-4670-b30d-4bd75f83920c","name":"Finalize","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,304]},{"parameters":{"conditions":{"options":{"leftValue":"","typeValidation":"loose"},"conditions":[{"leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}]},"options":{}},"id":"5e518832-eeb2-44cd-88a3-f92b63aa3c73","name":"IF DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[224,304]},{"parameters":{"jsCode":"const d = $input.first().json;\\nconst all = [...(d.approved_keywords || []), ...(d.rejected_keywords || [])];\\n\\nif (!all.length || !d.projectId) {\\n  return [{json: {...d, query: 'SELECT 1'}}];\\n}\\n\\nconst esc = s => s == null ? 'NULL' : \\"'\\" + String(s).replace(/'/g, \\"''\\") + \\"'\\";\\n\\nconst vals = all.slice(0, 2000).map(k => \\n  `(${d.projectId},${esc(k.keyword)},${esc(k.seed_keyword)},'related',${k.search_volume || 'NULL'},${k.cpc || 'NULL'},NULL,NULL,${esc(k.seed_keyword)},${esc(k.priority || 'medium')},'cluster','dataforseo','${k.status}',NULL)`\\n).join(',');\\n\\nconst query = `INSERT INTO keyword_results(project_id,keyword,seed_keyword,keyword_type,search_volume,cpc,competition,search_intent,keyword_cluster,content_priority,page_type,source,status,reject_reason) VALUES ${vals} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume),status=VALUES(status),seed_keyword=VALUES(seed_keyword)`;\\n\\nreturn [{json: {...d, query}}];"},"id":"8b70f825-ef2e-4d4e-bcda-2a2ec3ed6b0f","name":"Build SQL","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,208]},{"parameters":{"operation":"executeQuery","query":"={{ $json.query }}","options":{}},"id":"78f44e52-56f6-40de-b182-4d70964b37bb","name":"MySQL","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const d = $('Build SQL').first().json;\\nreturn [{json: {\\n  success: true,\\n  message: `Bulk tamamlandi: ${d.approved_keywords?.length || 0} ana sonuc, ${d.rejected_keywords?.length || 0} diger`,\\n  project_id: d.projectId,\\n  stats: d.stats,\\n  keywords: (d.approved_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume,\\n    priority: k.priority,\\n    status: k.status\\n  })),\\n  rejected_keywords: (d.rejected_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume\\n  })),\\n  processing_time_ms: Date.now() - d.startTime\\n}}];"},"id":"abeac08c-751c-4558-9b77-7c35715baefe","name":"Response DB","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,208]},{"parameters":{"jsCode":"const d = $input.first().json;\\nreturn [{json: {\\n  success: true,\\n  message: `Bulk tamamlandi: ${d.approved_keywords?.length || 0} ana sonuc, ${d.rejected_keywords?.length || 0} diger`,\\n  project_id: null,\\n  stats: d.stats,\\n  keywords: (d.approved_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume,\\n    priority: k.priority,\\n    status: k.status\\n  })),\\n  rejected_keywords: (d.rejected_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume\\n  })),\\n  processing_time_ms: Date.now() - d.startTime\\n}}];"},"id":"c23881c5-dc7d-4f9d-bf66-4d48b199d8a4","name":"Response No DB","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,400]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"4ca429dc-b6c8-44a3-870e-aba7b21191fd","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1104,304]}]	{"Webhook":{"main":[[{"node":"Validate","type":"main","index":0}]]},"Validate":{"main":[[{"node":"Loop Seeds","type":"main","index":0}]]},"Loop Seeds":{"main":[[{"node":"Process Seed","type":"main","index":0}],[{"node":"Finalize","type":"main","index":0}]]},"Process Seed":{"main":[[{"node":"Accumulate","type":"main","index":0}]]},"Accumulate":{"main":[[{"node":"Loop Seeds","type":"main","index":0}]]},"Finalize":{"main":[[{"node":"IF DB","type":"main","index":0}]]},"IF DB":{"main":[[{"node":"Build SQL","type":"main","index":0}],[{"node":"Response No DB","type":"main","index":0}]]},"Build SQL":{"main":[[{"node":"MySQL","type":"main","index":0}]]},"MySQL":{"main":[[{"node":"Response DB","type":"main","index":0}]]},"Response DB":{"main":[[{"node":"Respond","type":"main","index":0}]]},"Response No DB":{"main":[[{"node":"Respond","type":"main","index":0}]]}}	\N	f	\N
144488f0-2d2e-46a5-a12d-ad44f6d654f0	mNQs5AgZjCB0MIZx	Fatih Berkay Baheci	2025-12-23 19:55:02.057+00	2025-12-23 19:55:02.057+00	[{"parameters":{"httpMethod":"POST","path":"process-single-seed","responseMode":"lastNode","options":{}},"id":"fcfc61e4-e847-4a8b-a86a-a6686ed16414","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"process-single-seed"},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\"keywords\\": [\\"{{ $json.body.seed }}\\"], \\"location_code\\": {{ $json.body.locationCode }}, \\"language_code\\": \\"{{ $json.body.language }}\\", \\"include_seed_keyword\\": true, \\"sort_by\\": \\"search_volume\\"}]","options":{"timeout":60000}},"id":"e6557281-4a09-47d5-a3e9-f7cae426abc9","name":"DataForSEO","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[224,0],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const input = $('Webhook').first().json.body;\\nconst dfs = $input.first().json;\\nconst seed = input.seed;\\n\\nlet keywords = [];\\ntry {\\n  if (dfs?.tasks?.[0]?.result) {\\n    keywords = dfs.tasks[0].result.map(k => ({\\n      kw: (k.keyword || '').toLowerCase().trim(),\\n      vol: k.search_volume || 0,\\n      cpc: k.cpc || 0\\n    })).filter(k => k.kw.length >= 2);\\n  }\\n} catch(e) {}\\n\\n// Dedupe\\nconst seen = new Set();\\nconst unique = keywords.filter(k => {\\n  if (seen.has(k.kw)) return false;\\n  seen.add(k.kw);\\n  return true;\\n}).slice(0, 500);\\n\\nif (unique.length === 0) {\\n  return [{json: {\\n    seed,\\n    approved: [],\\n    rejected: [],\\n    stats: {approved: 0, rejected: 0}\\n  }}];\\n}\\n\\nconst kwList = unique.map((k, i) => `${i+1}|${k.kw}|${k.vol}`).join('\\\\n');\\n\\nconst prompt = `\\"${seed}\\" icin anahtar kelime analizi.\\n\\nKEYWORDS (no|keyword|volume):\\n${kwList}\\n\\nGOREV:\\n1. Icerik olusturmaya UYGUN olanlari sec (max 35 adet)\\n   - Blog/makale konusu olabilir mi?\\n   - Arama amaci net mi?\\n   - Bilgi verici icerik yazilabilir mi?\\n   \\n2. UYGUN OLMAYANLAR:\\n   - Sadece marka+model (ornek: \\"nike air max 90\\")\\n   - Cok genel (ornek: \\"ayakkabi\\")\\n   - Fiyat sorgulari (ornek: \\"spor ayakkabi fiyatlari\\")\\n   - Satin alma niyetli (ornek: \\"spor ayakkabi satin al\\")\\n\\n3. Benzer kelimeler tek secilsin:\\n   - fiyat/fiyati/fiyatlari  sadece 1 tane\\n   - erkek/erkekler  sadece 1 tane\\n\\nCIKTI FORMATI (SADECE BU SATIRLAR):\\nCONTENT:1,5,8,12,15\\nOTHERS:2,3,4,6,7,9,10,11,13,14\\n\\nACIKLAMA YAZMA. SADECE NUMARALAR.`;\\n\\nreturn [{json: {seed, keywords: unique, prompt}}];"},"id":"d48261ca-cfd5-442c-a33c-3eefd48a9fd0","name":"Parse DFS","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\"contents\\":[{\\"parts\\":[{\\"text\\":{{ JSON.stringify($json.prompt) }}}]}],\\"generationConfig\\":{\\"temperature\\":0.1,\\"maxOutputTokens\\":4096}}","options":{"timeout":60000}},"id":"833a122e-b572-4974-9b7a-580f7f7d9227","name":"Gemini","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[672,0],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const prev = $('Parse DFS').first().json;\\nconst gemini = $input.first().json;\\nconst seed = prev.seed;\\nconst kws = prev.keywords || [];\\n\\nconst approved = [];\\nconst rejected = [];\\n\\ntry {\\n  const txt = gemini?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  \\n  // Parse CONTENT line\\n  const contentMatch = txt.match(/CONTENT[:\\\\s]*([\\\\d,\\\\s]+)/i);\\n  const contentNos = contentMatch \\n    ? contentMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => n > 0 && n <= kws.length)\\n    : [];\\n  \\n  // Parse OTHERS line\\n  const othersMatch = txt.match(/OTHERS[:\\\\s]*([\\\\d,\\\\s]+)/i);\\n  const othersNos = othersMatch\\n    ? othersMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => n > 0 && n <= kws.length)\\n    : [];\\n  \\n  // Build approved list\\n  contentNos.forEach(n => {\\n    const k = kws[n - 1];\\n    if (k) {\\n      approved.push({\\n        keyword: k.kw,\\n        seed_keyword: seed,\\n        search_volume: k.vol,\\n        cpc: k.cpc,\\n        status: 'approved',\\n        priority: k.vol >= 5000 ? 'high' : k.vol >= 1000 ? 'medium' : 'low'\\n      });\\n    }\\n  });\\n  \\n  // Build rejected list\\n  othersNos.forEach(n => {\\n    const k = kws[n - 1];\\n    if (k) {\\n      rejected.push({\\n        keyword: k.kw,\\n        seed_keyword: seed,\\n        search_volume: k.vol,\\n        cpc: k.cpc,\\n        status: 'rejected'\\n      });\\n    }\\n  });\\n  \\n} catch(e) {\\n  // Fallback: top 35 by volume\\n  const sorted = [...kws].sort((a, b) => b.vol - a.vol);\\n  sorted.slice(0, 35).forEach(k => {\\n    approved.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'approved',\\n      priority: k.vol >= 5000 ? 'high' : k.vol >= 1000 ? 'medium' : 'low'\\n    });\\n  });\\n  sorted.slice(35).forEach(k => {\\n    rejected.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'rejected'\\n    });\\n  });\\n}\\n\\n// If no approved from Gemini, fallback\\nif (approved.length === 0 && kws.length > 0) {\\n  const sorted = [...kws].sort((a, b) => b.vol - a.vol);\\n  sorted.slice(0, 35).forEach(k => {\\n    approved.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'approved',\\n      priority: 'medium'\\n    });\\n  });\\n  sorted.slice(35).forEach(k => {\\n    rejected.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'rejected'\\n    });\\n  });\\n}\\n\\nreturn [{json: {\\n  seed,\\n  approved,\\n  rejected,\\n  stats: {\\n    approved: approved.length,\\n    rejected: rejected.length\\n  }\\n}}];"},"id":"f46983bb-41d3-492e-8806-415d09e85b3c","name":"Parse Gemini","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,0]}]	{"Webhook":{"main":[[{"node":"DataForSEO","type":"main","index":0}]]},"DataForSEO":{"main":[[{"node":"Parse DFS","type":"main","index":0}]]},"Parse DFS":{"main":[[{"node":"Gemini","type":"main","index":0}]]},"Gemini":{"main":[[{"node":"Parse Gemini","type":"main","index":0}]]}}	\N	f	\N
831c1266-c28b-4250-bd2a-bfcf243acbff	wl9T4eOGoazJkDdv	Fatih Berkay Baheci	2025-12-23 19:55:15.963+00	2025-12-23 19:55:15.963+00	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"fe47fbb2-4922-4bea-883f-93e110f9deeb","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-656,112],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"const body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\n\\nif (!Array.isArray(keywords) || keywords.length === 0) {\\n  return [{json: {error: 'keywords array required', code: 400}}];\\n}\\n\\nconst seeds = keywords\\n  .map(k => String(k).trim().toLowerCase())\\n  .filter(k => k.length >= 2)\\n  .slice(0, 20);\\n\\nif (seeds.length === 0) {\\n  return [{json: {error: 'valid keywords required', code: 400}}];\\n}\\n\\nconst locCodes = {TR: 2792, US: 2840, GB: 2826, DE: 2276};\\n\\n// Clear static data for fresh run\\nconst ctx = $getWorkflowStaticData('global');\\nctx.results = [];\\nctx.projectId = projectId ? parseInt(projectId) : null;\\nctx.clientId = clientId ? parseInt(clientId) : null;\\nctx.startTime = Date.now();\\nctx.totalSeeds = seeds.length;\\nctx.locationCode = locCodes[country] || 2792;\\nctx.language = language;\\n\\n// Return each seed as separate item\\nreturn seeds.map(seed => ({\\n  json: {\\n    seed,\\n    locationCode: locCodes[country] || 2792,\\n    language\\n  }\\n}));"},"id":"66291a55-53c6-43d2-a1d9-97856d1d9331","name":"Validate","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"options":{}},"id":"b2a15344-ff72-4b6b-8ebf-ba04a9316802","name":"Loop Seeds","type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-224,112]},{"parameters":{"method":"POST","url":"http://localhost:5678/webhook/process-single-seed","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($json) }}","options":{"timeout":120000}},"id":"1b5f299b-09db-47c7-93bc-40a2a5efbe21","name":"Process Seed","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,0],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const result = $input.first().json;\\n\\n// Accumulate results in static data\\nconst ctx = $getWorkflowStaticData('global');\\nif (!ctx.results) ctx.results = [];\\n\\nctx.results.push({\\n  seed: result.seed,\\n  approved: result.approved || [],\\n  rejected: result.rejected || [],\\n  stats: result.stats || {approved: 0, rejected: 0}\\n});\\n\\nreturn [{json: {accumulated: ctx.results.length}}];"},"id":"8d5a8f81-b60e-4091-b4fa-6874c576fa0b","name":"Accumulate","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"jsCode":"const ctx = $getWorkflowStaticData('global');\\nconst results = ctx.results || [];\\nconst projectId = ctx.projectId;\\nconst clientId = ctx.clientId;\\nconst startTime = ctx.startTime;\\nconst totalSeeds = ctx.totalSeeds;\\n\\n// Combine all results\\nconst allApproved = [];\\nconst allRejected = [];\\nconst perSeed = {};\\n\\nresults.forEach(r => {\\n  allApproved.push(...(r.approved || []));\\n  allRejected.push(...(r.rejected || []));\\n  perSeed[r.seed] = r.stats;\\n});\\n\\n// Clear static data\\ndelete ctx.results;\\ndelete ctx.projectId;\\ndelete ctx.clientId;\\ndelete ctx.startTime;\\ndelete ctx.totalSeeds;\\n\\nreturn [{json: {\\n  projectId,\\n  clientId,\\n  stats: {\\n    total_seeds: totalSeeds,\\n    total_approved: allApproved.length,\\n    total_rejected: allRejected.length,\\n    per_seed: perSeed\\n  },\\n  approved_keywords: allApproved,\\n  rejected_keywords: allRejected,\\n  startTime\\n}}];"},"id":"583e45a4-e846-4033-86bc-d0133fb4c676","name":"Finalize","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,304]},{"parameters":{"conditions":{"options":{"leftValue":"","typeValidation":"loose"},"conditions":[{"leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}]},"options":{}},"id":"26fc10f6-7207-4ba5-9555-b36d06db6ea1","name":"IF DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[224,304]},{"parameters":{"jsCode":"const d = $input.first().json;\\nconst all = [...(d.approved_keywords || []), ...(d.rejected_keywords || [])];\\n\\nif (!all.length || !d.projectId) {\\n  return [{json: {...d, query: 'SELECT 1'}}];\\n}\\n\\nconst esc = s => s == null ? 'NULL' : \\"'\\" + String(s).replace(/'/g, \\"''\\") + \\"'\\";\\n\\nconst vals = all.slice(0, 2000).map(k => \\n  `(${d.projectId},${esc(k.keyword)},${esc(k.seed_keyword)},'related',${k.search_volume || 'NULL'},${k.cpc || 'NULL'},NULL,NULL,${esc(k.seed_keyword)},${esc(k.priority || 'medium')},'cluster','dataforseo','${k.status}',NULL)`\\n).join(',');\\n\\nconst query = `INSERT INTO keyword_results(project_id,keyword,seed_keyword,keyword_type,search_volume,cpc,competition,search_intent,keyword_cluster,content_priority,page_type,source,status,reject_reason) VALUES ${vals} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume),status=VALUES(status),seed_keyword=VALUES(seed_keyword)`;\\n\\nreturn [{json: {...d, query}}];"},"id":"f721fc93-5baa-4314-9f43-58dbaf74916f","name":"Build SQL","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,208]},{"parameters":{"operation":"executeQuery","query":"={{ $json.query }}","options":{}},"id":"d19cf124-ee3f-4150-979f-c659e0e1ccc8","name":"MySQL","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const d = $('Build SQL').first().json;\\nreturn [{json: {\\n  success: true,\\n  message: `Bulk tamamlandi: ${d.approved_keywords?.length || 0} ana sonuc, ${d.rejected_keywords?.length || 0} diger`,\\n  project_id: d.projectId,\\n  stats: d.stats,\\n  keywords: (d.approved_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume,\\n    priority: k.priority,\\n    status: k.status\\n  })),\\n  rejected_keywords: (d.rejected_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume\\n  })),\\n  processing_time_ms: Date.now() - d.startTime\\n}}];"},"id":"3afa1f67-51d9-4bb3-9363-d36ffe04a8ca","name":"Response DB","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,208]},{"parameters":{"jsCode":"const d = $input.first().json;\\nreturn [{json: {\\n  success: true,\\n  message: `Bulk tamamlandi: ${d.approved_keywords?.length || 0} ana sonuc, ${d.rejected_keywords?.length || 0} diger`,\\n  project_id: null,\\n  stats: d.stats,\\n  keywords: (d.approved_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume,\\n    priority: k.priority,\\n    status: k.status\\n  })),\\n  rejected_keywords: (d.rejected_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume\\n  })),\\n  processing_time_ms: Date.now() - d.startTime\\n}}];"},"id":"c6f8101c-4e4d-4226-9ee6-e5222589bc51","name":"Response No DB","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,400]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"f3e3f418-b594-478a-b9c9-a580dacd2a06","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1104,304]}]	{"Webhook":{"main":[[{"node":"Validate","type":"main","index":0}]]},"Validate":{"main":[[{"node":"Loop Seeds","type":"main","index":0}]]},"Loop Seeds":{"main":[[{"node":"Process Seed","type":"main","index":0}],[{"node":"Finalize","type":"main","index":0}]]},"Process Seed":{"main":[[{"node":"Accumulate","type":"main","index":0}]]},"Accumulate":{"main":[[{"node":"Loop Seeds","type":"main","index":0}]]},"Finalize":{"main":[[{"node":"IF DB","type":"main","index":0}]]},"IF DB":{"main":[[{"node":"Build SQL","type":"main","index":0}],[{"node":"Response No DB","type":"main","index":0}]]},"Build SQL":{"main":[[{"node":"MySQL","type":"main","index":0}]]},"MySQL":{"main":[[{"node":"Response DB","type":"main","index":0}]]},"Response DB":{"main":[[{"node":"Respond","type":"main","index":0}]]},"Response No DB":{"main":[[{"node":"Respond","type":"main","index":0}]]}}	\N	f	\N
3f0ba1a2-c731-440b-963c-87cb5361b2c7	wl9T4eOGoazJkDdv	Fatih Berkay Baheci	2025-12-23 20:03:37.503+00	2025-12-23 20:03:37.503+00	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"2adab057-4eef-4a13-ae8f-af68dd9fa417","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1104,112],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"const body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\n\\nif (!Array.isArray(keywords) || keywords.length === 0) {\\n  return [{json: {error: 'keywords array required', code: 400}}];\\n}\\n\\nconst seeds = keywords\\n  .map(k => String(k).trim().toLowerCase())\\n  .filter(k => k.length >= 2)\\n  .slice(0, 20);\\n\\nif (seeds.length === 0) {\\n  return [{json: {error: 'valid keywords required', code: 400}}];\\n}\\n\\nconst locCodes = {TR: 2792, US: 2840, GB: 2826, DE: 2276};\\nconst locationCode = locCodes[country] || 2792;\\n\\n// Return each seed as separate item for sequential processing\\nreturn seeds.map((seed, idx) => ({\\n  json: {\\n    seed,\\n    seedIndex: idx,\\n    totalSeeds: seeds.length,\\n    locationCode,\\n    language,\\n    projectId: projectId ? parseInt(projectId) : null,\\n    clientId: clientId ? parseInt(clientId) : null,\\n    startTime: Date.now()\\n  }\\n}));"},"id":"becf9734-d29b-4df3-be6c-0704c5c8d26d","name":"Validate","type":"n8n-nodes-base.code","typeVersion":2,"position":[-880,112]},{"parameters":{"method":"POST","url":"http://localhost:5678/webhook/process-single-seed","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"seed\\": \\"{{ $json.seed }}\\",\\n  \\"locationCode\\": {{ $json.locationCode }},\\n  \\"language\\": \\"{{ $json.language }}\\"\\n}","options":{"batching":{"batch":{"batchSize":1}},"timeout":120000}},"id":"4ba38dc6-1bf0-4661-8f82-586d3d0b2f22","name":"Process Seeds","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-656,112],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const items = $input.all();\\nconst firstItem = $('Validate').first().json;\\nconst projectId = firstItem.projectId;\\nconst clientId = firstItem.clientId;\\nconst startTime = firstItem.startTime;\\nconst totalSeeds = firstItem.totalSeeds;\\n\\n// Combine all results\\nconst allApproved = [];\\nconst allRejected = [];\\nconst perSeed = {};\\n\\nitems.forEach(item => {\\n  const r = item.json;\\n  if (r.seed) {\\n    allApproved.push(...(r.approved || []));\\n    allRejected.push(...(r.rejected || []));\\n    perSeed[r.seed] = r.stats || {approved: 0, rejected: 0};\\n  }\\n});\\n\\nreturn [{json: {\\n  projectId,\\n  clientId,\\n  stats: {\\n    total_seeds: totalSeeds,\\n    total_approved: allApproved.length,\\n    total_rejected: allRejected.length,\\n    per_seed: perSeed\\n  },\\n  approved_keywords: allApproved,\\n  rejected_keywords: allRejected,\\n  startTime\\n}}];"},"id":"a451da23-76a2-4931-9a84-3be0075aaad9","name":"Combine Results","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"leftValue":"","typeValidation":"loose"},"conditions":[{"leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}]},"options":{}},"id":"da0f4753-a4e0-4002-905d-b99ad94c656e","name":"IF DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"jsCode":"const d = $input.first().json;\\nconst all = [...(d.approved_keywords || []), ...(d.rejected_keywords || [])];\\n\\nif (!all.length || !d.projectId) {\\n  return [{json: {...d, query: 'SELECT 1'}}];\\n}\\n\\nconst esc = s => s == null ? 'NULL' : \\"'\\" + String(s).replace(/'/g, \\"''\\") + \\"'\\";\\n\\nconst vals = all.slice(0, 2000).map(k => \\n  `(${d.projectId},${esc(k.keyword)},${esc(k.seed_keyword)},'related',${k.search_volume || 'NULL'},${k.cpc || 'NULL'},NULL,NULL,${esc(k.seed_keyword)},${esc(k.priority || 'medium')},'cluster','dataforseo','${k.status}',NULL)`\\n).join(',');\\n\\nconst query = `INSERT INTO keyword_results(project_id,keyword,seed_keyword,keyword_type,search_volume,cpc,competition,search_intent,keyword_cluster,content_priority,page_type,source,status,reject_reason) VALUES ${vals} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume),status=VALUES(status),seed_keyword=VALUES(seed_keyword)`;\\n\\nreturn [{json: {...d, query}}];"},"id":"715e6537-fe87-4c8f-bda3-27eb89b1fb9f","name":"Build SQL","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,0]},{"parameters":{"operation":"executeQuery","query":"={{ $json.query }}","options":{}},"id":"f6b45fef-46b6-4f95-9506-cc3efa23d542","name":"MySQL","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const d = $('Build SQL').first().json;\\nreturn [{json: {\\n  success: true,\\n  message: `Bulk tamamlandi: ${d.approved_keywords?.length || 0} ana sonuc, ${d.rejected_keywords?.length || 0} diger`,\\n  project_id: d.projectId,\\n  stats: d.stats,\\n  keywords: (d.approved_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume,\\n    priority: k.priority,\\n    status: k.status\\n  })),\\n  rejected_keywords: (d.rejected_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume\\n  })),\\n  processing_time_ms: Date.now() - d.startTime\\n}}];"},"id":"7b5864a2-74a7-4d92-b6a7-58e2bbbe34b5","name":"Response DB","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"jsCode":"const d = $input.first().json;\\nreturn [{json: {\\n  success: true,\\n  message: `Bulk tamamlandi: ${d.approved_keywords?.length || 0} ana sonuc, ${d.rejected_keywords?.length || 0} diger`,\\n  project_id: null,\\n  stats: d.stats,\\n  keywords: (d.approved_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume,\\n    priority: k.priority,\\n    status: k.status\\n  })),\\n  rejected_keywords: (d.rejected_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume\\n  })),\\n  processing_time_ms: Date.now() - d.startTime\\n}}];"},"id":"b79fbb1d-a38d-41e3-8b4a-c34973da5de8","name":"Response No DB","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,208]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"5bf30999-d066-4061-8398-4da68ad6edfe","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,112]}]	{"Webhook":{"main":[[{"node":"Validate","type":"main","index":0}]]},"Validate":{"main":[[{"node":"Process Seeds","type":"main","index":0}]]},"Process Seeds":{"main":[[{"node":"Combine Results","type":"main","index":0}]]},"Combine Results":{"main":[[{"node":"IF DB","type":"main","index":0}]]},"IF DB":{"main":[[{"node":"Build SQL","type":"main","index":0}],[{"node":"Response No DB","type":"main","index":0}]]},"Build SQL":{"main":[[{"node":"MySQL","type":"main","index":0}]]},"MySQL":{"main":[[{"node":"Response DB","type":"main","index":0}]]},"Response DB":{"main":[[{"node":"Respond","type":"main","index":0}]]},"Response No DB":{"main":[[{"node":"Respond","type":"main","index":0}]]}}	\N	f	\N
cca84042-6828-4a5e-97e4-a37d5b8ad28c	mNQs5AgZjCB0MIZx	Fatih Berkay Baheci	2025-12-24 08:20:18.987+00	2025-12-24 08:20:18.987+00	[{"parameters":{"httpMethod":"POST","path":"process-single-seed","responseMode":"lastNode","options":{}},"id":"2408578d-b210-43cc-9b8f-698ccad87cca","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"process-single-seed"},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\"keywords\\": [\\"{{ $json.body.seed }}\\"], \\"location_code\\": {{ $json.body.locationCode }}, \\"language_code\\": \\"{{ $json.body.language }}\\", \\"include_seed_keyword\\": true, \\"sort_by\\": \\"search_volume\\"}]","options":{"timeout":60000}},"id":"b666eeba-78a1-47d4-a474-dbbff4ae8bc8","name":"DataForSEO","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[224,0],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const input = $('Webhook').first().json.body;\\nconst dfs = $input.first().json;\\nconst seed = input.seed;\\n\\nlet keywords = [];\\ntry {\\n  if (dfs?.tasks?.[0]?.result) {\\n    keywords = dfs.tasks[0].result.map(k => ({\\n      kw: (k.keyword || '').toLowerCase().trim(),\\n      vol: k.search_volume || 0,\\n      cpc: k.cpc || 0\\n    })).filter(k => k.kw.length >= 2);\\n  }\\n} catch(e) {}\\n\\n// Dedupe\\nconst seen = new Set();\\nconst unique = keywords.filter(k => {\\n  if (seen.has(k.kw)) return false;\\n  seen.add(k.kw);\\n  return true;\\n}).slice(0, 500);\\n\\nif (unique.length === 0) {\\n  return [{json: {\\n    seed,\\n    approved: [],\\n    rejected: [],\\n    stats: {approved: 0, rejected: 0}\\n  }}];\\n}\\n\\nconst kwList = unique.map((k, i) => `${i+1}|${k.kw}|${k.vol}`).join('\\\\n');\\n\\nconst prompt = `\\"${seed}\\" icin anahtar kelime analizi.\\n\\nKEYWORDS (no|keyword|volume):\\n${kwList}\\n\\nGOREV: Icerik olusturmaya EN UYGUN 35 keyword sec.\\n\\nSECIM KRITERLERI:\\n- Blog/makale/rehber yazilabilir mi?\\n- Kullaniciya deger katan bilgi iceriyor mu?\\n- Arama amaci bilgi edinme mi?\\n\\nSECME (ama DIGER'de goster):\\n- Marka+model kombinasyonlari (nike air max 90)\\n- Fiyat/satin alma sorgulari\\n- Cok genel tek kelimeler\\n\\nONEMLI: Sadece CONTENT listesi ver. Geri kalan TUM keywordler otomatik DIGER olarak kaydedilecek.\\n\\nCIKTI FORMATI (TEK SATIR):\\nCONTENT:1,5,8,12,15,23,45,67\\n\\nACIKLAMA YAZMA. SADECE NUMARALAR.`;\\n\\nreturn [{json: {seed, keywords: unique, prompt}}];"},"id":"3f6b3573-5cd6-4d65-8363-f1a2b72d631f","name":"Parse DFS","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\"contents\\":[{\\"parts\\":[{\\"text\\":{{ JSON.stringify($json.prompt) }}}]}],\\"generationConfig\\":{\\"temperature\\":0.1,\\"maxOutputTokens\\":4096}}","options":{"timeout":60000}},"id":"068ee1b9-28ea-42d2-99da-45d282a960df","name":"Gemini","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[672,0],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const prev = $('Parse DFS').first().json;\\nconst gemini = $input.first().json;\\nconst seed = prev.seed;\\nconst kws = prev.keywords || [];\\n\\n// Normalize function for Turkish character comparison\\nconst normalize = (str) => {\\n  return str\\n    .toLowerCase()\\n    .replace(//g, 'i')\\n    .replace(//g, 'g')\\n    .replace(//g, 'u')\\n    .replace(//g, 's')\\n    .replace(//g, 'o')\\n    .replace(//g, 'c')\\n    .replace(/[^a-z0-9\\\\s]/g, '')\\n    .replace(/\\\\s+/g, ' ')\\n    .trim();\\n};\\n\\n// Check if string has Turkish characters (preferred version)\\nconst hasTurkishChars = (str) => /[]/.test(str);\\n\\n// Helper: prefer Turkish version, else higher volume\\nconst pickBest = (existing, newKw) => {\\n  const existingTr = hasTurkishChars(existing.kw);\\n  const newTr = hasTurkishChars(newKw.kw);\\n  if (newTr && !existingTr) return newKw;\\n  if (existingTr && !newTr) return existing;\\n  return newKw.vol > existing.vol ? newKw : existing;\\n};\\n\\nconst approved = [];\\nconst rejected = [];\\nconst contentSet = new Set();\\n\\ntry {\\n  const txt = gemini?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  \\n  // Parse CONTENT line\\n  const contentMatch = txt.match(/CONTENT[:\\\\s]*([\\\\d,\\\\s]+)/i);\\n  const contentNos = contentMatch \\n    ? contentMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => n > 0 && n <= kws.length)\\n    : [];\\n  \\n  // Build approved list from CONTENT (with Turkish preference)\\n  const approvedMap = new Map();\\n  contentNos.forEach(n => {\\n    const k = kws[n - 1];\\n    if (k) {\\n      contentSet.add(n - 1);\\n      const norm = normalize(k.kw);\\n      if (approvedMap.has(norm)) {\\n        approvedMap.set(norm, pickBest(approvedMap.get(norm), k));\\n      } else {\\n        approvedMap.set(norm, k);\\n      }\\n    }\\n  });\\n  \\n  approvedMap.forEach((k, norm) => {\\n    approved.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'approved',\\n      priority: k.vol >= 5000 ? 'high' : k.vol >= 1000 ? 'medium' : 'low'\\n    });\\n  });\\n  \\n  // Build rejected list - group by normalized, pick Turkish version\\n  const rejectedMap = new Map();\\n  const approvedNorms = new Set(approvedMap.keys());\\n  \\n  kws.forEach((k, idx) => {\\n    if (contentSet.has(idx)) return;\\n    const norm = normalize(k.kw);\\n    if (approvedNorms.has(norm)) return;\\n    \\n    if (rejectedMap.has(norm)) {\\n      rejectedMap.set(norm, pickBest(rejectedMap.get(norm), k));\\n    } else {\\n      rejectedMap.set(norm, k);\\n    }\\n  });\\n  \\n  rejectedMap.forEach((k, norm) => {\\n    rejected.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'rejected'\\n    });\\n  });\\n  \\n} catch(e) {\\n  // Fallback: top 35 by volume for approved, rest for rejected\\n  const sorted = [...kws].sort((a, b) => b.vol - a.vol);\\n  const approvedMap = new Map();\\n  const rejectedMap = new Map();\\n  \\n  sorted.forEach((k, idx) => {\\n    const norm = normalize(k.kw);\\n    const isTop35 = idx < 35;\\n    const targetMap = isTop35 ? approvedMap : rejectedMap;\\n    \\n    if (isTop35 && rejectedMap.has(norm)) return;\\n    if (!isTop35 && approvedMap.has(norm)) return;\\n    \\n    if (targetMap.has(norm)) {\\n      targetMap.set(norm, pickBest(targetMap.get(norm), k));\\n    } else {\\n      targetMap.set(norm, k);\\n    }\\n  });\\n  \\n  approvedMap.forEach((k) => {\\n    approved.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'approved',\\n      priority: k.vol >= 5000 ? 'high' : k.vol >= 1000 ? 'medium' : 'low'\\n    });\\n  });\\n  \\n  rejectedMap.forEach((k) => {\\n    rejected.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'rejected'\\n    });\\n  });\\n}\\n\\n// If no approved from Gemini, fallback to top 35\\nif (approved.length === 0 && kws.length > 0) {\\n  const sorted = [...kws].sort((a, b) => b.vol - a.vol);\\n  const approvedMap = new Map();\\n  const rejectedMap = new Map();\\n  \\n  sorted.forEach((k, idx) => {\\n    const norm = normalize(k.kw);\\n    const isTop35 = approvedMap.size < 35 && !rejectedMap.has(norm);\\n    const targetMap = isTop35 ? approvedMap : rejectedMap;\\n    \\n    if (!isTop35 && approvedMap.has(norm)) return;\\n    \\n    if (targetMap.has(norm)) {\\n      targetMap.set(norm, pickBest(targetMap.get(norm), k));\\n    } else {\\n      targetMap.set(norm, k);\\n    }\\n  });\\n  \\n  approvedMap.forEach((k) => {\\n    approved.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'approved',\\n      priority: 'medium'\\n    });\\n  });\\n  \\n  rejectedMap.forEach((k) => {\\n    rejected.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'rejected'\\n    });\\n  });\\n}\\n\\nreturn [{json: {\\n  seed,\\n  approved,\\n  rejected,\\n  stats: {\\n    approved: approved.length,\\n    rejected: rejected.length\\n  }\\n}}];"},"id":"68d5b73c-c41c-492b-a034-908fe9bea4d5","name":"Parse Gemini","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,0]}]	{"Webhook":{"main":[[{"node":"DataForSEO","type":"main","index":0}]]},"DataForSEO":{"main":[[{"node":"Parse DFS","type":"main","index":0}]]},"Parse DFS":{"main":[[{"node":"Gemini","type":"main","index":0}]]},"Gemini":{"main":[[{"node":"Parse Gemini","type":"main","index":0}]]}}	\N	f	\N
5f87ae9f-2108-4042-888c-99ad089a972e	cRzztL0RsykZYA9k	Fatih Berkay Baheci	2025-12-19 10:26:20.31+00	2025-12-19 10:26:20.31+00	[{"parameters":{"httpMethod":"POST","path":"sheets-connect","responseMode":"responseNode","options":{}},"id":"11ccaca6-b11e-4f66-ae1c-56e733aa384f","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-672,64],"webhookId":"sheets-connect"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const url = $json.body?.spreadsheet_url || '';\\nconst match = url.match(/\\\\/spreadsheets\\\\/d\\\\/([a-zA-Z0-9-_]+)/);\\nconst spreadsheetId = match ? match[1] : null;\\nif (!spreadsheetId) {\\n  return { json: { success: false, error: 'Geersiz Google Sheets URL' } };\\n}\\nreturn { json: { spreadsheetId, originalUrl: url } };"},"id":"567ae667-0a24-41a3-9392-f2f3e2c7b59c","name":"Parse URL","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,64]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"c1","leftValue":"={{ $json.spreadsheetId }}","rightValue":"","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"d9975acc-b891-411d-926a-3a31ce793fa3","name":"IF Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,64]},{"parameters":{"url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheetId }}","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","options":{}},"id":"450649b0-319e-4ba5-aeca-d1f3d41c82f2","name":"Get Spreadsheet","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,0],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const s = $json;\\nreturn { json: {\\n  success: true,\\n  spreadsheet_id: s.spreadsheetId,\\n  spreadsheet_name: s.properties?.title || 'Untitled',\\n  spreadsheet_url: s.spreadsheetUrl,\\n  sheets: (s.sheets || []).map(sh => ({ name: sh.properties?.title, gid: String(sh.properties?.sheetId || 0) }))\\n}};"},"id":"77122043-ca59-4488-aede-3ca511b5d0bc","name":"Format","type":"n8n-nodes-base.code","typeVersion":2,"position":[208,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"d113ce64-2b48-430a-b354-a81bd34c6e53","name":"Respond OK","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[432,0]},{"parameters":{"respondWith":"json","responseBody":"={ \\"success\\": false, \\"error\\": \\"Geersiz URL\\" }","options":{"responseCode":400}},"id":"1c780bec-e48e-4a85-97cf-49833d78a372","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[0,144]}]	{"Webhook":{"main":[[{"node":"Parse URL","type":"main","index":0}]]},"Parse URL":{"main":[[{"node":"IF Valid","type":"main","index":0}]]},"IF Valid":{"main":[[{"node":"Get Spreadsheet","type":"main","index":0}],[{"node":"Respond Error","type":"main","index":0}]]},"Get Spreadsheet":{"main":[[{"node":"Format","type":"main","index":0}]]},"Format":{"main":[[{"node":"Respond OK","type":"main","index":0}]]}}	\N	f	\N
84895dcd-2a4c-4e92-9732-63bbfa0d1557	k21swmfiM5y9Dspc	Fatih Berkay Baheci	2025-12-19 11:35:01.556+00	2025-12-19 11:35:01.556+00	[{"parameters":{"httpMethod":"POST","path":"sheets-write","responseMode":"responseNode","options":{}},"id":"8d4ff474-5958-4307-abfb-4ec63c7cae04","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-848,128],"webhookId":"sheets-write"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const body = $json.body || {};\\nconst mappings = body.column_mappings || {};\\nconst data = body.data || [];\\nconst writeMode = body.write_mode || 'append';\\nconst includeHeaders = body.include_headers !== false;\\nconst targetRow = body.target_row || 2;\\nconst targetColumn = body.target_column || 'A';\\nconst appendSeparator = body.append_separator || ', ';\\nconst sheetGid = body.sheet_gid || 0;\\n\\n// Get column letters sorted\\nconst columns = Object.entries(mappings).sort((a, b) => a[1].localeCompare(b[1]));\\nconst firstCol = columns[0]?.[1] || 'A';\\nconst lastCol = columns[columns.length - 1]?.[1] || 'A';\\n\\n// Build values array for Sheets API\\nconst values = [];\\n\\n// Add headers if needed (only for replace mode)\\nif (includeHeaders && writeMode === 'replace') {\\n  const headerRow = [];\\n  const labels = {\\n    keyword: 'Anahtar Kelime',\\n    search_volume: 'Arama Hacmi',\\n    keyword_difficulty: 'Zorluk',\\n    cpc: 'CPC',\\n    competition: 'Rekabet',\\n    search_intent: 'Arama Niyeti',\\n    opportunity_score: 'Frsat Skoru',\\n    ai_category: 'AI Kategori'\\n  };\\n  for (const [field, col] of columns) {\\n    headerRow.push(labels[field] || field);\\n  }\\n  values.push(headerRow);\\n}\\n\\n// Add data rows\\nfor (const item of data) {\\n  const row = [];\\n  for (const [field, col] of columns) {\\n    const val = item[field];\\n    row.push(val !== null && val !== undefined ? String(val) : '');\\n  }\\n  values.push(row);\\n}\\n\\n// Calculate ranges\\nconst dataEndRow = values.length;\\nconst exactRange = `${body.sheet_name}!${firstCol}1:${lastCol}${dataEndRow}`;\\nconst targetCellRange = `${body.sheet_name}!${targetColumn}${targetRow}`;\\nconst targetRowRange = `${body.sheet_name}!${firstCol}${targetRow}:${lastCol}${targetRow}`;\\n\\nreturn { json: {\\n  spreadsheet_id: body.spreadsheet_id,\\n  sheet_name: body.sheet_name,\\n  sheet_gid: sheetGid,\\n  exact_range: exactRange,\\n  target_cell_range: targetCellRange,\\n  target_row_range: targetRowRange,\\n  target_row: targetRow,\\n  target_column: targetColumn,\\n  append_separator: appendSeparator,\\n  values: values,\\n  single_row_values: values.length > 0 ? [values[0]] : [],\\n  new_cell_value: data[0] ? String(data[0][Object.keys(data[0])[0]] || '') : '',\\n  write_mode: writeMode,\\n  row_count: data.length\\n}};"},"id":"1d59bfd0-f5b2-4450-984b-2ed17aa09649","name":"Prepare Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-640,128]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.write_mode }}","rightValue":"replace","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.write_mode }}","rightValue":"append","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.write_mode }}","rightValue":"update_cell","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.write_mode }}","rightValue":"insert_row","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.write_mode }}","rightValue":"update_row","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true}]},"options":{"fallbackOutput":"none"}},"id":"cd4715dc-3942-4408-b836-d068eba995cb","name":"Switch","type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-416,128]},{"parameters":{"method":"POST","url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.sheet_name) }}!A:Z:clear","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","options":{}},"id":"e5a7ef64-c72f-4b85-8a94-03ed5bf00307","name":"Clear Sheet","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-192,-80],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"return { json: $('Prepare Data').item.json };"},"id":"8967955f-b832-42da-9866-065860bb3f15","name":"Restore (Replace)","type":"n8n-nodes-base.code","typeVersion":2,"position":[32,-80]},{"parameters":{"method":"PUT","url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.exact_range) }}?valueInputOption=USER_ENTERED","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ range: $json.exact_range, values: $json.values }) }}","options":{}},"id":"10045661-0791-4b97-aba0-2c8bbbd9b771","name":"Write (Replace)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[256,-80],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"method":"POST","url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.sheet_name) }}:append?valueInputOption=USER_ENTERED","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ values: $json.values }) }}","options":{}},"id":"0b97953a-b970-4269-aac8-bb828cdcd0b5","name":"Write (Append)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-192,48],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.target_cell_range) }}","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","options":{}},"id":"37526215-fba3-48e5-b8fe-5be1b54a496b","name":"Get Cell","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-192,160],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const prepData = $('Prepare Data').item.json;\\nconst currentValues = $json.values || [['']];\\nconst currentValue = currentValues[0]?.[0] || '';\\nconst newValue = prepData.new_cell_value;\\nconst separator = prepData.append_separator;\\n\\nconst updatedValue = currentValue ? `${currentValue}${separator}${newValue}` : newValue;\\n\\nreturn { json: {\\n  ...prepData,\\n  updated_cell_value: updatedValue\\n}};"},"id":"d3cefad5-fe4a-44f9-a9e4-b6a054e89b5c","name":"Merge Cell Value","type":"n8n-nodes-base.code","typeVersion":2,"position":[32,160]},{"parameters":{"method":"PUT","url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.target_cell_range) }}?valueInputOption=USER_ENTERED","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ values: [[$json.updated_cell_value]] }) }}","options":{}},"id":"e9ddff7e-12e4-4e56-b8b6-ebf016df7998","name":"Write Cell","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[256,160],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"method":"POST","url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}:batchUpdate","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ requests: [{ insertDimension: { range: { sheetId: $json.sheet_gid, dimension: 'ROWS', startIndex: $json.target_row - 1, endIndex: $json.target_row }, inheritFromBefore: false } }] }) }}","options":{}},"id":"bf651abb-e4ee-4625-9b5a-1a61f9d0ba9c","name":"Insert Row","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-192,288],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"return { json: $('Prepare Data').item.json };"},"id":"da3219a5-2e6f-4fa6-ad7e-1aa421577a1a","name":"Restore (Insert)","type":"n8n-nodes-base.code","typeVersion":2,"position":[32,288]},{"parameters":{"method":"PUT","url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.target_row_range) }}?valueInputOption=USER_ENTERED","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ values: $json.single_row_values }) }}","options":{}},"id":"30c2d38f-aaa4-4ffd-ad20-69b26bcc76a1","name":"Write Inserted Row","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[256,288],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"method":"PUT","url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.target_row_range) }}?valueInputOption=USER_ENTERED","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ values: $json.single_row_values }) }}","options":{}},"id":"18e2b9e1-95b0-4a14-a353-7b02c142704e","name":"Write (Update Row)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-192,400],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const prepData = $('Prepare Data').item.json;\\nreturn { json: { success: true, mode: prepData.write_mode, rows_written: prepData.row_count, spreadsheet_url: `https://docs.google.com/spreadsheets/d/${prepData.spreadsheet_id}` }};"},"id":"cce93c04-f354-4ca8-9935-afec7bf54dc9","name":"Format (Replace)","type":"n8n-nodes-base.code","typeVersion":2,"position":[480,-80]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const prepData = $('Prepare Data').item.json;\\nreturn { json: { success: true, mode: prepData.write_mode, rows_written: prepData.row_count, spreadsheet_url: `https://docs.google.com/spreadsheets/d/${prepData.spreadsheet_id}` }};"},"id":"45e1cbe9-5843-462e-8e7b-1a9820a7a5f2","name":"Format (Append)","type":"n8n-nodes-base.code","typeVersion":2,"position":[32,48]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const prepData = $('Prepare Data').item.json;\\nreturn { json: { success: true, mode: prepData.write_mode, cell: prepData.target_cell_range, new_value: $json.updated_cell_value || prepData.updated_cell_value, spreadsheet_url: `https://docs.google.com/spreadsheets/d/${prepData.spreadsheet_id}` }};"},"id":"331ee645-2916-4170-b492-86ce7e47caee","name":"Format (Cell)","type":"n8n-nodes-base.code","typeVersion":2,"position":[480,160]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const prepData = $('Prepare Data').item.json;\\nreturn { json: { success: true, mode: prepData.write_mode, inserted_at_row: prepData.target_row, spreadsheet_url: `https://docs.google.com/spreadsheets/d/${prepData.spreadsheet_id}` }};"},"id":"93ad50d0-ad7e-4a0a-801b-1e480b34cb2d","name":"Format (Insert)","type":"n8n-nodes-base.code","typeVersion":2,"position":[480,288]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const prepData = $('Prepare Data').item.json;\\nreturn { json: { success: true, mode: prepData.write_mode, updated_row: prepData.target_row, spreadsheet_url: `https://docs.google.com/spreadsheets/d/${prepData.spreadsheet_id}` }};"},"id":"f1cdd163-000f-4cff-9e54-bd7b418f4178","name":"Format (Update Row)","type":"n8n-nodes-base.code","typeVersion":2,"position":[32,400]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"3bc72137-4855-4747-8810-b21af90be895","name":"Respond (Replace)","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[688,-80]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"5b0a5aad-9466-41e2-9e67-89fe113bdf1f","name":"Respond (Append)","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[256,48]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"1c1b780e-f730-4181-b9d4-b1dd9698b757","name":"Respond (Cell)","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[688,160]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"00648ef0-0abc-458f-bf31-ea19047cff2b","name":"Respond (Insert)","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[688,288]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"016a6a38-2cbf-4ba3-8a73-441da44fb046","name":"Respond (Update Row)","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[256,400]}]	{"Webhook":{"main":[[{"node":"Prepare Data","type":"main","index":0}]]},"Prepare Data":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Clear Sheet","type":"main","index":0}],[{"node":"Write (Append)","type":"main","index":0}],[{"node":"Get Cell","type":"main","index":0}],[{"node":"Insert Row","type":"main","index":0}],[{"node":"Write (Update Row)","type":"main","index":0}]]},"Clear Sheet":{"main":[[{"node":"Restore (Replace)","type":"main","index":0}]]},"Restore (Replace)":{"main":[[{"node":"Write (Replace)","type":"main","index":0}]]},"Write (Replace)":{"main":[[{"node":"Format (Replace)","type":"main","index":0}]]},"Format (Replace)":{"main":[[{"node":"Respond (Replace)","type":"main","index":0}]]},"Write (Append)":{"main":[[{"node":"Format (Append)","type":"main","index":0}]]},"Format (Append)":{"main":[[{"node":"Respond (Append)","type":"main","index":0}]]},"Get Cell":{"main":[[{"node":"Merge Cell Value","type":"main","index":0}]]},"Merge Cell Value":{"main":[[{"node":"Write Cell","type":"main","index":0}]]},"Write Cell":{"main":[[{"node":"Format (Cell)","type":"main","index":0}]]},"Format (Cell)":{"main":[[{"node":"Respond (Cell)","type":"main","index":0}]]},"Insert Row":{"main":[[{"node":"Restore (Insert)","type":"main","index":0}]]},"Restore (Insert)":{"main":[[{"node":"Write Inserted Row","type":"main","index":0}]]},"Write Inserted Row":{"main":[[{"node":"Format (Insert)","type":"main","index":0}]]},"Format (Insert)":{"main":[[{"node":"Respond (Insert)","type":"main","index":0}]]},"Write (Update Row)":{"main":[[{"node":"Format (Update Row)","type":"main","index":0}]]},"Format (Update Row)":{"main":[[{"node":"Respond (Update Row)","type":"main","index":0}]]}}	\N	f	\N
c181632c-c3a2-4b27-99f2-001a4be7c06f	IoTg8e61J99uOFka	Fatih Berkay Baheci	2025-12-19 11:59:31.784+00	2025-12-19 11:59:31.784+00	[{"parameters":{"httpMethod":"POST","path":"sheets-get-cell","responseMode":"responseNode","options":{}},"id":"9bae26d1-993a-4112-8a13-46953bde139d","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"sheets-get-cell"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const body = $json.body || {};\\nconst spreadsheetId = body.spreadsheet_id;\\nconst sheetName = body.sheet_name;\\nconst row = body.row || 1;\\nconst column = body.column || 'A';\\n\\nif (!spreadsheetId || !sheetName) {\\n  return { json: { success: false, error: 'spreadsheet_id ve sheet_name gerekli' } };\\n}\\n\\nconst cellRange = `${sheetName}!${column}${row}`;\\n\\nreturn { json: {\\n  spreadsheet_id: spreadsheetId,\\n  sheet_name: sheetName,\\n  row,\\n  column,\\n  cell_range: cellRange\\n}};"},"id":"83cc90d3-eaca-4a58-9a82-e06a3b4db8ae","name":"Prepare","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.cell_range) }}","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","options":{}},"id":"7a7bca6b-d76d-469c-8ea1-b80c0c2413ce","name":"Get Cell","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[448,0],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const prepData = $('Prepare').item.json;\\nconst response = $json;\\nconst values = response.values || [['']];\\nconst cellValue = values[0]?.[0] || '';\\n\\nreturn { json: {\\n  success: true,\\n  value: cellValue,\\n  cell: prepData.cell_range\\n}};"},"id":"068baa03-07b9-4ced-946d-88ee1fa4c2af","name":"Format","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"c04cae19-bf61-4453-9470-8fbea03d95d2","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[880,0]}]	{"Webhook":{"main":[[{"node":"Prepare","type":"main","index":0}]]},"Prepare":{"main":[[{"node":"Get Cell","type":"main","index":0}]]},"Get Cell":{"main":[[{"node":"Format","type":"main","index":0}]]},"Format":{"main":[[{"node":"Respond","type":"main","index":0}]]}}	\N	f	\N
4a8dff3c-c281-46eb-8742-cd5ec6256b2b	O9VRT7UV70STh36c	Fatih Berkay Baheci	2025-12-19 11:59:40.715+00	2025-12-19 11:59:40.715+00	[{"parameters":{"httpMethod":"POST","path":"sheets-get-row","responseMode":"responseNode","options":{}},"id":"e84e60ab-f502-4820-8fea-54b17b77a730","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"sheets-get-row"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const body = $json.body || {};\\nconst spreadsheetId = body.spreadsheet_id;\\nconst sheetName = body.sheet_name;\\nconst row = body.row || 1;\\nconst columnMappings = body.column_mappings || {};\\n\\nif (!spreadsheetId || !sheetName) {\\n  return { json: { success: false, error: 'spreadsheet_id ve sheet_name gerekli' } };\\n}\\n\\n// Get column letters sorted\\nconst columns = Object.entries(columnMappings).sort((a, b) => a[1].localeCompare(b[1]));\\nconst firstCol = columns[0]?.[1] || 'A';\\nconst lastCol = columns[columns.length - 1]?.[1] || 'A';\\nconst rowRange = `${sheetName}!${firstCol}${row}:${lastCol}${row}`;\\n\\nreturn { json: {\\n  spreadsheet_id: spreadsheetId,\\n  sheet_name: sheetName,\\n  row,\\n  row_range: rowRange,\\n  column_mappings: columnMappings,\\n  columns: columns\\n}};"},"id":"1fd0fb98-8345-475b-a9cb-3ef5cb2f91b2","name":"Prepare","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.row_range) }}","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","options":{}},"id":"30c75a67-250a-40ea-8a1a-d6285eaa3ef6","name":"Get Row","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[448,0],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const prepData = $('Prepare').item.json;\\nconst response = $json;\\nconst rowValues = response.values?.[0] || [];\\nconst columns = prepData.columns || [];\\n\\n// Map values back to field names\\nconst values = {};\\ncolumns.forEach(([field, col], index) => {\\n  values[field] = rowValues[index] || '';\\n});\\n\\nreturn { json: {\\n  success: true,\\n  row: prepData.row,\\n  values: values\\n}};"},"id":"07badae0-2b73-47b1-b6fe-5c05c24d0a63","name":"Format","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"868a70c3-57cc-4bfd-8fc3-81ca3a1481bc","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[880,0]}]	{"Webhook":{"main":[[{"node":"Prepare","type":"main","index":0}]]},"Prepare":{"main":[[{"node":"Get Row","type":"main","index":0}]]},"Get Row":{"main":[[{"node":"Format","type":"main","index":0}]]},"Format":{"main":[[{"node":"Respond","type":"main","index":0}]]}}	\N	f	\N
6afc6c39-3544-4491-87f9-4e2810dcaaf6	GcCbIVDLCEBXWH4c	Fatih Berkay Baheci	2025-12-19 12:13:34.244+00	2025-12-19 12:13:34.244+00	[{"parameters":{"httpMethod":"POST","path":"sheets-test","responseMode":"responseNode","options":{}},"id":"98cd196e-1857-4b6e-a7cc-8cd62c9c2680","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"sheets-test"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const body = $json.body || {};\\nconst spreadsheetId = body.spreadsheet_id;\\nconst sheetName = body.sheet_name;\\n\\nif (!spreadsheetId || !sheetName) {\\n  return { json: { success: false, error: 'spreadsheet_id ve sheet_name gerekli' } };\\n}\\n\\nreturn { json: {\\n  spreadsheet_id: spreadsheetId,\\n  sheet_name: sheetName\\n}};"},"id":"f0b26a39-5805-481c-a61c-483d4b1481ce","name":"Prepare","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}?fields=properties.title,sheets(properties(sheetId,title,gridProperties.rowCount))","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","options":{}},"id":"2603cfec-f60c-42ff-a46b-9f196a3a92f3","name":"Get Metadata","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[448,0],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const prepData = $('Prepare').item.json;\\nconst response = $json;\\n\\ntry {\\n  const spreadsheetName = response.properties?.title || '';\\n  const sheets = response.sheets || [];\\n  \\n  // Find the requested sheet\\n  const targetSheet = sheets.find(s => s.properties?.title === prepData.sheet_name);\\n  \\n  if (!targetSheet) {\\n    return { json: {\\n      success: false,\\n      error: `Sheet '${prepData.sheet_name}' bulunamad`\\n    }};\\n  }\\n  \\n  const rowCount = targetSheet.properties?.gridProperties?.rowCount || 0;\\n  \\n  return { json: {\\n    success: true,\\n    spreadsheet_name: spreadsheetName,\\n    sheet_name: prepData.sheet_name,\\n    row_count: rowCount\\n  }};\\n} catch (err) {\\n  return { json: {\\n    success: false,\\n    error: 'Sheet bilgileri alnamad: ' + err.message\\n  }};\\n}"},"id":"2ffca6bd-5fea-40b8-b809-83f383d5a264","name":"Format","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"8b9c5f41-079f-411a-98a6-34fd9a0dc0ac","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[880,0]}]	{"Webhook":{"main":[[{"node":"Prepare","type":"main","index":0}]]},"Prepare":{"main":[[{"node":"Get Metadata","type":"main","index":0}]]},"Get Metadata":{"main":[[{"node":"Format","type":"main","index":0}]]},"Format":{"main":[[{"node":"Respond","type":"main","index":0}]]}}	\N	f	\N
c20bd27d-6b9f-4ecd-8d9b-3d18a4e295d1	j3jZIjdsJSchQqCe	Fatih Berkay Baheci	2025-12-19 13:16:48.135+00	2025-12-19 13:16:48.135+00	[{"parameters":{"httpMethod":"POST","path":"keyword-research","responseMode":"responseNode","options":{}},"id":"ce71ae02-218b-4c38-b350-8d3ba1bdf514","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-2960,-192],"webhookId":"keyword-research"},{"parameters":{"jsCode":"// ===========================================\\n// INPUT VALIDATION\\n// ===========================================\\nconst body = $json.body || $json;\\nconst keyword = body.keyword || body.main_keyword;\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\nconst customRules = body.custom_rules || '';\\n\\nif (!keyword || keyword.trim().length < 2) {\\n  return [{ json: { \\n    isValid: false, \\n    error: 'keyword parametresi zorunludur (min 2 karakter)', \\n    errorCode: 400 \\n  }}];\\n}\\n\\nconst locationCodes = {\\n  'TR': 2792, 'US': 2840, 'GB': 2826, 'DE': 2276, 'FR': 2250\\n};\\n\\nreturn [{ json: { \\n  isValid: true, \\n  keyword: keyword.trim().toLowerCase(),\\n  projectId: projectId ? parseInt(projectId) : null,\\n  clientId: clientId ? parseInt(clientId) : null,\\n  country: country,\\n  language: language,\\n  locationCode: locationCodes[country] || 2792,\\n  customRules: customRules\\n}}];"},"id":"438536cb-683f-4538-b7b0-d83a59b51046","name":"Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2736,-192]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"eccec6cd-cfb2-4642-b4a9-4bab435372b1","name":"IF Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-2512,-192]},{"parameters":{"respondWith":"json","responseBody":"={ \\"success\\": false, \\"error\\": \\"{{ $json.error }}\\" }","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"9147c91b-3161-4634-8999-c11d1d4f6bba","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-2288,32]},{"parameters":{"operation":"executeQuery","query":"=SELECT \\n  COALESCE(cc.enable_ai_analysis, 1) as enable_ai_analysis,\\n  cc.ai_model_preference,\\n  cc.ai_temperature,\\n  sp.prompt_text as filter_prompt\\nFROM (SELECT 1 as dummy) d\\nLEFT JOIN client_configurations cc ON cc.client_id = {{ $json.clientId || 0 }}\\nLEFT JOIN system_prompts sp ON sp.slug = 'keyword-filter' AND sp.is_active = 1\\nLIMIT 1","options":{}},"id":"1ff0a02c-0423-48c5-9d75-b8ca52309dcf","name":"Get Client Config & Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-2288,-192],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"jsCode":"// ===========================================\\n// PREPARE CONFIG FOR API CALLS\\n// ===========================================\\nconst input = $('Validate Input').first().json;\\nconst config = $input.first().json;\\n\\nreturn [{ json: {\\n  ...input,\\n  enableAiAnalysis: config.enable_ai_analysis == 1 || config.enable_ai_analysis === null,\\n  aiModel: config.ai_model_preference || 'gemini-2.0-flash',\\n  aiTemperature: parseFloat(config.ai_temperature) || 0.3,\\n  filterPromptTemplate: config.filter_prompt || ''\\n}}];"},"id":"cff631a6-fa4e-4496-906b-5eff852737c2","name":"Prepare Config","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2080,-192]},{"parameters":{"url":"=http://suggestqueries.google.com/complete/search?client=firefox&q={{ encodeURIComponent($json.keyword) }}&hl={{ $json.language }}&gl={{ $json.country.toLowerCase() }}","options":{"timeout":15000}},"id":"6e8c52e4-bf1d-4357-bdd1-3db837d34b44","name":"Google Suggestions","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1856,-192],"onError":"continueRegularOutput"},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\n  \\"keywords\\": [\\"{{ $('Prepare Config').first().json.keyword }}\\"],\\n  \\"location_code\\": {{ $('Prepare Config').first().json.locationCode }},\\n  \\"language_code\\": \\"{{ $('Prepare Config').first().json.language }}\\",\\n  \\"include_seed_keyword\\": true,\\n  \\"sort_by\\": \\"search_volume\\"\\n}]","options":{"timeout":60000}},"id":"99f78ec1-df9f-4828-90b4-1b8df289baeb","name":"DataForSEO Keywords","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1632,-192],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// MERGE ALL KEYWORD SOURCES + TURKISH NORMALIZATION\\n// ===========================================\\nconst config = $('Prepare Config').first().json;\\nconst mainKeyword = config.keyword;\\n\\nfunction normalizeForComparison(str) {\\n  return str.toLowerCase()\\n    .replace(//g, 'i').replace(//g, 'i')\\n    .replace(//g, 's').replace(//g, 's')\\n    .replace(//g, 'o').replace(//g, 'o')\\n    .replace(//g, 'u').replace(//g, 'u')\\n    .replace(//g, 'c').replace(//g, 'c')\\n    .replace(//g, 'g').replace(//g, 'g')\\n    .replace(/[^a-z0-9\\\\s]/g, '')\\n    .replace(/\\\\s+/g, ' ')\\n    .trim();\\n}\\n\\nfunction hasTurkishChars(str) {\\n  return /[]/.test(str);\\n}\\n\\nlet suggestions = [];\\ntry {\\n  const sugResponse = $('Google Suggestions').first().json;\\n  if (Array.isArray(sugResponse) && Array.isArray(sugResponse[1])) {\\n    suggestions = sugResponse[1].map(s => ({\\n      keyword: String(s).toLowerCase(),\\n      search_volume: null,\\n      cpc: null,\\n      competition: null,\\n      source: 'google_suggest'\\n    }));\\n  }\\n} catch (e) { console.log('Suggestions parse error:', e.message); }\\n\\nlet dataforseoKeywords = [];\\ntry {\\n  const dfsResponse = $('DataForSEO Keywords').first().json;\\n  if (dfsResponse?.tasks?.[0]?.result && Array.isArray(dfsResponse.tasks[0].result)) {\\n    dataforseoKeywords = dfsResponse.tasks[0].result.map(kw => ({\\n      keyword: (kw.keyword || '').toLowerCase(),\\n      search_volume: kw.search_volume || 0,\\n      cpc: kw.cpc || 0,\\n      competition: kw.competition || null,\\n      competition_index: kw.competition_index || 0,\\n      source: 'dataforseo'\\n    })).filter(kw => kw.keyword);\\n  }\\n} catch (e) { console.log('DataForSEO parse error:', e.message); }\\n\\nconst allKeywords = [...dataforseoKeywords, ...suggestions];\\nconst seen = new Map();\\n\\nallKeywords.forEach(kw => {\\n  if (!kw.keyword || kw.keyword.length < 2) return;\\n  const normalizedKey = normalizeForComparison(kw.keyword);\\n  if (!normalizedKey || normalizedKey.length < 2) return;\\n  \\n  if (!seen.has(normalizedKey)) {\\n    seen.set(normalizedKey, kw);\\n  } else {\\n    const existing = seen.get(normalizedKey);\\n    if (hasTurkishChars(kw.keyword) && !hasTurkishChars(existing.keyword)) {\\n      kw.search_volume = kw.search_volume || existing.search_volume;\\n      kw.cpc = kw.cpc || existing.cpc;\\n      kw.source = existing.source + ',' + kw.source;\\n      seen.set(normalizedKey, kw);\\n    } else if (kw.search_volume && !existing.search_volume) {\\n      existing.search_volume = kw.search_volume;\\n      existing.cpc = kw.cpc;\\n    }\\n  }\\n});\\n\\nconst uniqueKeywords = Array.from(seen.values());\\n\\nconst mainNormalized = normalizeForComparison(mainKeyword);\\nif (!seen.has(mainNormalized)) {\\n  uniqueKeywords.unshift({\\n    keyword: mainKeyword,\\n    search_volume: null,\\n    cpc: null,\\n    competition: null,\\n    source: 'seed'\\n  });\\n}\\n\\nreturn [{\\n  json: {\\n    mainKeyword: mainKeyword,\\n    projectId: config.projectId,\\n    clientId: config.clientId,\\n    country: config.country,\\n    language: config.language,\\n    customRules: config.customRules,\\n    enableAiAnalysis: config.enableAiAnalysis,\\n    aiModel: config.aiModel,\\n    aiTemperature: config.aiTemperature,\\n    filterPromptTemplate: config.filterPromptTemplate,\\n    keywords: uniqueKeywords,\\n    stats: {\\n      total_raw: allKeywords.length,\\n      after_dedup: uniqueKeywords.length,\\n      from_google_suggest: suggestions.length,\\n      from_dataforseo: dataforseoKeywords.length\\n    }\\n  }\\n}];"},"id":"9c2ba053-872e-4b76-b9c1-52745965f515","name":"Merge Keywords","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1408,-192]},{"parameters":{"jsCode":"// ===========================================\\n// PREPARE FILTER PROMPT FROM DATABASE\\n// Uses keyword-filter system prompt\\n// v4: Passes ALL keywords for later saving\\n// ===========================================\\nconst data = $input.first().json;\\nconst keywords = data.keywords || [];\\nconst mainKeyword = data.mainKeyword;\\nconst country = data.country;\\nconst language = data.language;\\nconst customRules = data.customRules || '';\\nlet promptTemplate = data.filterPromptTemplate || '';\\n\\nif (keywords.length === 0) {\\n  return [{ json: { skip: true, message: 'No keywords to filter' } }];\\n}\\n\\nif (!data.enableAiAnalysis) {\\n  return [{ json: { skipAi: true, ...data } }];\\n}\\n\\n// Sort ALL keywords by volume\\nconst allSortedKeywords = [...keywords]\\n  .sort((a, b) => (b.search_volume || 0) - (a.search_volume || 0));\\n\\n// Only top 150 go to AI for processing\\nconst aiKeywords = allSortedKeywords.slice(0, 150);\\n// Remaining keywords will be saved as pending\\nconst remainingKeywords = allSortedKeywords.slice(150);\\n\\n// Build keyword CSV for AI\\nconst keywordCsv = aiKeywords.map((kw, i) => {\\n  const vol = kw.search_volume || 0;\\n  const cpc = kw.cpc ? kw.cpc.toFixed(2) : '0';\\n  const comp = kw.competition || '';\\n  const src = kw.source || '';\\n  return `${i+1}|${kw.keyword}|${vol}|${cpc}|${comp}|${src}`;\\n}).join('\\\\n');\\n\\n// Use DB prompt or fallback\\nlet prompt = '';\\nif (promptTemplate) {\\n  prompt = promptTemplate\\n    .replace(/\\\\{\\\\{main_keyword\\\\}\\\\}/g, mainKeyword)\\n    .replace(/\\\\{\\\\{country\\\\}\\\\}/g, country)\\n    .replace(/\\\\{\\\\{language\\\\}\\\\}/g, language)\\n    .replace(/\\\\{\\\\{keyword_list\\\\}\\\\}/g, keywordCsv);\\n} else {\\n  prompt = `Sen bir SEO uzmanisin. Keyword listesini analiz et.\\\\n\\\\nAna Keyword: ${mainKeyword}\\\\nKEYWORDS:\\\\n${keywordCsv}\\\\n\\\\nCIKTI: No|status|intent|cluster|priority|content_type|reject_reason`;\\n}\\n\\nif (customRules) {\\n  prompt += `\\\\n\\\\n ZEL KURALLAR:\\\\n${customRules}`;\\n}\\n\\nreturn [{\\n  json: {\\n    ...data,\\n    skip: false,\\n    skipAi: false,\\n    filterPrompt: prompt,\\n    processedKeywords: aiKeywords,\\n    remainingKeywords: remainingKeywords,\\n    totalKeywords: allSortedKeywords.length\\n  }\\n}];"},"id":"b38cfe93-765c-44b2-bb1b-600e5ba7a1b1","name":"Prepare Filter Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1184,-192]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"not-skip","leftValue":"={{ $json.skip }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}},{"id":"not-skip-ai","leftValue":"={{ $json.skipAi }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"74ffbb2c-c5e2-4a5b-a9a7-f2ac6b8fc0d6","name":"IF Run Filter","type":"n8n-nodes-base.if","typeVersion":2,"position":[-960,-192]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{\\n    \\"parts\\": [{\\n      \\"text\\": {{ JSON.stringify($json.filterPrompt) }}\\n    }]\\n  }],\\n  \\"generationConfig\\": {\\n    \\"temperature\\": {{ $json.aiTemperature || 0.3 }},\\n    \\"maxOutputTokens\\": 8192\\n  }\\n}","options":{"timeout":90000}},"id":"22543871-2af3-4b52-9bd9-c4dd70e4b1ce","name":"Gemini Filter","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-736,-288],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// PARSE FILTER RESPONSE (Approved/Rejected)\\n// v4: Includes ALL remaining keywords as pending\\n// ===========================================\\nconst prevData = $('Prepare Filter Prompt').first().json;\\nconst geminiResponse = $input.first().json;\\nconst processedKeywords = prevData.processedKeywords || [];\\nconst remainingKeywords = prevData.remainingKeywords || [];\\n\\nconst approved = [];\\nconst rejected = [];\\n\\ntry {\\n  const text = geminiResponse?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  const lines = text.split('\\\\n').filter(l => /^\\\\d+\\\\|/.test(l.trim()));\\n  \\n  for (const line of lines) {\\n    const parts = line.split('|').map(p => p.trim());\\n    if (parts.length < 2) continue;\\n    \\n    const no = parseInt(parts[0]);\\n    const status = (parts[1] || '').toLowerCase();\\n    \\n    if (isNaN(no) || no < 1 || no > processedKeywords.length) continue;\\n    \\n    const original = processedKeywords[no - 1];\\n    \\n    if (status === 'approved') {\\n      approved.push({\\n        ...original,\\n        index: no,\\n        intent: parts[2] && parts[2] !== '' ? parts[2].toLowerCase() : null,\\n        cluster: parts[3] && parts[3] !== '' ? parts[3] : null,\\n        priority: parts[4] && parts[4] !== '' ? parts[4].toLowerCase() : 'medium',\\n        content_type: parts[5] && parts[5] !== '' ? parts[5].toLowerCase() : 'cluster',\\n        status: 'approved',\\n        reject_reason: null\\n      });\\n    } else if (status === 'rejected') {\\n      const cluster = parts[3] && parts[3] !== '' ? parts[3] : null;\\n      const reason = parts[6] && parts[6] !== '' ? parts[6] : 'filtered';\\n      rejected.push({\\n        ...original,\\n        index: no,\\n        intent: null,\\n        cluster: cluster,\\n        priority: null,\\n        content_type: null,\\n        status: 'rejected',\\n        reject_reason: reason\\n      });\\n    }\\n  }\\n  \\n  // Handle AI-processed keywords that weren't in response\\n  const processedIndices = new Set([...approved, ...rejected].map(k => k.index));\\n  processedKeywords.forEach((kw, idx) => {\\n    if (!processedIndices.has(idx + 1)) {\\n      rejected.push({\\n        ...kw,\\n        index: idx + 1,\\n        intent: null,\\n        cluster: null,\\n        priority: null,\\n        content_type: null,\\n        status: 'pending',\\n        reject_reason: 'AI skipped'\\n      });\\n    }\\n  });\\n  \\n  // Add ALL remaining keywords (not sent to AI) as pending\\n  remainingKeywords.forEach((kw, idx) => {\\n    rejected.push({\\n      ...kw,\\n      index: 150 + idx + 1,\\n      intent: null,\\n      cluster: null,\\n      priority: null,\\n      content_type: null,\\n      status: 'pending',\\n      reject_reason: null\\n    });\\n  });\\n  \\n} catch (e) { \\n  console.log('Parse error:', e.message);\\n  processedKeywords.forEach((kw, idx) => {\\n    approved.push({\\n      ...kw,\\n      index: idx + 1,\\n      intent: null,\\n      cluster: 'Genel',\\n      priority: 'medium',\\n      content_type: 'cluster',\\n      status: 'approved',\\n      reject_reason: null\\n    });\\n  });\\n}\\n\\nconst clusters = {};\\napproved.forEach(kw => {\\n  const c = kw.cluster || 'Genel';\\n  if (!clusters[c]) clusters[c] = [];\\n  clusters[c].push(kw.keyword);\\n});\\n\\nreturn [{\\n  json: {\\n    mainKeyword: prevData.mainKeyword,\\n    projectId: prevData.projectId,\\n    clientId: prevData.clientId,\\n    stats: {\\n      ...prevData.stats,\\n      total_processed: processedKeywords.length,\\n      approved_count: approved.length,\\n      rejected_count: rejected.length,\\n      remaining_count: remainingKeywords.length\\n    },\\n    approved_keywords: approved,\\n    rejected_keywords: rejected,\\n    all_keywords: [...approved, ...rejected],\\n    clusters: clusters,\\n    ai_used: true\\n  }\\n}];"},"id":"cb8f8af8-10b2-4a1c-bb19-f0226ed1ad2d","name":"Parse Filter Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[-512,-288]},{"parameters":{"jsCode":"// ===========================================\\n// SKIP AI - Use keywords as-is with defaults\\n// v3: All keywords approved by default when AI is skipped\\n// ===========================================\\nconst data = $input.first().json;\\nconst keywords = data.keywords || [];\\n\\nconst approvedKeywords = keywords.slice(0, 50).map((kw, idx) => ({\\n  ...kw,\\n  index: idx + 1,\\n  intent: null,\\n  cluster: 'Genel',\\n  priority: 'medium',\\n  content_type: 'cluster',\\n  status: 'approved',\\n  reject_reason: null\\n}));\\n\\n// Remaining keywords are pending\\nconst pendingKeywords = keywords.slice(50).map((kw, idx) => ({\\n  ...kw,\\n  index: idx + 51,\\n  intent: null,\\n  cluster: 'Beklemede',\\n  priority: null,\\n  content_type: null,\\n  status: 'pending',\\n  reject_reason: 'AI analysis skipped - pending review'\\n}));\\n\\nreturn [{\\n  json: {\\n    mainKeyword: data.mainKeyword,\\n    projectId: data.projectId,\\n    clientId: data.clientId,\\n    stats: {\\n      ...data.stats,\\n      approved_count: approvedKeywords.length,\\n      rejected_count: pendingKeywords.length\\n    },\\n    approved_keywords: approvedKeywords,\\n    rejected_keywords: pendingKeywords,\\n    all_keywords: [...approvedKeywords, ...pendingKeywords],\\n    clusters: { 'Genel': approvedKeywords.map(k => k.keyword) },\\n    ai_used: false\\n  }\\n}];"},"id":"84db2ce1-aee8-4722-9574-558c0af03a38","name":"Skip AI Filter","type":"n8n-nodes-base.code","typeVersion":2,"position":[-736,-80]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"has-project","leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}],"combinator":"and"},"options":{}},"id":"594d8a8b-b214-487a-b7fc-5f69fd419d8f","name":"IF Save to DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[-288,-192]},{"parameters":{"jsCode":"// ===========================================\\n// PREPARE BATCH INSERT - ALL KEYWORDS WITH STATUS\\n// v5: Fixed source normalization for VARCHAR column\\n// ===========================================\\nlet data = null;\\ntry { data = $('Parse Filter Response').first().json; } catch(e) {}\\nif (!data) { try { data = $('Skip AI Filter').first().json; } catch(e) {} }\\nif (!data) { data = $input.first().json; }\\n\\nconst projectId = data.projectId;\\nconst allKeywords = data.all_keywords || [...(data.approved_keywords || []), ...(data.rejected_keywords || [])];\\n\\nif (allKeywords.length === 0) {\\n  return [{ json: { skip: true, batchQuery: '' } }];\\n}\\n\\nfunction esc(str) {\\n  if (str === null || str === undefined) return 'NULL';\\n  return \\"'\\" + String(str).replace(/\\\\\\\\/g, '\\\\\\\\\\\\\\\\').replace(/'/g, \\"''\\") + \\"'\\";\\n}\\n\\nfunction escOrNull(str) {\\n  if (str === null || str === undefined || str === '') return 'NULL';\\n  return \\"'\\" + String(str).replace(/\\\\\\\\/g, '\\\\\\\\\\\\\\\\').replace(/'/g, \\"''\\") + \\"'\\";\\n}\\n\\n// Normalize source - take first valid source from combined values\\nfunction normalizeSource(src) {\\n  if (!src) return 'dataforseo';\\n  const first = src.split(',')[0].trim();\\n  return first || 'dataforseo';\\n}\\n\\n// Build batch VALUES\\nconst batchSize = 500;\\nconst batches = [];\\n\\nfor (let i = 0; i < allKeywords.length; i += batchSize) {\\n  const batch = allKeywords.slice(i, i + batchSize);\\n  const values = batch.map(kw => {\\n    const kwType = kw.source?.includes('suggest') ? 'google_suggest' : 'related';\\n    const src = normalizeSource(kw.source);\\n    return `(${projectId}, ${esc(kw.keyword)}, '${kwType}', ${kw.search_volume || 'NULL'}, ${kw.cpc || 'NULL'}, ${escOrNull(kw.competition)}, ${escOrNull(kw.intent)}, ${escOrNull(kw.cluster)}, ${escOrNull(kw.priority)}, ${escOrNull(kw.content_type)}, '${src}', '${kw.status || 'pending'}', ${escOrNull(kw.reject_reason)})`;\\n  }).join(',\\\\n');\\n  \\n  const query = `INSERT INTO keyword_results (project_id, keyword, keyword_type, search_volume, cpc, competition, search_intent, keyword_cluster, content_priority, page_type, source, status, reject_reason) VALUES ${values} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume), cpc=VALUES(cpc), search_intent=COALESCE(VALUES(search_intent),search_intent), keyword_cluster=COALESCE(VALUES(keyword_cluster),keyword_cluster), content_priority=COALESCE(VALUES(content_priority),content_priority), page_type=COALESCE(VALUES(page_type),page_type), status=VALUES(status), reject_reason=VALUES(reject_reason)`;\\n  \\n  batches.push({ json: { batchQuery: query, batchIndex: Math.floor(i/batchSize), batchCount: batch.length } });\\n}\\n\\nconsole.log(`[Split for DB] Total: ${allKeywords.length} keywords, ${batches.length} batches`);\\nreturn batches;"},"id":"f909122d-f149-4d46-a173-79cf5baad4e6","name":"Split for DB","type":"n8n-nodes-base.code","typeVersion":2,"position":[-64,-288]},{"parameters":{"operation":"executeQuery","query":"={{ $json.batchQuery }}","options":{}},"id":"d62c4a05-84ac-4a37-8dec-1f618ad13f3a","name":"Save to DB","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[160,-288],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// PREPARE FINAL RESPONSE\\n// v3: Reports both approved and rejected counts\\n// ===========================================\\nlet data = null;\\ntry { data = $('Parse Filter Response').first().json; } catch(e) {}\\nif (!data) { try { data = $('Skip AI Filter').first().json; } catch(e) {} }\\n\\nif (!data) {\\n  return [{ json: { success: false, error: 'Could not retrieve data' } }];\\n}\\n\\nconst approvedKeywords = data.approved_keywords || [];\\nconst rejectedKeywords = data.rejected_keywords || [];\\nconst savedCount = $input.all().length;\\n\\nreturn [{\\n  json: {\\n    success: true,\\n    message: `Keyword arastirmasi tamamlandi. ${approvedKeywords.length} keyword onaylandi, ${rejectedKeywords.length} reddedildi/beklemede, ${savedCount} DB'ye kaydedildi.`,\\n    main_keyword: data.mainKeyword,\\n    project_id: data.projectId,\\n    stats: {\\n      ...data.stats,\\n      saved_to_db: savedCount,\\n      approved_count: approvedKeywords.length,\\n      rejected_count: rejectedKeywords.length\\n    },\\n    keywords: approvedKeywords.map(kw => ({\\n      keyword: kw.keyword,\\n      search_volume: kw.search_volume,\\n      cpc: kw.cpc,\\n      competition: kw.competition,\\n      intent: kw.intent,\\n      cluster: kw.cluster,\\n      priority: kw.priority,\\n      content_type: kw.content_type,\\n      source: kw.source,\\n      status: kw.status\\n    })),\\n    rejected: rejectedKeywords.map(kw => ({\\n      keyword: kw.keyword,\\n      search_volume: kw.search_volume,\\n      reason: kw.reject_reason,\\n      status: kw.status\\n    })),\\n    clusters: data.clusters || {},\\n    ai_used: data.ai_used\\n  }\\n}];"},"id":"508b5272-c633-4347-ba6d-6d074abd14b2","name":"Response (DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[384,-288]},{"parameters":{"jsCode":"// ===========================================\\n// PREPARE RESPONSE (NO DB SAVE)\\n// ===========================================\\nlet data = null;\\ntry { data = $('Parse Filter Response').first().json; } catch(e) {}\\nif (!data) { try { data = $('Skip AI Filter').first().json; } catch(e) {} }\\nif (!data) { data = $input.first().json; }\\n\\nconst approvedKeywords = data.approved_keywords || [];\\nconst rejectedKeywords = data.rejected_keywords || [];\\n\\nreturn [{\\n  json: {\\n    success: true,\\n    message: `Keyword arastirmasi tamamlandi. ${approvedKeywords.length} keyword onaylandi, ${rejectedKeywords.length} reddedildi.`,\\n    main_keyword: data.mainKeyword,\\n    project_id: null,\\n    stats: {\\n      ...data.stats,\\n      saved_to_db: 0\\n    },\\n    keywords: approvedKeywords.map(kw => ({\\n      keyword: kw.keyword,\\n      search_volume: kw.search_volume,\\n      cpc: kw.cpc,\\n      competition: kw.competition,\\n      intent: kw.intent,\\n      cluster: kw.cluster,\\n      priority: kw.priority,\\n      content_type: kw.content_type,\\n      source: kw.source,\\n      status: kw.status\\n    })),\\n    rejected: rejectedKeywords.map(kw => ({\\n      keyword: kw.keyword,\\n      reason: kw.reject_reason,\\n      status: kw.status\\n    })),\\n    clusters: data.clusters || {},\\n    ai_used: data.ai_used\\n  }\\n}];"},"id":"d7cc1eb4-3339-4a5c-8027-b82fd578a30c","name":"Response (No DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[-64,-80]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"2a123e6b-46e1-45b4-844d-02f247859ee1","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[608,-192]},{"parameters":{"respondWith":"json","responseBody":"={ \\"success\\": true, \\"message\\": \\"Keyword bulunamadi\\", \\"keywords\\": [], \\"rejected\\": [], \\"stats\\": {} }","options":{}},"id":"cde5d3cd-74c9-4e8d-bbd5-c12c7a886ee1","name":"Respond Empty","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-736,128]}]	{"Webhook":{"main":[[{"node":"Validate Input","type":"main","index":0}]]},"Validate Input":{"main":[[{"node":"IF Valid","type":"main","index":0}]]},"IF Valid":{"main":[[{"node":"Get Client Config & Prompt","type":"main","index":0}],[{"node":"Respond Error","type":"main","index":0}]]},"Get Client Config & Prompt":{"main":[[{"node":"Prepare Config","type":"main","index":0}]]},"Prepare Config":{"main":[[{"node":"Google Suggestions","type":"main","index":0}]]},"Google Suggestions":{"main":[[{"node":"DataForSEO Keywords","type":"main","index":0}]]},"DataForSEO Keywords":{"main":[[{"node":"Merge Keywords","type":"main","index":0}]]},"Merge Keywords":{"main":[[{"node":"Prepare Filter Prompt","type":"main","index":0}]]},"Prepare Filter Prompt":{"main":[[{"node":"IF Run Filter","type":"main","index":0}]]},"IF Run Filter":{"main":[[{"node":"Gemini Filter","type":"main","index":0}],[{"node":"Skip AI Filter","type":"main","index":0}]]},"Gemini Filter":{"main":[[{"node":"Parse Filter Response","type":"main","index":0}]]},"Parse Filter Response":{"main":[[{"node":"IF Save to DB","type":"main","index":0}]]},"Skip AI Filter":{"main":[[{"node":"IF Save to DB","type":"main","index":0}]]},"IF Save to DB":{"main":[[{"node":"Split for DB","type":"main","index":0}],[{"node":"Response (No DB)","type":"main","index":0}]]},"Split for DB":{"main":[[{"node":"Save to DB","type":"main","index":0}]]},"Save to DB":{"main":[[{"node":"Response (DB)","type":"main","index":0}]]},"Response (DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]},"Response (No DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]}}	\N	f	\N
f7cd0ca4-f01c-4f88-8d44-102e6cde14ce	886MnxYqCbAQ1Bjz	Fatih Berkay Baheci	2025-12-21 10:58:05.456+00	2025-12-21 10:58:05.456+00	[{"parameters":{"httpMethod":"POST","path":"sheets-write","responseMode":"responseNode","options":{}},"id":"a3fcfc72-9c17-4c55-b17e-275b5b9c5a3a","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-672,80],"webhookId":"sheets-write"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const body = $json.body || {};\\nconst mappings = body.column_mappings || {};\\nconst data = body.data || [];\\nconst startRow = body.start_row || 2;\\nconst writeMode = body.write_mode || 'append';\\nconst includeHeaders = body.include_headers !== false;\\n\\n// Get column letters sorted\\nconst columns = Object.entries(mappings).sort((a, b) => a[1].localeCompare(b[1]));\\nconst firstCol = columns[0]?.[1] || 'A';\\nconst lastCol = columns[columns.length - 1]?.[1] || 'A';\\n\\n// Build values array for Sheets API\\nconst values = [];\\n\\n// Add headers if needed\\nif (includeHeaders) {\\n  const headerRow = [];\\n  const labels = {\\n    keyword: 'Anahtar Kelime',\\n    search_volume: 'Arama Hacmi',\\n    keyword_difficulty: 'Zorluk',\\n    cpc: 'CPC',\\n    competition: 'Rekabet',\\n    search_intent: 'Arama Niyeti',\\n    opportunity_score: 'Frsat Skoru',\\n    ai_category: 'AI Kategori'\\n  };\\n  for (const [field, col] of columns) {\\n    headerRow.push(labels[field] || field);\\n  }\\n  values.push(headerRow);\\n}\\n\\n// Add data rows\\nfor (const item of data) {\\n  const row = [];\\n  for (const [field, col] of columns) {\\n    const val = item[field];\\n    row.push(val !== null && val !== undefined ? String(val) : '');\\n  }\\n  values.push(row);\\n}\\n\\n// Calculate range for replace (exact range) vs append (starting point)\\nconst dataStartRow = includeHeaders ? 1 : startRow;\\nconst dataEndRow = dataStartRow + values.length - 1;\\nconst exactRange = `${body.sheet_name}!${firstCol}${dataStartRow}:${lastCol}${dataEndRow}`;\\nconst appendRange = `${body.sheet_name}!${firstCol}:${lastCol}`;\\n\\nreturn { json: {\\n  spreadsheet_id: body.spreadsheet_id,\\n  sheet_name: body.sheet_name,\\n  exact_range: exactRange,\\n  append_range: appendRange,\\n  values: values,\\n  write_mode: writeMode,\\n  row_count: data.length\\n}};"},"id":"215c15a1-ad4e-4c57-b80a-3e5bb33e3215","name":"Prepare Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,80]},{"parameters":{"conditions":{"options":{"caseSensitive":true},"conditions":[{"id":"c1","leftValue":"={{ $json.write_mode }}","rightValue":"replace","operator":{"type":"string","operation":"equals"}}]},"options":{}},"id":"04aa4aeb-e05d-4431-91c7-fc27f32124e7","name":"IF Replace","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,80]},{"parameters":{"method":"POST","url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.sheet_name) }}!A:Z:clear","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","options":{}},"id":"7e6bb1e9-879b-4881-b604-3f325a05f95b","name":"Clear Sheet","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,0],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"return { json: $('Prepare Data').item.json };"},"id":"93459e45-1c88-48e3-9183-c3abd6a530ae","name":"Restore (Replace)","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"method":"PUT","url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.exact_range) }}?valueInputOption=USER_ENTERED","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ range: $json.exact_range, values: $json.values }) }}","options":{}},"id":"53037a00-b6d8-402b-9ef7-d1b0a98f971f","name":"Write (Replace)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[448,0],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"method":"POST","url":"=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheet_id }}/values/{{ encodeURIComponent($json.append_range) }}:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS","authentication":"predefinedCredentialType","nodeCredentialType":"googleSheetsOAuth2Api","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ values: $json.values }) }}","options":{}},"id":"039bdec8-ed44-43c7-b475-e5890e95ef87","name":"Write (Append)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,160],"credentials":{"googleSheetsOAuth2Api":{"id":"FRUwxjFQM3dnpWm4","name":"Google Sheets account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const prepData = $('Prepare Data').item.json;\\nconst response = $json;\\nconst updatedRows = response.updatedRows || prepData.values.length;\\n\\nreturn { json: {\\n  success: true,\\n  rows_written: updatedRows,\\n  spreadsheet_url: `https://docs.google.com/spreadsheets/d/${prepData.spreadsheet_id}`\\n}};"},"id":"174df93a-e7fb-4091-b4b8-2abbc650bdd6","name":"Format (Replace)","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const prepData = $('Prepare Data').item.json;\\nconst response = $json;\\nconst updatedRows = response.updates?.updatedRows || prepData.values.length;\\n\\nreturn { json: {\\n  success: true,\\n  rows_written: updatedRows,\\n  spreadsheet_url: `https://docs.google.com/spreadsheets/d/${prepData.spreadsheet_id}`\\n}};"},"id":"6e529f28-9d94-44ba-9d22-19ca25d4f5b1","name":"Format (Append)","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,160]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"3bd2b97b-10f9-49a8-a2fe-bf28040fc3e4","name":"Respond (Replace)","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[896,0]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"e677d34c-fe67-4356-9c57-2b01d17c6847","name":"Respond (Append)","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[448,160]}]	{"Webhook":{"main":[[{"node":"Prepare Data","type":"main","index":0}]]},"Prepare Data":{"main":[[{"node":"IF Replace","type":"main","index":0}]]},"IF Replace":{"main":[[{"node":"Clear Sheet","type":"main","index":0}],[{"node":"Write (Append)","type":"main","index":0}]]},"Clear Sheet":{"main":[[{"node":"Restore (Replace)","type":"main","index":0}]]},"Restore (Replace)":{"main":[[{"node":"Write (Replace)","type":"main","index":0}]]},"Write (Replace)":{"main":[[{"node":"Format (Replace)","type":"main","index":0}]]},"Write (Append)":{"main":[[{"node":"Format (Append)","type":"main","index":0}]]},"Format (Replace)":{"main":[[{"node":"Respond (Replace)","type":"main","index":0}]]},"Format (Append)":{"main":[[{"node":"Respond (Append)","type":"main","index":0}]]}}	\N	f	\N
9dc5a4f7-aab6-404a-8959-11eebca030c0	xqZA3Veie70f1PZI	Fatih Berkay Baheci	2025-12-21 10:58:13.017+00	2025-12-21 10:58:13.017+00	[{"parameters":{"path":"client-prompts/list/:clientId","responseMode":"responseNode","options":{}},"id":"7bd75f15-a536-4430-8380-acd92785cd67","name":"Webhook - List Prompts","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,0],"webhookId":"client-prompts-list"},{"parameters":{"operation":"executeQuery","query":"=SELECT id, client_id, prompt_name, prompt_text, is_active, sort_order, created_at, updated_at FROM client_prompts WHERE client_id = {{ parseInt($json.params.clientId) || 0 }} ORDER BY sort_order ASC, created_at DESC","options":{}},"id":"90f088e7-ab6f-47cc-afce-75da6cebf44b","name":"MySQL - List Prompts","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"data\\": {{ JSON.stringify($input.all().map(i => ({ ...i.json, is_active: i.json.is_active === 1 || i.json.is_active === true }))) }}\\n}","options":{}},"id":"d82e3d49-c8e0-41b7-916f-126dcee0eaed","name":"Respond - List Prompts","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[448,0]},{"parameters":{"httpMethod":"POST","path":"client-prompts/create","responseMode":"responseNode","options":{}},"id":"336d2ab8-937e-459c-a147-1648ccad36ac","name":"Webhook - Create Prompt","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,208],"webhookId":"client-prompts-create"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Check max prompts and prepare insert\\nconst body = $json.body || {};\\nconst clientId = parseInt(body.client_id);\\nconst promptName = body.prompt_name || '';\\nconst promptText = body.prompt_text || '';\\nconst isActive = body.is_active ? 1 : 0;\\n\\nif (!clientId || !promptName || !promptText) {\\n  return { json: { error: 'Missing required fields', valid: false } };\\n}\\n\\nreturn {\\n  json: {\\n    clientId,\\n    promptName,\\n    promptText,\\n    isActive,\\n    valid: true\\n  }\\n};"},"id":"f1f75d49-d1e7-41f0-88e0-864e1bd7015d","name":"Code - Validate Create","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"condition-valid","leftValue":"={{ $json.valid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"020fb845-ebb5-4f3f-8622-7bff49cd9f89","name":"IF - Valid Create","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,208]},{"parameters":{"operation":"executeQuery","query":"=SELECT COUNT(*) as count FROM client_prompts WHERE client_id = {{ $json.clientId }}","options":{}},"id":"b6ba912c-9332-4b24-8ee3-52874e336fd3","name":"MySQL - Check Count","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,144],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Check if under limit and pass data\\nconst count = $json.count || 0;\\nconst MAX_PROMPTS = 10;\\nconst prevData = $('Code - Validate Create').item.json;\\n\\nif (count >= MAX_PROMPTS) {\\n  return { json: { error: `Maximum ${MAX_PROMPTS} prompts allowed`, canCreate: false } };\\n}\\n\\nreturn {\\n  json: {\\n    ...prevData,\\n    canCreate: true\\n  }\\n};"},"id":"ea729d6f-af5c-4546-9420-1aa21b486c1e","name":"Code - Check Limit","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,144]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"condition-can-create","leftValue":"={{ $json.canCreate }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"25b42883-1d61-4b37-9bf7-73d60a27309e","name":"IF - Can Create","type":"n8n-nodes-base.if","typeVersion":2,"position":[1104,144]},{"parameters":{"operation":"executeQuery","query":"=INSERT INTO client_prompts (client_id, prompt_name, prompt_text, is_active, sort_order) VALUES ({{ $json.clientId }}, {{ JSON.stringify($json.promptName) }}, {{ JSON.stringify($json.promptText) }}, {{ $json.isActive }}, (SELECT COALESCE(MAX(sort_order), 0) + 1 FROM client_prompts cp WHERE cp.client_id = {{ $json.clientId }}))","options":{}},"id":"2e92704c-49a0-424d-a905-de1862a92ec1","name":"MySQL - Create Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1328,80],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"SELECT * FROM client_prompts WHERE id = LAST_INSERT_ID()","options":{}},"id":"f7faf58d-cdc9-49f0-81b6-ad14007b01a5","name":"MySQL - Get Created Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1552,80],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"data\\": {{ JSON.stringify({ ...$json, is_active: $json.is_active === 1 }) }},\\n  \\"message\\": \\"Prompt created successfully\\"\\n}","options":{}},"id":"c8dece86-345d-48a9-9642-b8ab9d48c2ad","name":"Respond - Create Prompt","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1760,80]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": {{ JSON.stringify($json.error || 'Cannot create prompt') }}\\n}","options":{"responseCode":400}},"id":"b4ff7bea-821d-4fd2-b5a5-905b34b9acee","name":"Respond - Create Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1328,224]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": {{ JSON.stringify($json.error || 'Invalid request') }}\\n}","options":{"responseCode":400}},"id":"b8524a53-f304-418a-bc55-dcf5d3c9a230","name":"Respond - Invalid Create","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,272]},{"parameters":{"httpMethod":"PUT","path":"client-prompts/update/:id","responseMode":"responseNode","options":{}},"id":"aebd9405-6b52-4da4-95ec-6f9c9fd670f8","name":"Webhook - Update Prompt","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,400],"webhookId":"client-prompts-update"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Build update query\\nconst body = $json.body || {};\\nconst promptId = parseInt($json.params.id);\\n\\nif (!promptId) {\\n  return { json: { error: 'Invalid prompt ID', valid: false } };\\n}\\n\\nconst updates = [];\\nif (body.prompt_name !== undefined) {\\n  updates.push(`prompt_name = ${JSON.stringify(body.prompt_name)}`);\\n}\\nif (body.prompt_text !== undefined) {\\n  updates.push(`prompt_text = ${JSON.stringify(body.prompt_text)}`);\\n}\\nif (body.sort_order !== undefined) {\\n  updates.push(`sort_order = ${parseInt(body.sort_order)}`);\\n}\\n\\nif (updates.length === 0) {\\n  return { json: { error: 'No fields to update', valid: false } };\\n}\\n\\nupdates.push('updated_at = NOW()');\\n\\nreturn {\\n  json: {\\n    promptId,\\n    query: `UPDATE client_prompts SET ${updates.join(', ')} WHERE id = ${promptId}`,\\n    valid: true\\n  }\\n};"},"id":"ec11cfaf-71b4-4a54-9144-a4a1d94ef825","name":"Code - Build Update Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,400]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"condition-valid-update","leftValue":"={{ $json.valid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"59e2f8b2-768e-463e-a370-d73a7563913f","name":"IF - Valid Update","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,400]},{"parameters":{"operation":"executeQuery","query":"={{ $json.query }}","options":{}},"id":"25259415-b74d-486b-8641-507b8fbc4899","name":"MySQL - Update Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,352],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=SELECT * FROM client_prompts WHERE id = {{ $('Code - Build Update Prompt').item.json.promptId }}","options":{}},"id":"3a21674a-faff-4d9c-9b52-3fc6725bd50a","name":"MySQL - Get Updated Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[880,352],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": {{ $json.id ? true : false }},\\n  \\"data\\": {{ $json.id ? JSON.stringify({ ...$json, is_active: $json.is_active === 1 }) : 'null' }},\\n  \\"message\\": {{ $json.id ? '\\"Prompt updated successfully\\"' : '\\"Prompt not found\\"' }}\\n}","options":{}},"id":"571d7a52-5632-4fee-a026-2b8432b64b69","name":"Respond - Update Prompt","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1104,352]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": {{ JSON.stringify($json.error || 'Invalid request') }}\\n}","options":{"responseCode":400}},"id":"c1a68bba-3423-466e-a594-6743ac080799","name":"Respond - Invalid Update","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,464]},{"parameters":{"httpMethod":"DELETE","path":"client-prompts/delete/:id","responseMode":"responseNode","options":{}},"id":"caca335a-dd88-4cc9-8501-c37848e77110","name":"Webhook - Delete Prompt","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,608],"webhookId":"client-prompts-delete"},{"parameters":{"operation":"executeQuery","query":"=DELETE FROM client_prompts WHERE id = {{ parseInt($json.params.id) || 0 }}","options":{}},"id":"3cf91a18-4226-47ff-83e4-1f7c05e6c41f","name":"MySQL - Delete Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,608],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"message\\": \\"Prompt deleted successfully\\"\\n}","options":{}},"id":"0a40e276-5c1f-406e-8b7f-6f399a26ef42","name":"Respond - Delete Prompt","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[448,608]},{"parameters":{"httpMethod":"PUT","path":"client-prompts/set-active/:id","responseMode":"responseNode","options":{}},"id":"b1352f7b-34d9-45fb-8f43-4526787f0feb","name":"Webhook - Set Active","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,800],"webhookId":"client-prompts-set-active"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Get prompt ID and client ID\\nconst promptId = parseInt($json.params.id);\\nconst clientId = parseInt($json.body?.client_id);\\n\\nif (!promptId || !clientId) {\\n  return { json: { error: 'Invalid prompt or client ID', valid: false } };\\n}\\n\\nreturn {\\n  json: {\\n    promptId,\\n    clientId,\\n    valid: true\\n  }\\n};"},"id":"a0dc4cb9-eae8-4dab-a5d8-4c505f7c7fa7","name":"Code - Validate Set Active","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,800]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"condition-valid-set-active","leftValue":"={{ $json.valid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"ee137210-2bbe-468f-9919-2f1c0a461471","name":"IF - Valid Set Active","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,800]},{"parameters":{"operation":"executeQuery","query":"=UPDATE client_prompts SET is_active = 0 WHERE client_id = {{ $json.clientId }}","options":{}},"id":"8f1410ce-f65a-4cff-9586-6d21d4aec28c","name":"MySQL - Deactivate All","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,752],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"operation":"executeQuery","query":"=UPDATE client_prompts SET is_active = 1, updated_at = NOW() WHERE id = {{ $('Code - Validate Set Active').item.json.promptId }}","options":{}},"id":"bb05c1bc-2657-41e5-8716-124a46b15a2d","name":"MySQL - Activate One","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[880,752],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": true,\\n  \\"message\\": \\"Active prompt updated successfully\\"\\n}","options":{}},"id":"03b57618-93bf-44aa-b3dd-0441d6c980b1","name":"Respond - Set Active","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1104,752]},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": false,\\n  \\"error\\": {{ JSON.stringify($json.error || 'Invalid request') }}\\n}","options":{"responseCode":400}},"id":"dbaf24fa-852f-4a99-901b-716270a53219","name":"Respond - Invalid Set Active","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,864]},{"parameters":{"path":"client-prompts/active/:clientId","responseMode":"responseNode","options":{}},"id":"7a26b56d-c29f-4c4d-b38e-cc9e524550ca","name":"Webhook - Get Active Prompt","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[0,1008],"webhookId":"client-prompts-get-active"},{"parameters":{"operation":"executeQuery","query":"=SELECT id, client_id, prompt_name, prompt_text, is_active, sort_order, created_at, updated_at FROM client_prompts WHERE client_id = {{ parseInt($json.params.clientId) || 0 }} AND is_active = 1 LIMIT 1","options":{}},"id":"b918d4a3-19ec-46e3-befd-9f41787dc38c","name":"MySQL - Get Active Prompt","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,1008],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}}},{"parameters":{"respondWith":"json","responseBody":"={\\n  \\"success\\": {{ $json.id ? true : false }},\\n  \\"data\\": {{ $json.id ? JSON.stringify({ ...$json, is_active: true }) : 'null' }},\\n  \\"message\\": {{ $json.id ? '\\"Active prompt found\\"' : '\\"No active prompt found\\"' }}\\n}","options":{}},"id":"bc07c573-de42-4822-94e2-c8ba06be9e55","name":"Respond - Get Active","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[448,1008]}]	{"Webhook - List Prompts":{"main":[[{"node":"MySQL - List Prompts","type":"main","index":0}]]},"MySQL - List Prompts":{"main":[[{"node":"Respond - List Prompts","type":"main","index":0}]]},"Webhook - Create Prompt":{"main":[[{"node":"Code - Validate Create","type":"main","index":0}]]},"Code - Validate Create":{"main":[[{"node":"IF - Valid Create","type":"main","index":0}]]},"IF - Valid Create":{"main":[[{"node":"MySQL - Check Count","type":"main","index":0}],[{"node":"Respond - Invalid Create","type":"main","index":0}]]},"MySQL - Check Count":{"main":[[{"node":"Code - Check Limit","type":"main","index":0}]]},"Code - Check Limit":{"main":[[{"node":"IF - Can Create","type":"main","index":0}]]},"IF - Can Create":{"main":[[{"node":"MySQL - Create Prompt","type":"main","index":0}],[{"node":"Respond - Create Error","type":"main","index":0}]]},"MySQL - Create Prompt":{"main":[[{"node":"MySQL - Get Created Prompt","type":"main","index":0}]]},"MySQL - Get Created Prompt":{"main":[[{"node":"Respond - Create Prompt","type":"main","index":0}]]},"Webhook - Update Prompt":{"main":[[{"node":"Code - Build Update Prompt","type":"main","index":0}]]},"Code - Build Update Prompt":{"main":[[{"node":"IF - Valid Update","type":"main","index":0}]]},"IF - Valid Update":{"main":[[{"node":"MySQL - Update Prompt","type":"main","index":0}],[{"node":"Respond - Invalid Update","type":"main","index":0}]]},"MySQL - Update Prompt":{"main":[[{"node":"MySQL - Get Updated Prompt","type":"main","index":0}]]},"MySQL - Get Updated Prompt":{"main":[[{"node":"Respond - Update Prompt","type":"main","index":0}]]},"Webhook - Delete Prompt":{"main":[[{"node":"MySQL - Delete Prompt","type":"main","index":0}]]},"MySQL - Delete Prompt":{"main":[[{"node":"Respond - Delete Prompt","type":"main","index":0}]]},"Webhook - Set Active":{"main":[[{"node":"Code - Validate Set Active","type":"main","index":0}]]},"Code - Validate Set Active":{"main":[[{"node":"IF - Valid Set Active","type":"main","index":0}]]},"IF - Valid Set Active":{"main":[[{"node":"MySQL - Deactivate All","type":"main","index":0}],[{"node":"Respond - Invalid Set Active","type":"main","index":0}]]},"MySQL - Deactivate All":{"main":[[{"node":"MySQL - Activate One","type":"main","index":0}]]},"MySQL - Activate One":{"main":[[{"node":"Respond - Set Active","type":"main","index":0}]]},"Webhook - Get Active Prompt":{"main":[[{"node":"MySQL - Get Active Prompt","type":"main","index":0}]]},"MySQL - Get Active Prompt":{"main":[[{"node":"Respond - Get Active","type":"main","index":0}]]}}	\N	f	\N
a26989bc-baf1-4d58-829d-1f7c0a6cd9b2	askirexPIC3sUVXx	Fatih Berkay Baheci	2025-12-21 10:58:15.994+00	2025-12-21 10:58:15.994+00	[]	{}	\N	f	\N
3a51bf09-3eb8-4c77-b845-f9ea2363a824	adol4O3V4iGsGXpf	Fatih Berkay Baheci	2025-12-23 10:30:47.216+00	2025-12-23 10:30:47.216+00	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"1da93b88-26a8-4fdc-884f-df74c1cbd947","name":"Webhook Bulk","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1536,112],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"// ===========================================\\n// BULK INPUT VALIDATION\\n// ===========================================\\nconst body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\nconst customRules = body.custom_rules || '';\\n\\nif (!Array.isArray(keywords) || keywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'keywords array required', errorCode: 400 }}];\\n}\\n\\nconst cleanKeywords = keywords\\n  .map(k => String(k).trim().toLowerCase())\\n  .filter(k => k.length >= 2)\\n  .slice(0, 100);\\n\\nif (cleanKeywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'Min 1 valid keyword required', errorCode: 400 }}];\\n}\\n\\nconst locationCodes = { 'TR': 2792, 'US': 2840, 'GB': 2826, 'DE': 2276, 'FR': 2250 };\\n\\nreturn [{ json: { \\n  isValid: true,\\n  keywords: cleanKeywords,\\n  keywordCount: cleanKeywords.length,\\n  projectId: projectId ? parseInt(projectId) : null,\\n  clientId: clientId ? parseInt(clientId) : null,\\n  country, language,\\n  locationCode: locationCodes[country] || 2792,\\n  customRules,\\n  startTime: Date.now()\\n}}];"},"id":"6ca24c9e-f2b7-45f5-8982-0c3322bbfd47","name":"Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1328,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"ad6919c7-fad3-4730-a209-6f0feeb3715d","name":"IF Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1104,112]},{"parameters":{"respondWith":"json","responseBody":"={ \\"success\\": false, \\"error\\": \\"{{ $json.error }}\\" }","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"7cf1f099-286e-43de-97ea-5b4472dfc7a2","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-880,304]},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\n  \\"keywords\\": {{ JSON.stringify($json.keywords) }},\\n  \\"location_code\\": {{ $json.locationCode }},\\n  \\"language_code\\": \\"{{ $json.language }}\\",\\n  \\"include_seed_keyword\\": true,\\n  \\"sort_by\\": \\"search_volume\\"\\n}]","options":{"timeout":120000}},"id":"9d2eaee7-e125-44f3-b264-7c252dd51d9d","name":"DataForSEO Bulk","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-880,112],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// MERGE & PREPARE FOR GEMINI\\n// ===========================================\\nconst input = $('Validate Input').first().json;\\nconst seedKeywords = input.keywords || [];\\n\\nfunction normalizeForComparison(str) {\\n  return str.toLowerCase()\\n    .replace(//g, 'i').replace(//g, 'i')\\n    .replace(//g, 's').replace(//g, 's')\\n    .replace(//g, 'o').replace(//g, 'o')\\n    .replace(//g, 'u').replace(//g, 'u')\\n    .replace(//g, 'c').replace(//g, 'c')\\n    .replace(//g, 'g').replace(//g, 'g')\\n    .replace(/[^a-z0-9\\\\s]/g, '').replace(/\\\\s+/g, ' ').trim();\\n}\\n\\n// Parse DataForSEO response\\nlet dataforseoKeywords = [];\\ntry {\\n  const dfsResponse = $input.first().json;\\n  if (dfsResponse?.tasks?.[0]?.result) {\\n    dataforseoKeywords = dfsResponse.tasks[0].result.map(kw => {\\n      let seedKw = seedKeywords.find(s => \\n        kw.keyword?.toLowerCase().includes(s.toLowerCase())\\n      ) || seedKeywords[0];\\n      return {\\n        keyword: (kw.keyword || '').toLowerCase().trim(),\\n        seed_keyword: seedKw,\\n        search_volume: kw.search_volume || 0,\\n        cpc: kw.cpc || 0,\\n        competition: kw.competition || null,\\n        source: 'dataforseo'\\n      };\\n    }).filter(kw => kw.keyword && kw.keyword.length >= 2);\\n  }\\n} catch (e) { console.log('DFS error:', e.message); }\\n\\n// Dedupe\\nconst seen = new Map();\\ndataforseoKeywords.forEach(kw => {\\n  const key = normalizeForComparison(kw.keyword);\\n  if (key.length >= 2 && !seen.has(key)) seen.set(key, kw);\\n});\\n\\n// Add seed keywords if missing\\nseedKeywords.forEach(seed => {\\n  const key = normalizeForComparison(seed);\\n  if (!seen.has(key)) {\\n    seen.set(key, { keyword: seed, seed_keyword: seed, search_volume: null, cpc: null, source: 'seed' });\\n  }\\n});\\n\\nconst uniqueKeywords = Array.from(seen.values())\\n  .sort((a, b) => (b.search_volume || 0) - (a.search_volume || 0));\\n\\n// Take top 150 for AI, rest as pending\\nconst forAI = uniqueKeywords.slice(0, 150);\\nconst pending = uniqueKeywords.slice(150);\\n\\nreturn [{ json: {\\n  ...input,\\n  allKeywords: uniqueKeywords,\\n  forAI: forAI,\\n  pendingKeywords: pending,\\n  stats: {\\n    total_seeds: seedKeywords.length,\\n    from_dataforseo: dataforseoKeywords.length,\\n    unique: uniqueKeywords.length,\\n    for_ai: forAI.length,\\n    pending: pending.length\\n  }\\n}}];"},"id":"b52f287b-2229-4310-b6fb-4e1edfa116b1","name":"Merge Keywords","type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,112]},{"parameters":{"jsCode":"// ===========================================\\n// BUILD GEMINI PROMPT\\n// ===========================================\\nconst data = $input.first().json;\\nconst keywords = data.forAI || [];\\nconst mainKeyword = data.keywords[0] || '';\\n\\nif (keywords.length === 0) {\\n  return [{ json: { ...data, skipAi: true }}];\\n}\\n\\nconst keywordCsv = keywords.map((kw, i) => {\\n  const vol = kw.search_volume || 0;\\n  const cpc = kw.cpc ? kw.cpc.toFixed(2) : '0';\\n  const seed = kw.seed_keyword || '';\\n  return `${i+1}|${kw.keyword}|${vol}|${cpc}|${seed}`;\\n}).join('\\\\n');\\n\\nconst prompt = `Sen bir SEO uzmanisin. Asagidaki keyword listesini analiz et.\\n\\nAna Keyword: ${mainKeyword}\\nUlke: ${data.country}\\n\\nKEYWORDS (No|keyword|volume|cpc|seed):\\n${keywordCsv}\\n\\nHer keyword icin tek satir cikti ver:\\n- Uygunsa: No|approved|intent|cluster|priority|content_type\\n- Uygun degilse: No|rejected|||||reason\\n\\nIntent: informational, commercial, transactional, navigational\\nPriority: high, medium, low\\nContent_type: pillar, cluster, blog, product, faq\\n\\nSadece satirlari yaz, baska bir sey yazma.`;\\n\\nreturn [{ json: { ...data, filterPrompt: prompt, skipAi: false }}];"},"id":"932ae05a-8f92-4df8-90ea-67871a2b3c4c","name":"Build Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"skip","leftValue":"={{ $json.skipAi }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"b3d68c64-c671-4514-b238-3f3ae8cd9e40","name":"IF Run AI","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{ \\"parts\\": [{ \\"text\\": {{ JSON.stringify($json.filterPrompt) }} }] }],\\n  \\"generationConfig\\": { \\"temperature\\": 0.3, \\"maxOutputTokens\\": 8192 }\\n}","options":{"timeout":120000}},"id":"5c29be9e-961b-4977-a822-c1d6845d1dbe","name":"Gemini Filter","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,0],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// PARSE GEMINI RESPONSE\\n// ===========================================\\nconst prevData = $('Build Prompt').first().json;\\nconst geminiResponse = $input.first().json;\\nconst processedKeywords = prevData.forAI || [];\\nconst pendingKeywords = prevData.pendingKeywords || [];\\n\\nconst approved = [];\\nconst rejected = [];\\n\\ntry {\\n  const text = geminiResponse?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  const lines = text.split('\\\\n').filter(l => /^\\\\d+\\\\|/.test(l.trim()));\\n  const processedIndices = new Set();\\n  \\n  for (const line of lines) {\\n    const parts = line.split('|').map(p => p.trim());\\n    if (parts.length < 2) continue;\\n    \\n    const no = parseInt(parts[0]);\\n    const status = (parts[1] || '').toLowerCase();\\n    \\n    if (isNaN(no) || no < 1 || no > processedKeywords.length) continue;\\n    \\n    const original = processedKeywords[no - 1];\\n    processedIndices.add(no);\\n    \\n    if (status === 'approved') {\\n      approved.push({\\n        ...original,\\n        intent: parts[2] || null,\\n        cluster: parts[3] || null,\\n        priority: parts[4] || 'medium',\\n        content_type: parts[5] || 'cluster',\\n        status: 'approved',\\n        reject_reason: null\\n      });\\n    } else {\\n      rejected.push({\\n        ...original,\\n        intent: null, cluster: parts[3] || null,\\n        priority: null, content_type: null,\\n        status: 'rejected',\\n        reject_reason: parts[6] || 'filtered'\\n      });\\n    }\\n  }\\n  \\n  // Handle skipped keywords\\n  processedKeywords.forEach((kw, idx) => {\\n    if (!processedIndices.has(idx + 1)) {\\n      rejected.push({ ...kw, status: 'pending', reject_reason: 'AI skipped' });\\n    }\\n  });\\n} catch (e) {\\n  console.log('Parse error:', e.message);\\n  processedKeywords.forEach(kw => {\\n    approved.push({ ...kw, status: 'approved', priority: 'medium', content_type: 'cluster' });\\n  });\\n}\\n\\n// Add pending keywords\\npendingKeywords.forEach(kw => {\\n  rejected.push({ ...kw, status: 'pending', reject_reason: null });\\n});\\n\\nconst clusters = {};\\napproved.forEach(kw => {\\n  const c = kw.cluster || 'Genel';\\n  if (!clusters[c]) clusters[c] = [];\\n  clusters[c].push(kw.keyword);\\n});\\n\\nreturn [{ json: {\\n  projectId: prevData.projectId,\\n  clientId: prevData.clientId,\\n  mainKeyword: prevData.keywords[0],\\n  stats: { ...prevData.stats, approved: approved.length, rejected: rejected.length },\\n  approved_keywords: approved,\\n  rejected_keywords: rejected,\\n  all_keywords: [...approved, ...rejected],\\n  clusters,\\n  ai_used: true,\\n  processing_time_ms: Date.now() - prevData.startTime\\n}}];"},"id":"9a56f6d1-8137-4eab-9a60-514d94dd7fbc","name":"Parse Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"jsCode":"// ===========================================\\n// SKIP AI - Mark all as approved\\n// ===========================================\\nconst data = $input.first().json;\\nconst keywords = data.allKeywords || [];\\n\\nconst approved = keywords.slice(0, 50).map(kw => ({\\n  ...kw, status: 'approved', priority: 'medium', content_type: 'cluster'\\n}));\\nconst pending = keywords.slice(50).map(kw => ({\\n  ...kw, status: 'pending', reject_reason: 'AI skipped'\\n}));\\n\\nreturn [{ json: {\\n  projectId: data.projectId,\\n  clientId: data.clientId,\\n  mainKeyword: data.keywords[0],\\n  stats: { ...data.stats, approved: approved.length, rejected: pending.length },\\n  approved_keywords: approved,\\n  rejected_keywords: pending,\\n  all_keywords: [...approved, ...pending],\\n  clusters: { 'Genel': approved.map(k => k.keyword) },\\n  ai_used: false,\\n  processing_time_ms: Date.now() - data.startTime\\n}}];"},"id":"814054a4-2afd-4e4a-977b-0c3f809bed66","name":"Skip AI","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"has-project","leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}],"combinator":"and"},"options":{}},"id":"474f73d9-b5e2-42b0-bec8-78799996da7f","name":"IF Save DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,112]},{"parameters":{"jsCode":"// ===========================================\\n// PREPARE BATCH INSERT\\n// ===========================================\\nconst data = $input.first().json;\\nconst projectId = data.projectId;\\nconst allKeywords = data.all_keywords || [];\\n\\nif (allKeywords.length === 0) {\\n  return [{ json: { skip: true, batchQuery: '' }}];\\n}\\n\\nfunction esc(str) {\\n  if (str === null || str === undefined) return 'NULL';\\n  return \\"'\\" + String(str).replace(/\\\\\\\\/g, '\\\\\\\\\\\\\\\\').replace(/'/g, \\"''\\") + \\"'\\";\\n}\\n\\nconst values = allKeywords.slice(0, 500).map(kw => {\\n  const kwType = kw.source?.includes('suggest') ? 'google_suggest' : 'related';\\n  const src = (kw.source || 'dataforseo').split(',')[0].trim();\\n  return `(${projectId}, ${esc(kw.keyword)}, ${esc(kw.seed_keyword)}, '${kwType}', ${kw.search_volume || 'NULL'}, ${kw.cpc || 'NULL'}, ${esc(kw.competition)}, ${esc(kw.intent)}, ${esc(kw.cluster)}, ${esc(kw.priority)}, ${esc(kw.content_type)}, '${src}', '${kw.status || 'pending'}', ${esc(kw.reject_reason)})`;\\n}).join(',\\\\n');\\n\\nconst query = `INSERT INTO keyword_results (project_id, keyword, seed_keyword, keyword_type, search_volume, cpc, competition, search_intent, keyword_cluster, content_priority, page_type, source, status, reject_reason) VALUES ${values} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume), status=VALUES(status)`;\\n\\nreturn [{ json: { ...data, batchQuery: query }}];"},"id":"62cd0afd-918f-4e20-ae17-c5f54e383faa","name":"Prepare Insert","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"operation":"executeQuery","query":"={{ $json.batchQuery }}","options":{}},"id":"09afe8ba-e947-4352-b9ed-f1e32c31d6e4","name":"Save to DB","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[880,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// FINAL RESPONSE\\n// ===========================================\\nconst data = $('Prepare Insert').first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi. ${approved.length} onaylandi, ${rejected.length} reddedildi.`,\\n  project_id: data.projectId,\\n  stats: data.stats,\\n  keywords: approved.slice(0, 200).map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    intent: kw.intent,\\n    cluster: kw.cluster,\\n    priority: kw.priority,\\n    status: kw.status\\n  })),\\n  rejected: rejected.slice(0, 50).map(kw => ({\\n    keyword: kw.keyword,\\n    reason: kw.reject_reason\\n  })),\\n  clusters: data.clusters,\\n  ai_used: data.ai_used,\\n  processing_time_ms: data.processing_time_ms\\n}}];"},"id":"bfd47cdd-782b-4b84-a198-c44963b0d5b7","name":"Response (DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,0]},{"parameters":{"jsCode":"// ===========================================\\n// RESPONSE WITHOUT DB\\n// ===========================================\\nconst data = $input.first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi (DB yok). ${approved.length} onaylandi.`,\\n  project_id: null,\\n  stats: data.stats,\\n  keywords: approved.slice(0, 200),\\n  rejected: rejected.slice(0, 50),\\n  clusters: data.clusters,\\n  ai_used: data.ai_used\\n}}];"},"id":"63eff199-c03f-4f95-9dc9-f49d94d86f54","name":"Response (No DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,208]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"c2e81111-f134-4653-b2a1-a4344604667c","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1328,112]}]	{"Webhook Bulk":{"main":[[{"node":"Validate Input","type":"main","index":0}]]},"Validate Input":{"main":[[{"node":"IF Valid","type":"main","index":0}]]},"IF Valid":{"main":[[{"node":"DataForSEO Bulk","type":"main","index":0}],[{"node":"Respond Error","type":"main","index":0}]]},"DataForSEO Bulk":{"main":[[{"node":"Merge Keywords","type":"main","index":0}]]},"Merge Keywords":{"main":[[{"node":"Build Prompt","type":"main","index":0}]]},"Build Prompt":{"main":[[{"node":"IF Run AI","type":"main","index":0}]]},"IF Run AI":{"main":[[{"node":"Gemini Filter","type":"main","index":0}],[{"node":"Skip AI","type":"main","index":0}]]},"Gemini Filter":{"main":[[{"node":"Parse Response","type":"main","index":0}]]},"Parse Response":{"main":[[{"node":"IF Save DB","type":"main","index":0}]]},"Skip AI":{"main":[[{"node":"IF Save DB","type":"main","index":0}]]},"IF Save DB":{"main":[[{"node":"Prepare Insert","type":"main","index":0}],[{"node":"Response (No DB)","type":"main","index":0}]]},"Prepare Insert":{"main":[[{"node":"Save to DB","type":"main","index":0}]]},"Save to DB":{"main":[[{"node":"Response (DB)","type":"main","index":0}]]},"Response (DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]},"Response (No DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]}}	\N	f	\N
51c1b5e8-a64d-40b6-b3a9-067e90176b09	adol4O3V4iGsGXpf	Fatih Berkay Baheci	2025-12-23 10:45:08.856+00	2025-12-23 10:45:08.856+00	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"6601f0c6-3404-43d6-b06b-8e1d4d4b4dc2","name":"Webhook Bulk","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1536,112],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"// ===========================================\\n// BULK INPUT VALIDATION\\n// ===========================================\\nconst body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\nconst customRules = body.custom_rules || '';\\n\\nif (!Array.isArray(keywords) || keywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'keywords array required', errorCode: 400 }}];\\n}\\n\\nconst cleanKeywords = keywords\\n  .map(k => String(k).trim().toLowerCase())\\n  .filter(k => k.length >= 2)\\n  .slice(0, 100);\\n\\nif (cleanKeywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'Min 1 valid keyword required', errorCode: 400 }}];\\n}\\n\\nconst locationCodes = { 'TR': 2792, 'US': 2840, 'GB': 2826, 'DE': 2276, 'FR': 2250 };\\n\\nreturn [{ json: { \\n  isValid: true,\\n  keywords: cleanKeywords,\\n  keywordCount: cleanKeywords.length,\\n  projectId: projectId ? parseInt(projectId) : null,\\n  clientId: clientId ? parseInt(clientId) : null,\\n  country, language,\\n  locationCode: locationCodes[country] || 2792,\\n  customRules,\\n  startTime: Date.now()\\n}}];"},"id":"4c535dd9-bc45-43a1-a0d6-2cf0949420f1","name":"Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1328,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"7a44daad-03aa-4589-9152-91d8c6b51eff","name":"IF Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1104,112]},{"parameters":{"respondWith":"json","responseBody":"={ \\"success\\": false, \\"error\\": \\"{{ $json.error }}\\" }","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"566a4a83-775c-46e4-af45-8a4ef8d0c812","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-880,304]},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\n  \\"keywords\\": {{ JSON.stringify($json.keywords) }},\\n  \\"location_code\\": {{ $json.locationCode }},\\n  \\"language_code\\": \\"{{ $json.language }}\\",\\n  \\"include_seed_keyword\\": true,\\n  \\"sort_by\\": \\"search_volume\\"\\n}]","options":{"timeout":120000}},"id":"90e66d24-3f21-4925-b006-9230f7284b27","name":"DataForSEO Bulk","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-880,112],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// MERGE & PREPARE FOR GEMINI\\n// ===========================================\\nconst input = $('Validate Input').first().json;\\nconst seedKeywords = input.keywords || [];\\n\\nfunction normalizeForComparison(str) {\\n  return str.toLowerCase()\\n    .replace(//g, 'i').replace(//g, 'i')\\n    .replace(//g, 's').replace(//g, 's')\\n    .replace(//g, 'o').replace(//g, 'o')\\n    .replace(//g, 'u').replace(//g, 'u')\\n    .replace(//g, 'c').replace(//g, 'c')\\n    .replace(//g, 'g').replace(//g, 'g')\\n    .replace(/[^a-z0-9\\\\s]/g, '').replace(/\\\\s+/g, ' ').trim();\\n}\\n\\n// Find best matching seed for a keyword\\nfunction findBestSeed(keyword, seeds) {\\n  const kwNorm = normalizeForComparison(keyword);\\n  const kwWords = kwNorm.split(' ');\\n  let bestSeed = null;\\n  let bestScore = 0;\\n  \\n  for (const seed of seeds) {\\n    const seedNorm = normalizeForComparison(seed);\\n    const seedWords = seedNorm.split(' ');\\n    \\n    // Count matching words\\n    let matchCount = 0;\\n    for (const sw of seedWords) {\\n      if (sw.length >= 2 && kwWords.some(kw => kw.includes(sw) || sw.includes(kw))) {\\n        matchCount++;\\n      }\\n    }\\n    \\n    // Score based on word match ratio\\n    const score = matchCount / seedWords.length;\\n    if (score > bestScore) {\\n      bestScore = score;\\n      bestSeed = seed;\\n    }\\n  }\\n  \\n  return bestSeed || seeds[0];\\n}\\n\\n// Parse DataForSEO response\\nlet dataforseoKeywords = [];\\ntry {\\n  const dfsResponse = $input.first().json;\\n  if (dfsResponse?.tasks?.[0]?.result) {\\n    dataforseoKeywords = dfsResponse.tasks[0].result.map(kw => {\\n      const keyword = (kw.keyword || '').toLowerCase().trim();\\n      const seedKw = findBestSeed(keyword, seedKeywords);\\n      return {\\n        keyword: keyword,\\n        seed_keyword: seedKw,\\n        search_volume: kw.search_volume || 0,\\n        cpc: kw.cpc || 0,\\n        competition: kw.competition || null,\\n        source: 'dataforseo'\\n      };\\n    }).filter(kw => kw.keyword && kw.keyword.length >= 2);\\n  }\\n} catch (e) { console.log('DFS error:', e.message); }\\n\\n// Dedupe\\nconst seen = new Map();\\ndataforseoKeywords.forEach(kw => {\\n  const key = normalizeForComparison(kw.keyword);\\n  if (key.length >= 2 && !seen.has(key)) seen.set(key, kw);\\n});\\n\\n// Add seed keywords if missing\\nseedKeywords.forEach(seed => {\\n  const key = normalizeForComparison(seed);\\n  if (!seen.has(key)) {\\n    seen.set(key, { keyword: seed, seed_keyword: seed, search_volume: null, cpc: null, source: 'seed' });\\n  }\\n});\\n\\nconst uniqueKeywords = Array.from(seen.values())\\n  .sort((a, b) => (b.search_volume || 0) - (a.search_volume || 0));\\n\\n// Take top 150 for AI, rest as pending\\nconst forAI = uniqueKeywords.slice(0, 150);\\nconst pending = uniqueKeywords.slice(150);\\n\\nreturn [{ json: {\\n  ...input,\\n  allKeywords: uniqueKeywords,\\n  forAI: forAI,\\n  pendingKeywords: pending,\\n  stats: {\\n    total_seeds: seedKeywords.length,\\n    from_dataforseo: dataforseoKeywords.length,\\n    unique: uniqueKeywords.length,\\n    for_ai: forAI.length,\\n    pending: pending.length\\n  }\\n}}];"},"id":"5f5daa2a-2645-42f5-b107-9973712c0fce","name":"Merge Keywords","type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,112]},{"parameters":{"jsCode":"// ===========================================\\n// BUILD GEMINI PROMPT\\n// ===========================================\\nconst data = $input.first().json;\\nconst keywords = data.forAI || [];\\nconst seedKeywords = data.keywords || [];\\n\\nif (keywords.length === 0) {\\n  return [{ json: { ...data, skipAi: true }}];\\n}\\n\\nconst keywordCsv = keywords.map((kw, i) => {\\n  const vol = kw.search_volume || 0;\\n  const cpc = kw.cpc ? kw.cpc.toFixed(2) : '0';\\n  const seed = kw.seed_keyword || '';\\n  return `${i+1}|${kw.keyword}|${vol}|${cpc}|${seed}`;\\n}).join('\\\\n');\\n\\nconst seedList = seedKeywords.join(', ');\\n\\nconst prompt = `Sen bir SEO uzmanisin. Bir musteri icin TOPLU keyword arastirmasi yapiyoruz.\\n\\nMusterinin arastirmak istedigi SEED KEYWORDLER:\\n${seedList}\\n\\nUlke: ${data.country}\\n\\nAsagidaki keywordler DataForSEO'dan bu seed'lere gore cekildi. Her keyword kendi SEED KEYWORD'u ile iliskili oldugu surece ONAYLA.\\n\\nKEYWORDS (No|keyword|volume|cpc|seed_keyword):\\n${keywordCsv}\\n\\nDEGERLENDIRME KURALLARI:\\n1. Her keyword kendi seed_keyword'u ile iliskili mi bak (son sutun)\\n2. Keyword, seed ile alakali ise ONAYLA\\n3. Spam, anlamsiz veya tamamen alakasiz ise REDDET\\n4. Search volume 0 olsa bile alakali ise ONAYLA\\n5. COGU KEYWORD ONAYLANMALI - sadece gercekten alakasiz olanlari reddet\\n\\nHer keyword icin tek satir cikti ver:\\n- Uygunsa: No|approved|intent|cluster|priority|content_type\\n- Uygun degilse: No|rejected|||||reason\\n\\nIntent: informational, commercial, transactional, navigational\\nPriority: high (volume>1000), medium (100-1000), low (<100)\\nContent_type: pillar, cluster, blog, product, faq\\n\\nSadece satirlari yaz, baska bir sey yazma.`;\\n\\nreturn [{ json: { ...data, filterPrompt: prompt, skipAi: false }}];"},"id":"3207ee77-605a-49e8-901b-ee5ea41a7d26","name":"Build Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"skip","leftValue":"={{ $json.skipAi }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"ad9bdb94-3945-4f3e-ba8d-70d43351d0a3","name":"IF Run AI","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{ \\"parts\\": [{ \\"text\\": {{ JSON.stringify($json.filterPrompt) }} }] }],\\n  \\"generationConfig\\": { \\"temperature\\": 0.3, \\"maxOutputTokens\\": 8192 }\\n}","options":{"timeout":120000}},"id":"ad2c01df-39f4-4332-8a27-61b46fc71ac3","name":"Gemini Filter","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,0],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// PARSE GEMINI RESPONSE\\n// ===========================================\\nconst prevData = $('Build Prompt').first().json;\\nconst geminiResponse = $input.first().json;\\nconst processedKeywords = prevData.forAI || [];\\nconst pendingKeywords = prevData.pendingKeywords || [];\\n\\nconst approved = [];\\nconst rejected = [];\\n\\ntry {\\n  const text = geminiResponse?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  const lines = text.split('\\\\n').filter(l => /^\\\\d+\\\\|/.test(l.trim()));\\n  const processedIndices = new Set();\\n  \\n  for (const line of lines) {\\n    const parts = line.split('|').map(p => p.trim());\\n    if (parts.length < 2) continue;\\n    \\n    const no = parseInt(parts[0]);\\n    const status = (parts[1] || '').toLowerCase();\\n    \\n    if (isNaN(no) || no < 1 || no > processedKeywords.length) continue;\\n    \\n    const original = processedKeywords[no - 1];\\n    processedIndices.add(no);\\n    \\n    if (status === 'approved') {\\n      approved.push({\\n        ...original,\\n        intent: parts[2] || null,\\n        cluster: parts[3] || null,\\n        priority: parts[4] || 'medium',\\n        content_type: parts[5] || 'cluster',\\n        status: 'approved',\\n        reject_reason: null\\n      });\\n    } else {\\n      rejected.push({\\n        ...original,\\n        intent: null, cluster: parts[3] || null,\\n        priority: null, content_type: null,\\n        status: 'rejected',\\n        reject_reason: parts[6] || 'filtered'\\n      });\\n    }\\n  }\\n  \\n  // Handle skipped keywords\\n  processedKeywords.forEach((kw, idx) => {\\n    if (!processedIndices.has(idx + 1)) {\\n      rejected.push({ ...kw, status: 'pending', reject_reason: 'AI skipped' });\\n    }\\n  });\\n} catch (e) {\\n  console.log('Parse error:', e.message);\\n  processedKeywords.forEach(kw => {\\n    approved.push({ ...kw, status: 'approved', priority: 'medium', content_type: 'cluster' });\\n  });\\n}\\n\\n// Add pending keywords\\npendingKeywords.forEach(kw => {\\n  rejected.push({ ...kw, status: 'pending', reject_reason: null });\\n});\\n\\nconst clusters = {};\\napproved.forEach(kw => {\\n  const c = kw.cluster || 'Genel';\\n  if (!clusters[c]) clusters[c] = [];\\n  clusters[c].push(kw.keyword);\\n});\\n\\nreturn [{ json: {\\n  projectId: prevData.projectId,\\n  clientId: prevData.clientId,\\n  mainKeyword: prevData.keywords[0],\\n  stats: { ...prevData.stats, approved: approved.length, rejected: rejected.length },\\n  approved_keywords: approved,\\n  rejected_keywords: rejected,\\n  all_keywords: [...approved, ...rejected],\\n  clusters,\\n  ai_used: true,\\n  processing_time_ms: Date.now() - prevData.startTime\\n}}];"},"id":"d5ae869e-5e3f-4281-b889-edc0d53d57ff","name":"Parse Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"jsCode":"// ===========================================\\n// SKIP AI - Mark all as approved\\n// ===========================================\\nconst data = $input.first().json;\\nconst keywords = data.allKeywords || [];\\n\\nconst approved = keywords.slice(0, 50).map(kw => ({\\n  ...kw, status: 'approved', priority: 'medium', content_type: 'cluster'\\n}));\\nconst pending = keywords.slice(50).map(kw => ({\\n  ...kw, status: 'pending', reject_reason: 'AI skipped'\\n}));\\n\\nreturn [{ json: {\\n  projectId: data.projectId,\\n  clientId: data.clientId,\\n  mainKeyword: data.keywords[0],\\n  stats: { ...data.stats, approved: approved.length, rejected: pending.length },\\n  approved_keywords: approved,\\n  rejected_keywords: pending,\\n  all_keywords: [...approved, ...pending],\\n  clusters: { 'Genel': approved.map(k => k.keyword) },\\n  ai_used: false,\\n  processing_time_ms: Date.now() - data.startTime\\n}}];"},"id":"4abdfc0e-13c1-449e-b563-dfdd39184b11","name":"Skip AI","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"has-project","leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}],"combinator":"and"},"options":{}},"id":"0be7e6a8-2cf2-4e2c-89c7-a5dd3a9b5d50","name":"IF Save DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[448,112]},{"parameters":{"jsCode":"// ===========================================\\n// PREPARE BATCH INSERT\\n// ===========================================\\nconst data = $input.first().json;\\nconst projectId = data.projectId;\\nconst allKeywords = data.all_keywords || [];\\n\\nif (allKeywords.length === 0) {\\n  return [{ json: { skip: true, batchQuery: '' }}];\\n}\\n\\nfunction esc(str) {\\n  if (str === null || str === undefined) return 'NULL';\\n  return \\"'\\" + String(str).replace(/\\\\\\\\/g, '\\\\\\\\\\\\\\\\').replace(/'/g, \\"''\\") + \\"'\\";\\n}\\n\\nconst values = allKeywords.slice(0, 500).map(kw => {\\n  const kwType = kw.source?.includes('suggest') ? 'google_suggest' : 'related';\\n  const src = (kw.source || 'dataforseo').split(',')[0].trim();\\n  return `(${projectId}, ${esc(kw.keyword)}, ${esc(kw.seed_keyword)}, '${kwType}', ${kw.search_volume || 'NULL'}, ${kw.cpc || 'NULL'}, ${esc(kw.competition)}, ${esc(kw.intent)}, ${esc(kw.cluster)}, ${esc(kw.priority)}, ${esc(kw.content_type)}, '${src}', '${kw.status || 'pending'}', ${esc(kw.reject_reason)})`;\\n}).join(',\\\\n');\\n\\nconst query = `INSERT INTO keyword_results (project_id, keyword, seed_keyword, keyword_type, search_volume, cpc, competition, search_intent, keyword_cluster, content_priority, page_type, source, status, reject_reason) VALUES ${values} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume), status=VALUES(status)`;\\n\\nreturn [{ json: { ...data, batchQuery: query }}];"},"id":"44491a31-0007-4568-bc40-3b16966dd36c","name":"Prepare Insert","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"operation":"executeQuery","query":"={{ $json.batchQuery }}","options":{}},"id":"961770c2-a030-4005-82c1-8bb404d13f98","name":"Save to DB","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[880,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// FINAL RESPONSE\\n// ===========================================\\nconst data = $('Prepare Insert').first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi. ${approved.length} onaylandi, ${rejected.length} reddedildi.`,\\n  project_id: data.projectId,\\n  stats: data.stats,\\n  keywords: approved.slice(0, 200).map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    intent: kw.intent,\\n    cluster: kw.cluster,\\n    priority: kw.priority,\\n    status: kw.status\\n  })),\\n  rejected: rejected.slice(0, 50).map(kw => ({\\n    keyword: kw.keyword,\\n    reason: kw.reject_reason\\n  })),\\n  clusters: data.clusters,\\n  ai_used: data.ai_used,\\n  processing_time_ms: data.processing_time_ms\\n}}];"},"id":"abe52224-57e2-4f7b-93d1-ea179e4cd570","name":"Response (DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,0]},{"parameters":{"jsCode":"// ===========================================\\n// RESPONSE WITHOUT DB\\n// ===========================================\\nconst data = $input.first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi (DB yok). ${approved.length} onaylandi.`,\\n  project_id: null,\\n  stats: data.stats,\\n  keywords: approved.slice(0, 200),\\n  rejected: rejected.slice(0, 50),\\n  clusters: data.clusters,\\n  ai_used: data.ai_used\\n}}];"},"id":"45a55e99-dcb7-4b61-8cef-5d490f144f09","name":"Response (No DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,208]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"9b0e65f2-2f6e-4a90-b46c-6f6e0d1e17a1","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1328,112]}]	{"Webhook Bulk":{"main":[[{"node":"Validate Input","type":"main","index":0}]]},"Validate Input":{"main":[[{"node":"IF Valid","type":"main","index":0}]]},"IF Valid":{"main":[[{"node":"DataForSEO Bulk","type":"main","index":0}],[{"node":"Respond Error","type":"main","index":0}]]},"DataForSEO Bulk":{"main":[[{"node":"Merge Keywords","type":"main","index":0}]]},"Merge Keywords":{"main":[[{"node":"Build Prompt","type":"main","index":0}]]},"Build Prompt":{"main":[[{"node":"IF Run AI","type":"main","index":0}]]},"IF Run AI":{"main":[[{"node":"Gemini Filter","type":"main","index":0}],[{"node":"Skip AI","type":"main","index":0}]]},"Gemini Filter":{"main":[[{"node":"Parse Response","type":"main","index":0}]]},"Parse Response":{"main":[[{"node":"IF Save DB","type":"main","index":0}]]},"Skip AI":{"main":[[{"node":"IF Save DB","type":"main","index":0}]]},"IF Save DB":{"main":[[{"node":"Prepare Insert","type":"main","index":0}],[{"node":"Response (No DB)","type":"main","index":0}]]},"Prepare Insert":{"main":[[{"node":"Save to DB","type":"main","index":0}]]},"Save to DB":{"main":[[{"node":"Response (DB)","type":"main","index":0}]]},"Response (DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]},"Response (No DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]}}	\N	f	\N
5693bb4c-1bc1-4781-8fc9-b9cdbba5aa06	sWwmP23m89DQTpVI	Fatih Berkay Baheci	2025-12-23 19:43:18.467+00	2025-12-23 19:43:18.467+00	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"7a4686a8-c032-49ac-8603-2e91eeb6fc03","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-656,112],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"const body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\n\\nif (!Array.isArray(keywords) || keywords.length === 0) {\\n  return [{json: {error: 'keywords array required', code: 400}}];\\n}\\n\\nconst seeds = keywords\\n  .map(k => String(k).trim().toLowerCase())\\n  .filter(k => k.length >= 2)\\n  .slice(0, 20);\\n\\nif (seeds.length === 0) {\\n  return [{json: {error: 'valid keywords required', code: 400}}];\\n}\\n\\nconst locCodes = {TR: 2792, US: 2840, GB: 2826, DE: 2276};\\n\\n// Clear static data for fresh run\\nconst ctx = $getWorkflowStaticData('global');\\nctx.results = [];\\nctx.projectId = projectId ? parseInt(projectId) : null;\\nctx.clientId = clientId ? parseInt(clientId) : null;\\nctx.startTime = Date.now();\\nctx.totalSeeds = seeds.length;\\n\\n// Return each seed as separate item\\nreturn seeds.map(seed => ({\\n  json: {\\n    seed,\\n    locationCode: locCodes[country] || 2792,\\n    language\\n  }\\n}));"},"id":"e00aa475-179b-4157-bf38-b4d274937271","name":"Validate","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"options":{}},"id":"84410ee5-19a9-47fb-9197-545c7da900c0","name":"Loop Seeds","type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-224,112]},{"parameters":{"workflowId":{"__rl":true,"mode":"id","value":"MhHeIUZBSMtqRRrR"},"options":{}},"id":"467d2bcd-e6d2-467c-b0a1-da31ba66bcbb","name":"Process Seed","type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[0,0]},{"parameters":{"jsCode":"const result = $input.first().json;\\n\\n// Accumulate results in static data\\nconst ctx = $getWorkflowStaticData('global');\\nif (!ctx.results) ctx.results = [];\\n\\nctx.results.push({\\n  seed: result.seed,\\n  approved: result.approved || [],\\n  rejected: result.rejected || [],\\n  stats: result.stats || {approved: 0, rejected: 0}\\n});\\n\\nreturn [{json: {accumulated: ctx.results.length}}];"},"id":"f416ec62-fbdc-49a6-ad95-eb1d9120c79a","name":"Accumulate","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"jsCode":"const ctx = $getWorkflowStaticData('global');\\nconst results = ctx.results || [];\\nconst projectId = ctx.projectId;\\nconst clientId = ctx.clientId;\\nconst startTime = ctx.startTime;\\nconst totalSeeds = ctx.totalSeeds;\\n\\n// Combine all results\\nconst allApproved = [];\\nconst allRejected = [];\\nconst perSeed = {};\\n\\nresults.forEach(r => {\\n  allApproved.push(...(r.approved || []));\\n  allRejected.push(...(r.rejected || []));\\n  perSeed[r.seed] = r.stats;\\n});\\n\\n// Clear static data\\ndelete ctx.results;\\ndelete ctx.projectId;\\ndelete ctx.clientId;\\ndelete ctx.startTime;\\ndelete ctx.totalSeeds;\\n\\nreturn [{json: {\\n  projectId,\\n  clientId,\\n  stats: {\\n    total_seeds: totalSeeds,\\n    total_approved: allApproved.length,\\n    total_rejected: allRejected.length,\\n    per_seed: perSeed\\n  },\\n  approved_keywords: allApproved,\\n  rejected_keywords: allRejected,\\n  startTime\\n}}];"},"id":"9df0fd50-cbc1-4670-b30d-4bd75f83920c","name":"Finalize","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,304]},{"parameters":{"conditions":{"options":{"leftValue":"","typeValidation":"loose"},"conditions":[{"leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}]},"options":{}},"id":"5e518832-eeb2-44cd-88a3-f92b63aa3c73","name":"IF DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[224,304]},{"parameters":{"jsCode":"const d = $input.first().json;\\nconst all = [...(d.approved_keywords || []), ...(d.rejected_keywords || [])];\\n\\nif (!all.length || !d.projectId) {\\n  return [{json: {...d, query: 'SELECT 1'}}];\\n}\\n\\nconst esc = s => s == null ? 'NULL' : \\"'\\" + String(s).replace(/'/g, \\"''\\") + \\"'\\";\\n\\nconst vals = all.slice(0, 2000).map(k => \\n  `(${d.projectId},${esc(k.keyword)},${esc(k.seed_keyword)},'related',${k.search_volume || 'NULL'},${k.cpc || 'NULL'},NULL,NULL,${esc(k.seed_keyword)},${esc(k.priority || 'medium')},'cluster','dataforseo','${k.status}',NULL)`\\n).join(',');\\n\\nconst query = `INSERT INTO keyword_results(project_id,keyword,seed_keyword,keyword_type,search_volume,cpc,competition,search_intent,keyword_cluster,content_priority,page_type,source,status,reject_reason) VALUES ${vals} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume),status=VALUES(status),seed_keyword=VALUES(seed_keyword)`;\\n\\nreturn [{json: {...d, query}}];"},"id":"8b70f825-ef2e-4d4e-bcda-2a2ec3ed6b0f","name":"Build SQL","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,208]},{"parameters":{"operation":"executeQuery","query":"={{ $json.query }}","options":{}},"id":"78f44e52-56f6-40de-b182-4d70964b37bb","name":"MySQL","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[672,208],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const d = $('Build SQL').first().json;\\nreturn [{json: {\\n  success: true,\\n  message: `Bulk tamamlandi: ${d.approved_keywords?.length || 0} ana sonuc, ${d.rejected_keywords?.length || 0} diger`,\\n  project_id: d.projectId,\\n  stats: d.stats,\\n  keywords: (d.approved_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume,\\n    priority: k.priority,\\n    status: k.status\\n  })),\\n  rejected_keywords: (d.rejected_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume\\n  })),\\n  processing_time_ms: Date.now() - d.startTime\\n}}];"},"id":"abeac08c-751c-4558-9b77-7c35715baefe","name":"Response DB","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,208]},{"parameters":{"jsCode":"const d = $input.first().json;\\nreturn [{json: {\\n  success: true,\\n  message: `Bulk tamamlandi: ${d.approved_keywords?.length || 0} ana sonuc, ${d.rejected_keywords?.length || 0} diger`,\\n  project_id: null,\\n  stats: d.stats,\\n  keywords: (d.approved_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume,\\n    priority: k.priority,\\n    status: k.status\\n  })),\\n  rejected_keywords: (d.rejected_keywords || []).map(k => ({\\n    keyword: k.keyword,\\n    seed_keyword: k.seed_keyword,\\n    search_volume: k.search_volume\\n  })),\\n  processing_time_ms: Date.now() - d.startTime\\n}}];"},"id":"c23881c5-dc7d-4f9d-bf66-4d48b199d8a4","name":"Response No DB","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,400]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"4ca429dc-b6c8-44a3-870e-aba7b21191fd","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1104,304]}]	{"Webhook":{"main":[[{"node":"Validate","type":"main","index":0}]]},"Validate":{"main":[[{"node":"Loop Seeds","type":"main","index":0}]]},"Loop Seeds":{"main":[[{"node":"Process Seed","type":"main","index":0}],[{"node":"Finalize","type":"main","index":0}]]},"Process Seed":{"main":[[{"node":"Accumulate","type":"main","index":0}]]},"Accumulate":{"main":[[{"node":"Loop Seeds","type":"main","index":0}]]},"Finalize":{"main":[[{"node":"IF DB","type":"main","index":0}]]},"IF DB":{"main":[[{"node":"Build SQL","type":"main","index":0}],[{"node":"Response No DB","type":"main","index":0}]]},"Build SQL":{"main":[[{"node":"MySQL","type":"main","index":0}]]},"MySQL":{"main":[[{"node":"Response DB","type":"main","index":0}]]},"Response DB":{"main":[[{"node":"Respond","type":"main","index":0}]]},"Response No DB":{"main":[[{"node":"Respond","type":"main","index":0}]]}}	\N	f	\N
d724fddc-5297-4e70-8079-2ccd271e6ae0	adol4O3V4iGsGXpf	Fatih Berkay Baheci	2025-12-23 12:21:01.822+00	2025-12-23 12:21:01.822+00	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"68cfe983-5aef-4d2e-8384-62ed9ea87452","name":"Webhook Bulk","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1536,112],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"// ===========================================\\n// BULK INPUT VALIDATION\\n// ===========================================\\nconst body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\nconst customRules = body.custom_rules || '';\\n\\nif (!Array.isArray(keywords) || keywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'keywords array required', errorCode: 400 }}];\\n}\\n\\nconst cleanKeywords = keywords\\n  .map(k => String(k).trim().toLowerCase())\\n  .filter(k => k.length >= 2)\\n  .slice(0, 100);\\n\\nif (cleanKeywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'Min 1 valid keyword required', errorCode: 400 }}];\\n}\\n\\nconst locationCodes = { 'TR': 2792, 'US': 2840, 'GB': 2826, 'DE': 2276, 'FR': 2250 };\\n\\nreturn [{ json: { \\n  isValid: true,\\n  keywords: cleanKeywords,\\n  keywordCount: cleanKeywords.length,\\n  projectId: projectId ? parseInt(projectId) : null,\\n  clientId: clientId ? parseInt(clientId) : null,\\n  country, language,\\n  locationCode: locationCodes[country] || 2792,\\n  customRules,\\n  startTime: Date.now()\\n}}];"},"id":"afc275f0-8234-4c9d-a8fe-4b8667f574d5","name":"Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1328,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"54d3977e-55f9-4567-a6b6-03b78681b7f2","name":"IF Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1104,112]},{"parameters":{"respondWith":"json","responseBody":"={ \\"success\\": false, \\"error\\": \\"{{ $json.error }}\\" }","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"69e1bf8d-d7a8-429b-a619-561aa7062e54","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-880,304]},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\n  \\"keywords\\": {{ JSON.stringify($json.keywords) }},\\n  \\"location_code\\": {{ $json.locationCode }},\\n  \\"language_code\\": \\"{{ $json.language }}\\",\\n  \\"include_seed_keyword\\": true,\\n  \\"sort_by\\": \\"search_volume\\"\\n}]","options":{"timeout":120000}},"id":"a93d2f8d-521f-4ac8-bace-c580551fc5cf","name":"DataForSEO Bulk","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-880,112],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// PARSE DATAFORSEO & PREPARE FOR CLASSIFICATION\\n// ===========================================\\nconst input = $('Validate Input').first().json;\\nconst seedKeywords = input.keywords || [];\\n\\nfunction normalizeForComparison(str) {\\n  return str.toLowerCase()\\n    .replace(//g, 'i').replace(//g, 'i')\\n    .replace(//g, 's').replace(//g, 's')\\n    .replace(//g, 'o').replace(//g, 'o')\\n    .replace(//g, 'u').replace(//g, 'u')\\n    .replace(//g, 'c').replace(//g, 'c')\\n    .replace(//g, 'g').replace(//g, 'g')\\n    .replace(/[^a-z0-9\\\\s]/g, '').replace(/\\\\s+/g, ' ').trim();\\n}\\n\\n// Parse DataForSEO response\\nlet allKeywords = [];\\nconst seedVolumeMap = new Map();\\n\\ntry {\\n  const dfsResponse = $input.first().json;\\n  if (dfsResponse?.tasks?.[0]?.result) {\\n    allKeywords = dfsResponse.tasks[0].result.map(kw => {\\n      const keyword = (kw.keyword || '').toLowerCase().trim();\\n      \\n      // Track volume for seed keywords\\n      const kwNorm = normalizeForComparison(keyword);\\n      for (const seed of seedKeywords) {\\n        if (normalizeForComparison(seed) === kwNorm && kw.search_volume) {\\n          seedVolumeMap.set(seed, { volume: kw.search_volume, cpc: kw.cpc });\\n        }\\n      }\\n      \\n      return {\\n        keyword: keyword,\\n        search_volume: kw.search_volume || 0,\\n        cpc: kw.cpc || 0,\\n        competition: kw.competition || null,\\n        source: 'dataforseo'\\n      };\\n    }).filter(kw => kw.keyword && kw.keyword.length >= 2);\\n  }\\n} catch (e) { console.log('DFS error:', e.message); }\\n\\n// Dedupe\\nconst seen = new Map();\\nallKeywords.forEach(kw => {\\n  const key = normalizeForComparison(kw.keyword);\\n  if (key.length >= 2 && !seen.has(key)) {\\n    seen.set(key, kw);\\n  }\\n});\\n\\n// Add all seed keywords (they should always exist)\\nseedKeywords.forEach((seed, idx) => {\\n  const key = normalizeForComparison(seed);\\n  const existingData = seedVolumeMap.get(seed);\\n  \\n  if (!seen.has(key)) {\\n    seen.set(key, {\\n      keyword: seed.toLowerCase().trim(),\\n      search_volume: existingData?.volume || 0,\\n      cpc: existingData?.cpc || 0,\\n      competition: null,\\n      source: 'seed',\\n      is_seed: true,\\n      seed_index: idx\\n    });\\n  } else {\\n    const existing = seen.get(key);\\n    existing.is_seed = true;\\n    existing.seed_index = idx;\\n  }\\n});\\n\\n// Sort by volume\\nconst uniqueKeywords = Array.from(seen.values())\\n  .sort((a, b) => (b.search_volume || 0) - (a.search_volume || 0));\\n\\n// Take top 500 for classification (Gemini limit)\\nconst forClassification = uniqueKeywords.slice(0, 500);\\nconst remaining = uniqueKeywords.slice(500);\\n\\nreturn [{ json: {\\n  ...input,\\n  allKeywords: uniqueKeywords,\\n  forClassification: forClassification,\\n  remainingKeywords: remaining,\\n  stats: {\\n    total_seeds: seedKeywords.length,\\n    from_dataforseo: allKeywords.length,\\n    unique: uniqueKeywords.length,\\n    for_classification: forClassification.length,\\n    remaining: remaining.length\\n  }\\n}}];"},"id":"b6fd9fc0-65d5-4a50-97d1-2a1c16687c87","name":"Parse DataForSEO","type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,112]},{"parameters":{"jsCode":"// ===========================================\\n// BUILD CLASSIFICATION PROMPT\\n// ===========================================\\nconst data = $input.first().json;\\nconst keywords = data.forClassification || [];\\nconst seedKeywords = data.keywords || [];\\n\\nif (keywords.length === 0) {\\n  return [{ json: { ...data, skipClassification: true }}];\\n}\\n\\n// Build numbered seed list\\nconst seedList = seedKeywords.map((s, i) => `${i + 1}. ${s}`).join('\\\\n');\\n\\n// Build keyword list (just keywords, numbered)\\nconst keywordList = keywords.map((kw, i) => `${i + 1}. ${kw.keyword}`).join('\\\\n');\\n\\nconst classificationPrompt = `Sen bir SEO keyword siniflandirma uzmanisin. Asagidaki keywordlerin HER BIRINI en uygun SEED KEYWORD ile eslestir.\\n\\nSEED KEYWORDS:\\n${seedList}\\n\\nKURALLAR:\\n1. Her keyword SADECE BIR seed ile eslesebilir\\n2. Keyword, seed ile ANLAMSAL olarak iliskili olmali\\n3. Eger hicbir seed ile alakasi yoksa 0 yaz\\n4. Esanlamli/iliskili kelimeleri dikkate al (ornek: laptop = dizustu, terlik/bot/sandalet = ayakkabi)\\n5. Marka isimleri o kategorinin urunlerine aittir (Nike, Adidas = ayakkabi; Asus, HP = bilgisayar)\\n\\nKEYWORDS:\\n${keywordList}\\n\\nHer satir icin SADECE su formatta cevap ver:\\nkeyword_no|seed_no\\n\\nOrnek:\\n1|2\\n2|5\\n3|0\\n\\nSadece numaralari yaz, aciklama yapma.`;\\n\\nreturn [{ json: { ...data, classificationPrompt, skipClassification: false }}];"},"id":"44244491-ce39-4374-a6cf-2b3b817fe71b","name":"Build Classification Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"skip","leftValue":"={{ $json.skipClassification }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"4fde4e2e-7bfd-481a-89a2-5f2ee1b8af3d","name":"IF Classify","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{ \\"parts\\": [{ \\"text\\": {{ JSON.stringify($json.classificationPrompt) }} }] }],\\n  \\"generationConfig\\": { \\"temperature\\": 0.1, \\"maxOutputTokens\\": 8192 }\\n}","options":{"timeout":120000}},"id":"a5667675-ddfa-4402-832c-1b7eb0c30cac","name":"Gemini Classify","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,0],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// PARSE CLASSIFICATION & BUILD FILTER PROMPT\\n// ===========================================\\nconst prevData = $('Build Classification Prompt').first().json;\\nconst geminiResponse = $input.first().json;\\nconst keywords = prevData.forClassification || [];\\nconst seedKeywords = prevData.keywords || [];\\nconst remainingKeywords = prevData.remainingKeywords || [];\\n\\n// Parse Gemini classification response\\nconst classificationMap = new Map();\\n\\ntry {\\n  const text = geminiResponse?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  const lines = text.split('\\\\n').filter(l => l.trim());\\n  \\n  for (const line of lines) {\\n    const match = line.match(/^(\\\\d+)\\\\|(\\\\d+)$/);\\n    if (match) {\\n      const kwIndex = parseInt(match[1]) - 1;\\n      const seedIndex = parseInt(match[2]) - 1;\\n      \\n      if (kwIndex >= 0 && kwIndex < keywords.length) {\\n        if (seedIndex >= 0 && seedIndex < seedKeywords.length) {\\n          classificationMap.set(kwIndex, seedKeywords[seedIndex]);\\n        } else if (match[2] === '0') {\\n          classificationMap.set(kwIndex, '__UNRELATED__');\\n        }\\n      }\\n    }\\n  }\\n} catch (e) {\\n  console.log('Classification parse error:', e.message);\\n}\\n\\n// Apply classification to keywords\\nconst classifiedKeywords = keywords.map((kw, idx) => {\\n  const assignedSeed = classificationMap.get(idx);\\n  \\n  // If it's a seed keyword itself, assign to itself\\n  if (kw.is_seed && kw.seed_index !== undefined) {\\n    return {\\n      ...kw,\\n      seed_keyword: seedKeywords[kw.seed_index],\\n      classification_source: 'is_seed'\\n    };\\n  }\\n  \\n  if (assignedSeed === '__UNRELATED__') {\\n    return {\\n      ...kw,\\n      seed_keyword: null,\\n      classification_source: 'unrelated',\\n      status: 'rejected',\\n      reject_reason: 'Hicbir seed ile alakali degil'\\n    };\\n  }\\n  \\n  if (assignedSeed) {\\n    return {\\n      ...kw,\\n      seed_keyword: assignedSeed,\\n      classification_source: 'gemini'\\n    };\\n  }\\n  \\n  // Fallback: try to match by keyword content\\n  const kwLower = kw.keyword.toLowerCase();\\n  for (const seed of seedKeywords) {\\n    if (kwLower.includes(seed.toLowerCase()) || seed.toLowerCase().includes(kwLower)) {\\n      return {\\n        ...kw,\\n        seed_keyword: seed,\\n        classification_source: 'contains'\\n      };\\n    }\\n  }\\n  \\n  // Still no match - mark as unrelated\\n  return {\\n    ...kw,\\n    seed_keyword: null,\\n    classification_source: 'no_match',\\n    status: 'rejected',\\n    reject_reason: 'Siniflandirilamadi'\\n  };\\n});\\n\\n// Separate classified and unrelated\\nconst validKeywords = classifiedKeywords.filter(kw => kw.seed_keyword !== null);\\nconst unrelatedKeywords = classifiedKeywords.filter(kw => kw.seed_keyword === null);\\n\\n// Add remaining keywords (mark as pending for later processing)\\nconst pendingKeywords = remainingKeywords.map(kw => ({\\n  ...kw,\\n  seed_keyword: null,\\n  status: 'pending',\\n  reject_reason: 'Siniflandirilmadi (limit asimi)'\\n}));\\n\\n// Take top 150 for filtering\\nconst forFiltering = validKeywords.slice(0, 150);\\nconst restValid = validKeywords.slice(150);\\n\\n// Build filter prompt\\nconst keywordCsv = forFiltering.map((kw, i) => {\\n  const vol = kw.search_volume || 0;\\n  const cpc = kw.cpc ? kw.cpc.toFixed(2) : '0';\\n  const seed = kw.seed_keyword || '';\\n  return `${i+1}|${kw.keyword}|${vol}|${cpc}|${seed}`;\\n}).join('\\\\n');\\n\\nconst seedList = seedKeywords.join(', ');\\n\\nconst filterPrompt = `Sen bir SEO uzmanisin. Keyword filtreleme yapiyorsun.\\n\\nSEED KEYWORDS: ${seedList}\\n\\nAsagidaki keywordler zaten dogru seed ile eslestirildi. Simdi her keyword'un:\\n1. Seed ile GERCEKTEN alakali olup olmadigini kontrol et\\n2. Spam/anlamsiz olup olmadigini kontrol et\\n3. SEO degeri olup olmadigini degerlendir\\n\\nKEYWORDS (No|keyword|volume|cpc|seed):\\n${keywordCsv}\\n\\nHer keyword icin:\\n- Uygunsa: No|approved|intent|cluster|priority|content_type\\n- Uygun degilse: No|rejected|||||reason\\n\\nIntent: informational, commercial, transactional, navigational\\nPriority: high (volume>1000), medium (100-1000), low (<100)\\nContent_type: pillar, cluster, blog, product, faq\\n\\nSadece satirlari yaz.`;\\n\\n// Stats per seed\\nconst seedStats = {};\\nseedKeywords.forEach(seed => {\\n  seedStats[seed] = validKeywords.filter(kw => kw.seed_keyword === seed).length;\\n});\\n\\nreturn [{ json: {\\n  ...prevData,\\n  classifiedKeywords: validKeywords,\\n  unrelatedKeywords: unrelatedKeywords,\\n  pendingKeywords: [...restValid.map(kw => ({ ...kw, status: 'pending' })), ...pendingKeywords],\\n  forFiltering: forFiltering,\\n  filterPrompt: filterPrompt,\\n  stats: {\\n    ...prevData.stats,\\n    classified: validKeywords.length,\\n    unrelated: unrelatedKeywords.length,\\n    for_filtering: forFiltering.length,\\n    per_seed: seedStats\\n  }\\n}}];"},"id":"336c8bbe-6f3e-41e4-9280-17d868f455c4","name":"Parse Classification","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{ \\"parts\\": [{ \\"text\\": {{ JSON.stringify($json.filterPrompt) }} }] }],\\n  \\"generationConfig\\": { \\"temperature\\": 0.3, \\"maxOutputTokens\\": 8192 }\\n}","options":{"timeout":120000}},"id":"4a78b134-423f-4712-bf72-dca2949576e8","name":"Gemini Filter","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[448,0],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// PARSE FILTER RESPONSE\\n// ===========================================\\nconst prevData = $('Parse Classification').first().json;\\nconst geminiResponse = $input.first().json;\\nconst forFiltering = prevData.forFiltering || [];\\nconst pendingKeywords = prevData.pendingKeywords || [];\\nconst unrelatedKeywords = prevData.unrelatedKeywords || [];\\n\\nconst approved = [];\\nconst rejected = [...unrelatedKeywords]; // Start with unrelated\\n\\ntry {\\n  const text = geminiResponse?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  const lines = text.split('\\\\n').filter(l => /^\\\\d+\\\\|/.test(l.trim()));\\n  const processedIndices = new Set();\\n  \\n  for (const line of lines) {\\n    const parts = line.split('|').map(p => p.trim());\\n    if (parts.length < 2) continue;\\n    \\n    const no = parseInt(parts[0]);\\n    const status = (parts[1] || '').toLowerCase();\\n    \\n    if (isNaN(no) || no < 1 || no > forFiltering.length) continue;\\n    \\n    const original = forFiltering[no - 1];\\n    processedIndices.add(no);\\n    \\n    if (status === 'approved') {\\n      approved.push({\\n        ...original,\\n        intent: parts[2] || null,\\n        cluster: parts[3] || null,\\n        priority: parts[4] || 'medium',\\n        content_type: parts[5] || 'cluster',\\n        status: 'approved',\\n        reject_reason: null\\n      });\\n    } else {\\n      rejected.push({\\n        ...original,\\n        intent: null,\\n        cluster: null,\\n        priority: null,\\n        content_type: null,\\n        status: 'rejected',\\n        reject_reason: parts[6] || 'filtered'\\n      });\\n    }\\n  }\\n  \\n  // Handle unprocessed keywords\\n  forFiltering.forEach((kw, idx) => {\\n    if (!processedIndices.has(idx + 1)) {\\n      // Seed keywords should always be approved\\n      if (kw.is_seed) {\\n        approved.push({\\n          ...kw,\\n          intent: 'informational',\\n          cluster: kw.keyword,\\n          priority: 'high',\\n          content_type: 'pillar',\\n          status: 'approved'\\n        });\\n      } else {\\n        rejected.push({\\n          ...kw,\\n          status: 'pending',\\n          reject_reason: 'AI skipped'\\n        });\\n      }\\n    }\\n  });\\n} catch (e) {\\n  console.log('Filter parse error:', e.message);\\n  // On error, approve all classified keywords\\n  forFiltering.forEach(kw => {\\n    approved.push({\\n      ...kw,\\n      status: 'approved',\\n      priority: 'medium',\\n      content_type: 'cluster'\\n    });\\n  });\\n}\\n\\n// Add pending keywords\\nrejected.push(...pendingKeywords);\\n\\n// Clusters\\nconst clusters = {};\\napproved.forEach(kw => {\\n  const c = kw.cluster || kw.seed_keyword || 'Genel';\\n  if (!clusters[c]) clusters[c] = [];\\n  clusters[c].push(kw.keyword);\\n});\\n\\nreturn [{ json: {\\n  projectId: prevData.projectId,\\n  clientId: prevData.clientId,\\n  mainKeyword: prevData.keywords[0],\\n  stats: {\\n    ...prevData.stats,\\n    approved: approved.length,\\n    rejected: rejected.length\\n  },\\n  approved_keywords: approved,\\n  rejected_keywords: rejected,\\n  all_keywords: [...approved, ...rejected],\\n  clusters,\\n  ai_used: true,\\n  processing_time_ms: Date.now() - prevData.startTime\\n}}];"},"id":"b27352a8-6c86-4600-a77a-be6ee448c052","name":"Parse Filter Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,0]},{"parameters":{"jsCode":"// ===========================================\\n// SKIP CLASSIFICATION - Fallback\\n// ===========================================\\nconst data = $input.first().json;\\nconst keywords = data.allKeywords || [];\\nconst seedKeywords = data.keywords || [];\\n\\n// Simple fallback: mark all as pending\\nconst approved = [];\\nconst pending = keywords.map(kw => ({\\n  ...kw,\\n  seed_keyword: kw.is_seed ? seedKeywords[kw.seed_index] : null,\\n  status: 'pending',\\n  reject_reason: 'Classification skipped'\\n}));\\n\\n// At least approve seed keywords\\nseedKeywords.forEach((seed, idx) => {\\n  approved.push({\\n    keyword: seed,\\n    seed_keyword: seed,\\n    search_volume: 0,\\n    status: 'approved',\\n    priority: 'high',\\n    content_type: 'pillar',\\n    is_seed: true\\n  });\\n});\\n\\nreturn [{ json: {\\n  projectId: data.projectId,\\n  clientId: data.clientId,\\n  mainKeyword: data.keywords[0],\\n  stats: { ...data.stats, approved: approved.length, rejected: pending.length },\\n  approved_keywords: approved,\\n  rejected_keywords: pending,\\n  all_keywords: [...approved, ...pending],\\n  clusters: {},\\n  ai_used: false,\\n  processing_time_ms: Date.now() - data.startTime\\n}}];"},"id":"9166a14c-96cb-4ff4-b2fa-eb4914dfd090","name":"Skip Classification","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,208]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"has-project","leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}],"combinator":"and"},"options":{}},"id":"aaebc3b0-72ef-406f-ba15-0ea8949145ce","name":"IF Save DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[880,112]},{"parameters":{"jsCode":"// ===========================================\\n// PREPARE BATCH INSERT\\n// ===========================================\\nconst data = $input.first().json;\\nconst projectId = data.projectId;\\nconst allKeywords = data.all_keywords || [];\\n\\nif (allKeywords.length === 0) {\\n  return [{ json: { skip: true, batchQuery: '' }}];\\n}\\n\\nfunction esc(str) {\\n  if (str === null || str === undefined) return 'NULL';\\n  return \\"'\\" + String(str).replace(/\\\\\\\\/g, '\\\\\\\\\\\\\\\\').replace(/'/g, \\"''\\") + \\"'\\";\\n}\\n\\nconst values = allKeywords.slice(0, 500).map(kw => {\\n  const kwType = kw.source?.includes('suggest') ? 'google_suggest' : 'related';\\n  const src = (kw.source || 'dataforseo').split(',')[0].trim();\\n  return `(${projectId}, ${esc(kw.keyword)}, ${esc(kw.seed_keyword)}, '${kwType}', ${kw.search_volume || 'NULL'}, ${kw.cpc || 'NULL'}, ${esc(kw.competition)}, ${esc(kw.intent)}, ${esc(kw.cluster)}, ${esc(kw.priority)}, ${esc(kw.content_type)}, '${src}', '${kw.status || 'pending'}', ${esc(kw.reject_reason)})`;\\n}).join(',\\\\n');\\n\\nconst query = `INSERT INTO keyword_results (project_id, keyword, seed_keyword, keyword_type, search_volume, cpc, competition, search_intent, keyword_cluster, content_priority, page_type, source, status, reject_reason) VALUES ${values} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume), status=VALUES(status), seed_keyword=VALUES(seed_keyword)`;\\n\\nreturn [{ json: { ...data, batchQuery: query }}];"},"id":"238daf7e-164c-4fb0-9222-e811b87e8180","name":"Prepare Insert","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,0]},{"parameters":{"operation":"executeQuery","query":"={{ $json.batchQuery }}","options":{}},"id":"9c3edc17-dd79-47d8-9c56-e2403b545e10","name":"Save to DB","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1328,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// ===========================================\\n// FINAL RESPONSE\\n// ===========================================\\nconst data = $('Prepare Insert').first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi. ${approved.length} onaylandi, ${rejected.length} reddedildi.`,\\n  project_id: data.projectId,\\n  stats: data.stats,\\n  keywords: approved.slice(0, 200).map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    intent: kw.intent,\\n    cluster: kw.cluster,\\n    priority: kw.priority,\\n    status: kw.status\\n  })),\\n  rejected: rejected.slice(0, 50).map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    reason: kw.reject_reason\\n  })),\\n  clusters: data.clusters,\\n  ai_used: data.ai_used,\\n  processing_time_ms: data.processing_time_ms\\n}}];"},"id":"04b11aaf-ca27-4b03-b86a-1e6faf9cd49b","name":"Response (DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[1552,0]},{"parameters":{"jsCode":"// ===========================================\\n// RESPONSE WITHOUT DB\\n// ===========================================\\nconst data = $input.first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi (DB yok). ${approved.length} onaylandi.`,\\n  project_id: null,\\n  stats: data.stats,\\n  keywords: approved.slice(0, 200),\\n  rejected: rejected.slice(0, 50),\\n  clusters: data.clusters,\\n  ai_used: data.ai_used\\n}}];"},"id":"8fffb68b-ea56-4f3e-861c-f21632c13a51","name":"Response (No DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,208]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"2b7d2448-aeb3-43e8-b848-f0196916d8ea","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1760,112]}]	{"Webhook Bulk":{"main":[[{"node":"Validate Input","type":"main","index":0}]]},"Validate Input":{"main":[[{"node":"IF Valid","type":"main","index":0}]]},"IF Valid":{"main":[[{"node":"DataForSEO Bulk","type":"main","index":0}],[{"node":"Respond Error","type":"main","index":0}]]},"DataForSEO Bulk":{"main":[[{"node":"Parse DataForSEO","type":"main","index":0}]]},"Parse DataForSEO":{"main":[[{"node":"Build Classification Prompt","type":"main","index":0}]]},"Build Classification Prompt":{"main":[[{"node":"IF Classify","type":"main","index":0}]]},"IF Classify":{"main":[[{"node":"Gemini Classify","type":"main","index":0}],[{"node":"Skip Classification","type":"main","index":0}]]},"Gemini Classify":{"main":[[{"node":"Parse Classification","type":"main","index":0}]]},"Parse Classification":{"main":[[{"node":"Gemini Filter","type":"main","index":0}]]},"Gemini Filter":{"main":[[{"node":"Parse Filter Response","type":"main","index":0}]]},"Parse Filter Response":{"main":[[{"node":"IF Save DB","type":"main","index":0}]]},"Skip Classification":{"main":[[{"node":"IF Save DB","type":"main","index":0}]]},"IF Save DB":{"main":[[{"node":"Prepare Insert","type":"main","index":0}],[{"node":"Response (No DB)","type":"main","index":0}]]},"Prepare Insert":{"main":[[{"node":"Save to DB","type":"main","index":0}]]},"Save to DB":{"main":[[{"node":"Response (DB)","type":"main","index":0}]]},"Response (DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]},"Response (No DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]}}	\N	f	\N
7076bc45-4490-4155-8c2d-e0ed15df4562	adol4O3V4iGsGXpf	Fatih Berkay Baheci	2025-12-23 12:52:38.506+00	2025-12-23 12:52:38.506+00	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"a211aed4-620b-476c-8099-f44423abc0d0","name":"Webhook Bulk","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-2208,112],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"const body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\n\\nif (!Array.isArray(keywords) || keywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'keywords array required', errorCode: 400 }}];\\n}\\n\\nconst cleanKeywords = keywords.map(k => String(k).trim().toLowerCase()).filter(k => k.length >= 2).slice(0, 100);\\n\\nif (cleanKeywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'Min 1 valid keyword required', errorCode: 400 }}];\\n}\\n\\nconst locationCodes = { 'TR': 2792, 'US': 2840, 'GB': 2826, 'DE': 2276, 'FR': 2250 };\\n\\nreturn [{ json: { \\n  isValid: true, keywords: cleanKeywords, keywordCount: cleanKeywords.length,\\n  projectId: projectId ? parseInt(projectId) : null, clientId: clientId ? parseInt(clientId) : null,\\n  country, language, locationCode: locationCodes[country] || 2792, startTime: Date.now()\\n}}];"},"id":"2f9f85f2-6b14-42a7-bd80-7d24d65c1f21","name":"Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1984,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"e10371fe-a4a9-4096-af99-c193b0d58395","name":"IF Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1760,112]},{"parameters":{"respondWith":"json","responseBody":"={ \\"success\\": false, \\"error\\": \\"{{ $json.error }}\\" }","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"886d742f-a9f4-4aa8-8c54-5a7de94c9893","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-1536,304]},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\n  \\"keywords\\": {{ JSON.stringify($json.keywords) }},\\n  \\"location_code\\": {{ $json.locationCode }},\\n  \\"language_code\\": \\"{{ $json.language }}\\",\\n  \\"include_seed_keyword\\": true,\\n  \\"sort_by\\": \\"search_volume\\"\\n}]","options":{"timeout":120000}},"id":"841ba99e-7fcb-4668-87a7-b4b166c79bfd","name":"DataForSEO Bulk","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1536,112],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Parse DataForSEO & Build Classification Prompt\\nconst input = $('Validate Input').first().json;\\nconst seedKeywords = input.keywords || [];\\n\\nfunction normalize(str) {\\n  return str.toLowerCase().replace(//g,'i').replace(//g,'i').replace(//g,'s').replace(//g,'s')\\n    .replace(//g,'o').replace(//g,'o').replace(//g,'u').replace(//g,'u')\\n    .replace(//g,'c').replace(//g,'c').replace(//g,'g').replace(//g,'g')\\n    .replace(/[^a-z0-9\\\\s]/g,'').replace(/\\\\s+/g,' ').trim();\\n}\\n\\nlet allKeywords = [];\\ntry {\\n  const dfs = $input.first().json;\\n  if (dfs?.tasks?.[0]?.result) {\\n    allKeywords = dfs.tasks[0].result.map(kw => ({\\n      keyword: (kw.keyword || '').toLowerCase().trim(),\\n      search_volume: kw.search_volume || 0,\\n      cpc: kw.cpc || 0,\\n      competition: kw.competition || null\\n    })).filter(kw => kw.keyword && kw.keyword.length >= 2);\\n  }\\n} catch(e) {}\\n\\n// Dedupe\\nconst seen = new Map();\\nallKeywords.forEach(kw => {\\n  const key = normalize(kw.keyword);\\n  if (key.length >= 2 && !seen.has(key)) seen.set(key, kw);\\n});\\n\\n// Add seeds\\nseedKeywords.forEach((seed, idx) => {\\n  const key = normalize(seed);\\n  if (!seen.has(key)) {\\n    seen.set(key, { keyword: seed.toLowerCase().trim(), search_volume: 0, cpc: 0, competition: null, is_seed: true, seed_index: idx });\\n  } else {\\n    const e = seen.get(key); e.is_seed = true; e.seed_index = idx;\\n  }\\n});\\n\\nconst unique = Array.from(seen.values());\\nconst forClass = unique.slice(0, 2000);\\nconst remaining = unique.slice(2000);\\n\\n// Build prompt\\nconst seedList = seedKeywords.map((s,i) => `${i+1}. ${s}`).join('\\\\n');\\nconst kwList = forClass.map((kw,i) => `${i+1}. ${kw.keyword}`).join('\\\\n');\\n\\nconst prompt = `Sen SEO keyword siniflandirma uzmanisin. TUM keywordleri en uygun SEED ile eslestir.\\n\\nSEED KEYWORDS:\\n${seedList}\\n\\nKURALLAR:\\n1. Her keyword SADECE 1 seed ile eslesir\\n2. Anlamsal iliski kur (laptop/notebook=bilgisayar, terlik/bot/sandalet=ayakkabi, krem/serum=cilt bakimi)\\n3. Markalar kategoriye gore (Nike/Adidas=ayakkabi, Asus/HP=bilgisayar, Arcelik/Bosch=beyaz esya, Bioderma/Cerave=cilt bakimi)\\n4. Alakasiz=0\\n5. HEPSINI isle, atlama\\n\\nKEYWORDS (${forClass.length} adet):\\n${kwList}\\n\\nCIKTI: Her satir keyword_no|seed_no\\nOrnek: 1|2, 2|5, 3|0\\nSadece numaralar, aciklama yok.`;\\n\\nreturn [{ json: {\\n  ...input,\\n  allKeywords: unique,\\n  forClassification: forClass,\\n  remainingKeywords: remaining,\\n  classificationPrompt: prompt,\\n  stats: { total_seeds: seedKeywords.length, from_dataforseo: allKeywords.length, unique: unique.length, for_classification: forClass.length }\\n}}];"},"id":"0aaf239a-dcd0-4c95-8195-c9b013ecb156","name":"Parse & Build Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1328,112]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{ \\"parts\\": [{ \\"text\\": {{ JSON.stringify($json.classificationPrompt) }} }] }],\\n  \\"generationConfig\\": { \\"temperature\\": 0.1, \\"maxOutputTokens\\": 65536 }\\n}","options":{"timeout":300000}},"id":"b6016dc4-50c4-45f7-aeb6-a11f8d806c67","name":"Gemini Classify","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1104,112],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Parse Classification & Build Filter Prompt\\nconst prev = $('Parse & Build Prompt').first().json;\\nconst gemini = $input.first().json;\\nconst seedKeywords = prev.keywords || [];\\nconst forClass = prev.forClassification || [];\\nconst remaining = prev.remainingKeywords || [];\\n\\n// Parse Gemini response\\nconst classMap = new Map();\\ntry {\\n  const text = gemini?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  text.split('\\\\n').forEach(line => {\\n    const m = line.match(/^(\\\\d+)\\\\|(\\\\d+)$/);\\n    if (m) {\\n      const kwIdx = parseInt(m[1]) - 1;\\n      const seedIdx = parseInt(m[2]) - 1;\\n      if (kwIdx >= 0 && kwIdx < forClass.length) {\\n        classMap.set(kwIdx, seedIdx >= 0 && seedIdx < seedKeywords.length ? seedKeywords[seedIdx] : null);\\n      }\\n    }\\n  });\\n} catch(e) {}\\n\\n// Apply classifications\\nconst classified = forClass.map((kw, idx) => {\\n  if (kw.is_seed) return { ...kw, seed_keyword: seedKeywords[kw.seed_index], src: 'seed' };\\n  const assigned = classMap.get(idx);\\n  return { ...kw, seed_keyword: assigned || null, src: assigned ? 'gemini' : 'unrelated' };\\n});\\n\\n// Add remaining as unclassified\\nconst allClassified = [...classified, ...remaining.map(kw => ({ ...kw, seed_keyword: null, src: 'overflow' }))];\\n\\n// Stats per seed\\nconst perSeed = {};\\nseedKeywords.forEach(s => { perSeed[s] = allClassified.filter(k => k.seed_keyword === s).length; });\\nperSeed['unrelated'] = allClassified.filter(k => !k.seed_keyword).length;\\n\\n// Build filter prompt - only for classified keywords with seeds\\nconst withSeed = allClassified.filter(k => k.seed_keyword);\\nconst forFilter = withSeed.slice(0, 1000);\\nconst filterRest = withSeed.slice(1000);\\n\\nconst seedList = seedKeywords.join(', ');\\nconst filterCsv = forFilter.map((kw,i) => `${i+1}|${kw.keyword}|${kw.search_volume}|${kw.seed_keyword}`).join('\\\\n');\\n\\nconst filterPrompt = `SEO keyword degerlendirmesi yap. Her keyword icin ICERIK URETMEYE uygun mu karar ver.\\n\\nSEED'LER: ${seedList}\\n\\nKEYWORDS (No|keyword|volume|seed):\\n${filterCsv}\\n\\nDEGERLENDIR:\\n1. Keyword seed ile ALAKALI mi? (seed sutununa bak)\\n2. Icerik uretmeye UYGUN mu?\\n3. Spam/anlamsiz mi?\\n\\nCIKTI:\\n- Uygun: No|approved|intent|priority|content_type\\n- Uygun degil: No|rejected|reason\\n\\nintent: informational/commercial/transactional/navigational\\npriority: high(vol>1000)/medium(100-1000)/low(<100)\\ncontent_type: pillar/cluster/blog/product/faq\\n\\nONEMLI: Seed ile alakali olan COGU keyword ONAYLANMALI. Sadece spam/alakasiz olanlari reddet.\\nSadece satirlar, aciklama yok.`;\\n\\nreturn [{ json: {\\n  ...prev,\\n  allClassified: allClassified,\\n  forFilter: forFilter,\\n  filterRest: filterRest,\\n  unrelatedKeywords: allClassified.filter(k => !k.seed_keyword),\\n  filterPrompt: filterPrompt,\\n  stats: { ...prev.stats, classified: classified.length, per_seed: perSeed, for_filter: forFilter.length }\\n}}];"},"id":"559ee71d-881a-435d-a00a-bc9b254f7e1e","name":"Parse & Build Filter","type":"n8n-nodes-base.code","typeVersion":2,"position":[-880,112]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{ \\"parts\\": [{ \\"text\\": {{ JSON.stringify($json.filterPrompt) }} }] }],\\n  \\"generationConfig\\": { \\"temperature\\": 0.2, \\"maxOutputTokens\\": 65536 }\\n}","options":{"timeout":300000}},"id":"47883de2-9492-4060-b65b-b698a3234120","name":"Gemini Filter","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-656,112],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Parse Filter Response & Prepare Final Data\\nconst prev = $('Parse & Build Filter').first().json;\\nconst gemini = $input.first().json;\\nconst forFilter = prev.forFilter || [];\\nconst filterRest = prev.filterRest || [];\\nconst unrelated = prev.unrelatedKeywords || [];\\nconst seedKeywords = prev.keywords || [];\\n\\nconst approved = [];\\nconst rejected = [];\\n\\n// Parse Gemini filter response\\ntry {\\n  const text = gemini?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  const processed = new Set();\\n  \\n  text.split('\\\\n').forEach(line => {\\n    const parts = line.split('|').map(p => p.trim());\\n    if (parts.length < 2 || !/^\\\\d+$/.test(parts[0])) return;\\n    \\n    const no = parseInt(parts[0]);\\n    if (no < 1 || no > forFilter.length) return;\\n    processed.add(no);\\n    \\n    const kw = forFilter[no - 1];\\n    if (parts[1].toLowerCase() === 'approved') {\\n      approved.push({\\n        ...kw,\\n        intent: parts[2] || 'informational',\\n        priority: parts[3] || 'medium',\\n        content_type: parts[4] || 'cluster',\\n        status: 'approved'\\n      });\\n    } else {\\n      rejected.push({ ...kw, status: 'rejected', reject_reason: parts[2] || 'filtered' });\\n    }\\n  });\\n  \\n  // Unprocessed - approve seeds, mark others pending\\n  forFilter.forEach((kw, idx) => {\\n    if (!processed.has(idx + 1)) {\\n      if (kw.is_seed) {\\n        approved.push({ ...kw, intent: 'informational', priority: 'high', content_type: 'pillar', status: 'approved' });\\n      } else {\\n        approved.push({ ...kw, intent: 'informational', priority: 'medium', content_type: 'cluster', status: 'approved' });\\n      }\\n    }\\n  });\\n} catch(e) {\\n  // On error, approve all\\n  forFilter.forEach(kw => {\\n    approved.push({ ...kw, intent: 'informational', priority: 'medium', content_type: 'cluster', status: 'approved' });\\n  });\\n}\\n\\n// Add filterRest as approved (they passed classification)\\nfilterRest.forEach(kw => {\\n  approved.push({ ...kw, intent: 'informational', priority: 'medium', content_type: 'cluster', status: 'approved' });\\n});\\n\\n// Add unrelated as rejected\\nunrelated.forEach(kw => {\\n  rejected.push({ ...kw, status: 'rejected', reject_reason: 'Hicbir seed ile alakasiz' });\\n});\\n\\n// Final stats\\nconst finalPerSeed = {};\\nseedKeywords.forEach(s => {\\n  finalPerSeed[s] = { total: approved.filter(k => k.seed_keyword === s).length + rejected.filter(k => k.seed_keyword === s).length, approved: approved.filter(k => k.seed_keyword === s).length };\\n});\\n\\nreturn [{ json: {\\n  projectId: prev.projectId,\\n  clientId: prev.clientId,\\n  mainKeyword: prev.keywords[0],\\n  keywords: prev.keywords,\\n  stats: { ...prev.stats, approved: approved.length, rejected: rejected.length, per_seed_final: finalPerSeed },\\n  approved_keywords: approved,\\n  rejected_keywords: rejected,\\n  all_keywords: [...approved, ...rejected],\\n  startTime: prev.startTime\\n}}];"},"id":"d7bad07e-a3d6-4cb3-bf90-d284177699c4","name":"Parse Filter","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"has-project","leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}],"combinator":"and"},"options":{}},"id":"01679065-7198-4f65-ba5b-f9a779f5a4e5","name":"IF Save DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"jsCode":"const data = $input.first().json;\\nconst projectId = data.projectId;\\nconst all = data.all_keywords || [];\\n\\nif (all.length === 0) return [{ json: { ...data, batchQuery: 'SELECT 1' }}];\\n\\nfunction esc(s) {\\n  if (s === null || s === undefined) return 'NULL';\\n  return \\"'\\" + String(s).replace(/\\\\\\\\/g,'\\\\\\\\\\\\\\\\').replace(/'/g,\\"''\\") + \\"'\\";\\n}\\n\\nconst vals = all.slice(0, 500).map(kw => {\\n  return `(${projectId}, ${esc(kw.keyword)}, ${esc(kw.seed_keyword)}, 'related', ${kw.search_volume || 'NULL'}, ${kw.cpc || 'NULL'}, ${esc(kw.competition)}, ${esc(kw.intent)}, ${esc(kw.seed_keyword)}, ${esc(kw.priority)}, ${esc(kw.content_type)}, 'dataforseo', '${kw.status || 'pending'}', ${esc(kw.reject_reason)})`;\\n}).join(',\\\\n');\\n\\nconst query = `INSERT INTO keyword_results (project_id, keyword, seed_keyword, keyword_type, search_volume, cpc, competition, search_intent, keyword_cluster, content_priority, page_type, source, status, reject_reason) VALUES ${vals} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume), status=VALUES(status), seed_keyword=VALUES(seed_keyword)`;\\n\\nreturn [{ json: { ...data, batchQuery: query }}];"},"id":"b1cc0820-3d87-4bf8-bb81-5f16deb316f3","name":"Prepare Insert","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,0]},{"parameters":{"operation":"executeQuery","query":"={{ $json.batchQuery }}","options":{}},"id":"e636173b-25cd-4fc5-b894-9d7b09169e83","name":"Save to DB","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const data = $('Prepare Insert').first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nconst sorted = approved.sort((a,b) => {\\n  if (a.seed_keyword !== b.seed_keyword) return (a.seed_keyword||'').localeCompare(b.seed_keyword||'');\\n  return (b.search_volume||0) - (a.search_volume||0);\\n});\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi. ${approved.length} onaylandi, ${rejected.length} reddedildi.`,\\n  project_id: data.projectId,\\n  stats: data.stats,\\n  keywords: sorted.slice(0, 500).map(kw => ({ keyword: kw.keyword, seed_keyword: kw.seed_keyword, search_volume: kw.search_volume, intent: kw.intent, priority: kw.priority, content_type: kw.content_type, status: kw.status })),\\n  rejected_sample: rejected.slice(0, 100).map(kw => ({ keyword: kw.keyword, seed_keyword: kw.seed_keyword, reason: kw.reject_reason })),\\n  processing_time_ms: Date.now() - data.startTime\\n}}];"},"id":"c64d8fcf-0bfe-4e47-8f34-1e5e67d68f01","name":"Response (DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"jsCode":"const data = $input.first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nconst sorted = approved.sort((a,b) => {\\n  if (a.seed_keyword !== b.seed_keyword) return (a.seed_keyword||'').localeCompare(b.seed_keyword||'');\\n  return (b.search_volume||0) - (a.search_volume||0);\\n});\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi (DB yok). ${approved.length} onaylandi, ${rejected.length} reddedildi.`,\\n  project_id: null,\\n  stats: data.stats,\\n  keywords: sorted.slice(0, 500).map(kw => ({ keyword: kw.keyword, seed_keyword: kw.seed_keyword, search_volume: kw.search_volume, intent: kw.intent, priority: kw.priority, content_type: kw.content_type, status: kw.status })),\\n  rejected_sample: rejected.slice(0, 100).map(kw => ({ keyword: kw.keyword, seed_keyword: kw.seed_keyword, reason: kw.reject_reason })),\\n  processing_time_ms: Date.now() - data.startTime\\n}}];"},"id":"12ffce99-aecf-429c-b773-544dc3eb4f05","name":"Response (No DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,208]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"2030e7d8-61cf-40b0-9d9b-35dd515f28f7","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,112]}]	{"Webhook Bulk":{"main":[[{"node":"Validate Input","type":"main","index":0}]]},"Validate Input":{"main":[[{"node":"IF Valid","type":"main","index":0}]]},"IF Valid":{"main":[[{"node":"DataForSEO Bulk","type":"main","index":0}],[{"node":"Respond Error","type":"main","index":0}]]},"DataForSEO Bulk":{"main":[[{"node":"Parse & Build Prompt","type":"main","index":0}]]},"Parse & Build Prompt":{"main":[[{"node":"Gemini Classify","type":"main","index":0}]]},"Gemini Classify":{"main":[[{"node":"Parse & Build Filter","type":"main","index":0}]]},"Parse & Build Filter":{"main":[[{"node":"Gemini Filter","type":"main","index":0}]]},"Gemini Filter":{"main":[[{"node":"Parse Filter","type":"main","index":0}]]},"Parse Filter":{"main":[[{"node":"IF Save DB","type":"main","index":0}]]},"IF Save DB":{"main":[[{"node":"Prepare Insert","type":"main","index":0}],[{"node":"Response (No DB)","type":"main","index":0}]]},"Prepare Insert":{"main":[[{"node":"Save to DB","type":"main","index":0}]]},"Save to DB":{"main":[[{"node":"Response (DB)","type":"main","index":0}]]},"Response (DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]},"Response (No DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]}}	\N	f	\N
60a2a4bd-7f96-4784-b651-e8d5def6cc8e	adol4O3V4iGsGXpf	Fatih Berkay Baheci	2025-12-23 13:03:13.079+00	2025-12-23 13:03:13.079+00	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"71620525-a8e3-4f45-92eb-54f2882f7f0b","name":"Webhook Bulk","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1760,112],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"const body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\n\\nif (!Array.isArray(keywords) || keywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'keywords array required', errorCode: 400 }}];\\n}\\n\\nconst cleanKeywords = keywords.map(k => String(k).trim().toLowerCase()).filter(k => k.length >= 2).slice(0, 100);\\n\\nif (cleanKeywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'Min 1 valid keyword required', errorCode: 400 }}];\\n}\\n\\nconst locationCodes = { 'TR': 2792, 'US': 2840, 'GB': 2826, 'DE': 2276, 'FR': 2250 };\\n\\nreturn [{ json: { \\n  isValid: true, keywords: cleanKeywords, keywordCount: cleanKeywords.length,\\n  projectId: projectId ? parseInt(projectId) : null, clientId: clientId ? parseInt(clientId) : null,\\n  country, language, locationCode: locationCodes[country] || 2792, startTime: Date.now()\\n}}];"},"id":"a8b87264-6fe1-480f-886e-5f0e31520ac3","name":"Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1536,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"8227c7f9-3ace-4a5d-8bfe-6e56d597b359","name":"IF Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1328,112]},{"parameters":{"respondWith":"json","responseBody":"={ \\"success\\": false, \\"error\\": \\"{{ $json.error }}\\" }","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"bec5ec19-4c13-47cb-97b9-49faea701113","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-1104,304]},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\n  \\"keywords\\": {{ JSON.stringify($json.keywords) }},\\n  \\"location_code\\": {{ $json.locationCode }},\\n  \\"language_code\\": \\"{{ $json.language }}\\",\\n  \\"include_seed_keyword\\": true,\\n  \\"sort_by\\": \\"search_volume\\"\\n}]","options":{"timeout":120000}},"id":"84d23611-4826-4209-bac7-cae7d2df5b28","name":"DataForSEO Bulk","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1104,112],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Parse DataForSEO & Build Gemini Prompt\\nconst input = $('Validate Input').first().json;\\nconst seedKeywords = input.keywords || [];\\n\\nfunction normalize(str) {\\n  return str.toLowerCase().replace(//g,'i').replace(//g,'i').replace(//g,'s').replace(//g,'s')\\n    .replace(//g,'o').replace(//g,'o').replace(//g,'u').replace(//g,'u')\\n    .replace(//g,'c').replace(//g,'c').replace(//g,'g').replace(//g,'g')\\n    .replace(/[^a-z0-9\\\\s]/g,'').replace(/\\\\s+/g,' ').trim();\\n}\\n\\nlet allKeywords = [];\\ntry {\\n  const dfs = $input.first().json;\\n  if (dfs?.tasks?.[0]?.result) {\\n    allKeywords = dfs.tasks[0].result.map(kw => ({\\n      keyword: (kw.keyword || '').toLowerCase().trim(),\\n      search_volume: kw.search_volume || 0,\\n      cpc: kw.cpc || 0,\\n      competition: kw.competition || null\\n    })).filter(kw => kw.keyword && kw.keyword.length >= 2);\\n  }\\n} catch(e) {}\\n\\n// Dedupe\\nconst seen = new Map();\\nallKeywords.forEach(kw => {\\n  const key = normalize(kw.keyword);\\n  if (key.length >= 2 && !seen.has(key)) seen.set(key, kw);\\n});\\n\\n// Mark seeds\\nseedKeywords.forEach((seed, idx) => {\\n  const key = normalize(seed);\\n  if (!seen.has(key)) {\\n    seen.set(key, { keyword: seed.toLowerCase().trim(), search_volume: 0, cpc: 0, competition: null, is_seed: true, seed_index: idx });\\n  } else {\\n    const e = seen.get(key); e.is_seed = true; e.seed_index = idx;\\n  }\\n});\\n\\nconst unique = Array.from(seen.values());\\nconst forProcess = unique.slice(0, 2000);\\n\\n// Build prompt - TEK GEMINI CALL ile hem siniflandirma hem filtreleme\\nconst seedList = seedKeywords.map((s,i) => `${i+1}. ${s}`).join('\\\\n');\\nconst kwList = forProcess.map((kw,i) => `${i+1}|${kw.keyword}|${kw.search_volume}`).join('\\\\n');\\n\\nconst prompt = `Sen SEO uzmanisin. Keyword listesini analiz et.\\n\\nGOREV:\\n1. Her keyword'u en uygun SEED ile eslestir\\n2. Icerik uretmeye UYGUN mu degerlendir\\n\\nSEED'LER:\\n${seedList}\\n\\nKEYWORDS (no|keyword|volume):\\n${kwList}\\n\\nKURALLAR:\\n- Anlamsal iliski kur: laptop/notebook  bilgisayar, terlik/sandalet/bot  ayakkabi, krem/serum  cilt bakimi\\n- Markalar: Nike/Adidas  ayakkabi, Asus/HP/Lenovo  bilgisayar, Arcelik/Bosch  beyaz esya\\n- Alakasiz keyword  seed=0\\n- Spam/anlamsiz  reject\\n- Seed ile alakali COGU keyword ONAYLANMALI\\n\\nCIKTI FORMATI (HER SATIR):\\nno|seed_no|karar|intent\\n\\nkarar: approved veya rejected\\nintent: informational, commercial, transactional, navigational\\n\\nORNEK:\\n1|3|approved|commercial\\n2|1|approved|informational\\n3|0|rejected|spam\\n4|2|approved|transactional\\n\\nHER KEYWORD ICIN BIR SATIR YAZ. ATLAMADAN HEPSINI ISLE.`;\\n\\nreturn [{ json: {\\n  ...input,\\n  allKeywords: unique,\\n  forProcess: forProcess,\\n  prompt: prompt,\\n  stats: { total_seeds: seedKeywords.length, from_dataforseo: allKeywords.length, unique: unique.length, for_process: forProcess.length }\\n}}];"},"id":"4776bdf3-6f6e-46de-bec2-f2bcd027cee2","name":"Parse & Build Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[-880,112]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{ \\"parts\\": [{ \\"text\\": {{ JSON.stringify($json.prompt) }} }] }],\\n  \\"generationConfig\\": { \\"temperature\\": 0.1, \\"maxOutputTokens\\": 65536 }\\n}","options":{"timeout":300000}},"id":"861cec42-85fa-4564-89ad-41d34d4a6920","name":"Gemini Process","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-656,112],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Parse Gemini Response\\nconst prev = $('Parse & Build Prompt').first().json;\\nconst gemini = $input.first().json;\\nconst seedKeywords = prev.keywords || [];\\nconst forProcess = prev.forProcess || [];\\n\\nconst approved = [];\\nconst rejected = [];\\n\\n// Parse Gemini response\\ntry {\\n  const text = gemini?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  const lines = text.split('\\\\n').filter(l => l.trim());\\n  const processed = new Set();\\n  \\n  for (const line of lines) {\\n    // Format: no|seed_no|karar|intent\\n    const parts = line.split('|').map(p => p.trim());\\n    if (parts.length < 3) continue;\\n    \\n    const no = parseInt(parts[0]);\\n    if (isNaN(no) || no < 1 || no > forProcess.length) continue;\\n    if (processed.has(no)) continue;\\n    processed.add(no);\\n    \\n    const kw = forProcess[no - 1];\\n    const seedIdx = parseInt(parts[1]) - 1;\\n    const decision = (parts[2] || '').toLowerCase();\\n    const intent = parts[3] || 'informational';\\n    \\n    // Seed assignment\\n    let seedKw = null;\\n    if (seedIdx >= 0 && seedIdx < seedKeywords.length) {\\n      seedKw = seedKeywords[seedIdx];\\n    }\\n    \\n    if (decision === 'approved' && seedKw) {\\n      approved.push({\\n        keyword: kw.keyword,\\n        seed_keyword: seedKw,\\n        search_volume: kw.search_volume,\\n        cpc: kw.cpc,\\n        competition: kw.competition,\\n        intent: intent,\\n        priority: kw.search_volume >= 1000 ? 'high' : kw.search_volume >= 100 ? 'medium' : 'low',\\n        content_type: kw.is_seed ? 'pillar' : 'cluster',\\n        status: 'approved',\\n        is_seed: kw.is_seed || false\\n      });\\n    } else {\\n      rejected.push({\\n        keyword: kw.keyword,\\n        seed_keyword: seedKw,\\n        search_volume: kw.search_volume,\\n        status: 'rejected',\\n        reject_reason: decision === 'rejected' ? 'AI filtered' : 'Unrelated'\\n      });\\n    }\\n  }\\n  \\n  // Unprocessed keywords - seeds always approved, others rejected\\n  forProcess.forEach((kw, idx) => {\\n    if (!processed.has(idx + 1)) {\\n      if (kw.is_seed) {\\n        approved.push({\\n          keyword: kw.keyword,\\n          seed_keyword: seedKeywords[kw.seed_index],\\n          search_volume: kw.search_volume,\\n          cpc: kw.cpc,\\n          competition: kw.competition,\\n          intent: 'informational',\\n          priority: 'high',\\n          content_type: 'pillar',\\n          status: 'approved',\\n          is_seed: true\\n        });\\n      } else {\\n        rejected.push({\\n          keyword: kw.keyword,\\n          seed_keyword: null,\\n          search_volume: kw.search_volume,\\n          status: 'rejected',\\n          reject_reason: 'Not processed by AI'\\n        });\\n      }\\n    }\\n  });\\n  \\n} catch(e) {\\n  // On error, approve seeds only\\n  forProcess.forEach(kw => {\\n    if (kw.is_seed) {\\n      approved.push({\\n        keyword: kw.keyword,\\n        seed_keyword: seedKeywords[kw.seed_index],\\n        search_volume: kw.search_volume,\\n        intent: 'informational',\\n        priority: 'high',\\n        content_type: 'pillar',\\n        status: 'approved',\\n        is_seed: true\\n      });\\n    } else {\\n      rejected.push({\\n        keyword: kw.keyword,\\n        seed_keyword: null,\\n        search_volume: kw.search_volume,\\n        status: 'rejected',\\n        reject_reason: 'Parse error: ' + e.message\\n      });\\n    }\\n  });\\n}\\n\\n// Stats per seed\\nconst perSeed = {};\\nseedKeywords.forEach(s => {\\n  perSeed[s] = approved.filter(k => k.seed_keyword === s).length;\\n});\\n\\nreturn [{ json: {\\n  projectId: prev.projectId,\\n  clientId: prev.clientId,\\n  mainKeyword: prev.keywords[0],\\n  keywords: prev.keywords,\\n  stats: { ...prev.stats, approved: approved.length, rejected: rejected.length, per_seed: perSeed },\\n  approved_keywords: approved,\\n  rejected_keywords: rejected,\\n  startTime: prev.startTime\\n}}];"},"id":"b6cd1a05-8fe3-4de7-a28a-6ed383f8046f","name":"Parse Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"has-project","leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}],"combinator":"and"},"options":{}},"id":"2b3853e8-b33e-4904-b06e-ce0baeb299e9","name":"IF Save DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"jsCode":"const data = $input.first().json;\\nconst projectId = data.projectId;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\nconst all = [...approved, ...rejected];\\n\\nif (all.length === 0) return [{ json: { ...data, batchQuery: 'SELECT 1' }}];\\n\\nfunction esc(s) {\\n  if (s === null || s === undefined) return 'NULL';\\n  return \\"'\\" + String(s).replace(/\\\\\\\\/g,'\\\\\\\\\\\\\\\\').replace(/'/g,\\"''\\") + \\"'\\";\\n}\\n\\nconst vals = all.slice(0, 1000).map(kw => {\\n  return `(${projectId}, ${esc(kw.keyword)}, ${esc(kw.seed_keyword)}, 'related', ${kw.search_volume || 'NULL'}, ${kw.cpc || 'NULL'}, ${esc(kw.competition)}, ${esc(kw.intent)}, ${esc(kw.seed_keyword)}, ${esc(kw.priority)}, ${esc(kw.content_type)}, 'dataforseo', '${kw.status || 'pending'}', ${esc(kw.reject_reason)})`;\\n}).join(',\\\\n');\\n\\nconst query = `INSERT INTO keyword_results (project_id, keyword, seed_keyword, keyword_type, search_volume, cpc, competition, search_intent, keyword_cluster, content_priority, page_type, source, status, reject_reason) VALUES ${vals} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume), status=VALUES(status), seed_keyword=VALUES(seed_keyword)`;\\n\\nreturn [{ json: { ...data, batchQuery: query }}];"},"id":"8b84b76b-9fa8-46ad-9b90-49988aa5e809","name":"Prepare Insert","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,0]},{"parameters":{"operation":"executeQuery","query":"={{ $json.batchQuery }}","options":{}},"id":"8b3a40f5-1dea-4d47-9e1d-b78eb88d4b7b","name":"Save to DB","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const data = $('Prepare Insert').first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\n// Sort by seed, then volume\\nconst sorted = approved.sort((a,b) => {\\n  if (a.seed_keyword !== b.seed_keyword) return (a.seed_keyword||'').localeCompare(b.seed_keyword||'');\\n  return (b.search_volume||0) - (a.search_volume||0);\\n});\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi. ${approved.length} onaylandi, ${rejected.length} reddedildi.`,\\n  project_id: data.projectId,\\n  stats: data.stats,\\n  keywords: sorted.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    intent: kw.intent,\\n    priority: kw.priority,\\n    content_type: kw.content_type,\\n    status: kw.status\\n  })),\\n  rejected_keywords: rejected.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    reason: kw.reject_reason\\n  })),\\n  processing_time_ms: Date.now() - data.startTime\\n}}];"},"id":"8f6786ad-bfae-4aef-a108-f3752e836c38","name":"Response (DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"jsCode":"const data = $input.first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nconst sorted = approved.sort((a,b) => {\\n  if (a.seed_keyword !== b.seed_keyword) return (a.seed_keyword||'').localeCompare(b.seed_keyword||'');\\n  return (b.search_volume||0) - (a.search_volume||0);\\n});\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi (DB yok). ${approved.length} onaylandi, ${rejected.length} reddedildi.`,\\n  project_id: null,\\n  stats: data.stats,\\n  keywords: sorted.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    intent: kw.intent,\\n    priority: kw.priority,\\n    content_type: kw.content_type,\\n    status: kw.status\\n  })),\\n  rejected_keywords: rejected.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    reason: kw.reject_reason\\n  })),\\n  processing_time_ms: Date.now() - data.startTime\\n}}];"},"id":"bf906e39-d1fc-4bb0-ad8f-3ce36aa2821a","name":"Response (No DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,208]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"4a963511-6c99-44a5-95f1-ceb37281381e","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,112]}]	{"Webhook Bulk":{"main":[[{"node":"Validate Input","type":"main","index":0}]]},"Validate Input":{"main":[[{"node":"IF Valid","type":"main","index":0}]]},"IF Valid":{"main":[[{"node":"DataForSEO Bulk","type":"main","index":0}],[{"node":"Respond Error","type":"main","index":0}]]},"DataForSEO Bulk":{"main":[[{"node":"Parse & Build Prompt","type":"main","index":0}]]},"Parse & Build Prompt":{"main":[[{"node":"Gemini Process","type":"main","index":0}]]},"Gemini Process":{"main":[[{"node":"Parse Response","type":"main","index":0}]]},"Parse Response":{"main":[[{"node":"IF Save DB","type":"main","index":0}]]},"IF Save DB":{"main":[[{"node":"Prepare Insert","type":"main","index":0}],[{"node":"Response (No DB)","type":"main","index":0}]]},"Prepare Insert":{"main":[[{"node":"Save to DB","type":"main","index":0}]]},"Save to DB":{"main":[[{"node":"Response (DB)","type":"main","index":0}]]},"Response (DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]},"Response (No DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]}}	\N	f	\N
0d779cb5-a734-4dc0-8202-f21498dedbb4	adol4O3V4iGsGXpf	Fatih Berkay Baheci	2025-12-23 13:12:48.039+00	2025-12-23 13:12:48.039+00	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"bf0085dd-64ed-4626-94a5-38ae3eb0008d","name":"Webhook Bulk","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1760,112],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"const body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\n\\nif (!Array.isArray(keywords) || keywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'keywords array required', errorCode: 400 }}];\\n}\\n\\nconst cleanKeywords = keywords.map(k => String(k).trim().toLowerCase()).filter(k => k.length >= 2).slice(0, 100);\\n\\nif (cleanKeywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'Min 1 valid keyword required', errorCode: 400 }}];\\n}\\n\\nconst locationCodes = { 'TR': 2792, 'US': 2840, 'GB': 2826, 'DE': 2276, 'FR': 2250 };\\n\\nreturn [{ json: { \\n  isValid: true, keywords: cleanKeywords, keywordCount: cleanKeywords.length,\\n  projectId: projectId ? parseInt(projectId) : null, clientId: clientId ? parseInt(clientId) : null,\\n  country, language, locationCode: locationCodes[country] || 2792, startTime: Date.now()\\n}}];"},"id":"55c0b8bd-4e23-47ee-a7d6-83a14875e627","name":"Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1536,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"d7905ec9-1e5e-4926-b6fa-6e1e2ed8d8fa","name":"IF Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1328,112]},{"parameters":{"respondWith":"json","responseBody":"={ \\"success\\": false, \\"error\\": \\"{{ $json.error }}\\" }","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"f72251ff-25d7-4c4b-bc1d-55c3e6158b86","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-1104,304]},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\n  \\"keywords\\": {{ JSON.stringify($json.keywords) }},\\n  \\"location_code\\": {{ $json.locationCode }},\\n  \\"language_code\\": \\"{{ $json.language }}\\",\\n  \\"include_seed_keyword\\": true,\\n  \\"sort_by\\": \\"search_volume\\"\\n}]","options":{"timeout":120000}},"id":"2ac4bf93-e66c-4e04-9d54-34e741ad9343","name":"DataForSEO Bulk","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1104,112],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Parse DataForSEO & Build Gemini Prompt for Classification\\nconst input = $('Validate Input').first().json;\\nconst seedKeywords = input.keywords || [];\\n\\nfunction normalize(str) {\\n  return str.toLowerCase().replace(//g,'i').replace(//g,'i').replace(//g,'s').replace(//g,'s')\\n    .replace(//g,'o').replace(//g,'o').replace(//g,'u').replace(//g,'u')\\n    .replace(//g,'c').replace(//g,'c').replace(//g,'g').replace(//g,'g')\\n    .replace(/[^a-z0-9\\\\s]/g,'').replace(/\\\\s+/g,' ').trim();\\n}\\n\\nlet allKeywords = [];\\ntry {\\n  const dfs = $input.first().json;\\n  if (dfs?.tasks?.[0]?.result) {\\n    allKeywords = dfs.tasks[0].result.map(kw => ({\\n      keyword: (kw.keyword || '').toLowerCase().trim(),\\n      search_volume: kw.search_volume || 0,\\n      cpc: kw.cpc || 0,\\n      competition: kw.competition || null\\n    })).filter(kw => kw.keyword && kw.keyword.length >= 2);\\n  }\\n} catch(e) {}\\n\\n// Dedupe\\nconst seen = new Map();\\nallKeywords.forEach(kw => {\\n  const key = normalize(kw.keyword);\\n  if (key.length >= 2 && !seen.has(key)) seen.set(key, kw);\\n});\\n\\nconst unique = Array.from(seen.values());\\nconst forProcess = unique.slice(0, 2000);\\n\\n// Build classification prompt\\nconst seedList = seedKeywords.map((s,i) => `${i+1}. ${s}`).join('\\\\n');\\nconst kwList = forProcess.map((kw,i) => `${i+1}|${kw.keyword}`).join('\\\\n');\\n\\nconst prompt = `Her keyword'u en uygun SEED ile eslestir.\\n\\nSEED'LER:\\n${seedList}\\n\\nKEYWORDS:\\n${kwList}\\n\\nKURALLAR:\\n- Anlamsal iliski kur (laptop=bilgisayar, terlik/sandalet/bot=ayakkabi, krem/serum=cilt bakimi)\\n- Markalar kategoriye gore (Nike/Adidas=ayakkabi, Asus/HP=bilgisayar)\\n- Alakasiz=0\\n\\nCIKTI: Her satir sadece no|seed_no\\nOrnek:\\n1|2\\n2|3\\n3|0\\n\\nSADECE NUMARALAR, ACIKLAMA YOK.`;\\n\\nreturn [{ json: {\\n  ...input,\\n  allKeywords: forProcess,\\n  prompt: prompt,\\n  stats: { total_seeds: seedKeywords.length, from_dataforseo: allKeywords.length, unique: unique.length }\\n}}];"},"id":"9161e0d4-e1a7-4494-935e-24491283df80","name":"Parse & Build Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[-880,112]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{ \\"parts\\": [{ \\"text\\": {{ JSON.stringify($json.prompt) }} }] }],\\n  \\"generationConfig\\": { \\"temperature\\": 0.1, \\"maxOutputTokens\\": 65536 }\\n}","options":{"timeout":300000}},"id":"829a1067-ee9f-45f7-9532-223a0d71c2b4","name":"Gemini Classify","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-656,112],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Parse Classification & Apply Limits (max 35 per seed)\\nconst MAX_PER_SEED = 35;\\n\\nconst prev = $('Parse & Build Prompt').first().json;\\nconst gemini = $input.first().json;\\nconst seedKeywords = prev.keywords || [];\\nconst allKeywords = prev.allKeywords || [];\\n\\n// Parse Gemini response - assign each keyword to a seed\\nconst keywordToSeed = new Map();\\ntry {\\n  const text = gemini?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  const lines = text.split('\\\\n').filter(l => l.trim());\\n  \\n  for (const line of lines) {\\n    const cleanLine = line.replace(/^\\\\|\\\\s*/, '').replace(/\\\\s*\\\\|\\\\s*$/, '').trim();\\n    const parts = cleanLine.split('|').map(p => p.trim());\\n    if (parts.length < 2) continue;\\n    \\n    const kwIdx = parseInt(parts[0]) - 1;\\n    const seedIdx = parseInt(parts[1]) - 1;\\n    \\n    if (kwIdx >= 0 && kwIdx < allKeywords.length) {\\n      if (seedIdx >= 0 && seedIdx < seedKeywords.length) {\\n        keywordToSeed.set(kwIdx, seedKeywords[seedIdx]);\\n      } else {\\n        keywordToSeed.set(kwIdx, null); // Unrelated\\n      }\\n    }\\n  }\\n} catch(e) {}\\n\\n// Group keywords by seed\\nconst bySeed = {};\\nseedKeywords.forEach(s => { bySeed[s] = []; });\\nbySeed['_unrelated'] = [];\\n\\nallKeywords.forEach((kw, idx) => {\\n  const seed = keywordToSeed.get(idx);\\n  const enriched = { ...kw, seed_keyword: seed };\\n  \\n  if (seed && bySeed[seed]) {\\n    bySeed[seed].push(enriched);\\n  } else {\\n    bySeed['_unrelated'].push(enriched);\\n  }\\n});\\n\\n// Sort each seed's keywords by volume and apply limit\\nconst approved = [];\\nconst rejected = [];\\n\\nseedKeywords.forEach(seed => {\\n  const kwList = bySeed[seed].sort((a,b) => (b.search_volume||0) - (a.search_volume||0));\\n  \\n  // Top MAX_PER_SEED go to approved\\n  kwList.slice(0, MAX_PER_SEED).forEach(kw => {\\n    approved.push({\\n      ...kw,\\n      status: 'approved',\\n      intent: 'informational',\\n      priority: kw.search_volume >= 1000 ? 'high' : kw.search_volume >= 100 ? 'medium' : 'low',\\n      content_type: 'cluster'\\n    });\\n  });\\n  \\n  // Rest go to rejected (diger kelimeler)\\n  kwList.slice(MAX_PER_SEED).forEach(kw => {\\n    rejected.push({\\n      ...kw,\\n      status: 'rejected',\\n      reject_reason: 'Limit exceeded'\\n    });\\n  });\\n});\\n\\n// Unrelated keywords go to rejected\\nbySeed['_unrelated'].forEach(kw => {\\n  rejected.push({\\n    ...kw,\\n    status: 'rejected',\\n    reject_reason: 'Unrelated'\\n  });\\n});\\n\\n// Stats per seed\\nconst perSeed = {};\\nseedKeywords.forEach(s => {\\n  perSeed[s] = { approved: approved.filter(k => k.seed_keyword === s).length, total: bySeed[s].length };\\n});\\n\\nreturn [{ json: {\\n  projectId: prev.projectId,\\n  clientId: prev.clientId,\\n  mainKeyword: prev.keywords[0],\\n  keywords: prev.keywords,\\n  stats: { ...prev.stats, approved: approved.length, rejected: rejected.length, per_seed: perSeed },\\n  approved_keywords: approved,\\n  rejected_keywords: rejected,\\n  startTime: prev.startTime\\n}}];"},"id":"e67053c1-9441-4aaa-ac2e-89dc9fb0873a","name":"Parse & Apply Limits","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"has-project","leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}],"combinator":"and"},"options":{}},"id":"20d6cb3b-49ac-45dd-8751-7b84838068d2","name":"IF Save DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"jsCode":"const data = $input.first().json;\\nconst projectId = data.projectId;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\nconst all = [...approved, ...rejected];\\n\\nif (all.length === 0) return [{ json: { ...data, batchQuery: 'SELECT 1' }}];\\n\\nfunction esc(s) {\\n  if (s === null || s === undefined) return 'NULL';\\n  return \\"'\\" + String(s).replace(/\\\\\\\\/g,'\\\\\\\\\\\\\\\\').replace(/'/g,\\"''\\") + \\"'\\";\\n}\\n\\nconst vals = all.slice(0, 1000).map(kw => {\\n  return `(${projectId}, ${esc(kw.keyword)}, ${esc(kw.seed_keyword)}, 'related', ${kw.search_volume || 'NULL'}, ${kw.cpc || 'NULL'}, ${esc(kw.competition)}, ${esc(kw.intent)}, ${esc(kw.seed_keyword)}, ${esc(kw.priority)}, ${esc(kw.content_type)}, 'dataforseo', '${kw.status || 'pending'}', ${esc(kw.reject_reason)})`;\\n}).join(',\\\\n');\\n\\nconst query = `INSERT INTO keyword_results (project_id, keyword, seed_keyword, keyword_type, search_volume, cpc, competition, search_intent, keyword_cluster, content_priority, page_type, source, status, reject_reason) VALUES ${vals} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume), status=VALUES(status), seed_keyword=VALUES(seed_keyword)`;\\n\\nreturn [{ json: { ...data, batchQuery: query }}];"},"id":"37881faf-ac16-49c1-b127-2b1855935673","name":"Prepare Insert","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,0]},{"parameters":{"operation":"executeQuery","query":"={{ $json.batchQuery }}","options":{}},"id":"3b245393-e631-4ad5-842a-6d5a6c19b4d4","name":"Save to DB","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const data = $('Prepare Insert').first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi. ${approved.length} onaylandi, ${rejected.length} diger kelimeler.`,\\n  project_id: data.projectId,\\n  stats: data.stats,\\n  keywords: approved.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    intent: kw.intent,\\n    priority: kw.priority,\\n    content_type: kw.content_type,\\n    status: kw.status\\n  })),\\n  rejected_keywords: rejected.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    reason: kw.reject_reason\\n  })),\\n  processing_time_ms: Date.now() - data.startTime\\n}}];"},"id":"e8f62e8a-9de5-4154-86df-613c29762cd2","name":"Response (DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"jsCode":"const data = $input.first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi (DB yok). ${approved.length} onaylandi, ${rejected.length} diger kelimeler.`,\\n  project_id: null,\\n  stats: data.stats,\\n  keywords: approved.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    intent: kw.intent,\\n    priority: kw.priority,\\n    content_type: kw.content_type,\\n    status: kw.status\\n  })),\\n  rejected_keywords: rejected.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    reason: kw.reject_reason\\n  })),\\n  processing_time_ms: Date.now() - data.startTime\\n}}];"},"id":"987e0e5a-cd6f-4252-a06a-00e3d935a3ed","name":"Response (No DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,208]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"e6b31ec9-15d4-4bb9-81cf-813b357e738d","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,112]}]	{"Webhook Bulk":{"main":[[{"node":"Validate Input","type":"main","index":0}]]},"Validate Input":{"main":[[{"node":"IF Valid","type":"main","index":0}]]},"IF Valid":{"main":[[{"node":"DataForSEO Bulk","type":"main","index":0}],[{"node":"Respond Error","type":"main","index":0}]]},"DataForSEO Bulk":{"main":[[{"node":"Parse & Build Prompt","type":"main","index":0}]]},"Parse & Build Prompt":{"main":[[{"node":"Gemini Classify","type":"main","index":0}]]},"Gemini Classify":{"main":[[{"node":"Parse & Apply Limits","type":"main","index":0}]]},"Parse & Apply Limits":{"main":[[{"node":"IF Save DB","type":"main","index":0}]]},"IF Save DB":{"main":[[{"node":"Prepare Insert","type":"main","index":0}],[{"node":"Response (No DB)","type":"main","index":0}]]},"Prepare Insert":{"main":[[{"node":"Save to DB","type":"main","index":0}]]},"Save to DB":{"main":[[{"node":"Response (DB)","type":"main","index":0}]]},"Response (DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]},"Response (No DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]}}	\N	f	\N
6b5f0566-7eb7-4c41-a003-5b6234834530	adol4O3V4iGsGXpf	Fatih Berkay Baheci	2025-12-23 13:16:41.417+00	2025-12-23 13:16:41.417+00	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"86026c64-0098-49e8-873e-645ce2ad21f3","name":"Webhook Bulk","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1760,112],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"const body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\n\\nif (!Array.isArray(keywords) || keywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'keywords array required', errorCode: 400 }}];\\n}\\n\\nconst cleanKeywords = keywords.map(k => String(k).trim().toLowerCase()).filter(k => k.length >= 2).slice(0, 100);\\n\\nif (cleanKeywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'Min 1 valid keyword required', errorCode: 400 }}];\\n}\\n\\nconst locationCodes = { 'TR': 2792, 'US': 2840, 'GB': 2826, 'DE': 2276, 'FR': 2250 };\\n\\nreturn [{ json: { \\n  isValid: true, keywords: cleanKeywords, keywordCount: cleanKeywords.length,\\n  projectId: projectId ? parseInt(projectId) : null, clientId: clientId ? parseInt(clientId) : null,\\n  country, language, locationCode: locationCodes[country] || 2792, startTime: Date.now()\\n}}];"},"id":"a20640d8-c1a7-443c-9fde-514d6132f412","name":"Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1536,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"e6c1748b-0fee-4607-84a9-c7c9bfb86a9e","name":"IF Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1328,112]},{"parameters":{"respondWith":"json","responseBody":"={ \\"success\\": false, \\"error\\": \\"{{ $json.error }}\\" }","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"e03f3d24-1806-48bf-831c-a3e661326a9b","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-1104,304]},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\n  \\"keywords\\": {{ JSON.stringify($json.keywords) }},\\n  \\"location_code\\": {{ $json.locationCode }},\\n  \\"language_code\\": \\"{{ $json.language }}\\",\\n  \\"include_seed_keyword\\": true,\\n  \\"sort_by\\": \\"search_volume\\"\\n}]","options":{"timeout":120000}},"id":"e0da4dc4-a6a9-4664-8624-89f9ffb6252d","name":"DataForSEO Bulk","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1104,112],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Parse DataForSEO & Build Gemini Prompt for Classification\\nconst input = $('Validate Input').first().json;\\nconst seedKeywords = input.keywords || [];\\n\\nfunction normalize(str) {\\n  return str.toLowerCase().replace(//g,'i').replace(//g,'i').replace(//g,'s').replace(//g,'s')\\n    .replace(//g,'o').replace(//g,'o').replace(//g,'u').replace(//g,'u')\\n    .replace(//g,'c').replace(//g,'c').replace(//g,'g').replace(//g,'g')\\n    .replace(/[^a-z0-9\\\\s]/g,'').replace(/\\\\s+/g,' ').trim();\\n}\\n\\nlet allKeywords = [];\\ntry {\\n  const dfs = $input.first().json;\\n  if (dfs?.tasks?.[0]?.result) {\\n    allKeywords = dfs.tasks[0].result.map(kw => ({\\n      keyword: (kw.keyword || '').toLowerCase().trim(),\\n      search_volume: kw.search_volume || 0,\\n      cpc: kw.cpc || 0,\\n      competition: kw.competition || null\\n    })).filter(kw => kw.keyword && kw.keyword.length >= 2);\\n  }\\n} catch(e) {}\\n\\n// Dedupe\\nconst seen = new Map();\\nallKeywords.forEach(kw => {\\n  const key = normalize(kw.keyword);\\n  if (key.length >= 2 && !seen.has(key)) seen.set(key, kw);\\n});\\n\\nconst unique = Array.from(seen.values());\\nconst forProcess = unique.slice(0, 2000);\\n\\n// Build classification prompt\\nconst seedList = seedKeywords.map((s,i) => `${i+1}. ${s}`).join('\\\\n');\\nconst kwList = forProcess.map((kw,i) => `${i+1}|${kw.keyword}`).join('\\\\n');\\n\\nconst prompt = `Her keyword'u en uygun SEED ile eslestir.\\n\\nSEED'LER:\\n${seedList}\\n\\nKEYWORDS:\\n${kwList}\\n\\nKURALLAR:\\n- Anlamsal iliski kur (laptop=bilgisayar, terlik/sandalet/bot=ayakkabi, krem/serum=cilt bakimi)\\n- Markalar kategoriye gore (Nike/Adidas=ayakkabi, Asus/HP=bilgisayar)\\n- Alakasiz=0\\n\\nCIKTI: Her satir sadece no|seed_no\\nOrnek:\\n1|2\\n2|3\\n3|0\\n\\nSADECE NUMARALAR, ACIKLAMA YOK.`;\\n\\nreturn [{ json: {\\n  ...input,\\n  allKeywords: forProcess,\\n  prompt: prompt,\\n  stats: { total_seeds: seedKeywords.length, from_dataforseo: allKeywords.length, unique: unique.length }\\n}}];"},"id":"afea6bcf-97cf-44a1-a02d-ed73f1d35cf7","name":"Parse & Build Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[-880,112]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{ \\"parts\\": [{ \\"text\\": {{ JSON.stringify($json.prompt) }} }] }],\\n  \\"generationConfig\\": { \\"temperature\\": 0.1, \\"maxOutputTokens\\": 65536 }\\n}","options":{"timeout":300000}},"id":"5a06b767-00b8-41d5-a21f-dfc67f9accac","name":"Gemini Classify","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-656,112],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Parse Classification & Apply Limits (max 35 per seed)\\nconst MAX_PER_SEED = 35;\\n\\nconst prev = $('Parse & Build Prompt').first().json;\\nconst gemini = $input.first().json;\\nconst seedKeywords = prev.keywords || [];\\nconst allKeywords = prev.allKeywords || [];\\n\\n// Parse Gemini response - assign each keyword to a seed\\nconst keywordToSeed = new Map();\\ntry {\\n  const text = gemini?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  const lines = text.split('\\\\n').filter(l => l.trim());\\n  \\n  for (const line of lines) {\\n    const cleanLine = line.replace(/^\\\\|\\\\s*/, '').replace(/\\\\s*\\\\|\\\\s*$/, '').trim();\\n    const parts = cleanLine.split('|').map(p => p.trim());\\n    if (parts.length < 2) continue;\\n    \\n    const kwIdx = parseInt(parts[0]) - 1;\\n    const seedIdx = parseInt(parts[1]) - 1;\\n    \\n    if (kwIdx >= 0 && kwIdx < allKeywords.length) {\\n      if (seedIdx >= 0 && seedIdx < seedKeywords.length) {\\n        keywordToSeed.set(kwIdx, seedKeywords[seedIdx]);\\n      } else {\\n        keywordToSeed.set(kwIdx, null); // Unrelated\\n      }\\n    }\\n  }\\n} catch(e) {}\\n\\n// Group keywords by seed\\nconst bySeed = {};\\nseedKeywords.forEach(s => { bySeed[s] = []; });\\nbySeed['_unrelated'] = [];\\n\\nallKeywords.forEach((kw, idx) => {\\n  const seed = keywordToSeed.get(idx);\\n  const enriched = { ...kw, seed_keyword: seed };\\n  \\n  if (seed && bySeed[seed]) {\\n    bySeed[seed].push(enriched);\\n  } else {\\n    bySeed['_unrelated'].push(enriched);\\n  }\\n});\\n\\n// Sort each seed's keywords by volume and apply limit\\nconst approved = [];\\nconst rejected = [];\\n\\nseedKeywords.forEach(seed => {\\n  const kwList = bySeed[seed].sort((a,b) => (b.search_volume||0) - (a.search_volume||0));\\n  \\n  // Top MAX_PER_SEED go to approved\\n  kwList.slice(0, MAX_PER_SEED).forEach(kw => {\\n    approved.push({\\n      ...kw,\\n      status: 'approved',\\n      intent: 'informational',\\n      priority: kw.search_volume >= 1000 ? 'high' : kw.search_volume >= 100 ? 'medium' : 'low',\\n      content_type: 'cluster'\\n    });\\n  });\\n  \\n  // Rest go to rejected (diger kelimeler)\\n  kwList.slice(MAX_PER_SEED).forEach(kw => {\\n    rejected.push({\\n      ...kw,\\n      status: 'rejected',\\n      reject_reason: 'Limit exceeded'\\n    });\\n  });\\n});\\n\\n// Unrelated keywords go to rejected\\nbySeed['_unrelated'].forEach(kw => {\\n  rejected.push({\\n    ...kw,\\n    status: 'rejected',\\n    reject_reason: 'Unrelated'\\n  });\\n});\\n\\n// Stats per seed\\nconst perSeed = {};\\nseedKeywords.forEach(s => {\\n  perSeed[s] = { approved: approved.filter(k => k.seed_keyword === s).length, total: bySeed[s].length };\\n});\\n\\nreturn [{ json: {\\n  projectId: prev.projectId,\\n  clientId: prev.clientId,\\n  mainKeyword: prev.keywords[0],\\n  keywords: prev.keywords,\\n  stats: { ...prev.stats, approved: approved.length, rejected: rejected.length, per_seed: perSeed },\\n  approved_keywords: approved,\\n  rejected_keywords: rejected,\\n  startTime: prev.startTime\\n}}];"},"id":"92da1894-c8d2-4d0b-811a-a4fbe25866d0","name":"Parse & Apply Limits","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"has-project","leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}],"combinator":"and"},"options":{}},"id":"81648319-9342-4bc6-a08b-07c96505f100","name":"IF Save DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"jsCode":"const data = $input.first().json;\\nconst projectId = data.projectId;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\nconst all = [...approved, ...rejected];\\n\\nif (all.length === 0) return [{ json: { ...data, batchQuery: 'SELECT 1' }}];\\n\\nfunction esc(s) {\\n  if (s === null || s === undefined) return 'NULL';\\n  return \\"'\\" + String(s).replace(/\\\\\\\\/g,'\\\\\\\\\\\\\\\\').replace(/'/g,\\"''\\") + \\"'\\";\\n}\\n\\nconst vals = all.slice(0, 1000).map(kw => {\\n  return `(${projectId}, ${esc(kw.keyword)}, ${esc(kw.seed_keyword)}, 'related', ${kw.search_volume || 'NULL'}, ${kw.cpc || 'NULL'}, ${esc(kw.competition)}, ${esc(kw.intent)}, ${esc(kw.seed_keyword)}, ${esc(kw.priority)}, ${esc(kw.content_type)}, 'dataforseo', '${kw.status || 'pending'}', ${esc(kw.reject_reason)})`;\\n}).join(',\\\\n');\\n\\nconst query = `INSERT INTO keyword_results (project_id, keyword, seed_keyword, keyword_type, search_volume, cpc, competition, search_intent, keyword_cluster, content_priority, page_type, source, status, reject_reason) VALUES ${vals} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume), status=VALUES(status), seed_keyword=VALUES(seed_keyword)`;\\n\\nreturn [{ json: { ...data, batchQuery: query }}];"},"id":"99212952-4b4f-44f8-8ddc-11732149a15f","name":"Prepare Insert","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,0]},{"parameters":{"operation":"executeQuery","query":"={{ $json.batchQuery }}","options":{}},"id":"a6d57656-8f18-44d3-b8cf-cbd9cc766feb","name":"Save to DB","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const data = $('Prepare Insert').first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi. ${approved.length} onaylandi, ${rejected.length} diger kelimeler.`,\\n  project_id: data.projectId,\\n  stats: data.stats,\\n  keywords: approved.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    intent: kw.intent,\\n    priority: kw.priority,\\n    content_type: kw.content_type,\\n    status: kw.status\\n  })),\\n  rejected_keywords: rejected.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    reason: kw.reject_reason\\n  })),\\n  processing_time_ms: Date.now() - data.startTime\\n}}];"},"id":"9fc290ad-6a88-49ac-b973-2ee29517349c","name":"Response (DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"jsCode":"const data = $input.first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi (DB yok). ${approved.length} onaylandi, ${rejected.length} diger kelimeler.`,\\n  project_id: null,\\n  stats: data.stats,\\n  keywords: approved.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    intent: kw.intent,\\n    priority: kw.priority,\\n    content_type: kw.content_type,\\n    status: kw.status\\n  })),\\n  rejected_keywords: rejected.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    reason: kw.reject_reason\\n  })),\\n  processing_time_ms: Date.now() - data.startTime\\n}}];"},"id":"cc32cad0-e1a4-4b64-86d5-098f6a4496fb","name":"Response (No DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,208]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"c0e8271d-ba6d-4298-baa3-dbe97d98014d","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,112]}]	{"Webhook Bulk":{"main":[[{"node":"Validate Input","type":"main","index":0}]]},"Validate Input":{"main":[[{"node":"IF Valid","type":"main","index":0}]]},"IF Valid":{"main":[[{"node":"DataForSEO Bulk","type":"main","index":0}],[{"node":"Respond Error","type":"main","index":0}]]},"DataForSEO Bulk":{"main":[[{"node":"Parse & Build Prompt","type":"main","index":0}]]},"Parse & Build Prompt":{"main":[[{"node":"Gemini Classify","type":"main","index":0}]]},"Gemini Classify":{"main":[[{"node":"Parse & Apply Limits","type":"main","index":0}]]},"Parse & Apply Limits":{"main":[[{"node":"IF Save DB","type":"main","index":0}]]},"IF Save DB":{"main":[[{"node":"Prepare Insert","type":"main","index":0}],[{"node":"Response (No DB)","type":"main","index":0}]]},"Prepare Insert":{"main":[[{"node":"Save to DB","type":"main","index":0}]]},"Save to DB":{"main":[[{"node":"Response (DB)","type":"main","index":0}]]},"Response (DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]},"Response (No DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]}}	\N	f	\N
6823861f-0ec9-40bc-87ab-da92ca440beb	adol4O3V4iGsGXpf	Fatih Berkay Baheci	2025-12-23 13:27:38.333+00	2025-12-23 13:27:38.333+00	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"12cb40fd-fe5a-4a5d-95e3-548ba3acabd3","name":"Webhook Bulk","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1760,112],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"const body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\n\\nif (!Array.isArray(keywords) || keywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'keywords array required', errorCode: 400 }}];\\n}\\n\\nconst cleanKeywords = keywords.map(k => String(k).trim().toLowerCase()).filter(k => k.length >= 2).slice(0, 100);\\n\\nif (cleanKeywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'Min 1 valid keyword required', errorCode: 400 }}];\\n}\\n\\nconst locationCodes = { 'TR': 2792, 'US': 2840, 'GB': 2826, 'DE': 2276, 'FR': 2250 };\\n\\nreturn [{ json: { \\n  isValid: true, keywords: cleanKeywords, keywordCount: cleanKeywords.length,\\n  projectId: projectId ? parseInt(projectId) : null, clientId: clientId ? parseInt(clientId) : null,\\n  country, language, locationCode: locationCodes[country] || 2792, startTime: Date.now()\\n}}];"},"id":"7bf6072c-5b41-44ca-ad5a-3a498c5832e3","name":"Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1536,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"1194c171-c7ee-4eb3-b99f-88b662dc525f","name":"IF Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1328,112]},{"parameters":{"respondWith":"json","responseBody":"={ \\"success\\": false, \\"error\\": \\"{{ $json.error }}\\" }","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"fefa4ffb-9efa-433b-a4c3-41a584ecc763","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-1104,304]},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\n  \\"keywords\\": {{ JSON.stringify($json.keywords) }},\\n  \\"location_code\\": {{ $json.locationCode }},\\n  \\"language_code\\": \\"{{ $json.language }}\\",\\n  \\"include_seed_keyword\\": true,\\n  \\"sort_by\\": \\"search_volume\\"\\n}]","options":{"timeout":120000}},"id":"fdd4ef21-df58-4f08-bf5d-4571af179a75","name":"DataForSEO Bulk","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1104,112],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Parse DataForSEO & Build Advanced Prompt\\nconst input = $('Validate Input').first().json;\\nconst seedKeywords = input.keywords || [];\\n\\nfunction normalize(str) {\\n  return str.toLowerCase().replace(//g,'i').replace(//g,'i').replace(//g,'s').replace(//g,'s')\\n    .replace(//g,'o').replace(//g,'o').replace(//g,'u').replace(//g,'u')\\n    .replace(//g,'c').replace(//g,'c').replace(//g,'g').replace(//g,'g')\\n    .replace(/[^a-z0-9\\\\s]/g,'').replace(/\\\\s+/g,' ').trim();\\n}\\n\\nlet allKeywords = [];\\ntry {\\n  const dfs = $input.first().json;\\n  if (dfs?.tasks?.[0]?.result) {\\n    allKeywords = dfs.tasks[0].result.map(kw => ({\\n      keyword: (kw.keyword || '').toLowerCase().trim(),\\n      search_volume: kw.search_volume || 0,\\n      cpc: kw.cpc || 0,\\n      competition: kw.competition || null\\n    })).filter(kw => kw.keyword && kw.keyword.length >= 2);\\n  }\\n} catch(e) {}\\n\\n// Dedupe by normalized form\\nconst seen = new Map();\\nallKeywords.forEach(kw => {\\n  const key = normalize(kw.keyword);\\n  if (key.length >= 2 && !seen.has(key)) seen.set(key, kw);\\n});\\n\\nconst unique = Array.from(seen.values());\\nconst forProcess = unique.slice(0, 2000);\\n\\n// Build advanced prompt\\nconst seedList = seedKeywords.map((s,i) => `${i+1}. ${s}`).join('\\\\n');\\nconst kwList = forProcess.map((kw,i) => `${i+1}|${kw.keyword}|${kw.search_volume}`).join('\\\\n');\\n\\nconst prompt = `Sen uzman bir SEO ve icerik stratejistisin. Asagidaki keyword listesini analiz et.\\n\\n## GOREV\\nHer SEED icin:\\n1. ICERIK URETMEYE EN UYGUN keywordleri sec (MAX 35, daha az olabilir)\\n2. Geri kalanlari DIGER KELIMELER olarak grupla ve BENZER OLANLARI BIRLESTIR\\n\\n## SEED'LER\\n${seedList}\\n\\n## KEYWORDS (no|keyword|volume)\\n${kwList}\\n\\n## ANA SONUC KRITERLERI (content_worthy)\\n- Bagimsiz bir icerik/makale konusu olabilir mi?\\n- Arama amaci net mi? (bilgi/satin alma/karsilastirma)\\n- Yeterli arama hacmi var mi?\\n- Kullanici bu kelimeyle ne ariyor belli mi?\\n- REDDET: Cok genel, cok spesifik marka+model, anlamsiz kombinasyonlar, spam\\n\\n## DIGER KELIMELER KRITERLERI (others)\\n- Ana sonuca girmeyen TUM keywordler\\n- BENZER OLANLARI BIRLESTIR: \\"fiyat\\"/\\"fiyati\\"/\\"fiyatlari\\"  sadece en yuksek hacimli olan\\n- \\"ayakkabi\\"/\\"ayakabilar\\"  sadece biri\\n- Ek formatlar kaldir: \\"2024\\", \\"2025\\", \\"en iyi\\", \\"en ucuz\\" varyasyonlari tek keyword\\n\\n## CIKTI FORMATI\\nHer SEED icin ayri blok:\\n\\n[SEED_NO:seed_adi]\\nCONTENT:no1,no2,no3...\\nOTHERS:no1,no2,no3...\\n\\nOrnek:\\n[1:telefon]\\nCONTENT:5,12,23,45,67\\nOTHERS:2,8,15,22,31,44\\n\\n[2:laptop]\\nCONTENT:3,18,29\\nOTHERS:7,14,25,33\\n\\nKURALLAR:\\n- Her keyword SADECE 1 seed'e ait olabilir\\n- Alakasiz keywordler hicbir seed'e eklenmez\\n- CONTENT maksimum 35 keyword (daha az olabilir - kalite onemli)\\n- OTHERS'da benzer keywordlerden sadece 1 tane (en yuksek volume)\\n- Sadece numaralar, aciklama yok`;\\n\\nreturn [{ json: {\\n  ...input,\\n  allKeywords: forProcess,\\n  prompt: prompt,\\n  stats: { total_seeds: seedKeywords.length, from_dataforseo: allKeywords.length, unique: unique.length, for_process: forProcess.length }\\n}}];"},"id":"109a42a5-729e-4e5d-8065-39da0cf482a5","name":"Parse & Build Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[-880,112]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{ \\"parts\\": [{ \\"text\\": {{ JSON.stringify($json.prompt) }} }] }],\\n  \\"generationConfig\\": { \\"temperature\\": 0.2, \\"maxOutputTokens\\": 65536 }\\n}","options":{"timeout":300000}},"id":"d954dabe-1a37-403f-8d22-0e3755c81af6","name":"Gemini Analyze","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-656,112],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Parse Gemini Response\\nconst prev = $('Parse & Build Prompt').first().json;\\nconst gemini = $input.first().json;\\nconst seedKeywords = prev.keywords || [];\\nconst allKeywords = prev.allKeywords || [];\\n\\nconst approved = [];\\nconst rejected = [];\\n\\ntry {\\n  const text = gemini?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  \\n  // Parse each seed block\\n  const seedBlocks = text.split(/\\\\[\\\\d+:/).slice(1); // Split by [N:seed_name]\\n  \\n  seedBlocks.forEach((block, blockIdx) => {\\n    // Extract seed name from block start\\n    const seedMatch = block.match(/^([^\\\\]]+)\\\\]/);\\n    if (!seedMatch) return;\\n    \\n    const seedName = seedMatch[1].trim().toLowerCase();\\n    // Find matching seed\\n    const seedIdx = seedKeywords.findIndex(s => \\n      s.toLowerCase() === seedName || \\n      s.toLowerCase().includes(seedName) || \\n      seedName.includes(s.toLowerCase())\\n    );\\n    const actualSeed = seedIdx >= 0 ? seedKeywords[seedIdx] : null;\\n    if (!actualSeed) return;\\n    \\n    // Parse CONTENT line\\n    const contentMatch = block.match(/CONTENT:([0-9,\\\\s]+)/);\\n    const contentNos = contentMatch ? contentMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n) && n > 0 && n <= allKeywords.length) : [];\\n    \\n    // Parse OTHERS line\\n    const othersMatch = block.match(/OTHERS:([0-9,\\\\s]+)/);\\n    const othersNos = othersMatch ? othersMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n) && n > 0 && n <= allKeywords.length) : [];\\n    \\n    // Add to approved (content worthy)\\n    contentNos.forEach(no => {\\n      const kw = allKeywords[no - 1];\\n      if (!kw) return;\\n      approved.push({\\n        keyword: kw.keyword,\\n        seed_keyword: actualSeed,\\n        search_volume: kw.search_volume,\\n        cpc: kw.cpc,\\n        competition: kw.competition,\\n        status: 'approved',\\n        intent: 'informational',\\n        priority: kw.search_volume >= 5000 ? 'high' : kw.search_volume >= 1000 ? 'medium' : 'low',\\n        content_type: 'cluster'\\n      });\\n    });\\n    \\n    // Add to rejected (others - deduplicated)\\n    othersNos.forEach(no => {\\n      const kw = allKeywords[no - 1];\\n      if (!kw) return;\\n      rejected.push({\\n        keyword: kw.keyword,\\n        seed_keyword: actualSeed,\\n        search_volume: kw.search_volume,\\n        status: 'rejected',\\n        reject_reason: 'Filtered/Deduplicated'\\n      });\\n    });\\n  });\\n  \\n} catch(e) {\\n  // Fallback - approve seeds only\\n  seedKeywords.forEach((seed, idx) => {\\n    approved.push({\\n      keyword: seed,\\n      seed_keyword: seed,\\n      search_volume: 0,\\n      status: 'approved',\\n      intent: 'informational',\\n      priority: 'high',\\n      content_type: 'pillar'\\n    });\\n  });\\n}\\n\\n// Stats per seed\\nconst perSeed = {};\\nseedKeywords.forEach(s => {\\n  perSeed[s] = {\\n    approved: approved.filter(k => k.seed_keyword === s).length,\\n    others: rejected.filter(k => k.seed_keyword === s).length\\n  };\\n});\\n\\nreturn [{ json: {\\n  projectId: prev.projectId,\\n  clientId: prev.clientId,\\n  mainKeyword: prev.keywords[0],\\n  keywords: prev.keywords,\\n  stats: { ...prev.stats, approved: approved.length, rejected: rejected.length, per_seed: perSeed },\\n  approved_keywords: approved,\\n  rejected_keywords: rejected,\\n  startTime: prev.startTime\\n}}];"},"id":"c950eed1-6ad7-4a88-b5e8-0bc4a784db3d","name":"Parse Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"has-project","leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}],"combinator":"and"},"options":{}},"id":"a324b6af-48e5-484c-9ccd-ae23c2879d90","name":"IF Save DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"jsCode":"const data = $input.first().json;\\nconst projectId = data.projectId;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\nconst all = [...approved, ...rejected];\\n\\nif (all.length === 0) return [{ json: { ...data, batchQuery: 'SELECT 1' }}];\\n\\nfunction esc(s) {\\n  if (s === null || s === undefined) return 'NULL';\\n  return \\"'\\" + String(s).replace(/\\\\\\\\/g,'\\\\\\\\\\\\\\\\').replace(/'/g,\\"''\\") + \\"'\\";\\n}\\n\\nconst vals = all.slice(0, 1000).map(kw => {\\n  return `(${projectId}, ${esc(kw.keyword)}, ${esc(kw.seed_keyword)}, 'related', ${kw.search_volume || 'NULL'}, ${kw.cpc || 'NULL'}, ${esc(kw.competition)}, ${esc(kw.intent)}, ${esc(kw.seed_keyword)}, ${esc(kw.priority)}, ${esc(kw.content_type)}, 'dataforseo', '${kw.status || 'pending'}', ${esc(kw.reject_reason)})`;\\n}).join(',\\\\n');\\n\\nconst query = `INSERT INTO keyword_results (project_id, keyword, seed_keyword, keyword_type, search_volume, cpc, competition, search_intent, keyword_cluster, content_priority, page_type, source, status, reject_reason) VALUES ${vals} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume), status=VALUES(status), seed_keyword=VALUES(seed_keyword)`;\\n\\nreturn [{ json: { ...data, batchQuery: query }}];"},"id":"233ccff6-995f-4be1-a035-da4580755a1e","name":"Prepare Insert","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,0]},{"parameters":{"operation":"executeQuery","query":"={{ $json.batchQuery }}","options":{}},"id":"3323c063-8ffd-462f-88b5-6b8c194fb9b8","name":"Save to DB","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const data = $('Prepare Insert').first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi. ${approved.length} ana sonuc, ${rejected.length} diger kelime.`,\\n  project_id: data.projectId,\\n  stats: data.stats,\\n  keywords: approved.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    intent: kw.intent,\\n    priority: kw.priority,\\n    content_type: kw.content_type,\\n    status: kw.status\\n  })),\\n  rejected_keywords: rejected.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    reason: kw.reject_reason\\n  })),\\n  processing_time_ms: Date.now() - data.startTime\\n}}];"},"id":"f34ec3bd-8feb-458a-b6b5-0e471baf630f","name":"Response (DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"jsCode":"const data = $input.first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi (DB yok). ${approved.length} ana sonuc, ${rejected.length} diger kelime.`,\\n  project_id: null,\\n  stats: data.stats,\\n  keywords: approved.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    intent: kw.intent,\\n    priority: kw.priority,\\n    content_type: kw.content_type,\\n    status: kw.status\\n  })),\\n  rejected_keywords: rejected.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    reason: kw.reject_reason\\n  })),\\n  processing_time_ms: Date.now() - data.startTime\\n}}];"},"id":"e155c285-a8b3-4e24-8162-2723bce29371","name":"Response (No DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,208]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"813b3c70-9f8c-41bd-bb79-4238bd9e132c","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,112]}]	{"Webhook Bulk":{"main":[[{"node":"Validate Input","type":"main","index":0}]]},"Validate Input":{"main":[[{"node":"IF Valid","type":"main","index":0}]]},"IF Valid":{"main":[[{"node":"DataForSEO Bulk","type":"main","index":0}],[{"node":"Respond Error","type":"main","index":0}]]},"DataForSEO Bulk":{"main":[[{"node":"Parse & Build Prompt","type":"main","index":0}]]},"Parse & Build Prompt":{"main":[[{"node":"Gemini Analyze","type":"main","index":0}]]},"Gemini Analyze":{"main":[[{"node":"Parse Response","type":"main","index":0}]]},"Parse Response":{"main":[[{"node":"IF Save DB","type":"main","index":0}]]},"IF Save DB":{"main":[[{"node":"Prepare Insert","type":"main","index":0}],[{"node":"Response (No DB)","type":"main","index":0}]]},"Prepare Insert":{"main":[[{"node":"Save to DB","type":"main","index":0}]]},"Save to DB":{"main":[[{"node":"Response (DB)","type":"main","index":0}]]},"Response (DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]},"Response (No DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]}}	\N	f	\N
d8a07cc8-12f8-4dc4-b0c2-a97f7df43f6c	adol4O3V4iGsGXpf	Fatih Berkay Baheci	2025-12-23 13:33:15.04+00	2025-12-23 13:33:15.04+00	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"2aee6012-d6ab-44d8-9372-2464b58d1b08","name":"Webhook Bulk","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1760,112],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"const body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\n\\nif (!Array.isArray(keywords) || keywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'keywords array required', errorCode: 400 }}];\\n}\\n\\nconst cleanKeywords = keywords.map(k => String(k).trim().toLowerCase()).filter(k => k.length >= 2).slice(0, 100);\\n\\nif (cleanKeywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'Min 1 valid keyword required', errorCode: 400 }}];\\n}\\n\\nconst locationCodes = { 'TR': 2792, 'US': 2840, 'GB': 2826, 'DE': 2276, 'FR': 2250 };\\n\\nreturn [{ json: { \\n  isValid: true, keywords: cleanKeywords, keywordCount: cleanKeywords.length,\\n  projectId: projectId ? parseInt(projectId) : null, clientId: clientId ? parseInt(clientId) : null,\\n  country, language, locationCode: locationCodes[country] || 2792, startTime: Date.now()\\n}}];"},"id":"dd9c2905-9fa1-447b-8b63-d1976dbcc3af","name":"Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1536,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"9ffb9544-73b7-4bf0-8f02-a6d6b046bbaf","name":"IF Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1328,112]},{"parameters":{"respondWith":"json","responseBody":"={ \\"success\\": false, \\"error\\": \\"{{ $json.error }}\\" }","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"715e5a4f-f73c-46ba-b336-e3b18422ab73","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-1104,304]},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\n  \\"keywords\\": {{ JSON.stringify($json.keywords) }},\\n  \\"location_code\\": {{ $json.locationCode }},\\n  \\"language_code\\": \\"{{ $json.language }}\\",\\n  \\"include_seed_keyword\\": true,\\n  \\"sort_by\\": \\"search_volume\\"\\n}]","options":{"timeout":120000}},"id":"02f1198a-88c8-41fb-b491-f90c6e9eddb2","name":"DataForSEO Bulk","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1104,112],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Parse DataForSEO & Build Classification Prompt\\nconst input = $('Validate Input').first().json;\\nconst seedKeywords = input.keywords || [];\\n\\nfunction normalize(str) {\\n  return str.toLowerCase().replace(//g,'i').replace(//g,'i').replace(//g,'s').replace(//g,'s')\\n    .replace(//g,'o').replace(//g,'o').replace(//g,'u').replace(//g,'u')\\n    .replace(//g,'c').replace(//g,'c').replace(//g,'g').replace(//g,'g')\\n    .replace(/[^a-z0-9\\\\s]/g,'').replace(/\\\\s+/g,' ').trim();\\n}\\n\\nlet allKeywords = [];\\ntry {\\n  const dfs = $input.first().json;\\n  if (dfs?.tasks?.[0]?.result) {\\n    allKeywords = dfs.tasks[0].result.map(kw => ({\\n      keyword: (kw.keyword || '').toLowerCase().trim(),\\n      search_volume: kw.search_volume || 0,\\n      cpc: kw.cpc || 0,\\n      competition: kw.competition || null\\n    })).filter(kw => kw.keyword && kw.keyword.length >= 2);\\n  }\\n} catch(e) {}\\n\\n// Dedupe\\nconst seen = new Map();\\nallKeywords.forEach(kw => {\\n  const key = normalize(kw.keyword);\\n  if (key.length >= 2 && !seen.has(key)) seen.set(key, kw);\\n});\\n\\nconst unique = Array.from(seen.values()).slice(0, 3000);\\n\\n// Build classification prompt\\nconst seedList = seedKeywords.map((s,i) => `${i+1}. ${s}`).join('\\\\n');\\nconst kwList = unique.map((kw,i) => `${i+1}|${kw.keyword}`).join('\\\\n');\\n\\nconst classifyPrompt = `Her keyword'u en uygun SEED ile eslestir.\\n\\nSEED'LER:\\n${seedList}\\n\\nKEYWORDS:\\n${kwList}\\n\\nKURALLAR:\\n- Anlamsal iliski kur (laptop/notebook=bilgisayar, terlik/sandalet/bot=ayakkabi, krem/serum=cilt)\\n- Markalar kategoriye gore (Nike/Adidas=ayakkabi, Samsung/Apple=telefon, HP/Asus=laptop)\\n- Alakasiz keyword = 0\\n\\nCIKTI: Her satir no|seed_no (sadece numaralar)\\n1|2\\n2|0\\n3|1`;\\n\\nreturn [{ json: {\\n  ...input,\\n  allKeywords: unique,\\n  classifyPrompt: classifyPrompt,\\n  stats: { total_seeds: seedKeywords.length, from_dataforseo: allKeywords.length, unique: unique.length }\\n}}];"},"id":"44667b0c-af8e-4a55-99b2-d80241c9b2f0","name":"Parse DataForSEO","type":"n8n-nodes-base.code","typeVersion":2,"position":[-880,112]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{ \\"parts\\": [{ \\"text\\": {{ JSON.stringify($json.classifyPrompt) }} }] }],\\n  \\"generationConfig\\": { \\"temperature\\": 0.1, \\"maxOutputTokens\\": 65536 }\\n}","options":{"timeout":300000}},"id":"a3a6e309-fbfc-4cc6-9ce2-4cf0b66132e8","name":"Gemini Classify","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-656,112],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Parse Classification & Split by Seed (each seed becomes separate item for parallel processing)\\nconst prev = $('Parse DataForSEO').first().json;\\nconst gemini = $input.first().json;\\nconst seedKeywords = prev.keywords || [];\\nconst allKeywords = prev.allKeywords || [];\\n\\n// Parse classification\\nconst keywordToSeed = new Map();\\ntry {\\n  const text = gemini?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  text.split('\\\\n').forEach(line => {\\n    const clean = line.replace(/^\\\\|\\\\s*/, '').replace(/\\\\s*\\\\|\\\\s*$/, '').trim();\\n    const parts = clean.split('|').map(p => p.trim());\\n    if (parts.length >= 2) {\\n      const kwIdx = parseInt(parts[0]) - 1;\\n      const seedIdx = parseInt(parts[1]) - 1;\\n      if (kwIdx >= 0 && kwIdx < allKeywords.length && seedIdx >= 0 && seedIdx < seedKeywords.length) {\\n        keywordToSeed.set(kwIdx, seedIdx);\\n      }\\n    }\\n  });\\n} catch(e) {}\\n\\n// Group by seed\\nconst bySeed = {};\\nseedKeywords.forEach((s, i) => { bySeed[i] = []; });\\n\\nallKeywords.forEach((kw, idx) => {\\n  const seedIdx = keywordToSeed.get(idx);\\n  if (seedIdx !== undefined && bySeed[seedIdx]) {\\n    bySeed[seedIdx].push({ ...kw, originalIndex: idx });\\n  }\\n});\\n\\n// Create one item per seed for parallel processing\\nconst items = [];\\nseedKeywords.forEach((seed, seedIdx) => {\\n  const kwList = bySeed[seedIdx] || [];\\n  if (kwList.length === 0) {\\n    // No keywords for this seed, still create item with empty results\\n    items.push({\\n      json: {\\n        seed: seed,\\n        seedIndex: seedIdx,\\n        keywordCount: 0,\\n        keywords: [],\\n        projectId: prev.projectId,\\n        clientId: prev.clientId,\\n        startTime: prev.startTime,\\n        totalSeeds: seedKeywords.length,\\n        allSeedKeywords: seedKeywords,\\n        skipFilter: true\\n      }\\n    });\\n  } else {\\n    // Build filter prompt for this seed\\n    const kwCsv = kwList.map((kw, i) => `${i+1}|${kw.keyword}|${kw.search_volume}`).join('\\\\n');\\n    const filterPrompt = `Sen SEO uzmanisin. \\"${seed}\\" icin keyword analizi yap.\\n\\n## KEYWORDS (no|keyword|volume)\\n${kwCsv}\\n\\n## ANA SONUCLAR (max 35)\\nIcerik/makale olusturmaya EN UYGUN keywordleri sec:\\n- Bagimsiz icerik konusu olabilir mi?\\n- Arama amaci net mi?\\n- Cok genel veya cok spesifik marka+model REDDET\\n- Kalite > miktar (5 iyi keyword > 35 kotu keyword)\\n\\n## DIGER KELIMELER\\nAna sonuca GIRMEYEN keywordler, BENZERLER BIRLESTIRILMIS:\\n- \\"fiyat\\"/\\"fiyati\\"/\\"fiyatlari\\"  sadece biri\\n- \\"2024\\"/\\"2025\\" varyasyonlari  sadece biri\\n- \\"en iyi\\"/\\"en ucuz\\" varyasyonlari  sadece biri\\n\\n## CIKTI\\nCONTENT:1,5,12,23 (icerige uygun, max 35)\\nOTHERS:2,8,15,31 (diger, dedupe edilmis)\\n\\nSADECE BU 2 SATIR, ACIKLAMA YOK.`;\\n    \\n    items.push({\\n      json: {\\n        seed: seed,\\n        seedIndex: seedIdx,\\n        keywordCount: kwList.length,\\n        keywords: kwList,\\n        filterPrompt: filterPrompt,\\n        projectId: prev.projectId,\\n        clientId: prev.clientId,\\n        startTime: prev.startTime,\\n        totalSeeds: seedKeywords.length,\\n        allSeedKeywords: seedKeywords,\\n        skipFilter: false\\n      }\\n    });\\n  }\\n});\\n\\nreturn items;"},"id":"21aa121e-25a4-4950-b92f-a3d22f5641fe","name":"Split by Seed","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"skip","leftValue":"={{ $json.skipFilter }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"31b37e55-f59a-4bd7-b1f6-99f14e90563b","name":"IF Has Keywords","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{ \\"parts\\": [{ \\"text\\": {{ JSON.stringify($json.filterPrompt) }} }] }],\\n  \\"generationConfig\\": { \\"temperature\\": 0.2, \\"maxOutputTokens\\": 16384 }\\n}","options":{"timeout":120000}},"id":"a512f627-cd5d-4af5-8855-baa6db487fb3","name":"Gemini Filter (Parallel)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[0,0],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Parse Filter Response for this seed\\nconst prev = $('Split by Seed').item;\\nconst gemini = $input.first().json;\\nconst seed = prev.json.seed;\\nconst keywords = prev.json.keywords || [];\\n\\nconst approved = [];\\nconst rejected = [];\\n\\ntry {\\n  const text = gemini?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  \\n  // Parse CONTENT line\\n  const contentMatch = text.match(/CONTENT:([0-9,\\\\s]+)/);\\n  const contentNos = contentMatch ? contentMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n) && n > 0 && n <= keywords.length) : [];\\n  \\n  // Parse OTHERS line\\n  const othersMatch = text.match(/OTHERS:([0-9,\\\\s]+)/);\\n  const othersNos = othersMatch ? othersMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n) && n > 0 && n <= keywords.length) : [];\\n  \\n  // Content keywords  approved\\n  contentNos.forEach(no => {\\n    const kw = keywords[no - 1];\\n    if (kw) {\\n      approved.push({\\n        keyword: kw.keyword,\\n        seed_keyword: seed,\\n        search_volume: kw.search_volume,\\n        cpc: kw.cpc,\\n        competition: kw.competition,\\n        status: 'approved',\\n        intent: 'informational',\\n        priority: kw.search_volume >= 5000 ? 'high' : kw.search_volume >= 1000 ? 'medium' : 'low',\\n        content_type: 'cluster'\\n      });\\n    }\\n  });\\n  \\n  // Others keywords  rejected (deduplicated by AI)\\n  othersNos.forEach(no => {\\n    const kw = keywords[no - 1];\\n    if (kw) {\\n      rejected.push({\\n        keyword: kw.keyword,\\n        seed_keyword: seed,\\n        search_volume: kw.search_volume,\\n        status: 'rejected',\\n        reject_reason: 'Filtered/Deduplicated'\\n      });\\n    }\\n  });\\n} catch(e) {\\n  // Fallback: top 35 by volume approved, rest rejected\\n  const sorted = [...keywords].sort((a,b) => (b.search_volume||0) - (a.search_volume||0));\\n  sorted.slice(0, 35).forEach(kw => {\\n    approved.push({ keyword: kw.keyword, seed_keyword: seed, search_volume: kw.search_volume, status: 'approved', intent: 'informational', priority: 'medium', content_type: 'cluster' });\\n  });\\n  sorted.slice(35).forEach(kw => {\\n    rejected.push({ keyword: kw.keyword, seed_keyword: seed, search_volume: kw.search_volume, status: 'rejected', reject_reason: 'Fallback filter' });\\n  });\\n}\\n\\nreturn [{ json: {\\n  seed: seed,\\n  seedIndex: prev.json.seedIndex,\\n  approved: approved,\\n  rejected: rejected,\\n  projectId: prev.json.projectId,\\n  clientId: prev.json.clientId,\\n  startTime: prev.json.startTime,\\n  totalSeeds: prev.json.totalSeeds,\\n  allSeedKeywords: prev.json.allSeedKeywords\\n}}];"},"id":"0027e28b-6a3f-4bb9-b19b-9fe7779ade60","name":"Parse Filter","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,0]},{"parameters":{"jsCode":"// Empty seed - no keywords\\nconst prev = $input.first().json;\\nreturn [{ json: {\\n  seed: prev.seed,\\n  seedIndex: prev.seedIndex,\\n  approved: [],\\n  rejected: [],\\n  projectId: prev.projectId,\\n  clientId: prev.clientId,\\n  startTime: prev.startTime,\\n  totalSeeds: prev.totalSeeds,\\n  allSeedKeywords: prev.allSeedKeywords\\n}}];"},"id":"613dcc29-de9d-43ef-b129-018ac3397876","name":"Empty Seed","type":"n8n-nodes-base.code","typeVersion":2,"position":[224,208]},{"parameters":{"mode":"combine","combineBy":"combineAll","options":{}},"id":"7faf2949-e7ab-4b93-9a38-ca0c71faa058","name":"Merge Results","type":"n8n-nodes-base.merge","typeVersion":3,"position":[448,112]},{"parameters":{"jsCode":"// Combine all seed results\\nconst items = $input.all();\\n\\nlet projectId = null;\\nlet clientId = null;\\nlet startTime = Date.now();\\nlet allSeedKeywords = [];\\n\\nconst allApproved = [];\\nconst allRejected = [];\\nconst perSeed = {};\\n\\nitems.forEach(item => {\\n  const data = item.json;\\n  if (data.projectId) projectId = data.projectId;\\n  if (data.clientId) clientId = data.clientId;\\n  if (data.startTime) startTime = data.startTime;\\n  if (data.allSeedKeywords) allSeedKeywords = data.allSeedKeywords;\\n  \\n  const seed = data.seed;\\n  const approved = data.approved || [];\\n  const rejected = data.rejected || [];\\n  \\n  allApproved.push(...approved);\\n  allRejected.push(...rejected);\\n  \\n  perSeed[seed] = {\\n    approved: approved.length,\\n    others: rejected.length\\n  };\\n});\\n\\nreturn [{ json: {\\n  projectId: projectId,\\n  clientId: clientId,\\n  mainKeyword: allSeedKeywords[0] || '',\\n  keywords: allSeedKeywords,\\n  stats: {\\n    total_seeds: allSeedKeywords.length,\\n    approved: allApproved.length,\\n    rejected: allRejected.length,\\n    per_seed: perSeed\\n  },\\n  approved_keywords: allApproved,\\n  rejected_keywords: allRejected,\\n  startTime: startTime\\n}}];"},"id":"944d5b23-b5e0-4e08-93df-226d0d01502c","name":"Combine Results","type":"n8n-nodes-base.code","typeVersion":2,"position":[672,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"has-project","leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}],"combinator":"and"},"options":{}},"id":"00de3fb9-bf1d-4447-bab1-7b98f7f67f3f","name":"IF Save DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[880,112]},{"parameters":{"jsCode":"const data = $input.first().json;\\nconst projectId = data.projectId;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\nconst all = [...approved, ...rejected];\\n\\nif (all.length === 0) return [{ json: { ...data, batchQuery: 'SELECT 1' }}];\\n\\nfunction esc(s) {\\n  if (s === null || s === undefined) return 'NULL';\\n  return \\"'\\" + String(s).replace(/\\\\\\\\/g,'\\\\\\\\\\\\\\\\').replace(/'/g,\\"''\\") + \\"'\\";\\n}\\n\\nconst vals = all.slice(0, 2000).map(kw => {\\n  return `(${projectId}, ${esc(kw.keyword)}, ${esc(kw.seed_keyword)}, 'related', ${kw.search_volume || 'NULL'}, ${kw.cpc || 'NULL'}, ${esc(kw.competition)}, ${esc(kw.intent)}, ${esc(kw.seed_keyword)}, ${esc(kw.priority)}, ${esc(kw.content_type)}, 'dataforseo', '${kw.status || 'pending'}', ${esc(kw.reject_reason)})`;\\n}).join(',\\\\n');\\n\\nconst query = `INSERT INTO keyword_results (project_id, keyword, seed_keyword, keyword_type, search_volume, cpc, competition, search_intent, keyword_cluster, content_priority, page_type, source, status, reject_reason) VALUES ${vals} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume), status=VALUES(status), seed_keyword=VALUES(seed_keyword)`;\\n\\nreturn [{ json: { ...data, batchQuery: query }}];"},"id":"5115a00c-0561-4480-9bfc-ad134cca63ca","name":"Prepare Insert","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,0]},{"parameters":{"operation":"executeQuery","query":"={{ $json.batchQuery }}","options":{}},"id":"c1ff8f25-938a-4547-8a75-57d868dcdc68","name":"Save to DB","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1328,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const data = $('Prepare Insert').first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi. ${approved.length} ana sonuc, ${rejected.length} diger kelime.`,\\n  project_id: data.projectId,\\n  stats: data.stats,\\n  keywords: approved.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    intent: kw.intent,\\n    priority: kw.priority,\\n    content_type: kw.content_type,\\n    status: kw.status\\n  })),\\n  rejected_keywords: rejected.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    reason: kw.reject_reason\\n  })),\\n  processing_time_ms: Date.now() - data.startTime\\n}}];"},"id":"aee0018c-4d8b-4a27-a4ff-1239e0880b17","name":"Response (DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[1552,0]},{"parameters":{"jsCode":"const data = $input.first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi (DB yok). ${approved.length} ana sonuc, ${rejected.length} diger kelime.`,\\n  project_id: null,\\n  stats: data.stats,\\n  keywords: approved.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    intent: kw.intent,\\n    priority: kw.priority,\\n    content_type: kw.content_type,\\n    status: kw.status\\n  })),\\n  rejected_keywords: rejected.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    reason: kw.reject_reason\\n  })),\\n  processing_time_ms: Date.now() - data.startTime\\n}}];"},"id":"b8711170-8637-40ff-9579-0e80fc72898f","name":"Response (No DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[1104,208]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"d204d6cb-2acc-4e31-adb6-4521d52ff359","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1760,112]}]	{"Webhook Bulk":{"main":[[{"node":"Validate Input","type":"main","index":0}]]},"Validate Input":{"main":[[{"node":"IF Valid","type":"main","index":0}]]},"IF Valid":{"main":[[{"node":"DataForSEO Bulk","type":"main","index":0}],[{"node":"Respond Error","type":"main","index":0}]]},"DataForSEO Bulk":{"main":[[{"node":"Parse DataForSEO","type":"main","index":0}]]},"Parse DataForSEO":{"main":[[{"node":"Gemini Classify","type":"main","index":0}]]},"Gemini Classify":{"main":[[{"node":"Split by Seed","type":"main","index":0}]]},"Split by Seed":{"main":[[{"node":"IF Has Keywords","type":"main","index":0}]]},"IF Has Keywords":{"main":[[{"node":"Gemini Filter (Parallel)","type":"main","index":0}],[{"node":"Empty Seed","type":"main","index":0}]]},"Gemini Filter (Parallel)":{"main":[[{"node":"Parse Filter","type":"main","index":0}]]},"Parse Filter":{"main":[[{"node":"Merge Results","type":"main","index":0}]]},"Empty Seed":{"main":[[{"node":"Merge Results","type":"main","index":1}]]},"Merge Results":{"main":[[{"node":"Combine Results","type":"main","index":0}]]},"Combine Results":{"main":[[{"node":"IF Save DB","type":"main","index":0}]]},"IF Save DB":{"main":[[{"node":"Prepare Insert","type":"main","index":0}],[{"node":"Response (No DB)","type":"main","index":0}]]},"Prepare Insert":{"main":[[{"node":"Save to DB","type":"main","index":0}]]},"Save to DB":{"main":[[{"node":"Response (DB)","type":"main","index":0}]]},"Response (DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]},"Response (No DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]}}	\N	f	\N
b256ebac-6eea-44fd-bfd8-27bbc2074b91	adol4O3V4iGsGXpf	Fatih Berkay Baheci	2025-12-23 14:03:23.806+00	2025-12-23 14:03:23.806+00	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"d2342af3-cc19-44fd-86c0-459e66503fef","name":"Webhook Bulk","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-2944,272],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"const body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\n\\nif (!Array.isArray(keywords) || keywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'keywords array required', errorCode: 400 }}];\\n}\\n\\nconst cleanKeywords = keywords.map(k => String(k).trim().toLowerCase()).filter(k => k.length >= 2).slice(0, 100);\\n\\nif (cleanKeywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'Min 1 valid keyword required', errorCode: 400 }}];\\n}\\n\\nconst locationCodes = { 'TR': 2792, 'US': 2840, 'GB': 2826, 'DE': 2276, 'FR': 2250 };\\n\\nreturn [{ json: { \\n  isValid: true, \\n  keywords: cleanKeywords, \\n  keywordCount: cleanKeywords.length,\\n  projectId: projectId ? parseInt(projectId) : null, \\n  clientId: clientId ? parseInt(clientId) : null,\\n  country, \\n  language, \\n  locationCode: locationCodes[country] || 2792, \\n  startTime: Date.now()\\n}}];"},"id":"b2dba5d6-f45c-44ac-8ab1-d867efd68855","name":"Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2720,272]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"1cecf008-61d1-4a34-a352-7f0476467a71","name":"IF Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-2496,272]},{"parameters":{"respondWith":"json","responseBody":"={ \\"success\\": false, \\"error\\": \\"{{ $json.error }}\\" }","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"a91d310f-c67a-4305-bf54-7808e8c07aff","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-2288,464]},{"parameters":{"jsCode":"// Split into separate items - one per seed keyword (for parallel processing)\\nconst input = $input.first().json;\\nconst seedKeywords = input.keywords || [];\\n\\n// Create one item per seed\\nconst items = seedKeywords.map((seed, idx) => ({\\n  json: {\\n    seed: seed,\\n    seedIndex: idx,\\n    projectId: input.projectId,\\n    clientId: input.clientId,\\n    country: input.country,\\n    language: input.language,\\n    locationCode: input.locationCode,\\n    startTime: input.startTime,\\n    totalSeeds: seedKeywords.length,\\n    allSeeds: seedKeywords\\n  }\\n}));\\n\\nreturn items;"},"id":"98c39008-8c9c-4d9d-a4f6-6767e3d11bee","name":"Split Seeds","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2288,272]},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\n  \\"keywords\\": [\\"{{ $json.seed }}\\"],\\n  \\"location_code\\": {{ $json.locationCode }},\\n  \\"language_code\\": \\"{{ $json.language }}\\",\\n  \\"include_seed_keyword\\": true,\\n  \\"sort_by\\": \\"search_volume\\"\\n}]","options":{"timeout":60000}},"id":"0b0439ad-bd90-4756-856e-74d2771f88e1","name":"DataForSEO (Parallel)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2064,272],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Parse DataForSEO response and build Gemini filter prompt\\nconst prev = $('Split Seeds').item;\\nconst dfs = $input.first().json;\\nconst seed = prev.json.seed;\\n\\nfunction normalize(str) {\\n  return str.toLowerCase().replace(//g,'i').replace(//g,'i').replace(//g,'s').replace(//g,'s')\\n    .replace(//g,'o').replace(//g,'o').replace(//g,'u').replace(//g,'u')\\n    .replace(//g,'c').replace(//g,'c').replace(//g,'g').replace(//g,'g')\\n    .replace(/[^a-z0-9\\\\s]/g,'').replace(/\\\\s+/g,' ').trim();\\n}\\n\\nlet keywords = [];\\ntry {\\n  if (dfs?.tasks?.[0]?.result) {\\n    keywords = dfs.tasks[0].result.map(kw => ({\\n      keyword: (kw.keyword || '').toLowerCase().trim(),\\n      search_volume: kw.search_volume || 0,\\n      cpc: kw.cpc || 0,\\n      competition: kw.competition || null\\n    })).filter(kw => kw.keyword && kw.keyword.length >= 2);\\n  }\\n} catch(e) {}\\n\\n// Dedupe\\nconst seen = new Map();\\nkeywords.forEach(kw => {\\n  const key = normalize(kw.keyword);\\n  if (key.length >= 2 && !seen.has(key)) seen.set(key, kw);\\n});\\nconst unique = Array.from(seen.values());\\n\\n// Build filter prompt\\nconst kwCsv = unique.slice(0, 1000).map((kw, i) => `${i+1}|${kw.keyword}|${kw.search_volume}`).join('\\\\n');\\n\\nconst filterPrompt = `\\"${seed}\\" icin keyword analizi yap.\\n\\nKEYWORDS (no|keyword|volume):\\n${kwCsv}\\n\\n## ANA SONUCLAR (max 35)\\nIcerik/makale olusturmaya EN UYGUN keywordleri sec:\\n- Bagimsiz bir icerik konusu olabilir mi?\\n- Arama amaci net mi? (bilgi arayan, satin almak isteyen, karsilastiran)\\n- Yeterli arama hacmi var mi?\\n- REDDET: Cok genel tek kelimeler, cok spesifik marka+model kombinasyonlari, anlamsiz sorular\\n- KALITE > MIKTAR: 10 iyi keyword, 35 kotu keywordden iyidir\\n\\n## DIGER KELIMELER  \\nAna sonuca girmeyen tumunu listele, BENZERLER BIRLESTIRILMIS:\\n- \\"fiyat\\" \\"fiyati\\" \\"fiyatlari\\"  sadece en yuksek hacimli\\n- \\"2024\\" \\"2025\\" eki olanlar  sadece biri\\n- \\"en iyi\\" \\"en ucuz\\" \\"en kaliteli\\"  sadece biri\\n- Cogul/tekil  sadece biri\\n\\n## CIKTI FORMATI\\nCONTENT:1,5,12,23,45\\nOTHERS:2,3,8,15,22,31,44,55\\n\\nSADECE BU 2 SATIR. ACIKLAMA YAZMA.`;\\n\\nreturn [{ json: {\\n  seed: seed,\\n  seedIndex: prev.json.seedIndex,\\n  keywords: unique,\\n  keywordCount: unique.length,\\n  filterPrompt: filterPrompt,\\n  projectId: prev.json.projectId,\\n  clientId: prev.json.clientId,\\n  startTime: prev.json.startTime,\\n  totalSeeds: prev.json.totalSeeds,\\n  allSeeds: prev.json.allSeeds\\n}}];"},"id":"04bd6603-7148-4455-92e1-731bf51f4979","name":"Parse DataForSEO","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1840,272]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{ \\"parts\\": [{ \\"text\\": {{ JSON.stringify($json.filterPrompt) }} }] }],\\n  \\"generationConfig\\": { \\"temperature\\": 0.2, \\"maxOutputTokens\\": 16384 }\\n}","options":{"timeout":120000}},"id":"b4101a5a-1aec-4f66-bc57-a9fbb66c4412","name":"Gemini Filter (Parallel)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1616,272],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Parse Gemini filter response\\nconst prev = $('Parse DataForSEO').item;\\nconst gemini = $input.first().json;\\nconst seed = prev.json.seed;\\nconst keywords = prev.json.keywords || [];\\n\\nconst approved = [];\\nconst rejected = [];\\n\\ntry {\\n  const text = gemini?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  \\n  // Parse CONTENT line\\n  const contentMatch = text.match(/CONTENT:([0-9,\\\\s]+)/);\\n  const contentNos = contentMatch \\n    ? contentMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n) && n > 0 && n <= keywords.length) \\n    : [];\\n  \\n  // Parse OTHERS line\\n  const othersMatch = text.match(/OTHERS:([0-9,\\\\s]+)/);\\n  const othersNos = othersMatch \\n    ? othersMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n) && n > 0 && n <= keywords.length) \\n    : [];\\n  \\n  // Content  approved\\n  contentNos.forEach(no => {\\n    const kw = keywords[no - 1];\\n    if (kw) {\\n      approved.push({\\n        keyword: kw.keyword,\\n        seed_keyword: seed,\\n        search_volume: kw.search_volume,\\n        cpc: kw.cpc,\\n        competition: kw.competition,\\n        status: 'approved',\\n        intent: 'informational',\\n        priority: kw.search_volume >= 5000 ? 'high' : kw.search_volume >= 1000 ? 'medium' : 'low',\\n        content_type: 'cluster'\\n      });\\n    }\\n  });\\n  \\n  // Others  rejected (deduplicated)\\n  othersNos.forEach(no => {\\n    const kw = keywords[no - 1];\\n    if (kw) {\\n      rejected.push({\\n        keyword: kw.keyword,\\n        seed_keyword: seed,\\n        search_volume: kw.search_volume,\\n        status: 'rejected',\\n        reject_reason: 'Filtered/Deduplicated'\\n      });\\n    }\\n  });\\n  \\n} catch(e) {\\n  // Fallback: top 35 by volume\\n  const sorted = [...keywords].sort((a,b) => (b.search_volume||0) - (a.search_volume||0));\\n  sorted.slice(0, 35).forEach(kw => {\\n    approved.push({\\n      keyword: kw.keyword,\\n      seed_keyword: seed,\\n      search_volume: kw.search_volume,\\n      cpc: kw.cpc,\\n      status: 'approved',\\n      intent: 'informational',\\n      priority: 'medium',\\n      content_type: 'cluster'\\n    });\\n  });\\n  sorted.slice(35).forEach(kw => {\\n    rejected.push({\\n      keyword: kw.keyword,\\n      seed_keyword: seed,\\n      search_volume: kw.search_volume,\\n      status: 'rejected',\\n      reject_reason: 'Volume-based fallback'\\n    });\\n  });\\n}\\n\\nreturn [{ json: {\\n  seed: seed,\\n  seedIndex: prev.json.seedIndex,\\n  approved: approved,\\n  rejected: rejected,\\n  keywordCount: keywords.length,\\n  projectId: prev.json.projectId,\\n  clientId: prev.json.clientId,\\n  startTime: prev.json.startTime,\\n  totalSeeds: prev.json.totalSeeds,\\n  allSeeds: prev.json.allSeeds\\n}}];"},"id":"0c8937ea-aa24-4ad9-8427-de8a759677da","name":"Parse Filter","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1408,272]},{"parameters":{"jsCode":"// Combine all seed results into single response\\nconst items = $input.all();\\n\\nlet projectId = null;\\nlet clientId = null;\\nlet startTime = Date.now();\\nlet allSeeds = [];\\n\\nconst allApproved = [];\\nconst allRejected = [];\\nconst perSeed = {};\\n\\nitems.forEach(item => {\\n  const data = item.json;\\n  if (data.projectId) projectId = data.projectId;\\n  if (data.clientId) clientId = data.clientId;\\n  if (data.startTime) startTime = data.startTime;\\n  if (data.allSeeds && data.allSeeds.length > allSeeds.length) allSeeds = data.allSeeds;\\n  \\n  const seed = data.seed;\\n  const approved = data.approved || [];\\n  const rejected = data.rejected || [];\\n  \\n  allApproved.push(...approved);\\n  allRejected.push(...rejected);\\n  \\n  perSeed[seed] = {\\n    total_keywords: data.keywordCount || 0,\\n    approved: approved.length,\\n    others: rejected.length\\n  };\\n});\\n\\nreturn [{ json: {\\n  projectId: projectId,\\n  clientId: clientId,\\n  mainKeyword: allSeeds[0] || '',\\n  keywords: allSeeds,\\n  stats: {\\n    total_seeds: allSeeds.length,\\n    total_approved: allApproved.length,\\n    total_others: allRejected.length,\\n    per_seed: perSeed\\n  },\\n  approved_keywords: allApproved,\\n  rejected_keywords: allRejected,\\n  startTime: startTime\\n}}];"},"id":"e72a684a-1172-4f7c-b9c3-8ae9dafbf273","name":"Combine Results","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1184,272]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"has-project","leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}],"combinator":"and"},"options":{}},"id":"50d54173-e22b-4ab1-b82f-6d1e5d4d8606","name":"IF Save DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[-960,272]},{"parameters":{"jsCode":"const data = $input.first().json;\\nconst projectId = data.projectId;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\nconst all = [...approved, ...rejected];\\n\\nif (all.length === 0) return [{ json: { ...data, batchQuery: 'SELECT 1' }}];\\n\\nfunction esc(s) {\\n  if (s === null || s === undefined) return 'NULL';\\n  return \\"'\\" + String(s).replace(/\\\\\\\\/g,'\\\\\\\\\\\\\\\\').replace(/'/g,\\"''\\") + \\"'\\";\\n}\\n\\nconst vals = all.slice(0, 2000).map(kw => {\\n  return `(${projectId}, ${esc(kw.keyword)}, ${esc(kw.seed_keyword)}, 'related', ${kw.search_volume || 'NULL'}, ${kw.cpc || 'NULL'}, ${esc(kw.competition)}, ${esc(kw.intent)}, ${esc(kw.seed_keyword)}, ${esc(kw.priority)}, ${esc(kw.content_type)}, 'dataforseo', '${kw.status || 'pending'}', ${esc(kw.reject_reason)})`;\\n}).join(',\\\\n');\\n\\nconst query = `INSERT INTO keyword_results (project_id, keyword, seed_keyword, keyword_type, search_volume, cpc, competition, search_intent, keyword_cluster, content_priority, page_type, source, status, reject_reason) VALUES ${vals} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume), status=VALUES(status), seed_keyword=VALUES(seed_keyword)`;\\n\\nreturn [{ json: { ...data, batchQuery: query }}];"},"id":"9c2a0683-09df-454f-85e6-2f2c3a620189","name":"Prepare Insert","type":"n8n-nodes-base.code","typeVersion":2,"position":[-736,160]},{"parameters":{"operation":"executeQuery","query":"={{ $json.batchQuery }}","options":{}},"id":"0a2a8f50-8b3c-43a2-a61e-1ce958d75000","name":"Save to DB","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-528,160],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const data = $('Prepare Insert').first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi. ${approved.length} ana sonuc, ${rejected.length} diger kelime.`,\\n  project_id: data.projectId,\\n  stats: data.stats,\\n  keywords: approved.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    intent: kw.intent,\\n    priority: kw.priority,\\n    content_type: kw.content_type,\\n    status: kw.status\\n  })),\\n  rejected_keywords: rejected.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    reason: kw.reject_reason\\n  })),\\n  processing_time_ms: Date.now() - data.startTime\\n}}];"},"id":"890527ea-7267-4f28-9970-d6074be7d30f","name":"Response (DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[-304,160]},{"parameters":{"jsCode":"const data = $input.first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi (DB yok). ${approved.length} ana sonuc, ${rejected.length} diger kelime.`,\\n  project_id: null,\\n  stats: data.stats,\\n  keywords: approved.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    intent: kw.intent,\\n    priority: kw.priority,\\n    content_type: kw.content_type,\\n    status: kw.status\\n  })),\\n  rejected_keywords: rejected.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    reason: kw.reject_reason\\n  })),\\n  processing_time_ms: Date.now() - data.startTime\\n}}];"},"id":"d9690bd4-5e1c-4266-b6dd-d2cc14acb977","name":"Response (No DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[-736,368]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"670110e3-f269-48ef-bee8-006dcf821c8c","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-80,272]}]	{"Webhook Bulk":{"main":[[{"node":"Validate Input","type":"main","index":0}]]},"Validate Input":{"main":[[{"node":"IF Valid","type":"main","index":0}]]},"IF Valid":{"main":[[{"node":"Split Seeds","type":"main","index":0}],[{"node":"Respond Error","type":"main","index":0}]]},"Split Seeds":{"main":[[{"node":"DataForSEO (Parallel)","type":"main","index":0}]]},"DataForSEO (Parallel)":{"main":[[{"node":"Parse DataForSEO","type":"main","index":0}]]},"Parse DataForSEO":{"main":[[{"node":"Gemini Filter (Parallel)","type":"main","index":0}]]},"Gemini Filter (Parallel)":{"main":[[{"node":"Parse Filter","type":"main","index":0}]]},"Parse Filter":{"main":[[{"node":"Combine Results","type":"main","index":0}]]},"Combine Results":{"main":[[{"node":"IF Save DB","type":"main","index":0}]]},"IF Save DB":{"main":[[{"node":"Prepare Insert","type":"main","index":0}],[{"node":"Response (No DB)","type":"main","index":0}]]},"Prepare Insert":{"main":[[{"node":"Save to DB","type":"main","index":0}]]},"Save to DB":{"main":[[{"node":"Response (DB)","type":"main","index":0}]]},"Response (DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]},"Response (No DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]}}	\N	f	\N
f5eb2066-bec5-4b31-a64e-0f206c7ffb84	adol4O3V4iGsGXpf	Fatih Berkay Baheci	2025-12-23 14:15:46.359+00	2025-12-23 14:15:46.359+00	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"a65d47fc-fc11-4c3f-8eba-abd98bb78ba4","name":"Webhook Bulk","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3600,368],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"const body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\n\\nif (!Array.isArray(keywords) || keywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'keywords array required', errorCode: 400 }}];\\n}\\n\\nconst cleanKeywords = keywords.map(k => String(k).trim().toLowerCase()).filter(k => k.length >= 2).slice(0, 100);\\n\\nif (cleanKeywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'Min 1 valid keyword required', errorCode: 400 }}];\\n}\\n\\nconst locationCodes = { 'TR': 2792, 'US': 2840, 'GB': 2826, 'DE': 2276, 'FR': 2250 };\\n\\nreturn [{ json: { \\n  isValid: true, \\n  keywords: cleanKeywords, \\n  keywordCount: cleanKeywords.length,\\n  projectId: projectId ? parseInt(projectId) : null, \\n  clientId: clientId ? parseInt(clientId) : null,\\n  country, \\n  language, \\n  locationCode: locationCodes[country] || 2792, \\n  startTime: Date.now()\\n}}];"},"id":"53be42af-1d52-4ef5-ab2d-3f5136a21fe2","name":"Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-3376,368]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"valid","leftValue":"={{ $json.isValid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"8e6b16af-d7a1-4596-b75a-35ca35bff086","name":"IF Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-3168,368]},{"parameters":{"respondWith":"json","responseBody":"={ \\"success\\": false, \\"error\\": \\"{{ $json.error }}\\" }","options":{"responseCode":"={{ $json.errorCode }}"}},"id":"87c8b97d-e0f6-40d9-b10d-2e82c4ec3fe5","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-2944,560]},{"parameters":{"jsCode":"// Create items for each seed - will be processed by SplitInBatches\\nconst input = $input.first().json;\\nconst seedKeywords = input.keywords || [];\\n\\nconst items = seedKeywords.map((seed, idx) => ({\\n  json: {\\n    seed: seed,\\n    seedIndex: idx,\\n    projectId: input.projectId,\\n    clientId: input.clientId,\\n    country: input.country,\\n    language: input.language,\\n    locationCode: input.locationCode,\\n    startTime: input.startTime,\\n    totalSeeds: seedKeywords.length,\\n    allSeeds: seedKeywords,\\n    // Accumulator for results\\n    allApproved: [],\\n    allRejected: [],\\n    perSeedStats: {}\\n  }\\n}));\\n\\nreturn items;"},"id":"86ece961-d6a3-4c9f-aec1-abdc6dc96236","name":"Split Seeds","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2944,368]},{"parameters":{"options":{}},"id":"18337128-d293-464b-b47b-b061ec943478","name":"Loop Seeds","type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-2720,368]},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\n  \\"keywords\\": [\\"{{ $json.seed }}\\"],\\n  \\"location_code\\": {{ $json.locationCode }},\\n  \\"language_code\\": \\"{{ $json.language }}\\",\\n  \\"include_seed_keyword\\": true,\\n  \\"sort_by\\": \\"search_volume\\"\\n}]","options":{"timeout":60000}},"id":"a824d77f-9a98-4e0e-ae54-3b6d75bf3a79","name":"DataForSEO","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2496,368],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Parse DataForSEO and build Gemini prompt\\nconst loopItem = $('Loop Seeds').first().json;\\nconst dfs = $input.first().json;\\nconst seed = loopItem.seed;\\n\\nfunction normalize(str) {\\n  return str.toLowerCase().replace(//g,'i').replace(//g,'i').replace(//g,'s').replace(//g,'s')\\n    .replace(//g,'o').replace(//g,'o').replace(//g,'u').replace(//g,'u')\\n    .replace(//g,'c').replace(//g,'c').replace(//g,'g').replace(//g,'g')\\n    .replace(/[^a-z0-9\\\\s]/g,'').replace(/\\\\s+/g,' ').trim();\\n}\\n\\nlet keywords = [];\\ntry {\\n  if (dfs?.tasks?.[0]?.result) {\\n    keywords = dfs.tasks[0].result.map(kw => ({\\n      keyword: (kw.keyword || '').toLowerCase().trim(),\\n      search_volume: kw.search_volume || 0,\\n      cpc: kw.cpc || 0,\\n      competition: kw.competition || null\\n    })).filter(kw => kw.keyword && kw.keyword.length >= 2);\\n  }\\n} catch(e) {}\\n\\n// Dedupe\\nconst seen = new Map();\\nkeywords.forEach(kw => {\\n  const key = normalize(kw.keyword);\\n  if (key.length >= 2 && !seen.has(key)) seen.set(key, kw);\\n});\\nconst unique = Array.from(seen.values()).slice(0, 500);\\n\\n// Build Gemini prompt\\nconst kwCsv = unique.map((kw, i) => `${i+1}|${kw.keyword}|${kw.search_volume}`).join('\\\\n');\\n\\nconst prompt = `\\"${seed}\\" konusu icin keyword analizi.\\n\\nKEYWORDS:\\n${kwCsv}\\n\\nGOREV:\\n1. ANA SONUCLAR (max 35): Icerik/makale olusturmaya EN UYGUN keywordler\\n   - Bagimsiz icerik konusu olabilir mi?\\n   - Arama niyeti net mi?\\n   - Cok genel/cok spesifik marka+model REDDET\\n   - Kalite onemli, 5 iyi > 35 kotu\\n\\n2. DIGER KELIMELER: Geri kalanlar, benzerler birlestirilmis\\n   - fiyat/fiyati/fiyatlari  sadece yuksek hacimli\\n   - 2024/2025 varyasyonlari  sadece biri\\n   - en iyi/en ucuz  sadece biri\\n\\nCIKTI (sadece 2 satir):\\nCONTENT:1,5,12,23,45\\nOTHERS:2,3,8,15,22,31`;\\n\\nreturn [{ json: {\\n  ...loopItem,\\n  keywords: unique,\\n  keywordCount: unique.length,\\n  prompt: prompt\\n}}];"},"id":"b65a5a18-fdf1-4c04-8443-ae7b839ccbb3","name":"Parse DataForSEO","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2288,368]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{ \\"parts\\": [{ \\"text\\": {{ JSON.stringify($json.prompt) }} }] }],\\n  \\"generationConfig\\": { \\"temperature\\": 0.2, \\"maxOutputTokens\\": 8192 }\\n}","options":{"timeout":120000}},"id":"8df7baaa-83d8-4801-aa2c-17915ca4e704","name":"Gemini Filter","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2064,368],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Parse Gemini response and accumulate results\\nconst prev = $('Parse DataForSEO').first().json;\\nconst gemini = $input.first().json;\\nconst seed = prev.seed;\\nconst keywords = prev.keywords || [];\\n\\nconst approved = [];\\nconst rejected = [];\\n\\ntry {\\n  const text = gemini?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  \\n  // Parse CONTENT\\n  const contentMatch = text.match(/CONTENT[:\\\\s]*([0-9,\\\\s]+)/i);\\n  const contentNos = contentMatch \\n    ? contentMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n) && n > 0 && n <= keywords.length) \\n    : [];\\n  \\n  // Parse OTHERS\\n  const othersMatch = text.match(/OTHERS[:\\\\s]*([0-9,\\\\s]+)/i);\\n  const othersNos = othersMatch \\n    ? othersMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n) && n > 0 && n <= keywords.length) \\n    : [];\\n  \\n  contentNos.forEach(no => {\\n    const kw = keywords[no - 1];\\n    if (kw) {\\n      approved.push({\\n        keyword: kw.keyword,\\n        seed_keyword: seed,\\n        search_volume: kw.search_volume,\\n        cpc: kw.cpc,\\n        competition: kw.competition,\\n        status: 'approved',\\n        intent: 'informational',\\n        priority: kw.search_volume >= 5000 ? 'high' : kw.search_volume >= 1000 ? 'medium' : 'low',\\n        content_type: 'cluster'\\n      });\\n    }\\n  });\\n  \\n  othersNos.forEach(no => {\\n    const kw = keywords[no - 1];\\n    if (kw) {\\n      rejected.push({\\n        keyword: kw.keyword,\\n        seed_keyword: seed,\\n        search_volume: kw.search_volume,\\n        status: 'rejected',\\n        reject_reason: 'Filtered'\\n      });\\n    }\\n  });\\n  \\n} catch(e) {\\n  // Fallback\\n  const sorted = [...keywords].sort((a,b) => (b.search_volume||0) - (a.search_volume||0));\\n  sorted.slice(0, 35).forEach(kw => {\\n    approved.push({ keyword: kw.keyword, seed_keyword: seed, search_volume: kw.search_volume, status: 'approved', intent: 'informational', priority: 'medium', content_type: 'cluster' });\\n  });\\n  sorted.slice(35).forEach(kw => {\\n    rejected.push({ keyword: kw.keyword, seed_keyword: seed, search_volume: kw.search_volume, status: 'rejected', reject_reason: 'Fallback' });\\n  });\\n}\\n\\nreturn [{ json: {\\n  seed: seed,\\n  seedIndex: prev.seedIndex,\\n  approved: approved,\\n  rejected: rejected,\\n  approvedCount: approved.length,\\n  rejectedCount: rejected.length,\\n  projectId: prev.projectId,\\n  clientId: prev.clientId,\\n  startTime: prev.startTime,\\n  totalSeeds: prev.totalSeeds,\\n  allSeeds: prev.allSeeds\\n}}];"},"id":"059072a2-58c2-4850-88c4-7c3b22a17096","name":"Parse Gemini","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1840,368]},{"parameters":{"jsCode":"// Accumulate results from all seeds\\nconst currentItem = $input.first().json;\\nconst context = $getWorkflowStaticData('global');\\n\\n// Initialize accumulator\\nif (!context.results) {\\n  context.results = {\\n    allApproved: [],\\n    allRejected: [],\\n    perSeed: {},\\n    projectId: currentItem.projectId,\\n    clientId: currentItem.clientId,\\n    startTime: currentItem.startTime,\\n    allSeeds: currentItem.allSeeds,\\n    totalSeeds: currentItem.totalSeeds,\\n    processedSeeds: 0\\n  };\\n}\\n\\n// Add current seed results\\ncontext.results.allApproved.push(...(currentItem.approved || []));\\ncontext.results.allRejected.push(...(currentItem.rejected || []));\\ncontext.results.perSeed[currentItem.seed] = {\\n  approved: currentItem.approvedCount,\\n  others: currentItem.rejectedCount\\n};\\ncontext.results.processedSeeds++;\\n\\n// Check if all seeds processed\\nconst allDone = context.results.processedSeeds >= context.results.totalSeeds;\\n\\nreturn [{ json: {\\n  ...currentItem,\\n  allDone: allDone,\\n  accumulated: context.results\\n}}];"},"id":"3338de74-64ec-4db3-8a94-14b7a95df79f","name":"Accumulate","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1616,368]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"done","leftValue":"={{ $json.allDone }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"37c0bca2-da86-47fd-a60e-155eb2010763","name":"IF All Done","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1408,368]},{"parameters":{"jsCode":"// Final combination\\nconst acc = $input.first().json.accumulated;\\n\\n// Clear static data for next run\\nconst context = $getWorkflowStaticData('global');\\ndelete context.results;\\n\\nreturn [{ json: {\\n  projectId: acc.projectId,\\n  clientId: acc.clientId,\\n  mainKeyword: acc.allSeeds[0] || '',\\n  keywords: acc.allSeeds,\\n  stats: {\\n    total_seeds: acc.totalSeeds,\\n    total_approved: acc.allApproved.length,\\n    total_others: acc.allRejected.length,\\n    per_seed: acc.perSeed\\n  },\\n  approved_keywords: acc.allApproved,\\n  rejected_keywords: acc.allRejected,\\n  startTime: acc.startTime\\n}}];"},"id":"4fd615c3-9b37-424c-a214-c0761abcc8b2","name":"Finalize","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1184,272]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"has-project","leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}],"combinator":"and"},"options":{}},"id":"745bc80a-a546-4345-b7b3-58fbda20c3b1","name":"IF Save DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[-960,272]},{"parameters":{"jsCode":"const data = $input.first().json;\\nconst projectId = data.projectId;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\nconst all = [...approved, ...rejected];\\n\\nif (all.length === 0) return [{ json: { ...data, batchQuery: 'SELECT 1' }}];\\n\\nfunction esc(s) {\\n  if (s === null || s === undefined) return 'NULL';\\n  return \\"'\\" + String(s).replace(/\\\\\\\\/g,'\\\\\\\\\\\\\\\\').replace(/'/g,\\"''\\") + \\"'\\";\\n}\\n\\nconst vals = all.slice(0, 2000).map(kw => {\\n  return `(${projectId}, ${esc(kw.keyword)}, ${esc(kw.seed_keyword)}, 'related', ${kw.search_volume || 'NULL'}, ${kw.cpc || 'NULL'}, ${esc(kw.competition)}, ${esc(kw.intent)}, ${esc(kw.seed_keyword)}, ${esc(kw.priority)}, ${esc(kw.content_type)}, 'dataforseo', '${kw.status || 'pending'}', ${esc(kw.reject_reason)})`;\\n}).join(',\\\\n');\\n\\nconst query = `INSERT INTO keyword_results (project_id, keyword, seed_keyword, keyword_type, search_volume, cpc, competition, search_intent, keyword_cluster, content_priority, page_type, source, status, reject_reason) VALUES ${vals} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume), status=VALUES(status), seed_keyword=VALUES(seed_keyword)`;\\n\\nreturn [{ json: { ...data, batchQuery: query }}];"},"id":"8f84b105-91de-4996-8e14-4ffd9157fd4f","name":"Prepare Insert","type":"n8n-nodes-base.code","typeVersion":2,"position":[-736,160]},{"parameters":{"operation":"executeQuery","query":"={{ $json.batchQuery }}","options":{}},"id":"9f2d319f-477d-494e-82ff-071eb3f22c9c","name":"Save to DB","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-528,160],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const data = $('Prepare Insert').first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi. ${approved.length} ana sonuc, ${rejected.length} diger kelime.`,\\n  project_id: data.projectId,\\n  stats: data.stats,\\n  keywords: approved.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    intent: kw.intent,\\n    priority: kw.priority,\\n    content_type: kw.content_type,\\n    status: kw.status\\n  })),\\n  rejected_keywords: rejected.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    reason: kw.reject_reason\\n  })),\\n  processing_time_ms: Date.now() - data.startTime\\n}}];"},"id":"62aa8869-1606-4a4c-9e02-ec9b796eb750","name":"Response (DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[-304,160]},{"parameters":{"jsCode":"const data = $input.first().json;\\nconst approved = data.approved_keywords || [];\\nconst rejected = data.rejected_keywords || [];\\n\\nreturn [{ json: {\\n  success: true,\\n  message: `Bulk tamamlandi (DB yok). ${approved.length} ana sonuc, ${rejected.length} diger kelime.`,\\n  project_id: null,\\n  stats: data.stats,\\n  keywords: approved.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    intent: kw.intent,\\n    priority: kw.priority,\\n    content_type: kw.content_type,\\n    status: kw.status\\n  })),\\n  rejected_keywords: rejected.map(kw => ({\\n    keyword: kw.keyword,\\n    seed_keyword: kw.seed_keyword,\\n    search_volume: kw.search_volume,\\n    reason: kw.reject_reason\\n  })),\\n  processing_time_ms: Date.now() - data.startTime\\n}}];"},"id":"52be8073-380b-4a22-aa1a-015181130f86","name":"Response (No DB)","type":"n8n-nodes-base.code","typeVersion":2,"position":[-736,368]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"47651392-516e-42a9-b59c-3829269139ed","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-80,272]}]	{"Webhook Bulk":{"main":[[{"node":"Validate Input","type":"main","index":0}]]},"Validate Input":{"main":[[{"node":"IF Valid","type":"main","index":0}]]},"IF Valid":{"main":[[{"node":"Split Seeds","type":"main","index":0}],[{"node":"Respond Error","type":"main","index":0}]]},"Split Seeds":{"main":[[{"node":"Loop Seeds","type":"main","index":0}]]},"Loop Seeds":{"main":[[{"node":"DataForSEO","type":"main","index":0}]]},"DataForSEO":{"main":[[{"node":"Parse DataForSEO","type":"main","index":0}]]},"Parse DataForSEO":{"main":[[{"node":"Gemini Filter","type":"main","index":0}]]},"Gemini Filter":{"main":[[{"node":"Parse Gemini","type":"main","index":0}]]},"Parse Gemini":{"main":[[{"node":"Accumulate","type":"main","index":0}]]},"Accumulate":{"main":[[{"node":"IF All Done","type":"main","index":0}]]},"IF All Done":{"main":[[{"node":"Finalize","type":"main","index":0}],[{"node":"Loop Seeds","type":"main","index":0}]]},"Finalize":{"main":[[{"node":"IF Save DB","type":"main","index":0}]]},"IF Save DB":{"main":[[{"node":"Prepare Insert","type":"main","index":0}],[{"node":"Response (No DB)","type":"main","index":0}]]},"Prepare Insert":{"main":[[{"node":"Save to DB","type":"main","index":0}]]},"Save to DB":{"main":[[{"node":"Response (DB)","type":"main","index":0}]]},"Response (DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]},"Response (No DB)":{"main":[[{"node":"Respond Success","type":"main","index":0}]]}}	\N	f	\N
65a6c6ae-a211-4ab3-853b-d77f1454b066	adol4O3V4iGsGXpf	Fatih Berkay Baheci	2025-12-23 14:23:09+00	2025-12-23 14:23:09+00	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"d9771960-8335-4765-8cb5-38403b95f7fe","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-736,160],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"const body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\n\\nif (!Array.isArray(keywords) || keywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'keywords array required', errorCode: 400 }}];\\n}\\n\\nconst cleanKeywords = keywords.map(k => String(k).trim().toLowerCase()).filter(k => k.length >= 2).slice(0, 100);\\n\\nif (cleanKeywords.length === 0) {\\n  return [{ json: { isValid: false, error: 'Min 1 valid keyword required', errorCode: 400 }}];\\n}\\n\\nconst locationCodes = { 'TR': 2792, 'US': 2840, 'GB': 2826, 'DE': 2276, 'FR': 2250 };\\n\\n// Create one item per seed for sequential processing\\nconst items = cleanKeywords.map((seed, idx) => ({\\n  json: {\\n    seed: seed,\\n    seedIndex: idx,\\n    totalSeeds: cleanKeywords.length,\\n    allSeeds: cleanKeywords,\\n    projectId: projectId ? parseInt(projectId) : null,\\n    clientId: clientId ? parseInt(clientId) : null,\\n    country,\\n    language,\\n    locationCode: locationCodes[country] || 2792,\\n    startTime: Date.now()\\n  }\\n}));\\n\\nreturn items;"},"id":"2353ad1e-75c9-4e06-b04b-123db822ff5f","name":"Validate & Split","type":"n8n-nodes-base.code","typeVersion":2,"position":[-528,160]},{"parameters":{"options":{}},"id":"d56b8e5f-749a-4cca-86d0-c9876cb20384","name":"Process Each Seed","type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-304,160]},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\n  \\"keywords\\": [\\"{{ $json.seed }}\\"],\\n  \\"location_code\\": {{ $json.locationCode }},\\n  \\"language_code\\": \\"{{ $json.language }}\\",\\n  \\"include_seed_keyword\\": true,\\n  \\"sort_by\\": \\"search_volume\\"\\n}]","options":{"timeout":60000}},"id":"492fc2fd-9fe0-43a7-b7a2-8d78ca90d245","name":"DataForSEO","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-80,160],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const batch = $('Process Each Seed').first().json;\\nconst dfs = $input.first().json;\\nconst seed = batch.seed;\\n\\nlet keywords = [];\\ntry {\\n  if (dfs?.tasks?.[0]?.result) {\\n    keywords = dfs.tasks[0].result.map(kw => ({\\n      keyword: (kw.keyword || '').toLowerCase().trim(),\\n      volume: kw.search_volume || 0,\\n      cpc: kw.cpc || 0\\n    })).filter(kw => kw.keyword.length >= 2);\\n  }\\n} catch(e) {}\\n\\n// Dedupe\\nconst seen = new Set();\\nconst unique = keywords.filter(kw => {\\n  const key = kw.keyword.replace(/[]/g, c => 'iissoouuccgg'[''.indexOf(c)]);\\n  if (seen.has(key)) return false;\\n  seen.add(key);\\n  return true;\\n}).slice(0, 500);\\n\\nconst kwList = unique.map((k,i) => `${i+1}|${k.keyword}|${k.volume}`).join('\\\\n');\\n\\nconst prompt = `\\"${seed}\\" icin anahtar kelime analizi.\\n\\nLISTE:\\n${kwList}\\n\\n## ANA SONUCLAR (max 35)\\nIcerik olusturmaya uygun olanlar. Kriterler:\\n- Makale konusu olabilir mi?\\n- Arama amaci belli mi?\\n- Cok genel veya marka+model REDDET\\n\\n## DIGER\\nKalanlar, benzerler birlesik (fiyat/fiyati/fiyatlari  1 tane)\\n\\nCIKTI:\\nCONTENT:1,5,8,12\\nOTHERS:2,3,6,9,11`;\\n\\nreturn [{ json: { ...batch, keywords: unique, prompt } }];"},"id":"111a1402-157f-47d9-873c-c38206e80e31","name":"Parse DFS","type":"n8n-nodes-base.code","typeVersion":2,"position":[144,160]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\n  \\"contents\\": [{ \\"parts\\": [{ \\"text\\": {{ JSON.stringify($json.prompt) }} }] }],\\n  \\"generationConfig\\": { \\"temperature\\": 0.2, \\"maxOutputTokens\\": 8192 }\\n}","options":{"timeout":90000}},"id":"a24cae8f-098c-48bf-b32f-d8cd8c1371e6","name":"Gemini","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[368,160],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const prev = $('Parse DFS').first().json;\\nconst gemini = $input.first().json;\\nconst seed = prev.seed;\\nconst kws = prev.keywords || [];\\n\\nconst approved = [], rejected = [];\\n\\ntry {\\n  const txt = gemini?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  \\n  const cMatch = txt.match(/CONTENT[:\\\\s]*([\\\\d,\\\\s]+)/i);\\n  const oMatch = txt.match(/OTHERS[:\\\\s]*([\\\\d,\\\\s]+)/i);\\n  \\n  const cNos = cMatch ? cMatch[1].split(',').map(n=>parseInt(n.trim())).filter(n=>n>0&&n<=kws.length) : [];\\n  const oNos = oMatch ? oMatch[1].split(',').map(n=>parseInt(n.trim())).filter(n=>n>0&&n<=kws.length) : [];\\n  \\n  cNos.forEach(n => {\\n    const k = kws[n-1];\\n    if(k) approved.push({keyword:k.keyword, seed_keyword:seed, search_volume:k.volume, status:'approved', priority:k.volume>=5000?'high':k.volume>=1000?'medium':'low'});\\n  });\\n  \\n  oNos.forEach(n => {\\n    const k = kws[n-1];\\n    if(k) rejected.push({keyword:k.keyword, seed_keyword:seed, search_volume:k.volume, status:'rejected'});\\n  });\\n} catch(e) {\\n  // Fallback: top 35\\n  kws.sort((a,b)=>b.volume-a.volume).slice(0,35).forEach(k=>approved.push({keyword:k.keyword,seed_keyword:seed,search_volume:k.volume,status:'approved',priority:'medium'}));\\n  kws.slice(35).forEach(k=>rejected.push({keyword:k.keyword,seed_keyword:seed,search_volume:k.volume,status:'rejected'}));\\n}\\n\\n// Save to static data\\nconst ctx = $getWorkflowStaticData('global');\\nif(!ctx.results) ctx.results = {approved:[],rejected:[],perSeed:{},projectId:prev.projectId,clientId:prev.clientId,startTime:prev.startTime,allSeeds:prev.allSeeds};\\nctx.results.approved.push(...approved);\\nctx.results.rejected.push(...rejected);\\nctx.results.perSeed[seed] = {approved:approved.length, others:rejected.length};\\n\\nreturn [{json:{seed,done:true}}];"},"id":"911b5eaf-07cc-414a-8e4e-bb25a2a03631","name":"Parse Gemini","type":"n8n-nodes-base.code","typeVersion":2,"position":[592,160]},{"parameters":{},"id":"a7126c86-2eb2-41b4-a753-e98c135ca50c","name":"Continue Loop","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[800,160]},{"parameters":{"jsCode":"// Get accumulated results\\nconst ctx = $getWorkflowStaticData('global');\\nconst r = ctx.results || {approved:[],rejected:[],perSeed:{},allSeeds:[]};\\n\\n// Clear for next run\\ndelete ctx.results;\\n\\nreturn [{json:{\\n  projectId: r.projectId,\\n  clientId: r.clientId,\\n  mainKeyword: r.allSeeds?.[0] || '',\\n  keywords: r.allSeeds || [],\\n  stats: {total_seeds:r.allSeeds?.length||0, total_approved:r.approved.length, total_others:r.rejected.length, per_seed:r.perSeed},\\n  approved_keywords: r.approved,\\n  rejected_keywords: r.rejected,\\n  startTime: r.startTime\\n}}];"},"id":"d2b4be60-56af-481b-a450-4546373fdf81","name":"Finalize","type":"n8n-nodes-base.code","typeVersion":2,"position":[1024,368]},{"parameters":{"conditions":{"options":{"leftValue":"","typeValidation":"loose"},"conditions":[{"leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}]},"options":{}},"id":"84007778-a139-4db1-a6e3-15b4348beb69","name":"IF DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[1248,368]},{"parameters":{"jsCode":"const d = $input.first().json;\\nconst all = [...(d.approved_keywords||[]), ...(d.rejected_keywords||[])];\\nif(!all.length || !d.projectId) return [{json:{...d,query:'SELECT 1'}}];\\n\\nconst esc = s => s==null?'NULL':\\"'\\"+String(s).replace(/'/g,\\"''\\")+\\"'\\";\\nconst vals = all.slice(0,2000).map(k=>`(${d.projectId},${esc(k.keyword)},${esc(k.seed_keyword)},'related',${k.search_volume||'NULL'},NULL,NULL,NULL,${esc(k.seed_keyword)},${esc(k.priority)},'cluster','dataforseo','${k.status}',NULL)`).join(',');\\n\\nreturn [{json:{...d,query:`INSERT INTO keyword_results(project_id,keyword,seed_keyword,keyword_type,search_volume,cpc,competition,search_intent,keyword_cluster,content_priority,page_type,source,status,reject_reason)VALUES ${vals} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume),status=VALUES(status)`}}];"},"id":"e53e543c-d384-4d7d-ad3f-df79a6a668ca","name":"Build SQL","type":"n8n-nodes-base.code","typeVersion":2,"position":[1472,272]},{"parameters":{"operation":"executeQuery","query":"={{ $json.query }}","options":{}},"id":"f07e1627-ba88-4a94-972a-04c77b30e11b","name":"MySQL","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[1680,272],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const d = $('Build SQL').first().json;\\nreturn [{json:{success:true,message:`Bulk: ${d.approved_keywords?.length||0} ana, ${d.rejected_keywords?.length||0} diger`,project_id:d.projectId,stats:d.stats,keywords:d.approved_keywords,rejected_keywords:d.rejected_keywords}}];"},"id":"2d15bedb-550b-4130-aa0b-41b649b1be5f","name":"Response DB","type":"n8n-nodes-base.code","typeVersion":2,"position":[1904,272]},{"parameters":{"jsCode":"const d = $input.first().json;\\nreturn [{json:{success:true,message:`Bulk: ${d.approved_keywords?.length||0} ana, ${d.rejected_keywords?.length||0} diger`,project_id:null,stats:d.stats,keywords:d.approved_keywords,rejected_keywords:d.rejected_keywords}}];"},"id":"e4c77e48-f470-484d-805e-e3216afe0c1a","name":"Response No DB","type":"n8n-nodes-base.code","typeVersion":2,"position":[1472,464]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"dbc0a0d0-ae92-4e93-affe-8a6a6ef02bc1","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[2128,368]}]	{"Webhook":{"main":[[{"node":"Validate & Split","type":"main","index":0}]]},"Validate & Split":{"main":[[{"node":"Process Each Seed","type":"main","index":0}]]},"Process Each Seed":{"main":[[{"node":"DataForSEO","type":"main","index":0}],[{"node":"Finalize","type":"main","index":0}]]},"DataForSEO":{"main":[[{"node":"Parse DFS","type":"main","index":0}]]},"Parse DFS":{"main":[[{"node":"Gemini","type":"main","index":0}]]},"Gemini":{"main":[[{"node":"Parse Gemini","type":"main","index":0}]]},"Parse Gemini":{"main":[[{"node":"Continue Loop","type":"main","index":0}]]},"Continue Loop":{"main":[[{"node":"Process Each Seed","type":"main","index":0}]]},"Finalize":{"main":[[{"node":"IF DB","type":"main","index":0}]]},"IF DB":{"main":[[{"node":"Build SQL","type":"main","index":0}],[{"node":"Response No DB","type":"main","index":0}]]},"Build SQL":{"main":[[{"node":"MySQL","type":"main","index":0}]]},"MySQL":{"main":[[{"node":"Response DB","type":"main","index":0}]]},"Response DB":{"main":[[{"node":"Respond","type":"main","index":0}]]},"Response No DB":{"main":[[{"node":"Respond","type":"main","index":0}]]}}	\N	f	\N
e06053c4-e931-487a-94ae-31c187226716	adol4O3V4iGsGXpf	Fatih Berkay Baheci	2025-12-23 14:31:12.425+00	2025-12-23 14:31:12.425+00	[{"parameters":{"httpMethod":"POST","path":"bulk-keyword-research","responseMode":"responseNode","options":{}},"id":"3594851f-00c8-48d9-9743-3ca4781d724e","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1536,112],"webhookId":"bulk-keyword-research"},{"parameters":{"jsCode":"const body = $json.body || $json;\\nconst keywords = body.keywords || [];\\nconst projectId = body.project_id;\\nconst clientId = body.client_id;\\nconst country = (body.country || 'TR').toUpperCase();\\nconst language = body.language || 'tr';\\n\\nif (!keywords.length) return [{json:{error:'keywords required',code:400}}];\\n\\nconst seeds = keywords.map(k => String(k).trim().toLowerCase()).filter(k => k.length >= 2).slice(0, 50);\\nif (!seeds.length) return [{json:{error:'valid keywords required',code:400}}];\\n\\nconst locCodes = {TR:2792,US:2840,GB:2826,DE:2276};\\n\\nreturn [{json:{\\n  seeds,\\n  projectId: projectId ? parseInt(projectId) : null,\\n  clientId: clientId ? parseInt(clientId) : null,\\n  locationCode: locCodes[country] || 2792,\\n  language,\\n  startTime: Date.now()\\n}}];"},"id":"2604818f-822e-4086-988e-c69d92b5c7f8","name":"Validate","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1328,112]},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\"keywords\\": {{ JSON.stringify($json.seeds) }}, \\"location_code\\": {{ $json.locationCode }}, \\"language_code\\": \\"{{ $json.language }}\\", \\"include_seed_keyword\\": true, \\"sort_by\\": \\"search_volume\\"}]","options":{"timeout":90000}},"id":"a41f6e74-7ef6-47f5-8b22-f2160be1dbb6","name":"DataForSEO","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1104,112],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const prev = $('Validate').first().json;\\nconst dfs = $input.first().json;\\nconst seeds = prev.seeds;\\n\\n// Parse keywords\\nlet allKw = [];\\ntry {\\n  if (dfs?.tasks?.[0]?.result) {\\n    allKw = dfs.tasks[0].result.map(k => ({\\n      kw: (k.keyword||'').toLowerCase().trim(),\\n      vol: k.search_volume||0,\\n      cpc: k.cpc||0\\n    })).filter(k => k.kw.length >= 2);\\n  }\\n} catch(e) {}\\n\\n// Dedupe\\nconst seen = new Set();\\nconst unique = allKw.filter(k => {\\n  if (seen.has(k.kw)) return false;\\n  seen.add(k.kw);\\n  return true;\\n}).slice(0, 2000);\\n\\n// Build mega prompt - classification + filtering in one\\nconst seedList = seeds.map((s,i) => `${i+1}. ${s}`).join('\\\\n');\\nconst kwList = unique.map((k,i) => `${i+1}|${k.kw}|${k.vol}`).join('\\\\n');\\n\\nconst prompt = `GOREV: Her keyword'u dogru SEED ile eslestir ve icerik uygunlugunu degerlendir.\\n\\nSEED'LER:\\n${seedList}\\n\\nKEYWORDS (no|keyword|volume):\\n${kwList}\\n\\nKURALLAR:\\n1. Her keyword EN UYGUN seed ile eslesir (anlamsal, marka, kategori)\\n2. Alakasiz = seed 0\\n3. Her seed icin MAX 35 icerige uygun keyword sec (ANA)\\n4. Geri kalanlar DIGER (benzerler birlestir: fiyat/fiyati1 tane)\\n\\nCIKTI FORMATI - HER SEED ICIN:\\n[SEED_NO]\\nANA:1,5,12,23\\nDIGER:2,8,15,31\\n\\nOrnek:\\n[1]\\nANA:3,7,15,22,45\\nDIGER:2,9,18,33,41\\n\\n[2]\\nANA:1,6,19,28\\nDIGER:4,11,24,37\\n\\nSADECE NUMARALAR. ACIKLAMA YOK.`;\\n\\nreturn [{json:{...prev, keywords: unique, prompt}}];"},"id":"4a8a5a7a-80bc-43d1-9151-b1c1d0875378","name":"Parse DFS","type":"n8n-nodes-base.code","typeVersion":2,"position":[-880,112]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\"contents\\":[{\\"parts\\":[{\\"text\\":{{ JSON.stringify($json.prompt) }}}]}],\\"generationConfig\\":{\\"temperature\\":0.15,\\"maxOutputTokens\\":65536}}","options":{"timeout":180000}},"id":"5a1e38b4-8601-4262-af39-37faecc16a87","name":"Gemini","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-656,112],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const prev = $('Parse DFS').first().json;\\nconst gemini = $input.first().json;\\nconst seeds = prev.seeds;\\nconst kws = prev.keywords;\\n\\nconst approved = [];\\nconst rejected = [];\\nconst perSeed = {};\\n\\ntry {\\n  const txt = gemini?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  \\n  // Parse each seed block\\n  const blocks = txt.split(/\\\\[\\\\s*(\\\\d+)\\\\s*\\\\]/).filter(b => b.trim());\\n  \\n  for (let i = 0; i < blocks.length - 1; i += 2) {\\n    const seedIdx = parseInt(blocks[i]) - 1;\\n    const content = blocks[i + 1];\\n    \\n    if (seedIdx < 0 || seedIdx >= seeds.length) continue;\\n    const seed = seeds[seedIdx];\\n    \\n    // Parse ANA line\\n    const anaMatch = content.match(/ANA[:\\\\s]*([\\\\d,\\\\s]+)/i);\\n    const anaNos = anaMatch ? anaMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => n > 0 && n <= kws.length) : [];\\n    \\n    // Parse DIGER line\\n    const digerMatch = content.match(/DIGER[:\\\\s]*([\\\\d,\\\\s]+)/i);\\n    const digerNos = digerMatch ? digerMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => n > 0 && n <= kws.length) : [];\\n    \\n    anaNos.forEach(n => {\\n      const k = kws[n-1];\\n      if (k) approved.push({keyword: k.kw, seed_keyword: seed, search_volume: k.vol, cpc: k.cpc, status: 'approved', priority: k.vol >= 5000 ? 'high' : k.vol >= 1000 ? 'medium' : 'low'});\\n    });\\n    \\n    digerNos.forEach(n => {\\n      const k = kws[n-1];\\n      if (k) rejected.push({keyword: k.kw, seed_keyword: seed, search_volume: k.vol, status: 'rejected'});\\n    });\\n    \\n    perSeed[seed] = {approved: anaNos.length, others: digerNos.length};\\n  }\\n} catch(e) {\\n  // Fallback: distribute evenly\\n  const perSeedCount = Math.ceil(kws.length / seeds.length);\\n  seeds.forEach((seed, si) => {\\n    const start = si * perSeedCount;\\n    const chunk = kws.slice(start, start + perSeedCount).sort((a,b) => b.vol - a.vol);\\n    chunk.slice(0, 35).forEach(k => approved.push({keyword: k.kw, seed_keyword: seed, search_volume: k.vol, status: 'approved', priority: 'medium'}));\\n    chunk.slice(35).forEach(k => rejected.push({keyword: k.kw, seed_keyword: seed, search_volume: k.vol, status: 'rejected'}));\\n    perSeed[seed] = {approved: Math.min(35, chunk.length), others: Math.max(0, chunk.length - 35)};\\n  });\\n}\\n\\nreturn [{json:{\\n  projectId: prev.projectId,\\n  clientId: prev.clientId,\\n  seeds: seeds,\\n  stats: {total_seeds: seeds.length, total_approved: approved.length, total_others: rejected.length, per_seed: perSeed},\\n  approved_keywords: approved,\\n  rejected_keywords: rejected,\\n  startTime: prev.startTime\\n}}];"},"id":"5d84465b-2a7e-4ee0-967a-ba94bb4d8992","name":"Parse Gemini","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,112]},{"parameters":{"conditions":{"options":{"leftValue":"","typeValidation":"loose"},"conditions":[{"leftValue":"={{ $json.projectId }}","rightValue":true,"operator":{"type":"boolean","operation":"exists"}}]},"options":{}},"id":"76d90745-07d8-4224-8690-3de4e058dbd3","name":"IF DB","type":"n8n-nodes-base.if","typeVersion":2,"position":[-224,112]},{"parameters":{"jsCode":"const d = $input.first().json;\\nconst all = [...(d.approved_keywords||[]), ...(d.rejected_keywords||[])];\\nif (!all.length || !d.projectId) return [{json:{...d, query:'SELECT 1'}}];\\n\\nconst esc = s => s == null ? 'NULL' : \\"'\\" + String(s).replace(/'/g, \\"''\\") + \\"'\\";\\nconst vals = all.slice(0, 2000).map(k => \\n  `(${d.projectId},${esc(k.keyword)},${esc(k.seed_keyword)},'related',${k.search_volume||'NULL'},${k.cpc||'NULL'},NULL,NULL,${esc(k.seed_keyword)},${esc(k.priority)},'cluster','dataforseo','${k.status}',NULL)`\\n).join(',');\\n\\nreturn [{json:{...d, query:`INSERT INTO keyword_results(project_id,keyword,seed_keyword,keyword_type,search_volume,cpc,competition,search_intent,keyword_cluster,content_priority,page_type,source,status,reject_reason) VALUES ${vals} ON DUPLICATE KEY UPDATE search_volume=VALUES(search_volume),status=VALUES(status),seed_keyword=VALUES(seed_keyword)`}}];"},"id":"d0208b95-0789-45d0-a64a-8a3798943f36","name":"Build SQL","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,0]},{"parameters":{"operation":"executeQuery","query":"={{ $json.query }}","options":{}},"id":"da623ab2-0b34-44c8-ab8f-09b30eabca66","name":"MySQL","type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[224,0],"credentials":{"mySql":{"id":"1rDLBK64lV00T0am","name":"SEO Suite MySQL"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const d = $('Build SQL').first().json;\\nreturn [{json:{\\n  success: true,\\n  message: `Bulk: ${d.approved_keywords?.length||0} ana sonuc, ${d.rejected_keywords?.length||0} diger kelime`,\\n  project_id: d.projectId,\\n  stats: d.stats,\\n  keywords: (d.approved_keywords||[]).map(k => ({keyword:k.keyword, seed_keyword:k.seed_keyword, search_volume:k.search_volume, priority:k.priority, status:k.status})),\\n  rejected_keywords: (d.rejected_keywords||[]).map(k => ({keyword:k.keyword, seed_keyword:k.seed_keyword, search_volume:k.search_volume})),\\n  processing_time_ms: Date.now() - d.startTime\\n}}];"},"id":"30cb9238-546d-4fba-a8d3-bc4387b18f35","name":"Response DB","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"jsCode":"const d = $input.first().json;\\nreturn [{json:{\\n  success: true,\\n  message: `Bulk: ${d.approved_keywords?.length||0} ana sonuc, ${d.rejected_keywords?.length||0} diger kelime`,\\n  project_id: null,\\n  stats: d.stats,\\n  keywords: (d.approved_keywords||[]).map(k => ({keyword:k.keyword, seed_keyword:k.seed_keyword, search_volume:k.search_volume, priority:k.priority, status:k.status})),\\n  rejected_keywords: (d.rejected_keywords||[]).map(k => ({keyword:k.keyword, seed_keyword:k.seed_keyword, search_volume:k.search_volume})),\\n  processing_time_ms: Date.now() - d.startTime\\n}}];"},"id":"1c7862c4-8e30-4c25-83df-5073b8ef870f","name":"Response No DB","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,208]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"7b425ed5-aa71-4c23-9733-205bb3d39a5a","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[672,112]}]	{"Webhook":{"main":[[{"node":"Validate","type":"main","index":0}]]},"Validate":{"main":[[{"node":"DataForSEO","type":"main","index":0}]]},"DataForSEO":{"main":[[{"node":"Parse DFS","type":"main","index":0}]]},"Parse DFS":{"main":[[{"node":"Gemini","type":"main","index":0}]]},"Gemini":{"main":[[{"node":"Parse Gemini","type":"main","index":0}]]},"Parse Gemini":{"main":[[{"node":"IF DB","type":"main","index":0}]]},"IF DB":{"main":[[{"node":"Build SQL","type":"main","index":0}],[{"node":"Response No DB","type":"main","index":0}]]},"Build SQL":{"main":[[{"node":"MySQL","type":"main","index":0}]]},"MySQL":{"main":[[{"node":"Response DB","type":"main","index":0}]]},"Response DB":{"main":[[{"node":"Respond","type":"main","index":0}]]},"Response No DB":{"main":[[{"node":"Respond","type":"main","index":0}]]}}	\N	f	\N
8e91f2e2-5f5d-4823-b13e-39c5e22e33b8	MhHeIUZBSMtqRRrR	Fatih Berkay Baheci	2025-12-23 19:36:44.405+00	2025-12-23 19:36:44.405+00	[{"parameters":{},"id":"9551624f-74db-43f6-baa2-74c54978a94d","name":"Execute Workflow Trigger","type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[0,0]},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\"keywords\\": [\\"{{ $json.seed }}\\"], \\"location_code\\": {{ $json.locationCode }}, \\"language_code\\": \\"{{ $json.language }}\\", \\"include_seed_keyword\\": true, \\"sort_by\\": \\"search_volume\\"}]","options":{"timeout":60000}},"id":"c897d41a-5a5d-4676-b7da-09de70a560ef","name":"DataForSEO","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[224,0],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const input = $('Execute Workflow Trigger').first().json;\\nconst dfs = $input.first().json;\\nconst seed = input.seed;\\n\\nlet keywords = [];\\ntry {\\n  if (dfs?.tasks?.[0]?.result) {\\n    keywords = dfs.tasks[0].result.map(k => ({\\n      kw: (k.keyword || '').toLowerCase().trim(),\\n      vol: k.search_volume || 0,\\n      cpc: k.cpc || 0\\n    })).filter(k => k.kw.length >= 2);\\n  }\\n} catch(e) {}\\n\\n// Dedupe\\nconst seen = new Set();\\nconst unique = keywords.filter(k => {\\n  if (seen.has(k.kw)) return false;\\n  seen.add(k.kw);\\n  return true;\\n}).slice(0, 500);\\n\\nif (unique.length === 0) {\\n  return [{json: {\\n    seed,\\n    approved: [],\\n    rejected: [],\\n    stats: {approved: 0, rejected: 0}\\n  }}];\\n}\\n\\nconst kwList = unique.map((k, i) => `${i+1}|${k.kw}|${k.vol}`).join('\\\\n');\\n\\nconst prompt = `\\"${seed}\\" icin anahtar kelime analizi.\\n\\nKEYWORDS (no|keyword|volume):\\n${kwList}\\n\\nGOREV:\\n1. Icerik olusturmaya UYGUN olanlari sec (max 35 adet)\\n   - Blog/makale konusu olabilir mi?\\n   - Arama amaci net mi?\\n   - Bilgi verici icerik yazilabilir mi?\\n   \\n2. UYGUN OLMAYANLAR:\\n   - Sadece marka+model (ornek: \\"nike air max 90\\")\\n   - Cok genel (ornek: \\"ayakkabi\\")\\n   - Fiyat sorgulari (ornek: \\"spor ayakkabi fiyatlari\\")\\n   - Satin alma niyetli (ornek: \\"spor ayakkabi satin al\\")\\n\\n3. Benzer kelimeler tek secilsin:\\n   - fiyat/fiyati/fiyatlari  sadece 1 tane\\n   - erkek/erkekler  sadece 1 tane\\n\\nCIKTI FORMATI (SADECE BU SATIRLAR):\\nCONTENT:1,5,8,12,15\\nOTHERS:2,3,4,6,7,9,10,11,13,14\\n\\nACIKLAMA YAZMA. SADECE NUMARALAR.`;\\n\\nreturn [{json: {...input, keywords: unique, prompt}}];"},"id":"afb4b45f-e748-4de4-963b-189bf9a5bf0c","name":"Parse DFS","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\"contents\\":[{\\"parts\\":[{\\"text\\":{{ JSON.stringify($json.prompt) }}}]}],\\"generationConfig\\":{\\"temperature\\":0.1,\\"maxOutputTokens\\":4096}}","options":{"timeout":60000}},"id":"b19c829b-7d25-4077-ba39-bcf53a5e32c6","name":"Gemini","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[672,0],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const prev = $('Parse DFS').first().json;\\nconst gemini = $input.first().json;\\nconst seed = prev.seed;\\nconst kws = prev.keywords || [];\\n\\nconst approved = [];\\nconst rejected = [];\\n\\ntry {\\n  const txt = gemini?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  \\n  // Parse CONTENT line\\n  const contentMatch = txt.match(/CONTENT[:\\\\s]*([\\\\d,\\\\s]+)/i);\\n  const contentNos = contentMatch \\n    ? contentMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => n > 0 && n <= kws.length)\\n    : [];\\n  \\n  // Parse OTHERS line\\n  const othersMatch = txt.match(/OTHERS[:\\\\s]*([\\\\d,\\\\s]+)/i);\\n  const othersNos = othersMatch\\n    ? othersMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => n > 0 && n <= kws.length)\\n    : [];\\n  \\n  // Build approved list\\n  contentNos.forEach(n => {\\n    const k = kws[n - 1];\\n    if (k) {\\n      approved.push({\\n        keyword: k.kw,\\n        seed_keyword: seed,\\n        search_volume: k.vol,\\n        cpc: k.cpc,\\n        status: 'approved',\\n        priority: k.vol >= 5000 ? 'high' : k.vol >= 1000 ? 'medium' : 'low'\\n      });\\n    }\\n  });\\n  \\n  // Build rejected list\\n  othersNos.forEach(n => {\\n    const k = kws[n - 1];\\n    if (k) {\\n      rejected.push({\\n        keyword: k.kw,\\n        seed_keyword: seed,\\n        search_volume: k.vol,\\n        cpc: k.cpc,\\n        status: 'rejected'\\n      });\\n    }\\n  });\\n  \\n} catch(e) {\\n  // Fallback: top 35 by volume\\n  const sorted = [...kws].sort((a, b) => b.vol - a.vol);\\n  sorted.slice(0, 35).forEach(k => {\\n    approved.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'approved',\\n      priority: k.vol >= 5000 ? 'high' : k.vol >= 1000 ? 'medium' : 'low'\\n    });\\n  });\\n  sorted.slice(35).forEach(k => {\\n    rejected.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'rejected'\\n    });\\n  });\\n}\\n\\n// If no approved from Gemini, fallback\\nif (approved.length === 0 && kws.length > 0) {\\n  const sorted = [...kws].sort((a, b) => b.vol - a.vol);\\n  sorted.slice(0, 35).forEach(k => {\\n    approved.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'approved',\\n      priority: 'medium'\\n    });\\n  });\\n  sorted.slice(35).forEach(k => {\\n    rejected.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'rejected'\\n    });\\n  });\\n}\\n\\nreturn [{json: {\\n  seed,\\n  approved,\\n  rejected,\\n  stats: {\\n    approved: approved.length,\\n    rejected: rejected.length\\n  }\\n}}];"},"id":"764a7100-885f-490a-9764-1ea8d7d38cca","name":"Parse Gemini","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,0]}]	{"Execute Workflow Trigger":{"main":[[{"node":"DataForSEO","type":"main","index":0}]]},"DataForSEO":{"main":[[{"node":"Parse DFS","type":"main","index":0}]]},"Parse DFS":{"main":[[{"node":"Gemini","type":"main","index":0}]]},"Gemini":{"main":[[{"node":"Parse Gemini","type":"main","index":0}]]}}	\N	f	\N
2c3f8f8d-f586-4262-ae2d-e85f3ccbd935	MhHeIUZBSMtqRRrR	Fatih Berkay Baheci	2025-12-23 19:54:55.213+00	2025-12-23 19:54:55.213+00	[{"parameters":{},"id":"908e6211-af91-4ad5-b2b9-2ef3806d7bfd","name":"Execute Workflow Trigger","type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1,"position":[0,0]},{"parameters":{"method":"POST","url":"https://api.dataforseo.com/v3/keywords_data/google_ads/keywords_for_keywords/live","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Basic b2t0YXlAc2VvYXJ0LmNvbTo0ODk2ZGRhYzQ2OWUyZjIw"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=[{\\"keywords\\": [\\"{{ $json.seed }}\\"], \\"location_code\\": {{ $json.locationCode }}, \\"language_code\\": \\"{{ $json.language }}\\", \\"include_seed_keyword\\": true, \\"sort_by\\": \\"search_volume\\"}]","options":{"timeout":60000}},"id":"4d7a9a87-7a72-4699-a225-6f54bc4668aa","name":"DataForSEO","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[224,0],"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const input = $('Execute Workflow Trigger').first().json;\\nconst dfs = $input.first().json;\\nconst seed = input.seed;\\n\\nlet keywords = [];\\ntry {\\n  if (dfs?.tasks?.[0]?.result) {\\n    keywords = dfs.tasks[0].result.map(k => ({\\n      kw: (k.keyword || '').toLowerCase().trim(),\\n      vol: k.search_volume || 0,\\n      cpc: k.cpc || 0\\n    })).filter(k => k.kw.length >= 2);\\n  }\\n} catch(e) {}\\n\\n// Dedupe\\nconst seen = new Set();\\nconst unique = keywords.filter(k => {\\n  if (seen.has(k.kw)) return false;\\n  seen.add(k.kw);\\n  return true;\\n}).slice(0, 500);\\n\\nif (unique.length === 0) {\\n  return [{json: {\\n    seed,\\n    approved: [],\\n    rejected: [],\\n    stats: {approved: 0, rejected: 0}\\n  }}];\\n}\\n\\nconst kwList = unique.map((k, i) => `${i+1}|${k.kw}|${k.vol}`).join('\\\\n');\\n\\nconst prompt = `\\"${seed}\\" icin anahtar kelime analizi.\\n\\nKEYWORDS (no|keyword|volume):\\n${kwList}\\n\\nGOREV:\\n1. Icerik olusturmaya UYGUN olanlari sec (max 35 adet)\\n   - Blog/makale konusu olabilir mi?\\n   - Arama amaci net mi?\\n   - Bilgi verici icerik yazilabilir mi?\\n   \\n2. UYGUN OLMAYANLAR:\\n   - Sadece marka+model (ornek: \\"nike air max 90\\")\\n   - Cok genel (ornek: \\"ayakkabi\\")\\n   - Fiyat sorgulari (ornek: \\"spor ayakkabi fiyatlari\\")\\n   - Satin alma niyetli (ornek: \\"spor ayakkabi satin al\\")\\n\\n3. Benzer kelimeler tek secilsin:\\n   - fiyat/fiyati/fiyatlari  sadece 1 tane\\n   - erkek/erkekler  sadece 1 tane\\n\\nCIKTI FORMATI (SADECE BU SATIRLAR):\\nCONTENT:1,5,8,12,15\\nOTHERS:2,3,4,6,7,9,10,11,13,14\\n\\nACIKLAMA YAZMA. SADECE NUMARALAR.`;\\n\\nreturn [{json: {...input, keywords: unique, prompt}}];"},"id":"6302aac9-0e7a-4769-8c0a-5687fe36c7bc","name":"Parse DFS","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,0]},{"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","authentication":"genericCredentialType","genericAuthType":"httpQueryAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\\"contents\\":[{\\"parts\\":[{\\"text\\":{{ JSON.stringify($json.prompt) }}}]}],\\"generationConfig\\":{\\"temperature\\":0.1,\\"maxOutputTokens\\":4096}}","options":{"timeout":60000}},"id":"302ecb84-712e-4c82-9254-7d050959f37b","name":"Gemini","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[672,0],"credentials":{"httpQueryAuth":{"id":"Hp8gTY1C1efbSfkx","name":"Gemini API"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const prev = $('Parse DFS').first().json;\\nconst gemini = $input.first().json;\\nconst seed = prev.seed;\\nconst kws = prev.keywords || [];\\n\\nconst approved = [];\\nconst rejected = [];\\n\\ntry {\\n  const txt = gemini?.candidates?.[0]?.content?.parts?.[0]?.text || '';\\n  \\n  // Parse CONTENT line\\n  const contentMatch = txt.match(/CONTENT[:\\\\s]*([\\\\d,\\\\s]+)/i);\\n  const contentNos = contentMatch \\n    ? contentMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => n > 0 && n <= kws.length)\\n    : [];\\n  \\n  // Parse OTHERS line\\n  const othersMatch = txt.match(/OTHERS[:\\\\s]*([\\\\d,\\\\s]+)/i);\\n  const othersNos = othersMatch\\n    ? othersMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => n > 0 && n <= kws.length)\\n    : [];\\n  \\n  // Build approved list\\n  contentNos.forEach(n => {\\n    const k = kws[n - 1];\\n    if (k) {\\n      approved.push({\\n        keyword: k.kw,\\n        seed_keyword: seed,\\n        search_volume: k.vol,\\n        cpc: k.cpc,\\n        status: 'approved',\\n        priority: k.vol >= 5000 ? 'high' : k.vol >= 1000 ? 'medium' : 'low'\\n      });\\n    }\\n  });\\n  \\n  // Build rejected list\\n  othersNos.forEach(n => {\\n    const k = kws[n - 1];\\n    if (k) {\\n      rejected.push({\\n        keyword: k.kw,\\n        seed_keyword: seed,\\n        search_volume: k.vol,\\n        cpc: k.cpc,\\n        status: 'rejected'\\n      });\\n    }\\n  });\\n  \\n} catch(e) {\\n  // Fallback: top 35 by volume\\n  const sorted = [...kws].sort((a, b) => b.vol - a.vol);\\n  sorted.slice(0, 35).forEach(k => {\\n    approved.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'approved',\\n      priority: k.vol >= 5000 ? 'high' : k.vol >= 1000 ? 'medium' : 'low'\\n    });\\n  });\\n  sorted.slice(35).forEach(k => {\\n    rejected.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'rejected'\\n    });\\n  });\\n}\\n\\n// If no approved from Gemini, fallback\\nif (approved.length === 0 && kws.length > 0) {\\n  const sorted = [...kws].sort((a, b) => b.vol - a.vol);\\n  sorted.slice(0, 35).forEach(k => {\\n    approved.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'approved',\\n      priority: 'medium'\\n    });\\n  });\\n  sorted.slice(35).forEach(k => {\\n    rejected.push({\\n      keyword: k.kw,\\n      seed_keyword: seed,\\n      search_volume: k.vol,\\n      cpc: k.cpc,\\n      status: 'rejected'\\n    });\\n  });\\n}\\n\\nreturn [{json: {\\n  seed,\\n  approved,\\n  rejected,\\n  stats: {\\n    approved: approved.length,\\n    rejected: rejected.length\\n  }\\n}}];"},"id":"79a4aa5b-7757-4fde-a3ce-3a00c05f9451","name":"Parse Gemini","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,0]}]	{"Execute Workflow Trigger":{"main":[[{"node":"DataForSEO","type":"main","index":0}]]},"DataForSEO":{"main":[[{"node":"Parse DFS","type":"main","index":0}]]},"Parse DFS":{"main":[[{"node":"Gemini","type":"main","index":0}]]},"Gemini":{"main":[[{"node":"Parse Gemini","type":"main","index":0}]]}}	\N	f	\N
\.


--
-- Data for Name: workflow_publish_history; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.workflow_publish_history (id, "workflowId", "versionId", event, "userId", "createdAt") FROM stdin;
8	nuQVa3YLSJFRC4Ny	057c1d4a-90b8-4bc9-add8-c93e1acd2aa6	activated	ebc04a1a-5b80-4de2-8b65-382c0cd9393c	2025-12-17 10:26:00.903+00
9	WpQy66Cn5XTG9pFD	b9b1ad43-9b8a-43d5-8c9f-05adc54db544	activated	ebc04a1a-5b80-4de2-8b65-382c0cd9393c	2025-12-17 10:26:23.601+00
10	DyGEyObKWBEHrb0B	7c994d64-1fad-4c91-8a09-b1a0adb79c50	activated	ebc04a1a-5b80-4de2-8b65-382c0cd9393c	2025-12-17 10:26:39.9+00
11	yyD1QW0PcJgp3ik2	90411821-db26-46ed-b5ca-3daf1a5ea8f5	activated	ebc04a1a-5b80-4de2-8b65-382c0cd9393c	2025-12-17 10:27:03.137+00
12	6nclsXOjxGhT8qJs	6af1d565-35ba-4e0b-97d9-a109bbb7b16d	activated	ebc04a1a-5b80-4de2-8b65-382c0cd9393c	2025-12-17 10:27:23.907+00
13	r8uQ8T48G7SDp9or	e446236e-cc11-4f88-9622-af72007ff710	activated	ebc04a1a-5b80-4de2-8b65-382c0cd9393c	2025-12-17 10:27:37.311+00
14	yd6UhBrs7iqGeEg6	f0e64617-34fd-4f76-b5f5-07f41216e98e	activated	ebc04a1a-5b80-4de2-8b65-382c0cd9393c	2025-12-17 10:27:51.477+00
15	9wxzOy1QgENPVVSD	d427d382-3336-4aa9-9b50-d3f795ad77ad	activated	ebc04a1a-5b80-4de2-8b65-382c0cd9393c	2025-12-17 10:28:05.938+00
16	UxU00NHUOlNJSpFi	4117e47b-f342-43ae-9f1d-ae8ee30514c7	activated	ebc04a1a-5b80-4de2-8b65-382c0cd9393c	2025-12-17 10:28:21.811+00
17	E29x9qTqO4XIfetR	47de4265-58d6-42c2-9a3d-854120b78853	activated	ebc04a1a-5b80-4de2-8b65-382c0cd9393c	2025-12-17 10:28:39.394+00
18	oCR2cQcwwClAsT55	9c8edff5-626a-40e8-8897-5867882e1542	activated	ebc04a1a-5b80-4de2-8b65-382c0cd9393c	2025-12-17 10:28:52.316+00
19	x03Ivd085mWitZQ9	7ee59fa8-baf4-4e41-a893-81d590e61e86	activated	ebc04a1a-5b80-4de2-8b65-382c0cd9393c	2025-12-17 10:29:04.64+00
20	dKv529VBvG6GzQ7d	3acbc191-abbe-4188-85e8-28351da99233	activated	ebc04a1a-5b80-4de2-8b65-382c0cd9393c	2025-12-17 10:29:26.029+00
21	S0zn4vyawwOhLuuO	c6ba8c4f-fe4b-4ac8-9751-938e63afe4ee	activated	ebc04a1a-5b80-4de2-8b65-382c0cd9393c	2025-12-17 10:30:17.114+00
23	s7JHrKu0WDrkbkzw	73230155-b208-43c1-9cee-280a6e4ebac1	activated	ebc04a1a-5b80-4de2-8b65-382c0cd9393c	2025-12-17 10:32:02.483+00
29	IGWk6RXq1AHpB4L1	41b2d0c6-e47c-47fc-98ba-d3cb742389f0	activated	ebc04a1a-5b80-4de2-8b65-382c0cd9393c	2025-12-18 12:05:23.671+00
30	fkgU1ClgOCaGeuXR	d567b778-8181-432e-80b2-e2aae9143edc	activated	ebc04a1a-5b80-4de2-8b65-382c0cd9393c	2025-12-18 12:05:33.639+00
\.


--
-- Data for Name: workflow_statistics; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.workflow_statistics (count, "latestEvent", name, "workflowId", "rootCount") FROM stdin;
1	2025-12-17 10:32:50.608+00	data_loaded	9wxzOy1QgENPVVSD	1
1	2025-12-19 09:41:15.836+00	data_loaded	cRzztL0RsykZYA9k	1
1	2025-12-17 10:40:12.261+00	data_loaded	yd6UhBrs7iqGeEg6	1
1	2025-12-17 10:41:05.244+00	data_loaded	6nclsXOjxGhT8qJs	1
1	2025-12-17 10:41:30.429+00	data_loaded	x03Ivd085mWitZQ9	1
2	2025-12-17 10:41:33.391+00	production_error	x03Ivd085mWitZQ9	2
1	2025-12-17 11:01:15.315+00	data_loaded	nuQVa3YLSJFRC4Ny	1
1	2025-12-17 14:58:07.094+00	data_loaded	yyD1QW0PcJgp3ik2	1
1	2025-12-17 14:58:07.97+00	production_success	yyD1QW0PcJgp3ik2	1
2	2025-12-17 14:58:09.974+00	production_success	6nclsXOjxGhT8qJs	2
1	2025-12-17 14:58:10.324+00	data_loaded	UxU00NHUOlNJSpFi	1
1	2025-12-17 14:58:11.667+00	production_success	UxU00NHUOlNJSpFi	1
33	2025-12-18 14:58:39.947+00	production_success	yd6UhBrs7iqGeEg6	33
45	2025-12-18 09:44:32.324+00	production_success	nuQVa3YLSJFRC4Ny	45
1	2025-12-18 10:08:28.899+00	data_loaded	WpQy66Cn5XTG9pFD	1
1	2025-12-19 13:17:00.544+00	data_loaded	j3jZIjdsJSchQqCe	1
1	2025-12-23 19:55:30.533+00	data_loaded	wl9T4eOGoazJkDdv	1
2	2025-12-19 13:29:11.249+00	production_error	j3jZIjdsJSchQqCe	2
1	2025-12-23 20:01:38.3+00	data_loaded	mNQs5AgZjCB0MIZx	1
9	2025-12-19 09:52:21.699+00	production_error	cRzztL0RsykZYA9k	9
1	2025-12-19 10:27:07.878+00	data_loaded	IGWk6RXq1AHpB4L1	1
1	2025-12-19 10:28:19.103+00	data_loaded	k21swmfiM5y9Dspc	1
1	2025-12-18 18:58:30.772+00	production_error	9wxzOy1QgENPVVSD	1
3	2025-12-19 13:43:54.112+00	production_error	fkgU1ClgOCaGeuXR	3
27	2025-12-22 19:53:31.826+00	production_success	WpQy66Cn5XTG9pFD	27
4	2025-12-19 10:39:10.882+00	production_error	k21swmfiM5y9Dspc	4
125	2025-12-24 08:20:46.605+00	production_success	9wxzOy1QgENPVVSD	125
1	2025-12-23 08:20:49.52+00	data_loaded	adol4O3V4iGsGXpf	1
2	2025-12-23 08:24:50.87+00	production_error	adol4O3V4iGsGXpf	2
10	2025-12-24 08:21:26.165+00	production_success	mNQs5AgZjCB0MIZx	10
4	2025-12-24 08:21:27.895+00	production_success	wl9T4eOGoazJkDdv	4
22	2025-12-24 08:33:31.894+00	production_success	j3jZIjdsJSchQqCe	22
5	2025-12-21 11:08:11.58+00	production_success	cRzztL0RsykZYA9k	5
7	2025-12-21 11:08:15.357+00	production_success	IGWk6RXq1AHpB4L1	7
30	2025-12-21 11:09:06.82+00	production_success	k21swmfiM5y9Dspc	30
1	2025-12-19 12:01:11.157+00	data_loaded	IoTg8e61J99uOFka	1
1	2025-12-19 12:01:11.849+00	production_success	IoTg8e61J99uOFka	1
1	2025-12-19 12:01:14.326+00	data_loaded	O9VRT7UV70STh36c	1
1	2025-12-19 12:01:15.25+00	production_success	O9VRT7UV70STh36c	1
2	2025-12-21 11:12:08.845+00	production_error	WpQy66Cn5XTG9pFD	2
1	2025-12-19 12:02:53.662+00	data_loaded	fkgU1ClgOCaGeuXR	1
1	2025-12-19 09:15:07.412+00	data_loaded	886MnxYqCbAQ1Bjz	1
4	2025-12-19 09:35:04.495+00	production_success	886MnxYqCbAQ1Bjz	4
1	2025-12-19 12:14:09.552+00	data_loaded	GcCbIVDLCEBXWH4c	1
1	2025-12-19 12:14:10.486+00	production_success	GcCbIVDLCEBXWH4c	1
1	2025-12-19 13:12:39.546+00	production_success	fkgU1ClgOCaGeuXR	1
20	2025-12-23 14:32:51.708+00	production_success	adol4O3V4iGsGXpf	20
1	2025-12-23 19:42:02.688+00	data_loaded	sWwmP23m89DQTpVI	1
2	2025-12-23 19:49:24.087+00	production_success	sWwmP23m89DQTpVI	2
\.


--
-- Data for Name: workflows_tags; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.workflows_tags ("workflowId", "tagId") FROM stdin;
nuQVa3YLSJFRC4Ny	fuSMKRiaWGPmaGru
WpQy66Cn5XTG9pFD	fuSMKRiaWGPmaGru
yyD1QW0PcJgp3ik2	1
6nclsXOjxGhT8qJs	1
r8uQ8T48G7SDp9or	1
yd6UhBrs7iqGeEg6	1
9wxzOy1QgENPVVSD	1
UxU00NHUOlNJSpFi	1
E29x9qTqO4XIfetR	1
oCR2cQcwwClAsT55	1
dKv529VBvG6GzQ7d	1
s7JHrKu0WDrkbkzw	Ezxn5KBS7wZlyQuW
xqZA3Veie70f1PZI	fuSMKRiaWGPmaGru
886MnxYqCbAQ1Bjz	1
j3jZIjdsJSchQqCe	1
adol4O3V4iGsGXpf	1
\.


--
-- Name: auth_provider_sync_history_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.auth_provider_sync_history_id_seq', 1, false);


--
-- Name: execution_annotations_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.execution_annotations_id_seq', 1, false);


--
-- Name: execution_entity_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.execution_entity_id_seq', 719, true);


--
-- Name: execution_metadata_temp_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.execution_metadata_temp_id_seq', 1, false);


--
-- Name: insights_by_period_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.insights_by_period_id_seq', 304, true);


--
-- Name: insights_metadata_metaId_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public."insights_metadata_metaId_seq"', 73, true);


--
-- Name: insights_raw_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.insights_raw_id_seq', 930, true);


--
-- Name: migrations_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.migrations_id_seq', 123, true);


--
-- Name: oauth_user_consents_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.oauth_user_consents_id_seq', 1, false);


--
-- Name: workflow_dependency_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.workflow_dependency_id_seq', 265, true);


--
-- Name: workflow_publish_history_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.workflow_publish_history_id_seq', 32, true);


--
-- Name: test_run PK_011c050f566e9db509a0fadb9b9; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.test_run
    ADD CONSTRAINT "PK_011c050f566e9db509a0fadb9b9" PRIMARY KEY (id);


--
-- Name: installed_packages PK_08cc9197c39b028c1e9beca225940576fd1a5804; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.installed_packages
    ADD CONSTRAINT "PK_08cc9197c39b028c1e9beca225940576fd1a5804" PRIMARY KEY ("packageName");


--
-- Name: execution_metadata PK_17a0b6284f8d626aae88e1c16e4; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.execution_metadata
    ADD CONSTRAINT "PK_17a0b6284f8d626aae88e1c16e4" PRIMARY KEY (id);


--
-- Name: project_relation PK_1caaa312a5d7184a003be0f0cb6; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.project_relation
    ADD CONSTRAINT "PK_1caaa312a5d7184a003be0f0cb6" PRIMARY KEY ("projectId", "userId");


--
-- Name: chat_hub_sessions PK_1eafef1273c70e4464fec703412; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.chat_hub_sessions
    ADD CONSTRAINT "PK_1eafef1273c70e4464fec703412" PRIMARY KEY (id);


--
-- Name: folder_tag PK_27e4e00852f6b06a925a4d83a3e; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.folder_tag
    ADD CONSTRAINT "PK_27e4e00852f6b06a925a4d83a3e" PRIMARY KEY ("folderId", "tagId");


--
-- Name: role PK_35c9b140caaf6da09cfabb0d675; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.role
    ADD CONSTRAINT "PK_35c9b140caaf6da09cfabb0d675" PRIMARY KEY (slug);


--
-- Name: project PK_4d68b1358bb5b766d3e78f32f57; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.project
    ADD CONSTRAINT "PK_4d68b1358bb5b766d3e78f32f57" PRIMARY KEY (id);


--
-- Name: workflow_dependency PK_52325e34cd7a2f0f67b0f3cad65; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_dependency
    ADD CONSTRAINT "PK_52325e34cd7a2f0f67b0f3cad65" PRIMARY KEY (id);


--
-- Name: invalid_auth_token PK_5779069b7235b256d91f7af1a15; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.invalid_auth_token
    ADD CONSTRAINT "PK_5779069b7235b256d91f7af1a15" PRIMARY KEY (token);


--
-- Name: shared_workflow PK_5ba87620386b847201c9531c58f; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.shared_workflow
    ADD CONSTRAINT "PK_5ba87620386b847201c9531c58f" PRIMARY KEY ("workflowId", "projectId");


--
-- Name: folder PK_6278a41a706740c94c02e288df8; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.folder
    ADD CONSTRAINT "PK_6278a41a706740c94c02e288df8" PRIMARY KEY (id);


--
-- Name: data_table_column PK_673cb121ee4a8a5e27850c72c51; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.data_table_column
    ADD CONSTRAINT "PK_673cb121ee4a8a5e27850c72c51" PRIMARY KEY (id);


--
-- Name: annotation_tag_entity PK_69dfa041592c30bbc0d4b84aa00; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.annotation_tag_entity
    ADD CONSTRAINT "PK_69dfa041592c30bbc0d4b84aa00" PRIMARY KEY (id);


--
-- Name: oauth_refresh_tokens PK_74abaed0b30711b6532598b0392; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.oauth_refresh_tokens
    ADD CONSTRAINT "PK_74abaed0b30711b6532598b0392" PRIMARY KEY (token);


--
-- Name: chat_hub_messages PK_7704a5add6baed43eef835f0bfb; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.chat_hub_messages
    ADD CONSTRAINT "PK_7704a5add6baed43eef835f0bfb" PRIMARY KEY (id);


--
-- Name: execution_annotations PK_7afcf93ffa20c4252869a7c6a23; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.execution_annotations
    ADD CONSTRAINT "PK_7afcf93ffa20c4252869a7c6a23" PRIMARY KEY (id);


--
-- Name: oauth_user_consents PK_85b9ada746802c8993103470f05; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.oauth_user_consents
    ADD CONSTRAINT "PK_85b9ada746802c8993103470f05" PRIMARY KEY (id);


--
-- Name: migrations PK_8c82d7f526340ab734260ea46be; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.migrations
    ADD CONSTRAINT "PK_8c82d7f526340ab734260ea46be" PRIMARY KEY (id);


--
-- Name: installed_nodes PK_8ebd28194e4f792f96b5933423fc439df97d9689; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.installed_nodes
    ADD CONSTRAINT "PK_8ebd28194e4f792f96b5933423fc439df97d9689" PRIMARY KEY (name);


--
-- Name: shared_credentials PK_8ef3a59796a228913f251779cff; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.shared_credentials
    ADD CONSTRAINT "PK_8ef3a59796a228913f251779cff" PRIMARY KEY ("credentialsId", "projectId");


--
-- Name: test_case_execution PK_90c121f77a78a6580e94b794bce; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.test_case_execution
    ADD CONSTRAINT "PK_90c121f77a78a6580e94b794bce" PRIMARY KEY (id);


--
-- Name: user_api_keys PK_978fa5caa3468f463dac9d92e69; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_api_keys
    ADD CONSTRAINT "PK_978fa5caa3468f463dac9d92e69" PRIMARY KEY (id);


--
-- Name: execution_annotation_tags PK_979ec03d31294cca484be65d11f; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.execution_annotation_tags
    ADD CONSTRAINT "PK_979ec03d31294cca484be65d11f" PRIMARY KEY ("annotationId", "tagId");


--
-- Name: webhook_entity PK_b21ace2e13596ccd87dc9bf4ea6; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.webhook_entity
    ADD CONSTRAINT "PK_b21ace2e13596ccd87dc9bf4ea6" PRIMARY KEY ("webhookPath", method);


--
-- Name: insights_by_period PK_b606942249b90cc39b0265f0575; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.insights_by_period
    ADD CONSTRAINT "PK_b606942249b90cc39b0265f0575" PRIMARY KEY (id);


--
-- Name: workflow_history PK_b6572dd6173e4cd06fe79937b58; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_history
    ADD CONSTRAINT "PK_b6572dd6173e4cd06fe79937b58" PRIMARY KEY ("versionId");


--
-- Name: scope PK_bfc45df0481abd7f355d6187da1; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.scope
    ADD CONSTRAINT "PK_bfc45df0481abd7f355d6187da1" PRIMARY KEY (slug);


--
-- Name: oauth_clients PK_c4759172d3431bae6f04e678e0d; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.oauth_clients
    ADD CONSTRAINT "PK_c4759172d3431bae6f04e678e0d" PRIMARY KEY (id);


--
-- Name: workflow_publish_history PK_c788f7caf88e91e365c97d6d04a; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_publish_history
    ADD CONSTRAINT "PK_c788f7caf88e91e365c97d6d04a" PRIMARY KEY (id);


--
-- Name: processed_data PK_ca04b9d8dc72de268fe07a65773; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.processed_data
    ADD CONSTRAINT "PK_ca04b9d8dc72de268fe07a65773" PRIMARY KEY ("workflowId", context);


--
-- Name: settings PK_dc0fe14e6d9943f268e7b119f69ab8bd; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.settings
    ADD CONSTRAINT "PK_dc0fe14e6d9943f268e7b119f69ab8bd" PRIMARY KEY (key);


--
-- Name: oauth_access_tokens PK_dcd71f96a5d5f4bf79e67d322bf; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.oauth_access_tokens
    ADD CONSTRAINT "PK_dcd71f96a5d5f4bf79e67d322bf" PRIMARY KEY (token);


--
-- Name: data_table PK_e226d0001b9e6097cbfe70617cb; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.data_table
    ADD CONSTRAINT "PK_e226d0001b9e6097cbfe70617cb" PRIMARY KEY (id);


--
-- Name: user PK_ea8f538c94b6e352418254ed6474a81f; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public."user"
    ADD CONSTRAINT "PK_ea8f538c94b6e352418254ed6474a81f" PRIMARY KEY (id);


--
-- Name: insights_raw PK_ec15125755151e3a7e00e00014f; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.insights_raw
    ADD CONSTRAINT "PK_ec15125755151e3a7e00e00014f" PRIMARY KEY (id);


--
-- Name: chat_hub_agents PK_f39a3b36bbdf0e2979ddb21cf78; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.chat_hub_agents
    ADD CONSTRAINT "PK_f39a3b36bbdf0e2979ddb21cf78" PRIMARY KEY (id);


--
-- Name: insights_metadata PK_f448a94c35218b6208ce20cf5a1; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.insights_metadata
    ADD CONSTRAINT "PK_f448a94c35218b6208ce20cf5a1" PRIMARY KEY ("metaId");


--
-- Name: oauth_authorization_codes PK_fb91ab932cfbd694061501cc20f; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.oauth_authorization_codes
    ADD CONSTRAINT "PK_fb91ab932cfbd694061501cc20f" PRIMARY KEY (code);


--
-- Name: binary_data PK_fc3691585b39408bb0551122af6; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.binary_data
    ADD CONSTRAINT "PK_fc3691585b39408bb0551122af6" PRIMARY KEY ("fileId");


--
-- Name: role_scope PK_role_scope; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.role_scope
    ADD CONSTRAINT "PK_role_scope" PRIMARY KEY ("roleSlug", "scopeSlug");


--
-- Name: oauth_user_consents UQ_083721d99ce8db4033e2958ebb4; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.oauth_user_consents
    ADD CONSTRAINT "UQ_083721d99ce8db4033e2958ebb4" UNIQUE ("userId", "clientId");


--
-- Name: data_table_column UQ_8082ec4890f892f0bc77473a123; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.data_table_column
    ADD CONSTRAINT "UQ_8082ec4890f892f0bc77473a123" UNIQUE ("dataTableId", name);


--
-- Name: data_table UQ_b23096ef747281ac944d28e8b0d; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.data_table
    ADD CONSTRAINT "UQ_b23096ef747281ac944d28e8b0d" UNIQUE ("projectId", name);


--
-- Name: user UQ_e12875dfb3b1d92d7d7c5377e2; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public."user"
    ADD CONSTRAINT "UQ_e12875dfb3b1d92d7d7c5377e2" UNIQUE (email);


--
-- Name: auth_identity auth_identity_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.auth_identity
    ADD CONSTRAINT auth_identity_pkey PRIMARY KEY ("providerId", "providerType");


--
-- Name: auth_provider_sync_history auth_provider_sync_history_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.auth_provider_sync_history
    ADD CONSTRAINT auth_provider_sync_history_pkey PRIMARY KEY (id);


--
-- Name: credentials_entity credentials_entity_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.credentials_entity
    ADD CONSTRAINT credentials_entity_pkey PRIMARY KEY (id);


--
-- Name: event_destinations event_destinations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.event_destinations
    ADD CONSTRAINT event_destinations_pkey PRIMARY KEY (id);


--
-- Name: execution_data execution_data_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.execution_data
    ADD CONSTRAINT execution_data_pkey PRIMARY KEY ("executionId");


--
-- Name: execution_entity pk_e3e63bbf986767844bbe1166d4e; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.execution_entity
    ADD CONSTRAINT pk_e3e63bbf986767844bbe1166d4e PRIMARY KEY (id);


--
-- Name: workflow_statistics pk_workflow_statistics; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_statistics
    ADD CONSTRAINT pk_workflow_statistics PRIMARY KEY ("workflowId", name);


--
-- Name: workflows_tags pk_workflows_tags; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflows_tags
    ADD CONSTRAINT pk_workflows_tags PRIMARY KEY ("workflowId", "tagId");


--
-- Name: tag_entity tag_entity_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.tag_entity
    ADD CONSTRAINT tag_entity_pkey PRIMARY KEY (id);


--
-- Name: variables variables_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.variables
    ADD CONSTRAINT variables_pkey PRIMARY KEY (id);


--
-- Name: workflow_entity workflow_entity_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_entity
    ADD CONSTRAINT workflow_entity_pkey PRIMARY KEY (id);


--
-- Name: IDX_070b5de842ece9ccdda0d9738b; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX "IDX_070b5de842ece9ccdda0d9738b" ON public.workflow_publish_history USING btree ("workflowId", "versionId");


--
-- Name: IDX_14f68deffaf858465715995508; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX "IDX_14f68deffaf858465715995508" ON public.folder USING btree ("projectId", id);


--
-- Name: IDX_1d8ab99d5861c9388d2dc1cf73; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX "IDX_1d8ab99d5861c9388d2dc1cf73" ON public.insights_metadata USING btree ("workflowId");


--
-- Name: IDX_1e31657f5fe46816c34be7c1b4; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX "IDX_1e31657f5fe46816c34be7c1b4" ON public.workflow_history USING btree ("workflowId");


--
-- Name: IDX_1ef35bac35d20bdae979d917a3; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX "IDX_1ef35bac35d20bdae979d917a3" ON public.user_api_keys USING btree ("apiKey");


--
-- Name: IDX_56900edc3cfd16612e2ef2c6a8; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX "IDX_56900edc3cfd16612e2ef2c6a8" ON public.binary_data USING btree ("sourceType", "sourceId");


--
-- Name: IDX_5f0643f6717905a05164090dde; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX "IDX_5f0643f6717905a05164090dde" ON public.project_relation USING btree ("userId");


--
-- Name: IDX_60b6a84299eeb3f671dfec7693; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX "IDX_60b6a84299eeb3f671dfec7693" ON public.insights_by_period USING btree ("periodStart", type, "periodUnit", "metaId");


--
-- Name: IDX_61448d56d61802b5dfde5cdb00; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX "IDX_61448d56d61802b5dfde5cdb00" ON public.project_relation USING btree ("projectId");


--
-- Name: IDX_63d7bbae72c767cf162d459fcc; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX "IDX_63d7bbae72c767cf162d459fcc" ON public.user_api_keys USING btree ("userId", label);


--
-- Name: IDX_8e4b4774db42f1e6dda3452b2a; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX "IDX_8e4b4774db42f1e6dda3452b2a" ON public.test_case_execution USING btree ("testRunId");


--
-- Name: IDX_97f863fa83c4786f1956508496; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX "IDX_97f863fa83c4786f1956508496" ON public.execution_annotations USING btree ("executionId");


--
-- Name: IDX_UniqueRoleDisplayName; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX "IDX_UniqueRoleDisplayName" ON public.role USING btree ("displayName");


--
-- Name: IDX_a3697779b366e131b2bbdae297; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX "IDX_a3697779b366e131b2bbdae297" ON public.execution_annotation_tags USING btree ("tagId");


--
-- Name: IDX_a4ff2d9b9628ea988fa9e7d0bf; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX "IDX_a4ff2d9b9628ea988fa9e7d0bf" ON public.workflow_dependency USING btree ("workflowId");


--
-- Name: IDX_ae51b54c4bb430cf92f48b623f; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX "IDX_ae51b54c4bb430cf92f48b623f" ON public.annotation_tag_entity USING btree (name);


--
-- Name: IDX_c1519757391996eb06064f0e7c; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX "IDX_c1519757391996eb06064f0e7c" ON public.execution_annotation_tags USING btree ("annotationId");


--
-- Name: IDX_cec8eea3bf49551482ccb4933e; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX "IDX_cec8eea3bf49551482ccb4933e" ON public.execution_metadata USING btree ("executionId", key);


--
-- Name: IDX_d6870d3b6e4c185d33926f423c; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX "IDX_d6870d3b6e4c185d33926f423c" ON public.test_run USING btree ("workflowId");


--
-- Name: IDX_e48a201071ab85d9d09119d640; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX "IDX_e48a201071ab85d9d09119d640" ON public.workflow_dependency USING btree ("dependencyKey");


--
-- Name: IDX_e7fe1cfda990c14a445937d0b9; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX "IDX_e7fe1cfda990c14a445937d0b9" ON public.workflow_dependency USING btree ("dependencyType");


--
-- Name: IDX_execution_entity_deletedAt; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX "IDX_execution_entity_deletedAt" ON public.execution_entity USING btree ("deletedAt");


--
-- Name: IDX_role_scope_scopeSlug; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX "IDX_role_scope_scopeSlug" ON public.role_scope USING btree ("scopeSlug");


--
-- Name: IDX_workflow_entity_name; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX "IDX_workflow_entity_name" ON public.workflow_entity USING btree (name);


--
-- Name: idx_07fde106c0b471d8cc80a64fc8; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_07fde106c0b471d8cc80a64fc8 ON public.credentials_entity USING btree (type);


--
-- Name: idx_16f4436789e804e3e1c9eeb240; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_16f4436789e804e3e1c9eeb240 ON public.webhook_entity USING btree ("webhookId", method, "pathLength");


--
-- Name: idx_812eb05f7451ca757fb98444ce; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_812eb05f7451ca757fb98444ce ON public.tag_entity USING btree (name);


--
-- Name: idx_execution_entity_stopped_at_status_deleted_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_execution_entity_stopped_at_status_deleted_at ON public.execution_entity USING btree ("stoppedAt", status, "deletedAt") WHERE (("stoppedAt" IS NOT NULL) AND ("deletedAt" IS NULL));


--
-- Name: idx_execution_entity_wait_till_status_deleted_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_execution_entity_wait_till_status_deleted_at ON public.execution_entity USING btree ("waitTill", status, "deletedAt") WHERE (("waitTill" IS NOT NULL) AND ("deletedAt" IS NULL));


--
-- Name: idx_execution_entity_workflow_id_started_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_execution_entity_workflow_id_started_at ON public.execution_entity USING btree ("workflowId", "startedAt") WHERE (("startedAt" IS NOT NULL) AND ("deletedAt" IS NULL));


--
-- Name: idx_workflows_tags_workflow_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workflows_tags_workflow_id ON public.workflows_tags USING btree ("workflowId");


--
-- Name: pk_credentials_entity_id; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX pk_credentials_entity_id ON public.credentials_entity USING btree (id);


--
-- Name: pk_tag_entity_id; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX pk_tag_entity_id ON public.tag_entity USING btree (id);


--
-- Name: pk_workflow_entity_id; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX pk_workflow_entity_id ON public.workflow_entity USING btree (id);


--
-- Name: project_relation_role_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX project_relation_role_idx ON public.project_relation USING btree (role);


--
-- Name: project_relation_role_project_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX project_relation_role_project_idx ON public.project_relation USING btree ("projectId", role);


--
-- Name: user_role_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX user_role_idx ON public."user" USING btree ("roleSlug");


--
-- Name: variables_global_key_unique; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX variables_global_key_unique ON public.variables USING btree (key) WHERE ("projectId" IS NULL);


--
-- Name: variables_project_key_unique; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX variables_project_key_unique ON public.variables USING btree ("projectId", key) WHERE ("projectId" IS NOT NULL);


--
-- Name: workflow_entity workflow_version_increment; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER workflow_version_increment BEFORE UPDATE ON public.workflow_entity FOR EACH ROW EXECUTE FUNCTION public.increment_workflow_version();


--
-- Name: processed_data FK_06a69a7032c97a763c2c7599464; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.processed_data
    ADD CONSTRAINT "FK_06a69a7032c97a763c2c7599464" FOREIGN KEY ("workflowId") REFERENCES public.workflow_entity(id) ON DELETE CASCADE;


--
-- Name: workflow_entity FK_08d6c67b7f722b0039d9d5ed620; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_entity
    ADD CONSTRAINT "FK_08d6c67b7f722b0039d9d5ed620" FOREIGN KEY ("activeVersionId") REFERENCES public.workflow_history("versionId") ON DELETE RESTRICT;


--
-- Name: insights_metadata FK_1d8ab99d5861c9388d2dc1cf733; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.insights_metadata
    ADD CONSTRAINT "FK_1d8ab99d5861c9388d2dc1cf733" FOREIGN KEY ("workflowId") REFERENCES public.workflow_entity(id) ON DELETE SET NULL;


--
-- Name: workflow_history FK_1e31657f5fe46816c34be7c1b4b; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_history
    ADD CONSTRAINT "FK_1e31657f5fe46816c34be7c1b4b" FOREIGN KEY ("workflowId") REFERENCES public.workflow_entity(id) ON DELETE CASCADE;


--
-- Name: chat_hub_messages FK_1f4998c8a7dec9e00a9ab15550e; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.chat_hub_messages
    ADD CONSTRAINT "FK_1f4998c8a7dec9e00a9ab15550e" FOREIGN KEY ("revisionOfMessageId") REFERENCES public.chat_hub_messages(id) ON DELETE CASCADE;


--
-- Name: oauth_user_consents FK_21e6c3c2d78a097478fae6aaefa; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.oauth_user_consents
    ADD CONSTRAINT "FK_21e6c3c2d78a097478fae6aaefa" FOREIGN KEY ("userId") REFERENCES public."user"(id) ON DELETE CASCADE;


--
-- Name: insights_metadata FK_2375a1eda085adb16b24615b69c; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.insights_metadata
    ADD CONSTRAINT "FK_2375a1eda085adb16b24615b69c" FOREIGN KEY ("projectId") REFERENCES public.project(id) ON DELETE SET NULL;


--
-- Name: chat_hub_messages FK_25c9736e7f769f3a005eef4b372; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.chat_hub_messages
    ADD CONSTRAINT "FK_25c9736e7f769f3a005eef4b372" FOREIGN KEY ("retryOfMessageId") REFERENCES public.chat_hub_messages(id) ON DELETE CASCADE;


--
-- Name: execution_metadata FK_31d0b4c93fb85ced26f6005cda3; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.execution_metadata
    ADD CONSTRAINT "FK_31d0b4c93fb85ced26f6005cda3" FOREIGN KEY ("executionId") REFERENCES public.execution_entity(id) ON DELETE CASCADE;


--
-- Name: shared_credentials FK_416f66fc846c7c442970c094ccf; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.shared_credentials
    ADD CONSTRAINT "FK_416f66fc846c7c442970c094ccf" FOREIGN KEY ("credentialsId") REFERENCES public.credentials_entity(id) ON DELETE CASCADE;


--
-- Name: variables FK_42f6c766f9f9d2edcc15bdd6e9b; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.variables
    ADD CONSTRAINT "FK_42f6c766f9f9d2edcc15bdd6e9b" FOREIGN KEY ("projectId") REFERENCES public.project(id) ON DELETE CASCADE;


--
-- Name: chat_hub_agents FK_441ba2caba11e077ce3fbfa2cd8; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.chat_hub_agents
    ADD CONSTRAINT "FK_441ba2caba11e077ce3fbfa2cd8" FOREIGN KEY ("ownerId") REFERENCES public."user"(id) ON DELETE CASCADE;


--
-- Name: project_relation FK_5f0643f6717905a05164090dde7; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.project_relation
    ADD CONSTRAINT "FK_5f0643f6717905a05164090dde7" FOREIGN KEY ("userId") REFERENCES public."user"(id) ON DELETE CASCADE;


--
-- Name: project_relation FK_61448d56d61802b5dfde5cdb002; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.project_relation
    ADD CONSTRAINT "FK_61448d56d61802b5dfde5cdb002" FOREIGN KEY ("projectId") REFERENCES public.project(id) ON DELETE CASCADE;


--
-- Name: insights_by_period FK_6414cfed98daabbfdd61a1cfbc0; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.insights_by_period
    ADD CONSTRAINT "FK_6414cfed98daabbfdd61a1cfbc0" FOREIGN KEY ("metaId") REFERENCES public.insights_metadata("metaId") ON DELETE CASCADE;


--
-- Name: oauth_authorization_codes FK_64d965bd072ea24fb6da55468cd; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.oauth_authorization_codes
    ADD CONSTRAINT "FK_64d965bd072ea24fb6da55468cd" FOREIGN KEY ("clientId") REFERENCES public.oauth_clients(id) ON DELETE CASCADE;


--
-- Name: chat_hub_messages FK_6afb260449dd7a9b85355d4e0c9; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.chat_hub_messages
    ADD CONSTRAINT "FK_6afb260449dd7a9b85355d4e0c9" FOREIGN KEY ("executionId") REFERENCES public.execution_entity(id) ON DELETE SET NULL;


--
-- Name: insights_raw FK_6e2e33741adef2a7c5d66befa4e; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.insights_raw
    ADD CONSTRAINT "FK_6e2e33741adef2a7c5d66befa4e" FOREIGN KEY ("metaId") REFERENCES public.insights_metadata("metaId") ON DELETE CASCADE;


--
-- Name: workflow_publish_history FK_6eab5bd9eedabe9c54bd879fc40; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_publish_history
    ADD CONSTRAINT "FK_6eab5bd9eedabe9c54bd879fc40" FOREIGN KEY ("userId") REFERENCES public."user"(id) ON DELETE SET NULL;


--
-- Name: oauth_access_tokens FK_7234a36d8e49a1fa85095328845; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.oauth_access_tokens
    ADD CONSTRAINT "FK_7234a36d8e49a1fa85095328845" FOREIGN KEY ("userId") REFERENCES public."user"(id) ON DELETE CASCADE;


--
-- Name: installed_nodes FK_73f857fc5dce682cef8a99c11dbddbc969618951; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.installed_nodes
    ADD CONSTRAINT "FK_73f857fc5dce682cef8a99c11dbddbc969618951" FOREIGN KEY (package) REFERENCES public.installed_packages("packageName") ON UPDATE CASCADE ON DELETE CASCADE;


--
-- Name: oauth_access_tokens FK_78b26968132b7e5e45b75876481; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.oauth_access_tokens
    ADD CONSTRAINT "FK_78b26968132b7e5e45b75876481" FOREIGN KEY ("clientId") REFERENCES public.oauth_clients(id) ON DELETE CASCADE;


--
-- Name: chat_hub_sessions FK_7bc13b4c7e6afbfaf9be326c189; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.chat_hub_sessions
    ADD CONSTRAINT "FK_7bc13b4c7e6afbfaf9be326c189" FOREIGN KEY ("credentialId") REFERENCES public.credentials_entity(id) ON DELETE SET NULL;


--
-- Name: folder FK_804ea52f6729e3940498bd54d78; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.folder
    ADD CONSTRAINT "FK_804ea52f6729e3940498bd54d78" FOREIGN KEY ("parentFolderId") REFERENCES public.folder(id) ON DELETE CASCADE;


--
-- Name: shared_credentials FK_812c2852270da1247756e77f5a4; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.shared_credentials
    ADD CONSTRAINT "FK_812c2852270da1247756e77f5a4" FOREIGN KEY ("projectId") REFERENCES public.project(id) ON DELETE CASCADE;


--
-- Name: test_case_execution FK_8e4b4774db42f1e6dda3452b2af; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.test_case_execution
    ADD CONSTRAINT "FK_8e4b4774db42f1e6dda3452b2af" FOREIGN KEY ("testRunId") REFERENCES public.test_run(id) ON DELETE CASCADE;


--
-- Name: data_table_column FK_930b6e8faaf88294cef23484160; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.data_table_column
    ADD CONSTRAINT "FK_930b6e8faaf88294cef23484160" FOREIGN KEY ("dataTableId") REFERENCES public.data_table(id) ON DELETE CASCADE;


--
-- Name: folder_tag FK_94a60854e06f2897b2e0d39edba; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.folder_tag
    ADD CONSTRAINT "FK_94a60854e06f2897b2e0d39edba" FOREIGN KEY ("folderId") REFERENCES public.folder(id) ON DELETE CASCADE;


--
-- Name: execution_annotations FK_97f863fa83c4786f19565084960; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.execution_annotations
    ADD CONSTRAINT "FK_97f863fa83c4786f19565084960" FOREIGN KEY ("executionId") REFERENCES public.execution_entity(id) ON DELETE CASCADE;


--
-- Name: chat_hub_agents FK_9c61ad497dcbae499c96a6a78ba; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.chat_hub_agents
    ADD CONSTRAINT "FK_9c61ad497dcbae499c96a6a78ba" FOREIGN KEY ("credentialId") REFERENCES public.credentials_entity(id) ON DELETE SET NULL;


--
-- Name: chat_hub_sessions FK_9f9293d9f552496c40e0d1a8f80; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.chat_hub_sessions
    ADD CONSTRAINT "FK_9f9293d9f552496c40e0d1a8f80" FOREIGN KEY ("workflowId") REFERENCES public.workflow_entity(id) ON DELETE SET NULL;


--
-- Name: execution_annotation_tags FK_a3697779b366e131b2bbdae2976; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.execution_annotation_tags
    ADD CONSTRAINT "FK_a3697779b366e131b2bbdae2976" FOREIGN KEY ("tagId") REFERENCES public.annotation_tag_entity(id) ON DELETE CASCADE;


--
-- Name: shared_workflow FK_a45ea5f27bcfdc21af9b4188560; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.shared_workflow
    ADD CONSTRAINT "FK_a45ea5f27bcfdc21af9b4188560" FOREIGN KEY ("projectId") REFERENCES public.project(id) ON DELETE CASCADE;


--
-- Name: workflow_dependency FK_a4ff2d9b9628ea988fa9e7d0bf8; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_dependency
    ADD CONSTRAINT "FK_a4ff2d9b9628ea988fa9e7d0bf8" FOREIGN KEY ("workflowId") REFERENCES public.workflow_entity(id) ON DELETE CASCADE;


--
-- Name: oauth_user_consents FK_a651acea2f6c97f8c4514935486; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.oauth_user_consents
    ADD CONSTRAINT "FK_a651acea2f6c97f8c4514935486" FOREIGN KEY ("clientId") REFERENCES public.oauth_clients(id) ON DELETE CASCADE;


--
-- Name: oauth_refresh_tokens FK_a699f3ed9fd0c1b19bc2608ac53; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.oauth_refresh_tokens
    ADD CONSTRAINT "FK_a699f3ed9fd0c1b19bc2608ac53" FOREIGN KEY ("userId") REFERENCES public."user"(id) ON DELETE CASCADE;


--
-- Name: folder FK_a8260b0b36939c6247f385b8221; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.folder
    ADD CONSTRAINT "FK_a8260b0b36939c6247f385b8221" FOREIGN KEY ("projectId") REFERENCES public.project(id) ON DELETE CASCADE;


--
-- Name: oauth_authorization_codes FK_aa8d3560484944c19bdf79ffa16; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.oauth_authorization_codes
    ADD CONSTRAINT "FK_aa8d3560484944c19bdf79ffa16" FOREIGN KEY ("userId") REFERENCES public."user"(id) ON DELETE CASCADE;


--
-- Name: chat_hub_messages FK_acf8926098f063cdbbad8497fd1; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.chat_hub_messages
    ADD CONSTRAINT "FK_acf8926098f063cdbbad8497fd1" FOREIGN KEY ("workflowId") REFERENCES public.workflow_entity(id) ON DELETE SET NULL;


--
-- Name: oauth_refresh_tokens FK_b388696ce4d8be7ffbe8d3e4b69; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.oauth_refresh_tokens
    ADD CONSTRAINT "FK_b388696ce4d8be7ffbe8d3e4b69" FOREIGN KEY ("clientId") REFERENCES public.oauth_clients(id) ON DELETE CASCADE;


--
-- Name: workflow_publish_history FK_b4cfbc7556d07f36ca177f5e473; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_publish_history
    ADD CONSTRAINT "FK_b4cfbc7556d07f36ca177f5e473" FOREIGN KEY ("versionId") REFERENCES public.workflow_history("versionId") ON DELETE CASCADE;


--
-- Name: workflow_publish_history FK_c01316f8c2d7101ec4fa9809267; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_publish_history
    ADD CONSTRAINT "FK_c01316f8c2d7101ec4fa9809267" FOREIGN KEY ("workflowId") REFERENCES public.workflow_entity(id) ON DELETE CASCADE;


--
-- Name: execution_annotation_tags FK_c1519757391996eb06064f0e7c8; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.execution_annotation_tags
    ADD CONSTRAINT "FK_c1519757391996eb06064f0e7c8" FOREIGN KEY ("annotationId") REFERENCES public.execution_annotations(id) ON DELETE CASCADE;


--
-- Name: data_table FK_c2a794257dee48af7c9abf681de; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.data_table
    ADD CONSTRAINT "FK_c2a794257dee48af7c9abf681de" FOREIGN KEY ("projectId") REFERENCES public.project(id) ON DELETE CASCADE;


--
-- Name: project_relation FK_c6b99592dc96b0d836d7a21db91; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.project_relation
    ADD CONSTRAINT "FK_c6b99592dc96b0d836d7a21db91" FOREIGN KEY (role) REFERENCES public.role(slug);


--
-- Name: test_run FK_d6870d3b6e4c185d33926f423c8; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.test_run
    ADD CONSTRAINT "FK_d6870d3b6e4c185d33926f423c8" FOREIGN KEY ("workflowId") REFERENCES public.workflow_entity(id) ON DELETE CASCADE;


--
-- Name: shared_workflow FK_daa206a04983d47d0a9c34649ce; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.shared_workflow
    ADD CONSTRAINT "FK_daa206a04983d47d0a9c34649ce" FOREIGN KEY ("workflowId") REFERENCES public.workflow_entity(id) ON DELETE CASCADE;


--
-- Name: folder_tag FK_dc88164176283de80af47621746; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.folder_tag
    ADD CONSTRAINT "FK_dc88164176283de80af47621746" FOREIGN KEY ("tagId") REFERENCES public.tag_entity(id) ON DELETE CASCADE;


--
-- Name: user_api_keys FK_e131705cbbc8fb589889b02d457; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_api_keys
    ADD CONSTRAINT "FK_e131705cbbc8fb589889b02d457" FOREIGN KEY ("userId") REFERENCES public."user"(id) ON DELETE CASCADE;


--
-- Name: chat_hub_messages FK_e22538eb50a71a17954cd7e076c; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.chat_hub_messages
    ADD CONSTRAINT "FK_e22538eb50a71a17954cd7e076c" FOREIGN KEY ("sessionId") REFERENCES public.chat_hub_sessions(id) ON DELETE CASCADE;


--
-- Name: test_case_execution FK_e48965fac35d0f5b9e7f51d8c44; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.test_case_execution
    ADD CONSTRAINT "FK_e48965fac35d0f5b9e7f51d8c44" FOREIGN KEY ("executionId") REFERENCES public.execution_entity(id) ON DELETE SET NULL;


--
-- Name: chat_hub_messages FK_e5d1fa722c5a8d38ac204746662; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.chat_hub_messages
    ADD CONSTRAINT "FK_e5d1fa722c5a8d38ac204746662" FOREIGN KEY ("previousMessageId") REFERENCES public.chat_hub_messages(id) ON DELETE CASCADE;


--
-- Name: chat_hub_sessions FK_e9ecf8ede7d989fcd18790fe36a; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.chat_hub_sessions
    ADD CONSTRAINT "FK_e9ecf8ede7d989fcd18790fe36a" FOREIGN KEY ("ownerId") REFERENCES public."user"(id) ON DELETE CASCADE;


--
-- Name: user FK_eaea92ee7bfb9c1b6cd01505d56; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public."user"
    ADD CONSTRAINT "FK_eaea92ee7bfb9c1b6cd01505d56" FOREIGN KEY ("roleSlug") REFERENCES public.role(slug);


--
-- Name: role_scope FK_role; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.role_scope
    ADD CONSTRAINT "FK_role" FOREIGN KEY ("roleSlug") REFERENCES public.role(slug) ON UPDATE CASCADE ON DELETE CASCADE;


--
-- Name: role_scope FK_scope; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.role_scope
    ADD CONSTRAINT "FK_scope" FOREIGN KEY ("scopeSlug") REFERENCES public.scope(slug) ON UPDATE CASCADE ON DELETE CASCADE;


--
-- Name: auth_identity auth_identity_userId_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.auth_identity
    ADD CONSTRAINT "auth_identity_userId_fkey" FOREIGN KEY ("userId") REFERENCES public."user"(id);


--
-- Name: execution_data execution_data_fk; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.execution_data
    ADD CONSTRAINT execution_data_fk FOREIGN KEY ("executionId") REFERENCES public.execution_entity(id) ON DELETE CASCADE;


--
-- Name: execution_entity fk_execution_entity_workflow_id; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.execution_entity
    ADD CONSTRAINT fk_execution_entity_workflow_id FOREIGN KEY ("workflowId") REFERENCES public.workflow_entity(id) ON DELETE CASCADE;


--
-- Name: webhook_entity fk_webhook_entity_workflow_id; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.webhook_entity
    ADD CONSTRAINT fk_webhook_entity_workflow_id FOREIGN KEY ("workflowId") REFERENCES public.workflow_entity(id) ON DELETE CASCADE;


--
-- Name: workflow_entity fk_workflow_parent_folder; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_entity
    ADD CONSTRAINT fk_workflow_parent_folder FOREIGN KEY ("parentFolderId") REFERENCES public.folder(id) ON DELETE CASCADE;


--
-- Name: workflow_statistics fk_workflow_statistics_workflow_id; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_statistics
    ADD CONSTRAINT fk_workflow_statistics_workflow_id FOREIGN KEY ("workflowId") REFERENCES public.workflow_entity(id) ON DELETE CASCADE;


--
-- Name: workflows_tags fk_workflows_tags_tag_id; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflows_tags
    ADD CONSTRAINT fk_workflows_tags_tag_id FOREIGN KEY ("tagId") REFERENCES public.tag_entity(id) ON DELETE CASCADE;


--
-- Name: workflows_tags fk_workflows_tags_workflow_id; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflows_tags
    ADD CONSTRAINT fk_workflows_tags_workflow_id FOREIGN KEY ("workflowId") REFERENCES public.workflow_entity(id) ON DELETE CASCADE;


--
-- PostgreSQL database dump complete
--

\unrestrict WsAPP3rjnyAaKsZfrIcTlKtvM9Hamg5RPc7hYpOBcegjiVZauhowV0N2BIQhhEV

